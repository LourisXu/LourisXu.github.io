<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://lourisxu.github.io">
  <title>Spring-SpringMVC-MyBatis | Louris&#39; Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言 SpringBoot稍微学了集成redis、dubbo等的demo，项目看不下去，还是沉下去看看底层原理比较充实，不然太虚了。  Java设计模式 反射反射技术12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring-SpringMVC-MyBatis">
<meta property="og:url" content="https://lourisxu.github.io/2021/09/03/springspringmvcmybatis.html/index.html">
<meta property="og:site_name" content="Louris&#39; Blog">
<meta property="og:description" content="前言 SpringBoot稍微学了集成redis、dubbo等的demo，项目看不下去，还是沉下去看看底层原理比较充实，不然太虚了。  Java设计模式 反射反射技术12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626">
<meta property="article:published_time" content="2021-09-03T15:21:28.000Z">
<meta property="article:modified_time" content="2024-01-19T02:20:51.968Z">
<meta property="article:author" content="Louris">
<meta property="article:tag" content="Tech">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="Louris&#39; Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/assets/img/blog/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.e8862b.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

<meta name="generator" content="Hexo 4.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #00BFFF"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="/assets/img/blog/userpic.jpg" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">Louris</a></h1>
		</hgroup>
		
		<p class="header-subtitle">Do what I can</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">Home</a></li>
	        
				<li><a href="/categories/DS/">DS</a></li>
	        
				<li><a href="/tags/ML/">ML&amp;DL</a></li>
	        
				<li><a href="/tags/Tech/">Tech</a></li>
	        
				<li><a href="/tags/Algorithm/">Algorithm</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">All articles</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">Friends</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">About me</a>
    			
            
		</nav>
		<nav>
		 <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=230 height=86 src="//music.163.com/outchain/player?type=2&id=2080322&auto=1&height=66"></iframe>
		 <!--<div id="aplayer_home" class="aplayer" style="margin-bottom: 20px;width:100%;"></div>
		 <script type="text/javascript" src="\assets\js\APlayer.min.js"> </script>
 			<script>
   			new APlayer({
     		element: document.getElementById("aplayer_home"),
     		narrow: false,
     		autoplay: false,
     		showlrc: 0,
     		music: {
       		title: "What Are Words",
       		author: "Chris Media",
       		url: "https://coding.net/u/LourisXu/p/LourisXu/attachment/4532287/preview/4533847",
       		pic: "http://ov4otygyd.bkt.clouddn.com/What_Are_Words.jpg",
   			}
 			});
			</script>-->
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/LourisXu" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/5634881238/profile?rightmod=1&wvr=6&mod=personinfo" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:louris@csu.edu.cn" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #00BFFF"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="/assets/img/blog/userpic.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">Louris</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>Do what I can<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
				
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/LourisXu" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/5634881238/profile?rightmod=1&wvr=6&mod=personinfo" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:louris@csu.edu.cn" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 70%">
				
				
					<li style="width: 20%"><a href="/">Home</a></li>
		        
					<li style="width: 20%"><a href="/categories/DS/">DS</a></li>
		        
					<li style="width: 20%"><a href="/tags/ML/">ML&amp;DL</a></li>
		        
					<li style="width: 20%"><a href="/tags/Tech/">Tech</a></li>
		        
					<li style="width: 20%"><a href="/tags/Algorithm/">Algorithm</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            <article id="post-Java/ssm" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spring-SpringMVC-MyBatis
    </h1>
  


        
        <a href="/2021/09/03/springspringmvcmybatis.html/" class="archive-article-date">
  	<time datetime="2021-09-03T15:21:28.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-09-03</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><blockquote>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1></blockquote>
<p>SpringBoot稍微学了集成redis、dubbo等的demo，项目看不下去，还是沉下去看看底层原理比较充实，不然太虚了。</p>
<blockquote>
<h1 id="Java设计模式"><a href="#Java设计模式" class="headerlink" title="Java设计模式"></a>Java设计模式</h1></blockquote>
<h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><h3 id="反射技术"><a href="#反射技术" class="headerlink" title="反射技术"></a>反射技术</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReflectServiceImpl</span></span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(String name)</span></span>{</span><br><span class="line">        System.err.println(<span class="string">"Hello "</span> + name);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ReflectServiceImpl <span class="title">getInstance</span><span class="params">()</span></span>{</span><br><span class="line">        ReflectServiceImpl object = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            object = (ReflectServiceImpl) Class.forName(<span class="string">"ReflectServiceImpl"</span>).newInstance();</span><br><span class="line">        }<span class="keyword">catch</span> (ClassNotFoundException | InstantiationException | IllegalAccessException ex){</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReflectServiceImpl2</span></span>{</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReflectServiceImpl2</span><span class="params">(String name)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>{</span><br><span class="line">        System.err.println(<span class="string">"Hello "</span> + name);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ReflectServiceImpl2 <span class="title">getInstance</span><span class="params">()</span></span>{</span><br><span class="line">        ReflectServiceImpl2 object = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            object = (ReflectServiceImpl2) Class.forName(<span class="string">"ReflectServiceImpl2"</span>)</span><br><span class="line">                    .getConstructor(String<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">                    .newInstance("张三");</span><br><span class="line">        }<span class="keyword">catch</span> (ClassNotFoundException | InstantiationException | IllegalAccessException</span><br><span class="line">                | NoSuchMethodException | SecurityException | IllegalArgumentException</span><br><span class="line">                | InvocationTargetException ex){</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassTest</span></span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">reflectMethod</span><span class="params">()</span></span>{</span><br><span class="line">        Object obj = <span class="keyword">null</span>;</span><br><span class="line">        ReflectServiceImpl target = <span class="keyword">new</span> ReflectServiceImpl();</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            Method method = ReflectServiceImpl.class.getMethod("sayHello", String.class);</span><br><span class="line">            obj = method.invoke(target, <span class="string">"张三"</span>);</span><br><span class="line">        }<span class="keyword">catch</span> (NoSuchMethodException | SecurityException | IllegalAccessException</span><br><span class="line">                | IllegalArgumentException | InvocationTargetException ex){</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        ReflectServiceImpl object = ReflectServiceImpl.getInstance();</span><br><span class="line">        object.sayHello(<span class="string">"World!"</span>);</span><br><span class="line"></span><br><span class="line">        ReflectServiceImpl2 object1 = ReflectServiceImpl2.getInstance();</span><br><span class="line">        object1.sayHello();</span><br><span class="line"></span><br><span class="line">        reflectMethod();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">HelloWorld</span></span>{</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHelloWorld</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorldImpl</span> <span class="keyword">implements</span> <span class="title">HelloWorld</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHelloWorld</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"Hello World"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaticProxyExample</span> <span class="keyword">implements</span> <span class="title">HelloWorld</span></span>{</span><br><span class="line">    <span class="keyword">private</span> HelloWorldImpl helloWorldImpl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StaticProxyExample</span><span class="params">(HelloWorldImpl helloWorldImpl)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.helloWorldImpl = helloWorldImpl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StaticProxyExample</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, InstantiationException</span>{</span><br><span class="line">        <span class="keyword">this</span>.helloWorldImpl = (HelloWorldImpl) <span class="keyword">this</span>.getClass().getClassLoader().loadClass(<span class="string">"HelloWorldImpl"</span>).newInstance();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHelloWorld</span><span class="params">()</span> </span>{</span><br><span class="line">        helloWorldImpl.sayHelloWorld();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        <span class="comment">// 第一种方式</span></span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="keyword">new</span> HelloWorldImpl().sayHelloWorld();</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 第二种方式</span></span><br><span class="line">        <span class="keyword">new</span> StaticProxyExample(<span class="keyword">new</span> HelloWorldImpl()).sayHelloWorld();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><h3 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">HelloWorld</span></span>{</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHelloWorld</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorldImpl</span> <span class="keyword">implements</span> <span class="title">HelloWorld</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHelloWorld</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"Hello World"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaticProxyExample</span> <span class="keyword">implements</span> <span class="title">HelloWorld</span></span>{</span><br><span class="line">    <span class="keyword">private</span> HelloWorldImpl helloWorldImpl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StaticProxyExample</span><span class="params">(HelloWorldImpl helloWorldImpl)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.helloWorldImpl = helloWorldImpl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StaticProxyExample</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, InstantiationException</span>{</span><br><span class="line">        <span class="keyword">this</span>.helloWorldImpl = (HelloWorldImpl) <span class="keyword">this</span>.getClass().getClassLoader().loadClass(<span class="string">"HelloWorldImpl"</span>).newInstance();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHelloWorld</span><span class="params">()</span> </span>{</span><br><span class="line">        helloWorldImpl.sayHelloWorld();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JdkProxyExample</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object target = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">bind</span><span class="params">(Object target)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), <span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        System.out.println(<span class="string">"进入代理逻辑方法"</span>);</span><br><span class="line">        System.out.println(<span class="string">"在调度真实对象之前的服务"</span>);</span><br><span class="line">        Object obj = method.invoke(target, args);</span><br><span class="line">        System.out.println(<span class="string">"在调用真实对象之后的服务"</span>);</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxy</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        JdkProxyExample jdkProxyExample = <span class="keyword">new</span> JdkProxyExample();</span><br><span class="line">        HelloWorld proxy = (HelloWorld) jdkProxyExample.bind(<span class="keyword">new</span> HelloWorldImpl());</span><br><span class="line">        proxy.sayHelloWorld();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">进入代理逻辑方法</span><br><span class="line">在调度真实对象之前的服务</span><br><span class="line">Hello World</span><br><span class="line">在调用真实对象之后的服务</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Cglib动态代理"><a href="#Cglib动态代理" class="headerlink" title="Cglib动态代理"></a>Cglib动态代理</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.Enhancer;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodProxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReflectServiceImpl</span></span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(String name)</span></span>{</span><br><span class="line">        System.err.println(<span class="string">"Hello "</span> + name);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ReflectServiceImpl <span class="title">getInstance</span><span class="params">()</span></span>{</span><br><span class="line">        ReflectServiceImpl object = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            object = (ReflectServiceImpl) Class.forName(<span class="string">"ReflectServiceImpl"</span>).newInstance();</span><br><span class="line">        }<span class="keyword">catch</span> (ClassNotFoundException | InstantiationException | IllegalAccessException ex){</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CglibProxyExample</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">(Class cls)</span></span>{</span><br><span class="line">        <span class="comment">//CGlib enhancer增强类对象</span></span><br><span class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">        <span class="comment">//设置增强类型</span></span><br><span class="line">        enhancer.setSuperclass(cls);</span><br><span class="line">        <span class="comment">//定义代理逻辑对象为当前对象，要求当前对象实现MethodInterceptor方法</span></span><br><span class="line">        enhancer.setCallback(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//生成并返回代理对象</span></span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        System.err.println(<span class="string">"调用真实对象前"</span>);</span><br><span class="line">        <span class="comment">//CGlib反射调用真实对象方法</span></span><br><span class="line">        Object result = methodProxy.invokeSuper(o, objects);</span><br><span class="line">        System.err.println(<span class="string">"调用真实对象后"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxy</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        CglibProxyExample cpe = <span class="keyword">new</span> CglibProxyExample();</span><br><span class="line">        ReflectServiceImpl obj = (ReflectServiceImpl)cpe.getProxy(ReflectServiceImpl<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        obj.sayHello(<span class="string">"张三"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="comment">//拦截器接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Interceptor</span></span>{</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">before</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">around</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">after</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span></span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//拦截器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">before</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.err.println(<span class="string">"反射方法前逻辑"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">//不反射被代理对象原有方法</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.err.println(<span class="string">"反射方法后逻辑"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.err.println(<span class="string">"取代了被代理对象的方法"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InterceptorJdkProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>{</span><br><span class="line">    <span class="keyword">private</span> Object target; <span class="comment">//真实对象</span></span><br><span class="line">    <span class="keyword">private</span> String interceptorClass = <span class="keyword">null</span>; <span class="comment">//拦截器全限定名</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InterceptorJdkProxy</span><span class="params">(Object target, String interceptorClass)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">        <span class="keyword">this</span>.interceptorClass = interceptorClass;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">bind</span><span class="params">(Object target, String interceptorClass)</span></span>{</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">                target.getClass().getClassLoader(),</span><br><span class="line">                target.getClass().getInterfaces(),</span><br><span class="line">                <span class="keyword">new</span> InterceptorJdkProxy(target, interceptorClass));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        <span class="keyword">if</span>(interceptorClass == <span class="keyword">null</span>) <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line"></span><br><span class="line">        Object result = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过反射生成拦截器</span></span><br><span class="line">        Interceptor interceptor = (Interceptor) Class.forName(interceptorClass).newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用前置方法</span></span><br><span class="line">        <span class="keyword">if</span>(interceptor.before(proxy, target, method, args)){</span><br><span class="line">            <span class="comment">//反射原有对象方法</span></span><br><span class="line">            result = method.invoke(target, args);</span><br><span class="line">        }<span class="keyword">else</span> interceptor.around(proxy, target, method, args);</span><br><span class="line">        <span class="comment">//调用后置方法</span></span><br><span class="line">        interceptor.after(proxy, target, method, args);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        HelloWorld proxy = (HelloWorld) InterceptorJdkProxy.bind(</span><br><span class="line">                <span class="keyword">new</span> HelloWorldImpl(),</span><br><span class="line">                <span class="string">"MyInterceptor"</span>);</span><br><span class="line">        proxy.sayHelloWorld();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">反射方法前逻辑</span><br><span class="line">取代了被代理对象的方法</span><br><span class="line">反射方法后逻辑</span><br></pre></td></tr></tbody></table></figure>
<h2 id="责任链模式-多级代理"><a href="#责任链模式-多级代理" class="headerlink" title="责任链模式/多级代理"></a>责任链模式/多级代理</h2><p>责任链模式的经典方法见设计模式，这里用多级代理实现责任链模式</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="comment">//拦截器接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Interceptor</span></span>{</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">before</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">around</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">after</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span></span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//拦截器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">before</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.err.println(<span class="string">"反射方法前逻辑"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">//不反射被代理对象原有方法</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.err.println(<span class="string">"反射方法后逻辑"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.err.println(<span class="string">"取代了被代理对象的方法"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Interceptor1</span> <span class="keyword">implements</span> <span class="title">Interceptor</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">before</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"【拦截器1】的before方法"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{}</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"【拦截器1】的after方法"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Interceptor2</span> <span class="keyword">implements</span> <span class="title">Interceptor</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">before</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"【拦截器2】的before方法"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"【拦截器2】的after方法"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Interceptor3</span> <span class="keyword">implements</span> <span class="title">Interceptor</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">before</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"【拦截器3】的before方法"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Object proxy, Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"【拦截器3】的after方法"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InterceptorJdkProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>{</span><br><span class="line">    <span class="keyword">private</span> Object target; <span class="comment">//真实对象</span></span><br><span class="line">    <span class="keyword">private</span> String interceptorClass = <span class="keyword">null</span>; <span class="comment">//拦截器全限定名</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InterceptorJdkProxy</span><span class="params">(Object target, String interceptorClass)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">        <span class="keyword">this</span>.interceptorClass = interceptorClass;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">bind</span><span class="params">(Object target, String interceptorClass)</span></span>{</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">                target.getClass().getClassLoader(),</span><br><span class="line">                target.getClass().getInterfaces(),</span><br><span class="line">                <span class="keyword">new</span> InterceptorJdkProxy(target, interceptorClass));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        <span class="keyword">if</span>(interceptorClass == <span class="keyword">null</span>) <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line"></span><br><span class="line">        Object result = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过反射生成拦截器</span></span><br><span class="line">        Interceptor interceptor = (Interceptor) Class.forName(interceptorClass).newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用前置方法</span></span><br><span class="line">        <span class="keyword">if</span>(interceptor.before(proxy, target, method, args)){</span><br><span class="line">            <span class="comment">//反射原有对象方法</span></span><br><span class="line">            result = method.invoke(target, args);</span><br><span class="line">        }<span class="keyword">else</span> interceptor.around(proxy, target, method, args);</span><br><span class="line">        <span class="comment">//调用后置方法</span></span><br><span class="line">        interceptor.after(proxy, target, method, args);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        HelloWorld proxy1 = (HelloWorld) InterceptorJdkProxy.bind(</span><br><span class="line">                <span class="keyword">new</span> HelloWorldImpl(),</span><br><span class="line">                <span class="string">"Interceptor1"</span>);</span><br><span class="line">        HelloWorld proxy2 = (HelloWorld) InterceptorJdkProxy.bind(</span><br><span class="line">                proxy1,</span><br><span class="line">                <span class="string">"Interceptor2"</span>);</span><br><span class="line">        HelloWorld proxy3 = (HelloWorld) InterceptorJdkProxy.bind(</span><br><span class="line">                proxy2,</span><br><span class="line">                <span class="string">"Interceptor3"</span>);</span><br><span class="line">        proxy3.sayHelloWorld();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">【拦截器<span class="number">3</span>】的before方法</span><br><span class="line">【拦截器<span class="number">2</span>】的before方法</span><br><span class="line">【拦截器<span class="number">1</span>】的before方法</span><br><span class="line">Hello World</span><br><span class="line">【拦截器<span class="number">1</span>】的after方法</span><br><span class="line">【拦截器<span class="number">2</span>】的after方法</span><br><span class="line">【拦截器<span class="number">3</span>】的after方法</span><br></pre></td></tr></tbody></table></figure>
<h2 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Observable;</span><br><span class="line"><span class="keyword">import</span> java.util.Observer;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductList</span> <span class="keyword">extends</span> <span class="title">Observable</span></span>{</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; productList = <span class="keyword">null</span>; <span class="comment">//产品列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ProductList instance; <span class="comment">//类唯一实例, 单例模式</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ProductList</span><span class="params">()</span></span>{} <span class="comment">//构造方法私有化</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProductList <span class="title">getInstance</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="keyword">null</span>){</span><br><span class="line">            instance = <span class="keyword">new</span> ProductList();</span><br><span class="line">            instance.productList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProductListObserver</span><span class="params">(Observer observer)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.addObserver(observer);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProduct</span><span class="params">(String newProduct)</span></span>{</span><br><span class="line">        productList.add(newProduct);</span><br><span class="line">        System.out.println(<span class="string">"产品列表新增了产品："</span> + newProduct);</span><br><span class="line">        <span class="keyword">this</span>.setChanged(); <span class="comment">//设置被观察对象发生变化</span></span><br><span class="line">        <span class="keyword">this</span>.notifyObservers(newProduct); <span class="comment">//通知观察者，并传递新产品</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JingDongObserver</span> <span class="keyword">implements</span> <span class="title">Observer</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object product)</span> </span>{</span><br><span class="line">        String newProduct = (String)product;</span><br><span class="line">        System.err.println(<span class="string">"发送新产品【"</span> + newProduct + <span class="string">"】同步到京东商城"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaoBaoObserver</span> <span class="keyword">implements</span> <span class="title">Observer</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object product)</span> </span>{</span><br><span class="line">        String newProduct = (String)product;</span><br><span class="line">        System.err.println(<span class="string">"发送新产品【"</span> + newProduct + <span class="string">"】同步到淘宝商城"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverTest</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        ProductList observable = ProductList.getInstance();</span><br><span class="line">        TaoBaoObserver taoBaoObserver = <span class="keyword">new</span> TaoBaoObserver();</span><br><span class="line">        JingDongObserver jingDongObserver = <span class="keyword">new</span> JingDongObserver();</span><br><span class="line">        observable.addObserver(taoBaoObserver);</span><br><span class="line">        observable.addObserver(jingDongObserver);</span><br><span class="line">        observable.addProduct(<span class="string">"新增产品1"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">产品列表新增了产品：新增产品<span class="number">1</span></span><br><span class="line">发送新产品【新增产品<span class="number">1</span>】同步到京东商城</span><br><span class="line">发送新产品【新增产品<span class="number">1</span>】同步到淘宝商城</span><br></pre></td></tr></tbody></table></figure>

<h2 id="建造者模式"><a href="#建造者模式" class="headerlink" title="建造者模式"></a>建造者模式</h2><h3 id="简单实现以及建造者模式对比"><a href="#简单实现以及建造者模式对比" class="headerlink" title="简单实现以及建造者模式对比"></a>简单实现以及建造者模式对比</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span></span>{</span><br><span class="line">    <span class="comment">//必填</span></span><br><span class="line">    <span class="keyword">private</span> String itemName;</span><br><span class="line">    <span class="comment">//必填</span></span><br><span class="line">    <span class="keyword">private</span> Integer type;</span><br><span class="line">    <span class="comment">//卡券必填</span></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="comment">//视频必填</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCode</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getItemName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> itemName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUrl</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(String code)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setItemName</span><span class="params">(String itemName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.itemName = itemName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(Integer type)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(String url)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//建造者抽象类</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemBuilder</span></span>{</span><br><span class="line">    <span class="keyword">protected</span> Item item = <span class="keyword">new</span> Item();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildNormal</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">builCard</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildVideo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回产品对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Item <span class="title">getResult</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//建造者具体实现类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemConcreteBuilder</span> <span class="keyword">extends</span> <span class="title">ItemBuilder</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildNormal</span><span class="params">()</span> </span>{</span><br><span class="line">        item.setItemName(<span class="string">"普通商品"</span>);</span><br><span class="line">        item.setType(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">builCard</span><span class="params">()</span> </span>{</span><br><span class="line">        item.setItemName(<span class="string">"卡券商品"</span>);</span><br><span class="line">        item.setCode(<span class="string">"123456"</span>);</span><br><span class="line">        item.setType(<span class="number">2</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildVideo</span><span class="params">()</span> </span>{</span><br><span class="line">        item.setItemName(<span class="string">"视频商品"</span>);</span><br><span class="line">        item.setType(<span class="number">3</span>);</span><br><span class="line">        item.setUrl(<span class="string">"http://www.baidu.com"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//具体建造者</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemDirector</span></span>{</span><br><span class="line">    <span class="keyword">private</span> ItemBuilder itemBuilder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ItemDirector</span><span class="params">(ItemBuilder itemBuilder)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.itemBuilder = itemBuilder;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Item <span class="title">normalConstruct</span><span class="params">()</span></span>{</span><br><span class="line">        itemBuilder.buildNormal();</span><br><span class="line">        <span class="keyword">return</span> itemBuilder.getResult();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Item <span class="title">cardConstruct</span><span class="params">()</span></span>{</span><br><span class="line">        itemBuilder.builCard();</span><br><span class="line">        <span class="keyword">return</span> itemBuilder.getResult();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Item <span class="title">videoConstruct</span><span class="params">()</span></span>{</span><br><span class="line">        itemBuilder.buildVideo();</span><br><span class="line">        <span class="keyword">return</span> itemBuilder.getResult();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuilderTest</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Item <span class="title">easyBuild</span><span class="params">(String op)</span></span>{</span><br><span class="line">        Item item = <span class="keyword">new</span> Item();</span><br><span class="line">        <span class="keyword">if</span>(op.equals(<span class="string">"创建普通商品"</span>)){</span><br><span class="line">            item.setItemName(<span class="string">"xxx"</span>);</span><br><span class="line">            item.setType(<span class="number">1</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(op.equals(<span class="string">"创建点子卡券商品"</span>)){</span><br><span class="line">            item.setItemName(<span class="string">"xxx"</span>);</span><br><span class="line">            item.setCode(<span class="string">"xxx"</span>);</span><br><span class="line">            item.setType(<span class="number">2</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(op.equals(<span class="string">"创建视频"</span>)){</span><br><span class="line">            item.setItemName(<span class="string">"xxx"</span>);</span><br><span class="line">            item.setUrl(<span class="string">"https://www.baidu.com"</span>);</span><br><span class="line">            item.setType(<span class="number">3</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        ItemBuilder builder = <span class="keyword">new</span> ItemConcreteBuilder();</span><br><span class="line">        ItemDirector director = <span class="keyword">new</span> ItemDirector(builder);</span><br><span class="line">        Item item = director.normalConstruct();</span><br><span class="line">        System.out.println(JSON.toJSONString(item));</span><br><span class="line"></span><br><span class="line">        Item item1 = director.cardConstruct();</span><br><span class="line">        System.out.println(JSON.toJSON(item1));</span><br><span class="line"></span><br><span class="line">        Item item2 = director.videoConstruct();</span><br><span class="line">        System.out.println(JSON.toJSONString(item2));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{<span class="string">"itemName"</span>:<span class="string">"普通商品"</span>,<span class="string">"type"</span>:<span class="number">1</span>}</span><br><span class="line">{<span class="string">"itemName"</span>:<span class="string">"卡券商品"</span>,<span class="string">"code"</span>:<span class="string">"123456"</span>,<span class="string">"type"</span>:<span class="number">2</span>}</span><br><span class="line">{<span class="string">"code"</span>:<span class="string">"123456"</span>,<span class="string">"itemName"</span>:<span class="string">"视频商品"</span>,<span class="string">"type"</span>:<span class="number">3</span>,<span class="string">"url"</span>:<span class="string">"http://www.baidu.com"</span>}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="静态内部类的实现"><a href="#静态内部类的实现" class="headerlink" title="静态内部类的实现"></a>静态内部类的实现</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CopyItem</span></span>{</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Long stock;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStock</span><span class="params">(Long stock)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.stock = stock;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getStock</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> stock;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">CopyItem</span><span class="params">(ItemBuilder builder)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.name = builder.name;</span><br><span class="line">        <span class="keyword">this</span>.stock = builder.stock;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemBuilder</span></span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Long DEFAULT_STOCK = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> Long stock = DEFAULT_STOCK;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> CopyItem <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CopyItem(<span class="keyword">this</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ItemBuilder <span class="title">setName</span><span class="params">(String name)</span></span>{</span><br><span class="line">            <span class="keyword">if</span>(StringUtils.isBlank(name)){</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"...."</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ItemBuilder <span class="title">setStock</span><span class="params">(Long stock)</span></span>{</span><br><span class="line">            <span class="keyword">if</span>(stock &gt; <span class="number">9999999999L</span>){</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"库存数量错误"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">this</span>.stock = stock;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line"></span><br><span class="line">        CopyItem copyItem = <span class="keyword">new</span> CopyItem.ItemBuilder().setName(<span class="string">"copyItem"</span>).build();</span><br><span class="line">        System.out.println(JSON.toJSONString(copyItem));</span><br><span class="line"></span><br><span class="line">        CopyItem copyItem1 = <span class="keyword">new</span> CopyItem.ItemBuilder().setStock(<span class="number">99999999999L</span>).build();</span><br><span class="line">        System.out.println(JSON.toJSONString(copyItem1));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.IllegalArgumentException: 库存数量错误</span><br><span class="line">	at CopyItem$ItemBuilder.setStock(BuilderTest.java:<span class="number">152</span>)</span><br><span class="line">	at BuilderTest.main(BuilderTest.java:<span class="number">194</span>)</span><br><span class="line">{<span class="string">"name"</span>:<span class="string">"copyItem"</span>,<span class="string">"stock"</span>:<span class="number">0</span>}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="互联网持久层框架——MyBatis"><a href="#互联网持久层框架——MyBatis" class="headerlink" title="互联网持久层框架——MyBatis"></a>互联网持久层框架——MyBatis</h1></blockquote>
<blockquote>
<h1 id="认识MyBatis核心组件"><a href="#认识MyBatis核心组件" class="headerlink" title="认识MyBatis核心组件"></a>认识MyBatis核心组件</h1></blockquote>
<h2 id="Mybatis的核心组件"><a href="#Mybatis的核心组件" class="headerlink" title="Mybatis的核心组件"></a>Mybatis的核心组件</h2><ul>
<li>SqlSessionFactoryBuilder（构造—）：它会根据配置或者代码来生成SqlSessionFactory,采用的是分步构建的Builder模式；</li>
<li>SqlSessionFactory （工厂接口）：依靠它来生成SqlSession，使用的是工厂模式；</li>
<li>SqlSession（会话）：一个既可以发送SQL执行返回结果，也可以获取Mapper的接口。在现有的技术中，一般我们会让其在业务逻辑代码中“消失”，而使用的是MyBatis提供的SQL Mapper接口编程技术，它能提高代码的可读性和可维护性；</li>
<li>SQL Mapper（映射器）：MyBatis新设计存在的组件，它由一个Java接口和XML文件（或注解）构成，需要给出对应的SQL和映射规则。它负责发送SQL去执行，并返回结果。</li>
</ul>
<p><a href="https://mybatis.org/mybatis-3/zh/getting-started.html" target="_blank" rel="noopener">在线文档</a><br><a href="https://github.com/mybatis/mybatis-3" target="_blank" rel="noopener">Github</a></p>
<h3 id="SqlSessionFactory"><a href="#SqlSessionFactory" class="headerlink" title="SqlSessionFactory"></a>SqlSessionFactory</h3><h4 id="XML构建方式（推荐）"><a href="#XML构建方式（推荐）" class="headerlink" title="XML构建方式（推荐）"></a>XML构建方式（推荐）</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Config 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 别名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"role"</span> <span class="attr">type</span>=<span class="string">"Role"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数据库环境 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 映射文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"RoleMapper.xml"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">null</span>;</span><br><span class="line">        String resource = <span class="string">"mybatis-config.xml"</span>;</span><br><span class="line">        InputStream inputStream;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">            sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">        }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br></pre></td></tr></tbody></table></figure>
<h4 id="代码构建方式"><a href="#代码构建方式" class="headerlink" title="代码构建方式"></a>代码构建方式</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.pooled.PooledDataSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.Environment;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.transaction.TransactionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.transaction.jdbc.JdbcTransactionFactory;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span></span>{</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span></span>{</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Connector</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">connectDatabase</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="comment">//数据库连接池信息</span></span><br><span class="line">        PooledDataSource dataSource = <span class="keyword">new</span> PooledDataSource();</span><br><span class="line">        dataSource.setDriver(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"123456"</span>);</span><br><span class="line">        dataSource.setUrl(<span class="string">"jdbc:mysql://localhost:3306/ssm"</span>);</span><br><span class="line">        dataSource.setDefaultAutoCommit(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//采用MyBatis的JDBC事务方式</span></span><br><span class="line">        TransactionFactory transactionFactory = <span class="keyword">new</span> JdbcTransactionFactory();</span><br><span class="line">        Environment environment = <span class="keyword">new</span> Environment(<span class="string">"development"</span>, transactionFactory, dataSource);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建Configuration对象</span></span><br><span class="line">        Configuration configuration = <span class="keyword">new</span> Configuration(environment);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册一个MyBatis上下文别名</span></span><br><span class="line">        configuration.getTypeAliasRegistry().registerAlias(<span class="string">"role"</span>, Role<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加入一个映射器</span></span><br><span class="line">        configuration.addMapper(RoleMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用SqlSessionFactoryBuilder构建SqlSessionFractory</span></span><br><span class="line">        SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(configuration);</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="SqlSession"><a href="#SqlSession" class="headerlink" title="SqlSession"></a>SqlSession</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">helper</span><span class="params">()</span></span>{</span><br><span class="line">  <span class="comment">//定义SqlSession</span></span><br><span class="line">  SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span>{</span><br><span class="line">      <span class="comment">//打开SqlSession会话</span></span><br><span class="line">      SqlSessionFactory sqlSessionFactory = connectDatabase();</span><br><span class="line">      sqlSession = sqlSessionFactory.openSession();</span><br><span class="line">  }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">      sqlSession.rollback();</span><br><span class="line">  }<span class="keyword">finally</span> {</span><br><span class="line">      <span class="comment">//在finally语句汇总确保资源被顺利关闭</span></span><br><span class="line">      <span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>) sqlSession.close();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Mapper映射器"><a href="#Mapper映射器" class="headerlink" title="Mapper映射器"></a>Mapper映射器</h3><h4 id="POJO和映射接口"><a href="#POJO和映射接口" class="headerlink" title="POJO和映射接口"></a>POJO和映射接口</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span></span>{</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span></span>{</span><br><span class="line">    <span class="function">Role <span class="title">getRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="XML映射文件实现"><a href="#XML映射文件实现" class="headerlink" title="XML映射文件实现"></a>XML映射文件实现</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Config 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"RoleMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select id, role_name as roleName, note from t_role where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="注解实现"><a href="#注解实现" class="headerlink" title="注解实现"></a>注解实现</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span></span>{</span><br><span class="line">  <span class="meta">@Select</span>(<span class="string">"select id, role_name as roleName, note from t_role where id = #{id}"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Role <span class="title">getRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="SqlSession发送SQL"><a href="#SqlSession发送SQL" class="headerlink" title="SqlSession发送SQL"></a>SqlSession发送SQL</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Role role = (Role) sqlSession.selectOne(<span class="string">"RoleMapper.getRole"</span>, <span class="number">1L</span>);</span><br></pre></td></tr></tbody></table></figure>
<h4 id="用Mapper接口发送SQL（推荐）"><a href="#用Mapper接口发送SQL（推荐）" class="headerlink" title="用Mapper接口发送SQL（推荐）"></a>用Mapper接口发送SQL（推荐）</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RoleMapper roleMapper = sqlSession.getMapper(RoleMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">Role role = roleMapper.getRole(<span class="number">1L</span>);</span><br></pre></td></tr></tbody></table></figure>

<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><ul>
<li>SqlSessionFatoryBuilder的作用在于创建SqlSessionFactory，创建成功后，SqlSessionFactoryBuilder就失去了作用，所以它只能存在于创建SqlSessionFactory的方法中，而不要让其长期存在；</li>
<li>SqlSessionFactory可以被认为是一个数据库连接池，它的作用是创建SqlSession接口对象。所以SqlSessionFactory的生命周期存在于整个MyBatis的应用之中，所以一旦创建了SqlSessionFactory，就要长期保存它，直至不再使用Mybatis。</li>
<li>SqlSession相当于一个数据库连接，可以字啊一个事务里面执行多条SQL，然后commit、rollback等，其应该存活在一个业务请求中，处理完整个请求后，应当关闭连接，归还给SqlSessionFactory，否则数据库资源就很快被耗费光，系统就会瘫痪，所以需要try/catch/finally语句来保证其正确关闭</li>
<li>Mapper是一个借口，由SqlSession创建，所以其最大生命周期至多和SqlSession保持一致，尽管它很好用，但是由于SqlSession的关闭，它的数据库连接资源也会消失，所以它的生命周期应该小于等于SqlSession的生命周期。</li>
</ul>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="log4j-properties"><a href="#log4j-properties" class="headerlink" title="log4j.properties"></a>log4j.properties</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log4j.rootLogger=DEBUG,stdout</span><br><span class="line">log4j.logger.org.mybatis=DEBUG</span><br><span class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.stdout.layout.ConversionPattern=%5p %d %c: %m%n</span><br></pre></td></tr></tbody></table></figure>
<h3 id="mybatis-config-xml"><a href="#mybatis-config-xml" class="headerlink" title="mybatis-config.xml"></a>mybatis-config.xml</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 别名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"role"</span> <span class="attr">type</span>=<span class="string">"mybatis.Role"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数据库环境 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm?serverTimezone=UTC"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  映射文件  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mybatis\RoleMapper.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="RoleMapper-xml"><a href="#RoleMapper-xml" class="headerlink" title="RoleMapper.xml"></a>RoleMapper.xml</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"mybatis.RoleMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        insert into t_role(role_name, note) values(#{roleName}, #{note})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">        delete from t_role where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        update t_role set role_name = #{roleName}, note = #{note} where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select id, role_name as roleName, note from t_role where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select id, role_name as roleName, note from t_role</span><br><span class="line">        where role_name like concat('%', ${roleName}, '%')</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Role"><a href="#Role" class="headerlink" title="Role"></a>Role</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoleName</span><span class="params">(String roleName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoleName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleName;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="RoleMapper"><a href="#RoleMapper" class="headerlink" title="RoleMapper"></a>RoleMapper</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">    <span class="function">Role <span class="title">getRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findRoles</span><span class="params">(String roleName)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="SqlSessionFactoryUtil"><a href="#SqlSessionFactoryUtil" class="headerlink" title="SqlSessionFactoryUtil"></a>SqlSessionFactoryUtil</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.PropertyConfigurator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactoryUtils</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Class&lt;SqlSessionFactoryUtils&gt; LOCK = SqlSessionFactoryUtils<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SqlSessionFactoryUtils</span><span class="params">()</span></span>{} <span class="comment">//单例模式</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">getSqlSessionFactory</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK){</span><br><span class="line">            <span class="keyword">if</span>(sqlSessionFactory != <span class="keyword">null</span>) <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">            String resource = <span class="string">"mybatis\\mybatis-config.xml"</span>;</span><br><span class="line">            InputStream inputStream;</span><br><span class="line">            <span class="keyword">try</span>{</span><br><span class="line">                inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">                sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">            }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title">openSqlSession</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(sqlSessionFactory == <span class="keyword">null</span>) getSqlSessionFactory();</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory.openSession();</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        <span class="comment">//log4j.properties默认是在src目录下，如果不是需要重新设置</span></span><br><span class="line">        <span class="comment">//加载log4j的配置文件</span></span><br><span class="line"><span class="comment">//        FileInputStream fileInputStream = null;</span></span><br><span class="line"><span class="comment">//        try{</span></span><br><span class="line"><span class="comment">//            Properties properties = new Properties();</span></span><br><span class="line"><span class="comment">//            fileInputStream = new FileInputStream("src\\mybatis\\log4j.properties");</span></span><br><span class="line"><span class="comment">//            properties.load(fileInputStream);</span></span><br><span class="line"><span class="comment">//            PropertyConfigurator.configure(properties);</span></span><br><span class="line"><span class="comment">//        }catch (Exception e){</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        }finally {</span></span><br><span class="line"><span class="comment">//            if(fileInputStream != null){</span></span><br><span class="line"><span class="comment">//                try{</span></span><br><span class="line"><span class="comment">//                    fileInputStream.close();</span></span><br><span class="line"><span class="comment">//                }catch (IOException e){</span></span><br><span class="line"><span class="comment">//                    e.printStackTrace();</span></span><br><span class="line"><span class="comment">//                }</span></span><br><span class="line"><span class="comment">//            }</span></span><br><span class="line"><span class="comment">//        }</span></span><br><span class="line">        Logger logger = Logger.getLogger(SqlSessionFactoryUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            sqlSession = SqlSessionFactoryUtils.openSqlSession();</span><br><span class="line">            RoleMapper roleMapper = sqlSession.getMapper(RoleMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            Role role = roleMapper.getRole(<span class="number">1L</span>);</span><br><span class="line">            <span class="comment">//System.out.println(JSON.toJSONString(role));</span></span><br><span class="line">            logger.info(role.getRoleName());</span><br><span class="line">        }<span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>) sqlSession.close();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=59486:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">01</span>,<span class="number">812</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">01</span>,<span class="number">826</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">01</span>,<span class="number">826</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">01</span>,<span class="number">826</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">01</span>,<span class="number">826</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">01</span>,<span class="number">898</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">242</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">194481424</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">242</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl<span class="meta">@b</span>978d10]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">245</span> mybatis.RoleMapper.getRole: ==&gt;  Preparing: select id, role_name as roleName, note from t_role where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">274</span> mybatis.RoleMapper.getRole: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">301</span> mybatis.RoleMapper.getRole: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">302</span> mybatis.SqlSessionFactoryUtils: John</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">302</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl<span class="meta">@b</span>978d10]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">302</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl<span class="meta">@b</span>978d10]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">03</span> <span class="number">20</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">302</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">194481424</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="MyBatis配置"><a href="#MyBatis配置" class="headerlink" title="MyBatis配置"></a>MyBatis配置</h1></blockquote>
<p>MyBatis配置文件并不复杂，其所有元素如下所示：<br>MyBatis配置项的顺序不能颠倒。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span> <span class="comment">&lt;!--配置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>/&gt;</span> <span class="comment">&lt;!--属性--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">settings</span>/&gt;</span> <span class="comment">&lt;!--设置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAliases</span>/&gt;</span> <span class="comment">&lt;!--类型命名--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeHandlers</span>/&gt;</span> <span class="comment">&lt;!--类型处理器--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">objectFactory</span>/&gt;</span> <span class="comment">&lt;!--对象工厂--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>/&gt;</span> <span class="comment">&lt;!--插件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span>&gt;</span> <span class="comment">&lt;!--配置环境--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span>&gt;</span> <span class="comment">&lt;!--环境变量--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span>/&gt;</span> <span class="comment">&lt;!--事务管理器--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span>/&gt;</span> <span class="comment">&lt;!--数据源--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">databaseIdProvider</span>/&gt;</span> <span class="comment">&lt;!--数据库厂商标识--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>/&gt;</span> <span class="comment">&lt;!--映射器--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="properties属性"><a href="#properties属性" class="headerlink" title="properties属性"></a>properties属性</h2><p>properties属性可以给系统配置一些运行参数，可以放在XML文件或者properties文件中，而不是放在Java编码汇总，方便参数修改。<br>三种方式配置：</p>
<ul>
<li>property子元素</li>
<li>properties文件</li>
<li>程序代码传递</li>
</ul>
<h3 id="property子元素"><a href="#property子元素" class="headerlink" title="property子元素"></a>property子元素</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Config 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"database.driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"database.url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"database.username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"database.password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 别名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"role"</span> <span class="attr">type</span>=<span class="string">"MyBatis.Role"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数据库环境 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"${database.driver}"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"${database.url}"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"${database.username}"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"${database.password}"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 映射文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"MyBatis.RoleMapper.xml"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="使用properties文件"><a href="#使用properties文件" class="headerlink" title="使用properties文件"></a>使用properties文件</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">database.driver=com.mysql.cj.jdbc.Driver</span><br><span class="line">database.url=jdbc:mysql://localhost:3306/ssm</span><br><span class="line">database.username=root</span><br><span class="line">database.password=123456</span><br></pre></td></tr></tbody></table></figure>
<p>在xml配置通过<properties>属性resource来引入properties文件</properties></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"jdbc.properties"</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="使用程序传递方式传递参数"><a href="#使用程序传递方式传递参数" class="headerlink" title="使用程序传递方式传递参数"></a>使用程序传递方式传递参数</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">String resource = <span class="string">"mybatis-config.xml"</span>;</span><br><span class="line">InputStream inputStream;</span><br><span class="line">InputStream in = Resources.getResourceAsStream(<span class="string">"jdbc.properties"</span>);</span><br><span class="line">Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">props.load(in);</span><br><span class="line">String username = props.getProperty(<span class="string">"database.username"</span>);</span><br><span class="line">String password = props.getProperty(<span class="string">"database.password"</span>);</span><br><span class="line"><span class="comment">//解密用户和密码，并在属性中重置</span></span><br><span class="line">props.put(<span class="string">"database.username"</span>, CodeUtils.decode(username));</span><br><span class="line">props.put(<span class="string">"database.password"</span>, CodeUtils.decode(password));</span><br><span class="line">inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line"><span class="comment">//使用程序传递的方式覆盖原有的properties属性参数</span></span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream, props);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><p>最优先的是程序传递的方式，其次是使用properties文件的方式，最后是使用property子元素的方式，MyBatis会根据优先级来覆盖原先配置的属性值。</p>
<h2 id="settings设置"><a href="#settings设置" class="headerlink" title="settings设置"></a>settings设置</h2><p>settings是MyBatis中最复杂的配置，它能深刻影响MyBatis底层的运行，但是在大部分情况下使用默认值便可以运行，所以在大部分情况下不需要大量配置它，只需要修改一些常用的规则即可，比如自动映射、驼峰命名映射、级联规则、是否启动缓存、执行器（Executor）类型等。</p>
<table>
<thead>
<tr>
<th align="center">配置项</th>
<th align="center">作用</th>
<th align="center">配置选项说明</th>
<th align="center">默认值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">cacheEnable</td>
<td align="center">改配置影响所有映射器中配置缓存的全局开关</td>
<td align="center">true|false</td>
<td align="center">true</td>
</tr>
<tr>
<td align="center">lazyLoadingEnable</td>
<td align="center">延迟加载的全局开关。当开启时，所有关联对象都会延迟加载。在特定关联关系中可通过设置fetchType属性来覆盖该项的开关状态</td>
<td align="center">true|false</td>
<td align="center">false</td>
</tr>
<tr>
<td align="center">aggressiveLazyLoading</td>
<td align="center">当启用时，对任意延迟属性的调用会使带有延迟加载属性的对象完整加载；反之，每种属性将会按需加载</td>
<td align="center">true|false</td>
<td align="center">版本3.4.1（不包含）<br>之前true，之后false</td>
</tr>
<tr>
<td align="center">multipleResultSetsEnabled</td>
<td align="center">是否允许单一语句返回多结果集（需要兼容驱动）</td>
<td align="center">true|false</td>
<td align="center">true</td>
</tr>
<tr>
<td align="center">useColumnLabel</td>
<td align="center">使用列标签代替列名。不同的驱动会有不同的表现，具体可参考相关驱动文档或通过测试这两种不同的模式来观察所用驱动的结果</td>
<td align="center">true\false</td>
<td align="center">true</td>
</tr>
<tr>
<td align="center">useGeneratedKeys</td>
<td align="center">允许JDBC支持自动生成主键，需要驱动兼容。如果设置为true，则这个设置强制使用自动生成主键，尽管一些驱动不能兼容但仍可正常工作（比如Derby）</td>
<td align="center">true\false</td>
<td align="center">false</td>
</tr>
<tr>
<td align="center">autoMappingBehavior</td>
<td align="center">指定MyBatis应如何自动映射列到字段或属性。NONE表示取消自动映射：PARTIAL表示自动映射，没有定义嵌套结果集合映射结果集。FULL会自动映射任意复杂的结果集（无论是否嵌套）</td>
<td align="center">NONE、PARTIAL、FULL</td>
<td align="center">PARTIAL</td>
</tr>
<tr>
<td align="center">autoMappingUnknownColumnBehavior</td>
<td align="center">指定自动映射当中未知列（或未知属性类型）时的行为，默认是不处理，只有当日志级别达到WARN级别或者以下，才会显示相关日志，如果处理失败会抛出SqlSessionException异常</td>
<td align="center">NONE、PARTIAL、FULL</td>
<td align="center">NONE</td>
</tr>
<tr>
<td align="center">defaultExecutorType</td>
<td align="center">配置默认的执行器。SIMPLE是普通的执行器；REUSE会重用预处理语句（prepared statements）；BATCH执行器将重用语句并执行批量更新</td>
<td align="center">SIMPLE、REUSE、BATCH</td>
<td align="center">SIMPLE</td>
</tr>
<tr>
<td align="center">defaultStatementTimeout</td>
<td align="center">设置超时时间，它决定驱动等待数据库响应的秒数</td>
<td align="center">任何正整数</td>
<td align="center">Not Set(null)</td>
</tr>
<tr>
<td align="center">defaultFetchSize</td>
<td align="center">设置数据库驱动程序默认返回的条数限制，此参数可以重新设置</td>
<td align="center">任何正整数</td>
<td align="center">Not Set(null)</td>
</tr>
<tr>
<td align="center">safeRowBoundsEnabled</td>
<td align="center">允许在嵌套语句中使用分页（RowBounds）。如果允许，设置false</td>
<td align="center">true|false</td>
<td align="center">false</td>
</tr>
<tr>
<td align="center">safeResultHandlerEnabled</td>
<td align="center">允许在嵌套语句中使用分页（ResultHandler）。如果允许，设置false</td>
<td align="center">true|false</td>
<td align="center">true</td>
</tr>
<tr>
<td align="center">mapUnderscoreTocAmelCase</td>
<td align="center">是否开启自动驼峰命名规则映射，即从经典数据库列名A_COLUMN到经典Java属性名aColumn的类似映射</td>
<td align="center">true|false</td>
<td align="center">false</td>
</tr>
<tr>
<td align="center">localCacheScope</td>
<td align="center">MyBatis利用本地缓存机制（Local Cache）防止循环引用（circular references）和加速重复嵌套查询。默认值为SESSION。这种情况下会缓存一个会话中执行的所有查询。若设置值为STATEMENT，本地会话仅用在语句执行上，对相同SqlSession的不同调用将不会共享数据</td>
<td align="center">SESSION|STATEMENT</td>
<td align="center">SESSION</td>
</tr>
<tr>
<td align="center">jdbcTypeForNull</td>
<td align="center">当没有为参数提供特定的JDBC类型时，为空值指定JDBC类型。某些驱动需要指定列的JDBC类型，多数情况直接用一般类型即可，比如NULL，VARCHAR或OTHER</td>
<td align="center">NULL、VARCHAR、OTHER</td>
<td align="center">OTHER</td>
</tr>
<tr>
<td align="center">lazyLoadTriggerMethods</td>
<td align="center">指定哪个对象的方法除法一次延迟加载</td>
<td align="center">——</td>
<td align="center">equals、clone、hashCode、toString</td>
</tr>
<tr>
<td align="center">defaultScriptingLanuage</td>
<td align="center">指定动态SQL生成的默认语言</td>
<td align="center">——</td>
<td align="center">org.apache.ibatis.scripting.<br>xmltags.XMLDynamicLanguageDriver</td>
</tr>
<tr>
<td align="center">callSettersOnNulls</td>
<td align="center">指定当结果集中值为null时，是否调用映射对象的setter（map对象时为put）方法，这对于Map.keysSet()依赖或null值初始化时是有用的。注意，基本类型（int、boolean等）不能设置成null</td>
<td align="center">true|false</td>
<td align="center">false</td>
</tr>
<tr>
<td align="center">logPrefix</td>
<td align="center">指定MyBatis增加到日志名称的前缀</td>
<td align="center">任何字符串</td>
<td align="center">Not set</td>
</tr>
<tr>
<td align="center">logImpl</td>
<td align="center">指定MyBatis所用日志的具体实现，未指定时将自动查找</td>
<td align="center">SLF4J|LOG4J|LOG4J2|<br>JDK_LOGGING|COMMONS_LOGGING|<br>STDOUT_LOGGING|NO_LOGGING</td>
<td align="center">Not set</td>
</tr>
<tr>
<td align="center">proxyFactory</td>
<td align="center">指定MyBatis创建具有延迟加载能力的对象所用到的代理工具</td>
<td align="center">CGLIB|JAVASSIST</td>
<td align="center">JAVASSIST<br>（MyBatis版本为3.3及以上的）</td>
</tr>
<tr>
<td align="center">vfsImpl</td>
<td align="center">指定VFS的实现类</td>
<td align="center">提供VFS类的全限定名，如果存在多个，可以使用逗号分隔</td>
<td align="center">Not set</td>
</tr>
<tr>
<td align="center">useActualParamName</td>
<td align="center">允许用方法参数中声明的实际名称引用参数。要使用此功能，项目必须被编译为Java8参数的选择。（从版本3.4.1开始可以使用）</td>
<td align="center">true|false</td>
<td align="center">true</td>
</tr>
</tbody></table>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadingEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"multipleResultSetsEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"useColumnLabel"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"useGeneratedKeys"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"autoMappingBehavior"</span> <span class="attr">value</span>=<span class="string">"PARTIAL"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"autoMappingUnknownColumnBehavior"</span> <span class="attr">value</span>=<span class="string">"WARNING"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultExecutorType"</span> <span class="attr">value</span>=<span class="string">"SIMPLE"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultStatementTimeout"</span> <span class="attr">value</span>=<span class="string">"25"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultFetchSize"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"safeRowBoundsEnabled"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"localCacheScope"</span> <span class="attr">value</span>=<span class="string">"SESSION"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"jdbcTypeForNull"</span> <span class="attr">value</span>=<span class="string">"OTHER"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadTriggerMethods"</span> <span class="attr">value</span>=<span class="string">"equals,clone,hashCode,toString"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="typeAliases别名"><a href="#typeAliases别名" class="headerlink" title="typeAliases别名"></a>typeAliases别名</h2><p>由于类的全限定名称很长，需要大量使用的时候，总写那么长的名称不方便。</p>
<h3 id="系统定义别名"><a href="#系统定义别名" class="headerlink" title="系统定义别名"></a>系统定义别名</h3><p>在MyBatis的初始化过程中，系统自动初始化了一些别名。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.ResolverUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.ResolverUtil.IsA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeAliasRegistry</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Class&lt;?&gt;&gt; typeAliases = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TypeAliasRegistry</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"string"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"byte"</span>, Byte<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"long"</span>, Long<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"short"</span>, Short<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"int"</span>, Integer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"integer"</span>, Integer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"double"</span>, Double<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"float"</span>, Float<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"boolean"</span>, Boolean<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"byte[]"</span>, Byte[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"long[]"</span>, Long[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"short[]"</span>, Short[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"int[]"</span>, Integer[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"integer[]"</span>, Integer[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"double[]"</span>, Double[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"float[]"</span>, Float[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"boolean[]"</span>, Boolean[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_byte"</span>, Byte.TYPE);</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_long"</span>, Long.TYPE);</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_short"</span>, Short.TYPE);</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_int"</span>, Integer.TYPE);</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_integer"</span>, Integer.TYPE);</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_double"</span>, Double.TYPE);</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_float"</span>, Float.TYPE);</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_boolean"</span>, Boolean.TYPE);</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_byte[]"</span>, <span class="keyword">byte</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_long[]"</span>, <span class="keyword">long</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_short[]"</span>, <span class="keyword">short</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_int[]"</span>, <span class="keyword">int</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_integer[]"</span>, <span class="keyword">int</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_double[]"</span>, <span class="keyword">double</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_float[]"</span>, <span class="keyword">float</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"_boolean[]"</span>, <span class="keyword">boolean</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"date"</span>, Date<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"decimal"</span>, BigDecimal<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"bigdecimal"</span>, BigDecimal<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"biginteger"</span>, BigInteger<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"object"</span>, Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"date[]"</span>, Date[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"decimal[]"</span>, BigDecimal[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"bigdecimal[]"</span>, BigDecimal[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"biginteger[]"</span>, BigInteger[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"object[]"</span>, Object[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"map"</span>, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"hashmap"</span>, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"list"</span>, List<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"arraylist"</span>, ArrayList<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"collection"</span>, Collection<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"iterator"</span>, Iterator<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerAlias(<span class="string">"ResultSet"</span>, ResultSet<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Class&lt;T&gt; <span class="title">resolveAlias</span><span class="params">(String string)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">if</span> (string == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                String key = string.toLowerCase(Locale.ENGLISH);</span><br><span class="line">                Class value;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.typeAliases.containsKey(key)) {</span><br><span class="line">                    value = (Class)<span class="keyword">this</span>.typeAliases.get(key);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    value = Resources.classForName(string);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (ClassNotFoundException var4) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"Could not resolve type alias '"</span> + string + <span class="string">"'.  Cause: "</span> + var4, var4);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAliases</span><span class="params">(String packageName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.registerAliases(packageName, Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAliases</span><span class="params">(String packageName, Class&lt;?&gt; superType)</span> </span>{</span><br><span class="line">        ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = <span class="keyword">new</span> ResolverUtil();</span><br><span class="line">        resolverUtil.find(<span class="keyword">new</span> IsA(superType), packageName);</span><br><span class="line">        Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; typeSet = resolverUtil.getClasses();</span><br><span class="line">        Iterator var5 = typeSet.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var5.hasNext()) {</span><br><span class="line">            Class&lt;?&gt; type = (Class)var5.next();</span><br><span class="line">            <span class="keyword">if</span> (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !type.isMemberClass()) {</span><br><span class="line">                <span class="keyword">this</span>.registerAlias(type);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(Class&lt;?&gt; type)</span> </span>{</span><br><span class="line">        String alias = type.getSimpleName();</span><br><span class="line">        Alias aliasAnnotation = (Alias)type.getAnnotation(Alias<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (aliasAnnotation != <span class="keyword">null</span>) {</span><br><span class="line">            alias = aliasAnnotation.value();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.registerAlias(alias, type);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(String alias, Class&lt;?&gt; value)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (alias == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"The parameter alias cannot be null"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            String key = alias.toLowerCase(Locale.ENGLISH);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.typeAliases.containsKey(key) &amp;&amp; <span class="keyword">this</span>.typeAliases.get(key) != <span class="keyword">null</span> &amp;&amp; !((Class)<span class="keyword">this</span>.typeAliases.get(key)).equals(value)) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"The alias '"</span> + alias + <span class="string">"' is already mapped to the value '"</span> + ((Class)<span class="keyword">this</span>.typeAliases.get(key)).getName() + <span class="string">"'."</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">this</span>.typeAliases.put(key, value);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(String alias, String value)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">this</span>.registerAlias(alias, Resources.classForName(value));</span><br><span class="line">        } <span class="keyword">catch</span> (ClassNotFoundException var4) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"Error registering type alias "</span> + alias + <span class="string">" for "</span> + value + <span class="string">". Cause: "</span> + var4, var4);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Class&lt;?&gt;&gt; getTypeAliases() {</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableMap(<span class="keyword">this</span>.typeAliases);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Configuration配置的别名。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//事务方式别名</span></span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"JDBC"</span>, JdbcTransactionFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"MANAGED"</span>, ManagedTransactionFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//数据源类型别名</span></span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"JNDI"</span>, JndiDataSourceFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"POOLED"</span>, PooledDataSourceFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"UNPOOLED"</span>, UnpooledDataSourceFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//缓存策略别名</span></span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"PERPETUAL"</span>, PerpetualCache<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"FIFO"</span>, FifoCache<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"LRU"</span>, LruCache<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"SOFT"</span>, SoftCache<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"WEAK"</span>, WeakCache<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//数据库标识别名</span></span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"DB_VENDOR"</span>, VendorDatabaseProvider<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//语言驱动类别名</span></span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"XML"</span>, XMLLanguageDriver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"RAW"</span>, RawLanguageDriver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//日志类别名</span></span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"SLF4J"</span>, Slf4jImpl<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">typeAliasRegistry.registerAlias(<span class="string">"COMMONS_LOGGING"</span>, JakartaCommonsLoggingImpl<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>
<h3 id="自定义别名"><a href="#自定义别名" class="headerlink" title="自定义别名"></a>自定义别名</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"role"</span> <span class="attr">type</span>=<span class="string">"com.louris.mybatis.Role"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.louris.mybatis.pojo"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>如果有很多类需要定义别名，那么可以用以下方式进行配置，比如”com.louris.mybatis.pojo”包中的类，将其中第一个字母变为小写作为其别名，比如类Role的别名会编程role，User的别名为user。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.louris.mybatis.pojo"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>上述这种可能出现重名，需要注解@Alias()进行区分。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Alias</span>(<span class="string">"user3"</span>)</span><br><span class="line"><span class="keyword">public</span> Class User{</span><br><span class="line">  ....</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="typeHandler类型转换器"><a href="#typeHandler类型转换器" class="headerlink" title="typeHandler类型转换器"></a>typeHandler类型转换器</h2><p>在JDBC中，需要在PreparedStatement对象中设置那些已经预编译过的SQL语句的参数。执行SQL后，会通过ResultSet对象获取得到数据库的数据，而这些MyBatis是根据数据的类型通过typeHandler来实现的。在typeHandler中，分为jdbcType和javaType，其中jdbcType用于定义数据库类型，而javaType用于定义Java类型，那么typeHandler的作用就是承担jdbcType和javaType之间的相互转换。多数情况下爱不需要我们配置typeHandler、jdbcType、javaType，因为MyBatis会探测应该使用什么类型的typeHandler进行处理，但是有些场景无法探测到。对于那些需要使用自定义枚举的场景，或者数据库使用特殊数据类型的场景，可以使用自定义的typeHandler去处理类型之间的转换问题。</p>
<h3 id="系统定义的typeHandler"><a href="#系统定义的typeHandler" class="headerlink" title="系统定义的typeHandler"></a>系统定义的typeHandler</h3><ul>
<li>BooleanTypeHandler</li>
<li>ByteTypeHandler</li>
<li>IntegerTypeHanlder</li>
</ul>
<p>…</p>
<p>这些都是MyBatis系统已经创建好的typeHandler，大部的情况下无须显式地声明jdbcType和javaType，或者用typeHandler去指定typeHandler来实现数据类型转换，因为MyBatis系统会自己探测。</p>
<p>在MyBatis中typeHandler都要实现接口org.apache.ibatis.type.TypeHandler：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TypeHandler</span>&lt;<span class="title">T</span>&gt;</span>{</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, T parameter, jdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">  <span class="function">T <span class="title">getResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">  <span class="function">T <span class="title">getResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">  <span class="function">T <span class="title">getResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span> throw SQLException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>而各类typeHandler都是集成org.apache.ibatis.BaseTypeHandler</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.CallableStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.result.ResultMapException;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseTypeHandler</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">TypeReference</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">TypeHandler</span>&lt;<span class="title">T</span>&gt; </span>{</span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">protected</span> Configuration configuration;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseTypeHandler</span><span class="params">()</span> </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfiguration</span><span class="params">(Configuration c)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.configuration = c;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">if</span> (parameter == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">if</span> (jdbcType == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"JDBC requires that the JdbcType must be specified for all nullable parameters."</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                ps.setNull(i, jdbcType.TYPE_CODE);</span><br><span class="line">            } <span class="keyword">catch</span> (SQLException var7) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"Error setting null for parameter #"</span> + i + <span class="string">" with JdbcType "</span> + jdbcType + <span class="string">" . Try setting a different JdbcType for this parameter or a different jdbcTypeForNull configuration property. Cause: "</span> + var7, var7);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">this</span>.setNonNullParameter(ps, i, parameter, jdbcType);</span><br><span class="line">            } <span class="keyword">catch</span> (Exception var6) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"Error setting non null for parameter #"</span> + i + <span class="string">" with JdbcType "</span> + jdbcType + <span class="string">" . Try setting a different JdbcType for this parameter or a different configuration property. Cause: "</span> + var6, var6);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getResult</span><span class="params">(ResultSet rs, String columnName)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getNullableResult(rs, columnName);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception var4) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ResultMapException(<span class="string">"Error attempting to get column '"</span> + columnName + <span class="string">"' from result set.  Cause: "</span> + var4, var4);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getNullableResult(rs, columnIndex);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception var4) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ResultMapException(<span class="string">"Error attempting to get column #"</span> + columnIndex + <span class="string">" from result set.  Cause: "</span> + var4, var4);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getNullableResult(cs, columnIndex);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception var4) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ResultMapException(<span class="string">"Error attempting to get column #"</span> + columnIndex + <span class="string">" from callable statement.  Cause: "</span> + var4, var4);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setNonNullParameter</span><span class="params">(PreparedStatement var1, <span class="keyword">int</span> var2, T var3, JdbcType var4)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">getNullableResult</span><span class="params">(ResultSet var1, String var2)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">getNullableResult</span><span class="params">(ResultSet var1, <span class="keyword">int</span> var2)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">getNullableResult</span><span class="params">(CallableStatement var1, <span class="keyword">int</span> var2)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>通过BaseTypeHandler，MyBatis把javaType和jdbcType相互转换，并通过org.apache.ibatis.type.TypeHandlerRegistry类对象的register方法进行注册。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TypeHandlerRegistry</span><span class="params">(Configuration configuration)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.jdbcTypeHandlerMap = <span class="keyword">new</span> EnumMap(JdbcType<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">this</span>.typeHandlerMap = <span class="keyword">new</span> ConcurrentHashMap();</span><br><span class="line">    <span class="keyword">this</span>.allTypeHandlersMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="keyword">this</span>.defaultEnumTypeHandler = EnumTypeHandler<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    <span class="keyword">this</span>.unknownTypeHandler = <span class="keyword">new</span> UnknownTypeHandler(configuration);</span><br><span class="line">    <span class="keyword">this</span>.register((Class)Boolean<span class="class">.<span class="keyword">class</span>, (<span class="title">TypeHandler</span>)(<span class="title">new</span> <span class="title">BooleanTypeHandler</span>()))</span>;</span><br><span class="line">    <span class="keyword">this</span>.register((Class)Boolean.TYPE, (TypeHandler)(<span class="keyword">new</span> BooleanTypeHandler()));</span><br><span class="line">    <span class="keyword">this</span>.register((JdbcType)JdbcType.BOOLEAN, (TypeHandler)(<span class="keyword">new</span> BooleanTypeHandler()));</span><br><span class="line">    <span class="keyword">this</span>.register((JdbcType)JdbcType.BIT, (TypeHandler)(<span class="keyword">new</span> BooleanTypeHandler()));</span><br><span class="line">    <span class="keyword">this</span>.register((Class)Byte<span class="class">.<span class="keyword">class</span>, (<span class="title">TypeHandler</span>)(<span class="title">new</span> <span class="title">ByteTypeHandler</span>()))</span>;</span><br><span class="line">    <span class="keyword">this</span>.register((Class)Byte.TYPE, (TypeHandler)(<span class="keyword">new</span> ByteTypeHandler()));</span><br><span class="line">    <span class="keyword">this</span>.register((JdbcType)JdbcType.TINYINT, (TypeHandler)(<span class="keyword">new</span> ByteTypeHandler()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="自定义typeHandler"><a href="#自定义typeHandler" class="headerlink" title="自定义typeHandler"></a>自定义typeHandler</h3><h4 id="MyTypeHandler"><a href="#MyTypeHandler" class="headerlink" title="MyTypeHandler"></a>MyTypeHandler</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.JdbcType;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.TypeHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.CallableStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTypeHandler</span> <span class="keyword">implements</span> <span class="title">TypeHandler</span>&lt;<span class="title">String</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(MyTypeHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(PreparedStatement preparedStatement, <span class="keyword">int</span> i, String parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        logger.info(<span class="string">"设置string参数【"</span> + parameter + <span class="string">"】"</span>);</span><br><span class="line">        preparedStatement.setString(i, parameter);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getResult</span><span class="params">(ResultSet resultSet, String columnName)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        String result = resultSet.getString(columnName);</span><br><span class="line">        logger.info(<span class="string">"读取string参数1【"</span> + result + <span class="string">"】"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getResult</span><span class="params">(ResultSet resultSet, <span class="keyword">int</span> i)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        String result = resultSet.getString(i);</span><br><span class="line">        logger.info(<span class="string">"读取string参数2【"</span> + result + <span class="string">"】"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getResult</span><span class="params">(CallableStatement callableStatement, <span class="keyword">int</span> i)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        String result = callableStatement.getString(i);</span><br><span class="line">        logger.info(<span class="string">"读取string参数3【"</span> + result + <span class="string">"】"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="RoleMapper-xml-1"><a href="#RoleMapper-xml-1" class="headerlink" title="RoleMapper.xml"></a>RoleMapper.xml</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"mybatis.RoleMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"roleMapper"</span> <span class="attr">type</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span> <span class="attr">jdbcType</span>=<span class="string">"VARCHAR"</span> <span class="attr">javaType</span>=<span class="string">"string"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"note"</span> <span class="attr">column</span>=<span class="string">"note"</span> <span class="attr">typeHandler</span>=<span class="string">"mybatis.MyTypeHandler"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        insert into t_role(role_name, note) values(#{roleName}, #{note})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">        delete from t_role where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        update t_role set role_name = #{roleName}, note = #{note} where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select id, role_name as roleName, note from t_role where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select id, role_name as roleName, note from t_role</span><br><span class="line">        where role_name like concat('%', #{roleName, jdbcType=VARCHAR, javaType=string}, '%')</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles2"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultMap</span>=<span class="string">"roleMapper"</span>&gt;</span></span><br><span class="line">        select id, role_name, note from t_role</span><br><span class="line">        where note like concat('%', #{note, typeHandler=mybatis.MyTypeHandler}, '%')</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="RoleMapper-1"><a href="#RoleMapper-1" class="headerlink" title="RoleMapper"></a>RoleMapper</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">    <span class="function">Role <span class="title">getRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findRoles</span><span class="params">(String roleName)</span></span>;</span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findRoles2</span><span class="params">(String note)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="SqlSessionFactoryUtils"><a href="#SqlSessionFactoryUtils" class="headerlink" title="SqlSessionFactoryUtils"></a>SqlSessionFactoryUtils</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactoryUtils</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Class&lt;SqlSessionFactoryUtils&gt; LOCK = SqlSessionFactoryUtils<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SqlSessionFactoryUtils</span><span class="params">()</span></span>{} <span class="comment">//单例模式</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">getSqlSessionFactory</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK){</span><br><span class="line">            <span class="keyword">if</span>(sqlSessionFactory != <span class="keyword">null</span>) <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">            String resource = <span class="string">"mybatis\\mybatis-config.xml"</span>;</span><br><span class="line">            InputStream inputStream;</span><br><span class="line">            <span class="keyword">try</span>{</span><br><span class="line">                inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">                sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">            }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title">openSqlSession</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(sqlSessionFactory == <span class="keyword">null</span>) getSqlSessionFactory();</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory.openSession();</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        <span class="comment">//log4j.properties默认是在src目录下，如果不是需要重新设置</span></span><br><span class="line">        <span class="comment">//加载log4j的配置文件</span></span><br><span class="line"><span class="comment">//        FileInputStream fileInputStream = null;</span></span><br><span class="line"><span class="comment">//        try{</span></span><br><span class="line"><span class="comment">//            Properties properties = new Properties();</span></span><br><span class="line"><span class="comment">//            fileInputStream = new FileInputStream("src\\mybatis\\log4j.properties");</span></span><br><span class="line"><span class="comment">//            properties.load(fileInputStream);</span></span><br><span class="line"><span class="comment">//            PropertyConfigurator.configure(properties);</span></span><br><span class="line"><span class="comment">//        }catch (Exception e){</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        }finally {</span></span><br><span class="line"><span class="comment">//            if(fileInputStream != null){</span></span><br><span class="line"><span class="comment">//                try{</span></span><br><span class="line"><span class="comment">//                    fileInputStream.close();</span></span><br><span class="line"><span class="comment">//                }catch (IOException e){</span></span><br><span class="line"><span class="comment">//                    e.printStackTrace();</span></span><br><span class="line"><span class="comment">//                }</span></span><br><span class="line"><span class="comment">//            }</span></span><br><span class="line"><span class="comment">//        }</span></span><br><span class="line">        Logger logger = Logger.getLogger(SqlSessionFactoryUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            sqlSession = SqlSessionFactoryUtils.openSqlSession();</span><br><span class="line">            RoleMapper roleMapper = sqlSession.getMapper(RoleMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            Role role = roleMapper.getRole(<span class="number">1L</span>);</span><br><span class="line">            <span class="comment">//System.out.println(JSON.toJSONString(role));</span></span><br><span class="line">            logger.info(role.getRoleName());</span><br><span class="line">            List&lt;Role&gt; list= roleMapper.findRoles(pageParams,<span class="string">"John"</span>);</span><br><span class="line">            logger.info(list.get(<span class="number">0</span>).getNote());</span><br><span class="line"></span><br><span class="line">            List&lt;Role&gt; list1 = roleMapper.findRoles2(<span class="string">"Hello World!"</span>);</span><br><span class="line">            logger.info(list1.get(<span class="number">0</span>).getRoleName());</span><br><span class="line">        }<span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>) sqlSession.close();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="运行结果-1"><a href="#运行结果-1" class="headerlink" title="运行结果"></a>运行结果</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=60353:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">27</span>,<span class="number">625</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">27</span>,<span class="number">639</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">27</span>,<span class="number">639</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">27</span>,<span class="number">639</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">27</span>,<span class="number">639</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">27</span>,<span class="number">718</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">062</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">1940445711</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">062</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">73</span>a8da0f]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">065</span> mybatis.RoleMapper.getRole: ==&gt;  Preparing: select id, role_name as roleName, note from t_role where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">098</span> mybatis.RoleMapper.getRole: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">128</span> mybatis.RoleMapper.getRole: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">129</span> mybatis.SqlSessionFactoryUtils: John</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">129</span> mybatis.RoleMapper.findRoles: ==&gt;  Preparing: select id, role_name as roleName, <span class="function">note from t_role where role_name like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span></span></span><br><span class="line"><span class="function">DEBUG 2021-09-05 11:31:28,130 mybatis.RoleMapper.findRoles: </span>==&gt; Parameters: John(String)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">131</span> mybatis.RoleMapper.findRoles: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">131</span> mybatis.SqlSessionFactoryUtils: Hello World!</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">131</span> mybatis.RoleMapper.findRoles2: ==&gt;  Preparing: select id, role_name, <span class="function">note from t_role where note like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span></span></span><br><span class="line"><span class="function"> INFO 2021-09-05 11:31:28,132 mybatis.MyTypeHandler: 设置string参数【Hello World!】</span></span><br><span class="line"><span class="function">DEBUG 2021-09-05 11:31:28,132 mybatis.RoleMapper.findRoles2: </span>==&gt; Parameters: Hello World!(String)</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">134</span> mybatis.MyTypeHandler: 读取string参数<span class="number">1</span>【Hello World!】</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">134</span> mybatis.RoleMapper.findRoles2: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">135</span> mybatis.SqlSessionFactoryUtils: John</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">135</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">73</span>a8da0f]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">135</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">73</span>a8da0f]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">28</span>,<span class="number">135</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">1940445711</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="枚举typeHandler"><a href="#枚举typeHandler" class="headerlink" title="枚举typeHandler"></a>枚举typeHandler</h3><p>在绝多大数情况下，typeHandler因为枚举而使用，MyBatis已经定义了两个类作为枚举类型的支持：</p>
<ul>
<li>EnumOrdinalTypeHandler</li>
<li>EnumTypeHandler</li>
</ul>
<p>数据库预先插入一条数据：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert t_user values(1, 'zhangsan', '123456', '1', '13699988874', '0755-88888888', 'zhangsan@163.com', 'note...');</span><br></pre></td></tr></tbody></table></figure>

<h4 id="UserMapper-xml"><a href="#UserMapper-xml" class="headerlink" title="UserMapper.xml"></a>UserMapper.xml</h4><h5 id="EnumOrdinalTypeHandler方式"><a href="#EnumOrdinalTypeHandler方式" class="headerlink" title="EnumOrdinalTypeHandler方式"></a>EnumOrdinalTypeHandler方式</h5><p>EnumOrdinalTypeHandler是按MyBatis根据枚举数组下标索引的方式进行匹配的，也是枚举类型的默认转换类，它要求数据库返回一个整数作为其下标，它会根据下标找到对应的枚举类型。<br>详见运行结果①中，sex为1返回的是FEMAL的（0，‘女’)</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"mybatis.UserMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userMapper"</span> <span class="attr">type</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userName"</span> <span class="attr">column</span>=<span class="string">"user_name"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"password"</span> <span class="attr">column</span>=<span class="string">"password"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">column</span>=<span class="string">"sex"</span> <span class="attr">typeHandler</span>=<span class="string">"org.apache.ibatis.type.EnumOrdinalTypeHandler"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"mobile"</span> <span class="attr">column</span>=<span class="string">"mobile"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"tel"</span> <span class="attr">column</span>=<span class="string">"tel"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"email"</span> <span class="attr">column</span>=<span class="string">"email"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"note"</span> <span class="attr">column</span>=<span class="string">"note"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser"</span> <span class="attr">resultMap</span>=<span class="string">"userMapper"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">        select id, user_name, password, sex, mobile, tel, email, note from t_user where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h5 id="EnumTypeHandler方式"><a href="#EnumTypeHandler方式" class="headerlink" title="EnumTypeHandler方式"></a>EnumTypeHandler方式</h5><p>EnumTypeHandler会把使用的名称转化为对应的枚举，比如它会根据数据库返回的字符串“MALE”，进行Enum.valueOf(SexEnum.class, “MALE”);转换；将对应sex字段改成”MALE”进行测试，见运行结果②；</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"mybatis.UserMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userMapper"</span> <span class="attr">type</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userName"</span> <span class="attr">column</span>=<span class="string">"user_name"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"password"</span> <span class="attr">column</span>=<span class="string">"password"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">column</span>=<span class="string">"sex"</span> <span class="attr">typeHandler</span>=<span class="string">"org.apache.ibatis.type.EnumTypeHandler"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"mobile"</span> <span class="attr">column</span>=<span class="string">"mobile"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"tel"</span> <span class="attr">column</span>=<span class="string">"tel"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"email"</span> <span class="attr">column</span>=<span class="string">"email"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"note"</span> <span class="attr">column</span>=<span class="string">"note"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser"</span> <span class="attr">resultMap</span>=<span class="string">"userMapper"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">        select id, user_name, password, sex, mobile, tel, email, note from t_user where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="SexEnum"><a href="#SexEnum" class="headerlink" title="SexEnum"></a>SexEnum</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> SexEnum {</span><br><span class="line"></span><br><span class="line">    MALE(<span class="number">1</span>, <span class="string">"男"</span>),</span><br><span class="line">    FEMALE(<span class="number">0</span>, <span class="string">"女"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SexEnum</span><span class="params">(<span class="keyword">int</span> id, String name)</span></span>{ <span class="comment">//私有构造器</span></span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SexEnum <span class="title">getSexById</span><span class="params">(<span class="keyword">int</span> id)</span></span>{</span><br><span class="line">        <span class="keyword">for</span>(SexEnum sex : SexEnum.values()){</span><br><span class="line">            <span class="keyword">if</span>(sex.getId() == id) <span class="keyword">return</span> sex;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(java.lang.String name)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="User"><a href="#User" class="headerlink" title="User"></a>User</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> SexEnum sex;</span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line">    <span class="keyword">private</span> String tel;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmail</span><span class="params">(String email)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMobile</span><span class="params">(String mobile)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.mobile = mobile;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(SexEnum sex)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTel</span><span class="params">(String tel)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.tel = tel;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SexEnum <span class="title">getSex</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEmail</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> email;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMobile</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> mobile;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTel</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> tel;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="UserMapper"><a href="#UserMapper" class="headerlink" title="UserMapper"></a>UserMapper</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>{</span><br><span class="line">    <span class="function">User <span class="title">getUser</span><span class="params">(Long id)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="mybatis-config-xml-1"><a href="#mybatis-config-xml-1" class="headerlink" title="mybatis-config.xml"></a>mybatis-config.xml</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 别名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"role"</span> <span class="attr">type</span>=<span class="string">"mybatis.Role"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"mybatis.User"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数据库环境 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm?serverTimezone=UTC"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  映射文件  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mybatis\RoleMapper.xml"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mybatis\UserMapper.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="SqlSessionFactoryUtils-1"><a href="#SqlSessionFactoryUtils-1" class="headerlink" title="SqlSessionFactoryUtils"></a>SqlSessionFactoryUtils</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.PropertyConfigurator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactoryUtils</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Class&lt;SqlSessionFactoryUtils&gt; LOCK = SqlSessionFactoryUtils<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SqlSessionFactoryUtils</span><span class="params">()</span></span>{} <span class="comment">//单例模式</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">getSqlSessionFactory</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK){</span><br><span class="line">            <span class="keyword">if</span>(sqlSessionFactory != <span class="keyword">null</span>) <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">            String resource = <span class="string">"mybatis\\mybatis-config.xml"</span>;</span><br><span class="line">            InputStream inputStream;</span><br><span class="line">            <span class="keyword">try</span>{</span><br><span class="line">                inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">                sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">            }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title">openSqlSession</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(sqlSessionFactory == <span class="keyword">null</span>) getSqlSessionFactory();</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory.openSession();</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        <span class="comment">//log4j.properties默认是在src目录下，如果不是需要重新设置</span></span><br><span class="line">        <span class="comment">//加载log4j的配置文件</span></span><br><span class="line"><span class="comment">//        FileInputStream fileInputStream = null;</span></span><br><span class="line"><span class="comment">//        try{</span></span><br><span class="line"><span class="comment">//            Properties properties = new Properties();</span></span><br><span class="line"><span class="comment">//            fileInputStream = new FileInputStream("src\\mybatis\\log4j.properties");</span></span><br><span class="line"><span class="comment">//            properties.load(fileInputStream);</span></span><br><span class="line"><span class="comment">//            PropertyConfigurator.configure(properties);</span></span><br><span class="line"><span class="comment">//        }catch (Exception e){</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        }finally {</span></span><br><span class="line"><span class="comment">//            if(fileInputStream != null){</span></span><br><span class="line"><span class="comment">//                try{</span></span><br><span class="line"><span class="comment">//                    fileInputStream.close();</span></span><br><span class="line"><span class="comment">//                }catch (IOException e){</span></span><br><span class="line"><span class="comment">//                    e.printStackTrace();</span></span><br><span class="line"><span class="comment">//                }</span></span><br><span class="line"><span class="comment">//            }</span></span><br><span class="line"><span class="comment">//        }</span></span><br><span class="line">        Logger logger = Logger.getLogger(SqlSessionFactoryUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            sqlSession = SqlSessionFactoryUtils.openSqlSession();</span><br><span class="line"><span class="comment">//            RoleMapper roleMapper = sqlSession.getMapper(RoleMapper.class);</span></span><br><span class="line"><span class="comment">//            Role role = roleMapper.getRole(1L);</span></span><br><span class="line"><span class="comment">//            //System.out.println(JSON.toJSONString(role));</span></span><br><span class="line"><span class="comment">//            logger.info(role.getRoleName());</span></span><br><span class="line"><span class="comment">//            List&lt;Role&gt; list= roleMapper.findRoles("John");</span></span><br><span class="line"><span class="comment">//            logger.info(list.get(0).getNote());</span></span><br><span class="line"><span class="comment">//            List&lt;Role&gt; list1 = roleMapper.findRoles2("Hello World!");</span></span><br><span class="line"><span class="comment">//            logger.info(list1.get(0).getRoleName());</span></span><br><span class="line"></span><br><span class="line">            UserMapper userMapper = sqlSession.getMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            User user = userMapper.getUser(<span class="number">1L</span>);</span><br><span class="line">            logger.info(user.getSex().getName());</span><br><span class="line"></span><br><span class="line">        }<span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>) sqlSession.close();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="运行结果-2"><a href="#运行结果-2" class="headerlink" title="运行结果"></a>运行结果</h4><h5 id="结果①"><a href="#结果①" class="headerlink" title="结果①"></a>结果①</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=59199:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">169</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">183</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">183</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">183</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">183</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">264</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">619</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">1099717276</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">620</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">418</span>c5a9c]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">623</span> mybatis.UserMapper.getUser: ==&gt;  Preparing: select id, user_name, password, sex, mobile, tel, email, note from t_user where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">657</span> mybatis.UserMapper.getUser: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">685</span> mybatis.UserMapper.getUser: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">685</span> mybatis.SqlSessionFactoryUtils: 女</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">686</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">418</span>c5a9c]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">686</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">418</span>c5a9c]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">38</span>,<span class="number">687</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">1099717276</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h5 id="结果②"><a href="#结果②" class="headerlink" title="结果②"></a>结果②</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=63365:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">56</span>,<span class="number">478</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">56</span>,<span class="number">492</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">56</span>,<span class="number">492</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">56</span>,<span class="number">492</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">56</span>,<span class="number">492</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">56</span>,<span class="number">573</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">56</span>,<span class="number">940</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">33233312</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">56</span>,<span class="number">940</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">1f</span>b19a0]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">56</span>,<span class="number">943</span> mybatis.UserMapper.getUser: ==&gt;  Preparing: select id, user_name, password, sex, mobile, tel, email, note from t_user where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">56</span>,<span class="number">973</span> mybatis.UserMapper.getUser: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">57</span>,<span class="number">003</span> mybatis.UserMapper.getUser: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">57</span>,<span class="number">004</span> mybatis.SqlSessionFactoryUtils: 男</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">57</span>,<span class="number">005</span> mybatis.SqlSessionFactoryUtils: <span class="number">1</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">57</span>,<span class="number">005</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">1f</span>b19a0]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">57</span>,<span class="number">006</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">1f</span>b19a0]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">57</span>,<span class="number">006</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">33233312</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="自定义枚举typeHandler"><a href="#自定义枚举typeHandler" class="headerlink" title="自定义枚举typeHandler"></a>自定义枚举typeHandler</h4><p>MyBatis内部提供的两种转换的typeHandler有很大局限，更多时候需要我们使用自定义的typeHandler</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">update t_user set sex='1' where sex = 'MALE';</span><br><span class="line">alter table t_user modify sex int(10);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.JdbcType;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.MappedJdbcTypes;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.MappedTypes;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.TypeHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@MappedTypes</span>(SexEnum<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">MappedJdbcTypes</span>(<span class="title">JdbcType</span>.<span class="title">INTEGER</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SexEnumTypeHandler</span> <span class="keyword">implements</span> <span class="title">TypeHandler</span>&lt;<span class="title">SexEnum</span>&gt; </span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(PreparedStatement preparedStatement, <span class="keyword">int</span> i, SexEnum parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        preparedStatement.setInt(i, parameter.getId());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SexEnum <span class="title">getResult</span><span class="params">(ResultSet resultSet, String columnName)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">int</span> id = resultSet.getInt(columnName);</span><br><span class="line">        <span class="keyword">return</span> SexEnum.getSexById(id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SexEnum <span class="title">getResult</span><span class="params">(ResultSet resultSet, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">int</span> id = resultSet.getInt(columnIndex);</span><br><span class="line">        <span class="keyword">return</span> SexEnum.getSexById(id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SexEnum <span class="title">getResult</span><span class="params">(CallableStatement callableStatement, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">int</span> id = callableStatement.getInt(columnIndex);</span><br><span class="line">        <span class="keyword">return</span> SexEnum.getSexById(id);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这里涉及到两个注解，如下：</p>
<ul>
<li>@MappedTypes：指定与其关联的 Java类型列表。如果在javaType 属性中也同时指定，则注解上的配置将被忽略。</li>
<li>@MappedJdbcTypes：指定与其关联的JDBC 类型列表。如果在jdbcType 属性中也同时指定，则注解上的配置将被忽略。</li>
</ul>
<p>修改UserMapper中的typeHandler，执行结果如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=51458:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">30</span>,<span class="number">503</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">30</span>,<span class="number">519</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">30</span>,<span class="number">519</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">30</span>,<span class="number">519</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">30</span>,<span class="number">519</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">30</span>,<span class="number">621</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">30</span>,<span class="number">967</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">33233312</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">30</span>,<span class="number">967</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">1f</span>b19a0]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">30</span>,<span class="number">971</span> mybatis.UserMapper.getUser: ==&gt;  Preparing: select id, user_name, password, sex, mobile, tel, email, note from t_user where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">30</span>,<span class="number">998</span> mybatis.UserMapper.getUser: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">31</span>,<span class="number">023</span> mybatis.UserMapper.getUser: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">31</span>,<span class="number">024</span> mybatis.SqlSessionFactoryUtils: 男</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">31</span>,<span class="number">024</span> mybatis.SqlSessionFactoryUtils: <span class="number">1</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">31</span>,<span class="number">024</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">1f</span>b19a0]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">31</span>,<span class="number">025</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">1f</span>b19a0]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">16</span>:<span class="number">38</span>:<span class="number">31</span>,<span class="number">025</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">33233312</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="文件操作-（不太常用）"><a href="#文件操作-（不太常用）" class="headerlink" title="文件操作 （不太常用）"></a>文件操作 （不太常用）</h3><p>使用Blob字段，用于存入文件</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create table t_file(</span><br><span class="line">id int(12) not null auto_increment,</span><br><span class="line">content blob not null,</span><br><span class="line">primary key(id)  </span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestFile</span></span>{</span><br><span class="line">  <span class="keyword">long</span> id;</span><br><span class="line">  <span class="keyword">byte</span>[] content;</span><br><span class="line">  <span class="comment">//setter and getter</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"mybatis.FileMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"fileMapper"</span> <span class="attr">type</span>=<span class="string">"mybatis.TestFile"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"content"</span> <span class="attr">property</span>=<span class="string">"content"</span> <span class="attr">typeHandler</span>=<span class="string">"org.apache.ibatis.type.BlobTypeHandler"</span>/&gt;</span> <span class="tag">&lt;<span class="name">!-可以不用加typeHanlder，因为MyBatis可以自动检测---</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser"</span> <span class="attr">resultMap</span>=<span class="string">"fileMapper"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">        select id, content from t_file  where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertFile"</span> <span class="attr">parameterType</span>=<span class="string">"mybatis.TestFile"</span>&gt;</span></span><br><span class="line">      insert into t_file(content) values(#{content})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="ObjectFactory（对象工厂）"><a href="#ObjectFactory（对象工厂）" class="headerlink" title="ObjectFactory（对象工厂）"></a>ObjectFactory（对象工厂）</h2><p>当创建结果集时，MyBatis会使用一个对象工厂来完成创建这个结果集实例。在默认的情况下，MyBatis会使用其定义的对象工厂——DefaultObjectFactory(org.apache.ibatis.reflection.factory.DefaultObjectFactory)来完成对应的工作。</p>
<p>MyBatis允许注册自定义的ObjectFactory，需要实现接口org.apache.ibatis.reflection.factory.ObjectFactory，并给予配置。一般会考虑集成系统已经实现好的DefaultObjectFactory，通过一定的改写来完成我们所需要的工作。</p>
<h3 id="MyObjectFactory"><a href="#MyObjectFactory" class="headerlink" title="MyObjectFactory"></a>MyObjectFactory</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.factory.DefaultObjectFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObjectFactory</span> <span class="keyword">extends</span> <span class="title">DefaultObjectFactory</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8855122346740914948L</span>;</span><br><span class="line"></span><br><span class="line">    Logger logger = Logger.getLogger(MyObjectFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object temp = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.setProperties(properties);</span><br><span class="line">        logger.info(<span class="string">"初始化参数：【"</span> + properties.toString() +<span class="string">"】"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; type)</span> </span>{</span><br><span class="line">        T result =  <span class="keyword">super</span>.create(type);</span><br><span class="line">        logger.info(<span class="string">"创建对象："</span> + result.toString());</span><br><span class="line">        logger.info(<span class="string">"是否和上次创建的是同一个对象：【"</span> + (temp == result) + <span class="string">"】"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>{</span><br><span class="line">        T result = <span class="keyword">super</span>.create(type, constructorArgTypes, constructorArgs);</span><br><span class="line">        logger.info(<span class="string">"创建对象："</span> + result.toString());</span><br><span class="line">        temp = result;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">isCollection</span><span class="params">(Class&lt;T&gt; type)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.isCollection(type);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="mybatis-config-xml-2"><a href="#mybatis-config-xml-2" class="headerlink" title="mybatis-config.xml"></a>mybatis-config.xml</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">objectFactory</span> <span class="attr">type</span>=<span class="string">"mybatis.MyObjectFactory"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"propl"</span> <span class="attr">value</span>=<span class="string">"value1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">objectFactory</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="运行结果-3"><a href="#运行结果-3" class="headerlink" title="运行结果"></a>运行结果</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=55502:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">376</span> mybatis.MyObjectFactory: 初始化参数：【{propl=value1}】</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">395</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">408</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">408</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">408</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">408</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">516</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">864</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">1515403487</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">865</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">5</span>a5338df]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">867</span> mybatis.UserMapper.getUser: ==&gt;  Preparing: select id, user_name, password, sex, mobile, tel, email, note from t_user where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">893</span> mybatis.UserMapper.getUser: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">918</span> mybatis.MyObjectFactory: 创建对象：[]</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">918</span> mybatis.MyObjectFactory: 创建对象：[]</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">919</span> mybatis.MyObjectFactory: 是否和上次创建的是同一个对象：【<span class="keyword">true</span>】</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">920</span> mybatis.MyObjectFactory: 创建对象：mybatis.User@<span class="number">2f</span>62ea70</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">920</span> mybatis.MyObjectFactory: 创建对象：mybatis.User@<span class="number">2f</span>62ea70</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">920</span> mybatis.MyObjectFactory: 是否和上次创建的是同一个对象：【<span class="keyword">true</span>】</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">921</span> mybatis.UserMapper.getUser: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">922</span> mybatis.SqlSessionFactoryUtils: 男</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">922</span> mybatis.SqlSessionFactoryUtils: <span class="number">1</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">922</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">5</span>a5338df]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">922</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">5</span>a5338df]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">05</span> <span class="number">20</span>:<span class="number">53</span>:<span class="number">52</span>,<span class="number">922</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">1515403487</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>插件是MyBatis中最强大和灵活的组件，同时也是最复杂、最难以使用的组件，而且其十分危险，因为它将覆盖MyBatis底层对象的核心方法和属性。如果操作不对那个将产生严重后果，甚至是摧毁MyBatis框架。待跟进。</p>
<h2 id="enviroments（运行环境）"><a href="#enviroments（运行环境）" class="headerlink" title="enviroments（运行环境）"></a>enviroments（运行环境）</h2><p>在MyBatis中，运行环境主要的作用是配置数据库信息，它可以配置多个数据库，一般而言只需要配置其中的一个就可以了。其下面又分为两个可配置的元素：</p>
<ul>
<li>事务管理器（transactionManager）</li>
<li>数据源（dataSource）</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"${database.driver}"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"${database.url}"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"${database.username}"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"${database.password}"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="transactionManager（事务管理器）"><a href="#transactionManager（事务管理器）" class="headerlink" title="transactionManager（事务管理器）"></a>transactionManager（事务管理器）</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>在MyBatis中，transactionManger提供了两个实现类，它需要实现接口Transaction(org.apache.ibatis.transaction.Transaction)</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transaction</span> </span>{</span><br><span class="line">    <span class="function">Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">getTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>其主要工作就是提交、回滚和关闭数据库的事务</p>
<p>MyBatis为Transaction提供了两个实现类：</p>
<ul>
<li>JdbcTransaction</li>
<li>ManagedTransaction</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"MANAGED"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>JDBC使用JdbcTransactionFactory生成的JdbcTransaction对象实现。它是以JDBC的方式对数据库的提交和回滚进行操作；</li>
<li>MANAGED使用ManagedTransactionFactory生成的ManagedTransaction对象实现。它的提交和回滚方法不用任何操作，而是把事务交给容器处理。在默认情况下，它会关闭连接，然而一些容器并不希望这样，因此需要closeConnection属性设置为false来组织它默认的关闭行为。</li>
</ul>
<h4 id="自定义事务工厂"><a href="#自定义事务工厂" class="headerlink" title="自定义事务工厂"></a>自定义事务工厂</h4><p>可以通过自定义事务规则，满足特殊的需求。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"mybatis.MyTransactionFactory"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.TransactionIsolationLevel;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.transaction.Transaction;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTransaction</span> <span class="keyword">extends</span> <span class="title">JdbcTransaction</span> <span class="keyword">implements</span> <span class="title">Transaction</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyTransaction</span><span class="params">(DataSource ds, TransactionIsolationLevel desiredLevel, <span class="keyword">boolean</span> desiredAutoCommit)</span></span>{</span><br><span class="line">        <span class="keyword">super</span>(ds, desiredLevel, desiredAutoCommit);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyTransaction</span><span class="params">(Connection connection)</span></span>{</span><br><span class="line">        <span class="keyword">super</span>(connection);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getConnection();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">super</span>.commit();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">super</span>.rollback();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">super</span>.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getTimeout();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="environment数据源环境"><a href="#environment数据源环境" class="headerlink" title="environment数据源环境"></a>environment数据源环境</h3><p>environment的主要作用是配置数据库，数据库通过三个工厂类来提供：</p>
<ul>
<li>PooledDataSourceFactory产生PooledDataSource类对象；</li>
<li>UnpooledDataSourceFactory产生UnpooledDataSource类对象；</li>
<li>JndiDataSourceFactory则会根据JNDI的信息拿到外部容器实现的数据库连接对象。</li>
</ul>
<p>无论如何这三个工厂类，最后生成的产品都会是一个实现了DataSource接口的数据库连接对象。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"UNPOOLED"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"JNDI"</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="UNPOOLED"><a href="#UNPOOLED" class="headerlink" title="UNPOOLED"></a>UNPOOLED</h4><p>采用非数据库池的管理方式，每次请求都会打开一个新的数据库连接，所以创建会比较慢。<br>可配置的属性：</p>
<ul>
<li>driver数据库驱动名，比如MySQL的com.mysql.jc.jdbc.Driver</li>
<li>url连接数据库的URL</li>
<li>username用户名</li>
<li>password密码</li>
<li>defaultTransactionIsolationLevel默认的连接事务隔离级别</li>
</ul>
<h4 id="POOLED"><a href="#POOLED" class="headerlink" title="POOLED"></a>POOLED</h4><p>利用池的概念将JDBC的Connection对象组织起来，它开始会有一些空置，并且已经连接好的数据库连接，所以请求时，无须再建立和验证，省去了创建新的连接实例时所必需的初始化和认证时间。它还控制最大连接数，避免过多的连接导致系统瓶颈。<br>除了UNPOOLED下的属性外，会有更多属性用来配置POOLED的数据源：</p>
<ul>
<li>poolMaximumActiveConnections是在任意时间都存在的活动（也就是正在使用）连接数量，默认值为0；</li>
<li>poolMaximumIdleConnections是任意时间可能存在的空闲连接数；</li>
<li>poolMaximumCheckoutTime在被强制返回之前，池中连接被检出（Checked out）的时间，默认值为20000毫秒；</li>
<li>poolTimeToWait是一个底层设置，如果获取连接花费相当长的时间，它会给连接池打印状态日志，并重新尝试获取一个连接（避免在误配置的情况下一直失败），默认值为20000毫秒；</li>
<li>poolPingQuery为发送到数据库的侦测查询，用来检验连接是否处在正常工作秩序中，并准备接受请求。默认是“NO PING QUERY SET”，这会导致多数数据库驱动失败时带有一个恰当的错误消息。</li>
<li>poolPingEnabled为是否启用侦测查询。若开启，也必须使用一个可执行的SQL语句设置poolPingQuery属性（最好是一个非常快的SQL），默认值为false；</li>
<li>poolPingConnectionsNotUsedFor为配置poolPingQuery的使用额度。这可以被设置成匹配具体的数据库连接超时时间，来避免不必要的侦测，默认值为0（即所有连接每一时刻都被侦测——仅当poolPingEnabled为true时使用）。</li>
</ul>
<h4 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h4><p>数据源JNDI的实现为了能在如EJB或应用服务器这类容器中使用，容器可以集中或在外部配置数据源，然后放置一个JNDI上下文的引用。这种数据源配置只需要两个属性：</p>
<ul>
<li>initial_context用来在InitialContext中寻找上下文（即，initialContext.lookup(initial_context))。initial_context是个可选属性，如果忽略，那么data_source属性将会直接从InitialContext中寻找；</li>
<li>data_source是引用数据源实例位置上下文的路径。当提供initial_context配置时，data_source会在其返回的上下文中进行查找；当没有提供Initial_context时，data_source直接在InitialContext中查找。</li>
</ul>
<h4 id="第三方数据源"><a href="#第三方数据源" class="headerlink" title="第三方数据源"></a>第三方数据源</h4><p>MyBatis也支持第三方数据源，例如使用DBCP数据源，那么需要提供一个自定义的DataSourceFactory。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.DataSourceFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DbcpDataSourceFactory</span> <span class="keyword">implements</span> <span class="title">DataSourceFactory</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> Properties props = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.props = properties;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span> </span>{</span><br><span class="line">        DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            dataSource = BasicDataSourceFactory.createDataSource(props);</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>配置</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"mybatis.DbcpDataSourceFactory"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"${database.driver}"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"${database.url}"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"${database.username}"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"${database.password}"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="databaseIdProvider数据库厂商标识"><a href="#databaseIdProvider数据库厂商标识" class="headerlink" title="databaseIdProvider数据库厂商标识"></a>databaseIdProvider数据库厂商标识</h2><p>databaseIdProvider元素主要是支持多种不同厂商的数据库，虽然这个元素并不常用，但是在一些公司却十分有用，因为有些软件公司需要给不同的客户提供系统，使用何种数据库往往是由客户决定的。例如，软件公司默认的是MySQL数据库，而客户只打算使用Oracle。</p>
<h3 id="使用系统默认的databaseIdProvider"><a href="#使用系统默认的databaseIdProvider" class="headerlink" title="使用系统默认的databaseIdProvider"></a>使用系统默认的databaseIdProvider</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">databaseIdProvider</span> <span class="attr">type</span>=<span class="string">"DB_VENDOR"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"Oracle"</span> <span class="attr">value</span>=<span class="string">"oracle"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"MySQL"</span> <span class="attr">value</span>=<span class="string">"mysql"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"DB2"</span> <span class="attr">value</span>=<span class="string">"db2"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">databaseIdProvider</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>property元素属性：</p>
<ul>
<li>name是数据库名称，如果不确定如何填写，那么可以使用JDBC创建其数据库连接对象Connection，然后通过代码connection.getMetaData().getDatabase.ProductName()获取。</li>
<li>value是数据库的别名，在MyBatis里可以通过这个别名标识一条SQL适用于哪种数据库运行。然后，改造映射器的SQL</li>
</ul>
<p>配置文件中设置databaseId进行设置：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span> <span class="attr">databaseId</span>=<span class="string">"oracle"</span>&gt;</span></span><br><span class="line">  select id, role_name as roleName, note from t_role where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span> <span class="attr">databaseId</span>=<span class="string">"mysql"</span>&gt;</span></span><br><span class="line">  select id, role_name as roleName, note from t_Role where l=1 and id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>如果同时存在一条有databaseId和没有databaseId的标识会怎么样呢？<br>正常运行</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span> <span class="attr">databaseId</span>=<span class="string">"oracle"</span>&gt;</span></span><br><span class="line">  select id, role_name as roleName, note from t_role where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">  select id, role_name as roleName, note from t_Role where l=1 and id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>运行异常</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span> <span class="attr">databaseId</span>=<span class="string">"oracle"</span>&gt;</span></span><br><span class="line">  select id, role_name as roleName, note from t_role where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span> <span class="attr">databaseId</span>=<span class="string">"db2"</span>&gt;</span></span><br><span class="line">  select id, role_name as roleName, note from t_Role where l=1 and id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>使用多数据库SQL时需要配置databaseIdProvidertype的属性。</li>
<li>当databaseIdProvidertype属性被配置时，系统会优先取到和数据库配置一致的SQL。</li>
<li>如果没有，则取没有databaseId的SQL，可以把它当做默认值。</li>
<li>如果还是取不到，则会抛出异常，说明无法匹配到对应的SQL。</li>
</ul>
<h3 id="不使用系统规则"><a href="#不使用系统规则" class="headerlink" title="不使用系统规则"></a>不使用系统规则</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.DatabaseIdProvider;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDatabaseIdProvider</span> <span class="keyword">implements</span> <span class="title">DatabaseIdProvider</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATABASE_TYPE_DB2 = <span class="string">"DB2"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATABASE_TYPE_MYSQL = <span class="string">"MySQL"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATABASE_TYPE_ORACLE = <span class="string">"Oracle"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = Logger.getLogger(MyDatabaseIdProvider<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties p)</span> </span>{</span><br><span class="line">        logger.info(p);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDatabaseId</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        Connection connection = dataSource.getConnection();</span><br><span class="line">        String dbProductName = connection.getMetaData().getDatabaseProductName();</span><br><span class="line">        <span class="keyword">if</span>(MyDatabaseIdProvider.DATABASE_TYPE_DB2.equals(dbProductName)){</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"db2"</span>;</span><br><span class="line">        }<span class="keyword">else</span> <span class="keyword">if</span>(MyDatabaseIdProvider.DATABASE_TYPE_MYSQL.equals(dbProductName)){</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"mysql"</span>;</span><br><span class="line">        }<span class="keyword">else</span> <span class="keyword">if</span>(MyDatabaseIdProvider.DATABASE_TYPE_ORACLE.equals(dbProductName)){</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"oracle"</span>;</span><br><span class="line">        }<span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">databaseIdProvider</span> <span class="attr">type</span>=<span class="string">"mybatis.MyDatabaseIdProvider"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">databaseIdProvider</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="引入映射器的方法"><a href="#引入映射器的方法" class="headerlink" title="引入映射器的方法"></a>引入映射器的方法</h2><p>映射器是MyBatis最复杂、最核心的组件。</p>
<h3 id="Mapper接口"><a href="#Mapper接口" class="headerlink" title="Mapper接口"></a>Mapper接口</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">    <span class="function">Role <span class="title">getRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findRoles</span><span class="params">(String roleName)</span></span>;</span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findRoles2</span><span class="params">(String note)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Mapper-xml"><a href="#Mapper-xml" class="headerlink" title="Mapper.xml"></a>Mapper.xml</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"mybatis.RoleMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"roleMapper"</span> <span class="attr">type</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span> <span class="attr">jdbcType</span>=<span class="string">"VARCHAR"</span> <span class="attr">javaType</span>=<span class="string">"string"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"note"</span> <span class="attr">column</span>=<span class="string">"note"</span> <span class="attr">typeHandler</span>=<span class="string">"mybatis.MyTypeHandler"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        insert into t_role(role_name, note) values(#{roleName}, #{note})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">        delete from t_role where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        update t_role set role_name = #{roleName}, note = #{note} where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select id, role_name as roleName, note from t_role where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select id, role_name as roleName, note from t_role</span><br><span class="line">        where role_name like concat('%', #{roleName, jdbcType=VARCHAR, javaType=string}, '%')</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles2"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultMap</span>=<span class="string">"roleMapper"</span>&gt;</span></span><br><span class="line">        select id, role_name, note from t_role</span><br><span class="line">        where note like concat('%', #{note, typeHandler=mybatis.MyTypeHandler}, '%')</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="引入方法"><a href="#引入方法" class="headerlink" title="引入方法"></a>引入方法</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mybatis.RoleMapper.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"mybatis.RoleMapper.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"mybatis.RoleMapper"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"mybatis.UserMapper"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">url</span>=<span class="string">"file://D:/JavaTest/src/mybatis.RoleMapper.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="映射器"><a href="#映射器" class="headerlink" title="映射器"></a>映射器</h1></blockquote>
<p>映射器是MyBatis最复杂且最终啊哟的组件，由一个接口加上XML文件组成</p>
<h2 id="select元素"><a href="#select元素" class="headerlink" title="select元素"></a>select元素</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><table>
<thead>
<tr>
<th align="center">元素</th>
<th align="center">说明</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">id</td>
<td align="center">它和Mapper接口的命名空间组合起来是唯一的，供MyBatis调用</td>
<td align="center">如果命名空间和id结合起来不唯一，MyBatis将会抛出异常</td>
</tr>
<tr>
<td align="center">parameterType</td>
<td align="center">可以给出类的全命名，也可以给出别名，但是别名必须是MyBatis内部定义或者自定义的</td>
<td align="center">可以选择Java Bean、Map等简单的参数类型传递给SQL</td>
</tr>
<tr>
<td align="center">resultType</td>
<td align="center">定义类的全路径，在允许自动匹配的情况下，结果集将通过Java Bean的规范映射；<br>或定义为int/double/float/map等参数；<br>也可以使用别名，不能和resultMap同时使用</td>
<td align="center">常用的参数之一</td>
</tr>
<tr>
<td align="center">resultMap</td>
<td align="center">映射集的英勇，将执行强大的映射功能。我们可以使用resultType和resultMap其中一个，resultMap能提供自定义映射规则的机会。</td>
<td align="center">MyBatis最复杂的元素，可以配置映射规则、级联、typeHandler等</td>
</tr>
<tr>
<td align="center">flushCache</td>
<td align="center">它的作用是在调用SQL后，是否要求MyBatis清空之前查询本地缓存和二级缓存</td>
<td align="center">取值为布尔值。true|false。默认值为false</td>
</tr>
<tr>
<td align="center">useCache</td>
<td align="center">启动二级缓存开关，是否要求MyBatis将此次结果缓存</td>
<td align="center">true|false，默认true</td>
</tr>
<tr>
<td align="center">timeout</td>
<td align="center">设置超时参数，超时将抛出异常，单位秒</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">fetchSize</td>
<td align="center">获取记录的总条数设定</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">statementType</td>
<td align="center">告诉MyBatis使用哪个JDBC的Statement工作，取值为STATEMENT(Statement)、PREPARED(PreparedStatement)、CALLABLE(CallableStatement)</td>
<td align="center">默认PREPARED</td>
</tr>
<tr>
<td align="center">resultSetType</td>
<td align="center">对JDBC的resultSet接口而言，它的值包括FORWARD_ONLY（游标允许向前访问）、SCROLL_SENSITIVE（双向滚动、但不及时更新，就是如果数据库里的数据修改过，并不在resultSet中反映出来）、SCROLL_INSENSITIVE（双向滚动，并及时跟踪数据库的更新，以便更新resultSet中的数据）</td>
<td align="center">默认是数据库厂商提供的JDBC驱动所设置的</td>
</tr>
<tr>
<td align="center">databaseId</td>
<td align="center">数据库厂商标识</td>
<td align="center">提供多种数据库支持</td>
</tr>
<tr>
<td align="center">resultOrdered</td>
<td align="center">仅适用于嵌套结果select语句。如果为true，就是假设包含了嵌套结果集或是分组了，当返回一个主结果行时，就不能应用前面结果集了。这就确保了在获取嵌套的结果集时不至于导致内存不够用</td>
<td align="center">true|false, 默认false</td>
</tr>
<tr>
<td align="center">resultSets</td>
<td align="center">适合于多个结果集的情况，它将列出执行SQL后每个结果集的名称，每个名称之间用逗号分隔</td>
<td align="center">很少使用</td>
</tr>
</tbody></table>
<h3 id="自动映射和驼峰映射"><a href="#自动映射和驼峰映射" class="headerlink" title="自动映射和驼峰映射"></a>自动映射和驼峰映射</h3><p>MyBatis提供了自动映射功能，在默认情况下自动映射功能是开启的，使用它的好处在于能有效减少大量的映射配置，从而减少工作量。</p>
<p>在setting元素中有两个可以配置的选项autoMappingBehavior和mapUpderscoreToCamelCase，控制自动映射和驼峰映射的开关。<br>一般而言，自动映射会使用得多一些，而驼峰映射要求比较严苛，所以字啊实际中应用不算太广。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span></span>{</span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="keyword">private</span> String roleName;</span><br><span class="line">  <span class="keyword">private</span> String note;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"mybatis.Role"</span>&gt;</span></span><br><span class="line">  select id, role_name as roleName, note from t_role where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>role_name被别名roleName代替，和POJO的属性名称保持一致，MyBatis将其映射到POJO的属性roleName上，自动完成映射。</p>
</li>
<li><p>如果不用as roleName，则按照驼峰命名规则进行了匹配，如果驼峰映射开启的话。</p>
</li>
</ul>
<h3 id="传递多个参数"><a href="#传递多个参数" class="headerlink" title="传递多个参数"></a>传递多个参数</h3><h4 id="不带注解传递"><a href="#不带注解传递" class="headerlink" title="不带注解传递"></a>不带注解传递</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span> </span>{</span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findRolesByMap</span><span class="params">(Map&lt;String, Object&gt; parameterMap)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRolesByMap"</span> <span class="attr">parameterType</span>=<span class="string">"map"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select id, role_name as roleName, note from t_role</span><br><span class="line">        where role_name like concat('%', #{roleName}, '%')</span><br><span class="line">        and note like concat('%', #{note}, '%')</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; parameterMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">parameterMap.put(<span class="string">"roleName"</span>, <span class="string">"John"</span>);</span><br><span class="line">parameterMap.put(<span class="string">"note"</span>, <span class="string">"Hello World!"</span>);</span><br><span class="line">List&lt;Role&gt; roles = roleMapper.findRolesByMap(parameterMap);</span><br><span class="line"><span class="keyword">for</span>(Role role:roles){</span><br><span class="line">  logger.info(JSON.toJSON(role));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>运行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=49861:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">146</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">161</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">161</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">161</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">161</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">249</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">627</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">417557780</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">627</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">18e36</span>d14]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">630</span> mybatis.RoleMapper.findRolesByMap: ==&gt;  Preparing: select id, role_name as roleName, <span class="function">note from t_role where role_name like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span> and note like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span></span></span><br><span class="line"><span class="function">DEBUG 2021-09-06 17:13:27,659 mybatis.RoleMapper.findRolesByMap: </span>==&gt; Parameters: John(String), Hello World!(String)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">688</span> mybatis.RoleMapper.findRolesByMap: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">751</span> mybatis.SqlSessionFactoryUtils: {<span class="string">"note"</span>:<span class="string">"Hello World!"</span>,<span class="string">"roleName"</span>:<span class="string">"John"</span>,<span class="string">"id"</span>:<span class="number">1</span>}</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">754</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">18e36</span>d14]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">755</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">18e36</span>d14]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">755</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">417557780</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="带注解传递"><a href="#带注解传递" class="headerlink" title="带注解传递"></a>带注解传递</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span> </span>{</span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findRolesByAnnotation</span><span class="params">(@Param(<span class="string">"roleName"</span>)</span> String roleName, @<span class="title">Param</span><span class="params">(<span class="string">"note"</span>)</span> String note)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Role&gt; roles = roleMapper.findRolesByAnnotation(<span class="string">"John"</span>, <span class="string">"Hello World!"</span>);</span><br><span class="line"><span class="keyword">for</span>(Role role:roles){</span><br><span class="line">  logger.info(JSON.toJSON(role));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRolesByAnnotation"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">    select id, role_name as roleName, note from t_role</span><br><span class="line">    where role_name like concat('%', #{roleName}, '%')</span><br><span class="line">    and note like concat('%', #{note}, '%')</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>运行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=64453:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">17</span>,<span class="number">792</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">17</span>,<span class="number">806</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">17</span>,<span class="number">806</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">17</span>,<span class="number">806</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">17</span>,<span class="number">806</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">17</span>,<span class="number">886</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">18</span>,<span class="number">230</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">417557780</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">18</span>,<span class="number">231</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">18e36</span>d14]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">18</span>,<span class="number">233</span> mybatis.RoleMapper.findRolesByAnnotation: ==&gt;  Preparing: select id, role_name as roleName, <span class="function">note from t_role where role_name like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span> and note like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span></span></span><br><span class="line"><span class="function">DEBUG 2021-09-06 17:24:18,258 mybatis.RoleMapper.findRolesByAnnotation: </span>==&gt; Parameters: John(String), Hello World!(String)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">18</span>,<span class="number">286</span> mybatis.RoleMapper.findRolesByAnnotation: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">18</span>,<span class="number">352</span> mybatis.SqlSessionFactoryUtils: {<span class="string">"note"</span>:<span class="string">"Hello World!"</span>,<span class="string">"roleName"</span>:<span class="string">"John"</span>,<span class="string">"id"</span>:<span class="number">1</span>}</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">18</span>,<span class="number">355</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">18e36</span>d14]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">18</span>,<span class="number">356</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">18e36</span>d14]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">18</span>,<span class="number">356</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">417557780</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="Java-Bean传递"><a href="#Java-Bean传递" class="headerlink" title="Java Bean传递"></a>Java Bean传递</h4><p>注解的方式在参数数量较多的时候，使用起来就比较麻烦，为此，MyBatis还提供传递Java Bean的形式；</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span> </span>{</span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findRolesByBean</span><span class="params">(RoleParams roleParams)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRolesByBean"</span> <span class="attr">parameterType</span>=<span class="string">"mybatis.RoleParams"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">    select id, role_name as roleName, note from t_role</span><br><span class="line">    where role_name like concat('%', #{roleName}, '%')</span><br><span class="line">    and note like concat('%', #{note}, '%')</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">RoleParams roleParams = <span class="keyword">new</span> RoleParams();</span><br><span class="line">roleParams.setRoleName(<span class="string">"John"</span>);</span><br><span class="line">roleParams.setNote(<span class="string">"Hello World!"</span>);</span><br><span class="line">List&lt;Role&gt; roles = roleMapper.findRolesByBean(roleParams);</span><br><span class="line"><span class="keyword">for</span>(Role role:roles){</span><br><span class="line">  logger.info(JSON.toJSON(role));</span><br><span class="line">}</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">运行结果</span><br><span class="line">```java</span><br><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=54280:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">56</span>,<span class="number">668</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">56</span>,<span class="number">685</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">56</span>,<span class="number">685</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">56</span>,<span class="number">685</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">56</span>,<span class="number">685</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">56</span>,<span class="number">769</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">57</span>,<span class="number">122</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">332699949</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">57</span>,<span class="number">122</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">13</span>d4992d]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">57</span>,<span class="number">125</span> mybatis.RoleMapper.findRolesByBean: ==&gt;  Preparing: select id, role_name as roleName, <span class="function">note from t_role where role_name like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span> and note like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span></span></span><br><span class="line"><span class="function">DEBUG 2021-09-06 17:32:57,155 mybatis.RoleMapper.findRolesByBean: </span>==&gt; Parameters: John(String), Hello World!(String)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">57</span>,<span class="number">180</span> mybatis.RoleMapper.findRolesByBean: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">57</span>,<span class="number">243</span> mybatis.SqlSessionFactoryUtils: {<span class="string">"note"</span>:<span class="string">"Hello World!"</span>,<span class="string">"roleName"</span>:<span class="string">"John"</span>,<span class="string">"id"</span>:<span class="number">1</span>}</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">57</span>,<span class="number">246</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">13</span>d4992d]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">57</span>,<span class="number">247</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">13</span>d4992d]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">57</span>,<span class="number">247</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">332699949</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="混合传递方式"><a href="#混合传递方式" class="headerlink" title="混合传递方式"></a>混合传递方式</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span> </span>{</span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findByMix</span><span class="params">(@Param(<span class="string">"params"</span>)</span> RoleParams roleParams, @<span class="title">Param</span><span class="params">(<span class="string">"page"</span>)</span> PageParams pageParams)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RoleParams roleParams = <span class="keyword">new</span> RoleParams();</span><br><span class="line">roleParams.setRoleName(<span class="string">"John"</span>);</span><br><span class="line">roleParams.setNote(<span class="string">"Hello World!"</span>);</span><br><span class="line">PageParams pageParams = <span class="keyword">new</span> PageParams();</span><br><span class="line">pageParams.setLimit(<span class="number">1</span>);</span><br><span class="line">pageParams.setStart(<span class="number">0</span>);</span><br><span class="line">List&lt;Role&gt; roles = roleMapper.findByMix(roleParams, pageParams);</span><br><span class="line">logger.info(<span class="string">"findByMix"</span>);</span><br><span class="line"><span class="keyword">for</span>(Role role:roles){</span><br><span class="line">  logger.info(JSON.toJSON(role));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByMix"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">    select id, role_name as roleName, note from t_role</span><br><span class="line">    where role_name like</span><br><span class="line">    concat('%', #{params.roleName}, '%')</span><br><span class="line">    and note like concat('%', #{params.note}, '%')</span><br><span class="line">    limit #{page.start}, #{page.limit}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>运行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=56202:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">420</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">434</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">434</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">434</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">434</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">521</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">867</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">1115170891</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">867</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">4278284</span>b]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">869</span> mybatis.RoleMapper.findByMix: ==&gt;  Preparing: select id, role_name as roleName, <span class="function">note from t_role where role_name like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span> and note like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span> limit ?, ?</span></span><br><span class="line"><span class="function">DEBUG 2021-09-06 19:30:29,895 mybatis.RoleMapper.findByMix: </span>==&gt; Parameters: John(String), Hello World!(String), <span class="number">0</span>(Integer), <span class="number">1</span>(Integer)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">918</span> mybatis.RoleMapper.findByMix: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">919</span> mybatis.SqlSessionFactoryUtils: findByMix</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">984</span> mybatis.SqlSessionFactoryUtils: {<span class="string">"note"</span>:<span class="string">"Hello World!"</span>,<span class="string">"roleName"</span>:<span class="string">"John"</span>,<span class="string">"id"</span>:<span class="number">1</span>}</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">987</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">4278284</span>b]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">988</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">4278284</span>b]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">19</span>:<span class="number">30</span>:<span class="number">29</span>,<span class="number">988</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">1115170891</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>使用map传递参数导致了业务可读性的丧失，导致后续扩展和维护的困难，在实际的应用中要果断废弃这种方式；</li>
<li>使用@Param注解传递多个参数，受到参数个数（n）的影响。当n $\leq$ 5 时，这是最佳的传参方式，它比用Java Bean更好，因为它更加直观；当 n $\ge$ 5 时，多个参数讲给调用带来困难，此时不推荐使用它。</li>
<li>当参数个数多于5个时，建议使用JavaBean方式。</li>
<li>对于使用混合参数的，姚明全参数的合理性。</li>
</ul>
<h3 id="使用resultMap映射结果集"><a href="#使用resultMap映射结果集" class="headerlink" title="使用resultMap映射结果集"></a>使用resultMap映射结果集</h3><p>自动映射和驼峰映射规则比较简单，无法定义多的属性，比如typeHandler、级联等。为了支持复杂的映射，select元素提供了resultMap属性。</p>
<ul>
<li>resultMap元素定义了一个roleMap，它的属性id代表它的标识，type代表使用哪个类作为其映射的类，可以使别名或者全限定名，role是mybatis.Role的别名</li>
<li>它的子元素id代表resultMap的主键，而result代表其属性，id和result元素的属性property代表POJO的属性名称，而column代表SQL的列名。把POJO的属性和SQL的列名做对应，例如POJO的属性roleName，就用SQL的列名role_name建立映射关系。</li>
<li>在select元素中的属性resultMap指定了采用哪个resultMap作为其映射规则。</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"mybatis.RoleMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"roleMapper"</span> <span class="attr">type</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span> <span class="attr">jdbcType</span>=<span class="string">"VARCHAR"</span> <span class="attr">javaType</span>=<span class="string">"string"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"note"</span> <span class="attr">column</span>=<span class="string">"note"</span> <span class="attr">typeHandler</span>=<span class="string">"mybatis.MyTypeHandler"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles2"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultMap</span>=<span class="string">"roleMapper"</span>&gt;</span></span><br><span class="line">        select id, role_name, note from t_role</span><br><span class="line">        where note like concat('%', #{note, typeHandler=mybatis.MyTypeHandler}, '%')</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="分页参数RowBounds"><a href="#分页参数RowBounds" class="headerlink" title="分页参数RowBounds"></a>分页参数RowBounds</h3><p>MyBatis不仅支持分页，它还内置了一个专门处理分页的类——RowBounds。源码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.session;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RowBounds</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NO_ROW_OFFSET = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NO_ROW_LIMIT = <span class="number">2147483647</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RowBounds DEFAULT = <span class="keyword">new</span> RowBounds();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> offset;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> limit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RowBounds</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.offset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.limit = <span class="number">2147483647</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RowBounds</span><span class="params">(<span class="keyword">int</span> offset, <span class="keyword">int</span> limit)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.offset = offset;</span><br><span class="line">        <span class="keyword">this</span>.limit = limit;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOffset</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.offset;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLimit</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.limit;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>mapper.xml映射器文件中没有任何关于RowBounds参数的信息，它是MyBatis的一个附加参数，MyBatis会自动识别它，据此进行分页。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByRowBounds"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">    select id, role_name as roleName, note from t_role</span><br><span class="line">    where role_name like concat('%', #{roleName}, '%')</span><br><span class="line">    and note like concat('%', #{note}, '%')</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RoleParams roleParams = <span class="keyword">new</span> RoleParams();</span><br><span class="line">roleParams.setRoleName(<span class="string">"John"</span>);</span><br><span class="line">roleParams.setNote(<span class="string">"Hello World!"</span>);</span><br><span class="line">RowBounds rowBounds = <span class="keyword">new</span> RowBounds(<span class="number">0</span>, <span class="number">20</span>);</span><br><span class="line">List&lt;Role&gt; roles = roleMapper.findByRowBounds(<span class="string">"John"</span>, <span class="string">"Hello World!"</span>, rowBounds);</span><br><span class="line">logger.info(<span class="string">"findByRowBounds"</span>);</span><br><span class="line"><span class="keyword">for</span>(Role role:roles){</span><br><span class="line">    logger.info(JSON.toJSON(role));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>运行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=59806:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">49</span>,<span class="number">807</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">49</span>,<span class="number">821</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">49</span>,<span class="number">821</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">49</span>,<span class="number">821</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">49</span>,<span class="number">821</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">49</span>,<span class="number">911</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">50</span>,<span class="number">272</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">156710276</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">50</span>,<span class="number">272</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">9573584</span>]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">50</span>,<span class="number">275</span> mybatis.RoleMapper.findByRowBounds: ==&gt;  Preparing: select id, role_name as roleName, <span class="function">note from t_role where role_name like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span> and note like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span></span></span><br><span class="line"><span class="function">DEBUG 2021-09-06 20:26:50,306 mybatis.RoleMapper.findByRowBounds: </span>==&gt; Parameters: John(String), Hello World!(String)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">50</span>,<span class="number">333</span> mybatis.RoleMapper.findByRowBounds: &lt;==      Total: <span class="number">2</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">50</span>,<span class="number">334</span> mybatis.SqlSessionFactoryUtils: findByRowBounds</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">50</span>,<span class="number">396</span> mybatis.SqlSessionFactoryUtils: {<span class="string">"note"</span>:<span class="string">"Hello World!"</span>,<span class="string">"roleName"</span>:<span class="string">"John"</span>,<span class="string">"id"</span>:<span class="number">1</span>}</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">50</span>,<span class="number">401</span> mybatis.SqlSessionFactoryUtils: {<span class="string">"note"</span>:<span class="string">"OOOO Hello World! XXX"</span>,<span class="string">"roleName"</span>:<span class="string">"John"</span>,<span class="string">"id"</span>:<span class="number">2</span>}</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">50</span>,<span class="number">401</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">9573584</span>]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">50</span>,<span class="number">401</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">9573584</span>]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">50</span>,<span class="number">401</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">156710276</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="insert元素"><a href="#insert元素" class="headerlink" title="insert元素"></a>insert元素</h2><h3 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h3><table>
<thead>
<tr>
<th align="center">属性</th>
<th align="center">描述</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">id</td>
<td align="center">SQL编号，用于标识这条SQL</td>
<td align="center">命名空间+id+databaseId唯一，否则MyBatis会抛出异常</td>
</tr>
<tr>
<td align="center">parameterType</td>
<td align="center">同select</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">flushCache</td>
<td align="center">同select</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">timeout</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">statementType</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">useGeneratedKyes</td>
<td align="center">是否启动JDBC的getGeneratedKeys方法来去除由数据库内部生成的主键</td>
<td align="center">默认false</td>
</tr>
<tr>
<td align="center">keyProperty</td>
<td align="center">（仅对insert和update有用）唯一标记一个属性，MyBatis会通过getGeneratedKeys的返回值，或者通过isnert语句的selectKey子元素设置它的剪枝。如果是符合主键，要把每一个名称用逗号隔开</td>
<td align="center">默认值为unset, 不能和keyColumn连用</td>
</tr>
<tr>
<td align="center">keyColumn</td>
<td align="center">（仅对insert和update有用）通过生成的键值设置表中的列名，这个设置仅在某些数据库（像PostgreSQL）中是必须的，当主键列不是表中的第一列时需要设置。如果是符合主键，需要把一个名称用逗号隔开</td>
<td align="center">不能和keyProperty连用</td>
</tr>
<tr>
<td align="center">databaseId</td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<h3 id="简单insert语句应用"><a href="#简单insert语句应用" class="headerlink" title="简单insert语句应用"></a>简单insert语句应用</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">  insert into t_role(role_name, note) values(#{roleName}, #{note})</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="主键回填"><a href="#主键回填" class="headerlink" title="主键回填"></a>主键回填</h3><p>前一个插入应用中没有插入id列，因为MySQL中的表格才用了自增主键。但有时候还可能需要继续使用这个主键。</p>
<p>JDBC中的Statement对象在执行插入的SQL后，可以通过getGeneratedKeys方法获得数据库生成的主键（需要数据库驱动支持），这样便能达到获取主键的功能。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">    insert into t_role(role_name, note) values(#{roleName}, #{note})</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>userGeneratedKeys代表采用JDBC的Statement对象的getGeneratedKeys方法返回主键，而keyProperty则代表将用哪个POJO的属性去匹配这个主键，这里是id，说明它会用数据库生成的主键去幅值给这个POJO，测试主键回填的结果。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Role role = <span class="keyword">new</span> Role();</span><br><span class="line">role.setRoleName(<span class="string">"Tom"</span>);</span><br><span class="line">role.setNote(<span class="string">"note_test"</span>);</span><br><span class="line">roleMapper.insertRole(role);</span><br><span class="line">sqlSession.commit();</span><br><span class="line">logger.info(<span class="string">"role id: "</span> + role.getId().toString());</span><br></pre></td></tr></tbody></table></figure>

<p>运行结果<br>如果如同前面简单的插入语句，下面的role.getId()为空，而不是这里的role id: 10</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=50726:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">20</span>,<span class="number">537</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">20</span>,<span class="number">553</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">20</span>,<span class="number">553</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">20</span>,<span class="number">553</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">20</span>,<span class="number">553</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">20</span>,<span class="number">640</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">21</span>,<span class="number">041</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">1515403487</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">21</span>,<span class="number">042</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">5</span>a5338df]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">21</span>,<span class="number">045</span> mybatis.RoleMapper.insertRole: ==&gt;  Preparing: <span class="function">insert into <span class="title">t_role</span><span class="params">(role_name, note)</span> <span class="title">values</span><span class="params">(?, ?)</span></span></span><br><span class="line"><span class="function">DEBUG 2021-09-06 22:04:21,079 mybatis.RoleMapper.insertRole: </span>==&gt; Parameters: Tom(String), note_test(String)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">21</span>,<span class="number">082</span> mybatis.RoleMapper.insertRole: &lt;==    Updates: <span class="number">1</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">21</span>,<span class="number">096</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Committing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">5</span>a5338df]</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">21</span>,<span class="number">136</span> mybatis.SqlSessionFactoryUtils: role id: <span class="number">10</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">21</span>,<span class="number">136</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">5</span>a5338df]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">21</span>,<span class="number">136</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">5</span>a5338df]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">06</span> <span class="number">22</span>:<span class="number">04</span>:<span class="number">21</span>,<span class="number">136</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">1515403487</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="自定义主键"><a href="#自定义主键" class="headerlink" title="自定义主键"></a>自定义主键</h3><p>有时候主键可能依赖于某些规则，比如取消主键id的递增规则，而将其修改为：</p>
<ul>
<li>当角色表记录为空时，id设置为1；</li>
<li>当角色表记录不为空时，id设置为当前id加3；</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span> <span class="attr">resultType</span>=<span class="string">"long"</span> <span class="attr">order</span>=<span class="string">"BEFORE"</span>&gt;</span></span><br><span class="line">        select if (max(id) = null, 1, max(id) + 3) from t_role</span><br><span class="line">    <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span><br><span class="line">    insert into t_role(id, role_name, note) values(#{id}, #{roleName}, #{note})</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>keyProperty指定采用哪个属性作为POJO的主键</li>
<li>resutType告诉MyBatis将返回一个long型的结果集</li>
<li>order设置为BEFORE，说明它将于当前定义的SQL前执行。</li>
</ul>
<h2 id="update元素和delete元素"><a href="#update元素和delete元素" class="headerlink" title="update元素和delete元素"></a>update元素和delete元素</h2><p>update元素和delete元素比较简单，其属性和insert差不多，执行完也会返回一个整数，用以标志改SQL语句影响了数据库的记录行数；</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">    delete from t_role where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">    update t_role set role_name = #{roleName}, note = #{note} where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="sql元素"><a href="#sql元素" class="headerlink" title="sql元素"></a>sql元素</h2><ul>
<li>sql元素的作用在于可以定义一条SQL的一部分，方便后面的SQL应用它。</li>
<li>通常情况下要在select、insert等语句中反复编写它们，特别是那些字段较多的表更是如此。</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"mybatis.RoleMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"roleMapper"</span> <span class="attr">type</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span> <span class="attr">jdbcType</span>=<span class="string">"VARCHAR"</span> <span class="attr">javaType</span>=<span class="string">"string"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"note"</span> <span class="attr">column</span>=<span class="string">"note"</span> <span class="attr">typeHandler</span>=<span class="string">"mybatis.MyTypeHandler"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"roleCols"</span>&gt;</span></span><br><span class="line">        id, role_name, note</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span> <span class="attr">resultType</span>=<span class="string">"long"</span> <span class="attr">order</span>=<span class="string">"BEFORE"</span>&gt;</span></span><br><span class="line">            select if (max(id) = null, 1, max(id) + 3) from t_role</span><br><span class="line">        <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span><br><span class="line">        insert into t_role(<span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"roleCols"</span>&gt;</span>) values(#{id}, #{roleName}, #{note})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">        select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"roleCols"</span>&gt;</span> as roleName, note from t_role where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>sql元素还支持变量传递</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"roleCols"</span>&gt;</span></span><br><span class="line">    ${alias}.id, ${alias}.role_name, ${alias}.note</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultMap</span>=<span class="string">"roleMap"</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"roleCols"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"alias"</span> <span class="attr">value</span>=<span class="string">"r"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from t_role as r where where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>一些数据库字段返回为null，而MyBatis系统又检测不到使用何种jdbcType进行处理时，会发生异常的情况，这个时候执行对应的typeHandler进行处理，MyBatis就指导采取哪个typeHandler进行处理了。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t_role(id, role_name, note) values(#{id}, #{roleName, typeHandler=org.apache.ibatis.type.StringTypeHandler}, #{note})</span><br></pre></td></tr></tbody></table></figure>

<p>而事实上，大部分情况下都不需要这样编写，因为MyBatis会根据javaType和jdbcType去检测使用哪个typeHandler。如果roleName是一个没有注册的类型，那么就会发生异常，因为MyBatis无法找到对应的typeHandler来转换数据类型。此时可以自定义TypeHandler，通过类似的办法指定，就不会抛出异常了。</p>
<p>在一些因为数据库返回null，存在可能抛出异常的情况下，也可以指定对应的jdbcType，从而让MyBatis能够探测到使用哪个typeHandler进行转换，以避免空指针异常。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#{age, javeType=int, jdbcType=NUMERIC, typeHandler=MyTypeHandler}</span><br><span class="line"></span><br><span class="line">#{width, javaType=double, jdbcType=NUMERIC, numericScale=2}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="存储过程参数支持"><a href="#存储过程参数支持" class="headerlink" title="存储过程参数支持"></a>存储过程参数支持</h3><p>在MyBatis中提供了对存储过程的良好支持，对于简单的输出参数（比如INT,VARCHAR,DECIMAL）可以使用POJO通过映射来完成。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#{id, mode=IN}</span><br><span class="line">#{roleName, mode=OUT}</span><br><span class="line">#{note, mode=INOUT}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>IN：输入参数是外接需要传递给存储过程的；</li>
<li>OUT：输出参数是存储过程经过处理后返回的；</li>
<li>INOUT：输入输出参数一方面外界需要可以传递给它，另一方面在最后存储过程也会将它返回给调用者。</li>
</ul>
<h3 id="特殊字符串的替换和处理（-和-）"><a href="#特殊字符串的替换和处理（-和-）" class="headerlink" title="特殊字符串的替换和处理（#和$）"></a>特殊字符串的替换和处理（#和$）</h3><p>类似于前面参数传递（$）和普通参数（#）的区别。</p>
<h2 id="resultMap元素"><a href="#resultMap元素" class="headerlink" title="resultMap元素"></a>resultMap元素</h2><h3 id="resultMap元素构成"><a href="#resultMap元素构成" class="headerlink" title="resultMap元素构成"></a>resultMap元素构成</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">""</span> <span class="attr">type</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">idArg</span>&gt;</span><span class="tag">&lt;/<span class="name">idArg</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg</span>&gt;</span><span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">constructor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">discriminator</span> <span class="attr">javaType</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">case</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">case</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">discriminator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>其中constructor元素用于配置构造方法。<br>一个POJO可能不存在没有参数的构造方法，可以使用constructor进行配置。</p>
<p>假设角色类RoleBean不存在没有参数的构造方法，那么需要配置结果集：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RoleBean</span><span class="params">(Integer id, String roleName)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">constructor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">idArg</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">javaType</span>=<span class="string">"int"</span>&gt;</span><span class="tag">&lt;/<span class="name">idArg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">arg</span> <span class="attr">column</span>=<span class="string">"role_name"</span> <span class="attr">javeType</span>=<span class="string">"string"</span>&gt;</span><span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">constructor</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>如此，MyBatis就会使用对应的构造方法来构造POJO了<br>id元素表示哪个列是主键，允许多个主键，多个主键则成为联合主键。<br>result配置POJO到SQL列名的映射关系。</p>
<p>result元素和idArg元素的属性，如表所示：</p>
<table>
<thead>
<tr>
<th align="center">元素名称</th>
<th align="center">说明</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">property</td>
<td align="center">映射到列结果的字段或属性。如果POJO的属性匹配的是存在的且与给定SQL列名（column元素）相同的，那么MyBatis就会映射到POJO上</td>
<td align="center">可以使用导航式的字段，比如访问一个学生对象（Student）需要访问学生证（selfcard）的发送日期（issueDate），那么可以写成selfcard.issueDate</td>
</tr>
<tr>
<td align="center">column</td>
<td align="center">对应的是SQL的列</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">javaType</td>
<td align="center">配置Java的类型</td>
<td align="center">可以是特定的类完全限定名或者MyBatis上下文的别名</td>
</tr>
<tr>
<td align="center">jdbcType</td>
<td align="center">配置数据库类型</td>
<td align="center">这是一个JDBC的类型，MyBatis已经做了限定，支持大部分常用的数据库类型</td>
</tr>
<tr>
<td align="center">typeHandler</td>
<td align="center">类型处理器</td>
<td align="center">允许用特定的处理器来覆盖MyBatis默认的处理器。这就要指定jdbcType和javaType相互转化的规则</td>
</tr>
</tbody></table>
<p>例子：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"roleMapper"</span> <span class="attr">type</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span> <span class="attr">jdbcType</span>=<span class="string">"VARCHAR"</span> <span class="attr">javaType</span>=<span class="string">"string"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"note"</span> <span class="attr">column</span>=<span class="string">"note"</span> <span class="attr">typeHandler</span>=<span class="string">"mybatis.MyTypeHandler"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用map存储结果集（不推荐）"><a href="#使用map存储结果集（不推荐）" class="headerlink" title="使用map存储结果集（不推荐）"></a>使用map存储结果集（不推荐）</h3><p>一般而言，任何select语句都可以使用map存储，使用map原则上是可以匹配所有结果集的，但是使用map接口意味着可读性的下降，因为使用map时需要进一步了解map键值的构成和数据类型，所以这不是一种推荐的方式，更多时候会推荐使用POJO方式</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findColorByNote"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultType</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">    select id, color, note from t_color where note like concat('%', #{note}, '%')</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用POJO存储结果集（推荐）"><a href="#使用POJO存储结果集（推荐）" class="headerlink" title="使用POJO存储结果集（推荐）"></a>使用POJO存储结果集（推荐）</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">    insert into t_role(role_name, note) values(#{roleName}, #{note})</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用resultMap（推荐）"><a href="#使用resultMap（推荐）" class="headerlink" title="使用resultMap（推荐）"></a>使用resultMap（推荐）</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"roleMapper"</span> <span class="attr">type</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span> <span class="attr">jdbcType</span>=<span class="string">"VARCHAR"</span> <span class="attr">javaType</span>=<span class="string">"string"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"note"</span> <span class="attr">column</span>=<span class="string">"note"</span> <span class="attr">typeHandler</span>=<span class="string">"mybatis.MyTypeHandler"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles2"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultMap</span>=<span class="string">"roleMapper"</span>&gt;</span></span><br><span class="line">    select id, role_name, note from t_role</span><br><span class="line">    where note like concat('%', #{note, typeHandler=mybatis.MyTypeHandler}, '%')</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>resultMap属性id为这个resultMap的标识</li>
<li>type代表需要映射的POJO，这里可以使用MyBatis定义好的类的别名，也可以使用自定义的类的全限定名</li>
<li>元素id标识这个对象的主键</li>
<li>SQL语句的列名必须和roleMapper的column是一一对应的，使用XML配置的结果集，还可以配置typeHanlder、javaType、jdbcType等更多内容，但不能和resultType连用。</li>
</ul>
<h2 id="级联"><a href="#级联" class="headerlink" title="级联"></a>级联</h2><p>级联是一个数据库实体的概念。级联不是必须的，级联的好处是获取关联数据十分便捷，但是级联过多会增加系统的复杂度，同时降低系统的性能，此增比减，所以当级联的层级超过3层时，就不要考虑使用级联了，因为这样会造成多个对象的关联，导致系统的耦合、复杂和难以维护。</p>
<p>此处略过，后面真得用得到在看来得及。</p>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>在MyBatis中允许使用缓存，缓存一般都放置在可高速读、写的存储器上，比如服务器的内存，它能够有效提高系统的性能。因为数据库在大部分场景下是把存储在磁盘上的数据索引出来。从硬件的角度分析，索引磁盘是一个较为缓慢的过程，读取内存或者高速缓存处理器的速度要比读取磁盘快得多，其速度是读取硬盘的几十倍到上百倍，但是内存和告诉缓存处理器的空间有限，所以一般只会把那些常用且命中率高的数据缓存起来，以便将来使用，而不缓存那些不常用且命中率低的数据缓存。</p>
<h3 id="一级缓存和二级缓存"><a href="#一级缓存和二级缓存" class="headerlink" title="一级缓存和二级缓存"></a>一级缓存和二级缓存</h3><p>一级缓存是在SqlSession上的缓存，二级缓存是在SqlSessionFactory上的缓存。默认情况下，也就是没有任何配置的情况下，MyBatis系统会开启一级缓存，也就是对于SqlSession层面的缓存，这个缓存不需要POJO对象可序列化。</p>
<p>如果两次查询时完全相同的查询，且缓存没有超时就可以触发一级缓存：</p>
<ol>
<li>传入的StatementId</li>
<li>查询时要求的结果集中的结果范围</li>
<li>这次查询所产生的最终要传递给JDBC java.sql.PreparedStatement的Sql语句字符串</li>
<li>传递给java.sqlStatement要设置的参数值</li>
</ol>
<h4 id="一级缓存触发"><a href="#一级缓存触发" class="headerlink" title="一级缓存触发"></a>一级缓存触发</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">    Logger logger = Logger.getLogger(SqlSessionFactoryUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        sqlSession = SqlSessionFactoryUtils.openSqlSession();</span><br><span class="line">        RoleMapper roleMapper = sqlSession.getMapper(RoleMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Role role = roleMapper.getRole(<span class="number">1L</span>);</span><br><span class="line">        logger.info(role.getRoleName());</span><br><span class="line">        logger.info(role.getNote());</span><br><span class="line">        logger.info(<span class="string">"再获取一次POJO......"</span>);</span><br><span class="line">        Role role1 = roleMapper.getRole(<span class="number">1L</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e){</span><br><span class="line">        logger.info(e.getMessage(), e);</span><br><span class="line">    }<span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>) sqlSession.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=65310:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">18</span>,<span class="number">768</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">18</span>,<span class="number">775</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">18</span>,<span class="number">775</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">18</span>,<span class="number">775</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">18</span>,<span class="number">775</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">18</span>,<span class="number">858</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">19</span>,<span class="number">196</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">1758624236</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">19</span>,<span class="number">196</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">68</span>d279ec]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">19</span>,<span class="number">198</span> mybatis.RoleMapper.getRole: ==&gt;  Preparing: select id, role_name as roleName, note note from t_role where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">19</span>,<span class="number">230</span> mybatis.RoleMapper.getRole: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">19</span>,<span class="number">253</span> mybatis.RoleMapper.getRole: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">19</span>,<span class="number">254</span> mybatis.SqlSessionFactoryUtils: John</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">19</span>,<span class="number">254</span> mybatis.SqlSessionFactoryUtils: Hello World!</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">19</span>,<span class="number">254</span> mybatis.SqlSessionFactoryUtils: 再获取一次POJO......</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">19</span>,<span class="number">254</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">68</span>d279ec]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">19</span>,<span class="number">255</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">68</span>d279ec]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">19</span>,<span class="number">255</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">1758624236</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="一级缓存未触发"><a href="#一级缓存未触发" class="headerlink" title="一级缓存未触发"></a>一级缓存未触发</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">    Logger logger = Logger.getLogger(SqlSessionFactoryUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        sqlSession = SqlSessionFactoryUtils.openSqlSession();</span><br><span class="line">        RoleMapper roleMapper = sqlSession.getMapper(RoleMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Role role = roleMapper.getRole(<span class="number">1L</span>);</span><br><span class="line">        logger.info(role.getRoleName());</span><br><span class="line">        logger.info(role.getNote());</span><br><span class="line">        logger.info(<span class="string">"再获取一次POJO......"</span>);</span><br><span class="line">        Role role1 = roleMapper.getRole(<span class="number">1L</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e){</span><br><span class="line">        logger.info(e.getMessage(), e);</span><br><span class="line">    }<span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>) sqlSession.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=61431:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">280</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">293</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">294</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">294</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">294</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">380</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">731</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">1676605578</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">731</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">63</span>eef88a]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">734</span> mybatis.RoleMapper.getRole: ==&gt;  Preparing: select id, role_name as roleName, note note from t_role where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">758</span> mybatis.RoleMapper.getRole: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">778</span> mybatis.RoleMapper.getRole: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">779</span> mybatis.SqlSessionFactoryUtils: John</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">779</span> mybatis.SqlSessionFactoryUtils: Hello World!</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">779</span> mybatis.SqlSessionFactoryUtils: 再获取一次POJO......</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">779</span> mybatis.RoleMapper.getRole: ==&gt;  Preparing: select id, role_name as roleName, note note from t_role where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">780</span> mybatis.RoleMapper.getRole: ==&gt; Parameters: <span class="number">9</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">781</span> mybatis.RoleMapper.getRole: &lt;==      Total: <span class="number">1</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">781</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">63</span>eef88a]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">781</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">63</span>eef88a]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">00</span>:<span class="number">30</span>,<span class="number">781</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">1676605578</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<p>注意看第二次未触发一级缓存会多一个Preparing: sql语句</p>
<h4 id="一级缓存作用范围"><a href="#一级缓存作用范围" class="headerlink" title="一级缓存作用范围"></a>一级缓存作用范围</h4><p>SQL被执行了两次，这说明一级缓存是在SqlSession层面的，对于不同的SQlSession对象时不能共享的。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">    Logger logger = Logger.getLogger(SqlSessionFactoryUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">    SqlSession sqlSession1 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        sqlSession = SqlSessionFactoryUtils.openSqlSession();</span><br><span class="line">        RoleMapper roleMapper = sqlSession.getMapper(RoleMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Role role = roleMapper.getRole(<span class="number">1L</span>);</span><br><span class="line"><span class="comment">//            //System.out.println(JSON.toJSONString(role));</span></span><br><span class="line">        logger.info(role.getRoleName());</span><br><span class="line">        logger.info(role.getNote());</span><br><span class="line">        sqlSession.commit(); <span class="comment">//需要提交，如果是一级缓存，MyBatis才会缓存对象到SqlSessionFactory层面</span></span><br><span class="line">        sqlSession1 = SqlSessionFactoryUtils.openSqlSession();</span><br><span class="line">        RoleMapper roleMapper1 = sqlSession1.getMapper(RoleMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Role role1 = roleMapper1.getRole(<span class="number">1L</span>);</span><br><span class="line">        sqlSession1.commit();</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e){</span><br><span class="line">        logger.info(e.getMessage(), e);</span><br><span class="line">    }<span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>) sqlSession.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=55295:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">00</span>,<span class="number">794</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">00</span>,<span class="number">810</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">00</span>,<span class="number">810</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">00</span>,<span class="number">811</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">00</span>,<span class="number">811</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">00</span>,<span class="number">915</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">252</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">1676605578</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">252</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">63</span>eef88a]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">255</span> mybatis.RoleMapper.getRole: ==&gt;  Preparing: select id, role_name as roleName, note note from t_role where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">283</span> mybatis.RoleMapper.getRole: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">306</span> mybatis.RoleMapper.getRole: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">306</span> mybatis.SqlSessionFactoryUtils: John</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">307</span> mybatis.SqlSessionFactoryUtils: Hello World!</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">307</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">344</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">147022238</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">344</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">8</span>c3619e]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">345</span> mybatis.RoleMapper.getRole: ==&gt;  Preparing: select id, role_name as roleName, note note from t_role where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">345</span> mybatis.RoleMapper.getRole: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">346</span> mybatis.RoleMapper.getRole: &lt;==      Total: <span class="number">1</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">346</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">63</span>eef88a]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">347</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">63</span>eef88a]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">09</span>:<span class="number">01</span>,<span class="number">347</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">1676605578</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="开启二级缓存："><a href="#开启二级缓存：" class="headerlink" title="开启二级缓存："></a>开启二级缓存：</h4><p>需要在RoleMapper.xml上加入代码：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>需要序列化对象，否则会报错</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=57888:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">121</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">134</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">134</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">134</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">134</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">221</span> mybatis.RoleMapper: Cache Hit Ratio [mybatis.RoleMapper]: <span class="number">0.0</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">225</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">561</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">35984028</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">561</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">225129</span>c]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">564</span> mybatis.RoleMapper.getRole: ==&gt;  Preparing: select id, role_name as roleName, note note from t_role where id = ?</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">594</span> mybatis.RoleMapper.getRole: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">618</span> mybatis.RoleMapper.getRole: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">618</span> mybatis.SqlSessionFactoryUtils: John</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">618</span> mybatis.SqlSessionFactoryUtils: Hello World!</span><br><span class="line"> WARN <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">624</span> org.apache.ibatis.io.SerialFilterChecker: As you are using functionality that deserializes object streams, it is recommended to define the JEP-<span class="number">290</span> serial filter. Please refer to https:<span class="comment">//docs.oracle.com/pls/topic/lookup?ctx=javase15&amp;id=GUID-8296D8E8-2B93-4B9A-856E-0A65AF9B8C66</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">626</span> mybatis.RoleMapper: Cache Hit Ratio [mybatis.RoleMapper]: <span class="number">0.5</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">626</span> mybatis.SqlSessionFactoryUtils: John</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">626</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">225129</span>c]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">627</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">225129</span>c]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">08</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">38</span>,<span class="number">627</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">35984028</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="缓存配置项、自定义和应用"><a href="#缓存配置项、自定义和应用" class="headerlink" title="缓存配置项、自定义和应用"></a>缓存配置项、自定义和应用</h3><p>上一节只是配置了cache元素，加入了这个元素后，MyBatis就会将对应的命名空间内所有select元素SQL查询结果进行缓存，而其中的insert、delete和update语句在操作时会刷新缓存。</p>
<table>
<thead>
<tr>
<th align="center">属性</th>
<th align="left">说明</th>
<th align="left">取值</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">blocking</td>
<td align="left">是否使用阻塞性缓存，在读/写时它会加入JNI的锁进行操作</td>
<td align="left">true|false，默认false</td>
<td align="left">可保证读/写安全性，但加锁后性能不佳</td>
</tr>
<tr>
<td align="center">readOnly</td>
<td align="left">缓存内容是否只读</td>
<td align="left">true|false，默认false</td>
<td align="left">如果为只读，则不会因为多个线程读/写造成不一致性</td>
</tr>
<tr>
<td align="center">eviction</td>
<td align="left">缓存策略：LRU/FIFO/SOFT/WEAK</td>
<td align="left">默认值LRU</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">flushInterval</td>
<td align="left">这是一个整数，它以毫秒为单位，比如1分钟刷新一次，则配置60000。默认,null，也就是没有刷新时间，只有当执行update时，insert和delete语句才会刷新</td>
<td align="left">正整数</td>
<td align="left">超时后缓存失效</td>
</tr>
<tr>
<td align="center">type</td>
<td align="left">自定义缓存类，要求实现org.apache.ibatis.cache.Cache</td>
<td align="left">用于自定义缓存类</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">size</td>
<td align="left">缓存对象个数</td>
<td align="left">正整数，默认1024</td>
<td align="left"></td>
</tr>
</tbody></table>
<h4 id="自定义缓存实现类"><a href="#自定义缓存实现类" class="headerlink" title="自定义缓存实现类"></a>自定义缓存实现类</h4><p>可以自定义缓存，只需要实现接口org.apache.ibatis.cache.Cache</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReadWriteLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cache</span> </span>{</span><br><span class="line">    <span class="function">String <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object var1, Object var2)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">getObject</span><span class="params">(Object var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">removeObject</span><span class="params">(Object var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> ReadWriteLock <span class="title">getReadWriteLock</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="其他缓存"><a href="#其他缓存" class="headerlink" title="其他缓存"></a>其他缓存</h4><p>现实中，可以使用Redis、MongoDB或者其他常用的缓存，可以如下配置：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span> <span class="attr">type</span>=<span class="string">"mybatis.RedisCache"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"localhost"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cache</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>这样配置后，MyBatis会启用缓存，同时调用setHost(String host)方法设置配置的内容：</p>
<h4 id="语句自定义缓存"><a href="#语句自定义缓存" class="headerlink" title="语句自定义缓存"></a>语句自定义缓存</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">...</span> <span class="attr">flushCache</span>=<span class="string">"false"</span> <span class="attr">userCache</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">...</span> <span class="attr">flushCache</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">...</span> <span class="attr">flushCache</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">...</span> <span class="attr">flushCache</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>以上是默认配置，flushCache代表是否刷新缓存，userCache是select特有的，代表是否启用缓存。</p>
<h4 id="缓存引用"><a href="#缓存引用" class="headerlink" title="缓存引用"></a>缓存引用</h4><p>一个映射器内配置，如RoleMapper.xml，那么其他映射器不能使用，如果其他映射器需要相同的配置，需要引用缓存配置：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache-ref</span> <span class="attr">namespace</span>=<span class="string">"mybatis.RoleMapper"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h2><ul>
<li>输入参数</li>
<li>输出参数</li>
<li>输入输出参数</li>
</ul>
<p>待跟进</p>
<blockquote>
<h1 id="动态SQL"><a href="#动态SQL" class="headerlink" title="动态SQL"></a>动态SQL</h1></blockquote>
<h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><table>
<thead>
<tr>
<th align="center">元素</th>
<th align="center">作用</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">if</td>
<td align="center">判断语句</td>
<td align="center">单条件分支判断</td>
</tr>
<tr>
<td align="center">choose</td>
<td align="center">相当于Java中的switch和case语句</td>
<td align="center">多条件分支判断</td>
</tr>
<tr>
<td align="center">trim(where, set)</td>
<td align="center">辅助元素，用于处理特定的SQL拼装问题，比如去掉多余的and/or等</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">foreach</td>
<td align="center">循环语句</td>
<td align="center"></td>
</tr>
</tbody></table>
<h2 id="if元素"><a href="#if元素" class="headerlink" title="if元素"></a>if元素</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultMap</span>=<span class="string">"roleResultMap"</span>&gt;</span></span><br><span class="line">    select id, role_name, note from t_role where 1 = 1</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"roleName != null and roleName != ''"</span>&gt;</span></span><br><span class="line">        and role_name like concat('%', #{roleName}, '%')</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="choose、when、otherwise元素"><a href="#choose、when、otherwise元素" class="headerlink" title="choose、when、otherwise元素"></a>choose、when、otherwise元素</h2><p>类似于switch…case…default语句</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span> <span class="attr">resultMap</span>=<span class="string">"roleResultMap"</span>&gt;</span></span><br><span class="line">    select id, role_name, note from t_role</span><br><span class="line">    where 1 = 1</span><br><span class="line">    <span class="tag">&lt;<span class="name">choose</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">"id != null and id !=''"</span>&gt;</span></span><br><span class="line">            and id = #{id}</span><br><span class="line">        <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">"roleName != null and roleName !=''"</span>&gt;</span></span><br><span class="line">            and role_name like concat('%', #{roleName}, '%')</span><br><span class="line">        <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">otherwise</span>&gt;</span></span><br><span class="line">            and note is not null</span><br><span class="line">        <span class="tag">&lt;/<span class="name">otherwise</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">choose</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="trim、where、set元素"><a href="#trim、where、set元素" class="headerlink" title="trim、where、set元素"></a>trim、where、set元素</h2><p>前面有$1 = 1$在where里，如果去掉，是一条错误语句，加上又很奇怪，可考虑一下写法去掉$1 = 1$<br>当where元素里的条件成立时，才会加入where这个SQL关键字</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span> <span class="attr">resultMap</span>=<span class="string">"roleResultMap"</span>&gt;</span></span><br><span class="line">    select id, role_name, note from t_role</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"roleName != null and roleName != ''"</span>&gt;</span></span><br><span class="line">            role_name like concat('%', #{roleName}, '%')</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"note != null and note !=''"</span>&gt;</span></span><br><span class="line">            and note like concat('%', #{note}, '%')</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>与上面等价</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultMap</span>=<span class="string">"roleResultMap"</span>&gt;</span></span><br><span class="line">    select id, role_name, note from t_role</span><br><span class="line">    <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"where"</span> <span class="attr">prefixOverrides</span>=<span class="string">"and"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"roleName != null and roleName != ''"</span>&gt;</span></span><br><span class="line">            and role_name like concat('%', #{roleName}, '%')</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>现实中，可能更新某一对象的某些字段，而非全部，可以使用set元素避免缺失问题：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">    update t_role</span><br><span class="line">    <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"roleName != null and roleName != ''"</span>&gt;</span></span><br><span class="line">            role_name = #{roleName},</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"note != null and note !=''"</span>&gt;</span></span><br><span class="line">            note = #{note}</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">    where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>set元素遇到逗号，会把对应的逗号去掉。</p>
<h2 id="foreach元素"><a href="#foreach元素" class="headerlink" title="foreach元素"></a>foreach元素</h2><p>foreach元素是一个循环语句，用于遍历集合，能很好地支持数组和List、Set接口的集合。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findUserBySex"</span> <span class="attr">resultType</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">    select * from t_role where id in</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">"roleNo"</span> <span class="attr">index</span>=<span class="string">"index"</span> <span class="attr">collection</span>=<span class="string">"roleNoList"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">close</span>=<span class="string">")"</span>&gt;</span></span><br><span class="line">        #{roleNo}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>collection配置的roleNoList是传递进来的参数名称，它可以是一个数组、List、Set等集合；</li>
<li>item配置的是循环中当前的元素；</li>
<li>index配置的是当前元素在集合的位置下标；</li>
<li>open和close配置的是以什么符号将这些集合元素包装起来；</li>
<li>separator是各个元素的间隔符</li>
</ul>
<h2 id="用test的属性判断字符串"><a href="#用test的属性判断字符串" class="headerlink" title="用test的属性判断字符串"></a>用test的属性判断字符串</h2><p>test用于条件判断语句，它在MyBatis中使用广泛。test的作用相当于判断真假，在大部分场景中，它都是用以判断空和非空的。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRoleTest"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultMap</span>=<span class="string">"roleResultMap"</span>&gt;</span></span><br><span class="line">      selct id, role_name, note from t_role</span><br><span class="line">      <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">" type == 'Y'.toString()"</span>&gt;</span></span><br><span class="line">          where 1=1</span><br><span class="line">      <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="bind元素"><a href="#bind元素" class="headerlink" title="bind元素"></a>bind元素</h2><p>bind元素的作用通过OGNL表达式去定义一个上下文变量，更方便使用。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRole"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bind</span> <span class="attr">name</span>=<span class="string">"pattern"</span> <span class="attr">value</span>=<span class="string">"'%' + _parameter + '%"</span>/&gt;</span></span><br><span class="line">    select id, role_name as roleName, create_date as createDate, end_date as endDate,</span><br><span class="line">            end_flag as endFlag, note from t_role</span><br><span class="line">    where role_name like #{pattern}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="MyBatis的解析和运行原理"><a href="#MyBatis的解析和运行原理" class="headerlink" title="MyBatis的解析和运行原理"></a>MyBatis的解析和运行原理</h1></blockquote>
<h2 id="构建SqlSessionFactory过程"><a href="#构建SqlSessionFactory过程" class="headerlink" title="构建SqlSessionFactory过程"></a>构建SqlSessionFactory过程</h2><p>SqlSessionFactory是MyBatis的核心类之一，其最重要的功能就是提供创建MyBatis的核心接口SqlSession，所以要先创建SqlSessionFactory，为此要提供配置文件和相关的参数。</p>
<p>MyBatis是一个复杂的系统，它采用Builder模式去创建SqlSessionFactory，在实际中可以通过SqlSessionFactoryBuilder去构建：</p>
<ul>
<li>第一步：通过org.apache.ibatis.builder.xml.XMLConfigBuilder解析配置的XML文件，独处所配置的参数，并将读取的内容存入org.apache.ibatis.Configuration类对象中。而Configuraion采用的是单例模式，几乎所有的MyBatis配置内容都会存放在这个单例对象中，以便后续将这些内容独处。</li>
<li>第二步：使用Configuration对象去创建SqlSessionFactory。SqlSessionFactory是一个接口，而不是一个实现类，为此MyBatis提供了一个默认的实现类org.apache.ibatis.session.defaults.DefaultSqlSessionFactory。</li>
</ul>
<h3 id="XMLConfigBuilder"><a href="#XMLConfigBuilder" class="headerlink" title="XMLConfigBuilder"></a>XMLConfigBuilder</h3><p>从该方法可以看到，其通过一步步解析XML的内容得到对应的信息，而这些信息正式我们在配置文件中配置的内容。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseConfiguration</span><span class="params">(XNode root)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">this</span>.propertiesElement(root.evalNode(<span class="string">"properties"</span>));</span><br><span class="line">        Properties settings = <span class="keyword">this</span>.settingsAsProperties(root.evalNode(<span class="string">"settings"</span>));</span><br><span class="line">        <span class="keyword">this</span>.loadCustomVfs(settings);</span><br><span class="line">        <span class="keyword">this</span>.loadCustomLogImpl(settings);</span><br><span class="line">        <span class="keyword">this</span>.typeAliasesElement(root.evalNode(<span class="string">"typeAliases"</span>));</span><br><span class="line">        <span class="keyword">this</span>.pluginElement(root.evalNode(<span class="string">"plugins"</span>));</span><br><span class="line">        <span class="keyword">this</span>.objectFactoryElement(root.evalNode(<span class="string">"objectFactory"</span>));</span><br><span class="line">        <span class="keyword">this</span>.objectWrapperFactoryElement(root.evalNode(<span class="string">"objectWrapperFactory"</span>));</span><br><span class="line">        <span class="keyword">this</span>.reflectorFactoryElement(root.evalNode(<span class="string">"reflectorFactory"</span>));</span><br><span class="line">        <span class="keyword">this</span>.settingsElement(settings);</span><br><span class="line">        <span class="keyword">this</span>.environmentsElement(root.evalNode(<span class="string">"environments"</span>));</span><br><span class="line">        <span class="keyword">this</span>.databaseIdProviderElement(root.evalNode(<span class="string">"databaseIdProvider"</span>));</span><br><span class="line">        <span class="keyword">this</span>.typeHandlerElement(root.evalNode(<span class="string">"typeHandlers"</span>));</span><br><span class="line">        <span class="keyword">this</span>.mapperElement(root.evalNode(<span class="string">"mappers"</span>));</span><br><span class="line">    } <span class="keyword">catch</span> (Exception var3) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error parsing SQL Mapper Configuration. Cause: "</span> + var3, var3);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.builder.xml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.builder.BaseBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.builder.BuilderException;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.DataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.ErrorContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.loader.ProxyFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.VFS;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.DatabaseIdProvider;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.Environment;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.Environment.Builder;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.parsing.XNode;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.parsing.XPathParser;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.Interceptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.DefaultReflectorFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.MetaClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ReflectorFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.factory.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.wrapper.ObjectWrapperFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.AutoMappingBehavior;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.AutoMappingUnknownColumnBehavior;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.ExecutorType;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.LocalCacheScope;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.transaction.TransactionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.type.JdbcType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XMLConfigBuilder</span> <span class="keyword">extends</span> <span class="title">BaseBuilder</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> parsed;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> XPathParser parser;</span><br><span class="line">    <span class="keyword">private</span> String environment;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReflectorFactory localReflectorFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XMLConfigBuilder</span><span class="params">(Reader reader)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>((Reader)reader, (String)<span class="keyword">null</span>, (Properties)<span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XMLConfigBuilder</span><span class="params">(Reader reader, String environment)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>((Reader)reader, environment, (Properties)<span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XMLConfigBuilder</span><span class="params">(Reader reader, String environment, Properties props)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">new</span> XPathParser(reader, <span class="keyword">true</span>, props, <span class="keyword">new</span> XMLMapperEntityResolver()), environment, props);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XMLConfigBuilder</span><span class="params">(InputStream inputStream)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>((InputStream)inputStream, (String)<span class="keyword">null</span>, (Properties)<span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XMLConfigBuilder</span><span class="params">(InputStream inputStream, String environment)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>((InputStream)inputStream, environment, (Properties)<span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XMLConfigBuilder</span><span class="params">(InputStream inputStream, String environment, Properties props)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">new</span> XPathParser(inputStream, <span class="keyword">true</span>, props, <span class="keyword">new</span> XMLMapperEntityResolver()), environment, props);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">XMLConfigBuilder</span><span class="params">(XPathParser parser, String environment, Properties props)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> Configuration());</span><br><span class="line">        <span class="keyword">this</span>.localReflectorFactory = <span class="keyword">new</span> DefaultReflectorFactory();</span><br><span class="line">        ErrorContext.instance().resource(<span class="string">"SQL Mapper Configuration"</span>);</span><br><span class="line">        <span class="keyword">this</span>.configuration.setVariables(props);</span><br><span class="line">        <span class="keyword">this</span>.parsed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br><span class="line">        <span class="keyword">this</span>.parser = parser;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Configuration <span class="title">parse</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.parsed) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Each XMLConfigBuilder can only be used once."</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">this</span>.parsed = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">this</span>.parseConfiguration(<span class="keyword">this</span>.parser.evalNode(<span class="string">"/configuration"</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.configuration;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseConfiguration</span><span class="params">(XNode root)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">this</span>.propertiesElement(root.evalNode(<span class="string">"properties"</span>));</span><br><span class="line">            Properties settings = <span class="keyword">this</span>.settingsAsProperties(root.evalNode(<span class="string">"settings"</span>));</span><br><span class="line">            <span class="keyword">this</span>.loadCustomVfs(settings);</span><br><span class="line">            <span class="keyword">this</span>.loadCustomLogImpl(settings);</span><br><span class="line">            <span class="keyword">this</span>.typeAliasesElement(root.evalNode(<span class="string">"typeAliases"</span>));</span><br><span class="line">            <span class="keyword">this</span>.pluginElement(root.evalNode(<span class="string">"plugins"</span>));</span><br><span class="line">            <span class="keyword">this</span>.objectFactoryElement(root.evalNode(<span class="string">"objectFactory"</span>));</span><br><span class="line">            <span class="keyword">this</span>.objectWrapperFactoryElement(root.evalNode(<span class="string">"objectWrapperFactory"</span>));</span><br><span class="line">            <span class="keyword">this</span>.reflectorFactoryElement(root.evalNode(<span class="string">"reflectorFactory"</span>));</span><br><span class="line">            <span class="keyword">this</span>.settingsElement(settings);</span><br><span class="line">            <span class="keyword">this</span>.environmentsElement(root.evalNode(<span class="string">"environments"</span>));</span><br><span class="line">            <span class="keyword">this</span>.databaseIdProviderElement(root.evalNode(<span class="string">"databaseIdProvider"</span>));</span><br><span class="line">            <span class="keyword">this</span>.typeHandlerElement(root.evalNode(<span class="string">"typeHandlers"</span>));</span><br><span class="line">            <span class="keyword">this</span>.mapperElement(root.evalNode(<span class="string">"mappers"</span>));</span><br><span class="line">        } <span class="keyword">catch</span> (Exception var3) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error parsing SQL Mapper Configuration. Cause: "</span> + var3, var3);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Properties <span class="title">settingsAsProperties</span><span class="params">(XNode context)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Properties();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            Properties props = context.getChildrenAsProperties();</span><br><span class="line">            MetaClass metaConfig = MetaClass.forClass(Configuration<span class="class">.<span class="keyword">class</span>, <span class="title">this</span>.<span class="title">localReflectorFactory</span>)</span>;</span><br><span class="line">            Iterator var4 = props.keySet().iterator();</span><br><span class="line"></span><br><span class="line">            Object key;</span><br><span class="line">            <span class="keyword">do</span> {</span><br><span class="line">                <span class="keyword">if</span> (!var4.hasNext()) {</span><br><span class="line">                    <span class="keyword">return</span> props;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                key = var4.next();</span><br><span class="line">            } <span class="keyword">while</span>(metaConfig.hasSetter(String.valueOf(key)));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"The setting "</span> + key + <span class="string">" is not known.  Make sure you spelled it correctly (case sensitive)."</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadCustomVfs</span><span class="params">(Properties props)</span> <span class="keyword">throws</span> ClassNotFoundException </span>{</span><br><span class="line">        String value = props.getProperty(<span class="string">"vfsImpl"</span>);</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span>) {</span><br><span class="line">            String[] clazzes = value.split(<span class="string">","</span>);</span><br><span class="line">            String[] var4 = clazzes;</span><br><span class="line">            <span class="keyword">int</span> var5 = clazzes.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var6 = <span class="number">0</span>; var6 &lt; var5; ++var6) {</span><br><span class="line">                String clazz = var4[var6];</span><br><span class="line">                <span class="keyword">if</span> (!clazz.isEmpty()) {</span><br><span class="line">                    Class&lt;? extends VFS&gt; vfsImpl = Resources.classForName(clazz);</span><br><span class="line">                    <span class="keyword">this</span>.configuration.setVfsImpl(vfsImpl);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadCustomLogImpl</span><span class="params">(Properties props)</span> </span>{</span><br><span class="line">        Class&lt;? extends Log&gt; logImpl = <span class="keyword">this</span>.resolveClass(props.getProperty(<span class="string">"logImpl"</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setLogImpl(logImpl);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">typeAliasesElement</span><span class="params">(XNode parent)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) {</span><br><span class="line">            Iterator var2 = parent.getChildren().iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var2.hasNext()) {</span><br><span class="line">                XNode child = (XNode)var2.next();</span><br><span class="line">                String alias;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"package"</span>.equals(child.getName())) {</span><br><span class="line">                    alias = child.getStringAttribute(<span class="string">"name"</span>);</span><br><span class="line">                    <span class="keyword">this</span>.configuration.getTypeAliasRegistry().registerAliases(alias);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    alias = child.getStringAttribute(<span class="string">"alias"</span>);</span><br><span class="line">                    String type = child.getStringAttribute(<span class="string">"type"</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        Class&lt;?&gt; clazz = Resources.classForName(type);</span><br><span class="line">                        <span class="keyword">if</span> (alias == <span class="keyword">null</span>) {</span><br><span class="line">                            <span class="keyword">this</span>.typeAliasRegistry.registerAlias(clazz);</span><br><span class="line">                        } <span class="keyword">else</span> {</span><br><span class="line">                            <span class="keyword">this</span>.typeAliasRegistry.registerAlias(alias, clazz);</span><br><span class="line">                        }</span><br><span class="line">                    } <span class="keyword">catch</span> (ClassNotFoundException var7) {</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error registering typeAlias for '"</span> + alias + <span class="string">"'. Cause: "</span> + var7, var7);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pluginElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) {</span><br><span class="line">            Iterator var2 = parent.getChildren().iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var2.hasNext()) {</span><br><span class="line">                XNode child = (XNode)var2.next();</span><br><span class="line">                String interceptor = child.getStringAttribute(<span class="string">"interceptor"</span>);</span><br><span class="line">                Properties properties = child.getChildrenAsProperties();</span><br><span class="line">                Interceptor interceptorInstance = (Interceptor)<span class="keyword">this</span>.resolveClass(interceptor).getDeclaredConstructor().newInstance();</span><br><span class="line">                interceptorInstance.setProperties(properties);</span><br><span class="line">                <span class="keyword">this</span>.configuration.addInterceptor(interceptorInstance);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">objectFactoryElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) {</span><br><span class="line">            String type = context.getStringAttribute(<span class="string">"type"</span>);</span><br><span class="line">            Properties properties = context.getChildrenAsProperties();</span><br><span class="line">            ObjectFactory factory = (ObjectFactory)<span class="keyword">this</span>.resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">            factory.setProperties(properties);</span><br><span class="line">            <span class="keyword">this</span>.configuration.setObjectFactory(factory);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">objectWrapperFactoryElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) {</span><br><span class="line">            String type = context.getStringAttribute(<span class="string">"type"</span>);</span><br><span class="line">            ObjectWrapperFactory factory = (ObjectWrapperFactory)<span class="keyword">this</span>.resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">            <span class="keyword">this</span>.configuration.setObjectWrapperFactory(factory);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reflectorFactoryElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) {</span><br><span class="line">            String type = context.getStringAttribute(<span class="string">"type"</span>);</span><br><span class="line">            ReflectorFactory factory = (ReflectorFactory)<span class="keyword">this</span>.resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">            <span class="keyword">this</span>.configuration.setReflectorFactory(factory);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">propertiesElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) {</span><br><span class="line">            Properties defaults = context.getChildrenAsProperties();</span><br><span class="line">            String resource = context.getStringAttribute(<span class="string">"resource"</span>);</span><br><span class="line">            String url = context.getStringAttribute(<span class="string">"url"</span>);</span><br><span class="line">            <span class="keyword">if</span> (resource != <span class="keyword">null</span> &amp;&amp; url != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other."</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (resource != <span class="keyword">null</span>) {</span><br><span class="line">                defaults.putAll(Resources.getResourceAsProperties(resource));</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (url != <span class="keyword">null</span>) {</span><br><span class="line">                defaults.putAll(Resources.getUrlAsProperties(url));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            Properties vars = <span class="keyword">this</span>.configuration.getVariables();</span><br><span class="line">            <span class="keyword">if</span> (vars != <span class="keyword">null</span>) {</span><br><span class="line">                defaults.putAll(vars);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.parser.setVariables(defaults);</span><br><span class="line">            <span class="keyword">this</span>.configuration.setVariables(defaults);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">settingsElement</span><span class="params">(Properties props)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.configuration.setAutoMappingBehavior(AutoMappingBehavior.valueOf(props.getProperty(<span class="string">"autoMappingBehavior"</span>, <span class="string">"PARTIAL"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setAutoMappingUnknownColumnBehavior(AutoMappingUnknownColumnBehavior.valueOf(props.getProperty(<span class="string">"autoMappingUnknownColumnBehavior"</span>, <span class="string">"NONE"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setCacheEnabled(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"cacheEnabled"</span>), <span class="keyword">true</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setProxyFactory((ProxyFactory)<span class="keyword">this</span>.createInstance(props.getProperty(<span class="string">"proxyFactory"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setLazyLoadingEnabled(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"lazyLoadingEnabled"</span>), <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setAggressiveLazyLoading(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"aggressiveLazyLoading"</span>), <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setMultipleResultSetsEnabled(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"multipleResultSetsEnabled"</span>), <span class="keyword">true</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setUseColumnLabel(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"useColumnLabel"</span>), <span class="keyword">true</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setUseGeneratedKeys(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"useGeneratedKeys"</span>), <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setDefaultExecutorType(ExecutorType.valueOf(props.getProperty(<span class="string">"defaultExecutorType"</span>, <span class="string">"SIMPLE"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setDefaultStatementTimeout(<span class="keyword">this</span>.integerValueOf(props.getProperty(<span class="string">"defaultStatementTimeout"</span>), (Integer)<span class="keyword">null</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setDefaultFetchSize(<span class="keyword">this</span>.integerValueOf(props.getProperty(<span class="string">"defaultFetchSize"</span>), (Integer)<span class="keyword">null</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setDefaultResultSetType(<span class="keyword">this</span>.resolveResultSetType(props.getProperty(<span class="string">"defaultResultSetType"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setMapUnderscoreToCamelCase(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"mapUnderscoreToCamelCase"</span>), <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setSafeRowBoundsEnabled(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"safeRowBoundsEnabled"</span>), <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setLocalCacheScope(LocalCacheScope.valueOf(props.getProperty(<span class="string">"localCacheScope"</span>, <span class="string">"SESSION"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setJdbcTypeForNull(JdbcType.valueOf(props.getProperty(<span class="string">"jdbcTypeForNull"</span>, <span class="string">"OTHER"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setLazyLoadTriggerMethods(<span class="keyword">this</span>.stringSetValueOf(props.getProperty(<span class="string">"lazyLoadTriggerMethods"</span>), <span class="string">"equals,clone,hashCode,toString"</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setSafeResultHandlerEnabled(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"safeResultHandlerEnabled"</span>), <span class="keyword">true</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setDefaultScriptingLanguage(<span class="keyword">this</span>.resolveClass(props.getProperty(<span class="string">"defaultScriptingLanguage"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setDefaultEnumTypeHandler(<span class="keyword">this</span>.resolveClass(props.getProperty(<span class="string">"defaultEnumTypeHandler"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setCallSettersOnNulls(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"callSettersOnNulls"</span>), <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setUseActualParamName(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"useActualParamName"</span>), <span class="keyword">true</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setReturnInstanceForEmptyRow(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"returnInstanceForEmptyRow"</span>), <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setLogPrefix(props.getProperty(<span class="string">"logPrefix"</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setConfigurationFactory(<span class="keyword">this</span>.resolveClass(props.getProperty(<span class="string">"configurationFactory"</span>)));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setShrinkWhitespacesInSql(<span class="keyword">this</span>.booleanValueOf(props.getProperty(<span class="string">"shrinkWhitespacesInSql"</span>), <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">this</span>.configuration.setDefaultSqlProviderType(<span class="keyword">this</span>.resolveClass(props.getProperty(<span class="string">"defaultSqlProviderType"</span>)));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">environmentsElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.environment == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">this</span>.environment = context.getStringAttribute(<span class="string">"default"</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            Iterator var2 = context.getChildren().iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var2.hasNext()) {</span><br><span class="line">                XNode child = (XNode)var2.next();</span><br><span class="line">                String id = child.getStringAttribute(<span class="string">"id"</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.isSpecifiedEnvironment(id)) {</span><br><span class="line">                    TransactionFactory txFactory = <span class="keyword">this</span>.transactionManagerElement(child.evalNode(<span class="string">"transactionManager"</span>));</span><br><span class="line">                    DataSourceFactory dsFactory = <span class="keyword">this</span>.dataSourceElement(child.evalNode(<span class="string">"dataSource"</span>));</span><br><span class="line">                    DataSource dataSource = dsFactory.getDataSource();</span><br><span class="line">                    Builder environmentBuilder = (<span class="keyword">new</span> Builder(id)).transactionFactory(txFactory).dataSource(dataSource);</span><br><span class="line">                    <span class="keyword">this</span>.configuration.setEnvironment(environmentBuilder.build());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">databaseIdProviderElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        DatabaseIdProvider databaseIdProvider = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) {</span><br><span class="line">            String type = context.getStringAttribute(<span class="string">"type"</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"VENDOR"</span>.equals(type)) {</span><br><span class="line">                type = <span class="string">"DB_VENDOR"</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            Properties properties = context.getChildrenAsProperties();</span><br><span class="line">            databaseIdProvider = (DatabaseIdProvider)<span class="keyword">this</span>.resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">            databaseIdProvider.setProperties(properties);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        Environment environment = <span class="keyword">this</span>.configuration.getEnvironment();</span><br><span class="line">        <span class="keyword">if</span> (environment != <span class="keyword">null</span> &amp;&amp; databaseIdProvider != <span class="keyword">null</span>) {</span><br><span class="line">            String databaseId = databaseIdProvider.getDatabaseId(environment.getDataSource());</span><br><span class="line">            <span class="keyword">this</span>.configuration.setDatabaseId(databaseId);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> TransactionFactory <span class="title">transactionManagerElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) {</span><br><span class="line">            String type = context.getStringAttribute(<span class="string">"type"</span>);</span><br><span class="line">            Properties props = context.getChildrenAsProperties();</span><br><span class="line">            TransactionFactory factory = (TransactionFactory)<span class="keyword">this</span>.resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">            factory.setProperties(props);</span><br><span class="line">            <span class="keyword">return</span> factory;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Environment declaration requires a TransactionFactory."</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DataSourceFactory <span class="title">dataSourceElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) {</span><br><span class="line">            String type = context.getStringAttribute(<span class="string">"type"</span>);</span><br><span class="line">            Properties props = context.getChildrenAsProperties();</span><br><span class="line">            DataSourceFactory factory = (DataSourceFactory)<span class="keyword">this</span>.resolveClass(type).getDeclaredConstructor().newInstance();</span><br><span class="line">            factory.setProperties(props);</span><br><span class="line">            <span class="keyword">return</span> factory;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Environment declaration requires a DataSourceFactory."</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">typeHandlerElement</span><span class="params">(XNode parent)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) {</span><br><span class="line">            Iterator var2 = parent.getChildren().iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var2.hasNext()) {</span><br><span class="line">                XNode child = (XNode)var2.next();</span><br><span class="line">                String typeHandlerPackage;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"package"</span>.equals(child.getName())) {</span><br><span class="line">                    typeHandlerPackage = child.getStringAttribute(<span class="string">"name"</span>);</span><br><span class="line">                    <span class="keyword">this</span>.typeHandlerRegistry.register(typeHandlerPackage);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    typeHandlerPackage = child.getStringAttribute(<span class="string">"javaType"</span>);</span><br><span class="line">                    String jdbcTypeName = child.getStringAttribute(<span class="string">"jdbcType"</span>);</span><br><span class="line">                    String handlerTypeName = child.getStringAttribute(<span class="string">"handler"</span>);</span><br><span class="line">                    Class&lt;?&gt; javaTypeClass = <span class="keyword">this</span>.resolveClass(typeHandlerPackage);</span><br><span class="line">                    JdbcType jdbcType = <span class="keyword">this</span>.resolveJdbcType(jdbcTypeName);</span><br><span class="line">                    Class&lt;?&gt; typeHandlerClass = <span class="keyword">this</span>.resolveClass(handlerTypeName);</span><br><span class="line">                    <span class="keyword">if</span> (javaTypeClass != <span class="keyword">null</span>) {</span><br><span class="line">                        <span class="keyword">if</span> (jdbcType == <span class="keyword">null</span>) {</span><br><span class="line">                            <span class="keyword">this</span>.typeHandlerRegistry.register(javaTypeClass, typeHandlerClass);</span><br><span class="line">                        } <span class="keyword">else</span> {</span><br><span class="line">                            <span class="keyword">this</span>.typeHandlerRegistry.register(javaTypeClass, jdbcType, typeHandlerClass);</span><br><span class="line">                        }</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        <span class="keyword">this</span>.typeHandlerRegistry.register(typeHandlerClass);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) {</span><br><span class="line">            Iterator var2 = parent.getChildren().iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) {</span><br><span class="line">                <span class="keyword">while</span>(var2.hasNext()) {</span><br><span class="line">                    XNode child = (XNode)var2.next();</span><br><span class="line">                    String resource;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"package"</span>.equals(child.getName())) {</span><br><span class="line">                        resource = child.getStringAttribute(<span class="string">"name"</span>);</span><br><span class="line">                        <span class="keyword">this</span>.configuration.addMappers(resource);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        resource = child.getStringAttribute(<span class="string">"resource"</span>);</span><br><span class="line">                        String url = child.getStringAttribute(<span class="string">"url"</span>);</span><br><span class="line">                        String mapperClass = child.getStringAttribute(<span class="string">"class"</span>);</span><br><span class="line">                        InputStream inputStream;</span><br><span class="line">                        Throwable var8;</span><br><span class="line">                        XMLMapperBuilder mapperParser;</span><br><span class="line">                        <span class="keyword">if</span> (resource != <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) {</span><br><span class="line">                            ErrorContext.instance().resource(resource);</span><br><span class="line">                            inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">                            var8 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">try</span> {</span><br><span class="line">                                mapperParser = <span class="keyword">new</span> XMLMapperBuilder(inputStream, <span class="keyword">this</span>.configuration, resource, <span class="keyword">this</span>.configuration.getSqlFragments());</span><br><span class="line">                                mapperParser.parse();</span><br><span class="line">                            } <span class="keyword">catch</span> (Throwable var32) {</span><br><span class="line">                                var8 = var32;</span><br><span class="line">                                <span class="keyword">throw</span> var32;</span><br><span class="line">                            } <span class="keyword">finally</span> {</span><br><span class="line">                                <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) {</span><br><span class="line">                                    <span class="keyword">if</span> (var8 != <span class="keyword">null</span>) {</span><br><span class="line">                                        <span class="keyword">try</span> {</span><br><span class="line">                                            inputStream.close();</span><br><span class="line">                                        } <span class="keyword">catch</span> (Throwable var30) {</span><br><span class="line">                                            var8.addSuppressed(var30);</span><br><span class="line">                                        }</span><br><span class="line">                                    } <span class="keyword">else</span> {</span><br><span class="line">                                        inputStream.close();</span><br><span class="line">                                    }</span><br><span class="line">                                }</span><br><span class="line"></span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url != <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) {</span><br><span class="line">                            ErrorContext.instance().resource(url);</span><br><span class="line">                            inputStream = Resources.getUrlAsStream(url);</span><br><span class="line">                            var8 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">try</span> {</span><br><span class="line">                                mapperParser = <span class="keyword">new</span> XMLMapperBuilder(inputStream, <span class="keyword">this</span>.configuration, url, <span class="keyword">this</span>.configuration.getSqlFragments());</span><br><span class="line">                                mapperParser.parse();</span><br><span class="line">                            } <span class="keyword">catch</span> (Throwable var31) {</span><br><span class="line">                                var8 = var31;</span><br><span class="line">                                <span class="keyword">throw</span> var31;</span><br><span class="line">                            } <span class="keyword">finally</span> {</span><br><span class="line">                                <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) {</span><br><span class="line">                                    <span class="keyword">if</span> (var8 != <span class="keyword">null</span>) {</span><br><span class="line">                                        <span class="keyword">try</span> {</span><br><span class="line">                                            inputStream.close();</span><br><span class="line">                                        } <span class="keyword">catch</span> (Throwable var29) {</span><br><span class="line">                                            var8.addSuppressed(var29);</span><br><span class="line">                                        }</span><br><span class="line">                                    } <span class="keyword">else</span> {</span><br><span class="line">                                        inputStream.close();</span><br><span class="line">                                    }</span><br><span class="line">                                }</span><br><span class="line"></span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">else</span> {</span><br><span class="line">                            <span class="keyword">if</span> (resource != <span class="keyword">null</span> || url != <span class="keyword">null</span> || mapperClass == <span class="keyword">null</span>) {</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"A mapper element may only specify a url, resource or class, but not more than one."</span>);</span><br><span class="line">                            }</span><br><span class="line"></span><br><span class="line">                            Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">                            <span class="keyword">this</span>.configuration.addMapper(mapperInterface);</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSpecifiedEnvironment</span><span class="params">(String id)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.environment == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"No environment specified."</span>);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (id == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Environment requires an id attribute."</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.environment.equals(id);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="构建Configuration"><a href="#构建Configuration" class="headerlink" title="构建Configuration"></a>构建Configuration</h3><p>在SqlSessionFactory构建中，Configuration是最重要的，它的作用是：</p>
<ul>
<li>读入配置文件，包括基础配置的XML和映射XML（或注解）；</li>
<li>初始化一些基础配置，比如MyBatis的别名等，一些重要的类对象（比如插件、映射器、Object工厂、typeHandler对象等）；</li>
<li>提供单例，为后续创建SessionFactory服务，提供配置的参数；</li>
<li>执行一些重要对象的初始化方法；</li>
</ul>
<p>Configuration不会是一个很简单的类，MyBatis的配置信息都来自于此，其通过XMLConfigBuilder去构建的，首先它会读出所有XML配置的信息，然后把它们解析并保存在Configuration单例中。并初始化以下内容：</p>
<ul>
<li>properties全局参数</li>
<li>typeAliases别名</li>
<li>Plugins插件</li>
<li>objectFactory对象工厂</li>
<li>objectWrapperFactory对象包装工厂</li>
<li>reflectionFactory反射工厂</li>
<li>settings环境设置</li>
<li>environments数据库环境</li>
<li>databaseIdProvider数据库标识</li>
<li>typeHandlers类型转换器</li>
<li>Mappers映射器</li>
</ul>
<p>它们都会以类似typeHandler注册那样的方法被存放到Configuration单例中。</p>
<h3 id="构建映射器的内部组成"><a href="#构建映射器的内部组成" class="headerlink" title="构建映射器的内部组成"></a>构建映射器的内部组成</h3><p>当XMLConfigBuilder解析XML时，会将每一个SQL和其配置的内容保存起来，一般而言，在MyBatis中一条SQL和它相关的配置信息是由3个部分组成的，它们分别是MappedStatement、SqlSource和BoundSql。</p>
<ul>
<li>MappedStatement的作用是保存一个映射器节点(select/insert/delete/update)的内容。它是一个类，包括许多我们配置的SQL、SQL的id、缓存信息、resultMap、parameterType、resultType等重要配置内容。他还有一个重要的属性sqlSourec。MyBatis通过读取它来获得某条SQL配置的所有信息。</li>
<li>SqlSource是提供BoundSql对象的地方，它是MappedStatement的一个属性。它是一个接口，它有几个实现类DynamicSqlSource、ProviderSqlSource、RawSqlSource、StatisSqlSource。它的作用是根据上下文和参数解析生成需要的SQL、这个接口只定义了一个接口方法——getBoundSql(parameterObject)，使用它就可以得到一个BoundSql对象。</li>
<li>BoundSql是一个结果对象，也就是SqlSource通过对SQL和参数的联合解析得到的SQL和参数，它是建立SQL和参数的地方，它有3个常用的属性：sql、parameterObject、parameterMappings。</li>
</ul>
<p>BoundSql会提供3个主要的属性：parameterMappings、parameterObject和sql。<br>（1）parameterObject为参数本身，可以传递简单对象、POJO或者Map、@Param注解的参数：</p>
<ul>
<li>传递简单对象，包括int、String、float、double等。当传递基本数据类型时会装箱；</li>
<li>传递POJO或者Map，parameterObject就是传入的POJO或Map</li>
<li>传递多个参数，如果没有@Param注解，那么MyBatis就会把parameterObject变为一个Map&lt;String, Object&gt;对象，其键值的关系是按顺序来规划的，类似于{“1”:p1, “2”:p2…}，所以在编写时可以使用#{param1}或者#{1}去应用第一个参数</li>
<li>使用@Param注解，MyBatis会把parameterObject也变成一个Map&lt;String,Object&gt;对象，类似于没有@Param对象，只是把其数字的键值替换成@Param注解的键值。{“key1”:p1, “key2”:p2,”roleName”:p3}<br>（2）parameterMappings是一个List，它的每一个元素都是ParameterMapping对象。对象绘描述参数，参数包括属性名称、表达式、javaType、jdbcType、typeHanlder等重要信息，一般不需要去改变它。通过它就可以实现参数和SQL的结合，以便PreparedStatement能够通过它找到parameterObject对象的属性设置参数。<br>（3）sql属性就是书写在映射器里面的一条被SqlSource解析后的SQL。在大部分时候无须修改它，只是在使用插件时可以根据需要进行改写。</li>
</ul>
<h3 id="构建SqlSessionFactory"><a href="#构建SqlSessionFactory" class="headerlink" title="构建SqlSessionFactory"></a>构建SqlSessionFactory</h3><p>通过文件流生成Configuration对象，进而构建SqlSessionFactory对象</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">getSqlSessionFactory</span><span class="params">()</span></span>{</span><br><span class="line">      <span class="keyword">synchronized</span> (LOCK){</span><br><span class="line">          <span class="keyword">if</span>(sqlSessionFactory != <span class="keyword">null</span>) <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">          String resource = <span class="string">"mybatis\\mybatis-config.xml"</span>;</span><br><span class="line">          InputStream inputStream;</span><br><span class="line">          <span class="keyword">try</span>{</span><br><span class="line">              inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">              sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">          }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">      }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="SqlSession运行过程"><a href="#SqlSession运行过程" class="headerlink" title="SqlSession运行过程"></a>SqlSession运行过程</h2><h3 id="映射器（Mapper）的动态代理"><a href="#映射器（Mapper）的动态代理" class="headerlink" title="映射器（Mapper）的动态代理"></a>映射器（Mapper）的动态代理</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RoleMapper roleMapper = sqlSession.getMapper(RoleMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="DefaultSqlSession"><a href="#DefaultSqlSession" class="headerlink" title="DefaultSqlSession"></a>DefaultSqlSession</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.session.defaults;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSqlSession</span> <span class="keyword">implements</span> <span class="title">SqlSession</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Configuration configuration;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Executor executor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> autoCommit;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> dirty;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Cursor&lt;?&gt;&gt; cursorList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultSqlSession</span><span class="params">(Configuration configuration, Executor executor, <span class="keyword">boolean</span> autoCommit)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.configuration = configuration;</span><br><span class="line">        <span class="keyword">this</span>.executor = executor;</span><br><span class="line">        <span class="keyword">this</span>.dirty = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.autoCommit = autoCommit;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultSqlSession</span><span class="params">(Configuration configuration, Executor executor)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(configuration, executor, <span class="keyword">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过Configuration对象的getMapper方法</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.configuration.getMapper(type, <span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h4><p>追踪得到其通过MapperRegistry来获取对应的接口对象。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.session;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Configuration</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> MapperRegistry mapperRegistry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.mapperRegistry.getMapper(type, sqlSession);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="MapperRegistry"><a href="#MapperRegistry" class="headerlink" title="MapperRegistry"></a>MapperRegistry</h4><p>先判断是否需要注册一个Mapper，如果没有则会抛出异常信息，否则就会启用MapperProxyFactory工厂来生成一个代理实例。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.binding;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperRegistry</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Configuration config;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapperRegistry</span><span class="params">(Configuration config)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>{</span><br><span class="line">        MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory)<span class="keyword">this</span>.knownMappers.get(type);</span><br><span class="line">        <span class="keyword">if</span> (mapperProxyFactory == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> + type + <span class="string">" is not known to the MapperRegistry."</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">            } <span class="keyword">catch</span> (Exception var5) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Error getting mapper instance. Cause: "</span> + var5, var5);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="MapperProxyFactory"><a href="#MapperProxyFactory" class="headerlink" title="MapperProxyFactory"></a>MapperProxyFactory</h4><p>这里Mapper映射时通过动态代理来实现的。这里可以看到动态代理对接口的绑定，它的作用就是生成动态代理对象（占位），而代理的方法则被放到了MapperProxy类中。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.binding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.binding.MapperProxy.MapperMethodInvoker;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxyFactory</span>&lt;<span class="title">T</span>&gt; </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethodInvoker&gt; methodCache = <span class="keyword">new</span> ConcurrentHashMap();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapperProxyFactory</span><span class="params">(Class&lt;T&gt; mapperInterface)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class&lt;T&gt; <span class="title">getMapperInterface</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.mapperInterface;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Method, MapperMethodInvoker&gt; <span class="title">getMethodCache</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.methodCache;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(<span class="keyword">this</span>.mapperInterface.getClassLoader(), <span class="keyword">new</span> Class[]{<span class="keyword">this</span>.mapperInterface}, mapperProxy);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>{</span><br><span class="line">        MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> MapperProxy(sqlSession, <span class="keyword">this</span>.mapperInterface, <span class="keyword">this</span>.methodCache);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.newInstance(mapperProxy);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="MapperProxy"><a href="#MapperProxy" class="headerlink" title="MapperProxy"></a>MapperProxy</h4><p>可以看到这里的invoke方法逻辑，如果Mapper是一个JDK动态代理对象，那么就会运行到invoke方法里面。<br>invoke首先判断是否是一个类，这里Mapper是一个接口不是类，所以判定失败。然后会生成MapperMethod对象，它是通过cachedMapperMethod方法对其初始化的。最后执行execute方法，把SqlSession和当前运行的参数传递进去。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.binding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.invoke.MethodHandle;</span><br><span class="line"><span class="keyword">import</span> java.lang.invoke.MethodHandles;</span><br><span class="line"><span class="keyword">import</span> java.lang.invoke.MethodType;</span><br><span class="line"><span class="keyword">import</span> java.lang.invoke.MethodHandles.Lookup;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ExceptionUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.util.MapUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxy</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">4724728412955527868L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOWED_MODES = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Constructor&lt;Lookup&gt; lookupConstructor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method privateLookupInMethod;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SqlSession sqlSession;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperProxy.MapperMethodInvoker&gt; methodCache;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapperProxy</span><span class="params">(SqlSession sqlSession, Class&lt;T&gt; mapperInterface, Map&lt;Method, MapperProxy.MapperMethodInvoker&gt; methodCache)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.sqlSession = sqlSession;</span><br><span class="line">        <span class="keyword">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">        <span class="keyword">this</span>.methodCache = methodCache;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            return Object.class.equals(method.getDeclaringClass()) ? method.invoke(this, args) : this.cachedInvoker(method).invoke(proxy, method, args, this.sqlSession);</span><br><span class="line">        } <span class="keyword">catch</span> (Throwable var5) {</span><br><span class="line">            <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(var5);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MapperProxy.<span class="function">MapperMethodInvoker <span class="title">cachedInvoker</span><span class="params">(Method method)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> (MapperProxy.MapperMethodInvoker)MapUtil.computeIfAbsent(<span class="keyword">this</span>.methodCache, method, (m) -&gt; {</span><br><span class="line">                <span class="keyword">if</span> (m.isDefault()) {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        <span class="keyword">return</span> privateLookupInMethod == <span class="keyword">null</span> ? <span class="keyword">new</span> MapperProxy.DefaultMethodInvoker(<span class="keyword">this</span>.getMethodHandleJava8(method)) : <span class="keyword">new</span> MapperProxy.DefaultMethodInvoker(<span class="keyword">this</span>.getMethodHandleJava9(method));</span><br><span class="line">                    } <span class="keyword">catch</span> (InstantiationException | InvocationTargetException | NoSuchMethodException | IllegalAccessException var4) {</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(var4);</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> MapperProxy.PlainMethodInvoker(<span class="keyword">new</span> MapperMethod(<span class="keyword">this</span>.mapperInterface, method, <span class="keyword">this</span>.sqlSession.getConfiguration()));</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        } <span class="keyword">catch</span> (RuntimeException var4) {</span><br><span class="line">            Throwable cause = var4.getCause();</span><br><span class="line">            <span class="keyword">throw</span> (Throwable)(cause == <span class="keyword">null</span> ? var4 : cause);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> MethodHandle <span class="title">getMethodHandleJava9</span><span class="params">(Method method)</span> <span class="keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException </span>{</span><br><span class="line">        Class&lt;?&gt; declaringClass = method.getDeclaringClass();</span><br><span class="line">        <span class="keyword">return</span> ((Lookup)privateLookupInMethod.invoke((Object)<span class="keyword">null</span>, declaringClass, MethodHandles.lookup())).findSpecial(declaringClass, method.getName(), MethodType.methodType(method.getReturnType(), method.getParameterTypes()), declaringClass);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> MethodHandle <span class="title">getMethodHandleJava8</span><span class="params">(Method method)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException, InvocationTargetException </span>{</span><br><span class="line">        Class&lt;?&gt; declaringClass = method.getDeclaringClass();</span><br><span class="line">        <span class="keyword">return</span> ((Lookup)lookupConstructor.newInstance(declaringClass, <span class="number">15</span>)).unreflectSpecial(method, declaringClass);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        Method privateLookupIn;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            privateLookupIn = MethodHandles.class.getMethod("privateLookupIn", Class.class, Lookup.class);</span><br><span class="line">        } <span class="keyword">catch</span> (NoSuchMethodException var5) {</span><br><span class="line">            privateLookupIn = <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        privateLookupInMethod = privateLookupIn;</span><br><span class="line">        Constructor&lt;Lookup&gt; lookup = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (privateLookupInMethod == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                lookup = Lookup<span class="class">.<span class="keyword">class</span>.<span class="title">getDeclaredConstructor</span>(<span class="title">Class</span>.<span class="title">class</span>, <span class="title">Integer</span>.<span class="title">TYPE</span>)</span>;</span><br><span class="line">                lookup.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (NoSuchMethodException var3) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"There is neither 'privateLookupIn(Class, Lookup)' nor 'Lookup(Class, int)' method in java.lang.invoke.MethodHandles."</span>, var3);</span><br><span class="line">            } <span class="keyword">catch</span> (Exception var4) {</span><br><span class="line">                lookup = <span class="keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        lookupConstructor = lookup;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultMethodInvoker</span> <span class="keyword">implements</span> <span class="title">MapperProxy</span>.<span class="title">MapperMethodInvoker</span> </span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MethodHandle methodHandle;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DefaultMethodInvoker</span><span class="params">(MethodHandle methodHandle)</span> </span>{</span><br><span class="line">            <span class="keyword">this</span>.methodHandle = methodHandle;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args, SqlSession sqlSession)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.methodHandle.bindTo(proxy).invokeWithArguments(args);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PlainMethodInvoker</span> <span class="keyword">implements</span> <span class="title">MapperProxy</span>.<span class="title">MapperMethodInvoker</span> </span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MapperMethod mapperMethod;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PlainMethodInvoker</span><span class="params">(MapperMethod mapperMethod)</span> </span>{</span><br><span class="line">            <span class="keyword">this</span>.mapperMethod = mapperMethod;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args, SqlSession sqlSession)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.mapperMethod.execute(sqlSession, args);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">MapperMethodInvoker</span> </span>{</span><br><span class="line">        <span class="function">Object <span class="title">invoke</span><span class="params">(Object var1, Method var2, Object[] var3, SqlSession var4)</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="MapperMethod"><a href="#MapperMethod" class="headerlink" title="MapperMethod"></a>MapperMethod</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.binding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.ParameterizedType;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Type;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Flush;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.MapKey;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.cursor.Cursor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.ResultMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.SqlCommandType;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.StatementType;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.MetaObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ParamNameResolver;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.TypeParameterResolver;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.ResultHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.RowBounds;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperMethod</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MapperMethod.SqlCommand command;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MapperMethod.MethodSignature method;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapperMethod</span><span class="params">(Class&lt;?&gt; mapperInterface, Method method, Configuration config)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.command = <span class="keyword">new</span> MapperMethod.SqlCommand(config, mapperInterface, method);</span><br><span class="line">        <span class="keyword">this</span>.method = <span class="keyword">new</span> MapperMethod.MethodSignature(config, mapperInterface, method);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>{</span><br><span class="line">        Object result;</span><br><span class="line">        Object param;</span><br><span class="line">        <span class="keyword">switch</span>(<span class="keyword">this</span>.command.getType()) {</span><br><span class="line">        <span class="keyword">case</span> INSERT:</span><br><span class="line">            param = <span class="keyword">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">            result = <span class="keyword">this</span>.rowCountResult(sqlSession.insert(<span class="keyword">this</span>.command.getName(), param));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> UPDATE:</span><br><span class="line">            param = <span class="keyword">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">            result = <span class="keyword">this</span>.rowCountResult(sqlSession.update(<span class="keyword">this</span>.command.getName(), param));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DELETE:</span><br><span class="line">            param = <span class="keyword">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">            result = <span class="keyword">this</span>.rowCountResult(sqlSession.delete(<span class="keyword">this</span>.command.getName(), param));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SELECT:</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.method.returnsVoid() &amp;&amp; <span class="keyword">this</span>.method.hasResultHandler()) {</span><br><span class="line">                <span class="keyword">this</span>.executeWithResultHandler(sqlSession, args);</span><br><span class="line">                result = <span class="keyword">null</span>;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.method.returnsMany()) {</span><br><span class="line">                result = <span class="keyword">this</span>.executeForMany(sqlSession, args);</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.method.returnsMap()) {</span><br><span class="line">                result = <span class="keyword">this</span>.executeForMap(sqlSession, args);</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.method.returnsCursor()) {</span><br><span class="line">                result = <span class="keyword">this</span>.executeForCursor(sqlSession, args);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                param = <span class="keyword">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">                result = sqlSession.selectOne(<span class="keyword">this</span>.command.getName(), param);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.method.returnsOptional() &amp;&amp; (result == <span class="keyword">null</span> || !<span class="keyword">this</span>.method.getReturnType().equals(result.getClass()))) {</span><br><span class="line">                    result = Optional.ofNullable(result);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FLUSH:</span><br><span class="line">            result = sqlSession.flushStatements();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Unknown execution method for: "</span> + <span class="keyword">this</span>.command.getName());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.method.getReturnType().isPrimitive() &amp;&amp; !<span class="keyword">this</span>.method.returnsVoid()) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Mapper method '"</span> + <span class="keyword">this</span>.command.getName() + <span class="string">" attempted to return null from a method with a primitive return type ("</span> + <span class="keyword">this</span>.method.getReturnType() + <span class="string">")."</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">rowCountResult</span><span class="params">(<span class="keyword">int</span> rowCount)</span> </span>{</span><br><span class="line">        Object result;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.method.returnsVoid()) {</span><br><span class="line">            result = <span class="keyword">null</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (!Integer<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">this</span>.<span class="title">method</span>.<span class="title">getReturnType</span>()) &amp;&amp; !<span class="title">Integer</span>.<span class="title">TYPE</span>.<span class="title">equals</span>(<span class="title">this</span>.<span class="title">method</span>.<span class="title">getReturnType</span>())) </span>{</span><br><span class="line">            <span class="keyword">if</span> (!Long<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">this</span>.<span class="title">method</span>.<span class="title">getReturnType</span>()) &amp;&amp; !<span class="title">Long</span>.<span class="title">TYPE</span>.<span class="title">equals</span>(<span class="title">this</span>.<span class="title">method</span>.<span class="title">getReturnType</span>())) </span>{</span><br><span class="line">                <span class="keyword">if</span> (!Boolean<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">this</span>.<span class="title">method</span>.<span class="title">getReturnType</span>()) &amp;&amp; !<span class="title">Boolean</span>.<span class="title">TYPE</span>.<span class="title">equals</span>(<span class="title">this</span>.<span class="title">method</span>.<span class="title">getReturnType</span>())) </span>{</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Mapper method '"</span> + <span class="keyword">this</span>.command.getName() + <span class="string">"' has an unsupported return type: "</span> + <span class="keyword">this</span>.method.getReturnType());</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                result = rowCount &gt; <span class="number">0</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                result = (<span class="keyword">long</span>)rowCount;</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            result = rowCount;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeWithResultHandler</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>{</span><br><span class="line">        MappedStatement ms = sqlSession.getConfiguration().getMappedStatement(<span class="keyword">this</span>.command.getName());</span><br><span class="line">        <span class="keyword">if</span> (!StatementType.CALLABLE.equals(ms.getStatementType()) &amp;&amp; Void.TYPE.equals(((ResultMap)ms.getResultMaps().get(<span class="number">0</span>)).getType())) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"method "</span> + <span class="keyword">this</span>.command.getName() + <span class="string">" needs either a @ResultMap annotation, a @ResultType annotation, or a resultType attribute in XML so a ResultHandler can be used as a parameter."</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            Object param = <span class="keyword">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.method.hasRowBounds()) {</span><br><span class="line">                RowBounds rowBounds = <span class="keyword">this</span>.method.extractRowBounds(args);</span><br><span class="line">                sqlSession.select(<span class="keyword">this</span>.command.getName(), param, rowBounds, <span class="keyword">this</span>.method.extractResultHandler(args));</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                sqlSession.select(<span class="keyword">this</span>.command.getName(), param, <span class="keyword">this</span>.method.extractResultHandler(args));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;E&gt; <span class="function">Object <span class="title">executeForMany</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>{</span><br><span class="line">        Object param = <span class="keyword">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        List result;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.method.hasRowBounds()) {</span><br><span class="line">            RowBounds rowBounds = <span class="keyword">this</span>.method.extractRowBounds(args);</span><br><span class="line">            result = sqlSession.selectList(<span class="keyword">this</span>.command.getName(), param, rowBounds);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            result = sqlSession.selectList(<span class="keyword">this</span>.command.getName(), param);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.method.getReturnType().isAssignableFrom(result.getClass())) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.method.getReturnType().isArray() ? <span class="keyword">this</span>.convertToArray(result) : <span class="keyword">this</span>.convertToDeclaredCollection(sqlSession.getConfiguration(), result);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">Cursor&lt;T&gt; <span class="title">executeForCursor</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>{</span><br><span class="line">        Object param = <span class="keyword">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        Cursor result;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.method.hasRowBounds()) {</span><br><span class="line">            RowBounds rowBounds = <span class="keyword">this</span>.method.extractRowBounds(args);</span><br><span class="line">            result = sqlSession.selectCursor(<span class="keyword">this</span>.command.getName(), param, rowBounds);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            result = sqlSession.selectCursor(<span class="keyword">this</span>.command.getName(), param);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;E&gt; <span class="function">Object <span class="title">convertToDeclaredCollection</span><span class="params">(Configuration config, List&lt;E&gt; list)</span> </span>{</span><br><span class="line">        Object collection = config.getObjectFactory().create(<span class="keyword">this</span>.method.getReturnType());</span><br><span class="line">        MetaObject metaObject = config.newMetaObject(collection);</span><br><span class="line">        metaObject.addAll(list);</span><br><span class="line">        <span class="keyword">return</span> collection;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;E&gt; <span class="function">Object <span class="title">convertToArray</span><span class="params">(List&lt;E&gt; list)</span> </span>{</span><br><span class="line">        Class&lt;?&gt; arrayComponentType = <span class="keyword">this</span>.method.getReturnType().getComponentType();</span><br><span class="line">        Object array = Array.newInstance(arrayComponentType, list.size());</span><br><span class="line">        <span class="keyword">if</span> (!arrayComponentType.isPrimitive()) {</span><br><span class="line">            <span class="keyword">return</span> list.toArray((Object[])((Object[])array));</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); ++i) {</span><br><span class="line">                Array.set(array, i, list.get(i));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> array;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;K, V&gt; <span class="function">Map&lt;K, V&gt; <span class="title">executeForMap</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>{</span><br><span class="line">        Object param = <span class="keyword">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        Map result;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.method.hasRowBounds()) {</span><br><span class="line">            RowBounds rowBounds = <span class="keyword">this</span>.method.extractRowBounds(args);</span><br><span class="line">            result = sqlSession.selectMap(<span class="keyword">this</span>.command.getName(), param, <span class="keyword">this</span>.method.getMapKey(), rowBounds);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            result = sqlSession.selectMap(<span class="keyword">this</span>.command.getName(), param, <span class="keyword">this</span>.method.getMapKey());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodSignature</span> </span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> returnsMany;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> returnsMap;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> returnsVoid;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> returnsCursor;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> returnsOptional;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; returnType;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String mapKey;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Integer resultHandlerIndex;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Integer rowBoundsIndex;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ParamNameResolver paramNameResolver;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MethodSignature</span><span class="params">(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method)</span> </span>{</span><br><span class="line">            Type resolvedReturnType = TypeParameterResolver.resolveReturnType(method, mapperInterface);</span><br><span class="line">            <span class="keyword">if</span> (resolvedReturnType <span class="keyword">instanceof</span> Class) {</span><br><span class="line">                <span class="keyword">this</span>.returnType = (Class)resolvedReturnType;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (resolvedReturnType <span class="keyword">instanceof</span> ParameterizedType) {</span><br><span class="line">                <span class="keyword">this</span>.returnType = (Class)((ParameterizedType)resolvedReturnType).getRawType();</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">this</span>.returnType = method.getReturnType();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.returnsVoid = Void.TYPE.equals(<span class="keyword">this</span>.returnType);</span><br><span class="line">            <span class="keyword">this</span>.returnsMany = configuration.getObjectFactory().isCollection(<span class="keyword">this</span>.returnType) || <span class="keyword">this</span>.returnType.isArray();</span><br><span class="line">            <span class="keyword">this</span>.returnsCursor = Cursor<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">this</span>.<span class="title">returnType</span>)</span>;</span><br><span class="line">            <span class="keyword">this</span>.returnsOptional = Optional<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">this</span>.<span class="title">returnType</span>)</span>;</span><br><span class="line">            <span class="keyword">this</span>.mapKey = <span class="keyword">this</span>.getMapKey(method);</span><br><span class="line">            <span class="keyword">this</span>.returnsMap = <span class="keyword">this</span>.mapKey != <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">this</span>.rowBoundsIndex = <span class="keyword">this</span>.getUniqueParamIndex(method, RowBounds<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">this</span>.resultHandlerIndex = <span class="keyword">this</span>.getUniqueParamIndex(method, ResultHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">this</span>.paramNameResolver = <span class="keyword">new</span> ParamNameResolver(configuration, method);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">convertArgsToSqlCommandParam</span><span class="params">(Object[] args)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.paramNameResolver.getNamedParams(args);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRowBounds</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.rowBoundsIndex != <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> RowBounds <span class="title">extractRowBounds</span><span class="params">(Object[] args)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.hasRowBounds() ? (RowBounds)args[<span class="keyword">this</span>.rowBoundsIndex] : <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasResultHandler</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.resultHandlerIndex != <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ResultHandler <span class="title">extractResultHandler</span><span class="params">(Object[] args)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.hasResultHandler() ? (ResultHandler)args[<span class="keyword">this</span>.resultHandlerIndex] : <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Class&lt;?&gt; getReturnType() {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.returnType;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">returnsMany</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.returnsMany;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">returnsMap</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.returnsMap;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">returnsVoid</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.returnsVoid;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">returnsCursor</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.returnsCursor;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">returnsOptional</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.returnsOptional;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Integer <span class="title">getUniqueParamIndex</span><span class="params">(Method method, Class&lt;?&gt; paramType)</span> </span>{</span><br><span class="line">            Integer index = <span class="keyword">null</span>;</span><br><span class="line">            Class&lt;?&gt;[] argTypes = method.getParameterTypes();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argTypes.length; ++i) {</span><br><span class="line">                <span class="keyword">if</span> (paramType.isAssignableFrom(argTypes[i])) {</span><br><span class="line">                    <span class="keyword">if</span> (index != <span class="keyword">null</span>) {</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(method.getName() + <span class="string">" cannot have multiple "</span> + paramType.getSimpleName() + <span class="string">" parameters"</span>);</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    index = i;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> index;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getMapKey</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.mapKey;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> String <span class="title">getMapKey</span><span class="params">(Method method)</span> </span>{</span><br><span class="line">            String mapKey = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (Map<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">method</span>.<span class="title">getReturnType</span>())) </span>{</span><br><span class="line">                MapKey mapKeyAnnotation = (MapKey)method.getAnnotation(MapKey<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                <span class="keyword">if</span> (mapKeyAnnotation != <span class="keyword">null</span>) {</span><br><span class="line">                    mapKey = mapKeyAnnotation.value();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> mapKey;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlCommand</span> </span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> SqlCommandType type;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SqlCommand</span><span class="params">(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method)</span> </span>{</span><br><span class="line">            String methodName = method.getName();</span><br><span class="line">            Class&lt;?&gt; declaringClass = method.getDeclaringClass();</span><br><span class="line">            MappedStatement ms = <span class="keyword">this</span>.resolveMappedStatement(mapperInterface, methodName, declaringClass, configuration);</span><br><span class="line">            <span class="keyword">if</span> (ms == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">if</span> (method.getAnnotation(Flush<span class="class">.<span class="keyword">class</span>) </span>== <span class="keyword">null</span>) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Invalid bound statement (not found): "</span> + mapperInterface.getName() + <span class="string">"."</span> + methodName);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.name = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">this</span>.type = SqlCommandType.FLUSH;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">this</span>.name = ms.getId();</span><br><span class="line">                <span class="keyword">this</span>.type = ms.getSqlCommandType();</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.type == SqlCommandType.UNKNOWN) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Unknown execution method for: "</span> + <span class="keyword">this</span>.name);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> SqlCommandType <span class="title">getType</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.type;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> MappedStatement <span class="title">resolveMappedStatement</span><span class="params">(Class&lt;?&gt; mapperInterface, String methodName, Class&lt;?&gt; declaringClass, Configuration configuration)</span> </span>{</span><br><span class="line">            String statementId = mapperInterface.getName() + <span class="string">"."</span> + methodName;</span><br><span class="line">            <span class="keyword">if</span> (configuration.hasStatement(statementId)) {</span><br><span class="line">                <span class="keyword">return</span> configuration.getMappedStatement(statementId);</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (mapperInterface.equals(declaringClass)) {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                Class[] var6 = mapperInterface.getInterfaces();</span><br><span class="line">                <span class="keyword">int</span> var7 = var6.length;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> var8 = <span class="number">0</span>; var8 &lt; var7; ++var8) {</span><br><span class="line">                    Class&lt;?&gt; superInterface = var6[var8];</span><br><span class="line">                    <span class="keyword">if</span> (declaringClass.isAssignableFrom(superInterface)) {</span><br><span class="line">                        MappedStatement ms = <span class="keyword">this</span>.resolveMappedStatement(superInterface, methodName, declaringClass, configuration);</span><br><span class="line">                        <span class="keyword">if</span> (ms != <span class="keyword">null</span>) {</span><br><span class="line">                            <span class="keyword">return</span> ms;</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ParamMap</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMap</span>&lt;<span class="title">String</span>, <span class="title">V</span>&gt; </span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2212268410512043556L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ParamMap</span><span class="params">()</span> </span>{</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>{</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">super</span>.containsKey(key)) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Parameter '"</span> + key + <span class="string">"' not found. Available parameters are "</span> + <span class="keyword">this</span>.keySet());</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.get(key);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="SqlSession下的四大对象"><a href="#SqlSession下的四大对象" class="headerlink" title="SqlSession下的四大对象"></a>SqlSession下的四大对象</h3><p>映射器就是一个动态代理对进入到了MapperMethod的execute方法，然后它经过简单地判断进入了SqlSession的delete、update、insert、select等方法；</p>
<p>而这些方法是如何执行的呢？这是正确编写插件的根本。</p>
<p>SqlSession的执行过程是通过Executor、StatementHandler、ParameterHandler和ResultSetHandler来完成数据库操作和结果返回的。</p>
<ul>
<li>Executor代表执行器，由它调度StatementHandler、ParameterHandler、ResultSetHandler等来执行对应的SQL。其中StatementHandler是最重要的。</li>
<li>StatementHandler的作用是使用数据库的Statement(PreparedStatement)执行操作，它是四大对象的核心，起到承上启下的作用，许多重要的插件都是通过拦截它来实现的。</li>
<li>ParameterHandler是用来处理SQL参数的。</li>
<li>ResultSetHandler是进行数据集（ResultSet）的封装返回处理的，它相当复杂，不过不常用。</li>
</ul>
<h4 id="Executor——执行器"><a href="#Executor——执行器" class="headerlink" title="Executor——执行器"></a>Executor——执行器</h4><p>MyBatis中有3种执行器，可以粽子配置文件中进行选择，即settings元素中的defaultExecutorType属性：</p>
<ul>
<li>SIMPLE——简易执行器，不配置时就作为默认执行器</li>
<li>REUSE——它是一种能够执行重用预处理语句的执行器</li>
<li>BATCH——执行器重用语句和批量更新，批量专用的执行器</li>
</ul>
<p>MyBatis通过Configuration类创建Executor</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Executor <span class="title">newExecutor</span><span class="params">(Transaction transaction, ExecutorType executorType)</span> </span>{</span><br><span class="line">    executorType = executorType == <span class="keyword">null</span> ? <span class="keyword">this</span>.defaultExecutorType : executorType;</span><br><span class="line">    executorType = executorType == <span class="keyword">null</span> ? ExecutorType.SIMPLE : executorType;</span><br><span class="line">    Object executor;</span><br><span class="line">    <span class="keyword">if</span> (ExecutorType.BATCH == executorType) {</span><br><span class="line">        executor = <span class="keyword">new</span> BatchExecutor(<span class="keyword">this</span>, transaction);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (ExecutorType.REUSE == executorType) {</span><br><span class="line">        executor = <span class="keyword">new</span> ReuseExecutor(<span class="keyword">this</span>, transaction);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        executor = <span class="keyword">new</span> SimpleExecutor(<span class="keyword">this</span>, transaction);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.cacheEnabled) {</span><br><span class="line">        executor = <span class="keyword">new</span> CachingExecutor((Executor)executor);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Executor executor = (Executor)<span class="keyword">this</span>.interceptorChain.pluginAll(executor);</span><br><span class="line">    <span class="keyword">return</span> executor;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>以SimpleExcutor为例，通过Configuration来构建StatementHandler，然后使用prepareStatement方法，对SQL编译和参数进行初始化。其调用了StatementHandler进行预编译和基础设置，最后使用query方法，将ResultHandler传递进去</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.executor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.cursor.Cursor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.statement.StatementHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.BoundSql;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.ResultHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.RowBounds;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.transaction.Transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleExecutor</span> <span class="keyword">extends</span> <span class="title">BaseExecutor</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleExecutor</span><span class="params">(Configuration configuration, Transaction transaction)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(configuration, transaction);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doUpdate</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        Statement stmt = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> var6;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Configuration configuration = ms.getConfiguration();</span><br><span class="line">            StatementHandler handler = configuration.newStatementHandler(<span class="keyword">this</span>, ms, parameter, RowBounds.DEFAULT, (ResultHandler)<span class="keyword">null</span>, (BoundSql)<span class="keyword">null</span>);</span><br><span class="line">            stmt = <span class="keyword">this</span>.prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">            var6 = handler.update(stmt);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">this</span>.closeStatement(stmt);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var6;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">doQuery</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        Statement stmt = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        List var9;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Configuration configuration = ms.getConfiguration();</span><br><span class="line">            StatementHandler handler = configuration.newStatementHandler(<span class="keyword">this</span>.wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">            stmt = <span class="keyword">this</span>.prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">            var9 = handler.query(stmt, resultHandler);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">this</span>.closeStatement(stmt);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var9;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> &lt;E&gt; <span class="function">Cursor&lt;E&gt; <span class="title">doQueryCursor</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        Configuration configuration = ms.getConfiguration();</span><br><span class="line">        StatementHandler handler = configuration.newStatementHandler(<span class="keyword">this</span>.wrapper, ms, parameter, rowBounds, (ResultHandler)<span class="keyword">null</span>, boundSql);</span><br><span class="line">        Statement stmt = <span class="keyword">this</span>.prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">        Cursor&lt;E&gt; cursor = handler.queryCursor(stmt);</span><br><span class="line">        stmt.closeOnCompletion();</span><br><span class="line">        <span class="keyword">return</span> cursor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;BatchResult&gt; <span class="title">doFlushStatements</span><span class="params">(<span class="keyword">boolean</span> isRollback)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Statement <span class="title">prepareStatement</span><span class="params">(StatementHandler handler, Log statementLog)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        Connection connection = <span class="keyword">this</span>.getConnection(statementLog);</span><br><span class="line">        Statement stmt = handler.prepare(connection, <span class="keyword">this</span>.transaction.getTimeout());</span><br><span class="line">        handler.parameterize(stmt);</span><br><span class="line">        <span class="keyword">return</span> stmt;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="StatementHandler——数据库会话器"><a href="#StatementHandler——数据库会话器" class="headerlink" title="StatementHandler——数据库会话器"></a>StatementHandler——数据库会话器</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StatementHandler <span class="title">newStatementHandler</span><span class="params">(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> </span>{</span><br><span class="line">    StatementHandler statementHandler = <span class="keyword">new</span> RoutingStatementHandler(executor, mappedStatement, parameterObject, rowBounds, resultHandler, boundSql);</span><br><span class="line">    StatementHandler statementHandler = (StatementHandler)<span class="keyword">this</span>.interceptorChain.pluginAll(statementHandler);</span><br><span class="line">    <span class="keyword">return</span> statementHandler;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>创建一个RoutingStatementHandler对象，其实现了接口StatementHandler，并根据上下文环境决定创建哪个具体的StatementHandler对象实例。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.executor.statement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.cursor.Cursor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.Executor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.ExecutorException;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.parameter.ParameterHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.BoundSql;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.ResultHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.RowBounds;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoutingStatementHandler</span> <span class="keyword">implements</span> <span class="title">StatementHandler</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StatementHandler delegate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RoutingStatementHandler</span><span class="params">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> </span>{</span><br><span class="line">        <span class="keyword">switch</span>(ms.getStatementType()) {</span><br><span class="line">        <span class="keyword">case</span> STATEMENT:</span><br><span class="line">            <span class="keyword">this</span>.delegate = <span class="keyword">new</span> SimpleStatementHandler(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PREPARED:</span><br><span class="line">            <span class="keyword">this</span>.delegate = <span class="keyword">new</span> PreparedStatementHandler(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CALLABLE:</span><br><span class="line">            <span class="keyword">this</span>.delegate = <span class="keyword">new</span> CallableStatementHandler(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExecutorException(<span class="string">"Unknown statement type: "</span> + ms.getStatementType());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Statement <span class="title">prepare</span><span class="params">(Connection connection, Integer transactionTimeout)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.delegate.prepare(connection, transactionTimeout);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parameterize</span><span class="params">(Statement statement)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">this</span>.delegate.parameterize(statement);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">batch</span><span class="params">(Statement statement)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">this</span>.delegate.batch(statement);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Statement statement)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.delegate.update(statement);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(Statement statement, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.delegate.query(statement, resultHandler);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;E&gt; <span class="function">Cursor&lt;E&gt; <span class="title">queryCursor</span><span class="params">(Statement statement)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.delegate.queryCursor(statement);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BoundSql <span class="title">getBoundSql</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.delegate.getBoundSql();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ParameterHandler <span class="title">getParameterHandler</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.delegate.getParameterHandler();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="ParameterHandler——参数处理器"><a href="#ParameterHandler——参数处理器" class="headerlink" title="ParameterHandler——参数处理器"></a>ParameterHandler——参数处理器</h4><ul>
<li>getParameterObject()方法的作用是返回参数对象</li>
<li>setParameters()方法的作用是设置预编译SQL语句的参数。<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.executor.parameter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ParameterHandler</span> </span>{</span><br><span class="line">    <span class="function">Object <span class="title">getParameterObject</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setParameters</span><span class="params">(PreparedStatement var1)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h4 id="ResultSetHandler——结果处理器"><a href="#ResultSetHandler——结果处理器" class="headerlink" title="ResultSetHandler——结果处理器"></a>ResultSetHandler——结果处理器</h4><ul>
<li>handleOutputParameters()方法是处理存储过程输出参数的。</li>
<li>handleResultSets()是包装结果集的。<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.executor.resultset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.CallableStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.cursor.Cursor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResultSetHandler</span> </span>{</span><br><span class="line">    &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">handleResultSets</span><span class="params">(Statement var1)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    &lt;E&gt; <span class="function">Cursor&lt;E&gt; <span class="title">handleCursorResultSets</span><span class="params">(Statement var1)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleOutputParameters</span><span class="params">(CallableStatement var1)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h3 id="SqlSession运行总结"><a href="#SqlSession运行总结" class="headerlink" title="SqlSession运行总结"></a>SqlSession运行总结</h3><p>SqlSession是通过执行器Executor调度StatementHandler来运行的。<br>而StatementHandler经过3步：</p>
<ul>
<li>prepared预编译SQL</li>
<li>parameterize设置参数</li>
<li>query/update执行SQL</li>
</ul>
<p>其中parameterize是调用parameterHandler的方法设置的，而参数是根据类型处理器typeHandler处理的。query/update方法通过ResultSetHandler进行处理结果的封装，如果是update语句，就返回整数，否则就通过typeHandler处理结果类型，然后用ObjectFactory提供的规则组装对象，返回给调用者。</p>
<blockquote>
<h1 id="插件-1"><a href="#插件-1" class="headerlink" title="插件"></a>插件</h1></blockquote>
<h2 id="插件接口"><a href="#插件接口" class="headerlink" title="插件接口"></a>插件接口</h2><p>在MyBatis中使用插件，就必须实现接口Interceptor</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.plugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Interceptor</span> </span>{</span><br><span class="line">    <span class="function">Object <span class="title">intercept</span><span class="params">(Invocation var1)</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> Object <span class="title">plugin</span><span class="params">(Object target)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target, <span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>{</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>intercept方法：它将直接覆盖拦截对象原有的方法，因此它是插件的核心方法。intercept里面有个参数Invocation对象，通过它可以反射调度原来对象的方法。</li>
<li>plugin方法：target是被拦截对象，它的作用是给被拦截对象生成一个代理对象，并返回它。在MyBatis中，它提供了org.apache.ibatis.plugin.Plugin中的wrap静态方法生成代理对象，一般情况下都会使用它来生成代理对象。</li>
<li>setProperties方法：允许在plugin元素汇总配置所需参数，方法在插件初始化时就被调用了一次，然后把插件对象存入到配置中，以便后面再取出。</li>
</ul>
<h2 id="插件的初始化"><a href="#插件的初始化" class="headerlink" title="插件的初始化"></a>插件的初始化</h2><p>通过XMLConfigBuilder的代码可以发现，在解析配置文件时，在MyBatis的上下文初始化过程中，就开始读入插件节点和配置的参数，同时使用反射技术生成对应的插件实例，然后调用插件方法中的setProperties方法，设置我们配置的参数，将插件实例保存到配置对象中，以便读取和使用它。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pluginElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) {</span><br><span class="line">        Iterator var2 = parent.getChildren().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var2.hasNext()) {</span><br><span class="line">            XNode child = (XNode)var2.next();</span><br><span class="line">            String interceptor = child.getStringAttribute(<span class="string">"interceptor"</span>);</span><br><span class="line">            Properties properties = child.getChildrenAsProperties();</span><br><span class="line">            Interceptor interceptorInstance = (Interceptor)<span class="keyword">this</span>.resolveClass(interceptor).getDeclaredConstructor().newInstance();</span><br><span class="line">            interceptorInstance.setProperties(properties);</span><br><span class="line">            <span class="keyword">this</span>.configuration.addInterceptor(interceptorInstance);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptor</span><span class="params">(Interceptor interceptor)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.interceptorChain.addInterceptor(interceptor);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.plugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorChain</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InterceptorChain</span><span class="params">()</span> </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">pluginAll</span><span class="params">(Object target)</span> </span>{</span><br><span class="line">        Interceptor interceptor;</span><br><span class="line">        <span class="keyword">for</span>(Iterator var2 = <span class="keyword">this</span>.interceptors.iterator(); var2.hasNext(); target = interceptor.plugin(target)) {</span><br><span class="line">            interceptor = (Interceptor)var2.next();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptor</span><span class="params">(Interceptor interceptor)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.interceptors.add(interceptor);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Interceptor&gt; <span class="title">getInterceptors</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableList(<span class="keyword">this</span>.interceptors);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>完成初始化的插件保存在这个List对象里面等待将其取出使用。</p>
<h2 id="插件的代理和反射设计"><a href="#插件的代理和反射设计" class="headerlink" title="插件的代理和反射设计"></a>插件的代理和反射设计</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">executor = (Executor) interceptorChain.pluginAll(executor);</span><br></pre></td></tr></tbody></table></figure>
<p>其通过plugin方法生成代理对象，责任链模式。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">pluginAll</span><span class="params">(Object target)</span> </span>{</span><br><span class="line">    Interceptor interceptor;</span><br><span class="line">    <span class="keyword">for</span>(Iterator var2 = <span class="keyword">this</span>.interceptors.iterator(); var2.hasNext(); target = interceptor.plugin(target)) {</span><br><span class="line">        interceptor = (Interceptor)var2.next();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>自己编写代理类工作量很大，为此MyBatis中提供了一个常用工具类，用来生成代理对象：Plugin</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.plugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ExceptionUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.util.MapUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Plugin</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object target;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Interceptor interceptor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Plugin</span><span class="params">(Object target, Interceptor interceptor, Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">        <span class="keyword">this</span>.interceptor = interceptor;</span><br><span class="line">        <span class="keyword">this</span>.signatureMap = signatureMap;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">wrap</span><span class="params">(Object target, Interceptor interceptor)</span> </span>{</span><br><span class="line">        Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap = getSignatureMap(interceptor);</span><br><span class="line">        Class&lt;?&gt; type = target.getClass();</span><br><span class="line">        Class&lt;?&gt;[] interfaces = getAllInterfaces(type, signatureMap);</span><br><span class="line">        <span class="keyword">return</span> interfaces.length &gt; <span class="number">0</span> ? Proxy.newProxyInstance(type.getClassLoader(), interfaces, <span class="keyword">new</span> Plugin(target, interceptor, signatureMap)) : target;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Set&lt;Method&gt; methods = (Set)<span class="keyword">this</span>.signatureMap.get(method.getDeclaringClass());</span><br><span class="line">            <span class="keyword">return</span> methods != <span class="keyword">null</span> &amp;&amp; methods.contains(method) ? <span class="keyword">this</span>.interceptor.intercept(<span class="keyword">new</span> Invocation(<span class="keyword">this</span>.target, method, args)) : method.invoke(<span class="keyword">this</span>.target, args);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception var5) {</span><br><span class="line">            <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(var5);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; getSignatureMap(Interceptor interceptor) {</span><br><span class="line">        Intercepts interceptsAnnotation = (Intercepts)interceptor.getClass().getAnnotation(Intercepts<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (interceptsAnnotation == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PluginException(<span class="string">"No @Intercepts annotation was found in interceptor "</span> + interceptor.getClass().getName());</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            Signature[] sigs = interceptsAnnotation.value();</span><br><span class="line">            Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">            Signature[] var4 = sigs;</span><br><span class="line">            <span class="keyword">int</span> var5 = sigs.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var6 = <span class="number">0</span>; var6 &lt; var5; ++var6) {</span><br><span class="line">                Signature sig = var4[var6];</span><br><span class="line">                Set methods = (Set)MapUtil.computeIfAbsent(signatureMap, sig.type(), (k) -&gt; {</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> HashSet();</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    Method method = sig.type().getMethod(sig.method(), sig.args());</span><br><span class="line">                    methods.add(method);</span><br><span class="line">                } <span class="keyword">catch</span> (NoSuchMethodException var10) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PluginException(<span class="string">"Could not find method on "</span> + sig.type() + <span class="string">" named "</span> + sig.method() + <span class="string">". Cause: "</span> + var10, var10);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> signatureMap;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt;[] getAllInterfaces(Class&lt;?&gt; type, Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap) {</span><br><span class="line">        HashSet interfaces;</span><br><span class="line">        <span class="keyword">for</span>(interfaces = <span class="keyword">new</span> HashSet(); type != <span class="keyword">null</span>; type = type.getSuperclass()) {</span><br><span class="line">            Class[] var3 = type.getInterfaces();</span><br><span class="line">            <span class="keyword">int</span> var4 = var3.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var5 = <span class="number">0</span>; var5 &lt; var4; ++var5) {</span><br><span class="line">                Class&lt;?&gt; c = var3[var5];</span><br><span class="line">                <span class="keyword">if</span> (signatureMap.containsKey(c)) {</span><br><span class="line">                    interfaces.add(c);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (Class[])interfaces.toArray(<span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果使用这个类为插件生成代理对象，那么代理对象在调用方法时就会进入到invoke方法中。在invoke方法中，如果存在签名的拦截方法，插件的intercept方法就会在这里调用，然后返回结果。如果不存在签名方法，那么将直接反射调度要执行的方法。</p>
<p>MyBatis把被代理对象、反射方法及其参数，都传递给了Invocation类的构造方法，用以生成一个Invocation类对象，其有一个proceed()方法。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.plugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Invocation</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object target;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Method method;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] args;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Invocation</span><span class="params">(Object target, Method method, Object[] args)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">        <span class="keyword">this</span>.method = method;</span><br><span class="line">        <span class="keyword">this</span>.args = args;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getTarget</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.target;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Method <span class="title">getMethod</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.method;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object[] getArgs() {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.args;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.method.invoke(<span class="keyword">this</span>.target, <span class="keyword">this</span>.args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果有多个插件，那么通过wrap产生多层包装的代理对象。</p>
<h2 id="常见工具类——MetaObject"><a href="#常见工具类——MetaObject" class="headerlink" title="常见工具类——MetaObject"></a>常见工具类——MetaObject</h2><p>MetaObject可以有效读取或者修改一些重要对象的属性。在MyBatis中，四大对象提供的public设置参数的方法很少难以通过其自身得到相关的属性信息，但是有了MetaObject这个工具类就可以通过其他的技术手段来读取或者修改这些重要对象的属性。</p>
<p>MetaObject有3个方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用于包装对象，不再使用，用SystemMetaObject.froObject(Object obj)替换</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MetaObject <span class="title">forObject</span><span class="params">(Object object, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory, ReflectorFactory reflectorFactory)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> object == <span class="keyword">null</span> ? SystemMetaObject.NULL_META_OBJECT : <span class="keyword">new</span> MetaObject(object, objectFactory, objectWrapperFactory, reflectorFactory);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//用于获取对象属性值，支持OGNL</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">(String name)</span> </span>{</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) {</span><br><span class="line">        MetaObject metaValue = <span class="keyword">this</span>.metaObjectForProperty(prop.getIndexedName());</span><br><span class="line">        <span class="keyword">return</span> metaValue == SystemMetaObject.NULL_META_OBJECT ? <span class="keyword">null</span> : metaValue.getValue(prop.getChildren());</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.objectWrapper.get(prop);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//用于修改对象属性值，支持OGNL</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(String name, Object value)</span> </span>{</span><br><span class="line">    PropertyTokenizer prop = <span class="keyword">new</span> PropertyTokenizer(name);</span><br><span class="line">    <span class="keyword">if</span> (prop.hasNext()) {</span><br><span class="line">        MetaObject metaValue = <span class="keyword">this</span>.metaObjectForProperty(prop.getIndexedName());</span><br><span class="line">        <span class="keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) {</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            metaValue = <span class="keyword">this</span>.objectWrapper.instantiatePropertyValue(name, prop, <span class="keyword">this</span>.objectFactory);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        metaValue.setValue(prop.getChildren(), value);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">this</span>.objectWrapper.set(prop, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">StatementHandler statementHandler = (StatementHandler) invocation.getTarget();</span><br><span class="line">MetaObject metaStatementHandler = SystemMetaObject.forObject(statementHandler);</span><br><span class="line"><span class="comment">//进行绑定</span></span><br><span class="line"><span class="comment">//分离代理对象链（由于目标类可能被多个插件拦截，从而形成多次代理，通过循环可以分离出最原始的目标类）</span></span><br><span class="line"><span class="keyword">while</span>(metaStatementHandler.hasGetter(<span class="string">"h"</span>)){</span><br><span class="line">    Object object = metaStatementHandler.getValue(<span class="string">"h"</span>);</span><br><span class="line">    metaStatementHandler = SystemMetaObject.forObject(object);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取当前调用的SQL</span></span><br><span class="line">String sql = (String) metaStatementHandler.getValue(<span class="string">"delegate.boundSql.sql"</span>);</span><br><span class="line"><span class="comment">//判断SQL是否是select语句，如果不是select语句，则不需要处理</span></span><br><span class="line"><span class="comment">//如果是，则修改它，最多返回1000行，这里用的是MySQL数据库，其他数据库要改写成其他的</span></span><br><span class="line"><span class="keyword">if</span>(sql != <span class="keyword">null</span> &amp;&amp; sql.toLowerCase().trim().indexOf(<span class="string">"select"</span>) == <span class="number">0</span>){</span><br><span class="line">    <span class="comment">//通过SQL重写来实现，这里我们起了一个奇怪的别名，避免与表名重复</span></span><br><span class="line">    sql = <span class="string">"select * from ("</span> + sql + <span class="string">") $_$limit_$table_ limit 1000"</span>;</span><br><span class="line">    metaStatementHandler.setValue(<span class="string">"delegate.boundSql.sql"</span>, sql);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="确定需要拦截的签名"><a href="#确定需要拦截的签名" class="headerlink" title="确定需要拦截的签名"></a>确定需要拦截的签名</h3><p>MyBatis允许拦截四大对象中的任意一个对象，而通过Plugin源码，我们也看到了需要先注册签名才能使用插件，因此首先要确定需要拦截的对象，才能进一步确定需要配置什么样的签名，进而完成拦截的方法逻辑。</p>
<p>1、确定需要拦截的对象</p>
<ul>
<li>Executor是执行SQL的全过程，包括组装参数、组装结果集返回和执行SQL过程，都可以拦截，较为广泛，一般用的不算太多。根据是否启动缓存参数，决定它是否使用CachingExecutor进行封装。</li>
<li>StatementHandler是执行SQL的过程，我们可以重写执行SQL的过程，它是最常用的拦截对象。</li>
<li>ParameterHandler主要拦截执行SQL的参数组装，我们可以重写组装参数规则。</li>
<li>ResultSetHandler用于拦截执行结果的组装，我们可以重写组装结果的规则。</li>
</ul>
<p>2、拦截方法和参数<br>当确定了需要拦截什么对象，接下来就要确定需要拦截什么方法及方法的参数，这些都是在理解了MyBatis四大对象运作的基础上才确定的。<br>查询的过程是通过Executor调度StatementHandler来完成的。调度StatementHandler的prepare方法预编译SQL，于是要拦截的方法便是prepare方法，在此之前完成SQL的重新编写。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.executor.statement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.cursor.Cursor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.parameter.ParameterHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.BoundSql;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.ResultHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StatementHandler</span> </span>{</span><br><span class="line">    <span class="function">Statement <span class="title">prepare</span><span class="params">(Connection var1, Integer var2)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">parameterize</span><span class="params">(Statement var1)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">batch</span><span class="params">(Statement var1)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(Statement var1)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(Statement var1, ResultHandler var2)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    &lt;E&gt; <span class="function">Cursor&lt;E&gt; <span class="title">queryCursor</span><span class="params">(Statement var1)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">BoundSql <span class="title">getBoundSql</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ParameterHandler <span class="title">getParameterHandler</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>以上的任何方法都可以拦截</p>
<h3 id="设计拦截器"><a href="#设计拦截器" class="headerlink" title="设计拦截器"></a>设计拦截器</h3><ul>
<li>@Intercepts说明它是一个拦截器</li>
<li>@Signature是注册拦截器签名的地方，只有签名满足条件才能拦截</li>
<li>type可以是四大对象中的一个，这里是StatementHandler</li>
<li>method代表要拦截四大对象的某一种接口方法，而args<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Intercepts</span>({</span><br><span class="line">        <span class="meta">@Signature</span>(type=StatementHandler<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">        <span class="title">method</span> </span>= <span class="string">"prepare"</span>,</span><br><span class="line">        args = {Connection<span class="class">.<span class="keyword">class</span>, <span class="title">Integer</span>.<span class="title">class</span>})})</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">MyPlugin</span> <span class="keyword">implements</span> <span class="title">Interceptor</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h3 id="实现拦截方法"><a href="#实现拦截方法" class="headerlink" title="实现拦截方法"></a>实现拦截方法</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.statement.StatementHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.MetaObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.SystemMetaObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Intercepts</span>({</span><br><span class="line">        <span class="meta">@Signature</span>(type= StatementHandler<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">                <span class="title">method</span> </span>= <span class="string">"prepare"</span>,</span><br><span class="line">                args = {Connection<span class="class">.<span class="keyword">class</span>, <span class="title">Integer</span>.<span class="title">class</span>})})</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">MyPlugin</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> Logger logger = Logger.getLogger(MyPlugin<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">private</span> Properties properties = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插件方法，它将代替StatementHandler的prepare方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> invocation 入参</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回预编译后的PreparedStatement</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        StatementHandler statementHandler = (StatementHandler) invocation.getTarget();</span><br><span class="line">        <span class="comment">//进行绑定</span></span><br><span class="line">        MetaObject metaStatementHandler = SystemMetaObject.forObject(statementHandler);</span><br><span class="line">        Object object = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        分离代理对象链，由于目标类可能被多个拦截器（插件）拦截，</span></span><br><span class="line"><span class="comment">        从而形成多次代理，通过循环可以分离出最原始的目标类</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">while</span>(metaStatementHandler.hasGetter(<span class="string">"h"</span>)){</span><br><span class="line">            object = metaStatementHandler.getValue(<span class="string">"h"</span>);</span><br><span class="line">            metaStatementHandler = SystemMetaObject.forObject(object);</span><br><span class="line">        }</span><br><span class="line">        statementHandler = (StatementHandler) object;</span><br><span class="line">        String sql = (String) metaStatementHandler.getValue(<span class="string">"delegate.boundSql.sql"</span>);</span><br><span class="line">        Long parameterObject = (Long) metaStatementHandler.getValue(<span class="string">"delegate.boundSql.parameterObject"</span>);</span><br><span class="line">        logger.info(<span class="string">"执行的SQL：【"</span> + sql + <span class="string">"】"</span>);</span><br><span class="line">        logger.info(<span class="string">"参数：【"</span> + parameterObject + <span class="string">"】"</span>);</span><br><span class="line">        logger.info(<span class="string">"before ......"</span>);</span><br><span class="line">        <span class="comment">//如果当前代理的是一个非代理对象，那么它就回调用真实拦截对象的方法</span></span><br><span class="line">        <span class="comment">//如果不是，那么它会调度下个插件代理对象的invoke方法</span></span><br><span class="line">        Object obj = invocation.proceed();</span><br><span class="line">        logger.info(<span class="string">"after ......"</span>);</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产代理对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target 被代理的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 代理对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">plugin</span><span class="params">(Object target)</span> </span>{</span><br><span class="line">        <span class="comment">//采用系统默认的Plugin.wrap方法生成</span></span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target, <span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.properties = properties;</span><br><span class="line">        logger.info(<span class="string">"dbType = "</span> + <span class="keyword">this</span>.properties.get(<span class="string">"dbType"</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>MyBatis的配置文件配置plugins元素，注意其配置顺序。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"mybatis.MyPlugin"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dbType"</span> <span class="attr">value</span>=<span class="string">"mysql"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>运行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=55183:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">11</span>,<span class="number">638</span> mybatis.MyPlugin: dbType = mysql</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">11</span>,<span class="number">713</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">11</span>,<span class="number">726</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">11</span>,<span class="number">726</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">11</span>,<span class="number">727</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">11</span>,<span class="number">727</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">11</span>,<span class="number">996</span> mybatis.RoleMapper: Cache Hit Ratio [mybatis.RoleMapper]: <span class="number">0.0</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">12</span>,<span class="number">000</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">134</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">1163619825</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">134</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">455</span>b6df1]</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">138</span> mybatis.MyPlugin: 执行的SQL：【select id, role_name as roleName, note note from t_role where id = ?】</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">138</span> mybatis.MyPlugin: 参数：【<span class="number">1</span>】</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">138</span> mybatis.MyPlugin: before ......</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">138</span> mybatis.RoleMapper.getRole: ==&gt;  Preparing: select id, role_name as roleName, note note from t_role where id = ?</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">199</span> mybatis.MyPlugin: after ......</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">200</span> mybatis.RoleMapper.getRole: ==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">281</span> mybatis.RoleMapper.getRole: &lt;==      Total: <span class="number">1</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">282</span> mybatis.SqlSessionFactoryUtils: John</span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">282</span> mybatis.SqlSessionFactoryUtils: Hello World!</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">286</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">455</span>b6df1]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">287</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">455</span>b6df1]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">10</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">14</span>,<span class="number">287</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">1163619825</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="插件实例——分页插件"><a href="#插件实例——分页插件" class="headerlink" title="插件实例——分页插件"></a>插件实例——分页插件</h3><p>MyBatis中存在一个RowBounds用于分页，但是它是基于第一次查询结果的再分页，也就是先让SQL查询出所有的记录，然后分页，显然性能不高。</p>
<p>启动分页参数(PageParams)需要满足下列条件之一：</p>
<ul>
<li>传递单个PageParams或者其子对象</li>
<li>map中存在一个值为PageParams或者其子对象</li>
<li>在MyBatis中传递多个参数，但其中之一为PageParams或者其子对象</li>
<li>传递单个POJO参数，这个POJO有一个属性为PageParams或者其子对象，且提供了setter和getter方法。</li>
</ul>
<h4 id="自定义PageParamsCustom类"><a href="#自定义PageParamsCustom类" class="headerlink" title="自定义PageParamsCustom类"></a>自定义PageParamsCustom类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageParamsCustom</span> </span>{</span><br><span class="line">    <span class="comment">//当前页码</span></span><br><span class="line">    <span class="keyword">private</span> Integer page;</span><br><span class="line">    <span class="comment">//每页限制条数</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageSize;</span><br><span class="line">    <span class="comment">//是否启动插件，如果不启动，则不作分页</span></span><br><span class="line">    <span class="keyword">private</span> Boolean useFlag;</span><br><span class="line">    <span class="comment">//是否检测页码的有效性，如果为true，而页码大于最大页数，则抛出异常</span></span><br><span class="line">    <span class="keyword">private</span> Boolean checkFlag;</span><br><span class="line">    <span class="comment">//是否清楚最后order by后面的语句</span></span><br><span class="line">    <span class="keyword">private</span> Boolean cleanOrderBy;</span><br><span class="line">    <span class="comment">//总条数，插件会回填这个值</span></span><br><span class="line">    <span class="keyword">private</span> Integer total;</span><br><span class="line">    <span class="comment">//总页数，插件会回填这个值</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalPage;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCheckFlag</span><span class="params">(Boolean checkFlag)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.checkFlag = checkFlag;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCleanOrderBy</span><span class="params">(Boolean cleanOrderBy)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.cleanOrderBy = cleanOrderBy;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPage</span><span class="params">(Integer page)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.page = page;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPageSize</span><span class="params">(Integer pageSize)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.pageSize = pageSize;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotal</span><span class="params">(Integer total)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.total = total;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotalPage</span><span class="params">(Integer totalPage)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.totalPage = totalPage;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUseFlag</span><span class="params">(Boolean useFlag)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.useFlag = useFlag;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">getCheckFlag</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> checkFlag;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">getCleanOrderBy</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> cleanOrderBy;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">getUseFlag</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> useFlag;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getPage</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getPageSize</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> pageSize;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getTotal</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getTotalPage</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> totalPage;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="自定义PagePlugin类"><a href="#自定义PagePlugin类" class="headerlink" title="自定义PagePlugin类"></a>自定义PagePlugin类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mybatis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.ExecutorException;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.parameter.ParameterHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.executor.statement.StatementHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.BoundSql;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.plugin.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.MetaObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.SystemMetaObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.scripting.defaults.DefaultParameterHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.plaf.nimbus.State;</span><br><span class="line"><span class="keyword">import</span> java.beans.PropertyDescriptor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Intercepts</span>({</span><br><span class="line">        <span class="meta">@Signature</span>(</span><br><span class="line">                type = StatementHandler<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">                <span class="title">method</span> </span>= <span class="string">"prepare"</span>,</span><br><span class="line">                args = {Connection<span class="class">.<span class="keyword">class</span>, <span class="title">Integer</span>.<span class="title">class</span>}</span></span><br><span class="line"><span class="class">        )</span></span><br><span class="line"><span class="class">})</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">PagePlugin</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插件默认参数，可配置默认值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer defaultPage; <span class="comment">//默认页码</span></span><br><span class="line">    <span class="keyword">private</span> Integer defaultPageSize; <span class="comment">//默认每页条数</span></span><br><span class="line">    <span class="keyword">private</span> Boolean defaultUseFlag; <span class="comment">//默认是否启用插件</span></span><br><span class="line">    <span class="keyword">private</span> Boolean defaultCheckFlag; <span class="comment">//默认是否检测页码参数</span></span><br><span class="line">    <span class="keyword">private</span> Boolean defaultCleanOrderBy; <span class="comment">//默认是否清楚最后一个order by后的语句</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        StatementHandler statementHandler = (StatementHandler) getUnProxyObject(invocation.getTarget());</span><br><span class="line">        MetaObject metaStatementHandler = SystemMetaObject.forObject(statementHandler);</span><br><span class="line">        String sql = (String) metaStatementHandler.getValue(<span class="string">"delegate.boundSql.sql"</span>);</span><br><span class="line">        MappedStatement mappedStatement = (MappedStatement) metaStatementHandler.getValue(<span class="string">"delegate.mappedStatement"</span>);</span><br><span class="line">        <span class="comment">//不是select语句</span></span><br><span class="line">        <span class="keyword">if</span>(!checkSelect(sql)) <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        BoundSql boundSql = (BoundSql) metaStatementHandler.getValue(<span class="string">"delegate.boundSql"</span>);</span><br><span class="line">        Object parameterObject = boundSql.getParameterObject();</span><br><span class="line">        PageParamsCustom pageParamsCustom = getPageParamsForParamObj(parameterObject);</span><br><span class="line">        <span class="keyword">if</span>(pageParamsCustom == <span class="keyword">null</span>){</span><br><span class="line">            <span class="comment">//无法获取分页参数，不进行分页</span></span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//获取配置中是否启用分页功能</span></span><br><span class="line">        Boolean useFlag = pageParamsCustom.getUseFlag() == <span class="keyword">null</span> ? <span class="keyword">this</span>.defaultUseFlag : pageParamsCustom.getUseFlag();</span><br><span class="line">        <span class="keyword">if</span>(!useFlag){</span><br><span class="line">            <span class="comment">//不使用分页插件</span></span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//获取相关配置的参数</span></span><br><span class="line">        Integer pageNum = pageParamsCustom.getPage() == <span class="keyword">null</span> ? defaultPage : pageParamsCustom.getPage();</span><br><span class="line">        Integer pageSize = pageParamsCustom.getPageSize() == <span class="keyword">null</span> ? defaultPageSize : pageParamsCustom.getPageSize();</span><br><span class="line">        Boolean checkFlag = pageParamsCustom.getCheckFlag() == <span class="keyword">null</span> ? defaultCheckFlag : pageParamsCustom.getCheckFlag();</span><br><span class="line">        Boolean cleanOrderBy = pageParamsCustom.getCleanOrderBy() == <span class="keyword">null</span> ? defaultCleanOrderBy : pageParamsCustom.getCleanOrderBy();</span><br><span class="line">        <span class="comment">//计算总条数</span></span><br><span class="line">        <span class="keyword">int</span> total = getTotal(invocation, metaStatementHandler, boundSql, cleanOrderBy);</span><br><span class="line">        <span class="comment">//回填总条数到分页参数</span></span><br><span class="line">        pageParamsCustom.setTotal(total);</span><br><span class="line">        <span class="comment">//计算总页数</span></span><br><span class="line">        <span class="keyword">int</span> totalPage = total % pageSize == <span class="number">0</span> ? total / pageSize : total / pageSize + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//回填总页数到分页参数</span></span><br><span class="line">        pageParamsCustom.setTotalPage(totalPage);</span><br><span class="line">        <span class="comment">//检查当前页码的有效性</span></span><br><span class="line">        checkPage(checkFlag, pageNum, totalPage);</span><br><span class="line">        <span class="comment">//修改sql</span></span><br><span class="line">        <span class="keyword">return</span> preparedSQL(invocation, metaStatementHandler, boundSql, pageNum, pageSize);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">plugin</span><span class="params">(Object target)</span> </span>{</span><br><span class="line">        <span class="comment">//生成代理对象</span></span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target, <span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>{</span><br><span class="line">        <span class="comment">//从配置中获取参数</span></span><br><span class="line">        String strDefaultPage = properties.getProperty(<span class="string">"default.page"</span>, <span class="string">"1"</span>);</span><br><span class="line">        String strDefaultPageSize = properties.getProperty(<span class="string">"default.pageSize"</span>, <span class="string">"50"</span>);</span><br><span class="line">        String strDefaultUseFlag = properties.getProperty(<span class="string">"default.useFlag"</span>, <span class="string">"false"</span>);</span><br><span class="line">        String strDefaultCheckFlag = properties.getProperty(<span class="string">"default.checkFlag"</span>, <span class="string">"false"</span>);</span><br><span class="line">        String strDefaultCleanOrderBy = properties.getProperty(<span class="string">"default.cleanOrderBy"</span>, <span class="string">"false"</span>);</span><br><span class="line">        <span class="comment">//设置默认参数</span></span><br><span class="line">        <span class="keyword">this</span>.defaultPage = Integer.parseInt(strDefaultPage);</span><br><span class="line">        <span class="keyword">this</span>.defaultPageSize = Integer.parseInt(strDefaultPageSize);</span><br><span class="line">        <span class="keyword">this</span>.defaultUseFlag = Boolean.parseBoolean(strDefaultUseFlag);</span><br><span class="line">        <span class="keyword">this</span>.defaultCheckFlag = Boolean.parseBoolean(strDefaultCheckFlag);</span><br><span class="line">        <span class="keyword">this</span>.defaultCleanOrderBy = Boolean.parseBoolean(strDefaultCleanOrderBy);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从代理对象中分离出真实对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target invocation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 非代理StatementHandler对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">getUnProxyObject</span><span class="params">(Object target)</span> </span>{</span><br><span class="line">        MetaObject metaStatementHandler = SystemMetaObject.forObject(target);</span><br><span class="line">        <span class="comment">//分离代理对象链（由于目标类可能被多个拦截器拦截，从而形成多次代理，通过循环可以分离出最原始的目标类</span></span><br><span class="line">        Object object = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> (metaStatementHandler.hasGetter(<span class="string">"h"</span>)) {</span><br><span class="line">            object = metaStatementHandler.getValue(<span class="string">"h"</span>);</span><br><span class="line">            metaStatementHandler = SystemMetaObject.forObject(object);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (object == <span class="keyword">null</span>) <span class="keyword">return</span> target;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否sql语句</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sql 当前执行的SQL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否查询语句</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkSelect</span><span class="params">(String sql)</span> </span>{</span><br><span class="line">        String trimSql = sql.trim();</span><br><span class="line">        <span class="keyword">int</span> idx = trimSql.toLowerCase().indexOf(<span class="string">"select"</span>);</span><br><span class="line">        <span class="keyword">return</span> idx == <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PageParamsCustom <span class="title">getPageParamsForParamObj</span><span class="params">(Object parameterObject)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        PageParamsCustom pageParams = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (parameterObject == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//处理map参数，多个匿名参数和@Param注解参数，都是map</span></span><br><span class="line">        <span class="keyword">if</span> (parameterObject <span class="keyword">instanceof</span> Map) {</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) Map&lt;String, Object&gt; paramMap = (Map&lt;String, Object&gt;) parameterObject;</span><br><span class="line">            Set&lt;String&gt; keySet = paramMap.keySet();</span><br><span class="line">            Iterator&lt;String&gt; iterator = keySet.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">                String key = iterator.next();</span><br><span class="line">                Object value = paramMap.get(key);</span><br><span class="line">                <span class="keyword">if</span> (value <span class="keyword">instanceof</span> PageParamsCustom) <span class="keyword">return</span> (PageParamsCustom) value;</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (parameterObject <span class="keyword">instanceof</span> PageParamsCustom) {</span><br><span class="line">            <span class="comment">//参数是或者继承PageParamsCustom</span></span><br><span class="line">            <span class="keyword">return</span> (PageParamsCustom) parameterObject;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">//从POJO属性尝试读取分页参数</span></span><br><span class="line">            Field[] fields = parameterObject.getClass().getDeclaredFields();</span><br><span class="line">            <span class="comment">//尝试从POJO中获得类型为PageParamsCustom的属性</span></span><br><span class="line">            <span class="keyword">for</span> (Field field : fields) {</span><br><span class="line">                <span class="keyword">if</span> (field.getType() == PageParamsCustom<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">                    PropertyDescriptor propertyDescriptor = <span class="keyword">new</span> PropertyDescriptor(field.getName(), parameterObject.getClass());</span><br><span class="line">                    Method method = propertyDescriptor.getReadMethod();</span><br><span class="line">                    <span class="keyword">return</span> (PageParamsCustom) method.invoke(parameterObject);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> pageParams;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getTotal</span><span class="params">(Invocation invocation, MetaObject metaStatementHandler, BoundSql boundSql, Boolean cleanOrderBy)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        <span class="comment">//获取当前的mappedStatement</span></span><br><span class="line">        MappedStatement mappedStatement = (MappedStatement) metaStatementHandler.getValue(<span class="string">"delegate.mappedStatement"</span>);</span><br><span class="line">        <span class="comment">//配置对象</span></span><br><span class="line">        Configuration configuration = mappedStatement.getConfiguration();</span><br><span class="line">        <span class="comment">//当前需要执行的SQL</span></span><br><span class="line">        String sql = (String) metaStatementHandler.getValue(<span class="string">"delegate.boundSql.sql"</span>);</span><br><span class="line">        <span class="comment">//去掉最后的order by语句</span></span><br><span class="line">        <span class="keyword">if</span> (cleanOrderBy) sql = <span class="keyword">this</span>.cleanOrderByForSql(sql);</span><br><span class="line">        <span class="comment">//改写为统计总数的SQL</span></span><br><span class="line">        String countSql = <span class="string">"select count(*) as total from ("</span> + sql + <span class="string">") $_paging"</span>;</span><br><span class="line">        <span class="comment">//获取拦截方法参数，根据插件签名，知道是Connection对象</span></span><br><span class="line">        Connection connection = (Connection) invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> total = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//预编译统计总数SQL</span></span><br><span class="line">            preparedStatement = connection.prepareStatement(countSql);</span><br><span class="line">            <span class="comment">//构建统计总数BoundSql</span></span><br><span class="line">            BoundSql countBoundSql = <span class="keyword">new</span> BoundSql(configuration, countSql, boundSql.getParameterMappings(),</span><br><span class="line">                    boundSql.getParameterObject());</span><br><span class="line">            <span class="comment">//构建MyBatis的ParameterHandler用来设置总数Sql的参数</span></span><br><span class="line">            ParameterHandler handler = <span class="keyword">new</span> DefaultParameterHandler(mappedStatement, boundSql.getParameterObject(), countBoundSql);</span><br><span class="line">            <span class="comment">//设置总数SQL参数</span></span><br><span class="line">            handler.setParameters(preparedStatement);</span><br><span class="line">            <span class="comment">//执行查询</span></span><br><span class="line">            ResultSet resultSet = preparedStatement.executeQuery();</span><br><span class="line">            <span class="keyword">while</span> (resultSet.next()) total = resultSet.getInt(<span class="string">"total"</span>);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="comment">//这里不能关闭Connection，否则后续的SQL就没法继续了</span></span><br><span class="line">            <span class="keyword">if</span> (preparedStatement != <span class="keyword">null</span>) preparedStatement.close();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">cleanOrderByForSql</span><span class="params">(String sql)</span> </span>{</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder(sql);</span><br><span class="line">        String newSql = sql.toLowerCase();</span><br><span class="line">        <span class="comment">//如果没有order语句，则直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (!newSql.contains(<span class="string">"order"</span>)) <span class="keyword">return</span> sql;</span><br><span class="line">        <span class="keyword">int</span> idx = newSql.lastIndexOf(<span class="string">"order"</span>);</span><br><span class="line">        <span class="keyword">return</span> stringBuilder.substring(<span class="number">0</span>, idx).toString();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkPage</span><span class="params">(Boolean checkFlag, Integer pageNum, Integer pageTotal)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        <span class="keyword">if</span> (checkFlag) {</span><br><span class="line">            <span class="comment">//检查页码page是否合法</span></span><br><span class="line">            <span class="keyword">if</span> (pageNum &gt; pageTotal) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"查询失败，查询页码【"</span> + pageNum + <span class="string">"】大于总页数【"</span> + pageTotal + <span class="string">"】!!"</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">preparedSQL</span><span class="params">(Invocation invocation, MetaObject metaStatementHandler, BoundSql boundSql, <span class="keyword">int</span> pageNum, <span class="keyword">int</span> pageSize)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">//获取当前需要执行的SQL</span></span><br><span class="line">        String sql = boundSql.getSql();</span><br><span class="line">        String newSql = <span class="string">"select * from ("</span> + sql + <span class="string">") $_paging_table limit ?,?"</span>;</span><br><span class="line">        <span class="comment">//修改当前需要执行的SQL</span></span><br><span class="line">        metaStatementHandler.setValue(<span class="string">"delegate.boundSql.sql"</span>, newSql);</span><br><span class="line">        <span class="comment">//执行编译，相当于StatementHandler执行了prepared()方法，这个时候，就剩下两个分页参数没有设置</span></span><br><span class="line">        Object statementObj = invocation.proceed();</span><br><span class="line">        <span class="comment">//设置两个分页参数</span></span><br><span class="line">        <span class="keyword">this</span>.preparePageDataParams((PreparedStatement) statementObj, pageNum, pageSize);</span><br><span class="line">        <span class="keyword">return</span> statementObj;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">preparePageDataParams</span><span class="params">(PreparedStatement preparedStatement, <span class="keyword">int</span> pageNum, <span class="keyword">int</span> pageSize)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">//prepared()方法编译SQL，由于MyBatis上下文没有分页参数的信息，所以这里需要设置这两个参数</span></span><br><span class="line">        <span class="comment">//获取需要设置的参数个数，由于参数是最后的两个，所以很容易得到其位置</span></span><br><span class="line">        <span class="keyword">int</span> idx = preparedStatement.getParameterMetaData().getParameterCount();</span><br><span class="line">        <span class="comment">//最后两个是分页参数</span></span><br><span class="line">        preparedStatement.setInt(idx - <span class="number">1</span>, (pageNum - <span class="number">1</span>) * pageSize); <span class="comment">//开始行</span></span><br><span class="line">        preparedStatement.setInt(idx, pageSize); <span class="comment">//限制条数</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="mapper设置以及启动程序"><a href="#mapper设置以及启动程序" class="headerlink" title="mapper设置以及启动程序"></a>mapper设置以及启动程序</h4><p>配置文件设置</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"mybatis.PagePlugin"</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!--默认页码--&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default.page"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">          <span class="comment">&lt;!--默认每页条数--&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default.pageSize"</span> <span class="attr">value</span>=<span class="string">"20"</span>/&gt;</span></span><br><span class="line">          <span class="comment">&lt;!--默认每页条数--&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default.useFlag"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">          <span class="comment">&lt;!--是否检查页码有效性，如果非有效，则抛出异常--&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default.checkFlag"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">          <span class="comment">&lt;!--针对哪些含有order by的SQL，是否去掉最后一个order by以后的SQL语句，提高性能--&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default.cleanOrderBy"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Logger logger = Logger.getLogger(SqlSessionFactoryUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">SqlSession sqlSession1 = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    sqlSession = SqlSessionFactoryUtils.openSqlSession();</span><br><span class="line">    RoleMapper roleMapper = sqlSession.getMapper(RoleMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    PageParamsCustom pageParams = <span class="keyword">new</span> PageParamsCustom();</span><br><span class="line">    pageParams.setPageSize(<span class="number">10</span>);</span><br><span class="line">    List&lt;Role&gt; roleList = roleMapper.findRoles(pageParams, <span class="string">"John"</span>);</span><br><span class="line">    logger.info(roleList.size());</span><br><span class="line">} <span class="keyword">catch</span> (Exception e){</span><br><span class="line">    logger.info(e.getMessage(), e);</span><br><span class="line">    sqlSession.rollback();</span><br><span class="line">}<span class="keyword">finally</span> {</span><br><span class="line">    <span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>) sqlSession.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="运行结果-4"><a href="#运行结果-4" class="headerlink" title="运行结果"></a>运行结果</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=49924:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\JavaTest\out\production\JavaTest;D:\download\cglib-nodep-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\fastjson-<span class="number">1.2</span><span class="number">.76</span>.jar;D:\download\commons-lang3-<span class="number">3.12</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\mybatis-<span class="number">3.5</span><span class="number">.7</span>.jar;D:\download\mysql-connector-java-<span class="number">8.0</span><span class="number">.19</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\asm-<span class="number">7.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\cglib-<span class="number">3.3</span><span class="number">.0</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\ognl-<span class="number">3.2</span><span class="number">.20</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-<span class="number">1.2</span><span class="number">.17</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-api-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\log4j-core-<span class="number">2.14</span><span class="number">.1</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\commons-logging-<span class="number">1.2</span>.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\javassist-<span class="number">3.27</span><span class="number">.0</span>-GA.jar;D:\download\mybatis-<span class="number">3.5</span><span class="number">.7</span>\lib\slf4j-log4j12-<span class="number">1.7</span><span class="number">.30</span>.jar;D:\download\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.9</span><span class="number">.0</span>.jar mybatis.SqlSessionFactoryUtils</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">357</span> org.apache.ibatis.logging.LogFactory: Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">373</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">373</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">373</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">373</span> org.apache.ibatis.datasource.pooled.PooledDataSource: PooledDataSource forcefully closed/removed all connections.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">467</span> mybatis.RoleMapper: Cache Hit Ratio [mybatis.RoleMapper]: <span class="number">0.0</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">471</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Opening JDBC Connection</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">832</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Created connection <span class="number">1508181426</span>.</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">832</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Setting autocommit to <span class="keyword">false</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">59e505</span>b2]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">836</span> mybatis.RoleMapper.findRoles: ==&gt;  Preparing: <span class="function">select <span class="title">count</span><span class="params">(*)</span> as total <span class="title">from</span> <span class="params">(select id, role_name as roleName, note from t_role where role_name like concat(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span>) $_paging</span></span><br><span class="line"><span class="function">DEBUG 2021-09-11 21:22:16,863 mybatis.RoleMapper.findRoles: </span>==&gt; Parameters: John(String)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">946</span> mybatis.RoleMapper.findRoles: &lt;==      Total: <span class="number">1</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">947</span> mybatis.RoleMapper.findRoles: ==&gt;  Preparing: select * from (select id, role_name as roleName, <span class="function">note from t_role where role_name like <span class="title">concat</span><span class="params">(<span class="string">'%'</span>, ?, <span class="string">'%'</span>)</span>) $_paging_table limit ?,?</span></span><br><span class="line"><span class="function">DEBUG 2021-09-11 21:22:16,948 mybatis.RoleMapper.findRoles: </span>==&gt; Parameters: <span class="number">0</span>(Integer), <span class="number">10</span>(Integer), John(String)</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">952</span> mybatis.RoleMapper.findRoles: &lt;==      Total: <span class="number">2</span></span><br><span class="line"> INFO <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">952</span> mybatis.SqlSessionFactoryUtils: <span class="number">2</span></span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">957</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Resetting autocommit to <span class="keyword">true</span> on JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">59e505</span>b2]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">958</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction: Closing JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@<span class="number">59e505</span>b2]</span><br><span class="line">DEBUG <span class="number">2021</span>-<span class="number">09</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">958</span> org.apache.ibatis.datasource.pooled.PooledDataSource: Returned connection <span class="number">1508181426</span> to pool.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="Spring-基础"><a href="#Spring-基础" class="headerlink" title="Spring 基础"></a>Spring 基础</h1></blockquote>
<blockquote>
<h1 id="Spring-IoC概述"><a href="#Spring-IoC概述" class="headerlink" title="Spring IoC概述"></a>Spring IoC概述</h1></blockquote>
<p>IoC：Inverse of Control 控制反转</p>
<h2 id="Spring-IoC容器"><a href="#Spring-IoC容器" class="headerlink" title="Spring IoC容器"></a>Spring IoC容器</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.beans.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.ResolvableType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanFactory</span> </span>{</span><br><span class="line">    String FACTORY_BEAN_PREFIX = <span class="string">"&amp;"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">getBean</span><span class="params">(String var1)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(String var1, Class&lt;T&gt; var2)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">getBean</span><span class="params">(String var1, Object... var2)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; var1)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; var1, Object... var2)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">ObjectProvider&lt;T&gt; <span class="title">getBeanProvider</span><span class="params">(Class&lt;T&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">ObjectProvider&lt;T&gt; <span class="title">getBeanProvider</span><span class="params">(ResolvableType var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">containsBean</span><span class="params">(String var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">(String var1)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isPrototype</span><span class="params">(String var1)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isTypeMatch</span><span class="params">(String var1, ResolvableType var2)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isTypeMatch</span><span class="params">(String var1, Class&lt;?&gt; var2)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    Class&lt;?&gt; getType(String var1) <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    Class&lt;?&gt; getType(String var1, <span class="keyword">boolean</span> var2) <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line"></span><br><span class="line">    String[] getAliases(String var1);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>getBean的多个方法用于获取配置给SpringIoC容器的Bean。从参数类型看可以使字符串，也可以是Class类型，由于Class类型可以扩展接口也可以集成父类，所以在一定程度上会存在使用父类类型无法准确获得实例的异常，比如获取学生类，但是学生子类有男学生和女学生两类，这个时候通过学生类就无法从容器中得到实例，因为容器无法判断具体的实现类。</li>
<li>isSingleton用于判断是否单例，如果判断为真，其意思是该Bean的容器中是作为一个唯一单例存在的。而isPrototype则相反，如果判断为真，意思是当你从容其中获取Bean，容器就为你生成了一个新的实例。在默认情况下，Spring会为Bean创建一个单例，也就是默认情况下isSingleton返回true，而isPrototype返回false。</li>
<li>关于type的匹配，这是一个按Java类型匹配的方式。</li>
<li>getAliases方法是获取别名的方法。</li>
</ul>
<h3 id="Spring-IoC容器的初始化和依赖注入"><a href="#Spring-IoC容器的初始化和依赖注入" class="headerlink" title="Spring IoC容器的初始化和依赖注入"></a>Spring IoC容器的初始化和依赖注入</h3><p>Bean的初始化分为3步：<br>（1）Resource定位，这步是Spring IoC容器根据开发者的配置，进行资源定位，在Spring的开发中，通过XML或者注解都是十分常见的方式，定位的内容是由开发者所提供的。<br>（2）BeanDefinition的载入，这个过程就是Spring根据开发者的配置获取对应的POJO，用以生成对应实例的过程。<br>（3）BeanDefinition的注册，这个步骤就相当于把之前通过BeanDefinition载入的POJO往Spring IoC容器中注册，这样就可以使得开发和测试人员都可以通过描述从中得到Spring IoC容器的Bean了。<br>以上3步完成后，Bean就在Spring IoC容器中得到了初始化，但是没有完全依赖注入，也就是没有注入其配置的资源给Bean，那么它还不能完全使用。对于依赖注入，Spring Bean还有一个配置选项——lazy-init，其含义就是是否初始化Spring Bean，默认false，即默认自动初始化Bean。否则，只有当我们通过Spring IoC容器的getBean方法获取它时，它才会进行初始化，完成依赖注入。</p>
<h4 id="依赖注入实例"><a href="#依赖注入实例" class="headerlink" title="依赖注入实例"></a>依赖注入实例</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.beans.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JuiceMaker</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String beverageShop = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Source source = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeverageShop</span><span class="params">(String beverageShop)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.beverageShop = beverageShop;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSource</span><span class="params">(Source source)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Source <span class="title">getSource</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBeverageShop</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> beverageShop;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">makeJuice</span><span class="params">()</span></span>{</span><br><span class="line">        String juice = <span class="string">"这是一杯由"</span> + beverageShop + <span class="string">"饮品店，提供的"</span> + source.getSize() + source.getSugar() + source.getFruit();</span><br><span class="line">        <span class="keyword">return</span> juice;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.beans.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Source</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> String fruit;</span><br><span class="line">    <span class="keyword">private</span> String sugar;</span><br><span class="line">    <span class="keyword">private</span> Integer size;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFruit</span><span class="params">(String fruit)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.fruit = fruit;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSize</span><span class="params">(Integer size)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.size = size;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSugar</span><span class="params">(String sugar)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.sugar = sugar;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getSize</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFruit</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> fruit;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSugar</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> sugar;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>spring-config.xml，该文件在resources目录下，因为默认springboot读取扫描resources下的xml和其他资源文件，否则需要配置pom.xml的resources标签指定扫描目录：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 手动指定文件夹为resources --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--      MyBatis代码自动生成插件      --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--   配置文件的位置                 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configurationFile</span>&gt;</span>GeneratorMapper.xml<span class="tag">&lt;/<span class="name">configurationFile</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">verbose</span>&gt;</span>true<span class="tag">&lt;/<span class="name">verbose</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">overwrite</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overwrite</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>spring-config.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"source"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Source"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"fruit"</span> <span class="attr">value</span>=<span class="string">"橙汁"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sugar"</span> <span class="attr">value</span>=<span class="string">"少糖"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"size"</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"juiceMaker"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"beverageShop"</span> <span class="attr">value</span>=<span class="string">"贡茶"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"source"</span> <span class="attr">ref</span>=<span class="string">"source"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SpringBoot项目启动入口类</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span>  <span class="comment">//SpringBoot核心朱姐，主要用于开启spring自动配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        ApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring-config.xml"</span>);</span><br><span class="line">        JuiceMaker juiceMaker = (JuiceMaker) applicationContext.getBean(<span class="string">"juiceMaker"</span>);</span><br><span class="line">        System.out.println(juiceMaker.makeJuice());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>运行结果：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> -XX:TieredStopAtLevel=<span class="number">1</span> -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=<span class="keyword">true</span> -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=<span class="keyword">true</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=57146:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-web\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-web-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-autoconfigure-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-logging\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-logging-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-classic\<span class="number">1.2</span><span class="number">.3</span>\logback-classic-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-core\<span class="number">1.2</span><span class="number">.3</span>\logback-core-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\<span class="number">2.13</span><span class="number">.3</span>\log4j-to-slf4j-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-api\<span class="number">2.13</span><span class="number">.3</span>\log4j-api-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\jul-to-slf4j\<span class="number">1.7</span><span class="number">.30</span>\jul-to-slf4j-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\jakarta\annotation\jakarta.annotation-api\<span class="number">1.3</span><span class="number">.5</span>\jakarta.annotation-api-<span class="number">1.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\yaml\snakeyaml\<span class="number">1.27</span>\snakeyaml-<span class="number">1.27</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-json\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-json-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-databind\<span class="number">2.11</span><span class="number">.4</span>\jackson-databind-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\<span class="number">2.11</span><span class="number">.4</span>\jackson-annotations-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-core\<span class="number">2.11</span><span class="number">.4</span>\jackson-core-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jdk8-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jsr310-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\<span class="keyword">module</span>\jackson-<span class="keyword">module</span>-parameter-names\<span class="number">2.11</span><span class="number">.4</span>\jackson-<span class="keyword">module</span>-parameter-names-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-tomcat-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-core-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\glassfish\jakarta.el\<span class="number">3.0</span><span class="number">.3</span>\jakarta.el-<span class="number">3.0</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-web\<span class="number">5.3</span><span class="number">.5</span>\spring-web-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-webmvc\<span class="number">5.3</span><span class="number">.5</span>\spring-webmvc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-aop\<span class="number">5.3</span><span class="number">.5</span>\spring-aop-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-expression\<span class="number">5.3</span><span class="number">.5</span>\spring-expression-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\slf4j-api\<span class="number">1.7</span><span class="number">.30</span>\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-core\<span class="number">5.3</span><span class="number">.5</span>\spring-core-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jcl\<span class="number">5.3</span><span class="number">.5</span>\spring-jcl-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-beans\<span class="number">5.3</span><span class="number">.5</span>\spring-beans-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-context\<span class="number">5.3</span><span class="number">.5</span>\spring-context-<span class="number">5.3</span><span class="number">.5</span>.jar com.louris.springboot.Application</span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  `  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"></span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"></span><br><span class="line"> :: Spring Boot ::                (v2<span class="number">.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">13</span> <span class="number">14</span>:<span class="number">51</span>:<span class="number">24.036</span>  INFO <span class="number">11752</span> --- [           main] com.louris.springboot.Application        : Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">11752</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">13</span> <span class="number">14</span>:<span class="number">51</span>:<span class="number">24.038</span>  INFO <span class="number">11752</span> --- [           main] com.louris.springboot.Application        : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">13</span> <span class="number">14</span>:<span class="number">51</span>:<span class="number">24.627</span>  INFO <span class="number">11752</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-13 14:51:24.633  INFO 11752 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-13 14:51:24.633  INFO 11752 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-13 14:51:24.692  INFO 11752 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-13 14:51:24.692  INFO 11752 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 624 ms</span></span><br><span class="line"><span class="function">2021-09-13 14:51:24.786  INFO 11752 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-13 14:51:24.881  INFO 11752 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-13 14:51:24.888  INFO 11752 --- [           main] com.louris.springboot.Application        : Started Application in 1.066 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">1.431</span>)</span></span></span><br><span class="line"><span class="function">这是一杯由贡茶饮品店，提供的2少糖橙汁</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Spring-Bean的生命周期"><a href="#Spring-Bean的生命周期" class="headerlink" title="Spring Bean的生命周期"></a>Spring Bean的生命周期</h3><p>Spring IoC容器在执行了初始化和依赖注入后，会执行一定的步骤来完成初始化，通过这些步骤我们就能自定义初始化，而在Spring IoC容器正常关闭的时候，它也会执行一定的步骤来关闭容器，释放资源。除需要了解整个生命周期的步骤外，还要知道这些生命周期的接口是针对什么而言的，首先介绍生命周期的步骤。</p>
<ul>
<li>如果Bean实现了接口BeanNameAware的setBeanName方法，那么它就会调用这个方法。</li>
<li>如果Bean实现了接口BeanFactoryAware的setBeanFactory方法，那么它就会调用这个方法。</li>
<li>如果Bean实现了接口ApplicationContextAware的setApplicationContext方法，且Spring IoC容器也必须是一个ApplicationContext接口的实现类，那么才会调用这个方法，否则是不调用的。</li>
<li>如果Bean实现了接口BeanPostProcessor的postProcessBeforeInitialization方法，那么它就会调用这个方法。</li>
<li>如果Bean实现了接口BeanFactoryPostProcessor的afterPropertiesSet方法，那么它就会调用这个方法。</li>
<li>如果Bean自定义了初始化方法，它就会调用已定义的初始化方法。</li>
<li>如果Bean实现了接口BeanPostProcessor的postProcessAfterInitialization方法，完成了这些调用，这个时候Bean就完成了初始化，那么Bean就生存在Spring IoC的容器中了，使用者就可以从中获取Bean的服务。</li>
</ul>
<p>当服务器正常关闭，或者遇到其他关闭Spring IoC容器的事件，它就会调用对应的方法完成Bean的销毁，步骤如下：</p>
<ul>
<li>如果Bean实现了接口DisposableBean的destroy方法，那么就会调用它。</li>
<li>如果定义了自定义销毁方法，那么就会调用它。</li>
</ul>
<p>因为有些步骤是在一些条件下才会执行的，如果不注意这些，往往就发现命名实现了一些借口，但是该方法并没有被执行。所有的Spring IoC容器最低的要求是实现BeanFactory接口而已，而非ApplicationContext接口，如果采用了非ApplicationContext子类创建Spring IoC容器，俺么即使是实现了ApplicationContextAware的setApplicationContext方法，它也不会在生命周期之中被调用。</p>
<p>此外，还要注意这些接口是针对什么而言的，上述生命周期的接口，大部分是针对单个Bean而言的；BeanPostProcessor接口则是针对所有Bean而言的；接口DisposableBean则是针对Spring IoC容器本身。当一个Bean实现了上述的接口，我们只需要在Spring IoC容器中定义它就可以了，Spring IoC容器会自动识别。</p>
<h4 id="测试实现"><a href="#测试实现" class="headerlink" title="测试实现"></a>测试实现</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.beans.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Source</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> String fruit;</span><br><span class="line">    <span class="keyword">private</span> String sugar;</span><br><span class="line">    <span class="keyword">private</span> Integer size;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFruit</span><span class="params">(String fruit)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.fruit = fruit;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSize</span><span class="params">(Integer size)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.size = size;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSugar</span><span class="params">(String sugar)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.sugar = sugar;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getSize</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFruit</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> fruit;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSugar</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> sugar;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.beans.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanFactoryAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanNameAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JuiceMaker2</span> <span class="keyword">implements</span> <span class="title">BeanNameAware</span>, <span class="title">BeanFactoryAware</span>, <span class="title">ApplicationContextAware</span>, <span class="title">InitializingBean</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String beverageShop = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Source source = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeverageShop</span><span class="params">(String beverageShop)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.beverageShop = beverageShop;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSource</span><span class="params">(Source source)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Source <span class="title">getSource</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBeverageShop</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> beverageShop;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"【"</span> + <span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">"】执行自定义初始化方法"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"【"</span> + <span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">"】执行自定义销毁方法"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">makeJuice</span><span class="params">()</span></span>{</span><br><span class="line">        String juice = <span class="string">"这是一杯由"</span> + beverageShop + <span class="string">"饮品店，提供的"</span> + source.getSize() + source.getSugar() + source.getFruit();</span><br><span class="line">        <span class="keyword">return</span> juice;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String s)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"【"</span> + <span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">"】调用BeanNameAware接口的setBeanName方法"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">        System.out.println(<span class="string">"【"</span> + <span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">"】调用BeanFactoryAware接口的setBeanFactory方法"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">        System.out.println(<span class="string">"【"</span> + <span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">"】调用ApplicationContextAware接口的setApplicationContext方法"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(<span class="string">"【"</span> + <span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">"】调用Initializing接口的afterPropertiesSet方法"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanPostProcessor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理Spring IoC容器所有的Bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanPostProcessorImpl</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">        System.out.println(<span class="string">"【"</span>+ bean.getClass().getSimpleName() + <span class="string">"】对象"</span> + beanName + <span class="string">"开始初始化"</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">        System.out.println(<span class="string">"【"</span>+bean.getClass().getSimpleName() + <span class="string">"】对象"</span> + beanName + <span class="string">"实例化完成"</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.DisposableBean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 针对Spring IoC容器销毁的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DisposableBeanImpl</span> <span class="keyword">implements</span> <span class="title">DisposableBean</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(<span class="string">"调用接口DisposableBean的destroy方法"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker2;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SpringBoot项目启动入口类</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span>  <span class="comment">//SpringBoot核心朱姐，主要用于开启spring自动配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        ClassPathXmlApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring-config.xml"</span>);</span><br><span class="line">        JuiceMaker2 juiceMaker2 = (JuiceMaker2) applicationContext.getBean(<span class="string">"juiceMaker2"</span>);</span><br><span class="line">        System.out.println(juiceMaker2.makeJuice());</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>执行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> -XX:TieredStopAtLevel=<span class="number">1</span> -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=<span class="keyword">true</span> -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=<span class="keyword">true</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=54012:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-web\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-web-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-autoconfigure-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-logging\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-logging-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-classic\<span class="number">1.2</span><span class="number">.3</span>\logback-classic-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-core\<span class="number">1.2</span><span class="number">.3</span>\logback-core-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\<span class="number">2.13</span><span class="number">.3</span>\log4j-to-slf4j-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-api\<span class="number">2.13</span><span class="number">.3</span>\log4j-api-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\jul-to-slf4j\<span class="number">1.7</span><span class="number">.30</span>\jul-to-slf4j-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\jakarta\annotation\jakarta.annotation-api\<span class="number">1.3</span><span class="number">.5</span>\jakarta.annotation-api-<span class="number">1.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\yaml\snakeyaml\<span class="number">1.27</span>\snakeyaml-<span class="number">1.27</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-json\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-json-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-databind\<span class="number">2.11</span><span class="number">.4</span>\jackson-databind-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\<span class="number">2.11</span><span class="number">.4</span>\jackson-annotations-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-core\<span class="number">2.11</span><span class="number">.4</span>\jackson-core-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jdk8-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jsr310-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\<span class="keyword">module</span>\jackson-<span class="keyword">module</span>-parameter-names\<span class="number">2.11</span><span class="number">.4</span>\jackson-<span class="keyword">module</span>-parameter-names-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-tomcat-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-core-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\glassfish\jakarta.el\<span class="number">3.0</span><span class="number">.3</span>\jakarta.el-<span class="number">3.0</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-web\<span class="number">5.3</span><span class="number">.5</span>\spring-web-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-webmvc\<span class="number">5.3</span><span class="number">.5</span>\spring-webmvc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-aop\<span class="number">5.3</span><span class="number">.5</span>\spring-aop-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-expression\<span class="number">5.3</span><span class="number">.5</span>\spring-expression-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\slf4j-api\<span class="number">1.7</span><span class="number">.30</span>\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-core\<span class="number">5.3</span><span class="number">.5</span>\spring-core-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jcl\<span class="number">5.3</span><span class="number">.5</span>\spring-jcl-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-beans\<span class="number">5.3</span><span class="number">.5</span>\spring-beans-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-context\<span class="number">5.3</span><span class="number">.5</span>\spring-context-<span class="number">5.3</span><span class="number">.5</span>.jar com.louris.springboot.Application</span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  `  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"> </span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v2<span class="number">.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">13</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">11.074</span>  INFO <span class="number">10084</span> --- [           main] com.louris.springboot.Application        : Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">10084</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">13</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">11.076</span>  INFO <span class="number">10084</span> --- [           main] com.louris.springboot.Application        : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">13</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">11.780</span>  INFO <span class="number">10084</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-13 15:33:11.787  INFO 10084 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-13 15:33:11.787  INFO 10084 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-13 15:33:11.856  INFO 10084 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-13 15:33:11.856  INFO 10084 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 752 ms</span></span><br><span class="line"><span class="function">2021-09-13 15:33:11.958  INFO 10084 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-13 15:33:12.059  INFO 10084 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-13 15:33:12.066  INFO 10084 --- [           main] com.louris.springboot.Application        : Started Application in 1.212 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">1.614</span>)</span></span></span><br><span class="line"><span class="function">【DisposableBeanImpl】对象disposableBean开始初始化</span></span><br><span class="line"><span class="function">【DisposableBeanImpl】对象disposableBean实例化完成</span></span><br><span class="line"><span class="function">【Source】对象source开始初始化</span></span><br><span class="line"><span class="function">【Source】对象source实例化完成</span></span><br><span class="line"><span class="function">【JuiceMaker】对象juiceMaker开始初始化</span></span><br><span class="line"><span class="function">【JuiceMaker】对象juiceMaker实例化完成</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用BeanNameAware接口的setBeanName方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用BeanFactoryAware接口的setBeanFactory方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用ApplicationContextAware接口的setApplicationContext方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】对象juiceMaker2开始初始化</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用Initializing接口的afterPropertiesSet方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】执行自定义初始化方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】对象juiceMaker2实例化完成</span></span><br><span class="line"><span class="function">这是一杯由贡茶饮品店，提供的2少糖橙汁</span></span><br><span class="line"><span class="function">【JuiceMaker2】执行自定义销毁方法</span></span><br><span class="line"><span class="function">调用接口DisposableBean的destroy方法</span></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="装配Spring-Bean"><a href="#装配Spring-Bean" class="headerlink" title="装配Spring Bean"></a>装配Spring Bean</h1></blockquote>
<h2 id="依赖注入的3种方式"><a href="#依赖注入的3种方式" class="headerlink" title="依赖注入的3种方式"></a>依赖注入的3种方式</h2><h3 id="构造器注入"><a href="#构造器注入" class="headerlink" title="构造器注入"></a>构造器注入</h3><p>构造器注入依赖于构造方法实现，而构造方法可以是有参数的或者是无参数的。在大部分的情况下，我们都是通过类的构造方法来创建类对象，Spring也可以采用反射的方式，通过使用构造方式来完成注入，这就是构造器注入的原理。</p>
<p>为了让Spring完成对应的构造注入，我们有必要去描述具体的类、构造方法并设置对应的参数，这样Spring就会通过对应的信息用反射的形式创建对象。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.beans.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Role</span><span class="params">(String roleName, String note)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoleName</span><span class="params">(String roleName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoleName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"role"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"总经理"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"公司管理者"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><p>constructor-arg元素用于定义类构造方法的参数，其中index用于定义参数的位置，而value则是设置值，通过这样的定义Spring便知道使用Role对应的构造方法创建对象。</p>
</li>
<li><p>缺点是如果参数很多，构造方法就比较复杂</p>
</li>
</ul>
<h3 id="使用setter注入"><a href="#使用setter注入" class="headerlink" title="使用setter注入"></a>使用setter注入</h3><p>setter注入是Spring中最主流的注入方式。首先可以把构造方法声明为无参数的，然后使用setter注入为其设置对应的值，其实也是通过Java反射技术得以实现的。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"role"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"roleName"</span> <span class="attr">value</span>=<span class="string">"高级工程师"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">value</span>=<span class="string">"重要人员"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="接口注入"><a href="#接口注入" class="headerlink" title="接口注入"></a>接口注入</h3><p>有些时候资源并非来自于自身系统，而是来自于外界，比如数据库连接资源完全可以在Tomcat下配置，然后通过JNDI的形式去获取它，这样数据库连接资源是属于开发工程外的资源，这个时候可以采用接口注入的形式来获取它。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jndi.JndiObjectFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jndiName"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>java:comp/env/jdbc/ssm<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="装配Bean概述"><a href="#装配Bean概述" class="headerlink" title="装配Bean概述"></a>装配Bean概述</h2><p>Spring中提供了3种方法进行配置装配Bean到Spring IoC容器：</p>
<ul>
<li>在XML中显示配置；</li>
<li>在Java的接口和类中实现配置；</li>
<li>隐式Bean的发现机制和自动装配原则；</li>
</ul>
<p>明确3种方式的优先级：<br>（1）基于约定优于配置的原则，最优先的应该是通过隐式Bean的发现机制和自动装配的原则。减少程序开发者的决定权，简单又不是灵活；<br>（2）在没有办法使用自动装配原则的情况下应该优先考虑Java接口和类中实现配置，避免XML配置的泛滥。典型场景的例子是一个父类有多个子类，通过IoC容器初始化一个子类，容器将无法知道使用哪个子类去初始化，这个时候可以使用Java的注解配置去指定。<br>（3）在上述方法都无法使用的情况下，那么只能选择XML去配置Spring IoC容器。由于现实工作中常常用到第三方的类库，有些类并不是我们开发的，我们无法修改里面的代码，这个时候就通过XML的方式配置使用了。</p>
<h3 id="通过XML配置装配Bean"><a href="#通过XML配置装配Bean" class="headerlink" title="通过XML配置装配Bean"></a>通过XML配置装配Bean</h3><h4 id="简单配置类对象"><a href="#简单配置类对象" class="headerlink" title="简单配置类对象"></a>简单配置类对象</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"beanPostProcessor"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.BeanPostProcessorImpl"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"disposableBean"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.DisposableBeanImpl"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"source"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Source"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"fruit"</span> <span class="attr">value</span>=<span class="string">"橙汁"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sugar"</span> <span class="attr">value</span>=<span class="string">"少糖"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"size"</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"juiceMaker"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"beverageShop"</span> <span class="attr">value</span>=<span class="string">"贡茶"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"source"</span> <span class="attr">ref</span>=<span class="string">"source"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"juiceMaker2"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker2"</span> <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"destroy"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"beverageShop"</span> <span class="attr">value</span>=<span class="string">"贡茶"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"source"</span> <span class="attr">ref</span>=<span class="string">"source"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"role"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;constructor-arg index="0" value="总经理"/&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;constructor-arg index="1" value="公司管理者"/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"roleName"</span> <span class="attr">value</span>=<span class="string">"高级工程师"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">value</span>=<span class="string">"重要人员"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jndi.JndiObjectFactoryBean"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jndiName"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>java:comp/env/jdbc/ssm<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="装配集合等复杂对象"><a href="#装配集合等复杂对象" class="headerlink" title="装配集合等复杂对象"></a>装配集合等复杂对象</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"beanPostProcessor"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.BeanPostProcessorImpl"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"disposableBean"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.DisposableBeanImpl"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"source"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Source"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"fruit"</span> <span class="attr">value</span>=<span class="string">"橙汁"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sugar"</span> <span class="attr">value</span>=<span class="string">"少糖"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"size"</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"juiceMaker"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"beverageShop"</span> <span class="attr">value</span>=<span class="string">"贡茶"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"source"</span> <span class="attr">ref</span>=<span class="string">"source"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"juiceMaker2"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker2"</span> <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"destroy"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"beverageShop"</span> <span class="attr">value</span>=<span class="string">"贡茶"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"source"</span> <span class="attr">ref</span>=<span class="string">"source"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"role"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;constructor-arg index="0" value="总经理"/&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;constructor-arg index="1" value="公司管理者"/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"roleName"</span> <span class="attr">value</span>=<span class="string">"高级工程师"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">value</span>=<span class="string">"重要人员"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;bean id="dataSource" class="org.springframework.jndi.JndiObjectFactoryBean"&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--    &lt;property name="jndiName"&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        &lt;value&gt;java:comp/env/jdbc/ssm&lt;/value&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--    &lt;/property&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;/bean&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"complexAssembly"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.ComplexAssembly"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-list-1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-list-2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-list-3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"key1"</span> <span class="attr">value</span>=<span class="string">"value-key-1"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"key2"</span> <span class="attr">value</span>=<span class="string">"value-key-2"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"key3"</span> <span class="attr">value</span>=<span class="string">"value-key-3"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"properties"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"prop1"</span>&gt;</span>value-prop-1<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"prop2"</span>&gt;</span>value-prop-2<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"prop3"</span>&gt;</span>value-prop-3<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"set"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-set-1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-set-2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-set-3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"array"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-array-1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-array-2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-array-3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"role1"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"roleName"</span> <span class="attr">value</span>=<span class="string">"role_name_1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">value</span>=<span class="string">"role_note_1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"role2"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"roleName"</span> <span class="attr">value</span>=<span class="string">"role_name_2"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">value</span>=<span class="string">"note_note_2"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"user1"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.User"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userName"</span> <span class="attr">value</span>=<span class="string">"user_name_1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">value</span>=<span class="string">"role_note_1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"user2"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.User"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userName"</span> <span class="attr">value</span>=<span class="string">"user_name_2"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">value</span>=<span class="string">"role_note_1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userRoleAssembly"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.UserRoleAssembly"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"role1"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"role2"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"role1"</span> <span class="attr">value-ref</span>=<span class="string">"user1"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"role2"</span> <span class="attr">value-ref</span>=<span class="string">"user2"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"set"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"role1"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"role2"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="命名空间装配"><a href="#命名空间装配" class="headerlink" title="命名空间装配"></a>命名空间装配</h3><ul>
<li>c表示通过构造器，c:_0表示构造器的第一个参数，c:_1表示构造器的第一个参数，其他同理，所以必须在POJO上实现对应参数的构造器</li>
<li>p表示通过引用属性，p:id表示使用setId方法进行设置，其他同理</li>
<li>util表示使用内置的对象进行设置，例如list、set<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:c</span>=<span class="string">"http://www.springframework.org/schema/c"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"role3"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">c:_0</span>=<span class="string">"3"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">c:_1</span>=<span class="string">"role_name_3"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">c:_2</span>=<span class="string">"role_note_3"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"role4"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:id</span>=<span class="string">"4"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:roleName</span>=<span class="string">"role_name_4"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:note</span>=<span class="string">"role_note_4"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:c</span>=<span class="string">"http://www.springframework.org/schema/c"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"complexAssembly"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.ComplexAssembly"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-list-1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-list-2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-list-3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"key1"</span> <span class="attr">value</span>=<span class="string">"value-key-1"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"key2"</span> <span class="attr">value</span>=<span class="string">"value-key-2"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"key3"</span> <span class="attr">value</span>=<span class="string">"value-key-3"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"properties"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"prop1"</span>&gt;</span>value-prop-1<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"prop2"</span>&gt;</span>value-prop-2<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"prop3"</span>&gt;</span>value-prop-3<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"set"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-set-1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-set-2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-set-3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"array"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-array-1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-array-2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>value-array-3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"role1"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"roleName"</span> <span class="attr">value</span>=<span class="string">"role_name_1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">value</span>=<span class="string">"role_note_1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"role2"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"roleName"</span> <span class="attr">value</span>=<span class="string">"role_name_2"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">value</span>=<span class="string">"note_note_2"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"user1"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.User"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userName"</span> <span class="attr">value</span>=<span class="string">"user_name_1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">value</span>=<span class="string">"role_note_1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"user2"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.User"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userName"</span> <span class="attr">value</span>=<span class="string">"user_name_2"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">value</span>=<span class="string">"role_note_1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">"list"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"role1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"role2"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">util:map</span> <span class="attr">id</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"role1"</span> <span class="attr">value-ref</span>=<span class="string">"user1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"role2"</span> <span class="attr">value-ref</span>=<span class="string">"user2"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">util:set</span> <span class="attr">id</span>=<span class="string">"set"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"role1"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"role2"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">util:set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userRoleAssembly"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.UserRoleAssembly"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:id</span>=<span class="string">"1"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:list-ref</span>=<span class="string">"list"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:map-ref</span>=<span class="string">"map"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">p:set-ref</span>=<span class="string">"set"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h2 id="通过注解装配Bean"><a href="#通过注解装配Bean" class="headerlink" title="通过注解装配Bean"></a>通过注解装配Bean</h2><p>更多的时候会考虑使用注解的方式去装配Bean，可以减少XML的配置，注解功能更为强大，它既能实现XML的功能，也提供了自动装配的功能，采用了自动装配后，程序员所需要做的决断就少了，更加有利于对程序的开发。</p>
<p>在Spring中，它提供了两种方式来让Spring IoC容器发现Bean</p>
<ul>
<li>组件扫描：通过定义资源的方式，让Spring IoC容器扫描对应的包，从而把Bean装配进来；</li>
<li>自动装配：通过注解定义，使得一些依赖关系可以通过注解完成；</li>
</ul>
<h3 id="使用-Component装配Bean"><a href="#使用-Component装配Bean" class="headerlink" title="使用@Component装配Bean"></a>使用@Component装配Bean</h3><h4 id="注解Bean"><a href="#注解Bean" class="headerlink" title="注解Bean"></a>注解Bean</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.beans.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(value = <span class="string">"role"</span>) <span class="comment">//默认是类的小写字母开头</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>{</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"1"</span>)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"role_name_1"</span>)</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"role_note_1"</span>)</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Role</span><span class="params">()</span></span>{}</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Role</span><span class="params">(Long id, String roleName, String note)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoleName</span><span class="params">(String roleName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoleName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="ComponentScan配置扫描类"><a href="#ComponentScan配置扫描类" class="headerlink" title="@ComponentScan配置扫描类"></a>@ComponentScan配置扫描类</h4><p>注意，@ComponentScan有两个参数：</p>
<ul>
<li><p>basePackages，可以扫描多个包的bean，默认为当前Config类的包；</p>
</li>
<li><p>basePackageClasses，可以扫描多个指定的bean</p>
</li>
<li><p>如果采用多个@ComponentScan去定义对应的包，但是每定义一个@ComponentScan，Spring就会为所定义的类生成一个新的对象，也就是所配置的Bean将会生成多个实例，这往往不是我们需要的；</p>
</li>
<li><p>对于同时一定了上述两个参数的@ComponentScan，Spring会进行专门的区分，也就是说在同一个@ComponentScan中即使重复定义相同的包或者存在其子包定义，也不会造成因同一个Bean的多次扫描，而导致一次配置生成多个对象。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@ComponentScan(basePackages = {"com.louris.springboot.IoCImpl.beans"})</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackageClasses = {Role<span class="class">.<span class="keyword">class</span>})</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">PojoConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h4 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker2;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.config.PojoConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SpringBoot项目启动入口类</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span>  <span class="comment">//SpringBoot核心朱姐，主要用于开启spring自动配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(PojoConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Role role = applicationContext.getBean(Role<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(role.getRoleName());</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="运行结果-5"><a href="#运行结果-5" class="headerlink" title="运行结果"></a>运行结果</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> -XX:TieredStopAtLevel=<span class="number">1</span> -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=<span class="keyword">true</span> -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=<span class="keyword">true</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=57856:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-web\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-web-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-autoconfigure-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-logging\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-logging-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-classic\<span class="number">1.2</span><span class="number">.3</span>\logback-classic-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-core\<span class="number">1.2</span><span class="number">.3</span>\logback-core-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\<span class="number">2.13</span><span class="number">.3</span>\log4j-to-slf4j-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-api\<span class="number">2.13</span><span class="number">.3</span>\log4j-api-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\jul-to-slf4j\<span class="number">1.7</span><span class="number">.30</span>\jul-to-slf4j-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\jakarta\annotation\jakarta.annotation-api\<span class="number">1.3</span><span class="number">.5</span>\jakarta.annotation-api-<span class="number">1.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\yaml\snakeyaml\<span class="number">1.27</span>\snakeyaml-<span class="number">1.27</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-json\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-json-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-databind\<span class="number">2.11</span><span class="number">.4</span>\jackson-databind-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\<span class="number">2.11</span><span class="number">.4</span>\jackson-annotations-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-core\<span class="number">2.11</span><span class="number">.4</span>\jackson-core-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jdk8-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jsr310-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\<span class="keyword">module</span>\jackson-<span class="keyword">module</span>-parameter-names\<span class="number">2.11</span><span class="number">.4</span>\jackson-<span class="keyword">module</span>-parameter-names-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-tomcat-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-core-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\glassfish\jakarta.el\<span class="number">3.0</span><span class="number">.3</span>\jakarta.el-<span class="number">3.0</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-web\<span class="number">5.3</span><span class="number">.5</span>\spring-web-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-webmvc\<span class="number">5.3</span><span class="number">.5</span>\spring-webmvc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-aop\<span class="number">5.3</span><span class="number">.5</span>\spring-aop-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-expression\<span class="number">5.3</span><span class="number">.5</span>\spring-expression-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\slf4j-api\<span class="number">1.7</span><span class="number">.30</span>\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-core\<span class="number">5.3</span><span class="number">.5</span>\spring-core-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jcl\<span class="number">5.3</span><span class="number">.5</span>\spring-jcl-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-beans\<span class="number">5.3</span><span class="number">.5</span>\spring-beans-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-context\<span class="number">5.3</span><span class="number">.5</span>\spring-context-<span class="number">5.3</span><span class="number">.5</span>.jar com.louris.springboot.Application</span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  `  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"> </span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v2<span class="number">.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">17</span>:<span class="number">01</span>:<span class="number">32.447</span>  INFO <span class="number">12744</span> --- [           main] com.louris.springboot.Application        : Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">12744</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">17</span>:<span class="number">01</span>:<span class="number">32.448</span>  INFO <span class="number">12744</span> --- [           main] com.louris.springboot.Application        : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">17</span>:<span class="number">01</span>:<span class="number">33.050</span>  INFO <span class="number">12744</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-14 17:01:33.056  INFO 12744 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-14 17:01:33.057  INFO 12744 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-14 17:01:33.116  INFO 12744 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-14 17:01:33.116  INFO 12744 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 639 ms</span></span><br><span class="line"><span class="function">2021-09-14 17:01:33.213  INFO 12744 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-14 17:01:33.312  INFO 12744 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-14 17:01:33.318  INFO 12744 --- [           main] com.louris.springboot.Application        : Started Application in 1.084 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">1.455</span>)</span></span></span><br><span class="line"><span class="function">role_name_1</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="自动装配——-Autowired"><a href="#自动装配——-Autowired" class="headerlink" title="自动装配——@Autowired"></a>自动装配——@Autowired</h3><p>Spring先完成Bean的定义和生成，然后寻找需要注入的资源；也就是当Spring生成所有的Bean后，如果发现这个注解，它就会在Bean中查找，然后找到对应的类型，将其注入进来，这样就完成了依赖注入了。</p>
<p>自动装配技术是一种由Spring自己发现对应的Bean，自动完成装配工作的方式，它会应用到一个十分常用的注解@Autowired上，这个时候Spring会根据类型去寻找定义的Bean然后将其注入，按类型的方式。</p>
<h4 id="RoleService"><a href="#RoleService" class="headerlink" title="RoleService"></a>RoleService</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleService</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printRoleInfo</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="RoleServiceImpl"><a href="#RoleServiceImpl" class="headerlink" title="RoleServiceImpl"></a>RoleServiceImpl</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImpl</span> <span class="keyword">implements</span> <span class="title">RoleService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span>(required = <span class="keyword">true</span>) <span class="comment">//默认true，表示默认一定能找到，否则抛出异常，改成false则允许不注入</span></span><br><span class="line">    <span class="keyword">private</span> Role role = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRoleInfo</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"id ="</span> + role.getId());</span><br><span class="line">        System.out.println(<span class="string">"roleName ="</span> + role.getRoleName());</span><br><span class="line">        System.out.println(<span class="string">"note ="</span> + role.getNote());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRole</span><span class="params">(Role role)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.role = role;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">getRole</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> role;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="PojoConfig"><a href="#PojoConfig" class="headerlink" title="PojoConfig"></a>PojoConfig</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@ComponentScan(basePackages = {"com.louris.springboot.IoCImpl.beans"})</span></span><br><span class="line"><span class="comment">//@ComponentScan(basePackageClasses = {Role.class})</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackageClasses = {RoleServiceImpl<span class="class">.<span class="keyword">class</span>, <span class="title">Role</span>.<span class="title">class</span>})</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">PojoConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="测试启动类"><a href="#测试启动类" class="headerlink" title="测试启动类"></a>测试启动类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker2;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.config.PojoConfig;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SpringBoot项目启动入口类</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span>  <span class="comment">//SpringBoot核心朱姐，主要用于开启spring自动配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Role role = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line"><span class="comment">//        ClassPathXmlApplicationContext applicationContext = new ClassPathXmlApplicationContext("spring-config.xml");</span></span><br><span class="line"><span class="comment">////        JuiceMaker juiceMaker = (JuiceMaker) applicationContext.getBean("juiceMaker");</span></span><br><span class="line"><span class="comment">////        System.out.println(juiceMaker.makeJuice());</span></span><br><span class="line"><span class="comment">//        JuiceMaker2 juiceMaker2 = (JuiceMaker2) applicationContext.getBean("juiceMaker2");</span></span><br><span class="line"><span class="comment">//        System.out.println(juiceMaker2.makeJuice());</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        Role role = (Role)applicationContext.getBean("role");</span></span><br><span class="line"><span class="comment">//        System.out.println(role.getId());</span></span><br><span class="line"><span class="comment">//        System.out.println(role.getNote());</span></span><br><span class="line"><span class="comment">//        System.out.println(role.getRoleName());</span></span><br><span class="line">        ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(PojoConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//        Role role = applicationContext.getBean(Role.class);</span></span><br><span class="line"><span class="comment">//        System.out.println(role.getRoleName());</span></span><br><span class="line"><span class="comment">//        RoleService role = new RoleServiceImpl();</span></span><br><span class="line"><span class="comment">//        role.printRoleInfo();</span></span><br><span class="line">        RoleService role = applicationContext.getBean(RoleServiceImpl<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        role.printRoleInfo();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="运行结果-6"><a href="#运行结果-6" class="headerlink" title="运行结果"></a>运行结果</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> -XX:TieredStopAtLevel=<span class="number">1</span> -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=<span class="keyword">true</span> -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=<span class="keyword">true</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=60803:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-web\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-web-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-autoconfigure-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-logging\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-logging-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-classic\<span class="number">1.2</span><span class="number">.3</span>\logback-classic-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-core\<span class="number">1.2</span><span class="number">.3</span>\logback-core-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\<span class="number">2.13</span><span class="number">.3</span>\log4j-to-slf4j-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-api\<span class="number">2.13</span><span class="number">.3</span>\log4j-api-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\jul-to-slf4j\<span class="number">1.7</span><span class="number">.30</span>\jul-to-slf4j-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\jakarta\annotation\jakarta.annotation-api\<span class="number">1.3</span><span class="number">.5</span>\jakarta.annotation-api-<span class="number">1.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\yaml\snakeyaml\<span class="number">1.27</span>\snakeyaml-<span class="number">1.27</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-json\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-json-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-databind\<span class="number">2.11</span><span class="number">.4</span>\jackson-databind-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\<span class="number">2.11</span><span class="number">.4</span>\jackson-annotations-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-core\<span class="number">2.11</span><span class="number">.4</span>\jackson-core-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jdk8-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jsr310-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\<span class="keyword">module</span>\jackson-<span class="keyword">module</span>-parameter-names\<span class="number">2.11</span><span class="number">.4</span>\jackson-<span class="keyword">module</span>-parameter-names-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-tomcat-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-core-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\glassfish\jakarta.el\<span class="number">3.0</span><span class="number">.3</span>\jakarta.el-<span class="number">3.0</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-web\<span class="number">5.3</span><span class="number">.5</span>\spring-web-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-webmvc\<span class="number">5.3</span><span class="number">.5</span>\spring-webmvc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-aop\<span class="number">5.3</span><span class="number">.5</span>\spring-aop-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-expression\<span class="number">5.3</span><span class="number">.5</span>\spring-expression-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\slf4j-api\<span class="number">1.7</span><span class="number">.30</span>\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-core\<span class="number">5.3</span><span class="number">.5</span>\spring-core-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jcl\<span class="number">5.3</span><span class="number">.5</span>\spring-jcl-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-beans\<span class="number">5.3</span><span class="number">.5</span>\spring-beans-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-context\<span class="number">5.3</span><span class="number">.5</span>\spring-context-<span class="number">5.3</span><span class="number">.5</span>.jar com.louris.springboot.Application</span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  `  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"> </span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v2<span class="number">.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">21</span>:<span class="number">18</span>:<span class="number">05.341</span>  INFO <span class="number">23808</span> --- [           main] com.louris.springboot.Application        : Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">23808</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">21</span>:<span class="number">18</span>:<span class="number">05.342</span>  INFO <span class="number">23808</span> --- [           main] com.louris.springboot.Application        : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">21</span>:<span class="number">18</span>:<span class="number">05.992</span>  INFO <span class="number">23808</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-14 21:18:05.999  INFO 23808 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-14 21:18:05.999  INFO 23808 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-14 21:18:06.079  INFO 23808 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-14 21:18:06.079  INFO 23808 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 708 ms</span></span><br><span class="line"><span class="function">2021-09-14 21:18:06.106  INFO 23808 --- [           main] f.a.AutowiredAnnotationBeanPostProcessor : Autowired annotation is not supported on <span class="keyword">static</span> fields: <span class="keyword">private</span> <span class="keyword">static</span> com.louris.springboot.IoCImpl.beans.pojo.Role com.louris.springboot.Application.role</span></span><br><span class="line"><span class="function">2021-09-14 21:18:06.177  INFO 23808 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-14 21:18:06.275  INFO 23808 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-14 21:18:06.281  INFO 23808 --- [           main] com.louris.springboot.Application        : Started Application in 1.152 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">1.537</span>)</span></span></span><br><span class="line"><span class="function">id </span>=<span class="number">1</span></span><br><span class="line">roleName =role_name_1</span><br><span class="line">note =role_note_1</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到，@Autowired自动注入到RoleServiceImpl中，避免了手动获取bean并幅值。</p>
<h4 id="Autowired方法配置"><a href="#Autowired方法配置" class="headerlink" title="@Autowired方法配置"></a>@Autowired方法配置</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImpl</span> <span class="keyword">implements</span> <span class="title">RoleService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Autowired(required = true) //默认true，表示默认一定能找到，否则抛出异常，改成false则允许不注入</span></span><br><span class="line">    <span class="keyword">private</span> Role role = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRoleInfo</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"id ="</span> + role.getId());</span><br><span class="line">        System.out.println(<span class="string">"roleName ="</span> + role.getRoleName());</span><br><span class="line">        System.out.println(<span class="string">"note ="</span> + role.getNote());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRole</span><span class="params">(Role role)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.role = role;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">getRole</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> role;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="自动装配的歧义性（-Primary-和-Qualifier）"><a href="#自动装配的歧义性（-Primary-和-Qualifier）" class="headerlink" title="自动装配的歧义性（@Primary 和 @Qualifier）"></a>自动装配的歧义性（@Primary 和 @Qualifier）</h3><p>例如同一个接口有两个不同的实现类，那么注入的时候会有歧义性。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImpl</span> <span class="keyword">implements</span> <span class="title">RoleService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Autowired(required = true) //默认true，表示默认一定能找到，否则抛出异常，改成false则允许不注入</span></span><br><span class="line">    <span class="keyword">private</span> Role role = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRoleInfo</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"id ="</span> + role.getId());</span><br><span class="line">        System.out.println(<span class="string">"roleName ="</span> + role.getRoleName());</span><br><span class="line">        System.out.println(<span class="string">"note ="</span> + role.getNote());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRole</span><span class="params">(Role role)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.role = role;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">getRole</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> role;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImp2</span> <span class="keyword">implements</span> <span class="title">RoleService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Role role = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRoleInfo</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"Impl2"</span>);</span><br><span class="line">        System.out.println(<span class="string">"id ="</span> + role.getId());</span><br><span class="line">        System.out.println(<span class="string">"roleName ="</span> + role.getRoleName());</span><br><span class="line">        System.out.println(<span class="string">"note ="</span> + role.getNote());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleController</span> </span>{</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RoleService roleService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRole</span><span class="params">()</span></span>{</span><br><span class="line">        roleService.printRoleInfo();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Primary"><a href="#Primary" class="headerlink" title="@Primary"></a>@Primary</h3><p>通过该注解让Spring优先将被注解的类注入，消除歧义性</p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImp2</span> <span class="keyword">implements</span> <span class="title">RoleService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Role role = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRoleInfo</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"Impl2"</span>);</span><br><span class="line">        System.out.println(<span class="string">"id ="</span> + role.getId());</span><br><span class="line">        System.out.println(<span class="string">"roleName ="</span> + role.getRoleName());</span><br><span class="line">        System.out.println(<span class="string">"note ="</span> + role.getNote());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@ComponentScan(basePackages = {"com.louris.springboot.IoCImpl.beans"})</span></span><br><span class="line"><span class="comment">//@ComponentScan(basePackageClasses = {Role.class})</span></span><br><span class="line"><span class="comment">//@ComponentScan(basePackageClasses = {RoleServiceImpl.class, Role.class})</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = {<span class="string">"com.louris.springboot.IoCImpl.beans"</span>,</span><br><span class="line">        <span class="string">"com.louris.springboot.IoCImpl.controller"</span>,</span><br><span class="line">        <span class="string">"com.louris.springboot.IoCImpl.impl"</span>})</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PojoConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker2;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.config.PojoConfig;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.controller.RoleController;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SpringBoot项目启动入口类</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span>  <span class="comment">//SpringBoot核心朱姐，主要用于开启spring自动配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Role role = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(PojoConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        RoleController roleController = applicationContext.getBean(RoleController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        roleController.printRole();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="运行结果-7"><a href="#运行结果-7" class="headerlink" title="运行结果"></a>运行结果</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> -XX:TieredStopAtLevel=<span class="number">1</span> -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=<span class="keyword">true</span> -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=<span class="keyword">true</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=54761:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-web\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-web-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-autoconfigure-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-logging\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-logging-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-classic\<span class="number">1.2</span><span class="number">.3</span>\logback-classic-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-core\<span class="number">1.2</span><span class="number">.3</span>\logback-core-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\<span class="number">2.13</span><span class="number">.3</span>\log4j-to-slf4j-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-api\<span class="number">2.13</span><span class="number">.3</span>\log4j-api-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\jul-to-slf4j\<span class="number">1.7</span><span class="number">.30</span>\jul-to-slf4j-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\jakarta\annotation\jakarta.annotation-api\<span class="number">1.3</span><span class="number">.5</span>\jakarta.annotation-api-<span class="number">1.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\yaml\snakeyaml\<span class="number">1.27</span>\snakeyaml-<span class="number">1.27</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-json\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-json-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-databind\<span class="number">2.11</span><span class="number">.4</span>\jackson-databind-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\<span class="number">2.11</span><span class="number">.4</span>\jackson-annotations-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-core\<span class="number">2.11</span><span class="number">.4</span>\jackson-core-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jdk8-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jsr310-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\<span class="keyword">module</span>\jackson-<span class="keyword">module</span>-parameter-names\<span class="number">2.11</span><span class="number">.4</span>\jackson-<span class="keyword">module</span>-parameter-names-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-tomcat-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-core-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\glassfish\jakarta.el\<span class="number">3.0</span><span class="number">.3</span>\jakarta.el-<span class="number">3.0</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-web\<span class="number">5.3</span><span class="number">.5</span>\spring-web-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-webmvc\<span class="number">5.3</span><span class="number">.5</span>\spring-webmvc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-aop\<span class="number">5.3</span><span class="number">.5</span>\spring-aop-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-expression\<span class="number">5.3</span><span class="number">.5</span>\spring-expression-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\slf4j-api\<span class="number">1.7</span><span class="number">.30</span>\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-core\<span class="number">5.3</span><span class="number">.5</span>\spring-core-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jcl\<span class="number">5.3</span><span class="number">.5</span>\spring-jcl-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-beans\<span class="number">5.3</span><span class="number">.5</span>\spring-beans-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-context\<span class="number">5.3</span><span class="number">.5</span>\spring-context-<span class="number">5.3</span><span class="number">.5</span>.jar com.louris.springboot.Application</span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  `  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"> </span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v2<span class="number">.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">21</span>:<span class="number">52</span>:<span class="number">52.498</span>  INFO <span class="number">7232</span> --- [           main] com.louris.springboot.Application        : Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">7232</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">21</span>:<span class="number">52</span>:<span class="number">52.499</span>  INFO <span class="number">7232</span> --- [           main] com.louris.springboot.Application        : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">21</span>:<span class="number">52</span>:<span class="number">53.087</span>  INFO <span class="number">7232</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-14 21:52:53.099  INFO 7232 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-14 21:52:53.099  INFO 7232 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-14 21:52:53.165  INFO 7232 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-14 21:52:53.165  INFO 7232 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 618 ms</span></span><br><span class="line"><span class="function">2021-09-14 21:52:53.191  INFO 7232 --- [           main] f.a.AutowiredAnnotationBeanPostProcessor : Autowired annotation is not supported on <span class="keyword">static</span> fields: <span class="keyword">private</span> <span class="keyword">static</span> com.louris.springboot.IoCImpl.beans.pojo.Role com.louris.springboot.Application.role</span></span><br><span class="line"><span class="function">2021-09-14 21:52:53.266  INFO 7232 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-14 21:52:53.358  INFO 7232 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-14 21:52:53.364  INFO 7232 --- [           main] com.louris.springboot.Application        : Started Application in 1.083 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">1.451</span>)</span></span></span><br><span class="line"><span class="function">Impl2</span></span><br><span class="line"><span class="function">id </span>=<span class="number">1</span></span><br><span class="line">roleName =role_name_1</span><br><span class="line">note =role_note_1</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Qualifier"><a href="#Qualifier" class="headerlink" title="@Qualifier"></a>@Qualifier</h3><p>上面出现的歧义性，重要原因是SPring采用@Autowired是按照type进行注入的，那么如果采用名称查找的方式就可以消除歧义性了，故可以使用@Qualifier注解。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleController</span> </span>{</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(value = <span class="string">"roleServiceImpl"</span>)</span><br><span class="line">    <span class="keyword">private</span> RoleService roleService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRole</span><span class="params">()</span></span>{</span><br><span class="line">        roleService.printRoleInfo();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>该注解设计IoC容器的底层接口——BeanFactory</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException</span>;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="装载带有参数的构造方法类"><a href="#装载带有参数的构造方法类" class="headerlink" title="装载带有参数的构造方法类"></a>装载带有参数的构造方法类</h3><p>@Autowired和@Qualifer可以注解到参数</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleServiceImp2;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleController2</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> RoleService roleService = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    public RoleController2(@Autowired RoleService roleService){</span></span><br><span class="line"><span class="comment">//        this.roleService = roleService;</span></span><br><span class="line"><span class="comment">//    }</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RoleController2</span><span class="params">(@Qualifier(<span class="string">"roleServiceImpl"</span>)</span> RoleService roleService)</span>{</span><br><span class="line">        <span class="keyword">this</span>.roleService = roleService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRole</span><span class="params">()</span></span>{</span><br><span class="line">        roleService.printRoleInfo();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用-Bean装配Bean"><a href="#使用-Bean装配Bean" class="headerlink" title="使用@Bean装配Bean"></a>使用@Bean装配Bean</h3><p>以上都是通过@Component装配Bean，但是@Component只能注解在类上，不能注解到方法上。而对于Java而言，大部分的开发都需要引入第三方的包，而且往往并没有这些包的源码，这时候将无法为这些包的类加入@Component注解，让它们变为开发环境的Bean。</p>
<p>@Bean可以注解到方法之上，并且<strong>将方法返回的对象作为Spring的Bean</strong>，存放在IoC容器中。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"dataSource"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span></span>{</span><br><span class="line">    Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    properties.setProperty(<span class="string">"driver"</span>, <span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">    properties.setProperty(<span class="string">"url"</span>, <span class="string">"jdbc:mysql://localhost:3306/chapter12"</span>);</span><br><span class="line">    properties.setProperty(<span class="string">"username"</span>, <span class="string">"root"</span>);</span><br><span class="line">    properties.setProperty(<span class="string">"password"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>{</span><br><span class="line">        dataSource = BasicDataSourceFactory.createDataSource(properties);</span><br><span class="line">    }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="注解自定义Bean的初始化和销毁方法"><a href="#注解自定义Bean的初始化和销毁方法" class="headerlink" title="注解自定义Bean的初始化和销毁方法"></a>注解自定义Bean的初始化和销毁方法</h3><p>@Bean的配置项：</p>
<ul>
<li>name：是一个字符串数组，允许配置多个BeanName</li>
<li>autowire：标志是否是一个引用的Bean对象，默认值是Autowire.NO</li>
<li>initMethod：自定义初始化方法</li>
<li>destroyMethod：自定义销毁方法</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"juiceMaker2"</span>, initMethod = <span class="string">"init"</span>, destroyMethod = <span class="string">"destroy"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> JuiceMaker2 <span class="title">initJuiceMaker</span><span class="params">()</span></span>{</span><br><span class="line">    JuiceMaker2 juiceMaker2 = <span class="keyword">new</span> JuiceMaker2();</span><br><span class="line">    juiceMaker2.setBeverageShop(<span class="string">"贡茶"</span>);</span><br><span class="line">    Source source = <span class="keyword">new</span> Source();</span><br><span class="line">    source.setFruit(<span class="string">"橙子"</span>);</span><br><span class="line">    source.setSize(<span class="number">2</span>);</span><br><span class="line">    source.setSugar(<span class="string">"少糖"</span>);</span><br><span class="line">    juiceMaker2.setSource(source);</span><br><span class="line">    juiceMaker2.makeJuice();</span><br><span class="line">    <span class="keyword">return</span> juiceMaker2;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> -XX:TieredStopAtLevel=<span class="number">1</span> -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=<span class="keyword">true</span> -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=<span class="keyword">true</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=54328:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-web\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-web-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-autoconfigure-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-logging\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-logging-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-classic\<span class="number">1.2</span><span class="number">.3</span>\logback-classic-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-core\<span class="number">1.2</span><span class="number">.3</span>\logback-core-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\<span class="number">2.13</span><span class="number">.3</span>\log4j-to-slf4j-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-api\<span class="number">2.13</span><span class="number">.3</span>\log4j-api-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\jul-to-slf4j\<span class="number">1.7</span><span class="number">.30</span>\jul-to-slf4j-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\jakarta\annotation\jakarta.annotation-api\<span class="number">1.3</span><span class="number">.5</span>\jakarta.annotation-api-<span class="number">1.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\yaml\snakeyaml\<span class="number">1.27</span>\snakeyaml-<span class="number">1.27</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-json\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-json-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-databind\<span class="number">2.11</span><span class="number">.4</span>\jackson-databind-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\<span class="number">2.11</span><span class="number">.4</span>\jackson-annotations-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-core\<span class="number">2.11</span><span class="number">.4</span>\jackson-core-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jdk8-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jsr310-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\<span class="keyword">module</span>\jackson-<span class="keyword">module</span>-parameter-names\<span class="number">2.11</span><span class="number">.4</span>\jackson-<span class="keyword">module</span>-parameter-names-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-tomcat-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-core-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\glassfish\jakarta.el\<span class="number">3.0</span><span class="number">.3</span>\jakarta.el-<span class="number">3.0</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-web\<span class="number">5.3</span><span class="number">.5</span>\spring-web-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-webmvc\<span class="number">5.3</span><span class="number">.5</span>\spring-webmvc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-aop\<span class="number">5.3</span><span class="number">.5</span>\spring-aop-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-expression\<span class="number">5.3</span><span class="number">.5</span>\spring-expression-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\slf4j-api\<span class="number">1.7</span><span class="number">.30</span>\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-core\<span class="number">5.3</span><span class="number">.5</span>\spring-core-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jcl\<span class="number">5.3</span><span class="number">.5</span>\spring-jcl-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-beans\<span class="number">5.3</span><span class="number">.5</span>\spring-beans-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-context\<span class="number">5.3</span><span class="number">.5</span>\spring-context-<span class="number">5.3</span><span class="number">.5</span>.jar com.louris.springboot.Application</span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  `  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"> </span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v2<span class="number">.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">51</span>:<span class="number">54.224</span>  INFO <span class="number">12836</span> --- [           main] com.louris.springboot.Application        : Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">12836</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">51</span>:<span class="number">54.226</span>  INFO <span class="number">12836</span> --- [           main] com.louris.springboot.Application        : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">51</span>:<span class="number">54.851</span>  INFO <span class="number">12836</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-15 10:51:54.858  INFO 12836 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-15 10:51:54.858  INFO 12836 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-15 10:51:54.918  INFO 12836 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-15 10:51:54.918  INFO 12836 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 658 ms</span></span><br><span class="line"><span class="function">2021-09-15 10:51:54.947  INFO 12836 --- [           main] f.a.AutowiredAnnotationBeanPostProcessor : Autowired annotation is not supported on <span class="keyword">static</span> fields: <span class="keyword">private</span> <span class="keyword">static</span> com.louris.springboot.IoCImpl.beans.pojo.Role com.louris.springboot.Application.role</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用BeanNameAware接口的setBeanName方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用BeanFactoryAware接口的setBeanFactory方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用ApplicationContextAware接口的setApplicationContext方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用Initializing接口的afterPropertiesSet方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】执行自定义初始化方法</span></span><br><span class="line"><span class="function">2021-09-15 10:51:55.030  INFO 12836 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-15 10:51:55.133  INFO 12836 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-15 10:51:55.139  INFO 12836 --- [           main] com.louris.springboot.Application        : Started Application in 1.126 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">1.501</span>)</span></span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="装配的混合使用"><a href="#装配的混合使用" class="headerlink" title="装配的混合使用"></a>装配的混合使用</h2><p>一般本项目中的类通过注解注入，而外部包的类则通过XML进行bean注入。</p>
<h3 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleDataSourceService</span> </span>{</span><br><span class="line">    <span class="function">Role <span class="title">getRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleDataSourceService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ScopedProxyMode;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleDataSourceServiceImpl</span> <span class="keyword">implements</span> <span class="title">RoleDataSourceService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">getRole</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        Role role = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            connection = dataSource.getConnection();</span><br><span class="line">            preparedStatement = connection.prepareStatement(<span class="string">"select id, role_name, note from t_role where id = ?"</span>);</span><br><span class="line">            preparedStatement.setLong(<span class="number">1</span>, id);</span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            <span class="keyword">while</span>(resultSet.next()){</span><br><span class="line">                role = <span class="keyword">new</span> Role();</span><br><span class="line">                role.setId(resultSet.getLong(<span class="string">"id"</span>));</span><br><span class="line">                role.setRoleName(resultSet.getString(<span class="string">"role_name"</span>));</span><br><span class="line">                role.setNote(resultSet.getString(<span class="string">"note"</span>));</span><br><span class="line">            }</span><br><span class="line">        }<span class="keyword">catch</span> (SQLException e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }<span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">try</span>{</span><br><span class="line">                <span class="keyword">if</span>(connection != <span class="keyword">null</span>) connection.close();</span><br><span class="line">            }<span class="keyword">catch</span> (SQLException e){</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> role;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ImportResource;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@ComponentScan(basePackages = {"com.louris.springboot.IoCImpl.beans"})</span></span><br><span class="line"><span class="comment">//@ComponentScan(basePackageClasses = {Role.class})</span></span><br><span class="line"><span class="comment">//@ComponentScan(basePackageClasses = {RoleServiceImpl.class, Role.class})</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = {<span class="string">"com.louris.springboot.IoCImpl.beans"</span>,</span><br><span class="line">        <span class="string">"com.louris.springboot.IoCImpl.controller"</span>,</span><br><span class="line">        <span class="string">"com.louris.springboot.IoCImpl.impl"</span>})</span><br><span class="line"><span class="meta">@ImportResource</span>(locations = <span class="string">"classpath:spring-dataSource.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PojoConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp2.BasicDataSource"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm?serverTimezone=UTC"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- dbcp数据源 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-dbcp2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mysql驱动包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.JuiceMaker2;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Source;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.config.PojoConfig;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.controller.RoleController;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.controller.RoleController2;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleDataSourceServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleDataSourceService;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SpringBoot项目启动入口类</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span>  <span class="comment">//SpringBoot核心朱姐，主要用于开启spring自动配置</span></span><br><span class="line"><span class="comment">//@ImportResource(locations = "classpath:spring-dataSource.xml")</span></span><br><span class="line"><span class="meta">@Import</span>(value = {PojoConfig<span class="class">.<span class="keyword">class</span>})</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">Application</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line"></span><br><span class="line">        ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(PojoConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        RoleDataSourceService roleDataSourceService = applicationContext.getBean(RoleDataSourceServiceImpl<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Role role = roleDataSourceService.getRole(<span class="number">1L</span>);</span><br><span class="line">        System.out.println(role.getRoleName());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> -XX:TieredStopAtLevel=<span class="number">1</span> -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=<span class="keyword">true</span> -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=<span class="keyword">true</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=53592:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-web\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-web-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-autoconfigure-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-logging\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-logging-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-classic\<span class="number">1.2</span><span class="number">.3</span>\logback-classic-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-core\<span class="number">1.2</span><span class="number">.3</span>\logback-core-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\<span class="number">2.13</span><span class="number">.3</span>\log4j-to-slf4j-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-api\<span class="number">2.13</span><span class="number">.3</span>\log4j-api-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\jul-to-slf4j\<span class="number">1.7</span><span class="number">.30</span>\jul-to-slf4j-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\jakarta\annotation\jakarta.annotation-api\<span class="number">1.3</span><span class="number">.5</span>\jakarta.annotation-api-<span class="number">1.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\yaml\snakeyaml\<span class="number">1.27</span>\snakeyaml-<span class="number">1.27</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-json\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-json-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-databind\<span class="number">2.11</span><span class="number">.4</span>\jackson-databind-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\<span class="number">2.11</span><span class="number">.4</span>\jackson-annotations-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-core\<span class="number">2.11</span><span class="number">.4</span>\jackson-core-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jdk8-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jsr310-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\<span class="keyword">module</span>\jackson-<span class="keyword">module</span>-parameter-names\<span class="number">2.11</span><span class="number">.4</span>\jackson-<span class="keyword">module</span>-parameter-names-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-tomcat-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-core-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\glassfish\jakarta.el\<span class="number">3.0</span><span class="number">.3</span>\jakarta.el-<span class="number">3.0</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-web\<span class="number">5.3</span><span class="number">.5</span>\spring-web-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-webmvc\<span class="number">5.3</span><span class="number">.5</span>\spring-webmvc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-aop\<span class="number">5.3</span><span class="number">.5</span>\spring-aop-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-expression\<span class="number">5.3</span><span class="number">.5</span>\spring-expression-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\slf4j-api\<span class="number">1.7</span><span class="number">.30</span>\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-core\<span class="number">5.3</span><span class="number">.5</span>\spring-core-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jcl\<span class="number">5.3</span><span class="number">.5</span>\spring-jcl-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-beans\<span class="number">5.3</span><span class="number">.5</span>\spring-beans-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-context\<span class="number">5.3</span><span class="number">.5</span>\spring-context-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\commons\commons-dbcp2\<span class="number">2.8</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.8</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\commons\commons-pool2\<span class="number">2.9</span><span class="number">.0</span>\commons-pool2-<span class="number">2.9</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\mysql\mysql-connector-java\<span class="number">8.0</span><span class="number">.23</span>\mysql-connector-java-<span class="number">8.0</span><span class="number">.23</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\sun\activation\jakarta.activation\<span class="number">1.2</span><span class="number">.2</span>\jakarta.activation-<span class="number">1.2</span><span class="number">.2</span>.jar com.louris.springboot.Application</span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  `  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"> </span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v2<span class="number">.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">16</span>:<span class="number">03</span>:<span class="number">40.011</span>  INFO <span class="number">28368</span> --- [           main] com.louris.springboot.Application        : Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">28368</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">16</span>:<span class="number">03</span>:<span class="number">40.014</span>  INFO <span class="number">28368</span> --- [           main] com.louris.springboot.Application        : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">16</span>:<span class="number">03</span>:<span class="number">40.706</span>  INFO <span class="number">28368</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-15 16:03:40.712  INFO 28368 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-15 16:03:40.712  INFO 28368 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-15 16:03:41.829  INFO 28368 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-15 16:03:41.829  INFO 28368 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 1774 ms</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用BeanNameAware接口的setBeanName方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用BeanFactoryAware接口的setBeanFactory方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用ApplicationContextAware接口的setApplicationContext方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】调用Initializing接口的afterPropertiesSet方法</span></span><br><span class="line"><span class="function">【JuiceMaker2】执行自定义初始化方法</span></span><br><span class="line"><span class="function">2021-09-15 16:03:41.953  INFO 28368 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-15 16:03:42.051  INFO 28368 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-15 16:03:42.058  INFO 28368 --- [           main] com.louris.springboot.Application        : Started Application in 2.298 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">2.714</span>)</span></span></span><br><span class="line"><span class="function">John</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="加载多个配置文件"><a href="#加载多个配置文件" class="headerlink" title="加载多个配置文件"></a>加载多个配置文件</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan</span>(basePackages = {<span class="string">"com.louris.springboot.IoCImpl.beans"</span>,</span><br><span class="line">        <span class="string">"com.louris.springboot.IoCImpl.controller"</span>,</span><br><span class="line">        <span class="string">"com.louris.springboot.IoCImpl.impl"</span>})</span><br><span class="line"><span class="meta">@ImportResource</span>(locations = <span class="string">"classpath:spring-dataSource.xml"</span>)</span><br><span class="line"><span class="meta">@Import</span>({Config1<span class="class">.<span class="keyword">class</span>, <span class="title">Config2</span>.<span class="title">class</span>})</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">PojoConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>有多个XML配置文件，希望通过其中一个XML文件引入其他的XML文件</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"spring-dataSource.xml"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>或通过<a href="context:component-scan">context:component-scan</a>替换注解@Component</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.louris.springboot.IoCImpl.beans"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="使用Profile"><a href="#使用Profile" class="headerlink" title="使用Profile"></a>使用Profile</h2><p>在软件开发过程中，可能开发人员使用一套环境，而测试人员能使用另一套环境，而这两台系统的数据库是不一样的，毕竟测试人员也需要花费很多时间去构建测试数据，可不想老是被开发人员修改那些测试数据，这样就有了在不同环境中进行切换的需求了。</p>
<h3 id="使用注解-Profile配置"><a href="#使用注解-Profile配置" class="headerlink" title="使用注解@Profile配置"></a>使用注解@Profile配置</h3><p>配置两个数据库连接池，一个用于开发（dev），一个用于测试（test）。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.profile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProfileDataSource</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name=<span class="string">"devDataSource"</span>)</span><br><span class="line">    <span class="meta">@Profile</span>(value = <span class="string">"dev"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDevDataSource</span><span class="params">()</span></span>{</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">"driver"</span>, <span class="string">"com.mysql.cj.jdbc.Driver"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"url"</span>, <span class="string">"jdbc:mysql://localhost:3306/ssm?serverTimezone=UTC"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"username"</span>, <span class="string">"root"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"password"</span>, <span class="string">"123456"</span>);</span><br><span class="line">        DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            dataSource = BasicDataSourceFactory.createDataSource(properties);</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name=<span class="string">"testDataSource"</span>)</span><br><span class="line">    <span class="meta">@Profile</span>(value = <span class="string">"test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getTestDataSource</span><span class="params">()</span></span>{</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">"driver"</span>, <span class="string">"com.mysql.cj.jdbc.Driver"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"url"</span>, <span class="string">"jdbc:mysql://localhost:3306/ssm_test?serverTimezone=UTC"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"username"</span>, <span class="string">"root"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"password"</span>, <span class="string">"123456"</span>);</span><br><span class="line">        DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            dataSource = BasicDataSourceFactory.createDataSource(properties);</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用XML定义Profile"><a href="#使用XML定义Profile" class="headerlink" title="使用XML定义Profile"></a>使用XML定义Profile</h3><h4 id="1-配置文件的profile属性"><a href="#1-配置文件的profile属性" class="headerlink" title="(1)配置文件的profile属性"></a>(1)配置文件的profile属性</h4><p>该属性会导致一个配置文件所有的Bean都放在dev的Profile下；</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">profile</span>=<span class="string">"dev"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp2.BasicDataSource"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm?serverTimezone=UTC"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="2-配置文件的beans元素的profile属性"><a href="#2-配置文件的beans元素的profile属性" class="headerlink" title="(2)配置文件的beans元素的profile属性"></a>(2)配置文件的beans元素的profile属性</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">"dev"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"devDataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp2.BasicDataSource"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm?serverTimezone=UTC"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">"test"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"testDataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp2.BasicDataSource"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm_test?serverTimezone=UTC"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="启动Profile"><a href="#启动Profile" class="headerlink" title="启动Profile"></a>启动Profile</h4><ul>
<li>application.properties核心配置文件</li>
<li>application-dev.properties开发环境核心配置文件</li>
<li>application-test.properties测试环境核心配置文件</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.profiles.active=dev</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.profile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.PropertySource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource</span>(value = <span class="string">"classpath:application.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProfileDataSource</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSource"</span>)</span><br><span class="line">    <span class="meta">@Profile</span>(value = <span class="string">"dev"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDevDataSource</span><span class="params">()</span></span>{</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">"driverClassName"</span>, <span class="string">"com.mysql.cj.jdbc.Driver"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"url"</span>, <span class="string">"jdbc:mysql://localhost:3306/ssm?serverTimezone=UTC"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"username"</span>, <span class="string">"root"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"password"</span>, <span class="string">"123456"</span>);</span><br><span class="line">        DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            dataSource = BasicDataSourceFactory.createDataSource(properties);</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name=<span class="string">"dataSource"</span>)</span><br><span class="line">    <span class="meta">@Profile</span>(<span class="string">"test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getTestDataSource</span><span class="params">()</span></span>{</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">"driver"</span>, <span class="string">"com.mysql.cj.jdbc.Driver"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"url"</span>, <span class="string">"jdbc:mysql://localhost:3306/ssm_test?serverTimezone=UTC"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"username"</span>, <span class="string">"root"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"password"</span>, <span class="string">"123456"</span>);</span><br><span class="line">        DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            dataSource = BasicDataSourceFactory.createDataSource(properties);</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> -XX:TieredStopAtLevel=<span class="number">1</span> -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=<span class="keyword">true</span> -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=<span class="keyword">true</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=65000:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-web\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-web-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-autoconfigure-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-logging\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-logging-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-classic\<span class="number">1.2</span><span class="number">.3</span>\logback-classic-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-core\<span class="number">1.2</span><span class="number">.3</span>\logback-core-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\<span class="number">2.13</span><span class="number">.3</span>\log4j-to-slf4j-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-api\<span class="number">2.13</span><span class="number">.3</span>\log4j-api-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\jul-to-slf4j\<span class="number">1.7</span><span class="number">.30</span>\jul-to-slf4j-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\jakarta\annotation\jakarta.annotation-api\<span class="number">1.3</span><span class="number">.5</span>\jakarta.annotation-api-<span class="number">1.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\yaml\snakeyaml\<span class="number">1.27</span>\snakeyaml-<span class="number">1.27</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-json\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-json-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-databind\<span class="number">2.11</span><span class="number">.4</span>\jackson-databind-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\<span class="number">2.11</span><span class="number">.4</span>\jackson-annotations-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-core\<span class="number">2.11</span><span class="number">.4</span>\jackson-core-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jdk8-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jsr310-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\<span class="keyword">module</span>\jackson-<span class="keyword">module</span>-parameter-names\<span class="number">2.11</span><span class="number">.4</span>\jackson-<span class="keyword">module</span>-parameter-names-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-tomcat-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-core-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\glassfish\jakarta.el\<span class="number">3.0</span><span class="number">.3</span>\jakarta.el-<span class="number">3.0</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-web\<span class="number">5.3</span><span class="number">.5</span>\spring-web-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-webmvc\<span class="number">5.3</span><span class="number">.5</span>\spring-webmvc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-aop\<span class="number">5.3</span><span class="number">.5</span>\spring-aop-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-expression\<span class="number">5.3</span><span class="number">.5</span>\spring-expression-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\slf4j-api\<span class="number">1.7</span><span class="number">.30</span>\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-core\<span class="number">5.3</span><span class="number">.5</span>\spring-core-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jcl\<span class="number">5.3</span><span class="number">.5</span>\spring-jcl-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-beans\<span class="number">5.3</span><span class="number">.5</span>\spring-beans-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-context\<span class="number">5.3</span><span class="number">.5</span>\spring-context-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\commons\commons-dbcp2\<span class="number">2.8</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.8</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\commons\commons-pool2\<span class="number">2.9</span><span class="number">.0</span>\commons-pool2-<span class="number">2.9</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\mysql\mysql-connector-java\<span class="number">8.0</span><span class="number">.23</span>\mysql-connector-java-<span class="number">8.0</span><span class="number">.23</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\sun\activation\jakarta.activation\<span class="number">1.2</span><span class="number">.2</span>\jakarta.activation-<span class="number">1.2</span><span class="number">.2</span>.jar com.louris.springboot.Application</span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  `  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"> </span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v2<span class="number">.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">22</span>:<span class="number">49</span>:<span class="number">14.825</span>  INFO <span class="number">21616</span> --- [           main] com.louris.springboot.Application        : Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">21616</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">22</span>:<span class="number">49</span>:<span class="number">14.826</span>  INFO <span class="number">21616</span> --- [           main] com.louris.springboot.Application        : The following profiles are active: dev</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">15</span> <span class="number">22</span>:<span class="number">49</span>:<span class="number">15.675</span>  INFO <span class="number">21616</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-15 22:49:15.681  INFO 21616 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-15 22:49:15.681  INFO 21616 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-15 22:49:15.752  INFO 21616 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-15 22:49:15.752  INFO 21616 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 891 ms</span></span><br><span class="line"><span class="function">2021-09-15 22:49:15.887  INFO 21616 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-15 22:49:15.995  INFO 21616 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8080 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-15 22:49:16.002  INFO 21616 --- [           main] com.louris.springboot.Application        : Started Application in 1.402 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">1.773</span>)</span></span></span><br><span class="line"><span class="function">John</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="获取ApplicationContext"><a href="#获取ApplicationContext" class="headerlink" title="获取ApplicationContext"></a>获取ApplicationContext</h2><h3 id="自定义新建ApplicationContext"><a href="#自定义新建ApplicationContext" class="headerlink" title="自定义新建ApplicationContext"></a>自定义新建ApplicationContext</h3><h4 id="加载XML配置文件方式"><a href="#加载XML配置文件方式" class="headerlink" title="加载XML配置文件方式"></a>加载XML配置文件方式</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ClassPathXmlApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring-config.xml"</span>);</span><br><span class="line">Role role = (Role)applicationContext.getBean(<span class="string">"role"</span>);</span><br><span class="line">Role role1 = applicationContext.getBean(Role<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="加载注解配置类方式"><a href="#加载注解配置类方式" class="headerlink" title="加载注解配置类方式"></a>加载注解配置类方式</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan</span>(basePackages = {<span class="string">"com.louris.springboot.IoCImpl.beans"</span>})</span><br><span class="line"><span class="comment">//@ComponentScan(basePackageClasses = {Role.class})</span></span><br><span class="line"><span class="comment">//@ComponentScan(basePackageClasses = {RoleServiceImpl.class, Role.class})</span></span><br><span class="line"><span class="meta">@Configuration</span>  <span class="comment">//配置类</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = {<span class="string">"com.louris.springboot.IoCImpl"</span>}) <span class="comment">//扫描包下的Beans</span></span><br><span class="line"><span class="comment">//@ImportResource(locations = "classpath:spring-dataSource.xml") //引入资源配置文件</span></span><br><span class="line"><span class="meta">@PropertySource</span>(value = <span class="string">"classpath:application.properties"</span>, ignoreResourceNotFound = <span class="keyword">false</span>) <span class="comment">//引入配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PojoConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(PojoConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">Role role = (Role)applicationContext.getBean(<span class="string">"role"</span>);</span><br><span class="line">Role role1 = applicationContext.getBean(Role<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="启动类方式"><a href="#启动类方式" class="headerlink" title="启动类方式"></a>启动类方式</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = SpringApplication.run(Application.class, args);</span><br><span class="line">Role role = (Role)applicationContext.getBean("role");</span><br><span class="line">Role role1 = applicationContext.getBean(Role.class);</span><br></pre></td></tr></tbody></table></figure>

<h2 id="加载属性（properties）文件"><a href="#加载属性（properties）文件" class="headerlink" title="加载属性（properties）文件"></a>加载属性（properties）文件</h2><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server.port=8081</span><br><span class="line"># 设置连接数据库的信息</span><br><span class="line">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br><span class="line">spring.datasource.url=jdbc:mysql://localhost:3306/ssm?useUnicode=true&amp;characterEncoding=UTF-8&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=GMT%2B8</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=123456</span><br><span class="line"></span><br><span class="line">spring.datasource.type=org.apache.commons.dbcp2.BasicDataSource</span><br><span class="line">spring.datasource.dbcp2.max-idle=10</span><br><span class="line">spring.datasource.dbcp2.max-total=50</span><br><span class="line">spring.datasource.dbcp2.max-wait-millis=10000</span><br></pre></td></tr></tbody></table></figure>

<h2 id="使用注解方式加载属性文件"><a href="#使用注解方式加载属性文件" class="headerlink" title="使用注解方式加载属性文件"></a>使用注解方式加载属性文件</h2><h3 id="PropertySource注解"><a href="#PropertySource注解" class="headerlink" title="@PropertySource注解"></a>@PropertySource注解</h3><ul>
<li>name: 字符串，配置这次属性配置的名称</li>
<li>value：字符串数组，可以配置多个属性文件</li>
<li>ignoreResourceNotFound：默认false，找不到对应配置文件会抛出异常<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource</span>(value = <span class="string">"classpath:application.properties"</span>, ignoreResourceNotFound = <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProfileDataSource</span> </span>{}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(PojoConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">String url = applicationContext.getEnvironment().getProperty(<span class="string">"spring.datasource.url"</span>);</span><br><span class="line">System.out.println(url);</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> -XX:TieredStopAtLevel=<span class="number">1</span> -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=<span class="keyword">true</span> -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=<span class="keyword">true</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=62587:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-web\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-web-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-autoconfigure-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-logging\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-logging-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-classic\<span class="number">1.2</span><span class="number">.3</span>\logback-classic-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-core\<span class="number">1.2</span><span class="number">.3</span>\logback-core-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\<span class="number">2.13</span><span class="number">.3</span>\log4j-to-slf4j-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-api\<span class="number">2.13</span><span class="number">.3</span>\log4j-api-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\jul-to-slf4j\<span class="number">1.7</span><span class="number">.30</span>\jul-to-slf4j-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\jakarta\annotation\jakarta.annotation-api\<span class="number">1.3</span><span class="number">.5</span>\jakarta.annotation-api-<span class="number">1.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\yaml\snakeyaml\<span class="number">1.27</span>\snakeyaml-<span class="number">1.27</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-json\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-json-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-databind\<span class="number">2.11</span><span class="number">.4</span>\jackson-databind-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\<span class="number">2.11</span><span class="number">.4</span>\jackson-annotations-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-core\<span class="number">2.11</span><span class="number">.4</span>\jackson-core-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jdk8-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jsr310-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\<span class="keyword">module</span>\jackson-<span class="keyword">module</span>-parameter-names\<span class="number">2.11</span><span class="number">.4</span>\jackson-<span class="keyword">module</span>-parameter-names-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-tomcat-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-core-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\glassfish\jakarta.el\<span class="number">3.0</span><span class="number">.3</span>\jakarta.el-<span class="number">3.0</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-web\<span class="number">5.3</span><span class="number">.5</span>\spring-web-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-webmvc\<span class="number">5.3</span><span class="number">.5</span>\spring-webmvc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-aop\<span class="number">5.3</span><span class="number">.5</span>\spring-aop-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-expression\<span class="number">5.3</span><span class="number">.5</span>\spring-expression-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\slf4j-api\<span class="number">1.7</span><span class="number">.30</span>\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-core\<span class="number">5.3</span><span class="number">.5</span>\spring-core-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jcl\<span class="number">5.3</span><span class="number">.5</span>\spring-jcl-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-beans\<span class="number">5.3</span><span class="number">.5</span>\spring-beans-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-context\<span class="number">5.3</span><span class="number">.5</span>\spring-context-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\commons\commons-dbcp2\<span class="number">2.8</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.8</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\commons\commons-pool2\<span class="number">2.9</span><span class="number">.0</span>\commons-pool2-<span class="number">2.9</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\mysql\mysql-connector-java\<span class="number">8.0</span><span class="number">.23</span>\mysql-connector-java-<span class="number">8.0</span><span class="number">.23</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\sun\activation\jakarta.activation\<span class="number">1.2</span><span class="number">.2</span>\jakarta.activation-<span class="number">1.2</span><span class="number">.2</span>.jar com.louris.springboot.Application</span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  `  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"> </span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v2<span class="number">.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">16</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">18.644</span>  INFO <span class="number">27900</span> --- [           main] com.louris.springboot.Application        : Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">27900</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">16</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">18.646</span>  INFO <span class="number">27900</span> --- [           main] com.louris.springboot.Application        : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">16</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">19.280</span>  INFO <span class="number">27900</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8081 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-16 10:17:19.286  INFO 27900 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-16 10:17:19.286  INFO 27900 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-16 10:17:19.350  INFO 27900 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-16 10:17:19.350  INFO 27900 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 676 ms</span></span><br><span class="line"><span class="function">2021-09-16 10:17:19.449  INFO 27900 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-16 10:17:19.548  INFO 27900 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8081 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-16 10:17:19.555  INFO 27900 --- [           main] com.louris.springboot.Application        : Started Application in 1.126 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">1.504</span>)</span></span></span><br><span class="line"><span class="function">jdbc:mysql:<span class="comment">//localhost:3306/ssm?useUnicode=true&amp;characterEncoding=UTF-8&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=GMT%2B8</span></span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="PropertySourcesPlaceholderConfigure-Value注解"><a href="#PropertySourcesPlaceholderConfigure-Value注解" class="headerlink" title="@PropertySourcesPlaceholderConfigure + @Value注解"></a>@PropertySourcesPlaceholderConfigure + @Value注解</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.PropertySourcesPlaceholderConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@ComponentScan(basePackages = {"com.louris.springboot.IoCImpl.beans"})</span></span><br><span class="line"><span class="comment">//@ComponentScan(basePackageClasses = {Role.class})</span></span><br><span class="line"><span class="comment">//@ComponentScan(basePackageClasses = {RoleServiceImpl.class, Role.class})</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = {<span class="string">"com.louris.springboot.IoCImpl"</span>})</span><br><span class="line"><span class="comment">//@ImportResource(locations = "classpath:spring-dataSource.xml")</span></span><br><span class="line"><span class="meta">@PropertySource</span>(value = <span class="string">"classpath:application-dev.properties"</span>, ignoreResourceNotFound = <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PojoConfig</span> </span>{</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PropertySourcesPlaceholderConfigurer <span class="title">getPropertySourcesPlaceholderConfigurer</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PropertySourcesPlaceholderConfigurer();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.profile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@Profile(value = "dev")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProfileDataSource</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"${spring.datasource.driver-class-name}"</span>)</span><br><span class="line">    <span class="keyword">private</span> String driver = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"${spring.datasource.url}"</span>)</span><br><span class="line">    <span class="keyword">private</span> String url = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"${spring.datasource.username}"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"${spring.datasource.password}"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span></span>{</span><br><span class="line">         Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">         properties.setProperty(<span class="string">"driver"</span>, driver);</span><br><span class="line">         properties.setProperty(<span class="string">"usrl"</span>, url);</span><br><span class="line">         properties.setProperty(<span class="string">"username"</span>, username);</span><br><span class="line">         properties.setProperty(<span class="string">"password"</span>, password);</span><br><span class="line">         DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line">         <span class="keyword">try</span>{</span><br><span class="line">             dataSource = BasicDataSourceFactory.createDataSource(properties);</span><br><span class="line">         }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">         }</span><br><span class="line">         <span class="keyword">return</span> dataSource;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用XML方式加载属性文件"><a href="#使用XML方式加载属性文件" class="headerlink" title="使用XML方式加载属性文件"></a>使用XML方式加载属性文件</h3><p>略过。</p>
<h2 id="条件化装配Bean"><a href="#条件化装配Bean" class="headerlink" title="条件化装配Bean"></a>条件化装配Bean</h2><p>比如根据属性文件中的数据源信息进行装配Bean，如果属性不完整，则会创建失败。</p>
<h3 id="自定义条件类"><a href="#自定义条件类" class="headerlink" title="自定义条件类"></a>自定义条件类</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Condition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ConditionContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotatedTypeMetadata;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceCondition</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext conditionContext, AnnotatedTypeMetadata annotatedTypeMetadata)</span> </span>{</span><br><span class="line">        <span class="comment">//获取上下文环境</span></span><br><span class="line">        Environment environment = conditionContext.getEnvironment();</span><br><span class="line">        <span class="comment">//判断是否存在关于数据源的基础配置</span></span><br><span class="line">        <span class="keyword">return</span> environment.containsProperty(<span class="string">"spring.datasource.driver"</span>)</span><br><span class="line">                &amp;&amp; environment.containsProperty(<span class="string">"spring.datasource.url"</span>)</span><br><span class="line">                &amp;&amp; environment.containsProperty(<span class="string">"spring.datasource.username"</span>)</span><br><span class="line">                &amp;&amp; environment.containsProperty(<span class="string">"spring.datasource.password"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Conditional注解"><a href="#Conditional注解" class="headerlink" title="@Conditional注解"></a>@Conditional注解</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.profile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.config.DataSourceCondition;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProfileDataSource</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"${spring.datasource.driver}"</span>)</span><br><span class="line">    <span class="keyword">private</span> String driver = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"${spring.datasource.url}"</span>)</span><br><span class="line">    <span class="keyword">private</span> String url = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"${spring.datasource.username}"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"${spring.datasource.password}"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSource"</span>)</span><br><span class="line">    <span class="meta">@Conditional</span>(value = {DataSourceCondition<span class="class">.<span class="keyword">class</span>})</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">DataSource</span> <span class="title">getDataSource</span>()</span>{</span><br><span class="line">         Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">         properties.setProperty(<span class="string">"driver"</span>, driver);</span><br><span class="line">         properties.setProperty(<span class="string">"url"</span>, url);</span><br><span class="line">         properties.setProperty(<span class="string">"username"</span>, username);</span><br><span class="line">         properties.setProperty(<span class="string">"password"</span>, password);</span><br><span class="line">         System.out.println(properties.getProperty(<span class="string">"username"</span>));</span><br><span class="line">         DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line">         <span class="keyword">try</span>{</span><br><span class="line">             dataSource = BasicDataSourceFactory.createDataSource(properties);</span><br><span class="line">         }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">         }</span><br><span class="line">         <span class="keyword">return</span> dataSource;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Bean的作用域"><a href="#Bean的作用域" class="headerlink" title="Bean的作用域"></a>Bean的作用域</h2><ul>
<li>单例（singleton）：它是默认的选项，在整个应用中，Spring只为其生成一个Bean的实例；</li>
<li>原型（prototype）：当每次注入，或者通过Spring IoC容器获取Bean时，Spring都会为它创建一个新的实例；</li>
<li>会话（session）：在Web应用中使用，就是在会话过程中Spring只创建一个实例；</li>
<li>请求（request）：在Web应用中使用，就是一个请求中Spring会创建一个实例；</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.beans.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Scope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(value = <span class="string">"role"</span>)</span><br><span class="line"><span class="meta">@Scope</span>(value = <span class="string">"prototype"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>{</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"1"</span>)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"role_name_1"</span>)</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"role_note_1"</span>)</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Role</span><span class="params">()</span></span>{}</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Role</span><span class="params">(Long id, String roleName, String note)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoleName</span><span class="params">(String roleName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoleName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(PojoConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">Role role = applicationContext.getBean(Role<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">Role role1 = applicationContext.getBean(Role<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">System.out.println(role == role1);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> -XX:TieredStopAtLevel=<span class="number">1</span> -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=<span class="keyword">true</span> -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=<span class="keyword">true</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=59884:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-web\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-web-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-autoconfigure-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-logging\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-logging-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-classic\<span class="number">1.2</span><span class="number">.3</span>\logback-classic-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-core\<span class="number">1.2</span><span class="number">.3</span>\logback-core-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\<span class="number">2.13</span><span class="number">.3</span>\log4j-to-slf4j-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-api\<span class="number">2.13</span><span class="number">.3</span>\log4j-api-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\jul-to-slf4j\<span class="number">1.7</span><span class="number">.30</span>\jul-to-slf4j-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\jakarta\annotation\jakarta.annotation-api\<span class="number">1.3</span><span class="number">.5</span>\jakarta.annotation-api-<span class="number">1.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\yaml\snakeyaml\<span class="number">1.27</span>\snakeyaml-<span class="number">1.27</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-json\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-json-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-databind\<span class="number">2.11</span><span class="number">.4</span>\jackson-databind-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\<span class="number">2.11</span><span class="number">.4</span>\jackson-annotations-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-core\<span class="number">2.11</span><span class="number">.4</span>\jackson-core-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jdk8-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jsr310-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\<span class="keyword">module</span>\jackson-<span class="keyword">module</span>-parameter-names\<span class="number">2.11</span><span class="number">.4</span>\jackson-<span class="keyword">module</span>-parameter-names-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-tomcat-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-core-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\glassfish\jakarta.el\<span class="number">3.0</span><span class="number">.3</span>\jakarta.el-<span class="number">3.0</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-web\<span class="number">5.3</span><span class="number">.5</span>\spring-web-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-webmvc\<span class="number">5.3</span><span class="number">.5</span>\spring-webmvc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-aop\<span class="number">5.3</span><span class="number">.5</span>\spring-aop-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-expression\<span class="number">5.3</span><span class="number">.5</span>\spring-expression-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\slf4j-api\<span class="number">1.7</span><span class="number">.30</span>\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-core\<span class="number">5.3</span><span class="number">.5</span>\spring-core-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jcl\<span class="number">5.3</span><span class="number">.5</span>\spring-jcl-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-beans\<span class="number">5.3</span><span class="number">.5</span>\spring-beans-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-context\<span class="number">5.3</span><span class="number">.5</span>\spring-context-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\commons\commons-dbcp2\<span class="number">2.8</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.8</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\commons\commons-pool2\<span class="number">2.9</span><span class="number">.0</span>\commons-pool2-<span class="number">2.9</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\mysql\mysql-connector-java\<span class="number">8.0</span><span class="number">.23</span>\mysql-connector-java-<span class="number">8.0</span><span class="number">.23</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\sun\activation\jakarta.activation\<span class="number">1.2</span><span class="number">.2</span>\jakarta.activation-<span class="number">1.2</span><span class="number">.2</span>.jar com.louris.springboot.Application</span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  ·  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"> </span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v2<span class="number">.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">16</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">21.885</span>  INFO <span class="number">21908</span> --- [           main] com.louris.springboot.Application        : Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">21908</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">16</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">21.887</span>  INFO <span class="number">21908</span> --- [           main] com.louris.springboot.Application        : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">16</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">22.297</span>  INFO <span class="number">21908</span> --- [           main] o.s.c.a.ConfigurationClassEnhancer       : <span class="meta">@Bean</span> method PojoConfig.getPropertySourcesPlaceholderConfigurer is non-<span class="keyword">static</span> and returns an object assignable to Spring<span class="string">'s BeanFactoryPostProcessor interface. This will result in a failure to process annotations such as @Autowired, @Resource and @PostConstruct within the method'</span>s declaring <span class="meta">@Configuration</span> <span class="class"><span class="keyword">class</span>. <span class="title">Add</span> <span class="title">the</span> '<span class="title">static</span>' <span class="title">modifier</span> <span class="title">to</span> <span class="title">this</span> <span class="title">method</span> <span class="title">to</span> <span class="title">avoid</span> <span class="title">these</span> <span class="title">container</span> <span class="title">lifecycle</span> <span class="title">issues</span></span>; see <span class="meta">@Bean</span> javadoc <span class="keyword">for</span> complete details.</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">16</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">22.485</span>  INFO <span class="number">21908</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8081 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-16 21:42:22.492  INFO 21908 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-16 21:42:22.493  INFO 21908 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-16 21:42:22.556  INFO 21908 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-16 21:42:22.556  INFO 21908 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 641 ms</span></span><br><span class="line"><span class="function">2021-09-16 21:42:22.671  INFO 21908 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-16 21:42:22.772  INFO 21908 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8081 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-16 21:42:22.778  INFO 21908 --- [           main] com.louris.springboot.Application        : Started Application in 1.109 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">1.488</span>)</span></span></span><br><span class="line"><span class="function">2021-09-16 21:42:22.793  INFO 21908 --- [           main] o.s.c.a.ConfigurationClassEnhancer       : @Bean method PojoConfig.getPropertySourcesPlaceholderConfigurer is non-<span class="keyword">static</span> and returns an object assignable to Spring's BeanFactoryPostProcessor interface. This will result in a failure to process annotations such as @Autowired, @Resource and @PostConstruct within the method's declaring @Configuration class. Add the '<span class="keyword">static</span>' modifier to <span class="keyword">this</span> method to avoid these container lifecycle issues</span>; see <span class="meta">@Bean</span> javadoc <span class="keyword">for</span> complete details.</span><br><span class="line"><span class="keyword">false</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="使用Spring表达式（Spring-EL）"><a href="#使用Spring表达式（Spring-EL）" class="headerlink" title="使用Spring表达式（Spring EL）"></a>使用Spring表达式（Spring EL）</h2><p>Spring还提供了更灵活的注入方式，那就是Spring表达式。</p>
<h3 id="Spring-EL-相关的类"><a href="#Spring-EL-相关的类" class="headerlink" title="Spring EL 相关的类"></a>Spring EL 相关的类</h3><ul>
<li>ExpressionParser</li>
<li>TemplateAwareExpressionParser(abstract)</li>
<li>InternalSpelExpressionParser</li>
<li>SpelExpressionParser</li>
</ul>
<h3 id="表达式创建对象，调用对象方法"><a href="#表达式创建对象，调用对象方法" class="headerlink" title="表达式创建对象，调用对象方法"></a>表达式创建对象，调用对象方法</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//表达式解析器</span></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line"><span class="comment">//设置表达式</span></span><br><span class="line">Expression expression = parser.parseExpression(<span class="string">"'hello world'"</span>);</span><br><span class="line">String str = (String) expression.getValue();</span><br><span class="line">System.out.println(str);</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过EL访问普通方法</span></span><br><span class="line">expression = parser.parseExpression(<span class="string">"'hello world'.charAt(0)"</span>);</span><br><span class="line"><span class="keyword">char</span> ch = (Character) expression.getValue();</span><br><span class="line">System.out.println(ch);</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过EL访问的getter方法</span></span><br><span class="line">expression = parser.parseExpression(<span class="string">"'hello world'.bytes"</span>);</span><br><span class="line"><span class="keyword">byte</span>[] bytes = (<span class="keyword">byte</span>[]) expression.getValue();</span><br><span class="line">System.out.println(bytes);</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过EL访问属性，相当于“hello world".getBytes().length</span></span><br><span class="line">expression = parser.parseExpression(<span class="string">"'hello world'.bytes.length"</span>);</span><br><span class="line"><span class="keyword">int</span> length = (Integer) expression.getValue();</span><br><span class="line">System.out.println(length);</span><br><span class="line"></span><br><span class="line">expression = parser.parseExpression(<span class="string">"new String('abc')"</span>);</span><br><span class="line">String abc = (String) expression.getValue();</span><br><span class="line">System.out.println(abc);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建角色对象</span></span><br><span class="line">Role role = <span class="keyword">new</span> Role(<span class="number">1L</span>, <span class="string">"role_name"</span>, <span class="string">"note"</span>);</span><br><span class="line">expression = parser.parseExpression(<span class="string">"note"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//相当于从role中获取备注信息</span></span><br><span class="line">String note = (String) expression.getValue(role);</span><br><span class="line">System.out.println(note);</span><br><span class="line"></span><br><span class="line"><span class="comment">//变量环境类，并且将角色对象role作为其根节点</span></span><br><span class="line">EvaluationContext ctx = <span class="keyword">new</span> StandardEvaluationContext(role);</span><br><span class="line"><span class="comment">//变量环境类操作根节点</span></span><br><span class="line">parser.parseExpression(<span class="string">"note"</span>).setValue(ctx, <span class="string">"new_note"</span>);</span><br><span class="line"><span class="comment">//获取备注，这里的String.class指明，我们希望返回的是一个字符串</span></span><br><span class="line">note = parser.parseExpression(<span class="string">"note"</span>).getValue(ctx, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">System.out.println(note);</span><br><span class="line"><span class="comment">//调用getRoleName方法</span></span><br><span class="line">String roleName = parser.parseExpression(<span class="string">"getRoleName()"</span>).getValue(ctx, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">System.out.println(roleName);</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增环境变量</span></span><br><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">list.add(<span class="string">"value1"</span>);</span><br><span class="line">list.add(<span class="string">"value2"</span>);</span><br><span class="line"><span class="comment">//给变量环境增加变量</span></span><br><span class="line">ctx.setVariable(<span class="string">"list"</span>, list);</span><br><span class="line"><span class="comment">//通过表达式去读/写环境变量的值</span></span><br><span class="line">parser.parseExpression(<span class="string">"#list[1]"</span>).setValue(ctx, <span class="string">"update_value2"</span>);</span><br><span class="line">System.out.println(parser.parseExpression(<span class="string">"#list[1]"</span>).getValue(ctx));</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hello world</span><br><span class="line">h</span><br><span class="line">B@<span class="number">2</span>da3b078</span><br><span class="line"><span class="number">11</span></span><br><span class="line">abc</span><br><span class="line">note</span><br><span class="line">new_note</span><br><span class="line">role_name</span><br><span class="line">update_value2</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Bean的属性和方法"><a href="#Bean的属性和方法" class="headerlink" title="Bean的属性和方法"></a>Bean的属性和方法</h3><p>@Value</p>
<ul>
<li>直接字符串表示赋值</li>
<li>#{}表示Spring EL</li>
<li>${}表示使用配置文件内的属性<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.beans.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Scope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(value = <span class="string">"role"</span>)</span><br><span class="line"><span class="comment">//@Scope(value = "prototype")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>{</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#{1}"</span>)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#{'role_name_1'}"</span>)</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#{'role_note_1'}"</span>)</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Role</span><span class="params">()</span></span>{}</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Role</span><span class="params">(Long id, String roleName, String note)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoleName</span><span class="params">(String roleName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoleName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElBean</span></span>{</span><br><span class="line"></span><br><span class="line">  <span class="comment">//同过beanName获取bean，然后注入</span></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"#{role}"</span>)</span><br><span class="line">  <span class="keyword">private</span> Role role;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//获取bean的属性id</span></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"#{role.id}"</span>)</span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//调用bean的getNote方法，获取角色名称</span></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"#{role.getNote()?.toString()}"</span>) <span class="comment">//?表示当getNote()不为空，则调用toString()方法</span></span><br><span class="line">  <span class="keyword">private</span> String note;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h3 id="使用类的静态常量和方法"><a href="#使用类的静态常量和方法" class="headerlink" title="使用类的静态常量和方法"></a>使用类的静态常量和方法</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"#{T(Math).PI}"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">double</span> pi;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#{T(java.lang.Math).PT}"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">double</span> pi;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#{T(Math).random()}"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">double</span> random;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Spring-EL运算"><a href="#Spring-EL运算" class="headerlink" title="Spring EL运算"></a>Spring EL运算</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"#{role.id + 1}"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> num;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#{role.roleName + role.note}"</span>)</span><br><span class="line">pring String str;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#{role.id == 1}"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> equalNum;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#{role.id &gt; 1 ? 5 : 1}"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> max;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#{role.note ? : 'hello'}"</span>)</span><br><span class="line"><span class="keyword">private</span> String defaultString;</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="面向切面编程"><a href="#面向切面编程" class="headerlink" title="面向切面编程"></a>面向切面编程</h1></blockquote>
<h2 id="一个简单的约定游戏"><a href="#一个简单的约定游戏" class="headerlink" title="一个简单的约定游戏"></a>一个简单的约定游戏</h2><h3 id="约定规则"><a href="#约定规则" class="headerlink" title="约定规则"></a>约定规则</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.aop.interceptors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Interceptor</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">before</span><span class="params">(Object object)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">after</span><span class="params">(Object object)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(Object object)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">(Object object)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.aop.interceptors.Interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyBeanFactory</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(T object, Interceptor interceptor)</span></span>{</span><br><span class="line">        <span class="keyword">return</span> (T) ProxyBeanUtil.getBean(object, interceptor);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.aop.interceptors.Interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyBeanUtil</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//被代理对象</span></span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拦截器</span></span><br><span class="line">    <span class="keyword">private</span> Interceptor interceptor = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取动态代理对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object 被代理对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interceptor 拦截器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(Object object, Interceptor interceptor)</span></span>{</span><br><span class="line">        <span class="comment">//使用当前类，作为代理方法，此时被代理对象执行方法的时候，会进入当前类的invoke方法里</span></span><br><span class="line">        ProxyBeanUtil _this = <span class="keyword">new</span> ProxyBeanUtil();</span><br><span class="line">        <span class="comment">//保存被代理对象</span></span><br><span class="line">        _this.object = object;</span><br><span class="line">        <span class="comment">//保存拦截器</span></span><br><span class="line">        _this.interceptor = interceptor;</span><br><span class="line">        <span class="comment">//生成代理对象，并绑定代理方法</span></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(object.getClass().getClassLoader(),</span><br><span class="line">                object.getClass().getInterfaces(), _this);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">        Object retObj = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//是否产生异常</span></span><br><span class="line">        <span class="keyword">boolean</span> exceptionFlag = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//before方法</span></span><br><span class="line">        interceptor.before(object);</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="comment">//反射原有方法</span></span><br><span class="line">            retObj = method.invoke(object, args);</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            exceptionFlag = <span class="keyword">true</span>;</span><br><span class="line">        }<span class="keyword">finally</span> {</span><br><span class="line">            <span class="comment">//after方法</span></span><br><span class="line">            interceptor.after(object);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(exceptionFlag){</span><br><span class="line">            <span class="comment">//afterThrowing方法</span></span><br><span class="line">            interceptor.afterThrowing(object);</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            <span class="comment">//afterReturning方法</span></span><br><span class="line">            interceptor.afterReturning(object);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> retObj;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RoleService1 roleService1 = <span class="keyword">new</span> RoleServiceImpl1();</span><br><span class="line">Interceptor interceptor = <span class="keyword">new</span> RoleInterceptor();</span><br><span class="line">RoleService1 proxy = ProxyBeanFactory.getBean(roleService1, interceptor);</span><br><span class="line">Role role = <span class="keyword">new</span> Role(<span class="number">1L</span>, <span class="string">"role_name_1"</span>, <span class="string">"role_note_1"</span>);</span><br><span class="line">proxy.printRole(role);</span><br><span class="line">System.out.println(<span class="string">"########## 测试 afterthrowing 方法 ##########"</span>);</span><br><span class="line">role = <span class="keyword">null</span>;</span><br><span class="line">proxy.printRole(role);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">准备打印角色信息</span><br><span class="line">{id =<span class="number">1</span>, roleName=role_name_1,note=role_note_1}</span><br><span class="line">已经完成角色信息的打印处理</span><br><span class="line">刚刚完成打印功能，一切正常。</span><br><span class="line">########## 测试 afterthrowing 方法 ##########</span><br><span class="line">准备打印角色信息</span><br><span class="line">已经完成角色信息的打印处理</span><br><span class="line">打印功能执行异常了，查看一下角色对象为空了吗？</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Spring-AOP的基本概念"><a href="#Spring-AOP的基本概念" class="headerlink" title="Spring AOP的基本概念"></a>Spring AOP的基本概念</h2><h3 id="AOP的概念和使用原因"><a href="#AOP的概念和使用原因" class="headerlink" title="AOP的概念和使用原因"></a>AOP的概念和使用原因</h3><p>现实中有一些内容并不是面向对象（OOP）可以解决的，比如数据库事务，又如电商网站购物需要经过交易系统、财务系统，对于交易系统存在一个交易记录的对象，而财务系统则存在账户的信息对象。从这个角度而言，我们需要对交易记录和账户操作形成一个统一的事务管理。交易和账户的事务，要么全部成功，要么全部失败。</p>
<h4 id="JDBC数据库事务"><a href="#JDBC数据库事务" class="headerlink" title="JDBC数据库事务"></a>JDBC数据库事务</h4><p>这里购买交易的产品和购买记录都在try…catch…finally…语句中，首先需要自己去获取对应的映射器，而业务流程中穿插着事务的提交和回滚，也就是如果交易可以成功，那么就会提交事务，交易如果发生异常，那么就回滚事务，最后在finally语句中会关闭SqlSession所持有的功能。</p>
<p>但这不是一个很好的设计。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">savePurchaseRecord</span><span class="params">(Long productId, PurchaseRecord record)</span></span>{</span><br><span class="line">    SqlSession sqlSession = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>{</span><br><span class="line">        sqlSession = SqlSessionFactoryUtils.openSqlSession();</span><br><span class="line">        ProductMapper productMapper = sqlSession.getMapper(ProductMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Product product = productMapper.getRole(productId);</span><br><span class="line">        <span class="comment">//判断库存是否大于购买数量</span></span><br><span class="line">        <span class="keyword">if</span>(product.getStock() &gt;= record.getQuantity()){</span><br><span class="line">            <span class="comment">//减库存，并更新数据库记录</span></span><br><span class="line">            product.setStock(product.getStock() - record.getQuantity());</span><br><span class="line">            productMapper.update(product);</span><br><span class="line">            <span class="comment">//保存交易记录</span></span><br><span class="line">            PurchaseRecordMapper purchaseRecordMapper = sqlSession.getMapper(PurchaseRecordMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            purchaseRecordMapper.save(record);</span><br><span class="line">            sqlSession.commit();</span><br><span class="line">        }</span><br><span class="line">    }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">        <span class="comment">//异常回滚事务</span></span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        sqlSession.rollback();</span><br><span class="line">    }<span class="keyword">finally</span> {</span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        <span class="keyword">if</span>(sqlSession != <span class="keyword">null</span>) sqlSession.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Spring-AOP对应数据库事务"><a href="#Spring-AOP对应数据库事务" class="headerlink" title="Spring AOP对应数据库事务"></a>Spring AOP对应数据库事务</h4><p>该代码除了一个注解@Transactional，没有任何关于打开或者关闭数据库资源的代码，更没有任何提交或者回滚数据库事务的代码，但是它却能完成上一节的全部功能。</p>
<p>注意，这段代码更简介，也更容易维护，主要都集中在业务处理上，而不是数据库事务和资源管控上，这就是AOP的魅力；</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProductMapper productMapper = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> PurchaseRecordMapper purchaseRecordMapper = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateRoleNote</span><span class="params">(Long productId, PurchaseRecord record)</span></span>{</span><br><span class="line">    Product product = productMapper.getRole(productId);</span><br><span class="line">    <span class="comment">//判断库存是否大于购买数量</span></span><br><span class="line">    <span class="keyword">if</span>(product.getStock() &gt;= record.getQuantity()){</span><br><span class="line">        <span class="comment">//减库存，并更新数据库记录</span></span><br><span class="line">        product.setStock(product.getStock() - record.getQuantity());</span><br><span class="line">        productMapper.update(product);</span><br><span class="line">        <span class="comment">//保存交易记录</span></span><br><span class="line">        purchaseRecordMapper.save(record);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>一个正常的SQL步骤：</p>
<ul>
<li>打开通过数据库连接池获取数据库连接资源，并做一定的设置工作；</li>
<li>执行对应的SQL语句，对数据进行操作；</li>
<li>如果SQL执行过程中发生异常，回滚事务；</li>
<li>如果SQL执行过程中没有发生异常，最后提交事务；</li>
<li>到最后的阶段，需要关闭一些连接资源。</li>
</ul>
<p>该过程与之前约定游戏的流程十分接近，也就说作为AOP，完全可以根据这个流程做一定的封装，然后通过动态代理技术，将代码组织入对应的流程环节。</p>
<p>流程如下：</p>
<ul>
<li>打开获取数据库连接在before方法中完成；</li>
<li>执行SQL，按照读者的逻辑会采用反射的机制调用；</li>
<li>如果发生异常，则回滚事务；如果没有发生异常，则提交事务，然后关闭数据库连接资源；</li>
</ul>
<p>如果一个AOP框架不需要我们去实现流程中的方法，而是在流程中提供一些通用的方法，并可以通过一定的配置满足各种功能，比如AOP框架帮助你完成了获取数据库，你就不需要知道如何获取数据库连接功能了，此外再增加一些关于事务的重要约定：</p>
<ul>
<li>在方法标注为@Transactional时，则方法启用数据库事务功能；</li>
<li>在默认的情况下，如果原有方法出现异常，则回滚事务；如果没有发生异常，那么就提交事务，这样真个事务管理AOP就完成了整个流程，无须开发者编写任何代码去实现；</li>
<li>最后关闭数据库资源，这点也比较通用，这里AOP框架也帮你完成它。</li>
</ul>
<p>这是使用最广的执行流程，符合约定优于配置的开发原则。这些约定的方法加入默认实现后，开发者需要做的只是执行SQL这步而已。大部分情况下，只需要使用默认的约定即可，或者进行一些特定的配置，来完成所需的功能，这样开发者就可以更为关注业务开发，而不是资源控制、事务异常处理，这些AOP框架都可以完成。</p>
<h3 id="面向切面编程的术语"><a href="#面向切面编程的术语" class="headerlink" title="面向切面编程的术语"></a>面向切面编程的术语</h3><p>1、切面（Aspect）<br>切面就是在一个怎样的环境中工作，比如上一节，数据库的事务直接贯穿整个代码层面，这就是一个切面，它能够在被代理对象的方法之前、之后，产生异常或者正常返回后切入你的代码，甚至代替原来被代理对象的方法。</p>
<p>2、通知（Adice）<br>通知是切面开启后，切面的方法。它根据在代理对象真实方法调用前、后的顺序和逻辑区分，它和约定游戏的例子里的拦截器的方法十分接近。</p>
<ul>
<li>前置通知（before）：在动态代理反射原有对象方法或者执行环绕通知前执行的通知功能；</li>
<li>后置通知（after）：在动态代理反射原有对象方法或者执行环绕通知后执行的通知后执行的通知功能。无论是否抛出异常，它都会被执行；</li>
<li>返回通知（afterReturning）：在动态代理反射原有对象方法或者执行环绕通知后执行的通知功能；</li>
<li>异常通知（afterThrowing）：在动态代理反射原有对象方法或者执行环绕通知产生异常后执行的通知功能；</li>
<li>环绕通知（aroundThrowing）：在动态代理中，它可以取代当前被拦截对象的方法，通知参数或反射调用被拦截对象的方法。</li>
</ul>
<p>3、引入（Introduction）<br>引入允许我们在现有的类里添加自定义的类和方法。</p>
<p>4、切点（Pointcut）<br>在动态代理中，被切面拦截的方法就是一个切点，切面将可以将其切点和被拦截的方法按照一定的逻辑织入到约定流程当中。</p>
<p>5、连接点（join point）<br>连接点是一个判断条件，由它可以指定哪些是切点。对于指定的切点，Spring会生成代理对象去使用对应的切面对其拦截，否则就不会拦截它。</p>
<p>6、织入（Weaving）<br>织入是一个生成代理对象的过程。实际代理的方法分为静态代理和动态代理。静态代理是在编译class文件时生成的代码逻辑，但是在Spring中并不适用这样的方式。</p>
<h3 id="Spring对AOP的支持"><a href="#Spring对AOP的支持" class="headerlink" title="Spring对AOP的支持"></a>Spring对AOP的支持</h3><p>AOP并不是Spring框架特有的，Spring只是支持AOP编程的框架之一。每一个框架对AOP的支持各有特点，有些AOP能够对方法的参数进行拦截，有些AOP对方法进行拦截。</p>
<p>而Spring AOP是一种基于方法拦截的AOP，换句话说Spring只能支持方法拦截的AOP，Spring中有4种方式去实现AOP的拦截功能：</p>
<ul>
<li>使用ProxyFactoryBean和对应的接口实现AOP；</li>
<li>使用XML配置AOP；</li>
<li>使用@AspectJ注解驱动切面；</li>
<li>使用AspectJ注入切面</li>
</ul>
<h2 id="使用-AspectJ注解开发Spring-AOP"><a href="#使用-AspectJ注解开发Spring-AOP" class="headerlink" title="使用@AspectJ注解开发Spring AOP"></a>使用@AspectJ注解开发Spring AOP</h2><p>注解使用了对应的正则式，这些正则式是连接点的问题，也就是要告诉Spring AOP，需要拦截什么对象的什么方法，为此我们要学习连接点的知识。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="选择切点"><a href="#选择切点" class="headerlink" title="选择切点"></a>选择切点</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleService1</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService1;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImpl1</span> <span class="keyword">implements</span> <span class="title">RoleService1</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRole</span><span class="params">(Role role)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"{id ="</span>+role.getId() + <span class="string">", roleName="</span> + role.getRoleName() + <span class="string">","</span> +</span><br><span class="line">                <span class="string">"note="</span>+role.getNote() + <span class="string">"}"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建切面"><a href="#创建切面" class="headerlink" title="创建切面"></a>创建切面</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.aspects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleAspect</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(value = <span class="string">"execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl1.printRole(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"before ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(value = <span class="string">"execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl1.printRole(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"after ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(value = <span class="string">"execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl1.printRole(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterReturning ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(value = <span class="string">"execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl1.printRole(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterThrowing ...."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<table>
<thead>
<tr>
<th align="center">注解</th>
<th align="center">通知</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">@Before</td>
<td align="center">在被代理对象的方法前先调用</td>
<td align="center">前置通知</td>
</tr>
<tr>
<td align="center">@Around</td>
<td align="center">将被代理对象的方法封装起来，并用环绕通知取代它</td>
<td align="center">环绕通知，它将覆盖原有方法，但是允许你通过反射调用原有方法，后续会讨论</td>
</tr>
<tr>
<td align="center">@After</td>
<td align="center">在被代理对象的方法后调用</td>
<td align="center">后置通知</td>
</tr>
<tr>
<td align="center">@AfterReturning</td>
<td align="center">在被代理对象的方法正常返回后调用</td>
<td align="center">返回通知，要求被代理对象的方法执行过程中没有发生异常</td>
</tr>
<tr>
<td align="center">@AfterThrowing</td>
<td align="center">在被代理对象的方法抛出异常后调用</td>
<td align="center">异常通知，要求被代理对象的方法执行过程中产生异常</td>
</tr>
</tbody></table>
<h3 id="连接点"><a href="#连接点" class="headerlink" title="连接点"></a>连接点</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl1.printRole(..))</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>execution：代表执行方法的时候触发</li>
<li>*：代表任意返回类型的方法</li>
<li>com.louris.springboot.IoCImpl.impl.RoleServiceImpl1：代表类的全限定名</li>
<li>printRole：被拦截方法名称</li>
<li>(..)：任意的参数</li>
</ul>
<table>
<thead>
<tr>
<th align="center">AspectJ指示器</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">arg()</td>
<td align="left">限制连接点匹配参数为指定类型的方法</td>
</tr>
<tr>
<td align="center">@args()</td>
<td align="left">限制连接点匹配参数为指定注解标注的执行方法</td>
</tr>
<tr>
<td align="center">execution</td>
<td align="left">用于匹配连接点的执行方法，这是最常用的匹配，可以通过类似上面的正则式进行匹配</td>
</tr>
<tr>
<td align="center">this()</td>
<td align="left">限制连接点匹配AOP代理的Bean，引用为指定类型的类</td>
</tr>
<tr>
<td align="center">target</td>
<td align="left">限制连接点匹配被代理对象为指定的类型</td>
</tr>
<tr>
<td align="center">@target()</td>
<td align="left">限制连接点匹配特定的执行对象，这些对象要符合指定的注解类型</td>
</tr>
<tr>
<td align="center">within()</td>
<td align="left">限制连接点匹配指定的包</td>
</tr>
<tr>
<td align="center">@within()</td>
<td align="left">限制连接点匹配指定的类型</td>
</tr>
<tr>
<td align="center">@annotation</td>
<td align="left">限制匹配带有指定注解的连接点</td>
</tr>
</tbody></table>
<p>通过within限制，Spring只会拿到com.louris.springboot.IoCImpl.impl包下面的类的printRole方法作为切点了。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(value = <span class="string">"execution(* com.louris.springboot.*.*.*.printRole(..))</span></span><br><span class="line"><span class="string">                 &amp;&amp; within(com.louris.springboot.IoCImpl.impl)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>{</span><br><span class="line">    System.out.println(<span class="string">"before ...."</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.aspects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleAspect</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl1.printRole(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>{}</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"before ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"after ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterReturning ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterThrowing ...."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="测试AOP"><a href="#测试AOP" class="headerlink" title="测试AOP"></a>测试AOP</h3><h4 id="注解实现-1"><a href="#注解实现-1" class="headerlink" title="注解实现"></a>注解实现</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.aspects.RoleAspect;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(value = <span class="string">"com.louris.springboot.*"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AopConfig</span> </span>{</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RoleAspect <span class="title">getRoleAspect</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RoleAspect();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="XML实现"><a href="#XML实现" class="headerlink" title="XML实现"></a>XML实现</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:c</span>=<span class="string">"http://www.springframework.org/schema/c"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;context:component-scan base-package="com.louris.springboot.IoCImpl.beans"/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"roleAspect"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.aspects.RoleAspect"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"roleService"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.impl.RoleServiceImpl1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(AopConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//ApplicationContext applicationContext1 = new ClassPathXmlApplicationContext("sprint-aop-config.xml");</span></span><br><span class="line">RoleService1 roleService1 = (RoleService1) applicationContext.getBean(RoleService1<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">Role role = <span class="keyword">new</span> Role();</span><br><span class="line">role.setId(<span class="number">1L</span>);</span><br><span class="line">role.setRoleName(<span class="string">"role_name_1"</span>);</span><br><span class="line">role.setNote(<span class="string">"note_1"</span>);</span><br><span class="line">roleService1.printRole(role);</span><br><span class="line">System.out.println(<span class="string">"#################"</span>);</span><br><span class="line"><span class="comment">//测试异常通知</span></span><br><span class="line">role = <span class="keyword">null</span>;</span><br><span class="line">roleService1.printRole(role);</span><br></pre></td></tr></tbody></table></figure>
<p>运行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">before ....</span><br><span class="line">{id =<span class="number">1</span>, roleName=role_name_1,note=note_1}</span><br><span class="line">afterReturning ....</span><br><span class="line">after ....</span><br><span class="line">#################</span><br><span class="line">before ....</span><br><span class="line">afterThrowing ....</span><br><span class="line">after ....</span><br><span class="line">Exception in thread <span class="string">"main"</span> java.lang.NullPointerException</span><br><span class="line">	at com.louris.springboot.IoCImpl.impl.RoleServiceImpl1.printRole(RoleServiceImpl1.java:<span class="number">12</span>)</span><br><span class="line">	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.base/java.lang.reflect.Method.invoke(Method.java:<span class="number">564</span>)</span><br><span class="line">	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:<span class="number">344</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:<span class="number">198</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">163</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AspectJAfterThrowingAdvice.invoke(AspectJAfterThrowingAdvice.java:<span class="number">64</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.adapter.AfterReturningAdviceInterceptor.invoke(AfterReturningAdviceInterceptor.java:<span class="number">57</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.aspectj.AspectJAfterAdvice.invoke(AspectJAfterAdvice.java:<span class="number">49</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor.invoke(MethodBeforeAdviceInterceptor.java:<span class="number">58</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:<span class="number">97</span>)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">	at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:<span class="number">215</span>)</span><br><span class="line">	at com.sun.proxy.$Proxy67.printRole(Unknown Source)</span><br><span class="line">	at com.louris.springboot.Application.main(Application.java:<span class="number">100</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="环绕通知"><a href="#环绕通知" class="headerlink" title="环绕通知"></a>环绕通知</h3><p>环绕通知是Spring AOP中最强大的通知，它可以同时实现前置通知和后置通知。它保留了调度被代理对象原有方法的功能，所以它既强大，又灵活。但是由于强大，它的可控性不那么强，如果不需要大量改变业务逻辑，一般而言并不需要使用它。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around</span>(value = <span class="string">"print()"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span></span>{</span><br><span class="line">    System.out.println(<span class="string">"around before ...."</span>);</span><br><span class="line">    <span class="keyword">try</span>{</span><br><span class="line">        joinPoint.proceed();</span><br><span class="line">    }<span class="keyword">catch</span> (Throwable e){</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">    System.out.println(<span class="string">"around after ...."</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">around before ....</span><br><span class="line">before ....</span><br><span class="line">{id =<span class="number">1</span>, roleName=role_name_1,note=note_1}</span><br><span class="line">afterReturning ....</span><br><span class="line">after ....</span><br><span class="line">around after ....</span><br><span class="line">#################</span><br><span class="line">around before ....</span><br><span class="line">before ....</span><br><span class="line">afterThrowing ....</span><br><span class="line">after ....</span><br><span class="line">around after ....</span><br><span class="line">java.lang.NullPointerException</span><br></pre></td></tr></tbody></table></figure>

<h3 id="织入"><a href="#织入" class="headerlink" title="织入"></a>织入</h3><p>织入是生成代理对象的过程，在上述的代码中，切点方法所在的类都是拥有接口的类，而事实上即使没有接口，Spring也能提供AOP的功能，所以是否拥有接口不是使用Spring AOP的一个强制要求。</p>
<ul>
<li>当类的实现存在接口时，Spring将提供JDK动态代理，从而织入各个通知；</li>
<li>当类不存在接口的时候没有办法使用JDK动态代理，Spring会采用CGLIB来生成代理对象。</li>
</ul>
<h3 id="给通知传递参数"><a href="#给通知传递参数" class="headerlink" title="给通知传递参数"></a>给通知传递参数</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleService1</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printRole</span><span class="params">(Role role, <span class="keyword">int</span> sort)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImpl1</span> <span class="keyword">implements</span> <span class="title">RoleService1</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRole</span><span class="params">(Role role, <span class="keyword">int</span> sort)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"{id ="</span>+role.getId() + <span class="string">", roleName="</span> + role.getRoleName() + <span class="string">","</span> +</span><br><span class="line">                <span class="string">"note="</span>+role.getNote() + <span class="string">"}"</span>);</span><br><span class="line">        System.out.println(sort);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(value = <span class="string">"execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl1.printRole(..))"</span> +</span><br><span class="line">        <span class="string">"&amp;&amp; args(role, sort)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Role role, <span class="keyword">int</span> sort)</span></span>{</span><br><span class="line">    System.out.println(<span class="string">"before ...."</span>);</span><br><span class="line">    System.out.println(role.getRoleName());</span><br><span class="line">    System.out.println(sort);</span><br><span class="line">    System.out.println(<span class="string">"before exit...."</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>运行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">around before ....</span><br><span class="line">before ....</span><br><span class="line">role_name_1</span><br><span class="line"><span class="number">1</span></span><br><span class="line">before exit....</span><br><span class="line">{id =<span class="number">1</span>, roleName=role_name_1,note=note_1}</span><br><span class="line"><span class="number">1</span></span><br><span class="line">afterReturning ....</span><br><span class="line">after ....</span><br><span class="line">around after ....</span><br><span class="line">#################</span><br><span class="line">around before ....</span><br><span class="line">before ....</span><br><span class="line">around after ....</span><br><span class="line">java.lang.NullPointerException</span><br></pre></td></tr></tbody></table></figure>

<h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><p>Spring AOP只是通过动态代理技术，把各类通知织入到它所约定的流程当中，而事实上，有时候我们希望通过引入其他类的方法来得到更好的实现，这时就可以引入其他的方法了。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleVerifier</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">verify</span><span class="params">(Role role)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleVerifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleVerifierImpl</span> <span class="keyword">implements</span> <span class="title">RoleVerifier</span> </span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verify</span><span class="params">(Role role)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> role != <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注解@DeclareParents的配置：</p>
<ul>
<li>value 表示对对应类进行增强，也就是在对应类中引入一个新的接口</li>
<li>defaultImpl 代表其默认的实现类，这里是RoleVerifierImpl</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.aspects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleVerifierImpl;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleVerifier;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleAspect</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeclareParents</span>(value = <span class="string">"com.louris.springboot.IoCImpl.impl.RoleServiceImpl"</span>,</span><br><span class="line">    defaultImpl = RoleVerifierImpl<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">RoleVerifier</span> <span class="title">roleVerifier</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl.printRole(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>{}</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"around before ...."</span>);</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            joinPoint.proceed();</span><br><span class="line">        }<span class="keyword">catch</span> (Throwable e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        System.out.println(<span class="string">"around after ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"before ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"after ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterReturning ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterThrowing ...."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(AopConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">RoleService roleService = applicationContext.getBean(RoleService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">RoleVerifier roleVerifier = (RoleVerifier) roleService;</span><br><span class="line">Role role = <span class="keyword">new</span> Role();</span><br><span class="line">role.setId(<span class="number">1L</span>);</span><br><span class="line">role.setRoleName(<span class="string">"role_name_1"</span>);</span><br><span class="line">role.setNote(<span class="string">"note_1"</span>);</span><br><span class="line"><span class="keyword">if</span>(roleVerifier.verify(role)){</span><br><span class="line">    System.out.println(<span class="string">"role is not null!"</span>);</span><br><span class="line">    roleService.printRole(role);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">role is not <span class="keyword">null</span>!</span><br><span class="line">around before ....</span><br><span class="line">before ....</span><br><span class="line">{id =<span class="number">1</span>, roleName=role_name_1,note=note_1}</span><br><span class="line">afterReturning ....</span><br><span class="line">after ....</span><br><span class="line">around after ....</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到通过Spirng AOP后，使用强制转换后就可以把roleService转化为roleVerifier接口对象，然后就可以使用verify方法。而RoleVerifer调用的方法verify，显然它就是通过RoleVerifierImpl来实现的。</p>
<p>其原理是通过Spring AOP依赖于动态代理来实现，生成动态代理对象是通过类似于下面这行代码来实现的。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Proxy.newProxyInstance(obj.getClass().getClassLoader(), obj.getClass().getInterfaces(), _this);</span><br></pre></td></tr></tbody></table></figure>

<p>obj.getClass().getInterfaces()意味着代理对象挂在多个接口之下，换句话说，只要Spring AOP让代理对象挂到RoleService和RoleVerifier两个接口之下，那么就可以把对应的Bean通过强制转换，让其在RoleService和RoleVerifier之间相互转换了。</p>
<p>同样的如果RoleServiceImpl没有接口，那么它会使用CGLIB动态代理，使用增强着（Enhancer）也会有一个Interfaces的属性，允许代理对象挂到对应的多个接口下，于是也可以按JDK动态代理那样使得对象可以在多个接口之间相互转换。</p>
<h2 id="使用XML配置开发Spring-AOP"><a href="#使用XML配置开发Spring-AOP" class="headerlink" title="使用XML配置开发Spring AOP"></a>使用XML配置开发Spring AOP</h2><p>切点不变，即RoleService和RoleServiceImpl不变</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.aspects;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleVerifier;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlAspect</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RoleVerifier roleVerifier = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Role role)</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"role_id= "</span> + role.getId() + <span class="string">" before ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"after ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterReturning ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterThrowing ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"around before ...."</span>);</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            joinPoint.proceed();</span><br><span class="line">        }<span class="keyword">catch</span> (Throwable e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        System.out.println(<span class="string">"around after ...."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"xmlAspect"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.aspects.XmlAspect"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"roleService"</span> <span class="attr">class</span>=<span class="string">"com.louris.springboot.IoCImpl.impl.RoleServiceImpl"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;aop:config&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--    &amp;lt;!&amp;ndash; 引用xmlAspect作为切面 &amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--    &lt;aop:aspect ref="xmlAspect"&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        &amp;lt;!&amp;ndash; 定义通知 &amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        &lt;aop:before method="before" pointcut="execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl.printRole(..))"/&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        &lt;aop:after method="after" pointcut="execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl.printRole(..))"/&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        &lt;aop:after-throwing method="afterThrowing" pointcut="execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl.printRole(..))"/&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        &lt;aop:after-returning method="afterReturning" pointcut="execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl.printRole(..))"/&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--    &lt;/aop:aspect&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;/aop:config&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引用xmlAspect作为切面 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"xmlAspect"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 定义切点 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"printRole"</span> <span class="attr">expression</span>=<span class="string">"execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl.printRole(..))"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:declare-parents</span> <span class="attr">types-matching</span>=<span class="string">"com.louris.springboot.IoCImpl.impl.RoleServiceImpl"</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">implement-interface</span>=<span class="string">"com.louris.springboot.IoCImpl.service.RoleVerifier"</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">default-impl</span>=<span class="string">"com.louris.springboot.IoCImpl.impl.RoleVerifierImpl"</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 定义通知 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"before"</span> <span class="attr">pointcut</span>=<span class="string">"execution(* com.louris.springboot.IoCImpl.impl.RoleServiceImpl.printRole(..)) and args(role)"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">"after"</span> <span class="attr">pointcut-ref</span>=<span class="string">"printRole"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">"afterThrowing"</span> <span class="attr">pointcut-ref</span>=<span class="string">"printRole"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">method</span>=<span class="string">"afterReturning"</span> <span class="attr">pointcut-ref</span>=<span class="string">"printRole"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">method</span>=<span class="string">"around"</span> <span class="attr">pointcut-ref</span>=<span class="string">"printRole"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring-aop.xml"</span>);</span><br><span class="line">RoleService roleService = applicationContext.getBean(RoleService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">RoleVerifier roleVerifier = (RoleVerifier) roleService;</span><br><span class="line">Role role = <span class="keyword">new</span> Role();</span><br><span class="line">role.setId(<span class="number">1L</span>);</span><br><span class="line">role.setRoleName(<span class="string">"role_name_1"</span>);</span><br><span class="line">role.setNote(<span class="string">"note_1"</span>);</span><br><span class="line"><span class="keyword">if</span>(roleVerifier.verify(role)){</span><br><span class="line">    System.out.println(<span class="string">"role is not null!"</span>);</span><br><span class="line">    roleService.printRole(role);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="经典Spring-AOP应用程序"><a href="#经典Spring-AOP应用程序" class="headerlink" title="经典Spring AOP应用程序"></a>经典Spring AOP应用程序</h2><p>略过</p>
<h2 id="多个切面"><a href="#多个切面" class="headerlink" title="多个切面"></a>多个切面</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultiBean</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testMulti</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.MultiBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiBeanImpl</span> <span class="keyword">implements</span> <span class="title">MultiBean</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMulti</span><span class="params">()</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"test multi aspects!!"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.aspects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.impl.RoleVerifierImpl;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleVerifier;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="comment">//@Order(3)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Aspect1</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"execution(* com.louris.springboot.IoCImpl.impl.MultiBeanImpl.testMulti(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>{}</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"before 1 ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"after 1 ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterReturning 1 ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterThrowing 1 ...."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.aspects;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="comment">//@Order(2)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Aspect2</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"execution(* com.louris.springboot.IoCImpl.impl.MultiBeanImpl.testMulti(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>{}</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"before 2 ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"after 2 ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterReturning 2 ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterThrowing 2 ...."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.aspects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="comment">//@Order(1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Aspect3</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"execution(* com.louris.springboot.IoCImpl.impl.MultiBeanImpl.testMulti(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>{}</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"before 3 ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"after 3 ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterReturning 3 ...."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(value = <span class="string">"print()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"afterThrowing 3 ...."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.aspects.Aspect1;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.aspects.Aspect2;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.aspects.Aspect3;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = {<span class="string">"com.louris.springboot"</span>})</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Aspect1 <span class="title">getAspect1</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Aspect1();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Aspect2 <span class="title">getAspect2</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Aspect2();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Aspect3 <span class="title">getAspect3</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Aspect3();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(MultiConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">MultiBean multiBean = applicationContext.getBean(MultiBeanImpl<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">multiBean.testMulti();</span><br></pre></td></tr></tbody></table></figure>

<h3 id="多切面排序"><a href="#多切面排序" class="headerlink" title="多切面排序"></a>多切面排序</h3><p>运行结果：<br>（1）默认顺序：应该是切面类名字符排序</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">before <span class="number">1</span> ....</span><br><span class="line">before <span class="number">2</span> ....</span><br><span class="line">before <span class="number">3</span> ....</span><br><span class="line">test multi aspects!!</span><br><span class="line">afterReturning <span class="number">3</span> ....</span><br><span class="line">after <span class="number">3</span> ....</span><br><span class="line">afterReturning <span class="number">2</span> ....</span><br><span class="line">after <span class="number">2</span> ....</span><br><span class="line">afterReturning <span class="number">1</span> ....</span><br><span class="line">after <span class="number">1</span> ....</span><br></pre></td></tr></tbody></table></figure>

<p>（2）@Order注解指定顺序</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">before <span class="number">3</span> ....</span><br><span class="line">before <span class="number">2</span> ....</span><br><span class="line">before <span class="number">1</span> ....</span><br><span class="line">test multi aspects!!</span><br><span class="line">afterReturning <span class="number">1</span> ....</span><br><span class="line">after <span class="number">1</span> ....</span><br><span class="line">afterReturning <span class="number">2</span> ....</span><br><span class="line">after <span class="number">2</span> ....</span><br><span class="line">afterReturning <span class="number">3</span> ....</span><br><span class="line">after <span class="number">3</span> ....</span><br></pre></td></tr></tbody></table></figure>

<p>（3）其他方式：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> lcass Aspect1 implements Ordered{</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"aspect1"</span> <span class="attr">order</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">  ......</span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="Spring和数据库编程"><a href="#Spring和数据库编程" class="headerlink" title="Spring和数据库编程"></a>Spring和数据库编程</h1></blockquote>
<h2 id="传统的JDBC代码的弊端"><a href="#传统的JDBC代码的弊端" class="headerlink" title="传统的JDBC代码的弊端"></a>传统的JDBC代码的弊端</h2><p>执行一条简单的SQL，其过程也不简单，太多try…catch…finally</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Role <span class="title">getRole</span><span class="params">(Long id)</span></span>{</span><br><span class="line">    Role role = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//生命JDBC变量</span></span><br><span class="line">    Connection connection = <span class="keyword">null</span>;</span><br><span class="line">    PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">    ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>{</span><br><span class="line">        <span class="comment">//注册驱动程序</span></span><br><span class="line">        Class.forName(<span class="string">"com.mysql.cj.jdbc.Driver"</span>);</span><br><span class="line">        <span class="comment">//获取连接</span></span><br><span class="line">        connection = DriverManager.getConnection(<span class="string">"jdbc:mysql://localhost:3306/ssm"</span>,</span><br><span class="line">                <span class="string">"root"</span>,</span><br><span class="line">                <span class="string">"123456"</span>);</span><br><span class="line">        <span class="comment">//预编译SQL</span></span><br><span class="line">        preparedStatement = connection.prepareStatement(<span class="string">"select id, role_name, note from t_role where id = ?"</span>);</span><br><span class="line">        <span class="comment">//设置参数</span></span><br><span class="line">        preparedStatement.setLong(<span class="number">1</span>, id);</span><br><span class="line">        <span class="comment">//执行SQL</span></span><br><span class="line">        resultSet = preparedStatement.executeQuery();</span><br><span class="line">        <span class="comment">//组装结果集返回POJO</span></span><br><span class="line">        <span class="keyword">while</span>(resultSet.next()){</span><br><span class="line">            role = <span class="keyword">new</span> Role();</span><br><span class="line">            role.setId(resultSet.getLong(<span class="number">1</span>));</span><br><span class="line">            role.setRoleName(resultSet.getString(<span class="number">2</span>));</span><br><span class="line">            role.setNote(resultSet.getString(<span class="number">3</span>));</span><br><span class="line">        }</span><br><span class="line">    }<span class="keyword">catch</span> (ClassNotFoundException | SQLException e){</span><br><span class="line">        <span class="comment">//异常处理</span></span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }<span class="keyword">finally</span> {</span><br><span class="line">        <span class="comment">//关闭数据库连接资源</span></span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="keyword">if</span>(resultSet != <span class="keyword">null</span> &amp;&amp; !resultSet.isClosed()){</span><br><span class="line">                resultSet.close();</span><br><span class="line">            }</span><br><span class="line">        }<span class="keyword">catch</span> (SQLException e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="keyword">if</span>(preparedStatement != <span class="keyword">null</span> &amp;&amp; !preparedStatement.isClosed()){</span><br><span class="line">                preparedStatement.close();</span><br><span class="line">            }</span><br><span class="line">        }<span class="keyword">catch</span> (SQLException e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="keyword">if</span>(connection != <span class="keyword">null</span> &amp;&amp; !connection.isClosed()){</span><br><span class="line">                connection.close();</span><br><span class="line">            }</span><br><span class="line">        }<span class="keyword">catch</span> (SQLException e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> role;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="配置数据库资源"><a href="#配置数据库资源" class="headerlink" title="配置数据库资源"></a>配置数据库资源</h2><h3 id="使用简单数据库配置"><a href="#使用简单数据库配置" class="headerlink" title="使用简单数据库配置"></a>使用简单数据库配置</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.SimpleDriverDataSource"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用第三方数据库连接池"><a href="#使用第三方数据库连接池" class="headerlink" title="使用第三方数据库连接池"></a>使用第三方数据库连接池</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp2.BasicDataSource"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm?serverTimezone=UTC"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  连接池的最大数据库连接数  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"255"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  最大等待连接中的数量  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"5"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 最大等待毫秒数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWaitMillis"</span> <span class="attr">value</span>=<span class="string">"10000"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用JNDI数据库连接池"><a href="#使用JNDI数据库连接池" class="headerlink" title="使用JNDI数据库连接池"></a>使用JNDI数据库连接池</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jndi.JndiObjectFactoryBean"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jndiName"</span> <span class="attr">value</span>=<span class="string">"java:comp/env/jdbc/ssm"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="JDBC代码失控的解决方案——JdbcTemplate"><a href="#JDBC代码失控的解决方案——JdbcTemplate" class="headerlink" title="JDBC代码失控的解决方案——JdbcTemplate"></a>JDBC代码失控的解决方案——JdbcTemplate</h2><p>JdbcTemplate是Spring针对JDBC代码失控提供的解决方案，严格来说，它本身也不算成功。但是无论如何jdbcTemplate的方案也体现了Spring框架的主导思想之一：给予常用技术提供模板化的编程，减少了开发者的工作量。</p>
<h3 id="JdbcTemplate的增删改查"><a href="#JdbcTemplate的增删改查" class="headerlink" title="JdbcTemplate的增删改查"></a>JdbcTemplate的增删改查</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.core.JdbcTemplate"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTemplateTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入角色</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jdbcTemplate 模板</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响条数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(JdbcTemplate jdbcTemplate)</span></span>{</span><br><span class="line">        String roleName = <span class="string">"rolt_name_1"</span>;</span><br><span class="line">        String note = <span class="string">"note_1"</span>;</span><br><span class="line">        String sql = <span class="string">"insert into t_role(role_name, note) value(?,?)"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.update(sql, roleName, note);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除角色</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jdbcTemplate 模板</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 角色编号，主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 影响条数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(JdbcTemplate jdbcTemplate, Long id)</span></span>{</span><br><span class="line">        String sql = <span class="string">"delete from t_role where id=?"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.update(sql, id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateRole</span><span class="params">(JdbcTemplate jdbcTemplate, Role role)</span></span>{</span><br><span class="line">        String sql = <span class="string">"update t_role set role_name=?, note=? where id=?"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.update(sql, role.getRoleName(), role.getNote(), role.getId());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Role&gt; <span class="title">findRole</span><span class="params">(JdbcTemplate jdbcTemplate, String roleName)</span></span>{</span><br><span class="line">        String sql = <span class="string">"select id, role_name, note from t_role where role_name like concat('%', ?, '%')"</span>;</span><br><span class="line">        Object[] params = {roleName}; <span class="comment">//组织参数</span></span><br><span class="line">        <span class="comment">//使用RowMapper接口组织返回（使用lambda表达式）</span></span><br><span class="line">        List&lt;Role&gt; list = jdbcTemplate.query(sql, params, (ResultSet resultSet, <span class="keyword">int</span> rowNum) -&gt; {</span><br><span class="line">            Role result = <span class="keyword">new</span> Role();</span><br><span class="line">            result.setId(resultSet.getLong(<span class="string">"id"</span>));</span><br><span class="line">            result.setRoleName(resultSet.getString(<span class="string">"role_name"</span>));</span><br><span class="line">            result.setNote(resultSet.getString(<span class="string">"note"</span>));</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring-dataSource.xml"</span>);</span><br><span class="line">JdbcTemplate jdbcTemplate = applicationContext.getBean(JdbcTemplate<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">Long id = <span class="number">2L</span>;</span><br><span class="line">String sql = <span class="string">"select id, role_name, note from t_role where id = "</span> + id;</span><br><span class="line">Role role = jdbcTemplate.queryForObject(sql, <span class="keyword">new</span> RowMapper&lt;Role&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">mapRow</span><span class="params">(ResultSet resultSet, <span class="keyword">int</span> i)</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        Role result = <span class="keyword">new</span> Role();</span><br><span class="line">        result.setId(resultSet.getLong(<span class="string">"id"</span>));</span><br><span class="line">        result.setRoleName(resultSet.getString(<span class="string">"role_name"</span>));</span><br><span class="line">        result.setNote(resultSet.getString(<span class="string">"note"</span>));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line">System.out.println(role.getRoleName());</span><br><span class="line"></span><br><span class="line">JdbcTemplateTest jdbcTemplateTest = <span class="keyword">new</span> JdbcTemplateTest();</span><br><span class="line">jdbcTemplateTest.insertRole(jdbcTemplate);</span><br><span class="line"></span><br><span class="line">role = <span class="keyword">new</span> Role();</span><br><span class="line">role.setId(<span class="number">13L</span>);</span><br><span class="line">role.setRoleName(<span class="string">"update_role_name_1"</span>);</span><br><span class="line">role.setNote(<span class="string">"update_note_1"</span>);</span><br><span class="line">jdbcTemplateTest.updateRole(jdbcTemplate, role);</span><br><span class="line">jdbcTemplateTest.deleteRole(jdbcTemplate, <span class="number">11L</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>运行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk-14.0.2\bin\java.exe"</span> -XX:TieredStopAtLevel=<span class="number">1</span> -noverify -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=<span class="keyword">true</span> -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=<span class="keyword">true</span> <span class="string">"-javaagent:D:\IntelliJ IDEA 2020.1.1\lib\idea_rt.jar=65017:D:\IntelliJ IDEA 2020.1.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-web\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-web-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-autoconfigure-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-logging\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-logging-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-classic\<span class="number">1.2</span><span class="number">.3</span>\logback-classic-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\ch\qos\logback\logback-core\<span class="number">1.2</span><span class="number">.3</span>\logback-core-<span class="number">1.2</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\<span class="number">2.13</span><span class="number">.3</span>\log4j-to-slf4j-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\logging\log4j\log4j-api\<span class="number">2.13</span><span class="number">.3</span>\log4j-api-<span class="number">2.13</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\jul-to-slf4j\<span class="number">1.7</span><span class="number">.30</span>\jul-to-slf4j-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\jakarta\annotation\jakarta.annotation-api\<span class="number">1.3</span><span class="number">.5</span>\jakarta.annotation-api-<span class="number">1.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\yaml\snakeyaml\<span class="number">1.27</span>\snakeyaml-<span class="number">1.27</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-json\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-json-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-databind\<span class="number">2.11</span><span class="number">.4</span>\jackson-databind-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\<span class="number">2.11</span><span class="number">.4</span>\jackson-annotations-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\core\jackson-core\<span class="number">2.11</span><span class="number">.4</span>\jackson-core-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jdk8-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\<span class="number">2.11</span><span class="number">.4</span>\jackson-datatype-jsr310-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\fasterxml\jackson\<span class="keyword">module</span>\jackson-<span class="keyword">module</span>-parameter-names\<span class="number">2.11</span><span class="number">.4</span>\jackson-<span class="keyword">module</span>-parameter-names-<span class="number">2.11</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-tomcat-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-core-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\glassfish\jakarta.el\<span class="number">3.0</span><span class="number">.3</span>\jakarta.el-<span class="number">3.0</span><span class="number">.3</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\<span class="number">9.0</span><span class="number">.44</span>\tomcat-embed-websocket-<span class="number">9.0</span><span class="number">.44</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-web\<span class="number">5.3</span><span class="number">.5</span>\spring-web-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-webmvc\<span class="number">5.3</span><span class="number">.5</span>\spring-webmvc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-expression\<span class="number">5.3</span><span class="number">.5</span>\spring-expression-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\slf4j\slf4j-api\<span class="number">1.7</span><span class="number">.30</span>\slf4j-api-<span class="number">1.7</span><span class="number">.30</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-core\<span class="number">5.3</span><span class="number">.5</span>\spring-core-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jcl\<span class="number">5.3</span><span class="number">.5</span>\spring-jcl-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-beans\<span class="number">5.3</span><span class="number">.5</span>\spring-beans-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-context\<span class="number">5.3</span><span class="number">.5</span>\spring-context-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-aop\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-aop-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-aop\<span class="number">5.3</span><span class="number">.5</span>\spring-aop-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\aspectj\aspectjweaver\<span class="number">1.9</span><span class="number">.6</span>\aspectjweaver-<span class="number">1.9</span><span class="number">.6</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\commons\commons-dbcp2\<span class="number">2.8</span><span class="number">.0</span>\commons-dbcp2-<span class="number">2.8</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\apache\commons\commons-pool2\<span class="number">2.9</span><span class="number">.0</span>\commons-pool2-<span class="number">2.9</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\mysql\mysql-connector-java\<span class="number">8.0</span><span class="number">.23</span>\mysql-connector-java-<span class="number">8.0</span><span class="number">.23</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\mybatis\spring\boot\mybatis-spring-boot-starter\<span class="number">2.0</span><span class="number">.0</span>\mybatis-spring-boot-starter-<span class="number">2.0</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\boot\spring-boot-starter-jdbc\<span class="number">2.4</span><span class="number">.4</span>\spring-boot-starter-jdbc-<span class="number">2.4</span><span class="number">.4</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\com\zaxxer\HikariCP\<span class="number">3.4</span><span class="number">.5</span>\HikariCP-<span class="number">3.4</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-jdbc\<span class="number">5.3</span><span class="number">.5</span>\spring-jdbc-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\springframework\spring-tx\<span class="number">5.3</span><span class="number">.5</span>\spring-tx-<span class="number">5.3</span><span class="number">.5</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\mybatis\spring\boot\mybatis-spring-boot-autoconfigure\<span class="number">2.0</span><span class="number">.0</span>\mybatis-spring-boot-autoconfigure-<span class="number">2.0</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\mybatis\mybatis\<span class="number">3.5</span><span class="number">.0</span>\mybatis-<span class="number">3.5</span><span class="number">.0</span>.jar;C:\Users\<span class="number">98383</span>\.m2\repository\org\mybatis\mybatis-spring\<span class="number">2.0</span><span class="number">.0</span>\mybatis-spring-<span class="number">2.0</span><span class="number">.0</span>.jar com.louris.springboot.Application</span><br><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  `  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"> </span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v2<span class="number">.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08.441</span>  INFO <span class="number">22956</span> --- [           main] com.louris.springboot.Application        : Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">22956</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08.443</span>  INFO <span class="number">22956</span> --- [           main] com.louris.springboot.Application        : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08.901</span>  WARN <span class="number">22956</span> --- [           main] o.m.s.mapper.ClassPathMapperScanner      : No MyBatis mapper was found in <span class="string">'[com.louris.springboot]'</span> <span class="keyword">package</span>. Please check your configuration.</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">09.001</span>  INFO <span class="number">22956</span> --- [           main] o.s.c.a.ConfigurationClassEnhancer       : <span class="meta">@Bean</span> method PojoConfig.getPropertySourcesPlaceholderConfigurer is non-<span class="keyword">static</span> and returns an object assignable to Spring<span class="string">'s BeanFactoryPostProcessor interface. This will result in a failure to process annotations such as @Autowired, @Resource and @PostConstruct within the method'</span>s declaring <span class="meta">@Configuration</span> <span class="class"><span class="keyword">class</span>. <span class="title">Add</span> <span class="title">the</span> '<span class="title">static</span>' <span class="title">modifier</span> <span class="title">to</span> <span class="title">this</span> <span class="title">method</span> <span class="title">to</span> <span class="title">avoid</span> <span class="title">these</span> <span class="title">container</span> <span class="title">lifecycle</span> <span class="title">issues</span></span>; see <span class="meta">@Bean</span> javadoc <span class="keyword">for</span> complete details.</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">09.291</span>  INFO <span class="number">22956</span> --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8081 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-20 10:33:09.297  INFO 22956 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-20 10:33:09.297  INFO 22956 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-20 10:33:09.367  INFO 22956 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-20 10:33:09.367  INFO 22956 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 878 ms</span></span><br><span class="line"><span class="function">2021-09-20 10:33:09.530  INFO 22956 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-20 10:33:09.705  INFO 22956 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8081 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-20 10:33:09.712  INFO 22956 --- [           main] com.louris.springboot.Application        : Started Application in 1.502 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">1.887</span>)</span></span></span><br><span class="line"><span class="function">John</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="执行多条SQL"><a href="#执行多条SQL" class="headerlink" title="执行多条SQL"></a>执行多条SQL</h3><p>一个JdbcTemplate只执行了一条SQL，当要多次执行SQL时，可以使用execute方法。它将允许传递ConnectionCallback或者StatementCallback等接口进行回调，从而完成对应的功能。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Role <span class="title">getRoleByConnectionCallback</span><span class="params">(JdbcTemplate jdbcTemplate, Long id)</span></span>{</span><br><span class="line">    Role role = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//这里写成Java 8的Lambda表达式，如果你使用低版本的Java，需要使用ConnectionCallback匿名类</span></span><br><span class="line">    role = jdbcTemplate.execute((Connection connection) -&gt; {</span><br><span class="line">        Role result = <span class="keyword">null</span>;</span><br><span class="line">        String sql = <span class="string">"select id, role_name, note from t_role where id = ?"</span>;</span><br><span class="line">        PreparedStatement preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">        preparedStatement.setLong(<span class="number">1</span>, id);</span><br><span class="line">        ResultSet resultSet = preparedStatement.executeQuery();</span><br><span class="line">        <span class="keyword">while</span>(resultSet.next()){</span><br><span class="line">            result = <span class="keyword">new</span> Role();</span><br><span class="line">            result.setId(resultSet.getLong(<span class="string">"id"</span>));</span><br><span class="line">            result.setNote(resultSet.getString(<span class="string">"note"</span>));</span><br><span class="line">            result.setRoleName(resultSet.getString(<span class="string">"role_name"</span>));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> role;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Role <span class="title">getRoleByStatementCallback</span><span class="params">(JdbcTemplate jdbcTemplate, Long id)</span></span>{</span><br><span class="line">    Role role = <span class="keyword">null</span>;</span><br><span class="line">    role = jdbcTemplate.execute((Statement statement) -&gt; {</span><br><span class="line">        Role result = <span class="keyword">null</span>;</span><br><span class="line">        String sql = <span class="string">"select id, role_name, note from t_role where id="</span> + id;</span><br><span class="line">        ResultSet resultSet = statement.executeQuery(sql);</span><br><span class="line">        <span class="keyword">while</span>(resultSet.next()){</span><br><span class="line">            result = <span class="keyword">new</span> Role();</span><br><span class="line">            result.setId(resultSet.getLong(<span class="string">"id"</span>));</span><br><span class="line">            result.setNote(resultSet.getString(<span class="string">"note"</span>));</span><br><span class="line">            result.setRoleName(resultSet.getString(<span class="string">"role_name"</span>));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> role;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="JdbcTemplate源码分析"><a href="#JdbcTemplate源码分析" class="headerlink" title="JdbcTemplate源码分析"></a>JdbcTemplate源码分析</h3><ul>
<li>从源码中可以看到， Spring 要实现数据库连接资源获取和释放的逻辑，只要完成回调接口的方法逻辑即可，这便是它所提供的模板功能。但是我们并没有看到任何的事务管理，因为 jdbcTemplate 是不能支持事务的，还需要引入对应的事务管理器才能够支持事务。</li>
<li>在Spring 中，它会在内部再次判断事务是否交由事务管理器处理，如果是，则数据库连接将会从数据库事务管理器中获取，并且 jdbcTemplate 的资源链接请求的关闭也将由务管理器决定，而不是由 jdbcTemplate 自身决定 。由于这里只是简单应用 ，数据库事务并没有交由事务管理器管理，所以数据库资源是由 jdbcTemplate 自身管理。</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(StatementCallback&lt;T&gt; action, <span class="keyword">boolean</span> closeResources)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">    Assert.notNull(action, <span class="string">"Callback object must not be null"</span>);</span><br><span class="line">    Connection con = DataSourceUtils.getConnection(<span class="keyword">this</span>.obtainDataSource());</span><br><span class="line">    Statement stmt = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    Object var12;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        stmt = con.createStatement();</span><br><span class="line">        <span class="keyword">this</span>.applyStatementSettings(stmt);</span><br><span class="line">        T result = action.doInStatement(stmt);</span><br><span class="line">        <span class="keyword">this</span>.handleWarnings(stmt);</span><br><span class="line">        var12 = result;</span><br><span class="line">    } <span class="keyword">catch</span> (SQLException var10) {</span><br><span class="line">        String sql = getSql(action);</span><br><span class="line">        JdbcUtils.closeStatement(stmt);</span><br><span class="line">        stmt = <span class="keyword">null</span>;</span><br><span class="line">        DataSourceUtils.releaseConnection(con, <span class="keyword">this</span>.getDataSource());</span><br><span class="line">        con = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">this</span>.translateException(<span class="string">"StatementCallback"</span>, sql, var10);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span> (closeResources) {</span><br><span class="line">            JdbcUtils.closeStatement(stmt);</span><br><span class="line">            DataSourceUtils.releaseConnection(con, <span class="keyword">this</span>.getDataSource());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var12;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="MyBatis-Spring项目"><a href="#MyBatis-Spring项目" class="headerlink" title="MyBatis-Spring项目"></a>MyBatis-Spring项目</h2><h3 id="配置SqlSessionFactoryBean"><a href="#配置SqlSessionFactoryBean" class="headerlink" title="配置SqlSessionFactoryBean"></a>配置SqlSessionFactoryBean</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">SqlSessionFactory</span>&gt;, <span class="title">InitializingBean</span>, <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationEvent</span>&gt; </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(SqlSessionFactoryBean<span class="class">.<span class="keyword">class</span>)</span>; <span class="comment">//日志</span></span><br><span class="line">    <span class="keyword">private</span> Resource configLocation; <span class="comment">//MyBatis配置文件</span></span><br><span class="line">    <span class="keyword">private</span> Configuration configuration; <span class="comment">//Configuration对象</span></span><br><span class="line">    <span class="keyword">private</span> Resource[] mapperLocations; <span class="comment">//Mapper配置路径</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource; <span class="comment">//数据库</span></span><br><span class="line">    <span class="keyword">private</span> TransactionFactory transactionFactory; <span class="comment">//事务管理器</span></span><br><span class="line">    <span class="keyword">private</span> Properties configurationProperties; <span class="comment">//配置属性</span></span><br><span class="line">    <span class="keyword">private</span> SqlSessionFactoryBuilder sqlSessionFactoryBuilder = <span class="keyword">new</span> SqlSessionFactoryBuilder();</span><br><span class="line">    <span class="keyword">private</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line">    <span class="keyword">private</span> String environment = SqlSessionFactoryBean<span class="class">.<span class="keyword">class</span>.<span class="title">getSimpleName</span>()</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> failFast; <span class="comment">//当加载后，是否检测所有MyBatis的映射语句加载完全，默认为false</span></span><br><span class="line">    <span class="keyword">private</span> Interceptor[] plugins; <span class="comment">//插件</span></span><br><span class="line">    <span class="keyword">private</span> TypeHandler&lt;?&gt;[] typeHandlers; <span class="comment">//类型转换器，typeHandlers</span></span><br><span class="line">    <span class="keyword">private</span> String typeHandlersPackage; <span class="comment">//类型转换器包，用于扫描装载</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt;[] typeAliases; <span class="comment">//别名</span></span><br><span class="line">    <span class="keyword">private</span> String typeAliasesPackage; <span class="comment">//别名包，用于扫描加载</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; typeAliasesSuperType; <span class="comment">//当扩展了上面Class类后，就生成别名，但是如果你没有配置typeAliasesPackage则不会生效</span></span><br><span class="line">    <span class="keyword">private</span> DatabaseIdProvider databaseIdProvider; <span class="comment">//数据库厂商标识</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;? extends VFS&gt; vfs; <span class="comment">//unix的文件操作</span></span><br><span class="line">    <span class="keyword">private</span> Cache cache; <span class="comment">//缓存</span></span><br><span class="line">    <span class="keyword">private</span> ObjectFactory objectFactory; <span class="comment">///对象工厂</span></span><br><span class="line">    <span class="keyword">private</span> ObjectWrapperFactory objectWrapperFactory; <span class="comment">//对象包装器</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其他略过，springboot只需要配置properties文件就可以了</p>
<blockquote>
<h1 id="深入Spring数据库事务管理"><a href="#深入Spring数据库事务管理" class="headerlink" title="深入Spring数据库事务管理"></a>深入Spring数据库事务管理</h1></blockquote>
<h2 id="Spring数据库事务管理器的设计"><a href="#Spring数据库事务管理器的设计" class="headerlink" title="Spring数据库事务管理器的设计"></a>Spring数据库事务管理器的设计</h2><p>在Spring中数据库事务是通过PlatformTransactionManager进行管理的，而能够支持事务的是org.springframework.transaction.support.TransactionTemplate模板，它是Spring所提供的事务管理器的模板。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PlatformTransactionManager</span> <span class="keyword">extends</span> <span class="title">TransactionManager</span> </span>{</span><br><span class="line">    <span class="comment">//获取事务状态</span></span><br><span class="line">    <span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(@Nullable TransactionDefinition var1)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">    <span class="comment">//提交事务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus var1)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">    <span class="comment">//回滚事务</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">(TransactionStatus var1)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>从源码可以看到：</p>
<ul>
<li>事务的创建、提交和回滚是通过PlatformTransactionManager接口来完成的；</li>
<li>当事务产生异常时会回滚事务，在默认的实现中所有的异常都会回滚。我们可以通过配置去修改在某些异常发生时回滚或者不回滚事务；</li>
<li>当无异常时，会提交事务。</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.transaction.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionSystemException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionTemplate</span> <span class="keyword">extends</span> <span class="title">DefaultTransactionDefinition</span> <span class="keyword">implements</span> <span class="title">TransactionOperations</span>, <span class="title">InitializingBean</span> </span>{</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> PlatformTransactionManager transactionManager; <span class="comment">//事务管理器</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TransactionTemplate</span><span class="params">()</span> </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TransactionTemplate</span><span class="params">(PlatformTransactionManager transactionManager)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.transactionManager = transactionManager;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TransactionTemplate</span><span class="params">(PlatformTransactionManager transactionManager, TransactionDefinition transactionDefinition)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(transactionDefinition);</span><br><span class="line">        <span class="keyword">this</span>.transactionManager = transactionManager;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTransactionManager</span><span class="params">(@Nullable PlatformTransactionManager transactionManager)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.transactionManager = transactionManager;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">getTransactionManager</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.transactionManager;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Property 'transactionManager' is required"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(TransactionCallback&lt;T&gt; action)</span> <span class="keyword">throws</span> TransactionException </span>{</span><br><span class="line">        Assert.state(<span class="keyword">this</span>.transactionManager != <span class="keyword">null</span>, <span class="string">"No PlatformTransactionManager set"</span>);</span><br><span class="line">        <span class="comment">//使用自定义的事务管理器</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager <span class="keyword">instanceof</span> CallbackPreferringPlatformTransactionManager) {</span><br><span class="line">            <span class="keyword">return</span> ((CallbackPreferringPlatformTransactionManager)<span class="keyword">this</span>.transactionManager).execute(<span class="keyword">this</span>, action);</span><br><span class="line">        } <span class="keyword">else</span> { <span class="comment">//系统默认管理器</span></span><br><span class="line">          <span class="comment">//获取事务状态</span></span><br><span class="line">            TransactionStatus status = <span class="keyword">this</span>.transactionManager.getTransaction(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            Object result;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                result = action.doInTransaction(status); <span class="comment">//回调接口方法</span></span><br><span class="line">            } <span class="keyword">catch</span> (Error | RuntimeException var5) {</span><br><span class="line">                <span class="comment">//Transactional code threw applicatiion exception -&gt; rollback</span></span><br><span class="line">                <span class="comment">//回滚异常方法</span></span><br><span class="line">                <span class="keyword">this</span>.rollbackOnException(status, var5);</span><br><span class="line">                <span class="keyword">throw</span> var5; <span class="comment">//抛出异常</span></span><br><span class="line">            } <span class="keyword">catch</span> (Throwable var6) {</span><br><span class="line">                <span class="comment">//Transactional code threw error -&gt; rollback</span></span><br><span class="line">                <span class="comment">//回滚异常方法</span></span><br><span class="line">                <span class="keyword">this</span>.rollbackOnException(status, var6);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var6, <span class="string">"TransactionCallback threw undeclared checked exception"</span>); <span class="comment">//抛出异常</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.transactionManager.commit(status); <span class="comment">//提交事务</span></span><br><span class="line">            <span class="keyword">return</span> result; <span class="comment">//返回结果</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rollbackOnException</span><span class="params">(TransactionStatus status, Throwable ex)</span> <span class="keyword">throws</span> TransactionException </span>{</span><br><span class="line">        Assert.state(<span class="keyword">this</span>.transactionManager != <span class="keyword">null</span>, <span class="string">"No PlatformTransactionManager set"</span>);</span><br><span class="line">        <span class="keyword">this</span>.logger.debug(<span class="string">"Initiating transaction rollback on application exception"</span>, ex);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">this</span>.transactionManager.rollback(status);</span><br><span class="line">        } <span class="keyword">catch</span> (TransactionSystemException var4) {</span><br><span class="line">            <span class="keyword">this</span>.logger.error(<span class="string">"Application exception overridden by rollback exception"</span>, ex);</span><br><span class="line">            var4.initApplicationException(ex);</span><br><span class="line">            <span class="keyword">throw</span> var4;</span><br><span class="line">        } <span class="keyword">catch</span> (Error | RuntimeException var5) {</span><br><span class="line">            <span class="keyword">this</span>.logger.error(<span class="string">"Application exception overridden by rollback exception"</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> var5;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(@Nullable Object other)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span> == other || <span class="keyword">super</span>.equals(other) &amp;&amp; (!(other <span class="keyword">instanceof</span> TransactionTemplate) || <span class="keyword">this</span>.getTransactionManager() == ((TransactionTemplate)other).getTransactionManager());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="配置事务管理器"><a href="#配置事务管理器" class="headerlink" title="配置事务管理器"></a>配置事务管理器</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp2.BasicDataSource"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm?serverTimezone=UTC"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  连接池的最大数据库连接数  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"255"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  最大等待连接中的数量  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"5"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 最大等待毫秒数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWaitMillis"</span> <span class="attr">value</span>=<span class="string">"10000"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="编程式事务"><a href="#编程式事务" class="headerlink" title="编程式事务"></a>编程式事务</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.NonNull;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.NonNullApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.TransactionManagementConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> javax.xml.crypto.Data;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = {<span class="string">"com.louris.springboot"</span>})</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionConfig</span> <span class="keyword">implements</span> <span class="title">TransactionManagementConfigurer</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">initDataSource</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(dataSource != <span class="keyword">null</span>){</span><br><span class="line">            <span class="keyword">return</span> dataSource;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">"driverClassName"</span>, <span class="string">"com.mysql.cj.jdbc.Driver"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"url"</span>, <span class="string">"jdbc:mysql://localhost:3306/ssm"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"username"</span>, <span class="string">"root"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"password"</span>, <span class="string">"123456"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"maxTotal"</span>, <span class="string">"200"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"maxIdle"</span>, <span class="string">"20"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"maxWait"</span>, <span class="string">"30000"</span>);</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            dataSource = BasicDataSourceFactory.createDataSource(properties);</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"jdbcTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">initJdbcTemplate</span><span class="params">()</span></span>{</span><br><span class="line">        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate();</span><br><span class="line">        jdbcTemplate.setDataSource(initDataSource());</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span>(name=<span class="string">"transactionManager"</span>)</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionManager <span class="title">annotationDrivenTransactionManager</span><span class="params">()</span> </span>{</span><br><span class="line">        DataSourceTransactionManager dataSourceTransactionManager = <span class="keyword">new</span> DataSourceTransactionManager();</span><br><span class="line">        <span class="comment">//设置事务管理器管理的数据源</span></span><br><span class="line">        dataSourceTransactionManager.setDataSource(initDataSource());</span><br><span class="line">        <span class="keyword">return</span> dataSourceTransactionManager;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(TransactionConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">JdbcTemplate jdbcTemplate = applicationContext.getBean(JdbcTemplate<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//事务定义类</span></span><br><span class="line">TransactionDefinition transactionDefinition = <span class="keyword">new</span> DefaultTransactionDefinition();</span><br><span class="line">PlatformTransactionManager transactionManager = applicationContext.getBean(PlatformTransactionManager<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">TransactionStatus status = transactionManager.getTransaction(transactionDefinition);</span><br><span class="line"><span class="keyword">try</span>{</span><br><span class="line">    <span class="comment">//执行SQL语句</span></span><br><span class="line">    jdbcTemplate.update(<span class="string">"insert into t_role(role_name, note) values('role_name_transactionManager', 'note_transactionManager')"</span>);</span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//提交事务</span></span><br><span class="line">    transactionManager.commit(status);</span><br><span class="line">}<span class="keyword">catch</span>(Exception e){</span><br><span class="line">    <span class="comment">//回滚事务</span></span><br><span class="line">    transactionManager.rollback(status);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="声明式事务"><a href="#声明式事务" class="headerlink" title="声明式事务"></a>声明式事务</h2><h3 id="Transactional配置项"><a href="#Transactional配置项" class="headerlink" title="Transactional配置项"></a>Transactional配置项</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.transaction.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Inherited;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AliasFor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>({ElementType.TYPE, ElementType.METHOD})</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Transactional {</span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"transactionManager"</span>)</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"value"</span>)</span><br><span class="line">    <span class="function">String <span class="title">transactionManager</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    String[] label() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    <span class="function">Propagation <span class="title">propagation</span><span class="params">()</span> <span class="keyword">default</span> Propagation.REQUIRED</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Isolation <span class="title">isolation</span><span class="params">()</span> <span class="keyword">default</span> Isolation.DEFAULT</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">timeout</span><span class="params">()</span> <span class="keyword">default</span> -1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">timeoutString</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">readOnly</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] rollbackFor() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    String[] rollbackForClassName() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] noRollbackFor() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    String[] noRollbackForClassName() <span class="keyword">default</span> {};</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<table>
<thead>
<tr>
<th align="center">配置项</th>
<th align="center">含义</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">value</td>
<td align="center">定义事务管理器</td>
<td align="left">它是Spring IoC容器里的一个Bean id，这个Bean需要实现接口PlatformTransactionManager</td>
</tr>
<tr>
<td align="center">transactionManager</td>
<td align="center">同上</td>
<td align="left">同上</td>
</tr>
<tr>
<td align="center">isolation</td>
<td align="center">隔离级别</td>
<td align="left">这是一个数据库在多个事务同时存在时的概念。默认值取数据库默认隔离级别</td>
</tr>
<tr>
<td align="center">propagation</td>
<td align="center">传播行为</td>
<td align="left">传播行为是方法之间调用的问题，默认值为Propagation.REQUIRED</td>
</tr>
<tr>
<td align="center">timeout</td>
<td align="center">超时时间</td>
<td align="left">单位为秒，当超时时，会引发异常，默认会导致事务回滚</td>
</tr>
<tr>
<td align="center">readOnly</td>
<td align="center">是否开启只读事务</td>
<td align="left">默认值为false</td>
</tr>
<tr>
<td align="center">rollbackFor</td>
<td align="center">回滚事务的异常类定义</td>
<td align="left">也就是只有当方法产生所定义异常时，才回滚事务，否则就提交事务</td>
</tr>
<tr>
<td align="center">rollbackForClassName</td>
<td align="center">回滚事务的异常类名定义</td>
<td align="left">同rollbackFor，只是使用类名称定义</td>
</tr>
<tr>
<td align="center">noRollbackFor</td>
<td align="center">当产生哪些异常不回滚事务</td>
<td align="left">当产生所定义异常时，Spring将继续提交事务</td>
</tr>
<tr>
<td align="center">noRollbackForClassName</td>
<td align="center">同noRollbackFor</td>
<td align="left">同noRollbackFor，只是使用类的名称定义</td>
</tr>
</tbody></table>
<p>注意，使用声明式事务需要配置注解驱动：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用XML进行配置事务管理器"><a href="#使用XML进行配置事务管理器" class="headerlink" title="使用XML进行配置事务管理器"></a>使用XML进行配置事务管理器</h3><p>使用XML配置事务管理器的方法很多，但是也不常用，更多的还是会采用注解式的事务。</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionInterceptor"</span> <span class="attr">class</span>=<span class="string">"org.springframework.transaction.interceptor.TransactionInterceptor"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"transactionManager"</span> <span class="attr">ref</span>=<span class="string">"transactionManager"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置事务属性--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"transactionAttributes"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--key代表的是业务方法的正则式匹配，而其内容可以配置各类事务定义参数--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"insert*"</span>&gt;</span>PROPAGATION_REQUIRED,ISOLATION_READ_UNCOMMITTED<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"save*"</span>&gt;</span>PROPAGATION_REQUIRED,ISOLATION_READ_UNCOMMITTED<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"add*"</span>&gt;</span>PROPAGATION_REQUIRED,ISOLATION_READ_UNCOMMITTED<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"select*"</span>&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"get*"</span>&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"find*"</span>&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"del*"</span>&gt;</span>PROPAGATION_REQUIRED,ISOLATION_READ_UNCOMMITTED<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"remove*"</span>&gt;</span>PROPAGATION_REQUIRED,ISOLATION_READ_UNCOMMITTED<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"update*"</span>&gt;</span>PROPAGATION_REQUIRED,ISOLATION_READ_UNCOMMITTED<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  指明事务拦截器拦截哪些类  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"beanNames"</span>&gt;</span> <span class="comment">&lt;!--告诉spirng如何拦截类--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>*ServiceImpl<span class="tag">&lt;/<span class="name">value</span>&gt;</span> <span class="comment">&lt;!--所有关于Service是实现类都会被其拦截--&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interceptorNames"</span>&gt;</span> <span class="comment">&lt;!--定义事务拦截器--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>transactionInterceptor<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="事务定义器"><a href="#事务定义器" class="headerlink" title="事务定义器"></a>事务定义器</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionDefinition</span> </span>{</span><br><span class="line">    <span class="comment">//传播行为常量定义（7个）</span></span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_REQUIRED = <span class="number">0</span>; <span class="comment">//默认传播行为</span></span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_SUPPORTS = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_MANDATORY = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_REQUIRES_NEW = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_NOT_SUPPORTED = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_NEVER = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">int</span> PROPAGATION_NESTED = <span class="number">6</span>;</span><br><span class="line">    <span class="comment">//隔离级别定义（5个）</span></span><br><span class="line">    <span class="keyword">int</span> ISOLATION_DEFAULT = -<span class="number">1</span>; <span class="comment">//默认隔离级别</span></span><br><span class="line">    <span class="keyword">int</span> ISOLATION_READ_UNCOMMITTED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_READ_COMMITTED = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_REPEATABLE_READ = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> ISOLATION_SERIALIZABLE = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> TIMEOUT_DEFAULT = -<span class="number">1</span>; <span class="comment">//-1代表永不超时</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取传播行为</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">getPropagationBehavior</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取隔离级别</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">getIsolationLevel</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//事务超时时间</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">getTimeout</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//是否只读事务</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">isReadOnly</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取事务定义器的名称</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">getName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> TransactionDefinition <span class="title">withDefaults</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> StaticTransactionDefinition.INSTANCE;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>以上就是关于事务定义器的内容，除了异常的定义，其他关于事务的定义都可以在这里完成，而对于事务的回滚内容，它会议RollbackRuleAttribute和NoRollbackRuleAttribute两个类进行保存，这样在事务拦截器中就可以根据我们所配置的内容来处理事务方面的内容。</p>
<h3 id="声明式事务的约定流程"><a href="#声明式事务的约定流程" class="headerlink" title="声明式事务的约定流程"></a>声明式事务的约定流程</h3><p>@Transactional注解可以使用在方法或者类上，在Spring IoC容器初始化时，Spring会读入这个注解或者XML配置的事务信息，并且保存到一个事务定义类里面（TransactionDefinition接口的子类），以备将来使用。当运行时会让Spring拦截注解标注的某一个方法或者类的所有方法。谈到了拦截，可能会想到AOP，Spring也是如此。有了AOP的概念，那么它就会把你编写的代码织入到AOP的流程中，然后给出它的约定。</p>
<p>首先Spring通过事务管理器（PlatformTransactionManager的子类）创建事务，与此同时会把事务定义中的隔离级别、超时时间等属性根据配置内容往事务上设置。而根据传播行为配置采取一种特定的策略，后面会谈到传播行为的使用问题，这是Spring根据配置完成的内容，你只需要配置，无须编码。</p>
<p>然后，启动开发者提供的业务代码，我们知道Spring会通过反射的方式调度开发者的业务代码，但是反射的结果可能是正常返回或者产生异常返回，那么它给的约定是只要发生异常，并且符合事物定义类回滚条件的，Spring就会将数据库事务回滚，否则将数据库事务提交，这也是Spring自己完成的。</p>
<p>你会惊奇地发现，在整个开发过程中，只需要编写业务代码和对事务属性进行配置就可以了，并不需要使用代码干预，工作量比较少，代码逻辑也更为清晰，更有利于维护。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RoleDao roleDao = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT, timeout = <span class="number">3</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(Role role)</span></span>{</span><br><span class="line">  <span class="keyword">return</span> roleDao.insert(role);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SpringBoot项目启动入口类</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span>  <span class="comment">//SpringBoot核心朱姐，主要用于开启spring自动配置</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span> <span class="comment">//启动事务</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>{}</span><br></pre></td></tr></tbody></table></figure>

<p>这里没有数据库的资源打开和释放代码，也没看到数据库提交的代码，只看到了注解@Transactional。它配置了Propagation.REQUIRED的传播行为，这意味着当别的方法调度时，如果存在事务就沿用下来，如果不存在事务就开启新的事务，而隔离级别采用默认的隔离级别，并且设置超时时间为3秒。其他的开发人员只要知道当roleDao的insert方法抛出异常时，Spring就会回滚事务，如果成功，就提交事务。这样Spring就让开发人员主要精力放在业务的开发上，而不是控制数据库的资源和事务上。</p>
<p>但是我们必须清楚的是，这里的神奇原理是Spring AOP技术，而其底层的实现原理是动态代理，也就是只有代理对象相互调用才能想AOP那么神奇。</p>
<h2 id="数据库相关知识"><a href="#数据库相关知识" class="headerlink" title="数据库相关知识"></a>数据库相关知识</h2><h3 id="数据库事务ACID特性"><a href="#数据库事务ACID特性" class="headerlink" title="数据库事务ACID特性"></a>数据库事务ACID特性</h3><ul>
<li>原子性（Atomicity）</li>
<li>一致性（Consistency）</li>
<li>隔离性（Isolation）</li>
<li>持久性（Durability）</li>
</ul>
<h3 id="丢失更新"><a href="#丢失更新" class="headerlink" title="丢失更新"></a>丢失更新</h3><h4 id="第一类丢失更新"><a href="#第一类丢失更新" class="headerlink" title="第一类丢失更新"></a>第一类丢失更新</h4><p>假设一个场景，一个账户存在互联网消费和刷卡消费，而一对夫妻共用这个账户。老公喜欢刷卡消费，老婆喜欢互联网消费。老公查询余额10000元，请客吃饭消费1000元，提交事务成功，余额9000元；同时老婆查询10000元月，网购1000元，在老公提交事务成功后，突然不想买了，取消购买，回滚事务，余额还是10000元，这是不符合事实的。</p>
<h4 id="第二类丢失更新"><a href="#第二类丢失更新" class="headerlink" title="第二类丢失更新"></a>第二类丢失更新</h4><p>同前一节，不同的是，这里老婆也提交事务成功，余额还是9000元，这是不符合事实的。</p>
<p>为了克服事务之间协助的一致性，数据库标准规范中定义了事务之间的隔离级别，来在不同程度上减少出现丢失更新的可能性。</p>
<h3 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h3><p>读未提交、读已提交、可重复度、序列化</p>
<h2 id="选择隔离级别和传播行为"><a href="#选择隔离级别和传播行为" class="headerlink" title="选择隔离级别和传播行为"></a>选择隔离级别和传播行为</h2><h3 id="选择隔离级别"><a href="#选择隔离级别" class="headerlink" title="选择隔离级别"></a>选择隔离级别</h3><ul>
<li>在互联网应用中，不但要考虑数据库数据的一致性，而且要考虑系统的性能。一般而言，从脏读到序列化，系统性能直线下降。</li>
<li>在大部分场景下，企业会选择读/写提交的方式设置事务。这样既有助于提高并发，又压制了藏独，但是对于数据一致性问题并没有解决。</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RoleDao roleDao = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED, isolation = Isolation.READ_COMMITTED)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(Role role)</span></span>{</span><br><span class="line">  <span class="keyword">return</span> roleDao.insert(role);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>当业务并发量不是很大或者根本不需要考虑的情况下，使用序列化隔离级别用以保证数据的一致性，也是一个不错的选择。</li>
<li>总之，隔离级别需要根据并发的大小和性能作出决定，对于并发不打又要保证数据安全性的可以使用序列化的隔离级别，这样就能保证数据库在多事务环境汇总的一致性。</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RoleDao roleDao = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED, isolation = Isolation.SERIALIZABLE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(Role role)</span></span>{</span><br><span class="line">  <span class="keyword">return</span> roleDao.insert(role);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="传播行为"><a href="#传播行为" class="headerlink" title="传播行为"></a>传播行为</h3><p>传播行为是指方法之间的调用事务策略的问题。在大部分情况下，我们都希望事务能够同时成功或者同时失败。但是也会有例外，比如批次还款，不希望其中一次还款失败而导致整体其他已成功还款的业务回滚。</p>
<p>解决方法是，批次调度还款是产生一个新事务，如果这次异常，只会回滚本次，而不会回滚主事务。</p>
<p>类似这种一个方法调度另外一个方法时，可以对事务的特性进行传播配置，称为<strong>传播行为</strong>。</p>
<table>
<thead>
<tr>
<th align="center">传播行为</th>
<th align="center">含义</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">REQUIRED</td>
<td align="center">当方法调用时，如果不存在当前事务，那么就创建事务；如果之前的方法已经存在事务了，那么就沿用之前的事务</td>
<td align="center">这是Spring默认的传播行为</td>
</tr>
<tr>
<td align="center">SUPPORTS</td>
<td align="center">当方法调用时，如果不存在当前事务，那么不启用事务；如果存在当前事务，那么就沿用当前事务</td>
<td align="center">——</td>
</tr>
<tr>
<td align="center">MADATORY</td>
<td align="center">方法必须在事务内运行</td>
<td align="center">如果不存在当前事务，那么就抛出异常</td>
</tr>
<tr>
<td align="center">REQUIRES_NEW</td>
<td align="center">无论是否存在当前事务，方法都会在新的事务中运行</td>
<td align="center">也就是事务管理器会打开新的事务运行该方法</td>
</tr>
<tr>
<td align="center">NOT_SUPPORTED</td>
<td align="center">不支持事务，如果不存在当前事务也不会创建事务；如果存在当前事务，则挂起它，直至该方法结束后才回复当前事务</td>
<td align="center">适用于那些不需要事务的SQL</td>
</tr>
<tr>
<td align="center">NEVER</td>
<td align="center">不支持事务，只有在没有事务的环境中才能运行它</td>
<td align="center">如果方法存在当前事务，则抛出异常</td>
</tr>
<tr>
<td align="center">NESTED</td>
<td align="center">嵌套事务，也就是调用方法如果抛出异常只回滚自己内部执行的SQL，而不回滚主方法的SQL</td>
<td align="center">它的实现存在两种情况，如果当前数据库支持保存点(savepoint)，那么它就会在当前事务上使用保存点技术；如果发生异常则将方法内执行的SQL回滚到保存点上，而不是全部回滚，否则就等同于REQUIRES_NEW创建新的事务运行方法代码</td>
</tr>
</tbody></table>
<h2 id="Transactional的自调用失效问题"><a href="#Transactional的自调用失效问题" class="headerlink" title="@Transactional的自调用失效问题"></a>@Transactional的自调用失效问题</h2><ul>
<li>对于静态（static）方法和非public方法，注解@Transactional是失效的。</li>
<li>自调用失效</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.RoleMapper;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleDataService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Isolation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleDataServiceImpl</span> <span class="keyword">implements</span> <span class="title">RoleDataService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RoleMapper roleMapper = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.REQUIRES_NEW, isolation = Isolation.READ_COMMITTED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(Role role)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleMapper.insertRole(role);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED, isolation = Isolation.READ_COMMITTED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRoleList</span><span class="params">(List&lt;Role&gt; roleList)</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(Role role : roleList){</span><br><span class="line">            <span class="keyword">try</span>{</span><br><span class="line">                <span class="comment">//调用自身类的方法，产生自调用问题</span></span><br><span class="line">                <span class="keyword">int</span> i = insertRole(role);</span><br><span class="line">                count ++;</span><br><span class="line">            }<span class="keyword">catch</span> (Exception ex){</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Java <span class="title">HotSpot</span><span class="params">(TM)</span> 64-Bit Server VM warning: Options -Xverify:none and -noverify were deprecated in JDK 13 and will likely be removed in a future release.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .   ____          _            __ _ _</span></span><br><span class="line"><span class="function"> /\\ / ___'_ __ _ <span class="title">_</span><span class="params">(_)</span>_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="function"><span class="params">( ( )</span>\___ | '_ | '_| | '_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="function"> \\/  ___)| |_)| | | | | || <span class="params">(_| |  )</span> ) ) )</span></span><br><span class="line"><span class="function">  `  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="function"> </span>=========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v <span class="number">2.4</span><span class="number">.4</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">04.630</span> [main] INFO  com.louris.springboot.Application - Starting Application using Java <span class="number">14.0</span><span class="number">.2</span> on WINDOWS-PT43L0L with PID <span class="number">34280</span> (D:\SpringBootCourse\<span class="number">001</span>-springboot-first\target\classes started by louris in D:\SpringBootCourse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">04.632</span> [main] DEBUG com.louris.springboot.Application - Running with Spring Boot v2<span class="number">.4</span><span class="number">.4</span>, Spring v5<span class="number">.3</span><span class="number">.5</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">04.633</span> [main] INFO  com.louris.springboot.Application - The following profiles are active: dev</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">05.033</span> [main] DEBUG o.m.s.boot.autoconfigure.MybatisAutoConfiguration - Searching <span class="keyword">for</span> mappers annotated with <span class="meta">@Mapper</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">05.033</span> [main] DEBUG o.m.s.boot.autoconfigure.MybatisAutoConfiguration - Using auto-configuration base <span class="keyword">package</span> <span class="string">'com.louris.springboot'</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">05.037</span> [main] DEBUG org.apache.ibatis.logging.LogFactory - Logging initialized using <span class="string">'class org.apache.ibatis.logging.slf4j.Slf4jImpl'</span> adapter.</span><br><span class="line">2021-09-21 22:00:05.045 [main] DEBUG org.mybatis.spring.mapper.ClassPathMapperScanner - Identified candidate component class: file [D:\SpringBootCourse\001-springboot-first\target\classes\com\louris\springboot\IoCImpl\mapper\RoleMapper.class]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">05.047</span> [main] DEBUG org.mybatis.spring.mapper.ClassPathMapperScanner - Creating MapperFactoryBean with name <span class="string">'roleMapper'</span> and <span class="string">'com.louris.springboot.IoCImpl.mapper.RoleMapper'</span> mapperInterface</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">05.048</span> [main] DEBUG org.mybatis.spring.mapper.ClassPathMapperScanner - Enabling autowire by type <span class="keyword">for</span> MapperFactoryBean with name <span class="string">'roleMapper'</span>.</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">05.354</span> [main] INFO  o.s.boot.web.embedded.tomcat.TomcatWebServer - <span class="function">Tomcat initialized with <span class="title">port</span><span class="params">(s)</span>: 8081 <span class="params">(http)</span></span></span><br><span class="line"><span class="function">2021-09-21 22:00:05.361 [main] INFO  org.apache.coyote.http11.Http11NioProtocol - Initializing ProtocolHandler ["http-nio-8081"]</span></span><br><span class="line"><span class="function">2021-09-21 22:00:05.361 [main] INFO  org.apache.catalina.core.StandardService - Starting service [Tomcat]</span></span><br><span class="line"><span class="function">2021-09-21 22:00:05.361 [main] INFO  org.apache.catalina.core.StandardEngine - Starting Servlet engine: [Apache Tomcat/9.0.44]</span></span><br><span class="line"><span class="function">2021-09-21 22:00:05.431 [main] INFO  o.a.c.core.ContainerBase.[Tomcat].[localhost].[/] - Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="function">2021-09-21 22:00:05.431 [main] INFO  o.s.b.w.s.c.ServletWebServerApplicationContext - Root WebApplicationContext: initialization completed in 757 ms</span></span><br><span class="line"><span class="function">2021-09-21 22:00:05.587 [main] DEBUG org.mybatis.spring.SqlSessionFactoryBean - Parsed mapper file: 'file [D:\SpringBootCourse\001-springboot-first\target\classes\mapper\RoleMapper.xml]'</span></span><br><span class="line"><span class="function">2021-09-21 22:00:05.665 [main] INFO  o.s.scheduling.concurrent.ThreadPoolTaskExecutor - Initializing ExecutorService 'applicationTaskExecutor'</span></span><br><span class="line"><span class="function">2021-09-21 22:00:05.700 [main] DEBUG _.s.web.servlet.HandlerMapping.Mappings -</span></span><br><span class="line"><span class="function">	o.s.b.a.w.s.e.BasicErrorController:</span></span><br><span class="line"><span class="function">	</span>{ [/error]}: error(HttpServletRequest)</span><br><span class="line">	{ [/error], produces [text/html]}: errorHtml(HttpServletRequest,HttpServletResponse)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">05.712</span> [main] DEBUG _.s.web.servlet.HandlerMapping.Mappings - <span class="string">'beanNameHandlerMapping'</span> {}</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">05.720</span> [main] DEBUG _.s.web.servlet.HandlerMapping.Mappings - <span class="string">'resourceHandlerMapping'</span> {/webjars/ **=ResourceHttpRequestHandler [Classpath [META-INF/resources/webjars/]], / **=ResourceHttpRequestHandler [Classpath [META-INF/resources/], Classpath [resources/], Classpath [<span class="keyword">static</span>/], Classpath [<span class="keyword">public</span>/], ServletContext [/]]}</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">05.733</span> [main] DEBUG o.m.s.boot.autoconfigure.MybatisAutoConfiguration - No org.mybatis.spring.mapper.MapperFactoryBean found.</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">05.777</span> [main] INFO  org.apache.coyote.http11.Http11NioProtocol - Starting ProtocolHandler [<span class="string">"http-nio-8081"</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">05.791</span> [main] INFO  o.s.boot.web.embedded.tomcat.TomcatWebServer - <span class="function">Tomcat started on <span class="title">port</span><span class="params">(s)</span>: 8081 <span class="params">(http)</span> with context path ''</span></span><br><span class="line"><span class="function">2021-09-21 22:00:05.798 [main] INFO  com.louris.springboot.Application - Started Application in 1.489 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">1.972</span>)</span></span></span><br><span class="line"><span class="function">2021-09-21 22:00:06.044 [main] DEBUG org.mybatis.spring.SqlSessionUtils - Creating a new SqlSession</span></span><br><span class="line"><span class="function">2021-09-21 22:00:06.046 [main] DEBUG org.mybatis.spring.SqlSessionUtils - Registering transaction synchronization <span class="keyword">for</span> SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3815146b]</span></span><br><span class="line"><span class="function">2021-09-21 22:00:06.050 [main] DEBUG o.m.spring.transaction.SpringManagedTransaction - JDBC Connection [1341975886, URL</span>=jdbc:mysql:/ /localhost:<span class="number">3306</span>/ssm?useUnicode=<span class="keyword">true</span>&amp;characterEncoding=UTF-<span class="number">8</span>&amp;useJDBCCompliantTimezoneShift=<span class="keyword">true</span>&amp;useLegacyDatetimeCode=<span class="keyword">false</span>&amp;serverTimezone=GMT%<span class="number">2</span>B8, MySQL Connector/J] will be managed by Spring</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">06.053</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - ==&gt;  Preparing: <span class="function">insert into <span class="title">t_role</span><span class="params">(role_name, note)</span> <span class="title">values</span><span class="params">(?, ?)</span>  </span></span><br><span class="line"><span class="function">2021-09-21 22:00:06.067 [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - </span>==&gt; Parameters: role_name_1(String), note_1(String)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">06.068</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - &lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">06.075</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">3815146</span>b]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">06.075</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Fetched SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">3815146</span>b] from current transaction</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">06.075</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - ==&gt;  Preparing: <span class="function">insert into <span class="title">t_role</span><span class="params">(role_name, note)</span> <span class="title">values</span><span class="params">(?, ?)</span>  </span></span><br><span class="line"><span class="function">2021-09-21 22:00:06.076 [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - </span>==&gt; Parameters: role_name_2(String), note_2(String)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">06.077</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - &lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">06.077</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">3815146</span>b]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">06.077</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization committing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">3815146</span>b]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">06.077</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">3815146</span>b]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">06.077</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">3815146</span>b]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="出现原因"><a href="#出现原因" class="headerlink" title="出现原因"></a>出现原因</h3><p>在insertRoleList方法的实现中，它调用了自身类实现isertRole的方法，而insertRole声明式REQUIRES_NEW的传播行为，也就是每次调用就会产生新的事务运行，但是通过日志可以发现只有一次</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Create a new SqlSession</span><br></pre></td></tr></tbody></table></figure>
<p>说明角色插入两次都使用了同一事务，也就是说，在insertRole上标注的@Transactional失效了，这是一个很容易掉进去的陷阱。</p>
<p>出现这个问题的根本原因在于AOP的实现原理。由于@Transactional的实现原理是AOP，而AOP的实现原理是动态代理，而上述代码是自己调用自己的过程。换句话说，并不存在代理对象的调用，这样就不会产生AOP去为我们设置@Transactional配置的参数，这样就出现了自调用注解失败的问题！</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>（1）可以使用两个服务类，Spring IoC容器中为你生成了RoleService的代理对象，这样就可以使用AOP，且不会出现该问题；<br>（2）也可以直接从容器中获取RoleService的代理对象，如下所示：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.RoleMapper;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleDataService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Isolation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleDataServiceImpl</span> <span class="keyword">implements</span> <span class="title">RoleDataService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ApplicationContext applicationContext = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RoleMapper roleMapper = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.REQUIRES_NEW, isolation = Isolation.READ_COMMITTED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(Role role)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleMapper.insertRole(role);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED, isolation = Isolation.READ_COMMITTED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRoleList</span><span class="params">(List&lt;Role&gt; roleList)</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        RoleDataService roleDataService = applicationContext.getBean(RoleDataService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">for</span>(Role role : roleList){</span><br><span class="line">            <span class="keyword">try</span>{</span><br><span class="line"><span class="comment">//                //调用自身类的方法，产生自调用问题</span></span><br><span class="line"><span class="comment">//                int i = insertRole(role);</span></span><br><span class="line">                roleDataService.insertRole(role);</span><br><span class="line">                count ++;</span><br><span class="line">            }<span class="keyword">catch</span> (Exception ex){</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.580</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Creating a <span class="keyword">new</span> SqlSession</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.582</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Registering transaction synchronization <span class="keyword">for</span> SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">6222391</span>a]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.586</span> [main] DEBUG o.m.spring.transaction.SpringManagedTransaction - JDBC Connection [<span class="number">1745904086</span>, URL=jdbc:mysql:/ /localhost:<span class="number">3306</span>/ssm?useUnicode=<span class="keyword">true</span>&amp;characterEncoding=UTF-<span class="number">8</span>&amp;useJDBCCompliantTimezoneShift=<span class="keyword">true</span>&amp;useLegacyDatetimeCode=<span class="keyword">false</span>&amp;serverTimezone=GMT%<span class="number">2</span>B8, MySQL Connector/J] will be managed by Spring</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.588</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - ==&gt;  Preparing: <span class="function">insert into <span class="title">t_role</span><span class="params">(role_name, note)</span> <span class="title">values</span><span class="params">(?, ?)</span>  </span></span><br><span class="line"><span class="function">2021-09-21 22:10:48.601 [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - </span>==&gt; Parameters: role_name_1(String), note_1(String)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.607</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - &lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.613</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">6222391</span>a]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.613</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization committing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">6222391</span>a]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.613</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">6222391</span>a]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.613</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">6222391</span>a]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.646</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Creating a <span class="keyword">new</span> SqlSession</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.646</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Registering transaction synchronization <span class="keyword">for</span> SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">129</span>c4d19]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.646</span> [main] DEBUG o.m.spring.transaction.SpringManagedTransaction - JDBC Connection [<span class="number">321358401</span>, URL=jdbc:mysql:/ /localhost:<span class="number">3306</span>/ssm?useUnicode=<span class="keyword">true</span>&amp;characterEncoding=UTF-<span class="number">8</span>&amp;useJDBCCompliantTimezoneShift=<span class="keyword">true</span>&amp;useLegacyDatetimeCode=<span class="keyword">false</span>&amp;serverTimezone=GMT%<span class="number">2</span>B8, MySQL Connector/J] will be managed by Spring</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.647</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - ==&gt;  Preparing: <span class="function">insert into <span class="title">t_role</span><span class="params">(role_name, note)</span> <span class="title">values</span><span class="params">(?, ?)</span>  </span></span><br><span class="line"><span class="function">2021-09-21 22:10:48.647 [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - </span>==&gt; Parameters: role_name_2(String), note_2(String)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.648</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - &lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.648</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">129</span>c4d19]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.648</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization committing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">129</span>c4d19]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.648</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">129</span>c4d19]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">10</span>:<span class="number">48.648</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">129</span>c4d19]</span><br></pre></td></tr></tbody></table></figure>

<h2 id="典型错误用法的剖析"><a href="#典型错误用法的剖析" class="headerlink" title="典型错误用法的剖析"></a>典型错误用法的剖析</h2><h3 id="错误使用Service"><a href="#错误使用Service" class="headerlink" title="错误使用Service"></a>错误使用Service</h3><p>互联网往往曹勇模型——视图——控制器来搭建开发环境，因此在Controller中使用Service是十分常见的。<br>以下代码中，当一个Controller使用Service方法时，如果这个Service标注有@Transactional，那么它就会启用一个事务，而一个Service方法完成后，它就会释放该事务，所以前后两个insertRole的方法时在两个不同的事务中完成的。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Role&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">Role role = <span class="keyword">new</span> Role();</span><br><span class="line">role.setRoleName(<span class="string">"role_name_1"</span>);</span><br><span class="line">role.setNote(<span class="string">"note_1"</span>);</span><br><span class="line"></span><br><span class="line">Role role1 = <span class="keyword">new</span> Role();</span><br><span class="line">role1.setRoleName(<span class="string">"role_name_2"</span>);</span><br><span class="line">role1.setNote(<span class="string">"note_2"</span>);</span><br><span class="line"></span><br><span class="line">RoleDataService roleDataService = applicationContext.getBean(RoleDataService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">roleDataService.insertRole(role);</span><br><span class="line">roleDataService.insertRole(role1);</span><br></pre></td></tr></tbody></table></figure>

<p>日志可以证实这一点，明确地说明使用带有事务的Service，当调用时，如果不是调用Service方法，Spring会为你创建对应的数据库事务。如果多次调用，则不再同一个事务中，这会造成不同时提交和回滚不一致的问题。每一个Java EE开发者都要注意这类问题，以避免一些不必要的错误。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.893</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Creating a <span class="keyword">new</span> SqlSession</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.895</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Registering transaction synchronization <span class="keyword">for</span> SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">508</span>ad266]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.899</span> [main] DEBUG o.m.spring.transaction.SpringManagedTransaction - JDBC Connection [<span class="number">1772358460</span>, URL=jdbc:mysql:/ /localhost:<span class="number">3306</span>/ssm?useUnicode=<span class="keyword">true</span>&amp;characterEncoding=UTF-<span class="number">8</span>&amp;useJDBCCompliantTimezoneShift=<span class="keyword">true</span>&amp;useLegacyDatetimeCode=<span class="keyword">false</span>&amp;serverTimezone=GMT%<span class="number">2</span>B8, MySQL Connector/J] will be managed by Spring</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.901</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - ==&gt;  Preparing: <span class="function">insert into <span class="title">t_role</span><span class="params">(role_name, note)</span> <span class="title">values</span><span class="params">(?, ?)</span>  </span></span><br><span class="line"><span class="function">2021-09-22 10:14:49.916 [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - </span>==&gt; Parameters: role_name_1(String), note_1(String)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.918</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - &lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.924</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">508</span>ad266]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.924</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization committing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">508</span>ad266]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.925</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">508</span>ad266]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.925</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">508</span>ad266]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.972</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Creating a <span class="keyword">new</span> SqlSession</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.972</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Registering transaction synchronization <span class="keyword">for</span> SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">4</span>a31ed12]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.973</span> [main] DEBUG o.m.spring.transaction.SpringManagedTransaction - JDBC Connection [<span class="number">593881656</span>, URL=jdbc:mysql:/ /localhost:<span class="number">3306</span>/ssm?useUnicode=<span class="keyword">true</span>&amp;characterEncoding=UTF-<span class="number">8</span>&amp;useJDBCCompliantTimezoneShift=<span class="keyword">true</span>&amp;useLegacyDatetimeCode=<span class="keyword">false</span>&amp;serverTimezone=GMT%<span class="number">2</span>B8, MySQL Connector/J] will be managed by Spring</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.973</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - ==&gt;  Preparing: <span class="function">insert into <span class="title">t_role</span><span class="params">(role_name, note)</span> <span class="title">values</span><span class="params">(?, ?)</span>  </span></span><br><span class="line"><span class="function">2021-09-22 10:14:49.973 [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - </span>==&gt; Parameters: role_name_2(String), note_2(String)</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.974</span> [main] DEBUG c.l.s.IoCImpl.mapper.RoleMapper.insertRole - &lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.974</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">4</span>a31ed12]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.974</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization committing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">4</span>a31ed12]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.974</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">4</span>a31ed12]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">10</span>:<span class="number">14</span>:<span class="number">49.974</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">4</span>a31ed12]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="过长时间占用事务"><a href="#过长时间占用事务" class="headerlink" title="过长时间占用事务"></a>过长时间占用事务</h3><p>在企业的生产系统中，数据库事务资源是最宝贵的资源之一，使用了数据库事务之后，要及时释放数据库事务。换言之，我们应该尽可能地使用数据库事务资源去完成所需工作，但是在一些工作中需要使用到文件、对外连接等操作，而这些操作往往会占用较长时间，针对这些，如果开发者不注意细节，就很容易出现系统宕机的问题。</p>
<p>以下代码在insertRole方法结束后，Spring才会释放数据库事务资源，也就是说在运行doSomethingForFile方法时，Spring并没有释放数据库事务资源，而等到doSomethingForFile方法运行完成后，返回result后才会关闭数据库资源。</p>
<p>在大型互联网系统中，一个数据库的链接可能也就是50条左右，然而同时并发的请求则可能是成百上千。对于这些请求，大部分的并发请求都在等待50条占有数据库连接资源的文件操作了。加入平均一个doSomethingForFile的操作需要1秒，对于同时出现1000条并发请求的网站，就会出现请求卡顿的状态。因为大部分的请求都在等待数据库事务资源的分配，这是一个糟糕的结果。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span>(propagation = Propagation.REQUIRES_NEW, isolation = Isolation.READ_COMMITTED)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(Role role)</span> </span>{</span><br><span class="line">    <span class="comment">//return roleMapper.insertRole(role);</span></span><br><span class="line">    <span class="keyword">int</span> result = roleMapper.insertRole(role);</span><br><span class="line">    <span class="comment">//操作一些与数据库无关的操作</span></span><br><span class="line">    doSomethingForFile()</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>正确做法是Controller进行非数据库操作，如下所示，当程序运行完isnertRole方法后，Spring会释放数据库事务资源，而不再占用。对于doSomethingForFile方法而言，已经在一个没有事务的环境中运行了，这样当前的请求就不会长期占用数据库事务资源，使得其他并发的请求被迫等待其释放了。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/addRole"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Role <span class="title">addRole</span><span class="params">(Role role)</span></span>{</span><br><span class="line">    roleService.insertRole(role);</span><br><span class="line">    doSomethingForFild();</span><br><span class="line">    <span class="keyword">return</span> role;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="错误捕获异常"><a href="#错误捕获异常" class="headerlink" title="错误捕获异常"></a>错误捕获异常</h3><p>模拟一段购买商品的代码，其中ProductService是产品服务类，而TransactionService是记录交易信息，需求显然就是产品减库存和保存交易在同一个事务里面，要么同时成功，要么同时失败，并且假设减库存和保存交易的传播行为都为REQUIRED。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TransactionService transactionService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span>(propagation=Propagation.REQUIRED, isolation=Isolation.READ_COMMITTED)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doTranslation</span><span class="params">(TranslationBean trans)</span></span>{</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">try</span>{</span><br><span class="line">    <span class="comment">//减少库存</span></span><br><span class="line">    <span class="keyword">int</span> result = productService.decreaseStock(trans.getProductid(), trans.getQuantity());</span><br><span class="line">    <span class="comment">//如果减少库存成功则保存记录</span></span><br><span class="line">    <span class="keyword">if</span>(result &gt; <span class="number">0</span>){</span><br><span class="line">      transactionService.save(trans);</span><br><span class="line">    }</span><br><span class="line">  }<span class="keyword">catch</span>(Exception ex){</span><br><span class="line">    <span class="comment">//自行处理异常代码</span></span><br><span class="line">    <span class="comment">//记录异常日志</span></span><br><span class="line">    log.info(ex);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里的问题是方法已经存在异常了，由于开发者不了解Spring的事务约定，在两个操作的方法里面加入了自己的try…catch…语句，就可能发生这样的结果。当减少库存成功了，但是保存交易信息时失败而发生了异常，此时由于开发者加入了try…catch…语句，所以Spring在数据库事务所约定的流程中再也得不到任何异常信息了，此时Spring就会提交事务，<strong>这样就出现了库存减少，而交易记录却没有的糟糕情况</strong>。在那些需要大量异常处理的代码中，我们要小心这样的问题。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TransactionService transactionService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span>(propagation=Propagation.REQUIRED, isolation=Isolation.READ_COMMITTED)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doTranslation</span><span class="params">(TranslationBean trans)</span></span>{</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">try</span>{</span><br><span class="line">    <span class="comment">//减少库存</span></span><br><span class="line">    <span class="keyword">int</span> result = productService.decreaseStock(trans.getProductid(), trans.getQuantity());</span><br><span class="line">    <span class="comment">//如果减少库存成功则保存记录</span></span><br><span class="line">    <span class="keyword">if</span>(result &gt; <span class="number">0</span>){</span><br><span class="line">      transactionService.save(trans);</span><br><span class="line">    }</span><br><span class="line">  }<span class="keyword">catch</span>(Exception ex){</span><br><span class="line">    <span class="comment">//自行处理异常代码</span></span><br><span class="line">    <span class="comment">//记录异常日志</span></span><br><span class="line">    log.info(ex);</span><br><span class="line">    <span class="comment">//自行抛出异常，让Spring事务管理流程获取异常，进行事务管理</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>注意throw抛出了一个运行异常，这样在Spring的事务流程汇总，就会捕捉到抛出的这个异常，进行事务回滚，从而保证了产品减库存和交易记录保存的一致性，这才是正确的用法，使用事务时要时刻记住Spring和我们的约定流程。</p>
<blockquote>
<h1 id="Spring-MVC-框架"><a href="#Spring-MVC-框架" class="headerlink" title="Spring MVC 框架"></a>Spring MVC 框架</h1></blockquote>
<blockquote>
<h1 id="Spring-MVC的初始化和流程"><a href="#Spring-MVC的初始化和流程" class="headerlink" title="Spring MVC的初始化和流程"></a>Spring MVC的初始化和流程</h1></blockquote>
<h2 id="MVC设计概述"><a href="#MVC设计概述" class="headerlink" title="MVC设计概述"></a>MVC设计概述</h2><h3 id="SpringMVC的组件和流程"><a href="#SpringMVC的组件和流程" class="headerlink" title="SpringMVC的组件和流程"></a>SpringMVC的组件和流程</h3><p>Spring MVC的核心在于其流程，这是使用Spring MVC框架的基础，Spring MVC是一种基于Servlet的技术，它提供了核心控制器DispatcherServlet和相关的组件，并制定了松散的结构，以适合各种灵活的需要。</p>
<p>首先，Spring MVC框架爱是围绕着DispatcherServlet而工作的，所以这个类是其最为重要的类。从它的名字来看，它是一个Servlet，它可以拦截HTTP发送过来的请求，在Servlet初始化（调用init方法）时，Spring MVC会根据配置，获取配置信息，从而得到统一资源标识符（URI, Uniform Resource Identifier）和处理器（Handler）之间的映射关系（HandlerMapping），为了更加灵活和增强功能，Spring MVC还会给处理器加入拦截器，所以还可以在处理器执行前后加入自己的代码，这样就构成了一个处理器的执行链（HandlerExecutionChain），并且根据上下文初始化视图解析器等内容，当处理器返回的时候就可以通过视图解析器定位视图，然后将数据模型渲染到视图中，用来响应用户的请求了。</p>
<p>当一个请求到来时，DispatcherServlet首先通过请求和事先解析好的HandlerMapping配置，找到对应的处理器（Handler），这样就准备开始运行处理器和拦截器组成的执行链，而运行处理器需要有一个对应的环境，这样它就有了一个处理器的适配器（HandlerAdapter），通过这个适配器就能运行对应的处理器及其拦截器，这里的处理器包含了控制器的内容和其他增强的功能，在处理器返回模型和视图给DispacherServlet后，DispacherServlet就会把对应的视图信息传递给视图解析器（ViewResolver）。注意，这一步取决于是否使用逻辑视图，如果使用逻辑视图，那么视图解析器就会解析它，然后把模型渲染到视图中去，最后响应用户的请求；如果不是逻辑视图，则不会进行处理，而是直接通过视图渲染数据模型。这就是一个Spring MVC完整的流程，它是一个松散的结构，所以可以满足各类请求的需要。</p>
<h3 id="Spring-MVC-入门的实例"><a href="#Spring-MVC-入门的实例" class="headerlink" title="Spring MVC 入门的实例"></a>Spring MVC 入门的实例</h3><p>启动thymeleaf</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="comment">//@RequestMapping(value = "")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/index"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">index</span><span class="params">()</span></span>{</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, Spring MVC<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="Spring-MVC开发流程详解"><a href="#Spring-MVC开发流程详解" class="headerlink" title="Spring MVC开发流程详解"></a>Spring MVC开发流程详解</h2><p>在目前的开发过程中，大部分都会采用注解的开发方式，使用注解在Spring MVC中十分简单，主要是以一个注解@Controller标注，一般只需要通过扫描设置，就能将其扫描出来，只是往往还要结合注解@RequestMapping去配置它。@RequestMapping可以配置在类或方法之上，它的作用是指定URI和哪个类（或方法）作为一个处理请求的处理器，为了更加灵活，Spring MVC还定义了处理器的拦截器，当启动Spring MVC的时候，Spring MVC就会去解析@Controller中的@RequestMapping的配置，再结合所配置的拦截器，这样它就会组成多个拦截器和一个控制器的形式，存放到一个HandlerMapping中去。当请求来到服务器，首先是通过请求信息找到对应的handlerMapping，进而可以找到对应的拦截器和处理器，这样就能够运行对应的控制器和拦截器。</p>
<h3 id="配置-RequestMapping"><a href="#配置-RequestMapping" class="headerlink" title="配置@RequestMapping"></a>配置@RequestMapping</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.web.bind.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AliasFor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>({ElementType.TYPE, ElementType.METHOD})</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Mapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RequestMapping {</span><br><span class="line">    <span class="comment">//请求路径</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求路径，可以是数组</span></span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"path"</span>)</span><br><span class="line">    String[] value() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求路径，数组</span></span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"value"</span>)</span><br><span class="line">    String[] path() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求类型，比如是HTTP的GET请求还是POST请求等，HTTP请求枚举取值范围为：GET、HEAD、POST、PUT、PATCH、DELETE、OPTIONS、TRACE，常用的是GET和POST请求</span></span><br><span class="line">    RequestMethod[] method() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求参数，当请求带有配置的参数时，才匹配处理器</span></span><br><span class="line">    String[] params() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求头，当HTTP请求头尾配置项时，才匹配处理器</span></span><br><span class="line">    String[] headers() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求类型为配置类型才匹配处理器</span></span><br><span class="line">    String[] consumes() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理器之后的响应用户的结果类型，比如{"application/json; charset=UTF-8", "text/plain", "application/*"}</span></span><br><span class="line">    String[] produces() <span class="keyword">default</span> {};</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="控制器的开发"><a href="#控制器的开发" class="headerlink" title="控制器的开发"></a>控制器的开发</h3><h4 id="获取请求参数"><a href="#获取请求参数" class="headerlink" title="获取请求参数"></a>获取请求参数</h4><p>(1)不建议使用Servlet容器所给予的API，因为这样控制器将会依赖于Servlet容器。<br>Spring MVC会自动解析代码中的方法参数session、request，然后传递关于Servlet容器的API参数，所以是可以获取到的。通过request或者session都可以很容易地得到HTTP请求过来的参数，这固然是一个方法，但并非一个好的方法。<br>因为如果这样做了，那么对于idnex2方法而言，它就和Servlet容器紧密关联了，不利于扩展和测试。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/index2"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">index2</span><span class="params">(HttpSession session, HttpServletRequest request)</span></span>{</span><br><span class="line">    String idStr = request.getParameter(<span class="string">"id"</span>);</span><br><span class="line">    Long id = Long.parseLong(idStr);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>（2）建议使用@RequestParam注解来获取参数（不写的话，默认与参数名相同）<br>@RequestParam参数</p>
<ul>
<li>required，默认true，不允许参数为空</li>
<li>defaultValue，默认值为”\n\t\t\n\t\t\n\uE000\uE001\uE002\n\t\t\t\t\n”，可以修改为想要的内容。<br>通过注解和一些约定，可以发现index3方法对Servlet API的依赖没有了，它就很容易进行测试和扩展。<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value =<span class="string">"/index3"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">index3</span><span class="params">(@RequestParam(value = <span class="string">"ID"</span>, required = <span class="keyword">true</span>)</span> Long id)</span>{</span><br><span class="line">    System.out.println(<span class="string">"params[id] = "</span> + id);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<p>（3）获取session当中的内容<br>假设在登录系统已经在Session中设置了userName，那么可以使用@SessionAttribute去从Session中获取对应的数据.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/index4"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">index4</span><span class="params">(@SessionAttribute(<span class="string">"userName"</span>)</span> String userName)</span>{</span><br><span class="line">    System.out.println(<span class="string">"session[userName] = "</span> + userName);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="实现逻辑和绑定视图"><a href="#实现逻辑和绑定视图" class="headerlink" title="实现逻辑和绑定视图"></a>实现逻辑和绑定视图</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleController</span> </span>{</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(value = <span class="string">"roleServiceImpl"</span>)</span><br><span class="line">    <span class="keyword">private</span> RoleService roleService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRole</span><span class="params">(Role role)</span></span>{</span><br><span class="line">        roleService.printRole(role);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"getRole"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getRole</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Long id)</span>{</span><br><span class="line">        Role role = roleService.getRole(id);</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">"roleDetails"</span>);</span><br><span class="line">        <span class="comment">//给数据模型添加一个角色对象</span></span><br><span class="line">        mv.addObject(<span class="string">"role"</span>, role);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="视图渲染"><a href="#视图渲染" class="headerlink" title="视图渲染"></a>视图渲染</h3><p>（1）ModelAndView找到roleDetails.html或者roleDetail.jsp进行渲染</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"getRole"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getRole</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Long id)</span>{</span><br><span class="line">    Role role = roleService.getRole(id);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"roleDetails"</span>);</span><br><span class="line">    <span class="comment">//给数据模型添加一个角色对象</span></span><br><span class="line">    mv.addObject(<span class="string">"role"</span>, role);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"getRole"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getRole</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Long id)</span>{</span><br><span class="line">    Role role = roleService.getRole(id);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"roleDetails"</span>);</span><br><span class="line">    <span class="comment">//给数据模型添加一个角色对象</span></span><br><span class="line">    mv.addObject(<span class="string">"role"</span>, role);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"roleDetails"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>（2）Model加入参数，返回Stirng，找到roleDetails.html或者roleDetail.jsp进行渲染</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"getRole2"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getRole</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Long id, Model model)</span>{</span><br><span class="line">    Role role = roleService.getRole(id);</span><br><span class="line">    model.addAttribute(<span class="string">"role"</span>, role);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"roleDetails"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>(3)不渲染，@Response解析对象，返回json数据</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"getRole3"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getRole</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Long id, Model model)</span>{</span><br><span class="line">    Role role = roleService.getRole(id);</span><br><span class="line">    <span class="keyword">return</span> role;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="深入Spring-MVC组件开发"><a href="#深入Spring-MVC组件开发" class="headerlink" title="深入Spring MVC组件开发"></a>深入Spring MVC组件开发</h1></blockquote>
<h2 id="控制器接受各类请求参数"><a href="#控制器接受各类请求参数" class="headerlink" title="控制器接受各类请求参数"></a>控制器接受各类请求参数</h2><h3 id="接收普通请求参数"><a href="#接收普通请求参数" class="headerlink" title="接收普通请求参数"></a>接收普通请求参数</h3><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"form"</span> <span class="attr">action</span>=<span class="string">"./commonRoleParams"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>角色名称<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"roleName"</span> <span class="attr">name</span>=<span class="string">"roleName"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>备注<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"note"</span> <span class="attr">name</span>=<span class="string">"note"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleParams</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoleName</span><span class="params">(String roleName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoleName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleName;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.utils.RoleParams;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/params"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParamsController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/form"</span>)</span><br><span class="line">    <span class="comment">//@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">form</span><span class="params">(Model model)</span></span>{</span><br><span class="line">        model.addAttribute(<span class="string">"message"</span>, <span class="string">"asasa"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"testTable"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收普通参数</span></span><br><span class="line">    <span class="comment">//提交表单后的url为http://localhost:8081/params/commonRoleParams?roleName=aaa&amp;note=nbbb</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/commonParams"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">commonParams</span><span class="params">(String roleName, String note)</span></span>{ <span class="comment">//接收普通参数，</span></span><br><span class="line">        System.out.println(<span class="string">"roleName =&gt; "</span> + roleName);</span><br><span class="line">        System.out.println(<span class="string">"note =&gt; "</span> + note);</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//复杂参数需要考虑使用POJO管理这些参数</span></span><br><span class="line">    <span class="comment">//表单提交的参数会通过POJO进行获取，需要注意POJO的属性也要和HTTP请求参数名保持一致</span></span><br><span class="line">    <span class="comment">//这样即使没有任何注解，它们也能够有效传递参数</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/commonRoleParams"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">commonRoleParams</span><span class="params">(RoleParams roleParams)</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"roleName =&gt;"</span> + roleParams.getRoleName());</span><br><span class="line">        System.out.println(<span class="string">"note =&gt;"</span> + roleParams.getNote());</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用-RequestParam注解获取参数"><a href="#使用-RequestParam注解获取参数" class="headerlink" title="使用@RequestParam注解获取参数"></a>使用@RequestParam注解获取参数</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/commonAnnotationParams"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">commonAnnotationParams</span><span class="params">(@RequestParam(<span class="string">"role_name"</span>)</span> String roleName, String note)</span>{</span><br><span class="line">    System.out.println(<span class="string">"roleName =&gt;"</span> + roleName);</span><br><span class="line">    System.out.println(<span class="string">"note =&gt;"</span> + note);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用URL传递参数"><a href="#使用URL传递参数" class="headerlink" title="使用URL传递参数"></a>使用URL传递参数</h3><p>一些网站使用URL的形式传递参数，这符合RESTFul风格。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RoleDataService roleDataService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/getRole/{id}"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getRoleByPathVariable</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id)</span>{</span><br><span class="line">    Role role = roleDataService.getRoleByKey(id);</span><br><span class="line">    System.out.println(role.getRoleName());</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    <span class="comment">//绑定数据模型</span></span><br><span class="line">    mv.addObject(role);</span><br><span class="line">    <span class="comment">//设置为JSON视图</span></span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="传递JSON参数"><a href="#传递JSON参数" class="headerlink" title="传递JSON参数"></a>传递JSON参数</h3><p>有时候参数的传递还要更多的参数，比如角色的名称和备注，查询可能需要分页参数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageParams</span></span>{</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> start;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> limit;</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleParams</span></span>{</span><br><span class="line">  <span class="keyword">private</span> String roleName;</span><br><span class="line">  <span class="keyword">private</span> String note;</span><br><span class="line">  <span class="keyword">private</span> PageParams pageParams = <span class="keyword">null</span>; <span class="comment">//分页参数</span></span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">  <span class="comment">//JSON参数和类RoleParams一一对应</span></span><br><span class="line">  <span class="keyword">var</span> data = {</span><br><span class="line">    <span class="comment">//角色查询参数</span></span><br><span class="line">    roleName: <span class="string">'role'</span>,</span><br><span class="line">    note: <span class="string">'note'</span>,</span><br><span class="line">    <span class="comment">//分页参数</span></span><br><span class="line">    pageParms:{</span><br><span class="line">      start: <span class="number">1</span></span><br><span class="line">      limit: <span class="number">20</span></span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line">  <span class="comment">//Jquery的post请求</span></span><br><span class="line">  $.post({</span><br><span class="line">    url: <span class="string">"./params/findRoles"</span>,</span><br><span class="line">    <span class="comment">//此处需要告知传递参数类型为JSON，不能缺少</span></span><br><span class="line">    contentType: <span class="string">"application/json"</span></span><br><span class="line">    <span class="comment">//将JSON转化为字符串传递</span></span><br><span class="line">    data: <span class="built_in">JSON</span>.stringify(data),</span><br><span class="line">    <span class="comment">//成功后的方法</span></span><br><span class="line">    success: <span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/findRoles"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">findRoles</span><span class="params">(@ResponseBody RoleParams roleParams)</span></span>{</span><br><span class="line">    List&lt;Role&gt; roleList = roleDataService.findRoles(roleParams);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.addObject(roleList);</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="接收列表数据和表单序列化"><a href="#接收列表数据和表单序列化" class="headerlink" title="接收列表数据和表单序列化"></a>接收列表数据和表单序列化</h3><p>在一些场景下，如果要一次性删除多个角色，那么肯定是想将一个角色编号的数组传递给后台，或需要新增角色，甚至同时新增多个角色。无论如何，这都需要用到Java的集合或者数组去保存对应的参数。</p>
<h4 id="简单数组"><a href="#简单数组" class="headerlink" title="简单数组"></a>简单数组</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">  <span class="comment">//删除角色数组</span></span><br><span class="line">  <span class="keyword">var</span> idList = {<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>};</span><br><span class="line">  <span class="comment">//JQuery的post请求</span></span><br><span class="line">  $.post({</span><br><span class="line">    url: <span class="string">"./params/deleteRoles"</span>,</span><br><span class="line">    <span class="comment">//将JSON转化为字符串传递</span></span><br><span class="line">    data: <span class="built_in">JSON</span>.stringify(idList),</span><br><span class="line">    <span class="comment">//指定传递数据类型，不可缺少</span></span><br><span class="line">    contentType: <span class="string">"application/json"</span>,</span><br><span class="line">    <span class="comment">//成功后的方法</span></span><br><span class="line">    success: <span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/deleteRoles"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">deleteRoles</span><span class="params">(@RequestBody List&lt;Long&gt; idList)</span></span>{</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    <span class="comment">//删除角色</span></span><br><span class="line">    <span class="keyword">int</span> total = roleDataService.deleteRoles(idList);</span><br><span class="line">    <span class="comment">//帮顶视图</span></span><br><span class="line">    mv.addObject(<span class="string">"total"</span>, total);</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="POJO数组"><a href="#POJO数组" class="headerlink" title="POJO数组"></a>POJO数组</h4><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">  <span class="comment">//新增角色数组</span></span><br><span class="line">  <span class="keyword">var</span> roleList = [</span><br><span class="line">    {<span class="attr">roleName</span>: <span class="string">'role_name_1'</span>, <span class="attr">note</span>: <span class="string">'note_1'</span>},</span><br><span class="line">    {<span class="attr">roleName</span>: <span class="string">'role_name_2'</span>, <span class="attr">note</span>: <span class="string">'note_2'</span>},</span><br><span class="line">    {<span class="attr">roleName</span>: <span class="string">'role_name_3'</span>, <span class="attr">note</span>: <span class="string">'note_3'</span>}</span><br><span class="line">  ];</span><br><span class="line">  <span class="comment">//JQuery的post请求</span></span><br><span class="line">  $.post({</span><br><span class="line">    url: <span class="string">"./params/addRoles"</span>,</span><br><span class="line">    <span class="comment">//将JSON转化为字符串传递</span></span><br><span class="line">    data: <span class="built_in">JSON</span>.stringify(roleList),</span><br><span class="line">    contentType: <span class="string">"application/json"</span>,</span><br><span class="line">    <span class="comment">//成功后的方法</span></span><br><span class="line">    success: <span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/deleteRoles"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">deleteRoles</span><span class="params">(@RequestBody List&lt;Long&gt; idList)</span></span>{</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    <span class="comment">//删除角色</span></span><br><span class="line">    <span class="keyword">int</span> total = roleDataService.deleteRoles(idList);</span><br><span class="line">    <span class="comment">//帮顶视图</span></span><br><span class="line">    mv.addObject(<span class="string">"total"</span>, total);</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="表单序列化"><a href="#表单序列化" class="headerlink" title="表单序列化"></a>表单序列化</h4><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>参数<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://code.jquery.com/jquery-3.2.0.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">        $(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span></span><br><span class="line"><span class="javascript">           $(<span class="string">"#commit"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span></span><br><span class="line"><span class="javascript">               <span class="keyword">var</span> str = $(<span class="string">"form"</span>).serialize();</span></span><br><span class="line"><span class="javascript">               <span class="built_in">console</span>.log(str)</span></span><br><span class="line"><span class="actionscript">                <span class="comment">//提交表单</span></span></span><br><span class="line"><span class="javascript">               $.post({</span></span><br><span class="line"><span class="actionscript">                   url: <span class="string">"/params/serializeTest"</span>,</span></span><br><span class="line"><span class="actionscript">                   <span class="comment">//将form数据序列化，传递给后台，则将数据以roleName=xxx&amp;&amp;note=xxx传递</span></span></span><br><span class="line">                   data: str,</span><br><span class="line"><span class="actionscript">                   <span class="comment">//成功后的方法</span></span></span><br><span class="line"><span class="actionscript">                   success: <span class="function"><span class="keyword">function</span> <span class="params">(result)</span> </span>{</span></span><br><span class="line"></span><br><span class="line">                   }</span><br><span class="line">               });</span><br><span class="line">           });</span><br><span class="line">        });</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"form"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>角色名称<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"roleName"</span> <span class="attr">name</span>=<span class="string">"roleName"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>备注<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"note"</span> <span class="attr">name</span>=<span class="string">"note"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"commit"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/serializeTest"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">serializeTest</span><span class="params">(String roleName, String note)</span></span>{</span><br><span class="line">    System.out.println(<span class="string">"roleName =&gt;"</span> + roleName);</span><br><span class="line">    System.out.println(<span class="string">"note =&gt;"</span> + note);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h2><h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/showRoleJsonInfo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">showRoleJsonInfo</span><span class="params">(String roleName, String note)</span></span>{</span><br><span class="line">    System.out.println(<span class="string">"xxxxx"</span>);</span><br><span class="line">    System.out.println(<span class="string">"roleName =&gt;"</span> + roleName);</span><br><span class="line">    System.out.println(<span class="string">"note =&gt;"</span> + note);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line"></span><br><span class="line">    mv.addObject(<span class="string">"roleName"</span>, roleName);</span><br><span class="line">    mv.addObject(<span class="string">"note"</span>, note);</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/serializeTest"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serializeTest</span><span class="params">(Model model, String roleName, String note)</span></span>{</span><br><span class="line">    System.out.println(<span class="string">"roleName =&gt;"</span> + roleName);</span><br><span class="line">    System.out.println(<span class="string">"note =&gt;"</span> + note);</span><br><span class="line">    model.addAttribute(<span class="string">"roleName"</span>, roleName);</span><br><span class="line">    model.addAttribute(<span class="string">"note"</span>, note);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"redirect:showRoleJsonInfo"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/showRoleJsonInfo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">showRoleJsonInfo</span><span class="params">(String roleName, String note)</span></span>{</span><br><span class="line">    System.out.println(<span class="string">"xxxxx"</span>);</span><br><span class="line">    System.out.println(<span class="string">"roleName =&gt;"</span> + roleName);</span><br><span class="line">    System.out.println(<span class="string">"note =&gt;"</span> + note);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line"></span><br><span class="line">    mv.addObject(<span class="string">"roleName"</span>, roleName);</span><br><span class="line">    mv.addObject(<span class="string">"note"</span>, note);</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/serializeTest"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">serializeTest</span><span class="params">(Model model, String roleName, String note)</span></span>{</span><br><span class="line">    System.out.println(<span class="string">"roleName =&gt;"</span> + roleName);</span><br><span class="line">    System.out.println(<span class="string">"note =&gt;"</span> + note);</span><br><span class="line"><span class="comment">//        model.addAttribute("roleName", roleName);</span></span><br><span class="line"><span class="comment">//        model.addAttribute("note", note);</span></span><br><span class="line"><span class="comment">//        return "redirect:showRoleJsonInfo";</span></span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"redirect:./showRoleJsonInfo"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="传递参数"><a href="#传递参数" class="headerlink" title="传递参数"></a>传递参数</h3><p>重定向如果需要传递参数，需要用到RedirectAttributes类，其有两种常见方法：</p>
<ul>
<li>addAtribute(), 通过url传递的方式<a href="http://locahost:8081?obj=obect" target="_blank" rel="noopener">http://locahost:8081?obj=obect</a></li>
<li>addFlashAttribute(), 将数据放入session中，重定向后删除数据，通过@ModelAttribute注解获取对应参数。</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/showRoleJsonInfo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">showRoleJsonInfo</span><span class="params">(String obj, @ModelAttribute(<span class="string">"roleName"</span>)</span> String roleName, @<span class="title">ModelAttribute</span><span class="params">(<span class="string">"note"</span>)</span> String note)</span>{</span><br><span class="line">    System.out.println(<span class="string">"xxxxx"</span>);</span><br><span class="line">    System.out.println(obj);</span><br><span class="line">    System.out.println(<span class="string">"roleName =&gt;"</span> + roleName);</span><br><span class="line">    System.out.println(<span class="string">"note =&gt;"</span> + note);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line"></span><br><span class="line">    mv.addObject(<span class="string">"roleName"</span>, roleName);</span><br><span class="line">    mv.addObject(<span class="string">"note"</span>, note);</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/serializeTest"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serializeTest</span><span class="params">(RedirectAttributes ra, String roleName, String note)</span></span>{</span><br><span class="line">    System.out.println(<span class="string">"roleName =&gt;"</span> + roleName);</span><br><span class="line">    System.out.println(<span class="string">"note =&gt;"</span> + note);</span><br><span class="line">    ra.addAttribute(<span class="string">"obj"</span>, <span class="string">"object"</span>);</span><br><span class="line">    ra.addFlashAttribute(<span class="string">"roleName"</span>, roleName);</span><br><span class="line">    ra.addFlashAttribute(<span class="string">"note"</span>, note);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"redirect:showRoleJsonInfo"</span>;</span><br><span class="line"><span class="comment">//        ModelAndView mv = new ModelAndView();</span></span><br><span class="line"><span class="comment">//        mv.setViewName("redirect:./showRoleJsonInfo");</span></span><br><span class="line"><span class="comment">//        return mv;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="保存并获取属性参数"><a href="#保存并获取属性参数" class="headerlink" title="保存并获取属性参数"></a>保存并获取属性参数</h2><p>有时候我们会暂存数据到HTTP的request对象或者Session对象汇总，在开发控制器的时候，有时也需要保存对应的数据到这些对象中去，或者从中获取数据。Spring MVC给予了支持：</p>
<ul>
<li>@RequestAttribute获取HTTP的请求（request）对象属性值，用来传递给控制器的参数；</li>
<li>@SessionAttribute在HTTP的会话（Session）对象属性值中，用来传递给控制器的参数；</li>
<li>@SessionAttribute可以给它配置一个字符串数组，这个数组对应的是数据模型对应的键值对，然后将这些键值对保存到Session中。</li>
</ul>
<h3 id="注解-RequestAttribute"><a href="#注解-RequestAttribute" class="headerlink" title="注解@RequestAttribute"></a>注解@RequestAttribute</h3><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//设置请求属性</span><br><span class="line">request.setAttribute("id", 1L);</span><br><span class="line">//转发给控制器</span><br><span class="line">request.getRequestDispatcher("./params/requestAttribute")</span><br><span class="line">       .forward(request, response);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"requestAttribute"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">reqAttr</span><span class="params">(@RequestAttribute(<span class="string">"id"</span>)</span> Long id)</span>{</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    System.out.println(<span class="string">"id =&gt;"</span> + Long.toString(id));</span><br><span class="line">    mv.setViewName(<span class="string">"index"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="注解-SessionAttribute和注解-SessionAttributes"><a href="#注解-SessionAttribute和注解-SessionAttributes" class="headerlink" title="注解@SessionAttribute和注解@SessionAttributes"></a>注解@SessionAttribute和注解@SessionAttributes</h3><p>  这两个注解和 HTTP 的会话对象有 ，在浏览器和服务器保持联系的时候 HTTP 会创<br>个会话对象，这样可以让我们在和服务器会话期间（请注意这个时间范围）通过它读／<br>写会话对象的属性，缓存 定数据信息。<br>  先来讨论 下设置会话属性，在控制器中可以使用注解＠SessionAttributes 来设置对应<br>的键值对，不过这个注解只能对类进行标注，不能对方法或者参数注 它可以配置属性<br>名称或者属性类型。它的作用是当这个类被注解后， Spring MVC 执行完控制器的逻辑后，<br>将数据模型中对应的属性名称或者属性类型保存到 TTP Session 对象中。</p>
<h4 id="读取后端设置的session属性"><a href="#读取后端设置的session属性" class="headerlink" title="读取后端设置的session属性"></a>读取后端设置的session属性</h4><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">import</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span> %&gt;</span><span class="tag">&lt;<span class="name">%--</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Created</span> <span class="attr">by</span> <span class="attr">IntelliJ</span> <span class="attr">IDEA.</span></span></span><br><span class="line"><span class="tag">  <span class="attr">User:</span> <span class="attr">louris</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Date:</span> <span class="attr">2021</span>/<span class="attr">9</span>/<span class="attr">25</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Time:</span> <span class="attr">16:47</span></span></span><br><span class="line"><span class="tag">  <span class="attr">To</span> <span class="attr">change</span> <span class="attr">this</span> <span class="attr">template</span> <span class="attr">use</span> <span class="attr">File</span> | <span class="attr">Settings</span> | <span class="attr">File</span> <span class="attr">Templates.</span></span></span><br><span class="line"><span class="tag"><span class="attr">--</span>%&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html;charset=UTF-8"</span> <span class="attr">language</span>=<span class="string">"java"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Role</span> <span class="attr">role</span> = <span class="string">(Role)</span> <span class="attr">session.getAttribute</span>("<span class="attr">role</span>");</span></span><br><span class="line">    out.println("id = " + role.getId() + "&lt;p/&gt;");</span><br><span class="line"></span><br><span class="line">    Long id = (Long) session.getAttribute("id");</span><br><span class="line">    out.println("id = " + id + "<span class="tag">&lt;<span class="name">p</span>/&gt;</span>");</span><br><span class="line">%&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ModelAttribute;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.SessionAttribute;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.SessionAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.support.RedirectAttributes;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/attribute"</span>)</span><br><span class="line"><span class="comment">//可以配置数据模型的名称和类型，两者取或关系</span></span><br><span class="line"><span class="meta">@SessionAttributes</span>(names = {<span class="string">"id"</span>}, types = {Role<span class="class">.<span class="keyword">class</span>})</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">AttributeController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/enter"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">enter</span><span class="params">(RedirectAttributes ra, Long id)</span></span>{</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        ra.addAttribute(<span class="string">"id"</span>, id);</span><br><span class="line">        mv.setViewName(<span class="string">"redirect:sessionAttributes"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/sessionAttributes"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">sessionAttrs</span><span class="params">(Long id)</span></span>{</span><br><span class="line">        System.out.println(<span class="string">"sessionAttributes"</span>);</span><br><span class="line">        System.out.println(id);</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        Role role = <span class="keyword">new</span> Role();</span><br><span class="line">        role.setId(id);</span><br><span class="line">        mv.addObject(<span class="string">"role"</span>, role); <span class="comment">//根据类型，Session将会保存角色信息</span></span><br><span class="line">        mv.addObject(<span class="string">"id"</span>, id); <span class="comment">//根据名称，Session将会保存id</span></span><br><span class="line">        mv.setViewName(<span class="string">"attribute"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>运行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">25</span> <span class="number">17</span>:<span class="number">05</span>:<span class="number">21.298</span>  INFO <span class="number">12204</span> --- [nio-<span class="number">8081</span>-exec-<span class="number">1</span>] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet <span class="string">'dispatcherServlet'</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">25</span> <span class="number">17</span>:<span class="number">05</span>:<span class="number">21.299</span>  INFO <span class="number">12204</span> --- [nio-<span class="number">8081</span>-exec-<span class="number">1</span>] o.s.web.servlet.DispatcherServlet        : Initializing Servlet <span class="string">'dispatcherServlet'</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">25</span> <span class="number">17</span>:<span class="number">05</span>:<span class="number">21.299</span>  INFO <span class="number">12204</span> --- [nio-<span class="number">8081</span>-exec-<span class="number">1</span>] o.s.web.servlet.DispatcherServlet        : Completed initialization in <span class="number">0</span> ms</span><br><span class="line">sessionAttributes</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id = 2</span><br><span class="line">id = 2</span><br></pre></td></tr></tbody></table></figure>

<h4 id="读取前端设置的session属性"><a href="#读取前端设置的session属性" class="headerlink" title="读取前端设置的session属性"></a>读取前端设置的session属性</h4><p>上面是后端设置session属性，现在需要读取前端设置的session属性</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">import</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span> %&gt;</span><span class="tag">&lt;<span class="name">%--</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Created</span> <span class="attr">by</span> <span class="attr">IntelliJ</span> <span class="attr">IDEA.</span></span></span><br><span class="line"><span class="tag">  <span class="attr">User:</span> <span class="attr">louris</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Date:</span> <span class="attr">2021</span>/<span class="attr">9</span>/<span class="attr">25</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Time:</span> <span class="attr">16:47</span></span></span><br><span class="line"><span class="tag">  <span class="attr">To</span> <span class="attr">change</span> <span class="attr">this</span> <span class="attr">template</span> <span class="attr">use</span> <span class="attr">File</span> | <span class="attr">Settings</span> | <span class="attr">File</span> <span class="attr">Templates.</span></span></span><br><span class="line"><span class="tag"><span class="attr">--</span>%&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html;charset=UTF-8"</span> <span class="attr">language</span>=<span class="string">"java"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span></span></span><br><span class="line"><span class="tag">    <span class="attr">session.setAttribute</span>("<span class="attr">id</span>", <span class="attr">1L</span>);</span></span><br><span class="line"><span class="tag">    <span class="attr">response.sendRedirect</span>("<span class="attr">.</span>/<span class="attr">sessionAttributes</span>");</span></span><br><span class="line"><span class="tag">%&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ModelAttribute;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.SessionAttribute;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.SessionAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.support.RedirectAttributes;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/attribute"</span>)</span><br><span class="line"><span class="comment">//可以配置数据模型的名称和类型，两者取或关系</span></span><br><span class="line"><span class="meta">@SessionAttributes</span>(names = {<span class="string">"id"</span>}, types = {Role<span class="class">.<span class="keyword">class</span>})</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">AttributeController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/enter"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">enter</span><span class="params">(RedirectAttributes ra, Long id)</span></span>{</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        ra.addAttribute(<span class="string">"id"</span>, id);</span><br><span class="line">        mv.setViewName(<span class="string">"attribute"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/sessionAttributes"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">sessionAttrs</span><span class="params">(@SessionAttribute(<span class="string">"id"</span>)</span> Long id)</span>{</span><br><span class="line">        System.out.println(<span class="string">"sessionAttributes"</span>);</span><br><span class="line">        System.out.println(id);</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        Role role = <span class="keyword">new</span> Role();</span><br><span class="line">        role.setId(id);</span><br><span class="line">        mv.addObject(<span class="string">"role"</span>, role); <span class="comment">//根据类型，Session将会保存角色信息</span></span><br><span class="line">        mv.addObject(<span class="string">"id"</span>, id); <span class="comment">//根据名称，Session将会保存id</span></span><br><span class="line">        mv.setViewName(<span class="string">"enter"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="注解-CookieValue和注解-RequestHeader"><a href="#注解-CookieValue和注解-RequestHeader" class="headerlink" title="注解@CookieValue和注解@RequestHeader"></a>注解@CookieValue和注解@RequestHeader</h3><p>从名称而言，这两个注解都很明确，就是从 Cooki BTTP 请求头获取对应的请求信<br>，它们的用法比较简单，且大同小异。只是对于 Cookie ，用户是可以禁用的，所以在使用的时候需要考虑这个问题</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/getHeaderAndCookie"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">testHeaderAndCookie</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @RequestHeader(value = <span class="string">"User-Agnet"</span>, required = <span class="keyword">false</span>, defaultValue = <span class="string">"attribute"</span>)</span></span></span><br><span class="line"><span class="function">        String userAgent,</span></span><br><span class="line"><span class="function">        @<span class="title">CookieValue</span><span class="params">(value = <span class="string">"JSESSIONID"</span>, required = <span class="keyword">true</span>, defaultValue = <span class="string">"MyJsessionId"</span>)</span></span></span><br><span class="line"><span class="function">        String jsessionId)</span>{</span><br><span class="line">    System.out.println(<span class="string">"User-Agent: "</span> + userAgent);</span><br><span class="line">    System.out.println(<span class="string">"JSESSIONID: "</span> + jsessionId);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"aaaa"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">25</span> <span class="number">17</span>:<span class="number">38</span>:<span class="number">16.756</span>  INFO <span class="number">17924</span> --- [nio-<span class="number">8081</span>-exec-<span class="number">1</span>] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet <span class="string">'dispatcherServlet'</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">25</span> <span class="number">17</span>:<span class="number">38</span>:<span class="number">16.756</span>  INFO <span class="number">17924</span> --- [nio-<span class="number">8081</span>-exec-<span class="number">1</span>] o.s.web.servlet.DispatcherServlet        : Initializing Servlet <span class="string">'dispatcherServlet'</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">25</span> <span class="number">17</span>:<span class="number">38</span>:<span class="number">16.757</span>  INFO <span class="number">17924</span> --- [nio-<span class="number">8081</span>-exec-<span class="number">1</span>] o.s.web.servlet.DispatcherServlet        : Completed initialization in <span class="number">1</span> ms</span><br><span class="line">User-Agent: attribute</span><br><span class="line">JSESSIONID: <span class="number">03E6F</span>0E6323068266E42A287622E2681</span><br></pre></td></tr></tbody></table></figure>

<h2 id="拦截器-1"><a href="#拦截器-1" class="headerlink" title="拦截器"></a>拦截器</h2><ul>
<li>拦截器是Spring MVC中强大的控件，它可以在进入处理器之前做一些操作，或者在处理器完成后进行操作，甚至是在渲染视图后进行操作。</li>
<li>SpringMVC会在启动期间就通过@RequestMapping的注解解析URI和处理器的对应关系，在运行的时候通过请求找到对应的HandlerMapping，然后构建HandlerExecutionChain对象，它是一个执行的责任链对象。</li>
</ul>
<h3 id="拦截器的定义"><a href="#拦截器的定义" class="headerlink" title="拦截器的定义"></a>拦截器的定义</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerInterceptor</span> </span>{</span><br><span class="line">    <span class="comment">//在处理器之前执行的前置方法，这样Spring MVC可以进入处理器前处理一些方法了。</span></span><br><span class="line">    <span class="comment">//返回值是boolean类型，会影响后面SpringMVC的流程</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//在处理器之后执行的后置方法，处理器的逻辑完成后运行它。</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//无论是否产生异常都会在渲染视图后执行的方法。</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable Exception ex)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="拦截器的执行流程"><a href="#拦截器的执行流程" class="headerlink" title="拦截器的执行流程"></a>拦截器的执行流程</h3><p>前置方法 -&gt; 判断是否返回true<br>true -&gt; 处理器 -&gt; 后置方法 -&gt; 视图解析和渲染视图 -&gt; 完成方法 -&gt; 后续流程<br>false -&gt; 后续流程</p>
<h3 id="开发拦截器"><a href="#开发拦截器" class="headerlink" title="开发拦截器"></a>开发拦截器</h3><p>这里模仿登录拦截，只有登录了才能访问需登录才能访问的页面，如果未登录情况下访问了需登录才能访问的页面，会跳转</p>
<h4 id="自定义登录拦截器"><a href="#自定义登录拦截器" class="headerlink" title="自定义登录拦截器"></a>自定义登录拦截器</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.model.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(<span class="string">"进入拦截器-------------------"</span>);</span><br><span class="line">        <span class="comment">//编写业务拦截的规则</span></span><br><span class="line">        <span class="comment">//从session中获取用户的信息</span></span><br><span class="line">        User usr = (User)request.getSession().getAttribute(<span class="string">"user"</span>);</span><br><span class="line">        <span class="comment">//判断用户是否登录</span></span><br><span class="line">        <span class="keyword">if</span>(usr == <span class="keyword">null</span>){</span><br><span class="line">            <span class="comment">//未登录</span></span><br><span class="line">            response.sendRedirect(request.getContextPath() + <span class="string">"/user/error"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="拦截器配置类"><a href="#拦截器配置类" class="headerlink" title="拦截器配置类"></a>拦截器配置类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.interceptor.UserInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span>  <span class="comment">//定义此类为配置类，即相当于之前的xml配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>{</span><br><span class="line">        <span class="comment">//要拦截user下的所有访问请求，必须用户登录后才可以访问</span></span><br><span class="line">        <span class="comment">//但是这样拦截的路径中有一些是不需要用户登录也可访问的</span></span><br><span class="line">        String[] addPathPatterns = {</span><br><span class="line">                <span class="string">"/user/**"</span></span><br><span class="line">        };  <span class="comment">//需要拦截的内容</span></span><br><span class="line"></span><br><span class="line">        String[] excludePathPatterns = {</span><br><span class="line">                <span class="string">"/user/login"</span>,</span><br><span class="line">                <span class="string">"/user/out"</span>,</span><br><span class="line">                <span class="string">"/user/error"</span></span><br><span class="line">        }; <span class="comment">//需要排除的内容</span></span><br><span class="line">        <span class="comment">//mvc:interceptor bean class=""</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> UserInterceptor()).addPathPatterns(addPathPatterns).excludePathPatterns(excludePathPatterns);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="用户登录控制器"><a href="#用户登录控制器" class="headerlink" title="用户登录控制器"></a>用户登录控制器</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.model.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户登录请求</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/login"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">login</span><span class="params">(HttpServletRequest request)</span></span>{</span><br><span class="line">        <span class="comment">//将用户信息存放到session中</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">1001</span>);</span><br><span class="line">        user.setUserName(<span class="string">"zhangsan"</span>);</span><br><span class="line">        request.getSession().setAttribute(<span class="string">"user"</span>, user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login SUCCESS"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该请求需要用户登录之后才能访问</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/center"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">center</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"See Center Message"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户不能登录也能访问</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/out"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">out</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Out see anytime"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果用户未登录访问了需要登录才可以访问的请求，之后会跳转至该请求路径</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/error"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">error</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="验证表单"><a href="#验证表单" class="headerlink" title="验证表单"></a>验证表单</h2><p>在实际工作中，得到数据后的第一步就是检验数据的正确性，如果存在录入上的问题，一般会通过注解校验，发现错误后返回给用户，但是对于一些逻辑上的错误，比如购买金额=购买数量×单价，这样的规则就很难使用注解方式进行验证了，这个时候可以使用Spring所提供的验证器（Validator）规则去验证。</p>
<h3 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="POJO"><a href="#POJO" class="headerlink" title="POJO"></a>POJO</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.beans.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.aop.interceptors.Interceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transaction</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//产品编号</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> Long productId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户编号</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交易日期</span></span><br><span class="line">    <span class="meta">@Future</span> <span class="comment">//只能是将来的日期</span></span><br><span class="line">    <span class="meta">@DateTimeFormat</span>(pattern = <span class="string">"yyyy-MM-dd"</span>) <span class="comment">//日期格式化转换</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//价格</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@DecimalMin</span>(value = <span class="string">"0.1"</span>)  <span class="comment">//最小值0.1元</span></span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数量</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min</span>(<span class="number">1</span>) <span class="comment">//最小值为1</span></span><br><span class="line">    <span class="meta">@Max</span>(<span class="number">100</span>) <span class="comment">//最大值</span></span><br><span class="line">    <span class="keyword">private</span> Integer quantity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交易金额</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@DecimalMax</span>(<span class="string">"500000.00"</span>)  <span class="comment">//最大金额为5万元</span></span><br><span class="line">    <span class="meta">@DecimalMin</span>(<span class="string">"1.00"</span>)     <span class="comment">//最小交易金额为1元</span></span><br><span class="line">    <span class="keyword">private</span> Double amount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//邮件</span></span><br><span class="line">    <span class="meta">@Pattern</span>(regexp = <span class="string">"^([a-zA-Z0-9]*[-_]?[a-zA-Z0-9]+)*@"</span> +</span><br><span class="line">            <span class="string">"([a-zA-Z0-9]*[-_]?[a-zA-Z0-9]+)+[\\.][A-Za-z]{2,3}([\\.][A-Za-z]{2})?$"</span>, message = <span class="string">"不符合邮件格式"</span>)</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//备注</span></span><br><span class="line">    <span class="meta">@Size</span>(min=<span class="number">0</span>, max=<span class="number">256</span>) <span class="comment">//0到255个字符</span></span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmail</span><span class="params">(String email)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAmount</span><span class="params">(Double amount)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.amount = amount;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDate</span><span class="params">(Date date)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.date = date;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(Double price)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.price = price;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProductId</span><span class="params">(Long productId)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.productId = productId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setQuantity</span><span class="params">(Integer quantity)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.quantity = quantity;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserId</span><span class="params">(Long userId)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEmail</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> email;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getDate</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">getAmount</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> amount;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">getPrice</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getQuantity</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> quantity;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getProductId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> productId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getUserId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="页面"><a href="#页面" class="headerlink" title="页面"></a>页面</h3><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%--</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Created</span> <span class="attr">by</span> <span class="attr">IntelliJ</span> <span class="attr">IDEA.</span></span></span><br><span class="line"><span class="tag">  <span class="attr">User:</span> <span class="attr">louris</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Date:</span> <span class="attr">2021</span>/<span class="attr">9</span>/<span class="attr">26</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Time:</span> <span class="attr">16:00</span></span></span><br><span class="line"><span class="tag">  <span class="attr">To</span> <span class="attr">change</span> <span class="attr">this</span> <span class="attr">template</span> <span class="attr">use</span> <span class="attr">File</span> | <span class="attr">Settings</span> | <span class="attr">File</span> <span class="attr">Templates.</span></span></span><br><span class="line"><span class="tag"><span class="attr">--</span>%&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html;charset=UTF-8"</span> <span class="attr">language</span>=<span class="string">"java"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>validate<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"./annotation"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>产品编号：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"productId"</span> <span class="attr">id</span>=<span class="string">"productId"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>用户编号：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"userId"</span> <span class="attr">id</span>=<span class="string">"userId"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>交易日期：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"date"</span> <span class="attr">id</span>=<span class="string">"date"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>价格：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"price"</span> <span class="attr">id</span>=<span class="string">"price"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>数量：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"quantity"</span> <span class="attr">id</span>=<span class="string">"quantity"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>交易金额：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"amount"</span> <span class="attr">id</span>=<span class="string">"amount"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>用户邮件：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">id</span>=<span class="string">"email"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>备注：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"note"</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">cols</span>=<span class="string">"20"</span> <span class="attr">rows</span>=<span class="string">"5"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span> <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"2"</span> <span class="attr">align</span>=<span class="string">"right"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Transaction;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.Errors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.FieldError;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/validate"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/form"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">form</span><span class="params">()</span></span>{</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">"transaction"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/annotation"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">annotationValidate</span><span class="params">(@Valid Transaction transaction, Errors errors)</span></span>{</span><br><span class="line">        <span class="comment">//是否存在错误</span></span><br><span class="line">        <span class="keyword">if</span>(errors.hasErrors()){</span><br><span class="line">            <span class="comment">//获取错误信息</span></span><br><span class="line">            List&lt;FieldError&gt; errorList = errors.getFieldErrors();</span><br><span class="line">            <span class="keyword">for</span>(FieldError error:errorList){</span><br><span class="line">                <span class="comment">//打印字段错误信息</span></span><br><span class="line">                System.err.println(<span class="string">"field: "</span> + error.getField() + <span class="string">"\t"</span> +</span><br><span class="line">                        <span class="string">"msg: "</span> + error.getDefaultMessage());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">"enter"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用验证器"><a href="#使用验证器" class="headerlink" title="使用验证器"></a>使用验证器</h3><h4 id="验证器接口"><a href="#验证器接口" class="headerlink" title="验证器接口"></a>验证器接口</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.validation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Validator</span> </span>{</span><br><span class="line">    <span class="comment">//判断当前验证器是否用于检验clazz类型的POJO</span></span><br><span class="line">    <span class="comment">//true表示启动检验，否则不再检验</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检验POJO的合法性</span></span><br><span class="line">    <span class="comment">//var1为POJO请求对象</span></span><br><span class="line">    <span class="comment">//var2为错误信息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">validate</span><span class="params">(Object var1, Errors var2)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="自定义验证器"><a href="#自定义验证器" class="headerlink" title="自定义验证器"></a>自定义验证器</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.utils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Transaction;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.Errors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.Validator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionValidator</span> <span class="keyword">implements</span> <span class="title">Validator</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; aClass)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Transaction<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">aClass</span>)</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(Object o, Errors errors)</span> </span>{</span><br><span class="line">        Transaction transaction = (Transaction) o;</span><br><span class="line">        <span class="comment">//求交易金额和价格×数量的差额</span></span><br><span class="line">        <span class="keyword">double</span> dis = transaction.getAmount() - (transaction.getPrice() * transaction.getQuantity());</span><br><span class="line">        <span class="comment">//如果差额大于0.01，则认为业务错误</span></span><br><span class="line">        <span class="keyword">if</span>(Math.abs(dis) &gt; <span class="number">0.01</span>){</span><br><span class="line">            <span class="comment">//加入错误信息</span></span><br><span class="line">            errors.rejectValue(<span class="string">"amount"</span>, <span class="keyword">null</span>, <span class="string">"交易金额和购买数量与价格不匹配"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="控制器绑定验证器"><a href="#控制器绑定验证器" class="headerlink" title="控制器绑定验证器"></a>控制器绑定验证器</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Transaction;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.utils.TransactionValidator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.DataBinder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.Errors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.FieldError;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.InitBinder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.View;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.Valid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/validate"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InitBinder</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initBinder</span><span class="params">(DataBinder binder)</span></span>{</span><br><span class="line">        binder.setValidator(<span class="keyword">new</span> TransactionValidator());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/form"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">form</span><span class="params">()</span></span>{</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">"transaction"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/annotation"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">annotationValidate</span><span class="params">(@Valid Transaction transaction, Errors errors)</span></span>{</span><br><span class="line">        <span class="comment">//是否存在错误</span></span><br><span class="line">        <span class="keyword">if</span>(errors.hasErrors()){</span><br><span class="line">            <span class="comment">//获取错误信息</span></span><br><span class="line">            List&lt;FieldError&gt; errorList = errors.getFieldErrors();</span><br><span class="line">            <span class="keyword">for</span>(FieldError error:errorList){</span><br><span class="line">                <span class="comment">//打印字段错误信息</span></span><br><span class="line">                System.err.println(<span class="string">"field: "</span> + error.getField() + <span class="string">"\t"</span> +</span><br><span class="line">                        <span class="string">"msg: "</span> + error.getDefaultMessage());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">"enter"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h2><p>下面的例子中只是在数据模型中加入了数据，但没有把数据模型绑定给视图和模型，这一步是Spring MVC在完成控制器逻辑后，自动绑定的，并不需要我们绑定，也就没有绑定的代码了。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"getRoleByModelMap"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getRoleByModelMap</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Long id, ModelMap modelMap)</span>{</span><br><span class="line">    Role role = roleService.getRole(id);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"roleDetals"</span>);</span><br><span class="line">    modelMap.addAttribute(<span class="string">"role"</span>, role);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"getRoleByModel"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getRoleByModelMap</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Long id, Model model)</span>{</span><br><span class="line">    Role role = roleService.getRole(id);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"roleDetals"</span>);</span><br><span class="line">    model.addAttribute(<span class="string">"role"</span>, role);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"getRoleByMv"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getRoleByMv</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Long id, ModelAndView mv)</span>{</span><br><span class="line">    Role role = roleService.getRole(id);</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"roleDetals"</span>);</span><br><span class="line">    mv.addObject(<span class="string">"role"</span>, role);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="视图和视图解析器"><a href="#视图和视图解析器" class="headerlink" title="视图和视图解析器"></a>视图和视图解析器</h2><p>视图是展示给用户的内容，而在此之前，要通过控制器得到对应的数据模型，如果是非逻辑视图，则不会经过视图解析器定位视图，而是直接将数据模型渲染便结束了；而逻辑视图则要对其进一步解析，以定位真实视图，这就是视图解析器的作用了。而视图则是把从控制器查询回来的数据模型进行渲染，以显示给请求者查看。</p>
<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><h4 id="视图接口定义"><a href="#视图接口定义" class="headerlink" title="视图接口定义"></a>视图接口定义</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">View</span> </span>{</span><br><span class="line">    <span class="comment">//响应状态属性</span></span><br><span class="line">    String RESPONSE_STATUS_ATTRIBUTE = View.class.getName() + ".responseStatus";</span><br><span class="line">    <span class="comment">//定义数据模型下取出变量路径</span></span><br><span class="line">    String PATH_VARIABLES = View.class.getName() + ".pathVariables";</span><br><span class="line">    <span class="comment">//选择响应内容类型</span></span><br><span class="line">    String SELECTED_CONTENT_TYPE = View.class.getName() + ".selectedContentType";</span><br><span class="line"></span><br><span class="line">    <span class="comment">//响应客户端的类型</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">getContentType</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//渲染方法，model是数据模型</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">render</span><span class="params">(@Nullable Map&lt;String, ?&gt; model, HttpServletRequest var2, HttpServletResponse var3)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="非逻辑视图"><a href="#非逻辑视图" class="headerlink" title="非逻辑视图"></a>非逻辑视图</h4><p>将数据模型转换为一个JSON视图，展现给用户，无须对视图名字再进行下一步的解析。<br>常见的是MappingJackson2JsonView</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value =<span class="string">"/getRoleForJson"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getRoleForJson</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> Long id)</span>{</span><br><span class="line">  ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">  Role role = roleService.getRole(id);</span><br><span class="line">  mv.setView(<span class="keyword">new</span> MappingJackson2JsonView());</span><br><span class="line">  mv.addObject(<span class="string">"role"</span>, role);</span><br><span class="line">  <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="逻辑视图"><a href="#逻辑视图" class="headerlink" title="逻辑视图"></a>逻辑视图</h4><p>对于逻辑视图而言它需要一个视图解析器，无论是使用XML或者注解，其根本都是在创建一个视图解析器，通过前缀和后缀加上视图名称就能找到对应的JSP文件，然后把数据模型渲染到JSP文件中，这样便能展现视图给用户了。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name =<span class="string">"viewResolver"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewResolver <span class="title">initViewResolver</span><span class="params">()</span></span>{</span><br><span class="line">  InternalResourceViewResolver viewResolver = <span class="keyword">new</span> InternalResourceViewResolver();</span><br><span class="line">  viewResolver.setPrefix(<span class="string">"/WEB-INF/jsp/"</span>);</span><br><span class="line">  viewResolver.setSuffix(<span class="string">".jsp"</span>);</span><br><span class="line">  <span class="keyword">return</span> viewResolver;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="视图解析器"><a href="#视图解析器" class="headerlink" title="视图解析器"></a>视图解析器</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.web.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewResolver</span> </span>{</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="实例：Excel视图的使用"><a href="#实例：Excel视图的使用" class="headerlink" title="实例：Excel视图的使用"></a>实例：Excel视图的使用</h4><p>对于Excel而言，Spring MVC所推荐的是使用AbstractXlsView，它实现了视图接口，从其命名也可以知道它只是一个抽象类，不能生成实例对象。</p>
<h5 id="AbstractXlsView抽象类"><a href="#AbstractXlsView抽象类" class="headerlink" title="AbstractXlsView抽象类"></a>AbstractXlsView抽象类</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.web.servlet.view.document;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.hssf.usermodel.HSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Workbook;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.view.AbstractView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractXlsView</span> <span class="keyword">extends</span> <span class="title">AbstractView</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractXlsView</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.setContentType(<span class="string">"application/vnd.ms-excel"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">generatesDownloadContent</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">renderMergedOutputModel</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        Workbook workbook = <span class="keyword">this</span>.createWorkbook(model, request);</span><br><span class="line">        <span class="keyword">this</span>.buildExcelDocument(model, workbook, request, response);</span><br><span class="line">        response.setContentType(<span class="keyword">this</span>.getContentType());</span><br><span class="line">        <span class="keyword">this</span>.renderWorkbook(workbook, response);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Workbook <span class="title">createWorkbook</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HSSFWorkbook();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">renderWorkbook</span><span class="params">(Workbook workbook, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">        ServletOutputStream out = response.getOutputStream();</span><br><span class="line">        workbook.write(out);</span><br><span class="line">        workbook.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//抽象方法，常见Excel文件</span></span><br><span class="line">    <span class="comment">//model —— Spring MVC数据模型</span></span><br><span class="line">    <span class="comment">//workbook —— POI workbook对象</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildExcelDocument</span><span class="params">(Map&lt;String, Object&gt; model, Workbook workbook, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h5 id="定义Excel导出接口"><a href="#定义Excel导出接口" class="headerlink" title="定义Excel导出接口"></a>定义Excel导出接口</h5><p>假设需要一个导出所有角色信息的功能，但是将来也许还有其他的导出功能。为了方便，先定义一个接口，这个接口主要是让开发者自定义生成Excel的规则。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Workbook;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExcelExportService</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makeWorkBook</span><span class="params">(Map&lt;String, Object&gt; model, Workbook workbook)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="自定义Excel视图类"><a href="#自定义Excel视图类" class="headerlink" title="自定义Excel视图类"></a>自定义Excel视图类</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.view;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.ExcelExportService;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Workbook;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.view.document.AbstractXlsView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelView</span> <span class="keyword">extends</span> <span class="title">AbstractXlsView</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件名</span></span><br><span class="line">    <span class="keyword">private</span> String fileName = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//导出视图自定义接口</span></span><br><span class="line">    <span class="keyword">private</span> ExcelExportService excelExportService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造方法1</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExcelView</span><span class="params">(ExcelExportService excelExportService)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.excelExportService = excelExportService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造方法2</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExcelView</span><span class="params">(String viewName, ExcelExportService excelExportService)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.setBeanName(viewName);</span><br><span class="line">        <span class="keyword">this</span>.excelExportService = excelExportService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">buildExcelDocument</span><span class="params">(Map&lt;String, Object&gt; model, Workbook workbook, HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">//没有自定义接口</span></span><br><span class="line">        <span class="keyword">if</span>(excelExportService == <span class="keyword">null</span>){</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"导出服务接口不能为null!!"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//文件名不为空，为空则使用请求路径中的字符串作为文件名</span></span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.isEmpty(fileName)){</span><br><span class="line">            <span class="comment">//进行字符转换</span></span><br><span class="line">            String reqCharset = httpServletRequest.getCharacterEncoding();</span><br><span class="line">            reqCharset = reqCharset == <span class="keyword">null</span> ? <span class="string">"UTF-8"</span> : reqCharset;</span><br><span class="line">            fileName = <span class="keyword">new</span> String(fileName.getBytes(reqCharset), <span class="string">"ISO8859-1"</span>);</span><br><span class="line">            <span class="comment">//设置下面文件名</span></span><br><span class="line">            httpServletResponse.setHeader(<span class="string">"Content-disposition"</span>, <span class="string">"attachment;filename="</span> + fileName);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//回调接口方法，使用自定义生成Excel文档</span></span><br><span class="line">        excelExportService.makeWorkBook(model, workbook);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExcelExportService</span><span class="params">(ExcelExportService excelExportService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.excelExportService = excelExportService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFileName</span><span class="params">(String fileName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.fileName = fileName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ExcelExportService <span class="title">getExcelExportService</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> excelExportService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFileName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> fileName;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="角色信息导出控制器"><a href="#角色信息导出控制器" class="headerlink" title="角色信息导出控制器"></a>角色信息导出控制器</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.ExcelExportService;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleDataService;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.view.ExcelView;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.utils.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.utils.RoleParams;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Row;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Sheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Workbook;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.PushBuilder;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleController</span> </span>{</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(value = <span class="string">"roleDataServiceImpl"</span>)</span><br><span class="line">    <span class="keyword">private</span> RoleDataService roleService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/export"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">export</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="comment">//模型和视图</span></span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        <span class="comment">//Excel视图，并设置自定义导出接口</span></span><br><span class="line">        ExcelView ev = <span class="keyword">new</span> ExcelView(exportService());</span><br><span class="line">        <span class="comment">//文件名</span></span><br><span class="line">        ev.setFileName(<span class="string">"所有角色.xlsx"</span>);</span><br><span class="line">        <span class="comment">//设置SQL后台参数</span></span><br><span class="line">        RoleParams roleParams = <span class="keyword">new</span> RoleParams();</span><br><span class="line">        <span class="comment">//限制一万条</span></span><br><span class="line">        PageParams page = <span class="keyword">new</span> PageParams();</span><br><span class="line">        page.setStart(<span class="number">0</span>);</span><br><span class="line">        page.setLimit(<span class="number">10000</span>);</span><br><span class="line">        roleParams.setPageParams(page);</span><br><span class="line">        <span class="comment">//查询</span></span><br><span class="line">        List&lt;Role&gt; roleList = roleService.findRoles(roleParams);</span><br><span class="line">        <span class="comment">//加入数据模型</span></span><br><span class="line">        mv.addObject(<span class="string">"roleList"</span>, roleList);</span><br><span class="line">        mv.setView(ev);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>({<span class="string">"unchecked"</span>})</span><br><span class="line">    <span class="function"><span class="keyword">private</span> ExcelExportService <span class="title">exportService</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="comment">//使用Lambda表达式自定义导出excel规则</span></span><br><span class="line">        <span class="keyword">return</span> (Map&lt;String, Object&gt; model, Workbook workbook) -&gt; {</span><br><span class="line">            <span class="comment">//获取用户列表</span></span><br><span class="line">            List&lt;Role&gt; roleList = (List&lt;Role&gt;) model.get(<span class="string">"roleList"</span>);</span><br><span class="line">            <span class="comment">//生成Sheet</span></span><br><span class="line">            Sheet sheet = workbook.createSheet(<span class="string">"所有角色"</span>);</span><br><span class="line">            <span class="comment">//加载标题</span></span><br><span class="line">            Row title = sheet.createRow(<span class="number">0</span>);</span><br><span class="line">            title.createCell(<span class="number">0</span>).setCellValue(<span class="string">"编号"</span>);</span><br><span class="line">            title.createCell(<span class="number">1</span>).setCellValue(<span class="string">"名称"</span>);</span><br><span class="line">            title.createCell(<span class="number">2</span>).setCellValue(<span class="string">"备注"</span>);</span><br><span class="line">            <span class="comment">//遍历角色列表，生成一行行的数据</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; roleList.size(); i ++){</span><br><span class="line">                Role role = roleList.get(i);</span><br><span class="line">                <span class="keyword">int</span> rowIdx = i + <span class="number">1</span>;</span><br><span class="line">                Row row = sheet.createRow(rowIdx);</span><br><span class="line">                row.createCell(<span class="number">0</span>).setCellValue(role.getId());</span><br><span class="line">                row.createCell(<span class="number">1</span>).setCellValue(role.getRoleName());</span><br><span class="line">                row.createCell(<span class="number">2</span>).setCellValue(role.getNote());</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h2><p>Spring MVC为上传文件提供了良好的支持。首先Spring MVC的文件上传是通过MultipartRevolver处理的，它只是一个接口，它有两个实现类：</p>
<ul>
<li>CommonsMultipartResolver：依赖于Apache下的jakarta Common FileUpload项目解析Multipart请求，可以在Spring的各个版本中使用，只是它要依赖于第三方包才得以实现；</li>
<li>StandardServletMultipartResolver：Spring3.1版本后的产物，它依赖于Servlet3.0或者更高版本的实现，它不用依赖第三方包；</li>
</ul>
<h3 id="配置properties文件"><a href="#配置properties文件" class="headerlink" title="配置properties文件"></a>配置properties文件</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 配置上传文件</span><br><span class="line"># 是否开启文件上传支持</span><br><span class="line">spring.servlet.multipart.enabled=true</span><br><span class="line"># 文件写入磁盘阈值</span><br><span class="line">spring.servlet.multipart.file-size-threshold=0</span><br><span class="line"># 文件上传临时保存位置</span><br><span class="line">spring.servlet.multipart.location=D:\\JavaTest\\upload</span><br><span class="line"># 单个文件上传的最大大小</span><br><span class="line">spring.servlet.multipart.max-file-size=5MB</span><br><span class="line"># 多个文件上传的最大大小</span><br><span class="line">spring.servlet.multipart.max-request-size=10MB</span><br><span class="line"># 文件是否延迟解析</span><br><span class="line">spring.servlet.multipart.resolve-lazily=false</span><br></pre></td></tr></tbody></table></figure>

<h3 id="前端页面"><a href="#前端页面" class="headerlink" title="前端页面"></a>前端页面</h3><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%--</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Created</span> <span class="attr">by</span> <span class="attr">IntelliJ</span> <span class="attr">IDEA.</span></span></span><br><span class="line"><span class="tag">  <span class="attr">User:</span> <span class="attr">louris</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Date:</span> <span class="attr">2021</span>/<span class="attr">9</span>/<span class="attr">28</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Time:</span> <span class="attr">10:22</span></span></span><br><span class="line"><span class="tag">  <span class="attr">To</span> <span class="attr">change</span> <span class="attr">this</span> <span class="attr">template</span> <span class="attr">use</span> <span class="attr">File</span> | <span class="attr">Settings</span> | <span class="attr">File</span> <span class="attr">Templates.</span></span></span><br><span class="line"><span class="tag"><span class="attr">--</span>%&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html;charset=UTF-8"</span> <span class="attr">language</span>=<span class="string">"java"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>上传文件<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span> <span class="attr">action</span>=<span class="string">"./uploadMultipartFile"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">value</span>=<span class="string">"请选择上传的文件"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="注入MultiPartResolver-SpringBoot无须注入"><a href="#注入MultiPartResolver-SpringBoot无须注入" class="headerlink" title="注入MultiPartResolver(SpringBoot无须注入)"></a>注入MultiPartResolver(SpringBoot无须注入)</h3><p>在Spring中，既可以通过XML，也可以通过Java去配置MultipartResolver，这里只介绍注解配置方式。<br>注意，”multipartResolver”是Spring约定好的Bean name不可以修改。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.FileSystemResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.commons.CommonsMultipartResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.support.StandardServletMultipartResolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadConfig</span> </span>{</span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"multipartResolver"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> MultipartResolver <span class="title">initMultipartResolver</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StandardServletMultipartResolver();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//需要依赖第三方包</span></span><br><span class="line"><span class="comment">//    @Bean(name = "multipartResolver")</span></span><br><span class="line"><span class="comment">//    public MultipartResolver initMultipartResolver(){</span></span><br><span class="line"><span class="comment">//        //文件上传路径</span></span><br><span class="line"><span class="comment">//        String filePath = "D:\\JavaTest\\upload";</span></span><br><span class="line"><span class="comment">//        //5MB</span></span><br><span class="line"><span class="comment">//        Long singleMax = (long) (5 * Math.pow(2, 20));</span></span><br><span class="line"><span class="comment">//        //10MB</span></span><br><span class="line"><span class="comment">//        Long totalMax = (long) (10 * Math.pow(2, 20));</span></span><br><span class="line"><span class="comment">//        CommonsMultipartResolver multipartResolver = new CommonsMultipartResolver();</span></span><br><span class="line"><span class="comment">//        multipartResolver.setMaxUploadSizePerFile(singleMax);</span></span><br><span class="line"><span class="comment">//        multipartResolver.setMaxUploadSize(totalMax);</span></span><br><span class="line"><span class="comment">//        try{</span></span><br><span class="line"><span class="comment">//            multipartResolver.setUploadTempDir(new FileSystemResource(filePath));</span></span><br><span class="line"><span class="comment">//        }catch (IOException e){</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        }</span></span><br><span class="line"><span class="comment">//        return multipartResolver;</span></span><br><span class="line"><span class="comment">//    }</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="控制器-1"><a href="#控制器-1" class="headerlink" title="控制器"></a>控制器</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartHttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.view.json.MappingJackson2JsonView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Part;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/file"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/do"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">doForm</span><span class="params">()</span></span>{</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">"upload"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/upload"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">upload</span><span class="params">(HttpServletRequest request)</span></span>{</span><br><span class="line">        <span class="comment">//进行转换</span></span><br><span class="line">        MultipartHttpServletRequest multipartHttpServletRequest = (MultipartHttpServletRequest)request;</span><br><span class="line">        <span class="comment">//获得请求上传的文件</span></span><br><span class="line">        MultipartFile file = multipartHttpServletRequest.getFile(<span class="string">"file"</span>);</span><br><span class="line">        <span class="comment">//设置视图为JSON视图</span></span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setView(<span class="keyword">new</span> MappingJackson2JsonView());</span><br><span class="line">        <span class="comment">//获取原始文件名</span></span><br><span class="line">        String fileName = file.getOriginalFilename();</span><br><span class="line">        <span class="comment">//目标文件</span></span><br><span class="line">        File dest = <span class="keyword">new</span> File(fileName);</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="comment">//保存文件</span></span><br><span class="line">            file.transferTo(dest);</span><br><span class="line">            <span class="comment">//保存成功</span></span><br><span class="line">            mv.addObject(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">            mv.addObject(<span class="string">"msg"</span>, <span class="string">"上传文件成功"</span>);</span><br><span class="line">        }<span class="keyword">catch</span> (IllegalStateException | IOException e){</span><br><span class="line">            <span class="comment">//保存失败</span></span><br><span class="line">            mv.addObject(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">            mv.addObject(<span class="string">"msg"</span>, <span class="string">"上传文件失败"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/uploadMultipartFile"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">uploadMultipartFile</span><span class="params">(MultipartFile file)</span></span>{</span><br><span class="line">        <span class="comment">//设置视图为JSON视图</span></span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setView(<span class="keyword">new</span> MappingJackson2JsonView());</span><br><span class="line">        <span class="comment">//获取原始文件名</span></span><br><span class="line">        String fileName = file.getOriginalFilename();</span><br><span class="line">        <span class="comment">//目标文件</span></span><br><span class="line">        File dest = <span class="keyword">new</span> File(fileName);</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="comment">//保存文件</span></span><br><span class="line">            file.transferTo(dest);</span><br><span class="line">            <span class="comment">//保存成功</span></span><br><span class="line">            mv.addObject(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">            mv.addObject(<span class="string">"msg"</span>, <span class="string">"上传文件成功"</span>);</span><br><span class="line">        }<span class="keyword">catch</span> (IllegalStateException | IOException e){</span><br><span class="line">            <span class="comment">//保存失败</span></span><br><span class="line">            mv.addObject(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">            mv.addObject(<span class="string">"msg"</span>, <span class="string">"上传文件失败"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/uploadPart"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">uploadPart</span><span class="params">(Part file)</span></span>{</span><br><span class="line">        <span class="comment">//设置视图为JSON视图</span></span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setView(<span class="keyword">new</span> MappingJackson2JsonView());</span><br><span class="line">        <span class="comment">//获取原始文件名</span></span><br><span class="line">        String fileName = file.getSubmittedFileName();</span><br><span class="line">        <span class="comment">//目标文件</span></span><br><span class="line">        File dest = <span class="keyword">new</span> File(fileName);</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="comment">//保存文件</span></span><br><span class="line">            file.write(<span class="string">"D:\\JavaTest\\upload\\"</span> + fileName);</span><br><span class="line">            <span class="comment">//保存成功</span></span><br><span class="line">            mv.addObject(<span class="string">"success"</span>, <span class="keyword">true</span>);</span><br><span class="line">            mv.addObject(<span class="string">"msg"</span>, <span class="string">"上传文件成功"</span>);</span><br><span class="line">        }<span class="keyword">catch</span> (IllegalStateException | IOException e){</span><br><span class="line">            <span class="comment">//保存失败</span></span><br><span class="line">            mv.addObject(<span class="string">"success"</span>, <span class="keyword">false</span>);</span><br><span class="line">            mv.addObject(<span class="string">"msg"</span>, <span class="string">"上传文件失败"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="Spring-MVC高级应用"><a href="#Spring-MVC高级应用" class="headerlink" title="Spring MVC高级应用"></a>Spring MVC高级应用</h1></blockquote>
<h2 id="Spring-MVC的数据转换和格式化"><a href="#Spring-MVC的数据转换和格式化" class="headerlink" title="Spring MVC的数据转换和格式化"></a>Spring MVC的数据转换和格式化</h2><p>首先当一个请求到达 DispatcherServlet 的时候，需要找到对应的Handler Mapping ，然后根据 HandlerMapping 去找到对应的 HandlerAdapter 执行处理器。处理器在要调用的控制器之前，需要先获取 HTTP 发送过来的信息，然后将其转变为控制器的各种不同类型参数，这就是各类注解能够得到丰富类型参数的原因。它首先用 HTTP消息转换器（HttpMessageConverter ）对消息转换，但是这是 个比较原始的转换，它是String类型和文件类型比较简易的转换，它还需要进一步转换才能转换为 POJO 或者其他丰富的参数类型。为了拥有这样的能力， Spring 提供了转换器和格式化器，这样通过注解的信息和参数的类型，它就能够把 HTTP 发送过来的各种消息转换成为控制器所需要的各类参数了。</p>
<p>当处理器处理完了这些参数的转换，它就会进行验证，验证表单的方法在 15 章已经谈及。完成了这些内容，下 步就是调用开发者所提供的控制器了，将之前转换成功的参数传递进去，这样我 开发的控制器就能够得到丰富的 Java 类型的支持了，进而完成控制器的逻辑，控制器完成了对应的逻辑，返回结果后，处理器如果可以找到对应处理结果类型HttpMessageConverter 的实现类，它就会调用对应的 HttpMessageConverter 的实现类方法。对控制器返回的结果进行 HTTP 转换 步不是必须的，可以转换的前提是能够找到对应的转换器 在讨论注解＠ResponseBody 会再次看到这个过程，做完这些处理器的功能就完成了。</p>
<p>接下来就是关于视图解析和视图解析器的流程了，在前面的章节我们已经有了详细地阐述。整个过程是比较复杂的， 有时候要自定义 些特殊的转换规则，比如我们和第合作，合作方可能提供的并不是一 良好的 JSON 式，而是一些特殊的规则，这个时候就可能需要使用自定义的消息转换规则，把消息转换为对应的 Java 类型，从而简化开发。</p>
<p>在Java 类型转换之前， Spring MVC 中，为了应对 HTTP 请求，它还定义了HttpMessageConverter ，它是 个总体的接口，通过它可以读入 HTT 请求内容。也就是说，在读取 HTTP 请求的参数和内容的时候会先用 HttpMessageConverter 读出，做一次简单转换为 Java 类型， 主要是字符串 String ），然后就可以使用各类转换器进行转换了，在逻辑业务处理完成后，还可以通过它把数据转换为响应给用户的内容。对于转换器而言，在 Spring 中分为两大类，一种是由 Converter 接口所定义的，另外种是 GenericConverter ，它们都可以使用注册机注册。注意，它们都是来自于 Spring Core 项目，而非 SpringMVC 项目，它的作用范围是 Java 内部各种类型之间的转换。</p>
<h3 id="HttpMessageConverter和JSON消息转换器"><a href="#HttpMessageConverter和JSON消息转换器" class="headerlink" title="HttpMessageConverter和JSON消息转换器"></a>HttpMessageConverter和JSON消息转换器</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.http.converter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpInputMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpOutputMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HttpMessageConverter</span>&lt;<span class="title">T</span>&gt; </span>{</span><br><span class="line">    <span class="comment">//判断类型是否可读，clazz是类别，而对于mediaType是HTTP类型</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">canRead</span><span class="params">(Class&lt;?&gt; clazz, @Nullable MediaType mediaType)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断类型是否可写，clazz是类别，而对于mediaType是HTTP类型</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">canWrite</span><span class="params">(Class&lt;?&gt; clazz, @Nullable MediaType mediaType)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对于mediaType是HTTP类型</span></span><br><span class="line">    <span class="function">List&lt;MediaType&gt; <span class="title">getSupportedMediaTypes</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> List&lt;MediaType&gt; <span class="title">getSupportedMediaTypes</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">this</span>.canRead(clazz, (MediaType)<span class="keyword">null</span>) &amp;&amp; !<span class="keyword">this</span>.canWrite(clazz, (MediaType)<span class="keyword">null</span>) ? Collections.emptyList() : <span class="keyword">this</span>.getSupportedMediaTypes();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取数据类型，进行转换，clazz是类，而inputMessage是HTTP请求消息</span></span><br><span class="line">    <span class="function">T <span class="title">read</span><span class="params">(Class&lt;? extends T&gt; var1, HttpInputMessage var2)</span> <span class="keyword">throws</span> IOException, HttpMessageNotReadableException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消息写，contentType是HTTP类型，outputMessage是HTTP的应答消息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">(T var1, @Nullable MediaType var2, HttpOutputMessage var3)</span> <span class="keyword">throws</span> IOException, HttpMessageNotWritableException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="JSON消息转换类"><a href="#JSON消息转换类" class="headerlink" title="JSON消息转换类"></a>JSON消息转换类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConvertConfig</span> </span>{</span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"requestMappingHandlerAdapter"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HandlerAdapter <span class="title">initRequestMappingHandlerAdapter</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="comment">//创建RequestMappingHandlerAdapter适配器</span></span><br><span class="line">        RequestMappingHandlerAdapter requestMappingHandlerAdapter = <span class="keyword">new</span> RequestMappingHandlerAdapter();</span><br><span class="line">        <span class="comment">//HTTP JSON转换器</span></span><br><span class="line">        MappingJackson2HttpMessageConverter mappingJackson2HttpMessageConverter = <span class="keyword">new</span> MappingJackson2HttpMessageConverter();</span><br><span class="line">        <span class="comment">//http类型支持为JSON类型</span></span><br><span class="line">        MediaType mediaType = MediaType.APPLICATION_JSON_UTF8;</span><br><span class="line">        List&lt;MediaType&gt; mediaTypes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        mediaTypes.add(mediaType);</span><br><span class="line">        <span class="comment">//加入转换器的支持类型</span></span><br><span class="line">        mappingJackson2HttpMessageConverter.setSupportedMediaTypes(mediaTypes);</span><br><span class="line">        <span class="comment">//往适配器加入JSON转换器</span></span><br><span class="line">        requestMappingHandlerAdapter.getMessageConverters().add(mappingJackson2HttpMessageConverter);</span><br><span class="line">        <span class="keyword">return</span> requestMappingHandlerAdapter;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageConverters"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"jsonConverter"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jsonConverter"</span> <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>application/json;charset=UTF-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="ResponseBody注解"><a href="#ResponseBody注解" class="headerlink" title="@ResponseBody注解"></a>@ResponseBody注解</h4><p>通过注解@ResponseBody将标记Spring MVC，将响应结果转变为JSON，这样在控制器返回结果后，它会通过类型判断找到MappingJackson2HttpMessageConverter实例，进而在处理器内转变为JSON，从而满足JSON的转换的要求。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/json"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Role <span class="title">getRole</span><span class="params">()</span></span>{</span><br><span class="line">    Role role = <span class="keyword">new</span> Role();</span><br><span class="line">    role.setId(<span class="number">1L</span>);</span><br><span class="line">    role.setRoleName(<span class="string">"John"</span>);</span><br><span class="line">    role.setNote(<span class="string">"Note!!!"</span>);</span><br><span class="line">    <span class="keyword">return</span> role;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="一对一转换器（Converter）"><a href="#一对一转换器（Converter）" class="headerlink" title="一对一转换器（Converter）"></a>一对一转换器（Converter）</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.core.convert.converter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Converter</span>&lt;<span class="title">S</span>, <span class="title">T</span>&gt; </span>{</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">T <span class="title">convert</span><span class="params">(S var1)</span></span>; <span class="comment">//S为源类型，T为目标类型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> &lt;U&gt; <span class="function">Converter&lt;S, U&gt; <span class="title">andThen</span><span class="params">(Converter&lt;? <span class="keyword">super</span> T, ? extends U&gt; after)</span> </span>{</span><br><span class="line">        Assert.notNull(after, <span class="string">"After Converter must not be null"</span>);</span><br><span class="line">        <span class="keyword">return</span> (s) -&gt; {</span><br><span class="line">            T initialResult = <span class="keyword">this</span>.convert(s);</span><br><span class="line">            <span class="keyword">return</span> initialResult != <span class="keyword">null</span> ? after.convert(initialResult) : <span class="keyword">null</span>;</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Spring Core项目的部分转换器</p>
<table>
<thead>
<tr>
<th align="center">转换器</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">CharacterToNumber</td>
<td align="left">将字符转换为数字</td>
</tr>
<tr>
<td align="center">IntegerToEnum</td>
<td align="left">将整数转换为枚举类型</td>
</tr>
<tr>
<td align="center">ObjectToStringConverter</td>
<td align="left">将对象转换为字符串</td>
</tr>
<tr>
<td align="center">SerializingConverter</td>
<td align="left">序列化转换器</td>
</tr>
<tr>
<td align="center">DeserializingConverter</td>
<td align="left">反序列化转换器</td>
</tr>
<tr>
<td align="center">StringToBooleanConverter</td>
<td align="left">将字符串转换为布尔值</td>
</tr>
<tr>
<td align="center">StringToEnum</td>
<td align="left">将字符串转换为枚举</td>
</tr>
<tr>
<td align="center">StringToCurrencyConverter</td>
<td align="left">将字符串转换为金额</td>
</tr>
<tr>
<td align="center">EnumToStringConverter</td>
<td align="left">将枚举转化为字符串</td>
</tr>
</tbody></table>
<p>通过HttpMessageConverter把HTTP的消息读出后，Spring MVC就开始使用这些转换器来将HTTP的信息，转化为控制器的参数，这就是能在控制器上获得各类参数的原因。大部分情况下，Spring MVC所提供的功能，能够满足一般的需求，但是有时候我们需要进行自定义转化规则，这当然也不会太困难，只要实现接口Converter，然后注册给对应的转换服务类就可以了。</p>
<h3 id="自定义SpringToRole转换器"><a href="#自定义SpringToRole转换器" class="headerlink" title="自定义SpringToRole转换器"></a>自定义SpringToRole转换器</h3><p>@Component注解将bean注册给IoC容器，Spring MVC就会<a href="https://www.jianshu.com/p/e2505bc1a73d" target="_blank" rel="noopener">自动进行converter的注册</a></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.converter.Converter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringToRoleConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">String</span>, <span class="title">Role</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str "{id}-{role_name}-{note}"格式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">convert</span><span class="params">(String str)</span> </span>{</span><br><span class="line">        <span class="comment">//空串</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(str)){</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//不包含指定字符</span></span><br><span class="line">        <span class="keyword">if</span>(!str.contains(<span class="string">"-"</span>)){</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line">        String[] arr = str.split(<span class="string">"-"</span>);</span><br><span class="line">        <span class="comment">//字符串长度不对</span></span><br><span class="line">        <span class="keyword">if</span>(arr.length != <span class="number">3</span>){</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line">        System.out.println(<span class="string">"convert"</span>);</span><br><span class="line">        Role role = <span class="keyword">new</span> Role();</span><br><span class="line">        role.setId(Long.parseLong(arr[<span class="number">0</span>]));</span><br><span class="line">        role.setRoleName(arr[<span class="number">1</span>]);</span><br><span class="line">        role.setNote(arr[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">return</span> role;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="控制器-2"><a href="#控制器-2" class="headerlink" title="控制器"></a>控制器</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/updateRole"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">updateRole</span><span class="params">(Role role)</span> </span>{</span><br><span class="line">    Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    System.out.println(role.toString());</span><br><span class="line">    <span class="comment">//更新角色</span></span><br><span class="line">    result.put(<span class="string">"msg"</span>, <span class="string">"更新成功"</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>运行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">convert</span><br><span class="line">Role{id=<span class="number">1</span>, roleName=<span class="string">'role_name_1'</span>, note=<span class="string">'aaaa'</span>}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="数组和集合转换器-GenericConverter"><a href="#数组和集合转换器-GenericConverter" class="headerlink" title="数组和集合转换器 GenericConverter"></a>数组和集合转换器 GenericConverter</h3><ul>
<li>一对一的转换器只能从一种类型转换成另一种类型，不能进行一对多转换，比如把String转换为List<string>或者String[]，甚至是List<role>。</role></string></li>
<li>为了克服这个问题，Spring Core项目还加入了另外一个转换器结构GenericConverter，它能够满足数组和集合转换的要求。<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.core.convert.converter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.TypeDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GenericConverter</span> </span>{</span><br><span class="line">    <span class="comment">//返回可接受的转化类型</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    Set&lt;GenericConverter.ConvertiblePair&gt; getConvertibleTypes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//转换方法</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">Object <span class="title">convert</span><span class="params">(@Nullable Object var1, TypeDescriptor var2, TypeDescriptor var3)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//可转换匹配类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConvertiblePair</span> </span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; sourceType; <span class="comment">//源类型</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; targetType; <span class="comment">//目标类型</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ConvertiblePair</span><span class="params">(Class&lt;?&gt; sourceType, Class&lt;?&gt; targetType)</span> </span>{</span><br><span class="line">            Assert.notNull(sourceType, <span class="string">"Source type must not be null"</span>);</span><br><span class="line">            Assert.notNull(targetType, <span class="string">"Target type must not be null"</span>);</span><br><span class="line">            <span class="keyword">this</span>.sourceType = sourceType;</span><br><span class="line">            <span class="keyword">this</span>.targetType = targetType;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Class&lt;?&gt; getSourceType() {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.sourceType;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Class&lt;?&gt; getTargetType() {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.targetType;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(@Nullable Object other)</span> </span>{</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == other) {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (other != <span class="keyword">null</span> &amp;&amp; other.getClass() == GenericConverter.ConvertiblePair<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">                GenericConverter.ConvertiblePair otherPair = (GenericConverter.ConvertiblePair)other;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.sourceType == otherPair.sourceType &amp;&amp; <span class="keyword">this</span>.targetType == otherPair.targetType;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.sourceType.hashCode() * <span class="number">31</span> + <span class="keyword">this</span>.targetType.hashCode();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.sourceType.getName() + <span class="string">" -&gt; "</span> + <span class="keyword">this</span>.targetType.getName();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
在Spring MVC中，这是一个比较底层的接口，为了进行类型匹配判断，还定义了另外一个接口：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.core.convert.converter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.TypeDescriptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConditionalConverter</span> </span>{</span><br><span class="line">    <span class="comment">//如果返回true，才进行下一步转换</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(TypeDescriptor sourceType, TypeDescriptor targetType)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
为了整合原有接口GenericConverter，有了一个新的接口：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.core.convert.converter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConditionalGenericConverter</span> <span class="keyword">extends</span> <span class="title">GenericConverter</span>, <span class="title">ConditionalConverter</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
基于该接口，Spring Core开发了不少的实现类，这些实现类都会注册到ConversionService对象里，通诺ConditioanlConverter的matches进行匹配。如果可以匹配，则会调用convert方法进行转换，它能够提供各种对数组和集合的转换。</li>
</ul>
<h4 id="StringToArrayConverter"><a href="#StringToArrayConverter" class="headerlink" title="StringToArrayConverter"></a>StringToArrayConverter</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.springframework.core.convert.support;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.ConversionService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.TypeDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.converter.ConditionalGenericConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.convert.converter.GenericConverter.ConvertiblePair;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StringToArrayConverter</span> <span class="keyword">implements</span> <span class="title">ConditionalGenericConverter</span> </span>{</span><br><span class="line">    <span class="comment">//转换服务类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConversionService conversionService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StringToArrayConverter</span><span class="params">(ConversionService conversionService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.conversionService = conversionService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//可接受的类型</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;ConvertiblePair&gt; <span class="title">getConvertibleTypes</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">//确定转换类型</span></span><br><span class="line">        return Collections.singleton(new ConvertiblePair(String.class, Object[].class));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查找是否存在Converter支持转换，如果不使用系统的，那么需要自己注册</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(TypeDescriptor sourceType, TypeDescriptor targetType)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> ConversionUtils.canConvertElements(sourceType, targetType.getElementTypeDescriptor(), <span class="keyword">this</span>.conversionService);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//转换方法</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">convert</span><span class="params">(@Nullable Object source, TypeDescriptor sourceType, TypeDescriptor targetType)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (source == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">//源数据</span></span><br><span class="line">            String string = (String)source;</span><br><span class="line">            <span class="comment">//逗号分隔字符串</span></span><br><span class="line">            String[] fields = StringUtils.commaDelimitedListToStringArray(string);</span><br><span class="line">            TypeDescriptor targetElementType = targetType.getElementTypeDescriptor();</span><br><span class="line">            Assert.state(targetElementType != <span class="keyword">null</span>, <span class="string">"No target element type"</span>);</span><br><span class="line">            <span class="comment">//转换目标</span></span><br><span class="line">            Object target = Array.newInstance(targetElementType.getType(), fields.length);</span><br><span class="line">            <span class="comment">//遍历数组</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fields.length; ++i) {</span><br><span class="line">                String sourceElement = fields[i];</span><br><span class="line">                <span class="comment">//使用conversionService做类型转换，要求我们使用一个自定义或者Spring Core的Converter</span></span><br><span class="line">                Object targetElement = <span class="keyword">this</span>.conversionService.convert(sourceElement.trim(), sourceType, targetElementType);</span><br><span class="line">                Array.set(target, i, targetElement);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> target;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>首先，创建StringToArrayConverter对象需要一个ConversionService对象，而getConvertibleTypes方法则是可以自定义的类型，matches方法匹配类型，通过源类型和目标类型判定使用何种Converter能够转换，那么convert方法用于完成对字符串和数字的转换。在大部分情况下，我们都不需要自定义ConditionalGenericConverter实现类，只需要使用Spring MVC提供的便可以了。</p>
<p>由于需要使用一个定义好的Converter，所以利用之前的转换器，按照StringToArrayConverter对象的逻辑，每一个数组的元素都需要用逗号分隔，所以在原有StringToRoleConverter的规则上，让每一个角色对象的传递加入一个逗号分隔便可以了。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/updateRole"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">updateRole</span><span class="params">(@RequestParam(required = <span class="keyword">false</span>)</span> Role[] roles) </span>{</span><br><span class="line">    Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(Role role:roles){</span><br><span class="line">        System.out.println(role.toString());</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//更新角色</span></span><br><span class="line">    result.put(<span class="string">"msg"</span>, <span class="string">"更新成功"</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">convert</span><br><span class="line">convert</span><br><span class="line">Role{id=<span class="number">1</span>, roleName=<span class="string">'role_name_1'</span>, note=<span class="string">'aaaa'</span>}</span><br><span class="line">Role{id=<span class="number">2</span>, roleName=<span class="string">'role_name_1'</span>, note=<span class="string">'aaaa'</span>}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用格式化器（Formatter）"><a href="#使用格式化器（Formatter）" class="headerlink" title="使用格式化器（Formatter）"></a>使用格式化器（Formatter）</h3><p>有些数据需要格式化，比如说金额、日期等。传递 期格 yyyy-MM-dd 或者 yyyy-MM-dd hh ss rnrn ，这些是需要格式化的，对于金额也是如此，比如1万元币，正式场合往往要写作￥10000.00这些都要求字符串按一定的格式转为日期或者金额。为了对这些场景做出支持，Spring Context提供了相关的Formatter。它需要实现一个接口——Formatter，而Formatter又扩展了两个接口Printer和Parser。</p>
<p>在Spring内部用得比较多的两个注解是@DateTimeFormat和@NumberFormat，在客户端显示需要使用相关的标签。</p>
<h4 id="注解参数"><a href="#注解参数" class="headerlink" title="注解参数"></a>注解参数</h4><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%--</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Created</span> <span class="attr">by</span> <span class="attr">IntelliJ</span> <span class="attr">IDEA.</span></span></span><br><span class="line"><span class="tag">  <span class="attr">User:</span> <span class="attr">louris</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Date:</span> <span class="attr">2021</span>/<span class="attr">9</span>/<span class="attr">29</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Time:</span> <span class="attr">16:23</span></span></span><br><span class="line"><span class="tag">  <span class="attr">To</span> <span class="attr">change</span> <span class="attr">this</span> <span class="attr">template</span> <span class="attr">use</span> <span class="attr">File</span> | <span class="attr">Settings</span> | <span class="attr">File</span> <span class="attr">Templates.</span></span></span><br><span class="line"><span class="tag"><span class="attr">--</span>%&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html;charset=UTF-8"</span> <span class="attr">language</span>=<span class="string">"java"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charste=UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"form"</span> <span class="attr">action</span>=<span class="string">"./format"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>日期<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"date"</span> <span class="attr">name</span>=<span class="string">"date1"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"2017-06-01"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>金额<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"amount"</span> <span class="attr">name</span>=<span class="string">"amount1"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"123,000.00"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"commit"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>/&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/format"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">format</span><span class="params">(@RequestParam(<span class="string">"date1"</span>)</span> @<span class="title">DateTimeFormat</span><span class="params">(iso = DateTimeFormat.ISO.DATE)</span>Date date,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(<span class="string">"amount1"</span>)</span> @<span class="title">NumberFormat</span><span class="params">(pattern = <span class="string">"#,###.##"</span>)</span> Double amount)</span>{</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    System.out.println(date.toString());</span><br><span class="line">    System.out.println(amount.toString());</span><br><span class="line">    mv.addObject(<span class="string">"date"</span>, date);</span><br><span class="line">    mv.addObject(<span class="string">"amount"</span>, amount);</span><br><span class="line">    mv.setViewName(<span class="string">"enter"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="注解类变量"><a href="#注解类变量" class="headerlink" title="注解类变量"></a>注解类变量</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.beans.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.NumberFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormatPojo</span> </span>{</span><br><span class="line">    <span class="meta">@DateTimeFormat</span>(iso = DateTimeFormat.ISO.DATE)</span><br><span class="line">    <span class="keyword">private</span> Date date1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NumberFormat</span>(pattern = <span class="string">"##,###.00"</span>)</span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount1;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAmount1</span><span class="params">(BigDecimal amount1)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.amount1 = amount1;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDate1</span><span class="params">(Date date1)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.date1 = date1;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getAmount1</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> amount1;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getDate1</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> date1;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/formatPojo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">format</span><span class="params">(FormatPojo pojo)</span></span>{</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    System.out.println(pojo.getDate1().toString());</span><br><span class="line">    System.out.println(pojo.getAmount1().toString());</span><br><span class="line">    mv.setViewName(<span class="string">"enter"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="为控制器添加通知"><a href="#为控制器添加通知" class="headerlink" title="为控制器添加通知"></a>为控制器添加通知</h2><p>与Spring AOP一样，Spring MVC也能够给控制器加入通知，它主要涉及4个注解：</p>
<ul>
<li>@ControllerAdvice，主要作用于类，用以标识全局性的控制器的拦截器，它将应用于对应的控制器；</li>
<li>@InitBinder，是一个允许构建POJO参数的方法，允许在构造控制器参数的时候，加入一定的自定义控制；</li>
<li>@ExceptionHandler，通过它可以注册一个控制器异常，使用当控制器发生注册异常时，就会跳转到该方法上；</li>
<li>@ModelAttribute，是一种针对于数据模型的注解，它先于控制器方法运行，当标注方法返回对象时，它会保存到数据模型中。</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.propertyeditors.CustomDateEditor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.WebDataBinder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.InitBinder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ModelAttribute;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ControllerAdvice</span>(basePackages = {<span class="string">"com.louris.springboot.IoCImpl.controller"</span>})</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonControllerAdvice</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义HTTP对应参数处理规则</span></span><br><span class="line">    <span class="meta">@InitBinder</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initBinder</span><span class="params">(WebDataBinder binder)</span></span>{</span><br><span class="line">        <span class="comment">//针对日期类型的格式化，其中CustomDateEditor是客户自定义编辑器</span></span><br><span class="line">        <span class="comment">//它的boolean参数表示是否允许为空</span></span><br><span class="line">        binder.registerCustomEditor(Date<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line">                new CustomDateEditor(new SimpleDateFormat("yyyy-MM-dd"), false));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理数据模型，如果返回对象，则该对象会保存在数据模型中</span></span><br><span class="line">    <span class="meta">@ModelAttribute</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">populateModel</span><span class="params">(Model model)</span></span>{</span><br><span class="line">        model.addAttribute(<span class="string">"projectName"</span>, <span class="string">"springboot of louris"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//异常处理，使得被拦截的控制器方法发生异常时，都能用相同的视图响应</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">String</span> <span class="title">exception</span>()</span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"exception"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>首先，注解＠ControllerAdvice 己经标记了＠Component ，所以标注它， SpringMVC扫描的时候就会将其放置到 IoC 容器中</strong>，而它的属性 basePackages 则是指定拦截的控制器然后，通过注解＠InitBinder 可以获得 个参数一－WebDataBinder，它是 个可以指定 POJO参数属性转换的数据绑定，这里使用了关于日期 CustomDateEditor ，并且指定格式为yyyy-MM-dd ，它还允许自定义验证器，在第 15 章看到了这个过程，它的作用是允许参数的转换和验证器进行自定义。这样被拦截的控制器关于日期对象的参数，都会被它处理，就不需要我们自己制定 ormatter 了。再次，＠ModelAttribute 是关于数据模型的，它会在进入控制器方法前运行，加入一个数据模型键值对 projectName”－ chapter! 。最后@ExceptionHandler 的作用是制定被拦截的控制器发生异常后，如果异常匹配，就会使用该方法处理，返回字符串 exception”，那它就会找到对应的异常 JSP 去响应，这样就可以避免异常页面的不友好。</p>
<p>而事实上，控制器也可以使用@InitBinder、@ExceptionHandler、@ModelAttribute。注意，它只对于当前控制器有效</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleController</span> </span>{</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(value = <span class="string">"roleDataServiceImpl"</span>)</span><br><span class="line">    <span class="keyword">private</span> RoleDataService roleService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ModelAttribute</span>(<span class="string">"role"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">initRole</span><span class="params">(@RequestParam(value = <span class="string">"id"</span>, required = <span class="keyword">false</span>)</span> Long id)</span>{</span><br><span class="line">        <span class="comment">//判断id是否为空</span></span><br><span class="line">        <span class="keyword">if</span>(id == <span class="keyword">null</span> || id &lt; <span class="number">1</span>){</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line">        Role role = roleService.getRoleByKey(id);</span><br><span class="line">        <span class="keyword">return</span> role;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"getRoleFromModelAttribute"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">getRoleFromModelAttribute</span><span class="params">(@ModelAttribute(<span class="string">"role"</span>)</span> Role role)</span>{</span><br><span class="line">        <span class="keyword">return</span> role;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>注意，这个控制器并不在注解＠ControllerAdvice 所扫描的包内，所以不会被公共通知所拦截，它内部的注解@ModelAttribute 只是针对当前控制器本身。它所注解的方法会在控制器之前运行。</li>
<li>这里定义变量名为 role ，这样在运行这个方法之后，返回查询的角色对象，系统就会把返回的角色对象以键 role 保存到数据模型。</li>
<li>getRoleFromModelAttribute 方法的角色参数也只需要注解＠ModelAttrib1 通过变量名 role 取出即可，这样就完成了参数传递.</li>
</ul>
<h2 id="处理异常"><a href="#处理异常" class="headerlink" title="处理异常"></a>处理异常</h2><p>控制器的通知注解@ExceptionHandler 可以处理异常，这点之前我们己经讨论过。此外，SpringMVC 还提供了其他的异常处理机制，通过使用它们可以获取更为精确的信息，从而为定位问题带来方便。在默认的情况下， pring 会将自身产生的异常转换为合适的状态码，通过这些状态码可以进一步确定异常发生的原因，便于找到对应的问题</p>
<table>
<thead>
<tr>
<th align="left">Spring异常</th>
<th align="center">状态码</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">BindException</td>
<td align="center">400-Bad Request</td>
<td align="left">数据绑定异常</td>
</tr>
<tr>
<td align="left">ConversionNotSupportedException</td>
<td align="center">500-Internal Server Error</td>
<td align="left">数据类型转换异常</td>
</tr>
<tr>
<td align="left">HttpMediaTypeNotSupportedException</td>
<td align="center">406-Not Acceptable</td>
<td align="left">HTTP媒体类型不可接受异常</td>
</tr>
<tr>
<td align="left">HttpMediaTypeNotSupportedException</td>
<td align="center">415-Unsupported Media Type</td>
<td align="left">HTTP媒体类型不支持异常</td>
</tr>
<tr>
<td align="left">HttpMessageNotReadableException</td>
<td align="center">400-Bad Request</td>
<td align="left">HTTP消息不可读异常</td>
</tr>
<tr>
<td align="left">HttpMessageNotWritableException</td>
<td align="center">500-Internal Server Error</td>
<td align="left">HTTP消息不可写异常</td>
</tr>
<tr>
<td align="left">HttpRequestMethodNotSupportedException</td>
<td align="center">405-Method Not Allowed</td>
<td align="left">HTTP请求找不到处理方法异常，往往是HandlerMapping找不到控制器或其方法响应</td>
</tr>
<tr>
<td align="left">MethodArgumentNotValidException</td>
<td align="center">400-Bad Request</td>
<td align="left">控制器方法参数无效异常，一般是参数方面的问题</td>
</tr>
<tr>
<td align="left">MissingServletRequestParameterException</td>
<td align="center">400-Bad Request</td>
<td align="left">缺失参数异常</td>
</tr>
<tr>
<td align="left">MissingServletRequestPartException</td>
<td align="center">400-Bad Request</td>
<td align="left">方法中表明了采用“multipar/form-data”请求，而实际不是该请求</td>
</tr>
<tr>
<td align="left">TypeMismatchException</td>
<td align="center">400-Bad Request</td>
<td align="left">当设置一个POJO属性的时候，发现类型不对</td>
</tr>
</tbody></table>
<h3 id="自定义异常"><a href="#自定义异常" class="headerlink" title="自定义异常"></a>自定义异常</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增Spring MVC的异常映射，code代表异常映射码，而reason则代表异常原因</span></span><br><span class="line"><span class="meta">@ResponseStatus</span>(code = HttpStatus.NOT_FOUND, reason = <span class="string">"找不到角色信息异常！"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5040949196309781680L</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"notFound"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Role <span class="title">notFound</span><span class="params">(Long id)</span></span>{</span><br><span class="line">    Role role = roleService.getRoleByKey(id);</span><br><span class="line">    <span class="comment">//找不到角色信息抛出RoleException</span></span><br><span class="line">    <span class="keyword">if</span>(role == <span class="keyword">null</span>){</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RoleException();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> role;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//当前控制器发生RoleException异常时，进入该方法</span></span><br><span class="line"><span class="meta">@ExceptionHandler</span>(RoleException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">String</span> <span class="title">handlerRoleException</span>(<span class="title">RoleException</span> <span class="title">e</span>)</span>{</span><br><span class="line">    <span class="comment">//返回指定的页面，避免不友好</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"exception"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h2><p>有时候可能需要国际化，比如开发一个需要提供中文和英文的网站，特别是外资企业更是如此，国际化一般分为语言、时区和国家等信息。</p>
<h3 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h3><p>DispatcherServlet会解析一个LocaleResolver接口对象，通过它来决定用户区域（User Locale），读出对应用户系统设定的语言或者用户选择的语言，以确定其国际化。注意，对于DispatcherServlet而言，只能注册一个LocaleResolver接口对象。LocaleContextResolver，能够处理一些用户区域上的问题，包括语言和时区的问题。</p>
<ul>
<li>AcceptHeaderLocaleResolver：Spring默认的区域解析器，它通过检验HTTP请求的accept-language头部来解析区域。这个头部是由用户的web浏览器根据底层操作系统的区域设置进行设定。注意，这个区域解析器无法改变用户的区域，因为它无法修改用户操作系统的区域设置，所以它并不需要开发，因此没进一步讨论的必要；</li>
<li>FixedLocaleResolver：使用固定Locale国际化，不可修改Locale，这个可以由开发者提供固定的规则，一般不用，本书不再讨论它；</li>
<li>CookieLocaleResolver：根据Cookie数据获取国际化数据，由于用户禁止Cookie或者没有设置，如果是这样，它会根据accept-language HTTP头部确定默认区域；</li>
<li>SessionLocaleResolver：根据Session进行国际化，也就是根据用户Session的变量读取区域设置，所以它是可变的。如果Session也没有设置，那么它也会使用开发者设置默认的值。</li>
</ul>
<p>只有CookieLocaleResolver和SessionLocaleResolver才能通过Cookie或者Session去修改国际化，而另两个是固定的，所以现实中使用得多的是CookieLocaleResolver和SessionLocaleResolver。</p>
<h3 id="MessageSource接口"><a href="#MessageSource接口" class="headerlink" title="MessageSource接口"></a>MessageSource接口</h3><p>如何加载国际化文件的问题，MessageSource接口是Spring MVC为了加载消息所设置的接口。</p>
<ul>
<li>StaticMessageSource类是一种静态的消息</li>
<li>DelegatingMessageSource实现的是一个代理的功能，这两者在实际应用中使用并不多</li>
<li>ResourceBundleMessageSource使用的是JDK提供的ResourceBundle，它只能把文件放置在对应的类路径下。它不具备热加载的功能，也就是需要重启系统才能重新加载它。</li>
<li>ReloadableResourceBundleMessageSource更为灵活，它可以把属性文件放置在任何地方，可以在系统不重启的情况下</li>
</ul>
<p>注意”messageSource”是一个默认约定的名称，不能修改。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.MessageSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ReloadableResourceBundleMessageSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ResourceBundleMessageSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InternationalConfig</span> </span>{</span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"messageSource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageSource <span class="title">initMessageSource</span><span class="params">()</span></span>{</span><br><span class="line">        ResourceBundleMessageSource messageSource = <span class="keyword">new</span> ResourceBundleMessageSource();</span><br><span class="line">        messageSource.setDefaultEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        messageSource.setBasename(<span class="string">"msg"</span>);</span><br><span class="line">        <span class="keyword">return</span> messageSource;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"messageSource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageSource <span class="title">initMessageSource</span><span class="params">()</span></span>{</span><br><span class="line">        ReloadableResourceBundleMessageSource messageSource = <span class="keyword">new</span> ReloadableResourceBundleMessageSource();</span><br><span class="line">        messageSource.setDefaultEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        messageSource.setBasename(<span class="string">"classpath:msg"</span>);</span><br><span class="line">        <span class="comment">//缓存3600秒，相当于1小时，然后重新刷新</span></span><br><span class="line">        messageSource.setCacheSeconds(<span class="number">3600</span>);</span><br><span class="line">        <span class="comment">//缓存3600 × 1000毫秒，相当于1小时，然后重新刷新</span></span><br><span class="line">        messageSource.setCacheMillis(<span class="number">3600</span> * <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> messageSource;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="CookieLocaleResolver和SessionLocaleResolver"><a href="#CookieLocaleResolver和SessionLocaleResolver" class="headerlink" title="CookieLocaleResolver和SessionLocaleResolver"></a>CookieLocaleResolver和SessionLocaleResolver</h3><p>只是对于 Cookie 用户可以进行删除甚至禁用，使得其安全性难以得到保证，导致大量的使用默认值，也许这些并不是用户所期待的。为了避免这个问题，一般用得更多的是 SessionLocaleResolver ，它是基于 Session 实现的，具有更高的可靠性。<br>注意，”localeResolver”也是一个约定的名称。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"localeResolver"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> LocaleResolver <span class="title">initCookieLocaleResolver</span><span class="params">()</span></span>{</span><br><span class="line">    CookieLocaleResolver resolver = <span class="keyword">new</span> CookieLocaleResolver();</span><br><span class="line">    <span class="comment">//cookie名称</span></span><br><span class="line">    resolver.setCookieName(<span class="string">"lang"</span>);</span><br><span class="line">    <span class="comment">//cookie超时秒数</span></span><br><span class="line">    resolver.setCookieMaxAge(<span class="number">1800</span>);</span><br><span class="line">    <span class="comment">//默认使用简体中文</span></span><br><span class="line">    resolver.setDefaultLocale(Locale.SIMPLIFIED_CHINESE);</span><br><span class="line">    <span class="keyword">return</span> resolver;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"localeResolver"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> LocaleResolver <span class="title">initCookieLocaleResolver</span><span class="params">()</span></span>{</span><br><span class="line">    SessionLocaleResolver resolver = <span class="keyword">new</span> SessionLocaleResolver();</span><br><span class="line">    <span class="comment">//默认使用简体中文</span></span><br><span class="line">    resolver.setDefaultLocale(Locale.SIMPLIFIED_CHINESE);</span><br><span class="line">    <span class="keyword">return</span> resolver;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>当然以上都可以用xml进行配置，自己查。</p>
<h3 id="国际化拦截器（LocaleChangeInterceptor）"><a href="#国际化拦截器（LocaleChangeInterceptor）" class="headerlink" title="国际化拦截器（LocaleChangeInterceptor）"></a>国际化拦截器（LocaleChangeInterceptor）</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.MessageSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ReloadableResourceBundleMessageSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ResourceBundleMessageSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.LocaleResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.i18n.CookieLocaleResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.i18n.LocaleChangeInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.i18n.SessionLocaleResolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InternationalConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>{</span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"messageSource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageSource <span class="title">initMessageSource</span><span class="params">()</span></span>{</span><br><span class="line">        ResourceBundleMessageSource messageSource = <span class="keyword">new</span> ResourceBundleMessageSource();</span><br><span class="line">        messageSource.setDefaultEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        messageSource.setBasename(<span class="string">"msg"</span>);</span><br><span class="line">        <span class="keyword">return</span> messageSource;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Bean(name = "messageSource")</span></span><br><span class="line"><span class="comment">//    public MessageSource initMessageSource(){</span></span><br><span class="line"><span class="comment">//        ReloadableResourceBundleMessageSource messageSource = new ReloadableResourceBundleMessageSource();</span></span><br><span class="line"><span class="comment">//        messageSource.setDefaultEncoding("UTF-8");</span></span><br><span class="line"><span class="comment">//        messageSource.setBasename("classpath:msg");</span></span><br><span class="line"><span class="comment">//        //缓存3600秒，相当于1小时，然后重新刷新</span></span><br><span class="line"><span class="comment">//        messageSource.setCacheSeconds(3600);</span></span><br><span class="line"><span class="comment">//        //缓存3600 × 1000毫秒，相当于1小时，然后重新刷新</span></span><br><span class="line"><span class="comment">//        messageSource.setCacheMillis(3600 * 1000);</span></span><br><span class="line"><span class="comment">//        return messageSource;</span></span><br><span class="line"><span class="comment">//    }</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"localeResolver"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocaleResolver <span class="title">initCookieLocaleResolver</span><span class="params">()</span></span>{</span><br><span class="line">        CookieLocaleResolver resolver = <span class="keyword">new</span> CookieLocaleResolver();</span><br><span class="line">        <span class="comment">//cookie名称</span></span><br><span class="line">        resolver.setCookieName(<span class="string">"lang"</span>);</span><br><span class="line">        <span class="comment">//cookie超时秒数</span></span><br><span class="line">        resolver.setCookieMaxAge(<span class="number">1800</span>);</span><br><span class="line">        <span class="comment">//默认使用简体中文</span></span><br><span class="line">        resolver.setDefaultLocale(Locale.US);</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Bean(name = "localeResolver")</span></span><br><span class="line"><span class="comment">//    public LocaleResolver initCookieLocaleResolver(){</span></span><br><span class="line"><span class="comment">//        SessionLocaleResolver resolver = new SessionLocaleResolver();</span></span><br><span class="line"><span class="comment">//        //默认使用简体中文</span></span><br><span class="line"><span class="comment">//        resolver.setDefaultLocale(Locale.SIMPLIFIED_CHINESE);</span></span><br><span class="line"><span class="comment">//        return resolver;</span></span><br><span class="line"><span class="comment">//    }</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>{</span><br><span class="line">        LocaleChangeInterceptor interceptor = <span class="keyword">new</span> LocaleChangeInterceptor();</span><br><span class="line">        interceptor.setParamName(<span class="string">"language"</span>);</span><br><span class="line">        registry.addInterceptor(interceptor).addPathPatterns(<span class="string">"/**"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageController</span> </span>{</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/msgpage"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">page</span><span class="params">(Model model)</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"locale"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"spring"</span> <span class="attr">uri</span>=<span class="string">"http://www.springframework.org/tags"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%--</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Created</span> <span class="attr">by</span> <span class="attr">IntelliJ</span> <span class="attr">IDEA.</span></span></span><br><span class="line"><span class="tag">  <span class="attr">User:</span> <span class="attr">louris</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Date:</span> <span class="attr">2021</span>/<span class="attr">9</span>/<span class="attr">30</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Time:</span> <span class="attr">10:41</span></span></span><br><span class="line"><span class="tag">  <span class="attr">To</span> <span class="attr">change</span> <span class="attr">this</span> <span class="attr">template</span> <span class="attr">use</span> <span class="attr">File</span> | <span class="attr">Settings</span> | <span class="attr">File</span> <span class="attr">Templates.</span></span></span><br><span class="line"><span class="tag"><span class="attr">--</span>%&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html;charset=UTF-8"</span> <span class="attr">language</span>=<span class="string">"java"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%--</span>  找到属性文件变量名为<span class="attr">welcome</span>的配置  <span class="attr">--</span>%&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring:message</span> <span class="attr">code</span>=<span class="string">"welcome"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">Locale: ${pageContext.response.locale}</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>两个配置文件：<br>msg_en_US.propertires</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">welcome=the project name is springboot</span><br></pre></td></tr></tbody></table></figure>

<p>msg_en_CN.properties</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">welcome=项目名为SpringBoot</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="Redis应用"><a href="#Redis应用" class="headerlink" title="Redis应用"></a>Redis应用</h1></blockquote>
<blockquote>
<h1 id="Redis概述"><a href="#Redis概述" class="headerlink" title="Redis概述"></a>Redis概述</h1></blockquote>
<ul>
<li>缓存常用的数据</li>
<li>需要高速读/写的场合使用它快速读/写</li>
</ul>
<h2 id="Redis基本安装和使用"><a href="#Redis基本安装和使用" class="headerlink" title="Redis基本安装和使用"></a>Redis基本安装和使用</h2><h3 id="Windows下安装Redis"><a href="#Windows下安装Redis" class="headerlink" title="Windows下安装Redis"></a>Windows下安装Redis</h3><p><code>https://github.com/microsoftarchive/redis/releases</code>下载Redis解压后<br>新建文件startup.cmd</p>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server redis.windows.conf</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Linux下安装Redis"><a href="#Linux下安装Redis" class="headerlink" title="Linux下安装Redis"></a>Linux下安装Redis</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-6.2.6.tar.gz</span><br><span class="line">tar -zvxf redis-6.2.6.tar.gz</span><br><span class="line">cd redis-6.2.6</span><br><span class="line">make</span><br></pre></td></tr></tbody></table></figure>
<p>启动</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./src/redis-server</span><br></pre></td></tr></tbody></table></figure>
<p>另一个客户端启动命令行窗口</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./src/redis-cli</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Redis的Java-API"><a href="#Redis的Java-API" class="headerlink" title="Redis的Java API"></a>Redis的Java API</h2><h3 id="在Java程序中使用Redis"><a href="#在Java程序中使用Redis" class="headerlink" title="在Java程序中使用Redis"></a>在Java程序中使用Redis</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        Jedis jedis = connectionPool(); <span class="comment">//simpleConnection();</span></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>; <span class="comment">//记录操作次数</span></span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>){</span><br><span class="line">                <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">if</span>(end - start &gt;= <span class="number">1000</span>) <span class="keyword">break</span>;</span><br><span class="line">                i ++;</span><br><span class="line">                jedis.set(<span class="string">"test"</span> + i, i + <span class="string">""</span>);</span><br><span class="line">            }</span><br><span class="line">        }<span class="keyword">finally</span> { <span class="comment">//关闭连接</span></span><br><span class="line">            jedis.close();</span><br><span class="line">        }</span><br><span class="line">        System.out.println(<span class="string">"redis 每秒操作："</span> + i + <span class="string">"次"</span>); <span class="comment">//打印1秒内对Redis的操作次数</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Jedis <span class="title">simpleConnection</span><span class="params">()</span></span>{</span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">"localhost"</span>, <span class="number">6379</span>); <span class="comment">//连接redis</span></span><br><span class="line">        <span class="comment">//jedis.auth("passsword"); //如果需要密码</span></span><br><span class="line">        <span class="keyword">return</span> jedis;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Jedis <span class="title">connectionPool</span><span class="params">()</span></span>{</span><br><span class="line">        JedisPoolConfig poolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        <span class="comment">//最大空闲数</span></span><br><span class="line">        poolConfig.setMaxIdle(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">//最大连接数</span></span><br><span class="line">        poolConfig.setMaxTotal(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">//最大等待毫秒数</span></span><br><span class="line">        poolConfig.setMaxWaitMillis(<span class="number">20000</span>);</span><br><span class="line">        <span class="comment">//使用配置创建连接池</span></span><br><span class="line">        JedisPool pool = <span class="keyword">new</span> JedisPool(poolConfig, <span class="string">"localhost"</span>);</span><br><span class="line">        <span class="comment">//从连接池中获取单个连接</span></span><br><span class="line">        Jedis jedis = pool.getResource();</span><br><span class="line">        <span class="comment">//如果需要密码</span></span><br><span class="line">        <span class="comment">//jedis.auth("password");</span></span><br><span class="line">        <span class="keyword">return</span> jedis;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>运行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class "org.slf4j.impl.StaticLoggerBinder".</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line">redis 每秒操作：<span class="number">10283</span>次</span><br></pre></td></tr></tbody></table></figure>

<p>事实上，Redis的速度比这个操作速度快得多，这里慢是因为我们只是一条条地将命令发送给Redis去执行。如果使用流水线技术它会快得多，将可以达到10万次每秒的操作，十分有利于系统性能的提高。</p>
<h3 id="在Spring中使用Redis"><a href="#在Spring中使用Redis" class="headerlink" title="在Spring中使用Redis"></a>在Spring中使用Redis</h3><h4 id="添加依赖以及配置"><a href="#添加依赖以及配置" class="headerlink" title="添加依赖以及配置"></a>添加依赖以及配置</h4><p>添加依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--  SpringBoot集成Redis的起步依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="Spring-Data-Redis的4种工厂模型"><a href="#Spring-Data-Redis的4种工厂模型" class="headerlink" title="Spring Data Redis的4种工厂模型"></a>Spring Data Redis的4种工厂模型</h4><ul>
<li>JredisConnectionFactory</li>
<li>JedisConnectionFactory</li>
<li>LettuceConnectionFactory</li>
<li>SrpConnectionFactory</li>
</ul>
<h4 id="RedisSerializer对象序列化接口"><a href="#RedisSerializer对象序列化接口" class="headerlink" title="RedisSerializer对象序列化接口"></a>RedisSerializer对象序列化接口</h4><p>有了RedisConnectionFactory工厂，就可以使用RedisTemplate了。<br>普通的连接使用没有办法把Java对象直接存入Redis，而需要我们自己提供方案，这时往往需要将对象序列化，然后使用Redis进行存储，<br>而取回序列化的内容后，在通过转换变为java对象，Spring模板中提供了封装的方案，在它内部提供了RedisSerializer接口和一些实现类。</p>
<ul>
<li>GenericJackson2JsonRedisSerializer，通用的使用Json2.jar包，将Redis对象的序列化器；</li>
<li>Jackson2JsonRedisSerializer<t>，通过Jackson2.jar包提供的序列化进行转换；</t></li>
<li>JdkSerializationRedisSerializer<t>，使用JDK的序列化器进行转化；</t></li>
<li>OxmSerializer，使用Spring O/X对象Object和XML相互转换；</li>
<li>StringRedisSerializer，使用字符串进行序列化；</li>
<li>GenericToStringSerializer，通过通用的字符串序列化进行相互转换；</li>
</ul>
<p>为此，Spring提供的RedisTemplate还有两个属性：</p>
<ul>
<li>keySerializer：键序列化器；</li>
<li>valueSerializer：值序列化器；</li>
</ul>
<h5 id="properties配置方式"><a href="#properties配置方式" class="headerlink" title="properties配置方式"></a>properties配置方式</h5><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置redis</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库池设置</span></span><br><span class="line"><span class="comment"># 最大空闲数</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-idle</span>=<span class="string">50</span></span><br><span class="line"><span class="comment"># 最大连接数</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-active</span>=<span class="string">8</span></span><br><span class="line"><span class="comment"># 连接池最大阻塞等待时间</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-wait</span>=<span class="string">100</span></span><br></pre></td></tr></tbody></table></figure>

<h5 id="xml配置方式"><a href="#xml配置方式" class="headerlink" title="xml配置方式"></a>xml配置方式</h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"poolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--最大空闲数--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"50"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--最大连接数--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--最大等待时间--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWaitMillis"</span> <span class="attr">value</span>=<span class="string">"20000"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.jedis.JedisConnectionFactory"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hostName"</span> <span class="attr">value</span>=<span class="string">"localhost"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"6379"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;property name="password" value="123456"/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolConfig"</span> <span class="attr">ref</span>=<span class="string">"poolConfig"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jdkSerializationRedisSerializer"</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.serializer.JdkSerializationRedisSerializer"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"stringRedisSerializer"</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.serializer.StringRedisSerializer"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redisTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.core.RedisTemplate"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"connectionFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"keySerializer"</span> <span class="attr">ref</span>=<span class="string">"stringRedisSerializer"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"valueSerializer"</span> <span class="attr">ref</span>=<span class="string">"jdkSerializationRedisSerializer"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="配置类注解方式"><a href="#配置类注解方式" class="headerlink" title="配置类注解方式"></a>配置类注解方式</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.PoolConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.jedis.JedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.JdkSerializationRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>{</span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"poolConfig"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisPoolConfig <span class="title">getPoolConfig</span><span class="params">()</span></span>{</span><br><span class="line">        JedisPoolConfig poolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        <span class="comment">//最大空闲数</span></span><br><span class="line">        poolConfig.setMaxIdle(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">//最大连接数</span></span><br><span class="line">        poolConfig.setMaxTotal(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">//最大等待时间</span></span><br><span class="line">        poolConfig.setMaxWaitMillis(<span class="number">20000</span>);</span><br><span class="line">        <span class="keyword">return</span> poolConfig;</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"connectionFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">getJedisConnectionFactory</span><span class="params">()</span></span>{</span><br><span class="line">        JedisConnectionFactory factory = <span class="keyword">new</span> JedisConnectionFactory();</span><br><span class="line">        factory.setHostName(<span class="string">"localhost"</span>);</span><br><span class="line">        factory.setPort(<span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//factory.setPassword("123456");</span></span><br><span class="line">        factory.setPoolConfig(getPoolConfig());</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"jdkSerializationRedisSerializer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdkSerializationRedisSerializer <span class="title">getJdkRedisSerializer</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdkSerializationRedisSerializer();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"stringRedisSerializer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> StringRedisSerializer <span class="title">getStringRedisSerializer</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">getRedisTemplate</span><span class="params">()</span></span>{</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(getJedisConnectionFactory());</span><br><span class="line">        redisTemplate.setKeySerializer(getStringRedisSerializer());</span><br><span class="line">        redisTemplate.setValueSerializer(getJdkRedisSerializer());</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="对象序列化"><a href="#对象序列化" class="headerlink" title="对象序列化"></a>对象序列化</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.demo.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVerionsUID = <span class="number">6977402643848374753L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoleName</span><span class="params">(String roleName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoleName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleName;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//ApplicationContext applicationContext1 = new ClassPathXmlApplicationContext("spring-redis-config.xml");</span></span><br><span class="line">Role role = <span class="keyword">new</span> Role();</span><br><span class="line">role.setId(<span class="number">1L</span>);</span><br><span class="line">role.setRoleName(<span class="string">"role_name_1"</span>);</span><br><span class="line">role.setNote(<span class="string">"note_1"</span>);</span><br><span class="line">RedisTemplate&lt;String, Object&gt; redisTemplate = (RedisTemplate&lt;String, Object&gt;) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line">redisTemplate.opsForValue().set(<span class="string">"role_1"</span>, role);</span><br><span class="line">Role role1 = (Role)redisTemplate.opsForValue().get(<span class="string">"role_1"</span>);</span><br><span class="line">System.out.println(role1.getRoleName());</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">09</span>:<span class="number">56</span>:<span class="number">36.673</span> [main] DEBUG org.springframework.data.redis.core.RedisConnectionUtils - Fetching Redis Connection from RedisConnectionFactory</span><br><span class="line"><span class="number">09</span>:<span class="number">56</span>:<span class="number">36.703</span> [main] DEBUG org.springframework.data.redis.core.RedisConnectionUtils - Closing Redis Connection.</span><br><span class="line"><span class="number">09</span>:<span class="number">56</span>:<span class="number">36.704</span> [main] DEBUG org.springframework.data.redis.core.RedisConnectionUtils - Fetching Redis Connection from RedisConnectionFactory</span><br><span class="line"><span class="number">09</span>:<span class="number">56</span>:<span class="number">36.708</span> [main] DEBUG org.springframework.data.redis.core.RedisConnectionUtils - Closing Redis Connection.</span><br><span class="line">role_name_1</span><br></pre></td></tr></tbody></table></figure>

<h4 id="同一个Redis连接"><a href="#同一个Redis连接" class="headerlink" title="同一个Redis连接"></a>同一个Redis连接</h4><ul>
<li>注意，以上的使用都是基于RedisTemplate、基于连接池的操作，换句话说，并不能保证每次使用RedisTemplate是操作同一个对Redis的连接。</li>
<li>set和get方法可拿起来很简单，它可能就来自于一个Redis连接池的不同Redis的连接。</li>
<li>为了使得所有的操作都来自于同一个连接，可以使用SessionCallback或者RedisCallback这两个接口，而RedisCallBack是比较底层的封装，其使用不是很友好，所以更多的时候会使用SessionCallback这个接口。</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ApplicationContext applicationContext = new AnnotationConfigApplicationContext(RedisConfig.class);</span></span><br><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring-redis-config.xml"</span>);</span><br><span class="line">Role role = <span class="keyword">new</span> Role();</span><br><span class="line">role.setId(<span class="number">1L</span>);</span><br><span class="line">role.setRoleName(<span class="string">"role_name_1"</span>);</span><br><span class="line">role.setNote(<span class="string">"note_1"</span>);</span><br><span class="line">RedisTemplate&lt;String, Object&gt; redisTemplate = (RedisTemplate&lt;String, Object&gt;) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line"></span><br><span class="line">SessionCallback&lt;Role&gt; callback = <span class="keyword">new</span> SessionCallback&lt;Role&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">        operations.boundValueOps(<span class="string">"role_1"</span>).set(role);</span><br><span class="line">        <span class="keyword">return</span> (Role) operations.boundValueOps(<span class="string">"role_1"</span>).get();</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line">Role savedRole = (Role) redisTemplate.execute(callback);</span><br><span class="line">System.out.println(savedRole.getRoleName());</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Redis的6种数据类型"><a href="#Redis的6种数据类型" class="headerlink" title="Redis的6种数据类型"></a>Redis的6种数据类型</h2><table>
<thead>
<tr>
<th align="center">数据类型</th>
<th align="center">数据类型存储的值</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">STRING(字符串)</td>
<td align="center">可以是保存字符串、整数和浮点数</td>
<td align="left">可以对字符串进行操作，比如增加字符或者求子串；如果是整数或者浮点数，可以实现计算，比如自增等</td>
</tr>
<tr>
<td align="center">LIST(列表)</td>
<td align="center">它是一个链表，它的每一个节点都包含一个字符串</td>
<td align="left">Redis支持从链表的两端插入或者弹出节点，或者通过偏移对它进行剪裁；还可以读取一个或者多个节点，根据条件删除或者查找节点等</td>
</tr>
<tr>
<td align="center">SET(集合)</td>
<td align="center">它是一个收集器，但是是无序的，在它里面每一个元素都是一个字符串，而且是独一无二，各不相同的</td>
<td align="left">可以新增、读取、删除单个元素；检测一个元素是否在集合中；计算它和其他集合的交集、并集和差集等；随机从集合中读取元素</td>
</tr>
<tr>
<td align="center">HASH(哈希散列表)</td>
<td align="center">它类似于Java语言中的Map，是一个键值对应的无序列表</td>
<td align="left">可以增、删、查、改单个键值时，也可以获取所有的键值对</td>
</tr>
<tr>
<td align="center">ZSET(有序集合)</td>
<td align="center">它是一个有序的集合，可以包含字符串、整数、浮点数、分值（score），元素的排序是依据分值的大小来决定的</td>
<td align="left">可以增、删、查、改元素，根据分值的范围或者成员来获取对应的元素</td>
</tr>
<tr>
<td align="center">HyperLogLog(基数)</td>
<td align="center">它的作用是计算重复的值，以确定存储的数量</td>
<td align="left">只提供基数的运算，不提供返回的功能。</td>
</tr>
</tbody></table>
<h2 id="Redis和数据库的异同"><a href="#Redis和数据库的异同" class="headerlink" title="Redis和数据库的异同"></a>Redis和数据库的异同</h2><ul>
<li>NoSQL的数据主要存储在内存中（部分可以持久化到磁盘），而数据库主要是磁盘；</li>
<li>NoSQL数据结构比较简单，虽然能处理很多的问题，但是其功能毕竟是有限的，不如数据库的SQL语句强大，支持更为复杂的计算；</li>
<li>NoSQL并不完全安全稳定，由于它基于内存，一旦停电或者机器故障数据就很容易丢失数据，其持久化能力也是有限的，而基于磁盘的数据库则不会出现这样的问题；</li>
<li>NoSQL的数据完整性、事务能力、安全性、可靠性及可扩展性都不及数据库</li>
</ul>
<blockquote>
<h1 id="Redis数据结构常用命令"><a href="#Redis数据结构常用命令" class="headerlink" title="Redis数据结构常用命令"></a>Redis数据结构常用命令</h1></blockquote>
<h2 id="Redis数据结构——字符串"><a href="#Redis数据结构——字符串" class="headerlink" title="Redis数据结构——字符串"></a>Redis数据结构——字符串</h2><h3 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h3><table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">说明</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">set key value</td>
<td align="center">设置键值对</td>
<td align="left">最常用的写入命令</td>
</tr>
<tr>
<td align="center">get key</td>
<td align="center">通过键获取值</td>
<td align="left">最常用的读取命令</td>
</tr>
<tr>
<td align="center">del key</td>
<td align="center">通过key，删除键值对</td>
<td align="left">删除命令，返回删除数，注意，它是一个通用的命令，换句话说在其他数据结构中，也可以使用它</td>
</tr>
<tr>
<td align="center">strlen key</td>
<td align="center">求key指向字符串的长度</td>
<td align="left">返回长度</td>
</tr>
<tr>
<td align="center">getset key value</td>
<td align="center">修改原来key的对应值，并将旧值返回</td>
<td align="left">如果原来值为空，则返回为空，并设置新值</td>
</tr>
<tr>
<td align="center">getrange key start end</td>
<td align="center">获取子串</td>
<td align="left">记字符串的长度为len，把字符串看作一个数组，而Redis是以0开始计数的，所以start和end的取值范围为0到len-1</td>
</tr>
<tr>
<td align="center">append key value</td>
<td align="center">将新的字符串value，加入到原来的key指向的字符串末</td>
<td align="left">返回key指向新字符串的长度</td>
</tr>
</tbody></table>
<h4 id="本地操作测试"><a href="#本地操作测试" class="headerlink" title="本地操作测试"></a>本地操作测试</h4><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\<span class="title">download</span>\<span class="title">Redis</span>-<span class="title">x64</span>-3.2.100&gt;<span class="title">redis</span>-<span class="title">cli.exe</span> -<span class="title">h</span> 127.0.0.1 -<span class="title">p</span> 6379</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">set</span> <span class="title">key1</span> <span class="title">value1</span></span></span><br><span class="line"><span class="function"><span class="title">OK</span></span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">set</span> <span class="title">key2</span> <span class="title">value2</span></span></span><br><span class="line"><span class="function"><span class="title">OK</span></span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">get</span> <span class="title">key1</span></span></span><br><span class="line"><span class="function">"<span class="title">value1</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">del</span> <span class="title">key1</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 1</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">strlen</span> <span class="title">key2</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 6</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">getset</span> <span class="title">key2</span> <span class="title">new_value2</span></span></span><br><span class="line"><span class="function">"<span class="title">value2</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">get</span> <span class="title">key2</span></span></span><br><span class="line"><span class="function">"<span class="title">new_value2</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">getrange</span> <span class="title">key2</span> 0 3</span></span><br><span class="line"><span class="function">"<span class="title">new_</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">append</span> <span class="title">key2</span> <span class="title">_app</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 14</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">get</span> <span class="title">key2</span></span></span><br><span class="line"><span class="function">"<span class="title">new_value2_app</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="Spring操作测试"><a href="#Spring操作测试" class="headerlink" title="Spring操作测试"></a>Spring操作测试</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">getRedisTemplate</span><span class="params">()</span></span>{</span><br><span class="line">    RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">    redisTemplate.setConnectionFactory(getJedisConnectionFactory());</span><br><span class="line">    redisTemplate.setKeySerializer(getStringRedisSerializer());</span><br><span class="line">    redisTemplate.setValueSerializer(getStringRedisSerializer());</span><br><span class="line">    <span class="keyword">return</span> redisTemplate;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//ApplicationContext applicationContext = new ClassPathXmlApplicationContext("spring-redis-config.xml");</span></span><br><span class="line">RedisTemplate&lt;String, String&gt; redisTemplate = (RedisTemplate&lt;String, String&gt;) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line"><span class="comment">//设置值</span></span><br><span class="line">redisTemplate.opsForValue().set(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br><span class="line">redisTemplate.opsForValue().set(<span class="string">"key2"</span>, <span class="string">"value2"</span>);</span><br><span class="line"><span class="comment">//通过key获取值</span></span><br><span class="line">String value1 = redisTemplate.opsForValue().get(<span class="string">"key1"</span>);</span><br><span class="line">System.out.println(value1);</span><br><span class="line"><span class="comment">//通过key删除值</span></span><br><span class="line">redisTemplate.delete(<span class="string">"key1"</span>);</span><br><span class="line"><span class="comment">//求长度</span></span><br><span class="line">Long length = redisTemplate.opsForValue().size(<span class="string">"key2"</span>);</span><br><span class="line">System.out.println(length);</span><br><span class="line"><span class="comment">//设置新值并返回旧值</span></span><br><span class="line">String oldValue2 = redisTemplate.opsForValue().getAndSet(<span class="string">"key2"</span>, <span class="string">"new_value2"</span>);</span><br><span class="line">System.out.println(oldValue2);</span><br><span class="line"><span class="comment">//通过key获取值</span></span><br><span class="line">String value2 = redisTemplate.opsForValue().get(<span class="string">"key2"</span>);</span><br><span class="line">System.out.println(value2);</span><br><span class="line"><span class="comment">//求子串</span></span><br><span class="line">String rangeValue2 = redisTemplate.opsForValue().get(<span class="string">"key2"</span>, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">System.out.println(rangeValue2);</span><br><span class="line"><span class="comment">//追加字符串到末尾，返回新串长度</span></span><br><span class="line"><span class="keyword">int</span> newLen = redisTemplate.opsForValue().append(<span class="string">"key2"</span>, <span class="string">"_app"</span>);</span><br><span class="line">System.out.println(newLen);</span><br><span class="line"></span><br><span class="line">String appendValue2 = redisTemplate.opsForValue().get(<span class="string">"key2"</span>);</span><br><span class="line">System.out.println(appendValue2);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">value1</span><br><span class="line"><span class="number">6</span></span><br><span class="line">value2</span><br><span class="line">new_value2</span><br><span class="line">new_</span><br><span class="line"><span class="number">14</span></span><br><span class="line">new_value2_app</span><br></pre></td></tr></tbody></table></figure>

<h3 id="简单运算"><a href="#简单运算" class="headerlink" title="简单运算"></a>简单运算</h3><p>如果字符串是数字（整数或者浮点数），那么Redis还能支持简单的运算</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">说明</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">incr key</td>
<td align="center">在原字段上加1</td>
<td align="left">只能对整数操作</td>
</tr>
<tr>
<td align="center">incrby key increment</td>
<td align="center">在原字段上加上整数（increment）</td>
<td align="left">只能对整数操作</td>
</tr>
<tr>
<td align="center">decr key</td>
<td align="center">在原字段上减1</td>
<td align="left">只能对整数操作</td>
</tr>
<tr>
<td align="center">decrby key decrement</td>
<td align="center">在原字段上减去整数（decrement）</td>
<td align="left">只能对整数操作</td>
</tr>
<tr>
<td align="center">incrbyfloat key increment</td>
<td align="center">在原字段上加上浮点数（increment）</td>
<td align="left">可以操作浮点数或者整数</td>
</tr>
</tbody></table>
<h4 id="本地测试"><a href="#本地测试" class="headerlink" title="本地测试"></a>本地测试</h4><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> val <span class="number">8</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; incr val</span><br><span class="line">(integer) <span class="number">9</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; decr val</span><br><span class="line">(integer) <span class="number">8</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; decrby val <span class="number">2</span></span><br><span class="line">(integer) <span class="number">6</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; incrby float val <span class="number">2</span>.<span class="number">3</span></span><br><span class="line">(error) ERR wrong number of arguments <span class="keyword">for</span> 'incrby' command</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; incrbyfloat val <span class="number">2</span>.<span class="number">3</span></span><br><span class="line">"<span class="number">8</span>.<span class="number">300000000000001</span>"</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Spring测试"><a href="#Spring测试" class="headerlink" title="Spring测试"></a>Spring测试</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//ApplicationContext applicationContext = new ClassPathXmlApplicationContext("spring-redis-config.xml");</span></span><br><span class="line">RedisTemplate&lt;String, String&gt; redisTemplate = (RedisTemplate&lt;String, String&gt;) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line"></span><br><span class="line">String value1 = redisTemplate.execute(<span class="keyword">new</span> SessionCallback&lt;String&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">        operations.boundValueOps(<span class="string">"i"</span>).set(<span class="string">"9"</span>);</span><br><span class="line">        <span class="keyword">return</span> (String) operations.boundValueOps(<span class="string">"i"</span>).get();</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line">System.out.println(value1);</span><br><span class="line"></span><br><span class="line">String value2 = redisTemplate.execute(<span class="keyword">new</span> SessionCallback&lt;String&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">        operations.boundValueOps(<span class="string">"i"</span>).increment(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> (String) operations.boundValueOps(<span class="string">"i"</span>).get();</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line">System.out.println(value2);</span><br><span class="line"></span><br><span class="line">String value3 = redisTemplate.execute(<span class="keyword">new</span> SessionCallback&lt;String&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  String <span class="title">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">        operations.boundValueOps(<span class="string">"i"</span>).decrement();</span><br><span class="line">        <span class="keyword">return</span> (String) operations.boundValueOps(<span class="string">"i"</span>).get();</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line">System.out.println(value3);</span><br><span class="line"></span><br><span class="line">String value4 = redisTemplate.execute(<span class="keyword">new</span> SessionCallback&lt;String&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  String <span class="title">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">        operations.boundValueOps(<span class="string">"i"</span>).decrement(<span class="number">6</span>);</span><br><span class="line">        <span class="keyword">return</span> (String) operations.boundValueOps(<span class="string">"i"</span>).get();</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line">System.out.println(value4);</span><br><span class="line"></span><br><span class="line">String value5 = redisTemplate.execute(<span class="keyword">new</span> SessionCallback&lt;String&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  String <span class="title">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">        operations.boundValueOps(<span class="string">"i"</span>).increment(<span class="number">2.3</span>);</span><br><span class="line">        <span class="keyword">return</span> (String) operations.boundValueOps(<span class="string">"i"</span>).get();</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line">System.out.println(value5);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//ApplicationContext applicationContext = new ClassPathXmlApplicationContext("spring-redis-config.xml");</span></span><br><span class="line">RedisTemplate&lt;String, String&gt; redisTemplate = (RedisTemplate&lt;String, String&gt;) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line"></span><br><span class="line">redisTemplate.opsForValue().set(<span class="string">"i"</span>, <span class="string">"9"</span>);</span><br><span class="line">System.out.println(redisTemplate.opsForValue().get(<span class="string">"i"</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(redisTemplate.opsForValue().increment(<span class="string">"i"</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(redisTemplate.opsForValue().decrement(<span class="string">"i"</span>, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(redisTemplate.opsForValue().decrement(<span class="string">"i"</span>, <span class="number">6</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(redisTemplate.opsForValue().increment(<span class="string">"i"</span>, <span class="number">2.3</span>));</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">5.3</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="Redis数据结构——哈希"><a href="#Redis数据结构——哈希" class="headerlink" title="Redis数据结构——哈希"></a>Redis数据结构——哈希</h2><table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">说明</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">hdel key field1 [field2……]</td>
<td align="left">删除hash结构中的某个（些）字段</td>
<td align="left">可以进行多个字段的删除</td>
</tr>
<tr>
<td align="left">hexists key field</td>
<td align="left">判断hash结构中是否存在field字段</td>
<td align="left">存在返回1，否则返回0</td>
</tr>
<tr>
<td align="left">hgetall key</td>
<td align="left">获取所有hash结构中的键值</td>
<td align="left">返回键和值</td>
</tr>
<tr>
<td align="left">hincrby key field increment</td>
<td align="left">指定给hash结构中的某一字段加上一个整数</td>
<td align="left">要求该字段也是整数字符串</td>
</tr>
<tr>
<td align="left">hincrbyfloat key field increment</td>
<td align="left">指定给hash结构中的某一字段加上一个浮点数</td>
<td align="left">要求该字段是数字型字符串</td>
</tr>
<tr>
<td align="left">hkeys key</td>
<td align="left">返回hash中所有的键</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">hlen key</td>
<td align="left">返回hash中键值对的数量</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">hmget key field1 [field2……]</td>
<td align="left">返回hash中指定的键的值，可以是多个</td>
<td align="left">依次返回值</td>
</tr>
<tr>
<td align="left">hmget key filed1 value1 [field2 value2]</td>
<td align="left">hash结构设置多个键值对</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">hset key field value</td>
<td align="left">在hash结构中设置键值对</td>
<td align="left">单个设值</td>
</tr>
<tr>
<td align="left">hsetnx key field value</td>
<td align="left">当hash结构中不存在对应的键，才设置值</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">hvals key</td>
<td align="left">获取hash结构中所有的值</td>
<td align="left"></td>
</tr>
</tbody></table>
<ul>
<li>哈希结构的大小，如果哈希结构是个很大的键值对，那么使用它要十分注意，尤其是关于hkeys、hgetall、hvals等返回所有哈希结构数据的命令，会造成大量数据的读取。这需要考虑性能和读取数据大小对JVM内存的影响。</li>
<li>对于数字的操作命令hincrby而言，要求存储的也是整数型的字符串；对于hincrbyfloat而言，则要求使用浮点数或者整数，否则命令会失败。</li>
</ul>
<h3 id="本地测试-1"><a href="#本地测试-1" class="headerlink" title="本地测试"></a>本地测试</h3><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hmset role_1 id <span class="number">001</span> roleName role_name_001 note note_001</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hgetall role_1</span><br><span class="line"><span class="number">1</span>) "id"</span><br><span class="line"><span class="number">2</span>) "<span class="number">001</span>"</span><br><span class="line"><span class="number">3</span>) "roleName"</span><br><span class="line"><span class="number">4</span>) "role_name_001"</span><br><span class="line"><span class="number">5</span>) "note"</span><br><span class="line"><span class="number">6</span>) "note_001"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hgetall key</span><br><span class="line">(empty list or <span class="built_in">set</span>)</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hkeys key</span><br><span class="line">(empty list or <span class="built_in">set</span>)</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hkeys role_1</span><br><span class="line"><span class="number">1</span>) "id"</span><br><span class="line"><span class="number">2</span>) "roleName"</span><br><span class="line"><span class="number">3</span>) "note"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hmset hash f1 val1 f2 val2</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hset hash f3 <span class="number">6</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hexists hash f2</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hgetall hash</span><br><span class="line"><span class="number">1</span>) "f1"</span><br><span class="line"><span class="number">2</span>) "val1"</span><br><span class="line"><span class="number">3</span>) "f2"</span><br><span class="line"><span class="number">4</span>) "val2"</span><br><span class="line"><span class="number">5</span>) "f3"</span><br><span class="line"><span class="number">6</span>) "<span class="number">6</span>"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hkeys hash</span><br><span class="line"><span class="number">1</span>) "f1"</span><br><span class="line"><span class="number">2</span>) "f2"</span><br><span class="line"><span class="number">3</span>) "f3"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hincrby hash f3 <span class="number">2</span></span><br><span class="line">(integer) <span class="number">8</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hincrbyfloat hash f3 <span class="number">0</span>.<span class="number">88</span></span><br><span class="line">"<span class="number">8</span>.<span class="number">880000000000001</span>"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hlen hash</span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hmget hash f1 f2</span><br><span class="line"><span class="number">1</span>) "val1"</span><br><span class="line"><span class="number">2</span>) "val2"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hsetnx key f4 val4</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hvals hash</span><br><span class="line"><span class="number">1</span>) "val1"</span><br><span class="line"><span class="number">2</span>) "val2"</span><br><span class="line"><span class="number">3</span>) "<span class="number">8</span>.<span class="number">880000000000001</span>"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hsetnx hash f4 val4</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hvals hash</span><br><span class="line"><span class="number">1</span>) "val1"</span><br><span class="line"><span class="number">2</span>) "val2"</span><br><span class="line"><span class="number">3</span>) "<span class="number">8</span>.<span class="number">880000000000001</span>"</span><br><span class="line"><span class="number">4</span>) "val4"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hkeys hash</span><br><span class="line"><span class="number">1</span>) "f1"</span><br><span class="line"><span class="number">2</span>) "f2"</span><br><span class="line"><span class="number">3</span>) "f3"</span><br><span class="line"><span class="number">4</span>) "f4"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hdel hash f1</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hkeys hash</span><br><span class="line"><span class="number">1</span>) "f2"</span><br><span class="line"><span class="number">2</span>) "f3"</span><br><span class="line"><span class="number">3</span>) "f4"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Spring测试-1"><a href="#Spring测试-1" class="headerlink" title="Spring测试"></a>Spring测试</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//ApplicationContext applicationContext = new ClassPathXmlApplicationContext("spring-redis-config.xml");</span></span><br><span class="line">RedisTemplate&lt;String, String&gt; redisTemplate = (RedisTemplate&lt;String, String&gt;) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line"></span><br><span class="line">String key = <span class="string">"hash"</span>;</span><br><span class="line">Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">map.put(<span class="string">"f1"</span>, <span class="string">"val1"</span>);</span><br><span class="line">map.put(<span class="string">"f2"</span>, <span class="string">"val2"</span>);</span><br><span class="line"><span class="comment">//相当于hmset命令</span></span><br><span class="line">redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line"><span class="comment">//相当于hset命令</span></span><br><span class="line">redisTemplate.opsForHash().put(key, <span class="string">"f3"</span>, <span class="string">"6"</span>);</span><br><span class="line">printValueForHash(redisTemplate, key, <span class="string">"f3"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//相当于hexists key field命令</span></span><br><span class="line"><span class="keyword">boolean</span> exists = redisTemplate.opsForHash().hasKey(key, <span class="string">"f3"</span>);</span><br><span class="line">System.out.println(exists);</span><br><span class="line"></span><br><span class="line"><span class="comment">//相当于hgetall命令</span></span><br><span class="line">Map keyValMap = redisTemplate.opsForHash().entries(key);</span><br><span class="line"><span class="comment">//相当于hincrby命令</span></span><br><span class="line">redisTemplate.opsForHash().increment(key, <span class="string">"f3"</span>, <span class="number">2</span>);</span><br><span class="line">printValueForHash(redisTemplate, key, <span class="string">"f3"</span>);</span><br><span class="line"><span class="comment">//相当于hincrbyfloat命令</span></span><br><span class="line">redisTemplate.opsForHash().increment(key, <span class="string">"f3"</span>, <span class="number">0.88</span>);</span><br><span class="line">printValueForHash(redisTemplate, key, <span class="string">"f3"</span>);</span><br><span class="line"><span class="comment">//相当于hvals命令</span></span><br><span class="line">List valueList = redisTemplate.opsForHash().values(key);</span><br><span class="line"><span class="comment">//相当于hkeys命令</span></span><br><span class="line">Set keyList = redisTemplate.opsForHash().keys(key);</span><br><span class="line">List&lt;String&gt; fieldList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">fieldList.add(<span class="string">"f1"</span>);</span><br><span class="line">fieldList.add(<span class="string">"f2"</span>);</span><br><span class="line"><span class="comment">//相当于hmget命令</span></span><br><span class="line">List valueList2 = redisTemplate.opsForHash().multiGet(key, keyList);</span><br><span class="line"><span class="comment">//相当于hsetnx命令</span></span><br><span class="line"><span class="keyword">boolean</span> success = redisTemplate.opsForHash().putIfAbsent(key, <span class="string">"f4"</span>, <span class="string">"val4"</span>);</span><br><span class="line">System.out.println(success);</span><br><span class="line"><span class="comment">//相当于hdel命令</span></span><br><span class="line">Long result = redisTemplate.opsForHash().delete(key, <span class="string">"f1"</span>, <span class="string">"f2"</span>);</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">6</span></span><br><span class="line"><span class="keyword">true</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">8.880000000000001</span></span><br><span class="line"><span class="keyword">false</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="Redis数据结构——链表（linked-list）"><a href="#Redis数据结构——链表（linked-list）" class="headerlink" title="Redis数据结构——链表（linked-list）"></a>Redis数据结构——链表（linked-list）</h2><p>Redis的链表是双向链表，支持左右插入删除等操作。</p>
<h3 id="常规命令"><a href="#常规命令" class="headerlink" title="常规命令"></a>常规命令</h3><table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">说明</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">lpush key node1 [node2..]…</td>
<td align="left">把节点node1加入到链表最左边</td>
<td align="left">如果是node1、node2…noden这样加入，那么链表开头从左到右的顺序是noden…node2、node1</td>
</tr>
<tr>
<td align="left">rpush key nod1 [node2..]…</td>
<td align="left">把节点node1加入到链表的最右边</td>
<td align="left">如果node1、node2…noden这样加入，那么链表开头从左到右的顺序是node1、node2…noden</td>
</tr>
<tr>
<td align="left">lindex key index</td>
<td align="left">读取下标为index的节点</td>
<td align="left">返回节点字符串，从0开始算</td>
</tr>
<tr>
<td align="left">llen key</td>
<td align="left">求链表的长度</td>
<td align="left">返回链表节点数</td>
</tr>
<tr>
<td align="left">lpop key</td>
<td align="left">删除左边第一个节点，并将其返回</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">rpop key</td>
<td align="left">删除右边第一个节点，并将其返回</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">linsert key before|after pivot node</td>
<td align="left">插入一个节点node，并且可以指定在值为pivot的节点的前面（before）或者后面（after）</td>
<td align="left">如果list不存在，则报错；如果没有值为对应pivot的，也会插入失败返回-1</td>
</tr>
<tr>
<td align="left">lpushx list node</td>
<td align="left">如果存在key为list的链表，则插入节点node，并且作为从左到右的第一个节点</td>
<td align="left">如果list不存在，则失败</td>
</tr>
<tr>
<td align="left">rpushx list node</td>
<td align="left">如果存在key为list的链表，则插入节点node，并且作为从左到右的最后一个节点</td>
<td align="left">如果list不存在，则失败</td>
</tr>
<tr>
<td align="left">lrange list start end</td>
<td align="left">获取链表list从start下标到end下标的节点值</td>
<td align="left">包含start和end下标的值</td>
</tr>
<tr>
<td align="left">lrem list count value</td>
<td align="left">如果count为0，则删除所有值等于value的节点；如果count不是0，则先对count取绝对值，假设记为abs，然后从左到右删除不大于abs个等于value的节点</td>
<td align="left">注意，count为整数，如果是负数，则Redis会先求取其绝对值，然后传递到后台操作</td>
</tr>
<tr>
<td align="left">lset key index node</td>
<td align="left">设置列表下标为index的节点的值为node</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">ltrim key start stop</td>
<td align="left">修剪链表，只保留从start到stop的区间的节点，其余的都删除掉</td>
<td align="left">包含start和end的下标的节点会保留</td>
</tr>
</tbody></table>
<h4 id="本地测试-2"><a href="#本地测试-2" class="headerlink" title="本地测试"></a>本地测试</h4><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\<span class="title">download</span>\<span class="title">Redis</span>-<span class="title">x64</span>-3.2.100&gt;<span class="title">redis</span>-<span class="title">cli.exe</span> -<span class="title">h</span> 127.0.0.1 -<span class="title">p</span> 6379</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">lpush</span> <span class="title">list</span> <span class="title">node3</span> <span class="title">node2</span> <span class="title">node1</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 3</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">rpush</span> <span class="title">list</span> <span class="title">node4</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 4</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">lindex</span> <span class="title">list</span> 0</span></span><br><span class="line"><span class="function">"<span class="title">node1</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">llen</span> <span class="title">list</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 4</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">lpop</span> <span class="title">list</span></span></span><br><span class="line"><span class="function">"<span class="title">node1</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">rpop</span> <span class="title">list</span></span></span><br><span class="line"><span class="function">"<span class="title">node4</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">linsert</span> <span class="title">list</span> <span class="title">before</span> <span class="title">node2</span> <span class="title">before_node</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 3</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">linsert</span> <span class="title">list</span> <span class="title">after</span> <span class="title">node2</span> <span class="title">after_node</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 4</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">lpushx</span> <span class="title">list</span> <span class="title">head</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 5</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">rpushx</span> <span class="title">list</span> 0 10</span></span><br><span class="line"><span class="function">(<span class="title">error</span>) <span class="title">ERR</span> <span class="title">wrong</span> <span class="title">number</span> <span class="title">of</span> <span class="title">arguments</span> <span class="title">for</span> '<span class="title">rpushx</span>' <span class="title">command</span></span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">rpush</span> <span class="title">list</span> <span class="title">end</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 6</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">lrange</span> <span class="title">list</span> 0 19</span></span><br><span class="line"><span class="function">1) "<span class="title">head</span>"</span></span><br><span class="line"><span class="function">2) "<span class="title">before_node</span>"</span></span><br><span class="line"><span class="function">3) "<span class="title">node2</span>"</span></span><br><span class="line"><span class="function">4) "<span class="title">after_node</span>"</span></span><br><span class="line"><span class="function">5) "<span class="title">node3</span>"</span></span><br><span class="line"><span class="function">6) "<span class="title">end</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">lpush</span> <span class="title">list</span> <span class="title">node</span> <span class="title">node</span> <span class="title">node</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 9</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">lrem</span> <span class="title">list</span> 3 <span class="title">node</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 3</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">lset</span> <span class="title">list</span> 0 <span class="title">new_head_value</span></span></span><br><span class="line"><span class="function"><span class="title">OK</span></span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">lrange</span> <span class="title">list</span> 0 10</span></span><br><span class="line"><span class="function">1) "<span class="title">new_head_value</span>"</span></span><br><span class="line"><span class="function">2) "<span class="title">before_node</span>"</span></span><br><span class="line"><span class="function">3) "<span class="title">node2</span>"</span></span><br><span class="line"><span class="function">4) "<span class="title">after_node</span>"</span></span><br><span class="line"><span class="function">5) "<span class="title">node3</span>"</span></span><br><span class="line"><span class="function">6) "<span class="title">end</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="链表的阻塞命令"><a href="#链表的阻塞命令" class="headerlink" title="链表的阻塞命令"></a>链表的阻塞命令</h3><table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">说明</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">blpop key timeout</td>
<td align="left">移出并获取列表的第一个元素，如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止</td>
<td align="left">相对于lpop命令，它的操作是进程安全的</td>
</tr>
<tr>
<td align="left">brpop key timeout</td>
<td align="left">移出并获取列表的最后一个元素，如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止</td>
<td align="left">相对于rpop命令，它的操作是进程安全的</td>
</tr>
<tr>
<td align="left">rpoplpush key src dest</td>
<td align="left">按从左到右的顺序，将一个链表的最后一个元素移除，并插入到目标链表最左边</td>
<td align="left">不能设置超时时间</td>
</tr>
<tr>
<td align="left">brpoplpush key src dest timeout</td>
<td align="left">按从左到右的顺序，将一个链表的最后一个元素移除，并插入到目标链表最左边，并可以设置超时时间</td>
<td align="left">可设置超时时间</td>
</tr>
</tbody></table>
<h4 id="本地测试-3"><a href="#本地测试-3" class="headerlink" title="本地测试"></a>本地测试</h4><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; lpush list1 node1 node2 node3 node4 node5</span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; blpop list1 <span class="number">2</span></span><br><span class="line"><span class="number">1</span>) "list1"</span><br><span class="line"><span class="number">2</span>) "node5"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; brpop list1 <span class="number">3</span></span><br><span class="line"><span class="number">1</span>) "list1"</span><br><span class="line"><span class="number">2</span>) "node1"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; lpush list2 data1 data2 data3</span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; rpoplpush list1 list2</span><br><span class="line">"node2"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; brpoplpush list1 list2 <span class="number">3</span></span><br><span class="line">"node3"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; lrange list1 <span class="number">0</span> <span class="number">10</span></span><br><span class="line"><span class="number">1</span>) "node4"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; lrange list2 <span class="number">0</span> <span class="number">10</span></span><br><span class="line"><span class="number">1</span>) "node3"</span><br><span class="line"><span class="number">2</span>) "node2"</span><br><span class="line"><span class="number">3</span>) "data3"</span><br><span class="line"><span class="number">4</span>) "data2"</span><br><span class="line"><span class="number">5</span>) "data1"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Spring测试-2"><a href="#Spring测试-2" class="headerlink" title="Spring测试"></a>Spring测试</h4><h5 id="常规操作测试"><a href="#常规操作测试" class="headerlink" title="常规操作测试"></a>常规操作测试</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.util.ObjectBuffer;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.demo.config.RedisConfig;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.demo.pojo.Role;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.DataAccessException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisListCommands;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.jedis.JedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.SessionCallback;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line"></span><br><span class="line">        ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">//ApplicationContext applicationContext = new ClassPathXmlApplicationContext("spring-redis-config.xml");</span></span><br><span class="line">        RedisTemplate&lt;String, String&gt; redisTemplate = (RedisTemplate&lt;String, String&gt;) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="comment">//删除链表，以便我们可以反复测试</span></span><br><span class="line">            redisTemplate.delete(<span class="string">"list"</span>);</span><br><span class="line">            <span class="comment">//把node3插入链表list</span></span><br><span class="line">            redisTemplate.opsForList().leftPush(<span class="string">"list"</span>, <span class="string">"node3"</span>);</span><br><span class="line">            List&lt;String&gt; nodeList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i &gt;= <span class="number">1</span>; i --){</span><br><span class="line">                nodeList.add(<span class="string">"node"</span> + i);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//相当于lpush把多个价值从左插入链表</span></span><br><span class="line">            redisTemplate.opsForList().leftPushAll(<span class="string">"list"</span>, nodeList);</span><br><span class="line">            <span class="comment">//从右边插入一个节点</span></span><br><span class="line">            redisTemplate.opsForList().rightPush(<span class="string">"list"</span>, <span class="string">"node4"</span>);</span><br><span class="line">            <span class="comment">//获取下标为0的节点</span></span><br><span class="line">            String node1 = (String) redisTemplate.opsForList().index(<span class="string">"list"</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//获取链表长度</span></span><br><span class="line">            <span class="keyword">long</span> size = redisTemplate.opsForList().size(<span class="string">"list"</span>);</span><br><span class="line">            <span class="comment">//从左边弹出一个节点</span></span><br><span class="line">            String lpop = (String) redisTemplate.opsForList().leftPop(<span class="string">"list"</span>);</span><br><span class="line">            <span class="comment">//从右边弹出一个节点</span></span><br><span class="line">            String rpop = (String) redisTemplate.opsForList().rightPop(<span class="string">"list"</span>);</span><br><span class="line">            <span class="comment">//注意，需要使用更为底层的命令才能操作linsert命令</span></span><br><span class="line">            <span class="comment">//使用linsert命令在node2前插入一个节点</span></span><br><span class="line">            redisTemplate.getConnectionFactory().getConnection().lInsert(<span class="string">"list"</span>.getBytes(StandardCharsets.UTF_8),</span><br><span class="line">                    RedisListCommands.Position.BEFORE,</span><br><span class="line">                    <span class="string">"node2"</span>.getBytes(StandardCharsets.UTF_8),</span><br><span class="line">                    <span class="string">"before_node"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            <span class="comment">//判断list是否存在，如果存在则从左边插入head节点</span></span><br><span class="line">            redisTemplate.opsForList().leftPushIfPresent(<span class="string">"list"</span>, <span class="string">"head"</span>);</span><br><span class="line">            <span class="comment">//判断list是否存在，如果存在则从右边插入end节点</span></span><br><span class="line">            redisTemplate.opsForList().rightPushIfPresent(<span class="string">"list"</span>, <span class="string">"end"</span>);</span><br><span class="line">            <span class="comment">//从左到右，或者下标从0到10的节点元素</span></span><br><span class="line">            List valueList = redisTemplate.opsForList().range(<span class="string">"list"</span>, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">            nodeList.clear();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; i ++){</span><br><span class="line">                nodeList.add(<span class="string">"node"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//在链表左边插入三个值为node的节点</span></span><br><span class="line">            redisTemplate.opsForList().leftPushAll(<span class="string">"list"</span>, nodeList);</span><br><span class="line">            <span class="comment">//从左到右删除至多三个node节点</span></span><br><span class="line">            redisTemplate.opsForList().remove(<span class="string">"list"</span>, <span class="number">3</span>, <span class="string">"node"</span>);</span><br><span class="line">            <span class="comment">//给链表下标为0的节点设置新值</span></span><br><span class="line">            redisTemplate.opsForList().set(<span class="string">"list"</span>, <span class="number">0</span>, <span class="string">"new_head_value"</span>);</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        printList(redisTemplate, <span class="string">"list"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printList</span><span class="params">(RedisTemplate&lt;String, String&gt; redisTemplate, String key)</span></span>{</span><br><span class="line">        <span class="comment">//链表长度</span></span><br><span class="line">        Long size = redisTemplate.opsForList().size(key);</span><br><span class="line">        <span class="comment">//获取整个链表的值</span></span><br><span class="line">        List valueList = redisTemplate.opsForList().range(key, <span class="number">0</span>, size);</span><br><span class="line">        <span class="comment">//打印</span></span><br><span class="line">        System.out.println(valueList);</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printValueForHash</span><span class="params">(RedisTemplate&lt;String, String&gt; redisTemplate, String key, String field)</span></span>{</span><br><span class="line">        String value = (String) redisTemplate.opsForHash().get(key, field);</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[new_head_value, before_node, node2, node3, end]</span><br></pre></td></tr></tbody></table></figure>

<h5 id="阻塞操作测试"><a href="#阻塞操作测试" class="headerlink" title="阻塞操作测试"></a>阻塞操作测试</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.util.ObjectBuffer;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.demo.config.RedisConfig;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.demo.pojo.Role;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.DataAccessException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisListCommands;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.jedis.JedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.SessionCallback;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line"></span><br><span class="line">        ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">//ApplicationContext applicationContext = new ClassPathXmlApplicationContext("spring-redis-config.xml");</span></span><br><span class="line">        RedisTemplate&lt;String, String&gt; redisTemplate = (RedisTemplate&lt;String, String&gt;) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line">        <span class="comment">//清空数据，可以重复测试</span></span><br><span class="line">        redisTemplate.delete(<span class="string">"list1"</span>);</span><br><span class="line">        redisTemplate.delete(<span class="string">"list2"</span>);</span><br><span class="line">        <span class="comment">//初始化链表list1</span></span><br><span class="line">        List&lt;String&gt; nodeList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i ++){</span><br><span class="line">            nodeList.add(<span class="string">"node"</span> + i);</span><br><span class="line">        }</span><br><span class="line">        redisTemplate.opsForList().leftPushAll(<span class="string">"list1"</span>, nodeList);</span><br><span class="line">        <span class="comment">//Spring使用参数超时作为阻塞命令区分，等价于blpop命令，并且可以设置时间参数</span></span><br><span class="line">        printList(redisTemplate, <span class="string">"list1"</span>);</span><br><span class="line">        redisTemplate.opsForList().leftPop(<span class="string">"list1"</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//Spring使用参数超时时间作为阻塞命令区分，等价于brpop命令，并且可以设置时间参数</span></span><br><span class="line">        redisTemplate.opsForList().rightPop(<span class="string">"list1"</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        nodeList.clear();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; i ++){</span><br><span class="line">            nodeList.add(<span class="string">"data"</span> + i);</span><br><span class="line">        }</span><br><span class="line">        redisTemplate.opsForList().leftPushAll(<span class="string">"list2"</span>, nodeList);</span><br><span class="line">        <span class="comment">//相当于rpoplpush命令，弹出list1最右边的节点，插入到list2最左边</span></span><br><span class="line">        redisTemplate.opsForList().rightPopAndLeftPush(<span class="string">"list1"</span>, <span class="string">"list2"</span>);</span><br><span class="line">        printList(redisTemplate, <span class="string">"list1"</span>);</span><br><span class="line">        printList(redisTemplate, <span class="string">"list2"</span>);</span><br><span class="line">        <span class="comment">//相当于brpoplpush命令，注意在Spring中使用超时参数区分</span></span><br><span class="line">        redisTemplate.opsForList().rightPopAndLeftPush(<span class="string">"list1"</span>, <span class="string">"list2"</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//打印链表数据</span></span><br><span class="line">        printList(redisTemplate, <span class="string">"list1"</span>);</span><br><span class="line">        printList(redisTemplate, <span class="string">"list2"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printList</span><span class="params">(RedisTemplate&lt;String, String&gt; redisTemplate, String key)</span></span>{</span><br><span class="line">        <span class="comment">//链表长度</span></span><br><span class="line">        Long size = redisTemplate.opsForList().size(key);</span><br><span class="line">        <span class="comment">//获取整个链表的值</span></span><br><span class="line">        List valueList = redisTemplate.opsForList().range(key, <span class="number">0</span>, size);</span><br><span class="line">        <span class="comment">//打印</span></span><br><span class="line">        System.out.println(valueList);</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printValueForHash</span><span class="params">(RedisTemplate&lt;String, String&gt; redisTemplate, String key, String field)</span></span>{</span><br><span class="line">        String value = (String) redisTemplate.opsForHash().get(key, field);</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[node5, node4, node3, node2, node1]</span><br><span class="line">[node4, node3]</span><br><span class="line">[node2, data3, data2, data1]</span><br><span class="line">[node4]</span><br><span class="line">[node3, node2, data3, data2, data1]</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Redis数据结构——集合"><a href="#Redis数据结构——集合" class="headerlink" title="Redis数据结构——集合"></a>Redis数据结构——集合</h2><p>理论上一个集合可以存储$2^{31} - 1$个元素，因为采用哈希表结构，所以对于Redis集合的插入、删除和查找的时间复杂度都是$O(1)$</p>
<table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">说明</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">sadd key member1 [member2 member3 ……]</td>
<td align="left">给键为key的集合增加成员</td>
<td align="left">可以同时增加多个</td>
</tr>
<tr>
<td align="left">scard key</td>
<td align="left">统计键为key的集合成员数</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">sdiff key1 [key2]</td>
<td align="left">找出两个集合的差集</td>
<td align="left">参数如果是单key，那么Redis就返回这个key的所有元素</td>
</tr>
<tr>
<td align="left">sdiffstore des key1 [key2]</td>
<td align="left">先按sdiff命令的规则，找出key1和key2两个集合的差集，然后将其保存到des集合中</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">sinter key1 [key2]</td>
<td align="left">求key1和key2两个集合的交集</td>
<td align="left">参数如果是单key，那么Redis就返回这个key的所有元素</td>
</tr>
<tr>
<td align="left">sinterstore des key1 key2</td>
<td align="left">先按sinter命令的规则，找出key1和key2两个结合的交集，然后保存到des中</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">sismember key member</td>
<td align="left">判断member是否键为key的集合的成员</td>
<td align="left">如果是返回0，否则返回0</td>
</tr>
<tr>
<td align="left">smember key</td>
<td align="left">返回集合所有成员</td>
<td align="left">如果数据量大，需要考虑迭代遍历的问题</td>
</tr>
<tr>
<td align="left">smove src des member</td>
<td align="left">将成员member从集合src迁移到集合des中</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">spop key</td>
<td align="left">随机弹出集合的一个元素</td>
<td align="left">注意其随机性，因为集合是无序的</td>
</tr>
<tr>
<td align="left">srandmember key [key]</td>
<td align="left">随机返回集合中一个或者多个元素，count为限制返回总数，如果count为负数，则先求其绝对值</td>
<td align="left">count为整数，如果不填默认为1，如果count大于等于集合总数，则返回整个集合</td>
</tr>
<tr>
<td align="left">srem key member1 [member2……]</td>
<td align="left">移出集合中的元素，可以是多个元素</td>
<td align="left">对于很大的集合可以通过它删除部分元素，避免删除大量数据引发Redis停顿</td>
</tr>
<tr>
<td align="left">sunion key1 [key2]</td>
<td align="left">求两个集合的并集</td>
<td align="left">参数如果是单key，那么Redis就返回这个key的所有元素</td>
</tr>
<tr>
<td align="left">sunionstore des key1 key2</td>
<td align="left">先执行sunion命令求出并集，然后保存到键为des的集合中</td>
<td align="left"></td>
</tr>
</tbody></table>
<h3 id="本地测试-4"><a href="#本地测试-4" class="headerlink" title="本地测试"></a>本地测试</h3><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\<span class="title">download</span>\<span class="title">Redis</span>-<span class="title">x64</span>-3.2.100&gt;<span class="title">redis</span>-<span class="title">cli.exe</span> -<span class="title">h</span> 127.0.0.1 -<span class="title">p</span> 6379</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">sadd</span> <span class="title">set1</span> <span class="title">v1</span> <span class="title">v2</span> <span class="title">v3</span> <span class="title">v4</span> <span class="title">v5</span> <span class="title">v6</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 6</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">sadd</span> <span class="title">set2</span> <span class="title">v2</span> <span class="title">v4</span> <span class="title">v6</span> <span class="title">v8</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 4</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">sdiffstore</span> <span class="title">diff_set</span> <span class="title">set1</span> <span class="title">set2</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 3</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">smembers</span> <span class="title">diff_set</span></span></span><br><span class="line"><span class="function">1) "<span class="title">v1</span>"</span></span><br><span class="line"><span class="function">2) "<span class="title">v3</span>"</span></span><br><span class="line"><span class="function">3) "<span class="title">v5</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">sunionstore</span> <span class="title">union_set</span> <span class="title">set1</span> <span class="title">set2</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 7</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">smember</span> <span class="title">union_set</span></span></span><br><span class="line"><span class="function">(<span class="title">error</span>) <span class="title">ERR</span> <span class="title">unknown</span> <span class="title">command</span> '<span class="title">smember</span>'</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">smembers</span> <span class="title">union_set</span></span></span><br><span class="line"><span class="function">1) "<span class="title">v1</span>"</span></span><br><span class="line"><span class="function">2) "<span class="title">v6</span>"</span></span><br><span class="line"><span class="function">3) "<span class="title">v5</span>"</span></span><br><span class="line"><span class="function">4) "<span class="title">v2</span>"</span></span><br><span class="line"><span class="function">5) "<span class="title">v3</span>"</span></span><br><span class="line"><span class="function">6) "<span class="title">v4</span>"</span></span><br><span class="line"><span class="function">7) "<span class="title">v8</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">sinterstore</span> <span class="title">inter_set</span> <span class="title">set1</span> <span class="title">set2</span></span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 3</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">smembers</span> <span class="title">inter_set</span></span></span><br><span class="line"><span class="function">1) "<span class="title">v6</span>"</span></span><br><span class="line"><span class="function">2) "<span class="title">v4</span>"</span></span><br><span class="line"><span class="function">3) "<span class="title">v2</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Spring测试-3"><a href="#Spring测试-3" class="headerlink" title="Spring测试"></a>Spring测试</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//ApplicationContext applicationContext = new ClassPathXmlApplicationContext("spring-redis-config.xml");</span></span><br><span class="line">RedisTemplate&lt;String, String&gt; redisTemplate = (RedisTemplate&lt;String, String&gt;) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line">Set set = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//将元素加入列表</span></span><br><span class="line">redisTemplate.boundSetOps(<span class="string">"set1"</span>).add(<span class="string">"v1"</span>, <span class="string">"v2"</span>, <span class="string">"v3"</span>, <span class="string">"v4"</span>, <span class="string">"v5"</span>, <span class="string">"v6"</span>);</span><br><span class="line">redisTemplate.boundSetOps(<span class="string">"set2"</span>).add(<span class="string">"v0"</span>, <span class="string">"v2"</span>, <span class="string">"v4"</span>, <span class="string">"v6"</span>, <span class="string">"v8"</span>);</span><br><span class="line"><span class="comment">//求集合长度</span></span><br><span class="line">redisTemplate.opsForSet().size(<span class="string">"set1"</span>);</span><br><span class="line"><span class="comment">//求差集</span></span><br><span class="line">set = redisTemplate.opsForSet().difference(<span class="string">"set1"</span>, <span class="string">"set2"</span>);</span><br><span class="line"><span class="comment">//求并集</span></span><br><span class="line">set = redisTemplate.opsForSet().intersect(<span class="string">"set1"</span>, <span class="string">"set2"</span>);</span><br><span class="line"><span class="comment">//判断是否集合中的元素</span></span><br><span class="line"><span class="keyword">boolean</span> exists = redisTemplate.opsForSet().isMember(<span class="string">"set1"</span>, <span class="string">"v1"</span>);</span><br><span class="line"><span class="comment">//获取集合所有元素</span></span><br><span class="line">set = redisTemplate.opsForSet().members(<span class="string">"set1"</span>);</span><br><span class="line"><span class="comment">//从集合中随机弹出一个元素</span></span><br><span class="line">String val = (String) redisTemplate.opsForSet().pop(<span class="string">"set1"</span>);</span><br><span class="line"><span class="comment">//随机获取一个集合的元素</span></span><br><span class="line">val = (String) redisTemplate.opsForSet().randomMember(<span class="string">"set1"</span>);</span><br><span class="line"><span class="comment">//随机获取2个集合的元素</span></span><br><span class="line">List list = redisTemplate.opsForSet().randomMembers(<span class="string">"set1"</span>, <span class="number">2L</span>);</span><br><span class="line"><span class="comment">//删除一个集合的元素，参数可以是多个</span></span><br><span class="line">redisTemplate.opsForSet().remove(<span class="string">"set1"</span>, <span class="string">"v1"</span>);</span><br><span class="line"><span class="comment">//求两个集合的并集</span></span><br><span class="line">redisTemplate.opsForSet().union(<span class="string">"set1"</span>, <span class="string">"set2"</span>);</span><br><span class="line"><span class="comment">//求两个集合的差集，并保存到集合diff_set中</span></span><br><span class="line">redisTemplate.opsForSet().differenceAndStore(<span class="string">"set1"</span>, <span class="string">"set2"</span>, <span class="string">"diff_set"</span>);</span><br><span class="line"><span class="comment">//求两个集合的交集，并保存到集合Inter_set中</span></span><br><span class="line">redisTemplate.opsForSet().intersectAndStore(<span class="string">"set1"</span>, <span class="string">"set2"</span>, <span class="string">"inter_set"</span>);</span><br><span class="line"><span class="comment">//求两个集合的并集，并保存到集合union_set中</span></span><br><span class="line">redisTemplate.opsForSet().unionAndStore(<span class="string">"set1"</span>, <span class="string">"set2"</span>, <span class="string">"union_set"</span>);</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Redis数据结构——有序集合"><a href="#Redis数据结构——有序集合" class="headerlink" title="Redis数据结构——有序集合"></a>Redis数据结构——有序集合</h2><p>添加、删除、查找的时间复杂度都是$O(1)$，集合最大成员数为$2^{31} - 1$</p>
<p>有序集合，可以支持对分数排序，底层实现有两种方式：字典和跳表</p>
<h3 id="Redis基础命令"><a href="#Redis基础命令" class="headerlink" title="Redis基础命令"></a>Redis基础命令</h3><table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">说明</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">zadd key score1 value1 [score2 value2 ……]</td>
<td align="left">向有序集合的key，增加一个或者多个成员</td>
<td align="left">如果不存在对应的key，则创建键为key的有序集合</td>
</tr>
<tr>
<td align="left">zcard key</td>
<td align="left">获取有序集合的成员数</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zcount key min max</td>
<td align="left">根据分数返回对应的成员列表</td>
<td align="left">min为最小值，max为最大值，默认为包含min和max值，采用数学区间表示的方法，如果需要不包含，则在分数前面加入”(“，注意支持”[“</td>
</tr>
<tr>
<td align="left">zincrby key increment member</td>
<td align="left">给有序集合成员值为member的分数增加increment</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zinterstore desKey numkeys key1 [key2 key3 ……]</td>
<td align="left">求多个有序集合的交集，并且将结果保存到desKey中</td>
<td align="left">numKeys是一个整数，表示多个有序结合</td>
</tr>
<tr>
<td align="left">zlexcount key min max</td>
<td align="left">求有序集合key成员值在min和max的范围</td>
<td align="left">这里范围为key的成员值，Redis借助数据区间的表示方法，”[“表示包含该值，”(“表示不包含该值</td>
</tr>
<tr>
<td align="left">zrange key start stop [winthscores]</td>
<td align="left">按照分值的大小（从小到大）返回成员，加入start和stop参数可以截取某一段返回。如果输入可选项withscores，则连同分数一起返回</td>
<td align="left">这里记集合最大长度为len，则Redis会将集合排序后，形成一个从0到len-1的下标，然后根据start和stop控制的下标（包含start和stop）返回</td>
</tr>
<tr>
<td align="left">zrank key member</td>
<td align="left">按从小到大求有序集合的排行</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zrangebylex key min max [limit offset count]</td>
<td align="left">根据值的大小，从小到大排序，min为最小值，max为最大值；limit选项可选，当Redis求出范围集合后，会产生下标0到n，然后根据偏移量offset和限定返回数count，返回对应的成员</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zrangebyscore key min max[withscores] [limit offset count]</td>
<td align="left">根据分数大小，从小到大求取范围，选项withscores和limit同上</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zremrangebyscore key start stop</td>
<td align="left">根据分数区间进行删除</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zremrangebyrank key start stop</td>
<td align="left">按照分数排行从小到大的排序删除，从0开始计算</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zremrangebylex key min max</td>
<td align="left">按照值的分布进行删除</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zrevrange key start stop [withscores]</td>
<td align="left">从大到小的按分数排序，参数同上</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zrevrangebyscore key max min [withscore]</td>
<td align="left">从大到小的按分数排序，参数同上</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zrevrank key member</td>
<td align="left">按从大到小的顺序，求元素的排行</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zscore key member</td>
<td align="left">返回成员的分数值</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">zunionstore desKey numKeys [key1 key2 key3 key4 ……]</td>
<td align="left">求多个有序集合的并集，其中numKeys是有序集合的个数</td>
<td align="left"></td>
</tr>
</tbody></table>
<h3 id="本地测试-5"><a href="#本地测试-5" class="headerlink" title="本地测试"></a>本地测试</h3><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zadd zset1 <span class="number">1</span> x1 <span class="number">2</span> x2 <span class="number">3</span> x3 <span class="number">4</span> x4 <span class="number">5</span> x5 <span class="number">6</span> x6 <span class="number">7</span> x7 <span class="number">8</span> x8 <span class="number">9</span> x9</span><br><span class="line">(integer) <span class="number">9</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zadd zset2 <span class="number">1</span> y1 <span class="number">2</span> x2 <span class="number">3</span> y3 <span class="number">4</span> x4 <span class="number">5</span> y5 <span class="number">6</span> x6 <span class="number">7</span> y7 <span class="number">8</span> x8 <span class="number">9</span> y9</span><br><span class="line">(integer) <span class="number">9</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zcard zset1</span><br><span class="line">(integer) <span class="number">9</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zcount zset1 <span class="number">1</span> <span class="number">4</span></span><br><span class="line">(integer) <span class="number">4</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zinterstore des_key <span class="number">2</span> zset1 zset2</span><br><span class="line">(integer) <span class="number">4</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zlexcount zset1 x1 x5</span><br><span class="line">(error) ERR min or max <span class="keyword">not</span> valid string range item</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zlexcount zset1</span><br><span class="line">(error) ERR wrong number of arguments <span class="keyword">for</span> 'zlexcount' command</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zlexcount zset1 (x1 [x5</span><br><span class="line">(integer) <span class="number">4</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrange zset1 <span class="number">1</span> <span class="number">5</span> withscores</span><br><span class="line"> <span class="number">1</span>) "x2"</span><br><span class="line"> <span class="number">2</span>) "<span class="number">2</span>"</span><br><span class="line"> <span class="number">3</span>) "x3"</span><br><span class="line"> <span class="number">4</span>) "<span class="number">3</span>"</span><br><span class="line"> <span class="number">5</span>) "x4"</span><br><span class="line"> <span class="number">6</span>) "<span class="number">4</span>"</span><br><span class="line"> <span class="number">7</span>) "x5"</span><br><span class="line"> <span class="number">8</span>) "<span class="number">5</span>"</span><br><span class="line"> <span class="number">9</span>) "x6"</span><br><span class="line"><span class="number">10</span>) "<span class="number">6</span>"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrange zset1 <span class="number">5</span> <span class="number">7</span> withscores</span><br><span class="line"><span class="number">1</span>) "x6"</span><br><span class="line"><span class="number">2</span>) "<span class="number">6</span>"</span><br><span class="line"><span class="number">3</span>) "x7"</span><br><span class="line"><span class="number">4</span>) "<span class="number">7</span>"</span><br><span class="line"><span class="number">5</span>) "x8"</span><br><span class="line"><span class="number">6</span>) "<span class="number">8</span>"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrank zset1 x5</span><br><span class="line">(integer) <span class="number">4</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrangebylex zset1 (x1 [x6</span><br><span class="line"><span class="number">1</span>) "x2"</span><br><span class="line"><span class="number">2</span>) "x3"</span><br><span class="line"><span class="number">3</span>) "x4"</span><br><span class="line"><span class="number">4</span>) "x5"</span><br><span class="line"><span class="number">5</span>) "x6"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrangebyscore zset1 <span class="number">5</span> <span class="number">7</span></span><br><span class="line"><span class="number">1</span>) "x5"</span><br><span class="line"><span class="number">2</span>) "x6"</span><br><span class="line"><span class="number">3</span>) "x7"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrangebyscore zset1 <span class="number">2</span> <span class="number">7</span> withscores</span><br><span class="line"> <span class="number">1</span>) "x2"</span><br><span class="line"> <span class="number">2</span>) "<span class="number">2</span>"</span><br><span class="line"> <span class="number">3</span>) "x3"</span><br><span class="line"> <span class="number">4</span>) "<span class="number">3</span>"</span><br><span class="line"> <span class="number">5</span>) "x4"</span><br><span class="line"> <span class="number">6</span>) "<span class="number">4</span>"</span><br><span class="line"> <span class="number">7</span>) "x5"</span><br><span class="line"> <span class="number">8</span>) "<span class="number">5</span>"</span><br><span class="line"> <span class="number">9</span>) "x6"</span><br><span class="line"><span class="number">10</span>) "<span class="number">6</span>"</span><br><span class="line"><span class="number">11</span>) "x7"</span><br><span class="line"><span class="number">12</span>) "<span class="number">7</span>"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrevrange zset1 <span class="number">1</span> <span class="number">5</span></span><br><span class="line"><span class="number">1</span>) "x8"</span><br><span class="line"><span class="number">2</span>) "x7"</span><br><span class="line"><span class="number">3</span>) "x6"</span><br><span class="line"><span class="number">4</span>) "x5"</span><br><span class="line"><span class="number">5</span>) "x4"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrevrangebyscore zset2 <span class="number">5</span>  <span class="number">2</span> withscores</span><br><span class="line"><span class="number">1</span>) "y5"</span><br><span class="line"><span class="number">2</span>) "<span class="number">5</span>"</span><br><span class="line"><span class="number">3</span>) "x4"</span><br><span class="line"><span class="number">4</span>) "<span class="number">4</span>"</span><br><span class="line"><span class="number">5</span>) "y3"</span><br><span class="line"><span class="number">6</span>) "<span class="number">3</span>"</span><br><span class="line"><span class="number">7</span>) "x2"</span><br><span class="line"><span class="number">8</span>) "<span class="number">2</span>"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zrevrank zset1 x4</span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zscore zset1 x5</span><br><span class="line">"<span class="number">5</span>"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zunionstore des_key <span class="number">2</span> zset1 zset2</span><br><span class="line">(integer) <span class="number">14</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zincrby zset1 <span class="number">5</span> x9</span><br><span class="line">"<span class="number">14</span>"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zremrangebyscore zset1 <span class="number">3</span> <span class="number">2</span></span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zremrangebyscore zset1 <span class="number">3</span> <span class="number">5</span></span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zremrangebyrank zset1 <span class="number">1</span> <span class="number">3</span></span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; zremrangebylex zset2 (y1 (y5</span><br><span class="line">(integer) <span class="number">2</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Spring测试-4"><a href="#Spring测试-4" class="headerlink" title="Spring测试"></a>Spring测试</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        RedisTemplate&lt;String, String&gt; redisTemplate = (RedisTemplate&lt;String, String&gt;) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line">        <span class="comment">//Spring提供接口TypedTuple操作有序结合</span></span><br><span class="line">        Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; set1 = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; set2 = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">9</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">9</span>; i ++) {</span><br><span class="line">            j--;</span><br><span class="line">            <span class="comment">//计算分数和值</span></span><br><span class="line">            Double score1 = Double.valueOf(i);</span><br><span class="line">            String value1 = <span class="string">"x"</span> + i;</span><br><span class="line">            Double score2 = Double.valueOf(j);</span><br><span class="line">            String value2 = j % <span class="number">2</span> == <span class="number">1</span> ? <span class="string">"y"</span> + j : <span class="string">"x"</span> + j;</span><br><span class="line">            <span class="comment">//使用Spring提供的默认TypedTuple——DefaultTypedTuple</span></span><br><span class="line">            ZSetOperations.TypedTuple&lt;String&gt; typedTuple1 = <span class="keyword">new</span> DefaultTypedTuple&lt;&gt;(value1, score1);</span><br><span class="line">            set1.add(typedTuple1);</span><br><span class="line">            ZSetOperations.TypedTuple&lt;String&gt; typedTuple2 = <span class="keyword">new</span> DefaultTypedTuple&lt;&gt;(value2, score2);</span><br><span class="line">            set2.add(typedTuple2);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//将元素插入有序集合zset1</span></span><br><span class="line">        redisTemplate.opsForZSet().add(<span class="string">"zset1"</span>, set1);</span><br><span class="line">        redisTemplate.opsForZSet().add(<span class="string">"zset2"</span>, set2);</span><br><span class="line">        <span class="comment">//统计总数</span></span><br><span class="line">        Long size = <span class="keyword">null</span>;</span><br><span class="line">        size = redisTemplate.opsForZSet().zCard(<span class="string">"set1"</span>);</span><br><span class="line">        <span class="comment">//计分数为score，那么下面的方法就是求3&lt;=score&lt;=6的元素</span></span><br><span class="line">        size = redisTemplate.opsForZSet().count(<span class="string">"zset1"</span>, <span class="number">3</span>, <span class="number">6</span>);</span><br><span class="line">        Set&lt;String&gt; set = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//从下标一开始截取5个元素，但是不返回分数，每一个元素是String</span></span><br><span class="line">        set = redisTemplate.opsForZSet().range(<span class="string">"zset1"</span>, <span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">        printSet(set);</span><br><span class="line">        <span class="comment">//截取集合所有元素，并且对集合按分数排序，并返回分数，每一个元素是TypedTuple</span></span><br><span class="line">        set1 = redisTemplate.opsForZSet().rangeWithScores(<span class="string">"zset1"</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        printTypedTuple(set1);</span><br><span class="line">        <span class="comment">//将zset1和zset2两个集合的交集放入集合inter_zset</span></span><br><span class="line">        size = redisTemplate.opsForZSet().intersectAndStore(<span class="string">"zset1"</span>, <span class="string">"zset2"</span>, <span class="string">"inter_zset"</span>);</span><br><span class="line">        <span class="comment">//区间</span></span><br><span class="line">        RedisZSetCommands.Range range = RedisZSetCommands.Range.range();</span><br><span class="line">        range.lt(<span class="string">"x8"</span>); <span class="comment">//小于</span></span><br><span class="line">        range.gt(<span class="string">"x1"</span>); <span class="comment">//大于</span></span><br><span class="line">        set = redisTemplate.opsForZSet().rangeByLex(<span class="string">"zset1"</span>, range);</span><br><span class="line">        printSet(set);</span><br><span class="line">        range.lte(<span class="string">"x8"</span>); <span class="comment">//小于等于</span></span><br><span class="line">        range.gte(<span class="string">"x1"</span>); <span class="comment">//大于等于</span></span><br><span class="line">        set = redisTemplate.opsForZSet().rangeByLex(<span class="string">"zset1"</span>, range);</span><br><span class="line">        printSet(set);</span><br><span class="line">        <span class="comment">//限制返回个数</span></span><br><span class="line">        RedisZSetCommands.Limit limit = RedisZSetCommands.Limit.limit();</span><br><span class="line">        <span class="comment">//限制返回个数</span></span><br><span class="line">        limit.count(<span class="number">4</span>);</span><br><span class="line">        <span class="comment">//限制从第五个开始截取</span></span><br><span class="line">        limit.offset(<span class="number">5</span>);</span><br><span class="line">        <span class="comment">//求区间内的元素，并限制返回4条</span></span><br><span class="line">        set = redisTemplate.opsForZSet().rangeByLex(<span class="string">"zset1"</span>, range, limit);</span><br><span class="line">        printSet(set);</span><br><span class="line">        <span class="comment">//求排行，排名第1返回0，第2返回1</span></span><br><span class="line">        Long rank = redisTemplate.opsForZSet().rank(<span class="string">"zset1"</span>, <span class="string">"x4"</span>);</span><br><span class="line">        System.out.println(<span class="string">"rank = "</span> + rank);</span><br><span class="line">        <span class="comment">//删除元素，返回删除个数</span></span><br><span class="line">        size = redisTemplate.opsForZSet().remove(<span class="string">"zset1"</span>, <span class="string">"x5"</span>, <span class="string">"x6"</span>);</span><br><span class="line">        System.out.println(<span class="string">"delete = "</span> + size);</span><br><span class="line">        <span class="comment">//按照排行删除从0开始算起，这里将删除排名第2和第3的元素</span></span><br><span class="line">        size = redisTemplate.opsForZSet().removeRange(<span class="string">"zset2"</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="comment">//获取所有集合的元素和分数，以-1代表全部元素</span></span><br><span class="line">        set1 = redisTemplate.opsForZSet().rangeWithScores(<span class="string">"zset2"</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        printTypedTuple(set1);</span><br><span class="line">        <span class="comment">//删除指定的元素</span></span><br><span class="line">        size = redisTemplate.opsForZSet().remove(<span class="string">"zset2"</span>, <span class="string">"y5"</span>, <span class="string">"y3"</span>);</span><br><span class="line">        System.out.println(size);</span><br><span class="line">        <span class="comment">//给集合中的一个元素的分数加上11</span></span><br><span class="line">        Double dbl = redisTemplate.opsForZSet().incrementScore(<span class="string">"zset1"</span>, <span class="string">"x1"</span>, <span class="number">11</span>);</span><br><span class="line">        redisTemplate.opsForZSet().removeRangeByScore(<span class="string">"zset1"</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        set1 = redisTemplate.opsForZSet().reverseRangeWithScores(<span class="string">"zset2"</span>, <span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">        printTypedTuple(set1);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printTypedTuple</span><span class="params">(Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; set)</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(set != <span class="keyword">null</span> &amp;&amp; set.isEmpty()) <span class="keyword">return</span>;</span><br><span class="line">        Iterator&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; iterator = set.iterator();</span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext()){</span><br><span class="line">            ZSetOperations.TypedTuple&lt;String&gt; val = (ZSetOperations.TypedTuple&lt;String&gt;) iterator.next();</span><br><span class="line">            System.out.println(<span class="string">"{value="</span> + val.getValue() + <span class="string">", score="</span> + val.getScore() + <span class="string">"}\n"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printSet</span><span class="params">(Set&lt;String&gt; set)</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(set != <span class="keyword">null</span> &amp;&amp; set.isEmpty()) <span class="keyword">return</span>;</span><br><span class="line">        Iterator&lt;String&gt; iterator = set.iterator();</span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext()){</span><br><span class="line">            String val = iterator.next();</span><br><span class="line">            System.out.println(val + <span class="string">"\t"</span>);</span><br><span class="line">        }</span><br><span class="line">        System.out.println();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">x2</span><br><span class="line">x3</span><br><span class="line">x4</span><br><span class="line">x5</span><br><span class="line">x6</span><br><span class="line"></span><br><span class="line">{value=x1, score=<span class="number">1.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x2, score=<span class="number">2.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x3, score=<span class="number">3.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x4, score=<span class="number">4.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x5, score=<span class="number">5.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x6, score=<span class="number">6.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x7, score=<span class="number">7.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x8, score=<span class="number">8.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x9, score=<span class="number">9.0</span>}</span><br><span class="line"></span><br><span class="line">x2</span><br><span class="line">x3</span><br><span class="line">x4</span><br><span class="line">x5</span><br><span class="line">x6</span><br><span class="line">x7</span><br><span class="line"></span><br><span class="line">x1</span><br><span class="line">x2</span><br><span class="line">x3</span><br><span class="line">x4</span><br><span class="line">x5</span><br><span class="line">x6</span><br><span class="line">x7</span><br><span class="line">x8</span><br><span class="line"></span><br><span class="line">x6</span><br><span class="line">x7</span><br><span class="line">x8</span><br><span class="line"></span><br><span class="line">rank = <span class="number">3</span></span><br><span class="line">delete = <span class="number">2</span></span><br><span class="line">{value=x0, score=<span class="number">0.0</span>}</span><br><span class="line"></span><br><span class="line">{value=y3, score=<span class="number">3.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x4, score=<span class="number">4.0</span>}</span><br><span class="line"></span><br><span class="line">{value=y5, score=<span class="number">5.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x6, score=<span class="number">6.0</span>}</span><br><span class="line"></span><br><span class="line">{value=y7, score=<span class="number">7.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x8, score=<span class="number">8.0</span>}</span><br><span class="line"></span><br><span class="line"><span class="number">2</span></span><br><span class="line">{value=y7, score=<span class="number">7.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x6, score=<span class="number">6.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x4, score=<span class="number">4.0</span>}</span><br><span class="line"></span><br><span class="line">{value=x0, score=<span class="number">0.0</span>}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="基数——HyperLogLog"><a href="#基数——HyperLogLog" class="headerlink" title="基数——HyperLogLog"></a>基数——HyperLogLog</h2><p>基数是一种算法。举个例子，一本英文著作由数百万个单词组成，你的内存却不足以存储它们，那么我们先分析一下业务。英文单词本身是有限的，在这本书的几百万个单词中有许许多多重复单词，扣去重复的单词，这本书中也就是几千到一万多个单词而已，那么内存就足够存储它们了。基数的作用是评估大约需要准备多少个存储单元去存储数据，但是基数的算法一般会存在一定的误差（一般是可控的）。</p>
<p>基数并不是存储元素，存储元素消耗内存空间比较大，而是给某一个有重复元素的数据集和（一般是很大的数据集合）评估需要的空间单元数，所以它没有办法进行存储，工作中用得不多。</p>
<table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">说明</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">pfadd key element</td>
<td align="left">添加指定元素到HyperLogLog中</td>
<td align="left">如果已经存储元素，则返回为0，添加失败</td>
</tr>
<tr>
<td align="left">pfcount key</td>
<td align="left">返回HyperLogLog的基数值</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">pfmerge desKey key1 [key2 key3……]</td>
<td align="left">合并多个HyperLogLog，并将其保存在desKey中</td>
<td align="left"></td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">RedisTemplate&lt;String, String&gt; redisTemplate = (RedisTemplate&lt;String, String&gt;) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line">redisTemplate.opsForHyperLogLog().add(<span class="string">"HyperLogLog"</span>, <span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"a"</span>);</span><br><span class="line">redisTemplate.opsForHyperLogLog().add(<span class="string">"HyperLogLog2"</span>, <span class="string">"a"</span>);</span><br><span class="line">redisTemplate.opsForHyperLogLog().add(<span class="string">"HyperLogLog2"</span>, <span class="string">"z"</span>);</span><br><span class="line">Long size = redisTemplate.opsForHyperLogLog().size(<span class="string">"HyperLogLog"</span>);</span><br><span class="line">System.out.println(size);</span><br><span class="line">size = redisTemplate.opsForHyperLogLog().size(<span class="string">"HyperLogLog2"</span>);</span><br><span class="line">System.out.println(size);</span><br><span class="line">redisTemplate.opsForHyperLogLog().union(<span class="string">"des_key"</span>, <span class="string">"HyperLogLog"</span>, <span class="string">"HyperLogLog2"</span>);</span><br><span class="line">size = redisTemplate.opsForHyperLogLog().size(<span class="string">"des_key"</span>);</span><br><span class="line">System.out.println(size);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="Redis的一些常用技术"><a href="#Redis的一些常用技术" class="headerlink" title="Redis的一些常用技术"></a>Redis的一些常用技术</h1></blockquote>
<p>Redis的事务时使用MULTI-EXEC的命令组合，使用它可以提供两个重要的保证：</p>
<ul>
<li>事务是一个被隔离的操作，事务中的方法都会被Redis进行序列化并按顺序执行，事务在执行的过程中不会被其他客户端发生的命令所打断；</li>
<li>事务是一个原子性的操作，它要么全部执行，要么就什么都不执行</li>
</ul>
<p>在一个Redis的连接中，请注意要求是一个连接，所以更多的时候在使用Spring中会使用SessionCallback接口进行处理，在Redis中使用事务会经过3个过程：</p>
<ul>
<li>开启事务</li>
<li>命令进入队列</li>
<li>执行事务</li>
</ul>
<table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">说明</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">multi</td>
<td align="left">开启事务命令，之后的命令就进入队列，而不会马上被执行</td>
<td align="left">在事务生存期间，所有的Redis关于数据结构的命令都会入队</td>
</tr>
<tr>
<td align="left">watch key1 [key2 ……]</td>
<td align="left">监听某些键，当被监听的键在事务执行前被修改，则事务会被回滚</td>
<td align="left">使用乐观锁</td>
</tr>
<tr>
<td align="left">unwatch key1 [key2 ……]</td>
<td align="left">取消监听某些键</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">exec</td>
<td align="left">执行事务，如果被监听的键没有被修改，则采用执行命令，否则就回滚事务</td>
<td align="left">在执行事务队列存储的命令前，Redis会检测被监听的键值对有没有发生变化，如果没有则执行命令，否则就回滚事务</td>
</tr>
<tr>
<td align="left">discard</td>
<td align="left">回滚事务</td>
<td align="left">回滚进入队列的事务命令，之后就不能再用exec命令提交了</td>
</tr>
</tbody></table>
<h2 id="Redis的基础事务"><a href="#Redis的基础事务" class="headerlink" title="Redis的基础事务"></a>Redis的基础事务</h2><h3 id="本地测试-6"><a href="#本地测试-6" class="headerlink" title="本地测试"></a>本地测试</h3><p>在Redis中开启事务是multi命令，而执行事务时exec命令。multi到exec命令之间的Redis命令将采取进入队列的形式，直至exec命令的出现，才会一次性发送队列里的命令去执行，而在执行这些命令的时候其他客户端就不能再插入任何命令了，这就是Redis的事务机制。</p>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key1 value1</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get key1</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; exec</span><br><span class="line"><span class="number">1</span>) OK</span><br><span class="line"><span class="number">2</span>) "value1"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>如果回滚事务，则可以使用discard命令，它就会进入在事务队列中的命令，这样事务中的方法就不会被执行了。</p>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key1 value1</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get key1</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; exec</span><br><span class="line"><span class="number">1</span>) OK</span><br><span class="line"><span class="number">2</span>) "value1"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; discard</span><br><span class="line">(error) ERR DISCARD without MULTI</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Spring测试-5"><a href="#Spring测试-5" class="headerlink" title="Spring测试"></a>Spring测试</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.setEnableTransactionSupport(<span class="keyword">true</span>);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">RedisTemplate redisTemplate = (RedisTemplate) applicationContext.getBean(RedisTemplate<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">SessionCallback callback = <span class="keyword">new</span> SessionCallback() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">(RedisOperations ops)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">        ops.multi();</span><br><span class="line">        ops.boundValueOps(<span class="string">"key1"</span>).set(<span class="string">"value1"</span>);</span><br><span class="line">        <span class="comment">//注意由于命令只是进入队列，而没有被执行，所以此处采用get命令，而value却返回为null</span></span><br><span class="line">        String value = (String) ops.boundValueOps(<span class="string">"key1"</span>).get();</span><br><span class="line">        System.out.println(<span class="string">"事务执行过程中，命令入队列，而没有被执行，所以value为空：value="</span> + value);</span><br><span class="line">        <span class="comment">//此时list会保存之前进入队列的所有命令的结果</span></span><br><span class="line">        List&lt;Object&gt; list = ops.exec(); <span class="comment">//执行事务</span></span><br><span class="line">        <span class="comment">//事务结束后，获取value1</span></span><br><span class="line">        value = (String) redisTemplate.opsForValue().get(<span class="string">"key1"</span>);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"><span class="comment">//执行Redis的命令</span></span><br><span class="line">String value = (String) redisTemplate.execute(callback);</span><br><span class="line">System.out.println(value);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">事务执行过程中，命令入队列，而没有被执行，所以value为空：value=<span class="keyword">null</span></span><br><span class="line">value1</span><br></pre></td></tr></tbody></table></figure>

<h2 id="探索Redis事务回滚"><a href="#探索Redis事务回滚" class="headerlink" title="探索Redis事务回滚"></a>探索Redis事务回滚</h2><p>对于Redis而言，不单单需要注意其事务处理的过程，其回滚的能力也和数据库不太一样。<br>在命令入队的时候，Redis就会检测事务的命令是否正确：</p>
<ul>
<li>如果不正确则会产生错误。无论之前和之后的命令都会被事务所回滚，就变为什么都没有执行；</li>
<li>如果命令格式正确，而因为操作数据结构引起的错误，则该命令执行出现错误，而其之前和之后的命令都会被正常执行。</li>
</ul>
<p>对于一些重要的操作，我们需要通过程序去检测数据的正确性，以保证Redis事务的正确执行，避免出现数据不一致的情况。Redis之所以保持这样简易的事务，完全是为了保证移动互联网的核心问题——性能。</p>
<h3 id="命令正确，数据类型错误"><a href="#命令正确，数据类型错误" class="headerlink" title="命令正确，数据类型错误"></a>命令正确，数据类型错误</h3><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key1 value1</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key2 value2</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; incr key1</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">del</span> key2</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; exec</span><br><span class="line"><span class="number">1</span>) OK</span><br><span class="line"><span class="number">2</span>) OK</span><br><span class="line"><span class="number">3</span>) (error) ERR value is <span class="keyword">not</span> an integer or out of range</span><br><span class="line"><span class="number">4</span>) (integer) <span class="number">1</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="命令错误"><a href="#命令错误" class="headerlink" title="命令错误"></a>命令错误</h3><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key1 value1</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key2 value2</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; incy key1</span><br><span class="line">(error) ERR unknown command 'incy'</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">del</span> key2</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; exec</span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get key1</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get key2</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="使用watch命令监控事务"><a href="#使用watch命令监控事务" class="headerlink" title="使用watch命令监控事务"></a>使用watch命令监控事务</h2><p>在Redis中使用watch命令可以决定事务是执行还是回滚。一般而言，可以在multi命令之前使用watch命令监控某些键值对，然后使用multi命令开启事务，执行各类对数据结构进行操作的命令，这个时候这些命令就会进入队列。当Redis使用exec命令执行事务的是偶，它首先会去比对被watch命令所监控的键值对，如果没有发生变化，那么它会执行事务队列中的命令，提交事务；如果发生变化，那么它不会执行任何事务中的命令，而去事务回滚。无论事务是否回滚，Redis都会去取消执行事务前的watch命令。</p>
<h3 id="正常事务提交"><a href="#正常事务提交" class="headerlink" title="正常事务提交"></a>正常事务提交</h3><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; flushdb</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key1 value1</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; watch key1</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key2 value2</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; exec</span><br><span class="line"><span class="number">1</span>) OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get key2</span><br><span class="line">"value2"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="事务回滚"><a href="#事务回滚" class="headerlink" title="事务回滚"></a>事务回滚</h3><p>客户端1：</p>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; flushdb</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key1 value1</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; watch key1</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key2 value2</span><br><span class="line">QUEUED</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; exec</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get key2</span><br><span class="line">(nil)</span><br></pre></td></tr></tbody></table></figure>
<p>客户端2：在客户端1 设置key2键值对时，修改key1：</p>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; <span class="built_in">set</span> key1 val1</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="流水线（pipelined）"><a href="#流水线（pipelined）" class="headerlink" title="流水线（pipelined）"></a>流水线（pipelined）</h2><p>在事务中Redis提供了队列，这是一个可以批量执行任务的队列，这样性能就比较高，但是使用multi…exec事务命令是有系统开销的，因为它会检测对应的锁和序列化命令。有时候我们希望在没有任何附加条件的场景下去使用队列批量执行一系列的命令，从而提高系统性能，这就是Redis的流水线技术。</p>
<h3 id="Java-API测试"><a href="#Java-API测试" class="headerlink" title="Java API测试"></a>Java API测试</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Pipeline;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{</span><br><span class="line">        Jedis jedis = connectionPool();</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//开启流水线</span></span><br><span class="line">        Pipeline pipeline = jedis.pipelined();</span><br><span class="line">        <span class="comment">//这里测试10万条的读/写操作</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100000</span>; i ++){</span><br><span class="line">            <span class="keyword">int</span> j = i + <span class="number">1</span>;</span><br><span class="line">            pipeline.set(<span class="string">"pipeline_key_"</span> + j, <span class="string">"pipeline_value_"</span> + j);</span><br><span class="line">            pipeline.get(<span class="string">"pipeline_key_"</span> + j);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//pipeline.sync(); //这里只执行同步，但是不返回结果</span></span><br><span class="line">        <span class="comment">//pipeline.syncAndReturnAll(); 将返回执行过的命令返回的List列表结果</span></span><br><span class="line">        List result = pipeline.syncAndReturnAll();</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//计算耗时</span></span><br><span class="line">        System.out.println(<span class="string">"耗时："</span> + (end - start) + <span class="string">"毫秒"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Jedis <span class="title">connectionPool</span><span class="params">()</span></span>{</span><br><span class="line">        JedisPoolConfig poolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        <span class="comment">//最大空闲数</span></span><br><span class="line">        poolConfig.setMaxIdle(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">//最大连接数</span></span><br><span class="line">        poolConfig.setMaxTotal(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">//最大等待毫秒数</span></span><br><span class="line">        poolConfig.setMaxWaitMillis(<span class="number">20000</span>);</span><br><span class="line">        <span class="comment">//使用配置创建连接池</span></span><br><span class="line">        JedisPool pool = <span class="keyword">new</span> JedisPool(poolConfig, <span class="string">"localhost"</span>);</span><br><span class="line">        <span class="comment">//从连接池中获取单个连接</span></span><br><span class="line"></span><br><span class="line">        Jedis jedis = pool.getResource();</span><br><span class="line">        <span class="comment">//如果需要密码</span></span><br><span class="line">        <span class="comment">//jedis.auth("password");</span></span><br><span class="line">        <span class="keyword">return</span> jedis;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">耗时：<span class="number">742</span>毫秒</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Spring测试-6"><a href="#Spring测试-6" class="headerlink" title="Spring测试"></a>Spring测试</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">RedisTemplate redisTemplate = (RedisTemplate) applicationContext.getBean(RedisTemplate<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">SessionCallback callback = <span class="keyword">new</span> SessionCallback() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(RedisOperations redisOperations)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i ++){</span><br><span class="line">            <span class="keyword">int</span> j = i + <span class="number">1</span>;</span><br><span class="line">            redisOperations.boundValueOps(<span class="string">"pipeline_key_"</span> + j).set(<span class="string">"pipeline_value_"</span> + j);</span><br><span class="line">            redisOperations.boundValueOps(<span class="string">"pipeline_key_"</span> + j).get();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"><span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"><span class="comment">//执行Redis的流水线命令</span></span><br><span class="line">List resultList = redisTemplate.executePipelined(callback);</span><br><span class="line"><span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">System.out.println(end - start);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">351</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="发布订阅"><a href="#发布订阅" class="headerlink" title="发布订阅"></a>发布订阅</h2><p>当使用银行卡消费的时候，银行往往会通过微信、短信或邮件通知用户这笔交易的信息，这便是一种发布订阅模式，这里的发布是交易信息的发布，订阅则是各个渠道。这在实际工作中十分常用，Redis支持这样的一个模式。</p>
<ul>
<li>要有发送的消息渠道，让记账系统能够发送消息；</li>
<li>要有订阅者（短信、邮件、微信等系统）订阅这个渠道的消息</li>
</ul>
<h3 id="本地测试-7"><a href="#本地测试-7" class="headerlink" title="本地测试"></a>本地测试</h3><p>可以看到客户端2在<code>publish</code>消息后，客户端1收到了消息。</p>
<p>客户端1：订阅了一个名为chat的渠道</p>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Redis</span>&gt;<span class="title">redis</span>-<span class="title">cli.exe</span> -<span class="title">h</span> 127.0.0.1 -<span class="title">p</span> 6379</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">SUBSCRIBE</span> <span class="title">chat</span></span></span><br><span class="line"><span class="function"><span class="title">Reading</span> <span class="title">messages</span>... (<span class="title">press</span> <span class="title">Ctrl</span>-<span class="title">C</span> <span class="title">to</span> <span class="title">quit</span>)</span></span><br><span class="line"><span class="function">1) "<span class="title">subscribe</span>"</span></span><br><span class="line"><span class="function">2) "<span class="title">chat</span>"</span></span><br><span class="line"><span class="function">3) (<span class="title">integer</span>) 1</span></span><br><span class="line"><span class="function">1) "<span class="title">message</span>"</span></span><br><span class="line"><span class="function">2) "<span class="title">chat</span>"</span></span><br><span class="line"><span class="function">3) "<span class="title">let</span>'<span class="title">s</span> <span class="title">go</span>!!"</span></span><br></pre></td></tr></tbody></table></figure>
<p>客户端2：向渠道chat发送消息</p>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Redis</span>&gt;<span class="title">redis</span>-<span class="title">cli.exe</span> -<span class="title">h</span> 127.0.0.1 -<span class="title">p</span> 6379</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">publish</span> <span class="title">chat</span> "<span class="title">let</span>'<span class="title">s</span> <span class="title">go</span>!!"</span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 1</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Spring测试-7"><a href="#Spring测试-7" class="headerlink" title="Spring测试"></a>Spring测试</h3><h4 id="Redis发布订阅监听类"><a href="#Redis发布订阅监听类" class="headerlink" title="Redis发布订阅监听类"></a>Redis发布订阅监听类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.MessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisMessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>{</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message, <span class="keyword">byte</span>[] bytes)</span> </span>{</span><br><span class="line">        <span class="comment">//获取消息</span></span><br><span class="line">        <span class="keyword">byte</span>[] body = message.getBody();</span><br><span class="line">        <span class="comment">//使用值序列化器转换</span></span><br><span class="line">        String msgBody = (String) redisTemplate.getValueSerializer().deserialize(body);</span><br><span class="line">        System.out.println(msgBody);</span><br><span class="line">        <span class="comment">//获取channel</span></span><br><span class="line">        <span class="keyword">byte</span>[] channel = message.getChannel();</span><br><span class="line">        <span class="comment">//使用字符串序列化器转换</span></span><br><span class="line">        String channelStr = (String) redisTemplate.getStringSerializer().deserialize(channel);</span><br><span class="line">        System.out.println(channelStr);</span><br><span class="line">        <span class="comment">//渠道名称转换</span></span><br><span class="line">        String bytesStr = <span class="keyword">new</span> String(bytes);</span><br><span class="line">        System.out.println(bytesStr);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRedisTemplate</span><span class="params">(RedisTemplate redisTemplate)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate <span class="title">getRedisTemplate</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="RedisConfig配置类"><a href="#RedisConfig配置类" class="headerlink" title="RedisConfig配置类"></a>RedisConfig配置类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.utils.RedisMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.task.TaskExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.jedis.JedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.ChannelTopic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.RedisMessageListenerContainer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.Topic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.JdkSerializationRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> javax.xml.crypto.Data;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = <span class="string">"com.louris.springboot.utils"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"poolConfig"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisPoolConfig <span class="title">getPoolConfig</span><span class="params">()</span></span>{</span><br><span class="line">        JedisPoolConfig poolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        <span class="comment">//最大空闲数</span></span><br><span class="line">        poolConfig.setMaxIdle(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">//最大连接数</span></span><br><span class="line">        poolConfig.setMaxTotal(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">//最大等待时间</span></span><br><span class="line">        poolConfig.setMaxWaitMillis(<span class="number">20000</span>);</span><br><span class="line">        <span class="keyword">return</span> poolConfig;</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"connectionFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">getJedisConnectionFactory</span><span class="params">()</span></span>{</span><br><span class="line">        JedisConnectionFactory factory = <span class="keyword">new</span> JedisConnectionFactory();</span><br><span class="line">        factory.setHostName(<span class="string">"localhost"</span>);</span><br><span class="line">        factory.setPort(<span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//factory.setPassword("123456");</span></span><br><span class="line">        factory.setPoolConfig(getPoolConfig());</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"jdkSerializationRedisSerializer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdkSerializationRedisSerializer <span class="title">getJdkRedisSerializer</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdkSerializationRedisSerializer();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"stringRedisSerializer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> StringRedisSerializer <span class="title">getStringRedisSerializer</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, String&gt; <span class="title">getRedisTemplate</span><span class="params">()</span></span>{</span><br><span class="line">        RedisTemplate&lt;String, String&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(getJedisConnectionFactory());</span><br><span class="line">        redisTemplate.setKeySerializer(getStringRedisSerializer());</span><br><span class="line">        redisTemplate.setValueSerializer(getStringRedisSerializer());</span><br><span class="line">        redisTemplate.setEnableTransactionSupport(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"taskExecutor"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">getExecutor</span><span class="params">()</span></span>{</span><br><span class="line">        ThreadPoolTaskExecutor taskExecutor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        taskExecutor.setCorePoolSize(<span class="number">20</span>);</span><br><span class="line">        <span class="keyword">return</span> taskExecutor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisMessageListener listener = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"topicContainer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title">getContainer</span><span class="params">()</span></span>{</span><br><span class="line">        RedisMessageListenerContainer container = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line">        container.setConnectionFactory(getJedisConnectionFactory());</span><br><span class="line">        container.setTaskExecutor(getExecutor());</span><br><span class="line">        ChannelTopic channelTopic = <span class="keyword">new</span> ChannelTopic(<span class="string">"chat"</span>);</span><br><span class="line">        container.addMessageListener(listener, channelTopic);</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">RedisTemplate redisTemplate = (RedisTemplate) applicationContext.getBean(RedisTemplate<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">String channel = <span class="string">"chat"</span>;</span><br><span class="line">redisTemplate.convertAndSend(channel, <span class="string">"I am lazy!!"</span>);</span><br></pre></td></tr></tbody></table></figure>

<h4 id="测试结果-1"><a href="#测试结果-1" class="headerlink" title="测试结果"></a>测试结果</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">I am lazy!!</span><br><span class="line">chat</span><br><span class="line">chat</span><br></pre></td></tr></tbody></table></figure>

<h2 id="超时命令"><a href="#超时命令" class="headerlink" title="超时命令"></a>超时命令</h2><table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">说明</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">persist key</td>
<td align="left">持久化key，取消超时时间</td>
<td align="left">移除key的超时时间</td>
</tr>
<tr>
<td align="left">ttl key</td>
<td align="left">查看key的超时时间</td>
<td align="left">以秒计算，-1代表没有超时时间，如果不存在key或者key已经超时则为-2</td>
</tr>
<tr>
<td align="left">expire key seconds</td>
<td align="left">设置超时时间戳</td>
<td align="left">以秒为单位</td>
</tr>
<tr>
<td align="left">expireat key timestamp</td>
<td align="left">设置超时时间点</td>
<td align="left">用uninx时间戳确定</td>
</tr>
<tr>
<td align="left">pptl key milliseconds</td>
<td align="left">查看key的超时时间戳</td>
<td align="left">用毫秒计算</td>
</tr>
<tr>
<td align="left">pexpire key</td>
<td align="left">设置键值超时的时间</td>
<td align="left">以毫秒为单位</td>
</tr>
<tr>
<td align="left">Pexpireat key stamptimes</td>
<td align="left">设置超时时间点</td>
<td align="left">以毫秒为单位的uninx时间戳</td>
</tr>
</tbody></table>
<h3 id="本地测试-8"><a href="#本地测试-8" class="headerlink" title="本地测试"></a>本地测试</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; set key1 value1</span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get key1</span><br><span class="line"><span class="string">"value1"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl key1</span><br><span class="line">(integer) -<span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; expire key1 <span class="number">120</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl key1</span><br><span class="line">(integer) <span class="number">114</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; persist key1</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl key1</span><br><span class="line">(integer) -<span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; expireat key1 <span class="number">1478278200</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ttl key1</span><br><span class="line">(integer) -<span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Spring测试-8"><a href="#Spring测试-8" class="headerlink" title="Spring测试"></a>Spring测试</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(RedisConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">RedisTemplate redisTemplate = (RedisTemplate) applicationContext.getBean(RedisTemplate<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">SessionCallback sessionCallback = <span class="keyword">new</span> SessionCallback() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(RedisOperations redisOperations)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">        redisOperations.boundValueOps(<span class="string">"key1"</span>).set(<span class="string">"value1"</span>);</span><br><span class="line">        String keyValue = (String) redisOperations.boundValueOps(<span class="string">"key1"</span>).get();</span><br><span class="line">        Long expSecond = redisOperations.getExpire(<span class="string">"key1"</span>);</span><br><span class="line">        System.out.println(expSecond);</span><br><span class="line">        <span class="keyword">boolean</span> b = <span class="keyword">false</span>;</span><br><span class="line">        b = redisOperations.expire(<span class="string">"key1"</span>, <span class="number">120L</span>, TimeUnit.SECONDS);</span><br><span class="line">        b = redisOperations.persist(<span class="string">"key1"</span>);</span><br><span class="line">        Long l = <span class="number">0L</span>;</span><br><span class="line">        l = redisOperations.getExpire(<span class="string">"key1"</span>);</span><br><span class="line">        Long now = System.currentTimeMillis();</span><br><span class="line">        Date date = <span class="keyword">new</span> Date();</span><br><span class="line">        date.setTime(now + <span class="number">120000</span>);</span><br><span class="line">        redisOperations.expireAt(<span class="string">"key"</span>, date);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line">redisTemplate.execute(sessionCallback);</span><br></pre></td></tr></tbody></table></figure>

<p>如果key超时了，Redis会回收key的存储空间吗？<br>答案是不会。</p>
<p><strong>Redis的key超时不会被其自动回收，它只会标识哪些键值对超时了。这样做的一个好处在于，如果一个很大的键值对超时，比如一个列表或者哈希结构，存在数以百万个元素，要对其回收需要很长的事件。如果采用超时回收，则可能产生停顿。坏处也很明显，这些超时的键值对会浪费比较多的空间。</strong></p>
<p>Redis提供两种方式回收这些超时键值对：</p>
<ul>
<li>定时回收：指在确定的某个事件触发一段代码，回收超时的键值对</li>
<li>惰性回收则是当一个超时的键，被再次用get命令访问时，将触发Redis将其从内存中清空</li>
</ul>
<h2 id="使用Lua语言"><a href="#使用Lua语言" class="headerlink" title="使用Lua语言"></a>使用Lua语言</h2><p>在Redis的2.6以上版本中，除了可以使用命令外，还可以使用Lua语言操作Redis，从前面的命令可以Redis命令的计算鞥哪里并不算很强大，而使用Lua语言则在很大程度上弥补了Redis的这个不足。只是在Redis中，执行Lua语言是原子性的，这个特性有助于Redis对并发数据一致性的支持。</p>
<h3 id="执行输入Lua程序代码"><a href="#执行输入Lua程序代码" class="headerlink" title="执行输入Lua程序代码"></a>执行输入Lua程序代码</h3><h4 id="一般命令格式"><a href="#一般命令格式" class="headerlink" title="一般命令格式"></a>一般命令格式</h4><p>命令格式：<br><code>eval lua-script key-num [key1 key2 key3 ...] [value1 value2 value3 ...]</code><br>其中：</p>
<ul>
<li>eval代表执行Lua语言的命令</li>
<li>Lua-script代表Lua语言脚本</li>
<li>key-num整数代表参数中有多少个key，需要注意的是Redis中key是从1开始的，如果没有key的参数，那么写0</li>
<li><code>[key1 key2 key3 ...]</code>是key作为参数传递给Lua语言，也可以不填它是key的参数，但是需要和key-num的个数对应起来。</li>
<li><code>[value1 value2 value3 ...]</code>这些参数传递给Lua语言，它们是可填可不填的。</li>
</ul>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Redis</span>&gt;<span class="title">redis</span>-<span class="title">cli.exe</span> -<span class="title">h</span> 127.0.0.1 -<span class="title">p</span> 6379</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">eval</span> "<span class="title">return</span> '<span class="title">hello</span> <span class="title">java</span>'" 0</span></span><br><span class="line"><span class="function">"<span class="title">hello</span> <span class="title">java</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">eval</span> "<span class="title">redis.call</span>('<span class="title">set</span>', <span class="title">keys</span>[1], <span class="title">argv</span>[1])" 1 <span class="title">lua</span>-<span class="title">key</span> <span class="title">lua</span>-<span class="title">value</span></span></span><br><span class="line"><span class="function">(<span class="title">error</span>) <span class="title">ERR</span> <span class="title">Error</span> <span class="title">running</span> <span class="title">script</span> (<span class="title">call</span> <span class="title">to</span> <span class="title">f_5da76ed59a058931c0fc4d6a1aaa4d59bac041ec</span>): @<span class="title">enable_strict_lua</span>:15: <span class="title">user_script</span>:1: <span class="title">Script</span> <span class="title">attempted</span> <span class="title">to</span> <span class="title">access</span> <span class="title">unexisting</span> <span class="title">global</span> <span class="title">variable</span> '<span class="title">keys</span>'</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">eval</span> "<span class="title">redis.call</span>('<span class="title">set</span>', <span class="title">KEYS</span>[1], <span class="title">ARGV</span>[1])" 1 <span class="title">lua</span>-<span class="title">key</span> <span class="title">lua</span>-<span class="title">value</span></span></span><br><span class="line"><span class="function">(<span class="title">nil</span>)</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt; <span class="title">get</span> <span class="title">lua</span>-<span class="title">key</span></span></span><br><span class="line"><span class="function">"<span class="title">lua</span>-<span class="title">value</span>"</span></span><br><span class="line"><span class="function">127.0.0.1:6379&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>设置一个键值对，可以在Lua语言中采用<code>redis.call(command, key[param1, param2...])</code>进行操作，其中：</p>
<ul>
<li>command是命令，包括set、get、del等</li>
<li>Key是被操作的键</li>
<li>param1,param2…代表给key的参数。</li>
</ul>
<p>KEYS[1]代表读取传递给Lua脚本的第一个key参数，而ARGV[1]代表第一个非key参数。</p>
<h4 id="多次执行同一脚本"><a href="#多次执行同一脚本" class="headerlink" title="多次执行同一脚本"></a>多次执行同一脚本</h4><p>有时可能需要多次执行同样一段样本，这个时候可以使用Redis缓存脚本的功能，在Redis中脚本会通过SHA-1签名算法加密脚本，然后返回一个标识字符串，可以通过这个字符串执行加密后的脚本。这样的一个好处在于，如果脚本很长，从客户端传输可能需要很长的时间，那么使用标识字符串，则只需要传递32位字符串即可，这样就能够提高传输的效率，从而提高性能。</p>
<p>首先使用命令：<br><code>script load script</code><br>这个脚本的返回值是一个SHA-1签名过后的标识字符串记为shastring，通过它可以使用命令执行签名后的脚本：<br><code>evalsha shastring keynum [key1 key2 key3 ...] [param1 param2 param3 ...]</code></p>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; script load "redis.<span class="keyword">call</span>('<span class="built_in">set</span>', KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>])"</span><br><span class="line">"<span class="number">27</span>d4ba7a9326bdcdabb271c0771037674735bec2"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; evalsha <span class="number">27</span>d4ba7a9326bdcdabb271c0771037674735bec2 <span class="number">1</span> sha-key val</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get sha-key</span><br><span class="line">"val"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Spring测试-9"><a href="#Spring测试-9" class="headerlink" title="Spring测试"></a>Spring测试</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">RedisTemplate redisTemplate = (RedisTemplate) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line"><span class="comment">//如果是简单的操作，使用原来的Jedis会简单些</span></span><br><span class="line">Jedis jedis = (Jedis) redisTemplate.getConnectionFactory().getConnection().getNativeConnection();</span><br><span class="line"><span class="comment">//执行简单的脚本</span></span><br><span class="line">String helloJava = (String) jedis.eval(<span class="string">"return 'hello java'"</span>);</span><br><span class="line">System.out.println(helloJava);</span><br><span class="line"><span class="comment">//执行带参数的脚本</span></span><br><span class="line">jedis.eval(<span class="string">"redis.call('set', KEYS[1], ARGV[1])"</span>, <span class="number">1</span>, <span class="string">"lua-key"</span>, <span class="string">"lua-value"</span>);</span><br><span class="line">String luaKey = (String) jedis.get(<span class="string">"lua-key"</span>);</span><br><span class="line">System.out.println(luaKey);</span><br><span class="line"><span class="comment">//缓存脚本，返回sha1签名标识</span></span><br><span class="line">String sha1 = jedis.scriptLoad(<span class="string">"redis.call('set', KEYS[1], ARGV[1])"</span>);</span><br><span class="line"><span class="comment">//通过标识执行脚本</span></span><br><span class="line">jedis.evalsha(sha1, <span class="number">1</span>, <span class="keyword">new</span> String[]{<span class="string">"sha-key"</span>, <span class="string">"sha-val"</span>});</span><br><span class="line"><span class="comment">//获取执行脚本后的数据</span></span><br><span class="line">String shaVal = jedis.get(<span class="string">"sha-key"</span>);</span><br><span class="line">System.out.println(shaVal);</span><br><span class="line"><span class="comment">//关闭连接</span></span><br><span class="line">jedis.close();</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hello java</span><br><span class="line">lua-value</span><br><span class="line">sha-val</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext applicationContext = SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">RedisTemplate redisTemplate = (RedisTemplate) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义脚本封装类</span></span><br><span class="line">DefaultRedisScript&lt;Role&gt; redisScript = <span class="keyword">new</span> DefaultRedisScript&lt;&gt;();</span><br><span class="line"><span class="comment">//设置脚本</span></span><br><span class="line">redisScript.setScriptText(<span class="string">"redis.call('set', KEYS[1], ARGV[1]) return redis.call('get', KEYS[1])"</span>);</span><br><span class="line"><span class="comment">//定义操作的key列表</span></span><br><span class="line">List&lt;String&gt; keyList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">keyList.add(<span class="string">"role1"</span>);</span><br><span class="line"><span class="comment">//需要序列化保存和读取的对象</span></span><br><span class="line">Role role = <span class="keyword">new</span> Role();</span><br><span class="line">role.setId(<span class="number">1L</span>);</span><br><span class="line">role.setRoleName(<span class="string">"role_name_1"</span>);</span><br><span class="line">role.setNote(<span class="string">"note_1"</span>);</span><br><span class="line"><span class="comment">//获得标识字符串</span></span><br><span class="line">String sha1 = redisScript.getSha1();</span><br><span class="line">System.out.println(sha1);</span><br><span class="line"><span class="comment">//设置返回结果类型，如果没有这句话，结果返回为空</span></span><br><span class="line">redisScript.setResultType(Role<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//定义序列化器</span></span><br><span class="line">JdkSerializationRedisSerializer serializationRedisSerializer = <span class="keyword">new</span> JdkSerializationRedisSerializer();</span><br><span class="line"><span class="comment">//执行脚本</span></span><br><span class="line"><span class="comment">//第一个是RedisSript接口对象，第二个是参数序列化器</span></span><br><span class="line"><span class="comment">//第三个是结果序列化器，第四个是Redis的key列表，最后是参数列表</span></span><br><span class="line">Role obj = (Role) redisTemplate.execute(redisScript, serializationRedisSerializer, serializationRedisSerializer, keyList, role);</span><br><span class="line"><span class="comment">//打印结果</span></span><br><span class="line">System.out.println(obj);</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aac72bd8699ae9c333eff85158365d7bc61a7177</span><br><span class="line">Role{id=<span class="number">1</span>, roleName=<span class="string">'role_name_1'</span>, note=<span class="string">'note_1'</span>}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="执行Lua文件"><a href="#执行Lua文件" class="headerlink" title="执行Lua文件"></a>执行Lua文件</h3><h4 id="本地测试-9"><a href="#本地测试-9" class="headerlink" title="本地测试"></a>本地测试</h4><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">'set'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>])</span><br><span class="line">redis.call(<span class="string">'set'</span>, KEYS[<span class="number">2</span>], ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">local</span> n1 = <span class="built_in">tonumber</span>(redis.call(<span class="string">'get'</span>, KEYS[<span class="number">1</span>]))</span><br><span class="line"><span class="keyword">local</span> n2 = <span class="built_in">tonumber</span>(redis.call(<span class="string">'get'</span>, KEYS[<span class="number">2</span>]))</span><br><span class="line"><span class="keyword">if</span> n1 &gt; n2 <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span> n1 == n2 <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span> n1 &lt; n2 <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>需要特别注意，键和参数之间需要用逗号隔开，逗号前后必须都有空格！！</strong></p>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Redis</span>&gt;<span class="title">redis</span>-<span class="title">cli</span> --<span class="title">eval</span> <span class="title">test.lua</span> <span class="title">key1</span> <span class="title">key2</span>, 2 4</span></span><br><span class="line"><span class="function">(<span class="title">error</span>) <span class="title">ERR</span> <span class="title">Error</span> <span class="title">running</span> <span class="title">script</span> (<span class="title">call</span> <span class="title">to</span> <span class="title">f_4828d75e6222e1b400c218baa4e772ed333f3ea5</span>): @<span class="title">user_script</span>:5: <span class="title">user_script</span>:5: <span class="title">attempt</span> <span class="title">to</span> <span class="title">compare</span> <span class="title">two</span> <span class="title">nil</span> <span class="title">values</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Redis</span>&gt;<span class="title">redis</span>-<span class="title">cli</span> --<span class="title">eval</span> <span class="title">test.lua</span> <span class="title">key1</span> <span class="title">key2</span>, 2 4</span></span><br><span class="line"><span class="function">(<span class="title">error</span>) <span class="title">ERR</span> <span class="title">Error</span> <span class="title">running</span> <span class="title">script</span> (<span class="title">call</span> <span class="title">to</span> <span class="title">f_979e3d9cc79a6ab54e4f3d653e6cda618bc77b03</span>): @<span class="title">user_script</span>:5: <span class="title">user_script</span>:5: <span class="title">attempt</span> <span class="title">to</span> <span class="title">compare</span> <span class="title">two</span> <span class="title">nil</span> <span class="title">values</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Redis</span>&gt;<span class="title">redis</span>-<span class="title">cli</span> --<span class="title">eval</span> <span class="title">test.lua</span> <span class="title">key1</span> <span class="title">key2</span> 2 4</span></span><br><span class="line"><span class="function">(<span class="title">error</span>) <span class="title">ERR</span> <span class="title">Error</span> <span class="title">running</span> <span class="title">script</span> (<span class="title">call</span> <span class="title">to</span> <span class="title">f_979e3d9cc79a6ab54e4f3d653e6cda618bc77b03</span>): @<span class="title">user_script</span>:5: <span class="title">user_script</span>:5: <span class="title">attempt</span> <span class="title">to</span> <span class="title">compare</span> <span class="title">two</span> <span class="title">nil</span> <span class="title">values</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Redis</span>&gt;<span class="title">redis</span>-<span class="title">cli</span> --<span class="title">eval</span> <span class="title">test.lua</span> <span class="title">key1</span> <span class="title">key2</span> , 2 4</span></span><br><span class="line"><span class="function">(<span class="title">integer</span>) 2</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="Spring测试-10"><a href="#Spring测试-10" class="headerlink" title="Spring测试"></a>Spring测试</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">    ApplicationContext applicationContext = SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    RedisTemplate redisTemplate = (RedisTemplate) applicationContext.getBean(<span class="string">"redisTemplate"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读入文件流</span></span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">"C:\\Program Files\\Redis\\test.lua"</span>);</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = getFileToByte(file);</span><br><span class="line">    Jedis jedis = (Jedis) redisTemplate.getConnectionFactory().getConnection().getNativeConnection();</span><br><span class="line">    <span class="comment">//发送文件二进制给Redis，这样Redis就会返回sha1标识</span></span><br><span class="line">    <span class="keyword">byte</span>[] sha1 = jedis.scriptLoad(bytes);</span><br><span class="line">    <span class="comment">//使用返回的标识执行，其中第二个参数2，表示使用2个键</span></span><br><span class="line">    <span class="comment">//而后面的字符串都转化为了二进制字节进行传输</span></span><br><span class="line">    Object obj = jedis.evalsha(sha1, <span class="number">2</span>, <span class="string">"key1"</span>.getBytes(), <span class="string">"key2"</span>.getBytes(), <span class="string">"2"</span>.getBytes(), <span class="string">"4"</span>.getBytes());</span><br><span class="line">    System.out.println(obj);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getFileToByte(File file){</span><br><span class="line">    <span class="keyword">byte</span>[] by = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>)file.length()];</span><br><span class="line">    <span class="keyword">try</span>{</span><br><span class="line">        InputStream is = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        ByteArrayOutputStream bytestream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] bb = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">        <span class="keyword">int</span> ch;</span><br><span class="line">        ch = is.read(bb);</span><br><span class="line">        <span class="keyword">while</span>(ch != -<span class="number">1</span>){</span><br><span class="line">            bytestream.write(bb, <span class="number">0</span>, ch);</span><br><span class="line">            ch = is.read(bb);</span><br><span class="line">        }</span><br><span class="line">        by = bytestream.toByteArray();</span><br><span class="line">    }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> by;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="Redis配置"><a href="#Redis配置" class="headerlink" title="Redis配置"></a>Redis配置</h1></blockquote>
<h2 id="Redis基础配置文件"><a href="#Redis基础配置文件" class="headerlink" title="Redis基础配置文件"></a>Redis基础配置文件</h2><ul>
<li>Windows系统，默认的配置文件就是redis.window.conf;</li>
<li>Linux系统，则是redis.conf</li>
</ul>
<h2 id="Redis备份（持久化）"><a href="#Redis备份（持久化）" class="headerlink" title="Redis备份（持久化）"></a>Redis备份（持久化）</h2><p>Redis中存在两种方式的备份：</p>
<ul>
<li>快照（snapshotting），它是备份当前瞬间Redis在内存中的数据记录；</li>
<li>只追加文件（Append-Only File， AOF），其作用就是当Redis执行写命令后，在一定的条件下降执行过的写命令依次保存在Redis的文件中，将来就可以依次执行那些保存的命令恢复Redis的数据了。</li>
</ul>
<p>（1）对于快照备份而言，如果当前Reids的数据量大，备份可能造成Redis卡顿，但是恢复重启比较快速。<br>（2）对于AOF备份而言，它只是追加写入命令，所以备份一般不会造成Redis卡顿，但是恢复重启要执行更多的命令，备份文件可能也很大，使用者使用的时候需要注意。</p>
<p>Redis中允许使用其中的一种、同时使用两种，或者两种都不用。</p>
<h3 id="快照模式的配置项"><a href="#快照模式的配置项" class="headerlink" title="快照模式的配置项"></a>快照模式的配置项</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></tbody></table></figure>
<p>配置项的含义：</p>
<ul>
<li>当900秒执行1个写命令时，启用快照备份；</li>
<li>当300秒执行10个写命令时，启用快照备份；</li>
<li>当60秒内执行10000个写命令时，启用快照备份</li>
</ul>
<p>Redis执行save命令的时候，将禁止写入命令</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop-writes-on-bgsave-error yes</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>bgsave</code>命令，它是一个异步保存命令，也就是系统将启动另外一条进程，把Redis的数据保存到对应的数据文件中。它和save命令最大的不同是它不会阻塞客户端的写入，也就是在执行bgsave的时候，允许客户端继续读/写Redis。</li>
<li>在默认情况下，如果Redis执行bgsave失败后，Redis将停止接受写操作，这样以一种强硬的方式让用户知道数据不能正确的持久化到磁盘，否则就会没人注意到灾难的发生；</li>
<li>如果后台保存进程重新启动工作了，Redis也将自动允许写操作。</li>
<li>然而如果安装了靠谱的监控，可能不希望Redis这样做，可以将其修改为no</li>
</ul>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdbchecksum yes</span><br></pre></td></tr></tbody></table></figure>
<p>这个命令的意思是是否对rdb文件进行检验</p>
<p>rdb文件实际是Redis持久化的数据文件，当采用快照模式备份时，Redis将使用它保存数据，将来可以使用它恢复数据</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbfilename dump.rdb</span><br></pre></td></tr></tbody></table></figure>

<h3 id="只追加文件模式的配置项"><a href="#只追加文件模式的配置项" class="headerlink" title="只追加文件模式的配置项"></a>只追加文件模式的配置项</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendonly no</span><br></pre></td></tr></tbody></table></figure>
<p>如果appendonly配置为no，则不启用AOF方式进行备份。如果appendonly配置为yes，则以AOF方式备份Redis数据，那么此时Redis会按照配置，在特定的时候执行追加命令，用以备份数据。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendfilename "appendonly.aof"</span><br></pre></td></tr></tbody></table></figure>
<p>这里定义追加的写入文件为appendonly.aof，采用AOF追加文件备份的时候命令都会写到这里。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># appendfsync always</span><br><span class="line">appendfsync everysec</span><br><span class="line"># appendfsync no</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>AOF文件和Redis命令是同步频率的，假设配置为always，其含义为当Redis执行命令的时候，则同时同步到AOF文件，这样会使得Redis同步刷新AOF文件，造成缓慢。</li>
<li>而采用everysec则代表每秒同步一次命令到AOF文件。</li>
<li>采用no的时候，则由客户端调用命令执行备份，Redis本身不备份文件。</li>
<li>对于always配置的时候，每次命令都会持久化，它的好处在于安全，坏处在于每次都持久化性能较差。</li>
<li>采用everysec的安全性不如always，别分可能会丢失一秒以内的命令，但是银行也不大，安全度上课，性能可以得到保障。</li>
<li>采用no，则性能有所保障，但是由于失去备份，所以安全性比较差。</li>
<li>建议采用默认配置everysec</li>
</ul>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no-appendfsync-on-rewrite no</span><br></pre></td></tr></tbody></table></figure>
<p>它指定是否在后台AOF文件rewrite（重写）期间调用fsync，默认为no，表示要调用fsync（无论后台是否有子进程在刷盘）。Redis在后台写RDB文件或重写AOF文件期间会存在大量磁盘I/O，此时，在某些Linux系统中，调用fsync可能会阻塞。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto-aof-rewrite-percentage 100</span><br></pre></td></tr></tbody></table></figure>
<p>它指定Redis重写AOF文件的条件，默认为100，表示与上次rewrite的AOF文件大小相比，当前AOF文件增长量超过上次AOF文件大小的100%时，就会触发background rewrite。若配置为0，则会禁用自动rewrite。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto-aof-rewrite-min-size 64mb</span><br></pre></td></tr></tbody></table></figure>
<p>它指定触发rewrite的AOF文件大小。若AOF文件小于该值，即使当前文件的增量比例达到auto-aof-rewrite-percentage的配置值，也不会触发自动rewrite。即这两个配置项同时满足时，才会触发rewrite。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aof-load-truncated yes</span><br></pre></td></tr></tbody></table></figure>
<p>Redis在恢复时会忽略最后一条可能存在问题的指令，默认为yes。即在AOF写入时，可能存在指令写错的问题（突然断电、写了一半），这种情况下yes会log并继续，而no会直接恢复失败。</p>
<h2 id="Redis内存回收策略"><a href="#Redis内存回收策略" class="headerlink" title="Redis内存回收策略"></a>Redis内存回收策略</h2><p>Redis也会因为内存不足而产生错误，也可能因为回收过久而导致系统长期的停顿，因此掌握执行回收策略十分有必要。在Redis的配置文件中，当Redis的内存达到规定的最大值时，允许配置6种策略中的一种进行淘汰键值，并且将一些键值对进行回收。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># volatile-lru -&gt; Evict using approximated LRU. only keys with an expire set.</span><br><span class="line"># allkeys-lru -&gt; Evict any key using approximated LRU.</span><br><span class="line"># volatile-lfu -&gt; Evict using approximated LFU, only keys with an expire set.</span><br><span class="line"># allkeys-lfu -&gt; Evict any key using approximated LFU.</span><br><span class="line"># volatile-random -&gt; Remove a random key having an expire set.</span><br><span class="line"># allkeys-random -&gt; Remove a random key, any key.</span><br><span class="line"># volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</span><br><span class="line"># noeviction -&gt; Don't evict anything, just return an error on write operations.</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>volatile-lru：采用最近使用最少的淘汰策略，Redis将回收那些超时的（仅仅是超时的）键值对，也就是它只淘汰那些超时的键值对；</li>
<li>allkeys-lru：采用淘汰最少使用的策略，Redis将对所有的（不仅仅是超时的）键值对采用最近使用最少的淘汰策略；</li>
<li>volatile-random： 采用随机淘汰策略删除超时的（仅仅是超时的）键值对；</li>
<li>allkeys-random：采用随机淘汰策略删除所有的（不仅仅是超时的）键值对，这个策略不常用；</li>
<li>volatile-ttl：采用删除存货时间最短的键值对策略；</li>
<li>noeviction：根本就不淘汰任何键值对，当内存已满时，如果做读操作，例如get命令，它将正常工作，而做些操作，它将返回错误。也就是说，当Redis采用这个策略内存达到最大的时候，它就只能读不能写了。</li>
</ul>
<p>Redis在默认情况下会曹勇noeviction策略。换句话说，如果内存已满，则不再提供写入操作，而只提供读取操作。显然这往往并不能满足我们的要求，因为对于互联网系统而言，常常会涉及数以百万甚至更多的用户，所以往往需要设置回收策略。</p>
<p>注意：LRU算法或者TTL算法都不是很精确算法，而是一个近似算法。Redis不会通过对全部的键值对进行比较来确定最精确的时间值，从而确定删除哪个键值对，因为这将消耗太多的时间，导致回收垃圾执行的时间太长，造成服务停顿。而在Redis的默认配置文件中，存在着参数<code>maxmemory-samples</code>，它的默认值为3，假设采取了volatile-ttl算法：</p>
<p>假设当前有5个即将超时的键值对：</p>
<table>
<thead>
<tr>
<th align="left">键值对</th>
<th align="left">剩余超时秒数</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">A1</td>
<td align="left">6</td>
<td align="left">属于探测样本</td>
</tr>
<tr>
<td align="left">A2</td>
<td align="left">3</td>
<td align="left">属于探测样本中最短值，因此最先删除</td>
</tr>
<tr>
<td align="left">A3</td>
<td align="left">4</td>
<td align="left">属于探测样本</td>
</tr>
<tr>
<td align="left">A4</td>
<td align="left">1</td>
<td align="left">最短值，但是它不属于探测样本，所以没有最先删除</td>
</tr>
<tr>
<td align="left">A5</td>
<td align="left">9</td>
<td align="left">但不属于样本</td>
</tr>
</tbody></table>
<p>由于配置maxmemory-samples的值为3，如果Redis是按表中的顺序探测，那么它只会取到样本A1、A2、A3，然后进行比较，因为A2国企剩余秒数最少，所以决定淘汰A2，因此A2是最先被删除的。注意，此时即将过期且剩余超时秒数最短的A4却还在内存中，因为它不属于探测样本。这就是Redis中采用的近似算法。当设置maxmemory-samples越大，则Redis删除的就越精确，但是与此同时带来不利的是，Redis也就需要花更多的事件去计算和匹配更为精确的值。</p>
<p>回收超时策略的缺点是必须指明超时的键值对，这会给程序开发带来一些设置超时的代码，无疑增加了开发者的工作量。对所有的键值对进行回收，有可能把正在使用的键值对删掉，增加了存储的不稳定性。对于垃圾回收的策略，还需要注意的是回收的时间，因为在Redis对垃圾的回收期间，会造成系统缓慢。因此，控制其回收时间有一定好处，只是这个时间不能过短或过长。过短则会造成回收次数过于频繁，过长则导致系统单次垃圾回收停顿时间过长，都不利于系统的稳定性，这些都需要设计者在实际的工作中进行思考。</p>
<h2 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h2><p>尽管Redis的性能很好，但是有时候依旧满足不了应用的需要，比如过多的用户进入主页，导致Redis被频繁访问，此时就存在大量的读操作。对于一些热门网站的某个时刻（比如促销商品的时候）每秒成千上万的请求是司空见惯的，这个时候大量的读操作就会到达Redis服务器，触发许许多多的操作，显然单靠一台Redis服务器是完全不够用的。一些服务网站对安全性有较高的要求，当主服务器不能正常工作的时候，也需要从服务器代替原来的主服务器，作为灾备，以保证系统可以继续正常的工作。因此更多的时候我们更希望可以读/写分离，读/写分离的前提是读操作远远比写操作频繁得多，如果把数据都存放在多台服务器上那么就可以从多台服务器中读取数据，从而消除了单台服务器的压力，读/写分离的技术已经广泛用于数据库中了。</p>
<h3 id="主从同步基本概念"><a href="#主从同步基本概念" class="headerlink" title="主从同步基本概念"></a>主从同步基本概念</h3><p>主从架构设计的思路大概是：</p>
<ul>
<li>在多台数据服务器中，只有一台主服务器，而主服务器只负责写入数据，不负责让外部程序读取数据；</li>
<li>存在多台从服务器，从服务器不写入数据，只负责同步主服务器的数据，并让外部程序读取数据；</li>
<li>主服务器在写入数据后，即刻将写入数据的命令发送给从服务器，从而使得主从数据同步；</li>
<li>应用程序可以随机读取某一台从服务器的数据，这样就分摊了读数据的压力；</li>
<li>当从服务器不能工作的时候，整个系统将不受影响；当主服务器不能工作的时候，可以方便地从服务器中选举一台来当主服务器。</li>
</ul>
<h3 id="Redis主从同步配置"><a href="#Redis主从同步配置" class="headerlink" title="Redis主从同步配置"></a>Redis主从同步配置</h3><p>对Redis进行主从同步的配置分为主机与从机，主机是一台，而从机可以是多台。<br>（1）首先，明确主机。当确定哪台机子是主机的时候，关键的两个配置时<code>dir</code>和<code>dbfilename</code>选项，当然必须保证这两个文件时可写的。对于Redis的默认配置而言，dir的默认值为<code>./</code>，而对于dbfilename的默认值为<code>dump.rbd</code>。换句话说，默认采用Redis当前的目录的dump.rdb文件进行同步。<br>（2）其次，在明确了从机之后，进行进一步配置所要关注的只有<code>replicaof</code>这个配置选项，它的配置格式为：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>其中，masterip代表主机，port代表端口。<br>当从机Redis服务重启时，就会同步对应主机的数据了。当不想让从机继续复制主机的数据时，可以在从机的Redis命令客户端发送<code>slaveof no one</code>命令，这样从机就不会再接收主服务器的数据更新了。又或者原来主服务器已经无法工作了，而你可能需要去复制新的主机，这个时候执行<code>slaveof server port</code>就能让从机复制另外一台主机的数据了。<br>（3）在实际的Linux环境中，配置文件<code>redis.conf</code>中还有一个<code>bind</code>的配置，默认为<code>127.0.0.1</code>，也就是只允许本机访问，把它修改为<code>bind 0.0.0.0</code>，其他的服务器就能够访问了。<code>bing</code>是绑定本机的IP地址，<code>port</code>绑定端口，允许其他人访问该IP的端口进行redis连接。</p>
<h3 id="Redis主从同步的过程"><a href="#Redis主从同步的过程" class="headerlink" title="Redis主从同步的过程"></a>Redis主从同步的过程</h3><p>略，详见书。</p>
<h2 id="哨兵（Sentinel）模式"><a href="#哨兵（Sentinel）模式" class="headerlink" title="哨兵（Sentinel）模式"></a>哨兵（Sentinel）模式</h2><ul>
<li>主从切换技术的方法是：当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，既费时费力，还回造成一段时间内服务不可用，这不是一种推荐的方式。</li>
<li>更多时候，优先考虑哨兵模式，它是当前企业应用的主流方式。</li>
</ul>
<h3 id="哨兵模式概述"><a href="#哨兵模式概述" class="headerlink" title="哨兵模式概述"></a>哨兵模式概述</h3><p>Redis可以存在多台服务器，并且实现了主从复制的功能。哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例。</p>
<p>哨兵的两个作用：</p>
<ul>
<li>通过发送命令，让Redis服务器返回检测其运行状态，包括主服务器核从服务器；</li>
<li>当哨兵检测到master宕机，会自动将slave切换成master，然后通过发布订阅模式通知到其他的从服务器，修改配置文件，让它们切换主机；</li>
</ul>
<p>现实中只是一个哨兵进程对Redis服务器进行监控，也可能出现问题，为了处理这个问题，还可以使用多个哨兵的监控，而各个哨兵之间还会相互监控，这样就变为了多个哨兵模式。多个哨兵不仅监控各个Redis服务器，而且哨兵之间相互监控，看看哨兵们是否还“活”着。</p>
<p>故障切换（failover）的过程：假设主服务器宕机，哨兵1先检测到这个结果，当时系统并不会马上进行failover操作，而仅仅是哨兵1主观地认为主机已经不可用，这个现象被称为主观下线。当后面的哨兵也监测到了主服务器不可用，并且有了一定数量的哨兵认为主服务器不可用，那么哨兵之间就会形成一次投票，投票的结果由一个哨兵发起，进行failover操作，在failover操作的过程中切换成功后，就会通过发布订阅方式，让各个哨兵把自己监控的服务器实现切换主机，这个过程被称为客观下线。这样对于客户端而言，一切都是透明的。</p>
<h3 id="搭建哨兵模式"><a href="#搭建哨兵模式" class="headerlink" title="搭建哨兵模式"></a>搭建哨兵模式</h3><p>略，以后用到了再来搞。</p>
<blockquote>
<h1 id="Spring缓存机制和Redis的结合"><a href="#Spring缓存机制和Redis的结合" class="headerlink" title="Spring缓存机制和Redis的结合"></a>Spring缓存机制和Redis的结合</h1></blockquote>
<h2 id="Redis和数据库的结合"><a href="#Redis和数据库的结合" class="headerlink" title="Redis和数据库的结合"></a>Redis和数据库的结合</h2><h3 id="Redis和数据库读操作"><a href="#Redis和数据库读操作" class="headerlink" title="Redis和数据库读操作"></a>Redis和数据库读操作</h3><p>数据缓存往往会在Redis上设置超时时间，当设置Redis的数据超时后，Redis就没法读出数据了，这个时候就会触发程序读取数据库，然后将读取的数据库数据写入Redis（此时会给Redis重设超时时间），这样程序在读取的过程中就能按一定的时间间隔刷新数据了。</p>
<p>伪代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DataObject <span class="title">readMethod</span><span class="params">(args)</span></span>{</span><br><span class="line">  <span class="comment">//尝试从Redis中读取数据</span></span><br><span class="line">  DataObject dataObject = getRedis(key);</span><br><span class="line">  <span class="keyword">if</span>(data != <span class="keyword">null</span>){ <span class="comment">//读取数据返回为空，失败</span></span><br><span class="line">    <span class="comment">//从数据库中读取数据</span></span><br><span class="line">    data = getFromDataBase();</span><br><span class="line">    <span class="comment">//重新写入Redis，以便以后读出</span></span><br><span class="line">    writeRedis(key, data);</span><br><span class="line">    <span class="comment">//设置Redis的超时时间为5分钟</span></span><br><span class="line">    setRedisExpire(key, <span class="number">5</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Redis和数据库写操作"><a href="#Redis和数据库写操作" class="headerlink" title="Redis和数据库写操作"></a>Redis和数据库写操作</h3><ul>
<li>写操作要考虑数据一致的问题，尤其是那些重要的业务数据。</li>
<li>写入业务数据，先从数据库中读取最新数据，然后进行业务操作，更新业务数据到数据库后，再将数据刷新到Redis缓存中，这样就完成了一次写操作。这样的操作就能避免将脏数据写入数据库汇总，这类问题在操作时要注意。</li>
</ul>
<p>伪代码</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DataObject <span class="title">writeMethod</span><span class="params">(args)</span></span>{</span><br><span class="line">  <span class="comment">//从数据库里读取最新数据</span></span><br><span class="line">  DataObject dataObject = getFromDataBase(args);</span><br><span class="line">  <span class="comment">//执行业务逻辑</span></span><br><span class="line">  ExecLogic(dataObject);</span><br><span class="line">  <span class="comment">//更新数据库数据</span></span><br><span class="line">  updateDataBase(dataObject);</span><br><span class="line">  <span class="comment">//刷新Redis缓存</span></span><br><span class="line">  updateRedisData(dataObject);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="使用Spring缓存机制整合Redis"><a href="#使用Spring缓存机制整合Redis" class="headerlink" title="使用Spring缓存机制整合Redis"></a>使用Spring缓存机制整合Redis</h2><h3 id="准备测试环境"><a href="#准备测试环境" class="headerlink" title="准备测试环境"></a>准备测试环境</h3><h4 id="配置MySQL和Redis以及Spring-Cache配置"><a href="#配置MySQL和Redis以及Spring-Cache配置" class="headerlink" title="配置MySQL和Redis以及Spring Cache配置"></a>配置MySQL和Redis以及Spring Cache配置</h4><h5 id="配置文件配置方式（推荐）"><a href="#配置文件配置方式（推荐）" class="headerlink" title="配置文件配置方式（推荐）"></a>配置文件配置方式（推荐）</h5><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8081</span></span><br><span class="line"><span class="comment"># 设置连接数据库的信息</span></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/ssm?useUnicode=true&amp;characterEncoding=UTF-8&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.datasource.type</span>=<span class="string">org.apache.commons.dbcp2.BasicDataSource</span></span><br><span class="line"><span class="meta">spring.datasource.dbcp2.max-idle</span>=<span class="string">10</span></span><br><span class="line"><span class="meta">spring.datasource.dbcp2.max-total</span>=<span class="string">50</span></span><br><span class="line"><span class="meta">spring.datasource.dbcp2.max-wait-millis</span>=<span class="string">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定MyBatis映射文件的路径</span></span><br><span class="line"><span class="meta">mybatis.mapper-locations</span>=<span class="string">classpath:mapper/*.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 配置logback配置文件的属性</span></span><br><span class="line"><span class="meta">logback.path</span>=<span class="string">D:/</span></span><br><span class="line"><span class="meta">logback.serviceName</span>=<span class="string">myService</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置视图解析器</span></span><br><span class="line"><span class="meta">spring.mvc.view.prefix</span>=<span class="string">/</span></span><br><span class="line"><span class="meta">spring.mvc.view.suffix</span>=<span class="string">.jsp</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置上传文件</span></span><br><span class="line"><span class="comment"># 是否开启文件上传支持</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 文件写入磁盘阈值</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.file-size-threshold</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># 文件上传临时保存位置</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.location</span>=<span class="string">D:\\JavaTest\\upload</span></span><br><span class="line"><span class="comment"># 单个文件上传的最大大小</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.max-file-size</span>=<span class="string">5MB</span></span><br><span class="line"><span class="comment"># 多个文件上传的最大大小</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.max-request-size</span>=<span class="string">10MB</span></span><br><span class="line"><span class="comment"># 文件是否延迟解析</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.resolve-lazily</span>=<span class="string">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置redis</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库池设置</span></span><br><span class="line"><span class="comment"># 最大空闲数</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-idle</span>=<span class="string">50</span></span><br><span class="line"><span class="comment"># 最大连接数</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-active</span>=<span class="string">8</span></span><br><span class="line"><span class="comment"># 连接池最大阻塞等待时间</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-wait</span>=<span class="string">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Spring缓存</span></span><br><span class="line"><span class="comment"># 如果由底层的缓存管理器支持创建，以逗号分隔的列表缓存名称</span></span><br><span class="line"><span class="meta">spring.cache.cache-names</span>=<span class="string">redisCache</span></span><br><span class="line"><span class="comment">## caffeine缓存配置细节</span></span><br><span class="line"><span class="comment">#spring.cache.caffeine.spec=</span></span><br><span class="line"><span class="comment">## couchbase缓存超时时间，默认是永不超时</span></span><br><span class="line"><span class="comment">#spring.cache.couchbase.expiration=0ms</span></span><br><span class="line"><span class="comment">## 配置encache缓存初始化文件路径</span></span><br><span class="line"><span class="comment">#spring.cache.ehcache.config=</span></span><br><span class="line"><span class="comment">## infinispan缓存配置文件</span></span><br><span class="line"><span class="comment">#spring.cache.infinispan.config=</span></span><br><span class="line"><span class="comment">## jcache缓存配置文件</span></span><br><span class="line"><span class="comment">#spring.cache.jcache.config=</span></span><br><span class="line"><span class="comment">## jcache缓存提供者配置</span></span><br><span class="line"><span class="comment">#spring.cache.jcache.provider=</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Redis缓存管理器</span></span><br><span class="line"><span class="comment"># 是否允许Redis缓存空值</span></span><br><span class="line"><span class="meta">spring.cache.redis.cache-null-values</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># Redis的键前缀</span></span><br><span class="line"><span class="meta">spring.cache.redis.key-prefix</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 缓存超时时间戳，配置为0则不设置超时时间</span></span><br><span class="line"><span class="meta">spring.cache.redis.time-to-live</span>=<span class="string">60000ms</span></span><br><span class="line"><span class="comment"># 是否启用Redis的键前缀</span></span><br><span class="line"><span class="meta">spring.cache.redis.use-key-prefix</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 缓存类型，在默认的情况下，Spring会自动根据上下文探测</span></span><br><span class="line"><span class="meta">spring.cache.type</span>=<span class="string">redis</span></span><br></pre></td></tr></tbody></table></figure>

<h5 id="配置类自定义配置缓存管理器配置方式"><a href="#配置类自定义配置缓存管理器配置方式" class="headerlink" title="配置类自定义配置缓存管理器配置方式"></a>配置类自定义配置缓存管理器配置方式</h5><p>有时候，在自定义时可能存在比较多的设置，也可以不采用Spring Boot自动配置的缓存管理器，而是使用自定义的缓存管理器，这也是没有问题的。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.utils.RedisMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.CacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.task.TaskExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheWriter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.jedis.JedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.ChannelTopic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.RedisMessageListenerContainer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.Topic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.JdkSerializationRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> javax.xml.crypto.Data;</span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = <span class="string">"com.louris.springboot.utils"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"poolConfig"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisPoolConfig <span class="title">getPoolConfig</span><span class="params">()</span></span>{</span><br><span class="line">        JedisPoolConfig poolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        <span class="comment">//最大空闲数</span></span><br><span class="line">        poolConfig.setMaxIdle(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">//最大连接数</span></span><br><span class="line">        poolConfig.setMaxTotal(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">//最大等待时间</span></span><br><span class="line">        poolConfig.setMaxWaitMillis(<span class="number">20000</span>);</span><br><span class="line">        <span class="keyword">return</span> poolConfig;</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"connectionFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">getJedisConnectionFactory</span><span class="params">()</span></span>{</span><br><span class="line">        JedisConnectionFactory factory = <span class="keyword">new</span> JedisConnectionFactory(getPoolConfig());</span><br><span class="line">        factory.setHostName(<span class="string">"localhost"</span>);</span><br><span class="line">        factory.setPort(<span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//factory.setPassword("123456");</span></span><br><span class="line">        factory.afterPropertiesSet(); <span class="comment">//调用后初始化方法，没有它将抛出异常</span></span><br><span class="line">        <span class="comment">//factory.setPoolConfig(getPoolConfig());</span></span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"jdkSerializationRedisSerializer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdkSerializationRedisSerializer <span class="title">getJdkRedisSerializer</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdkSerializationRedisSerializer();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"stringRedisSerializer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> StringRedisSerializer <span class="title">getStringRedisSerializer</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, String&gt; <span class="title">getRedisTemplate</span><span class="params">()</span></span>{</span><br><span class="line">        RedisTemplate&lt;String, String&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        <span class="comment">//设置连接工程</span></span><br><span class="line">        redisTemplate.setConnectionFactory(getJedisConnectionFactory());</span><br><span class="line">        <span class="comment">//设置序列化器</span></span><br><span class="line">        redisTemplate.setDefaultSerializer(getStringRedisSerializer());</span><br><span class="line">        redisTemplate.setKeySerializer(getStringRedisSerializer());</span><br><span class="line">        redisTemplate.setValueSerializer(getJdkRedisSerializer());</span><br><span class="line">        redisTemplate.setHashKeySerializer(getStringRedisSerializer());</span><br><span class="line">        redisTemplate.setHashValueSerializer(getJdkRedisSerializer());</span><br><span class="line">        redisTemplate.setEnableTransactionSupport(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"redisCacheManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">initRedisCacheManager</span><span class="params">(@Autowired RedisTemplate redisTemplate)</span></span>{</span><br><span class="line">        RedisCacheWriter writer = RedisCacheWriter.lockingRedisCacheWriter(getJedisConnectionFactory());</span><br><span class="line">        <span class="comment">//启动Redis缓存的默认设置</span></span><br><span class="line">        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line">        <span class="comment">//设置JDK序列化器</span></span><br><span class="line">        config = config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(getJdkRedisSerializer()));</span><br><span class="line">        <span class="comment">//禁用前缀</span></span><br><span class="line">        config = config.disableKeyPrefix();</span><br><span class="line">        <span class="comment">//设置1min超时</span></span><br><span class="line">        config = config.entryTtl(Duration.ofSeconds(<span class="number">60</span>));</span><br><span class="line">        <span class="comment">//创建Redis缓存管理器</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheManager(writer, config);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"taskExecutor"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">getExecutor</span><span class="params">()</span></span>{</span><br><span class="line">        ThreadPoolTaskExecutor taskExecutor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        taskExecutor.setCorePoolSize(<span class="number">20</span>);</span><br><span class="line">        <span class="keyword">return</span> taskExecutor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisMessageListener listener = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"topicContainer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title">getContainer</span><span class="params">()</span></span>{</span><br><span class="line">        RedisMessageListenerContainer container = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line">        container.setConnectionFactory(getJedisConnectionFactory());</span><br><span class="line">        container.setTaskExecutor(getExecutor());</span><br><span class="line">        ChannelTopic channelTopic = <span class="keyword">new</span> ChannelTopic(<span class="string">"chat"</span>);</span><br><span class="line">        container.addMessageListener(listener, channelTopic);</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="POJO-1"><a href="#POJO-1" class="headerlink" title="POJO"></a>POJO</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.beans.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Scope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(value = <span class="string">"role"</span>)</span><br><span class="line"><span class="comment">//@Scope(value = "prototype")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVerionsUID = <span class="number">6977402643848374753L</span>;</span><br><span class="line">    <span class="comment">//@Value("#{1}")</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">//@Value("#{'role_name_1'}")</span></span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="comment">//@Value("#{'role_note_1'}")</span></span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Role</span><span class="params">()</span></span>{}</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Role</span><span class="params">(Long id, String roleName, String note)</span></span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoleName</span><span class="params">(String roleName)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.roleName = roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.note = note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoleName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> note;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Role{"</span> +</span><br><span class="line">                <span class="string">"id="</span> + id +</span><br><span class="line">                <span class="string">", roleName='"</span> + roleName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", note='"</span> + note + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'}'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="RoleMapper-xml-2"><a href="#RoleMapper-xml-2" class="headerlink" title="RoleMapper.xml"></a>RoleMapper.xml</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.louris.springboot.IoCImpl.mapper.RoleDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">resultType</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span>&gt;</span></span><br><span class="line">        select id, role_name as roleName, note from t_role where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteRole"</span>&gt;</span></span><br><span class="line">        delete from t_role where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        insert into t_role(role_name, note) values(#{roleName}, #{note})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateRole"</span> <span class="attr">parameterType</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span>&gt;</span></span><br><span class="line">        update t_role set role_name = #{roleName}, note = #{note} where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles"</span> <span class="attr">resultType</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.Role"</span>&gt;</span></span><br><span class="line">        select id, role_name as roleName, note from t_role</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"roleName != null"</span>&gt;</span></span><br><span class="line">                role_name like concat('%', #{roleName}, '%')</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"note != null"</span>&gt;</span></span><br><span class="line">                note like concat('%', #{note}, '%')</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="RoleData持久层接口"><a href="#RoleData持久层接口" class="headerlink" title="RoleData持久层接口"></a>RoleData持久层接口</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleDao</span> </span>{</span><br><span class="line">    <span class="function">Role <span class="title">getRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findRoles</span><span class="params">(@Param(<span class="string">"roleName"</span>)</span> String roleName, @<span class="title">Param</span><span class="params">(<span class="string">"note"</span>)</span> String note)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="RoleService服务接口"><a href="#RoleService服务接口" class="headerlink" title="RoleService服务接口"></a>RoleService服务接口</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleService</span> </span>{</span><br><span class="line">    <span class="function">Role <span class="title">getRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function">Role <span class="title">insertRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateRole</span><span class="params">(Role role)</span></span>;</span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findRoles</span><span class="params">(String roleName, String note)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="缓存注解简介"><a href="#缓存注解简介" class="headerlink" title="缓存注解简介"></a>缓存注解简介</h3><table>
<thead>
<tr>
<th align="left">注解</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">@Cacheable</td>
<td align="left">表明在进入方法之前，Spring会先去缓存服务器中查找对应key的缓存值，如果找到缓存值，那么Spring将不会再调用方法，而是将缓存值读出，返回给调用者；如果找到缓存值，那么Spring就会执行你的方法，将最后的结果通过key保存到缓存服务器中</td>
</tr>
<tr>
<td align="left">@CachePut</td>
<td align="left">Spring会将该方法返回的值缓存到缓存服务器中，这里需要注意的是，Spring不会事先去缓存服务器中查找，而是直接执行方法，然后缓存。换句话说，该方法始终会被Spring所调用</td>
</tr>
<tr>
<td align="left">@CacheEvict</td>
<td align="left">移除缓存对应的key的值</td>
</tr>
<tr>
<td align="left">@Caching</td>
<td align="left">这是一个分组注解，它能够同时应用于其他缓存的注解</td>
</tr>
</tbody></table>
<ul>
<li>注解@Cacheable和@CachePut都可以保存缓存键值对，只是它们的方式略有不同，请注意二者的区别，它们只能运用于有返回值的方法中，而删除缓存key的@CacheEvict则可以用在void的方法上，因为它并不需要去保存任何值</li>
<li>上述注解都能标注到类或者方法之上，如果放到类上，则对所有的方法都有效；如果放到方法上，则只是对方法有效。</li>
<li>在大部分情况下，会放置到方法上。因为@Cacheable和@CachePut可以配置的属性接近，所以把它们归为一类去介绍，而@Caching因为不常用，就不介绍了。</li>
<li>一般而言，对于查询，我们会考虑使用@Cacheable；对于插入和修改，我们会考虑使用@CachePut；对于删除操作，我们会考虑使用@CacheEvict；</li>
</ul>
<h3 id="注解-Cacheable和-CachePut"><a href="#注解-Cacheable和-CachePut" class="headerlink" title="注解@Cacheable和@CachePut"></a>注解@Cacheable和@CachePut</h3><table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">配置类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">value</td>
<td align="left">String[]</td>
<td align="left">使用缓存的名称</td>
</tr>
<tr>
<td align="left">condition</td>
<td align="left">String</td>
<td align="left">Spring表达式，如果表达式返回值为false，则不会将缓存应用到方法上，true则会</td>
</tr>
<tr>
<td align="left">key</td>
<td align="left">String</td>
<td align="left">Spring表达式，可以通过它来计算对应缓存的key</td>
</tr>
<tr>
<td align="left">unless</td>
<td align="left">String</td>
<td align="left">Spring表达式，如果表达式返回值为true，则不会将方法的结果方挂到缓存上</td>
</tr>
</tbody></table>
<p>Spring表达式值的引用</p>
<table>
<thead>
<tr>
<th align="left">表达式</th>
<th align="left">描述</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">#root.args</td>
<td align="left">定义传递给缓存方法的参数</td>
<td align="left">不常用，不予讨论</td>
</tr>
<tr>
<td align="left">#root.caches</td>
<td align="left">该方法执行是对应的缓存名称，它是一个数组</td>
<td align="left">同上</td>
</tr>
<tr>
<td align="left">#root.target</td>
<td align="left">执行缓存的目标对象</td>
<td align="left">同上</td>
</tr>
<tr>
<td align="left">#root.targetClass</td>
<td align="left">目标对象的类，它是#root.target.class的缩写</td>
<td align="left">同上</td>
</tr>
<tr>
<td align="left">#root.method</td>
<td align="left">缓存方法</td>
<td align="left">同上</td>
</tr>
<tr>
<td align="left">#root.methodName</td>
<td align="left">缓存方法的名称，它是#root.method.name的缩写</td>
<td align="left">同上</td>
</tr>
<tr>
<td align="left">#result</td>
<td align="left">方法返回结果值，还可以使用Spring表达式进一步读取其属性</td>
<td align="left">请注意该表达式不能用于注解@Cacheable，因为该注解的方法可能不会被执行，这样返回值就无从谈起了。</td>
</tr>
<tr>
<td align="left">#Argument</td>
<td align="left">任意方法的参数，可以通过方法本身的名称或者下标去定义</td>
<td align="left">比如getRole(Long id)方法，想读取id这个参数，可以写为#id，或者#a0，#p0，笔者建议写为#id，这样可读性高</td>
</tr>
</tbody></table>
<h4 id="RoleServiceImpl实现类"><a href="#RoleServiceImpl实现类" class="headerlink" title="RoleServiceImpl实现类"></a>RoleServiceImpl实现类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.Role;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.RoleDao;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RoleService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CachePut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Isolation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImpl</span> <span class="keyword">implements</span> <span class="title">RoleService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RoleDao roleDao = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="meta">@Cacheable</span>(value = <span class="string">"redisCache"</span>, key = <span class="string">"'redis_role_' + #id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">getRole</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleDao.getRole(id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="meta">@CachePut</span>(value=<span class="string">"redisCache"</span>, key=<span class="string">"'redis_role_' + #result.id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Role <span class="title">insertRole</span><span class="params">(Role role)</span> </span>{</span><br><span class="line">        roleDao.insertRole(role);</span><br><span class="line">        <span class="keyword">return</span> role;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="meta">@CachePut</span>(value = <span class="string">"redisCache"</span>, key = <span class="string">"'redis_role_' + #role.id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateRole</span><span class="params">(Role role)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleDao.updateRole(role);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleDao.deleteRole(id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Role&gt; <span class="title">findRoles</span><span class="params">(String roleName, String note)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> roleDao.findRoles(roleName, note);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="启动测试类"><a href="#启动测试类" class="headerlink" title="启动测试类"></a>启动测试类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SpringBoot项目启动入口类</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span>  <span class="comment">//SpringBoot核心注解，主要用于开启spring自动配置</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        ApplicationContext applicationContext = SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        <span class="comment">//ApplicationContext applicationContext = new AnnotationConfigApplicationContext(RedisConfig.class);</span></span><br><span class="line">        <span class="comment">//获取角色服务类</span></span><br><span class="line">        RoleService roleService = applicationContext.getBean(RoleService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Role role = <span class="keyword">new</span> Role();</span><br><span class="line">        role.setRoleName(<span class="string">"role_name_1"</span>);</span><br><span class="line">        role.setNote(<span class="string">"role_note_1"</span>);</span><br><span class="line">        <span class="comment">//插入角色</span></span><br><span class="line">        roleService.insertRole(role); <span class="comment">//会回填id</span></span><br><span class="line">        <span class="comment">//获取角色</span></span><br><span class="line">        Role role1 = roleService.getRole(role.getId());</span><br><span class="line">        role1.setNote(<span class="string">"role_note_1_update"</span>);</span><br><span class="line">        <span class="comment">//更新角色</span></span><br><span class="line">        roleService.updateRole(role1);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="测试结果-2"><a href="#测试结果-2" class="headerlink" title="测试结果"></a>测试结果</h4><h5 id="配置文件配置方式测试结果"><a href="#配置文件配置方式测试结果" class="headerlink" title="配置文件配置方式测试结果"></a>配置文件配置方式测试结果</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">55.819</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Creating a <span class="keyword">new</span> SqlSession</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">55.821</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Registering transaction synchronization <span class="keyword">for</span> SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">5f</span>c1e4fb]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">55.825</span> [main] DEBUG o.m.spring.transaction.SpringManagedTransaction - JDBC Connection [<span class="number">794778569</span>, URL=jdbc:mysql:/ /localhost:<span class="number">3306</span>/ssm?useUnicode=<span class="keyword">true</span>&amp;characterEncoding=UTF-<span class="number">8</span>&amp;useJDBCCompliantTimezoneShift=<span class="keyword">true</span>&amp;useLegacyDatetimeCode=<span class="keyword">false</span>&amp;serverTimezone=GMT%<span class="number">2</span>B8, MySQL Connector/J] will be managed by Spring</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">55.827</span> [main] DEBUG c.l.springboot.IoCImpl.mapper.RoleDao.insertRole - ==&gt;  Preparing: <span class="function">insert into <span class="title">t_role</span><span class="params">(role_name, note)</span> <span class="title">values</span><span class="params">(?, ?)</span>  </span></span><br><span class="line"><span class="function">2021-10-14 19:25:55.841 [main] DEBUG c.l.springboot.IoCImpl.mapper.RoleDao.insertRole - </span>==&gt; Parameters: role_name_1(String), role_note_1(String)</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">55.843</span> [main] DEBUG c.l.springboot.IoCImpl.mapper.RoleDao.insertRole - &lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">55.849</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">5f</span>c1e4fb]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">55.999</span> [main] DEBUG io.lettuce.core.RedisClient - Trying to get a Redis connection <span class="keyword">for</span>: redis:<span class="comment">//127.0.0.1</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.numHeapArenas: <span class="number">24</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.numDirectArenas: <span class="number">24</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.pageSize: <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.maxOrder: <span class="number">11</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.chunkSize: <span class="number">16777216</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.smallCacheSize: <span class="number">256</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.normalCacheSize: <span class="number">64</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.maxCachedBufferCapacity: <span class="number">32768</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.cacheTrimInterval: <span class="number">8192</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.cacheTrimIntervalMillis: <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.useCacheForAllThreads: <span class="keyword">true</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.298</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.maxCachedByteBuffersPerChunk: <span class="number">1023</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.313</span> [main] DEBUG io.netty.buffer.ByteBufUtil - -Dio.netty.allocator.type: pooled</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.313</span> [main] DEBUG io.netty.buffer.ByteBufUtil - -Dio.netty.threadLocalDirectBufferSize: <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.313</span> [main] DEBUG io.netty.buffer.ByteBufUtil - -Dio.netty.maxThreadLocalCharBufferSize: <span class="number">16384</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.316</span> [main] DEBUG io.lettuce.core.resource.KqueueProvider - Starting without optional kqueue library</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.316</span> [main] DEBUG io.lettuce.core.resource.EpollProvider - Starting without optional epoll library</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.317</span> [main] DEBUG i.l.core.resource.DefaultEventLoopGroupProvider - Allocating executor io.netty.channel.nio.NioEventLoopGroup</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.317</span> [main] DEBUG i.l.core.resource.DefaultEventLoopGroupProvider - Creating executor io.netty.channel.nio.NioEventLoopGroup</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.317</span> [main] DEBUG io.netty.channel.MultithreadEventLoopGroup - -Dio.netty.eventLoopThreads: <span class="number">24</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.330</span> [main] DEBUG io.netty.channel.nio.NioEventLoop - -Dio.netty.noKeySetOptimization: <span class="keyword">false</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.330</span> [main] DEBUG io.netty.channel.nio.NioEventLoop - -Dio.netty.selectorAutoRebuildThreshold: <span class="number">512</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.337</span> [main] DEBUG i.l.core.resource.DefaultEventLoopGroupProvider - Adding reference to io.netty.channel.nio.NioEventLoopGroup@<span class="number">5</span>cfa2ac5, existing ref count <span class="number">0</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.377</span> [main] DEBUG io.lettuce.core.RedisClient - Resolved SocketAddress <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/&lt;unresolved&gt;:<span class="number">6379</span> using redis:<span class="comment">//127.0.0.1</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.385</span> [main] DEBUG io.lettuce.core.AbstractRedisClient - Connecting to Redis at <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/&lt;unresolved&gt;:<span class="number">6379</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.399</span> [main] DEBUG io.netty.channel.DefaultChannelId - -Dio.netty.processId: <span class="number">11780</span> (auto-detected)</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.411</span> [main] DEBUG io.netty.util.NetUtil - -Djava.net.preferIPv4Stack: <span class="keyword">false</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.411</span> [main] DEBUG io.netty.util.NetUtil - -Djava.net.preferIPv6Addresses: <span class="keyword">false</span></span><br><span class="line">2021-10-14 19:25:56.417 [main] DEBUG io.netty.util.NetUtilInitializations - Loopback interface: lo (Software Loopback Interface 1, 127.0.0.1)</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.418</span> [main] DEBUG io.netty.util.NetUtil - Failed to get SOMAXCONN from sysctl and file \proc\sys\net\core\somaxconn. Default: <span class="number">200</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.424</span> [main] DEBUG io.netty.channel.DefaultChannelId - -Dio.netty.machineId: <span class="number">8</span>c:ec:<span class="number">4</span>b:ff:fe:cd:<span class="number">47</span>:<span class="number">39</span> (auto-detected)</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.553</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, [id: <span class="number">0x84f515a0</span>] (inactive), chid=<span class="number">0x1</span>] channelRegistered()</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.556</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.netty.util.Recycler - -Dio.netty.recycler.maxCapacityPerThread: <span class="number">4096</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.556</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.netty.util.Recycler - -Dio.netty.recycler.maxSharedCapacityFactor: <span class="number">2</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.556</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.netty.util.Recycler - -Dio.netty.recycler.linkCapacity: <span class="number">16</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.556</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.netty.util.Recycler - -Dio.netty.recycler.ratio: <span class="number">8</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.556</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.netty.util.Recycler - -Dio.netty.recycler.delayedQueue.ratio: <span class="number">8</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.579</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.netty.buffer.AbstractByteBuf - -Dio.netty.buffer.checkAccessible: <span class="keyword">true</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.579</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.netty.buffer.AbstractByteBuf - -Dio.netty.buffer.checkBounds: <span class="keyword">true</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.579</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.netty.util.ResourceLeakDetectorFactory - Loaded <span class="keyword">default</span> ResourceLeakDetector: io.netty.util.ResourceLeakDetector@<span class="number">51049</span>dd1</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.616</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] write(ctx, AsyncCommand [type=HELLO, output=GenericMapOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command], promise)</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.618</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandEncoder - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>] writing command AsyncCommand [type=HELLO, output=GenericMapOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.622</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Received: <span class="number">30</span> bytes, <span class="number">1</span> commands in the stack</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.622</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Stack contains: <span class="number">1</span> commands</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.623</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.RedisStateMachine - Decode done, empty stack: <span class="keyword">true</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.623</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Completing command AsyncCommand [type=HELLO, output=GenericMapOutput [output=<span class="keyword">null</span>, error=<span class="string">'ERR unknown command '</span>HELLO<span class="string">''</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.624</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] write(ctx, AsyncCommand [type=PING, output=StatusOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command], promise)</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.624</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandEncoder - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>] writing command AsyncCommand [type=PING, output=StatusOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.625</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Received: <span class="number">7</span> bytes, <span class="number">1</span> commands in the stack</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.625</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Stack contains: <span class="number">1</span> commands</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.625</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.RedisStateMachine - Decode done, empty stack: <span class="keyword">true</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.625</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Completing command AsyncCommand [type=PING, output=StatusOutput [output=PONG, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.625</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] channelActive()</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.626</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.DefaultEndpoint - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, epid=<span class="number">0x1</span>] activateEndpointAndExecuteBufferedCommands <span class="number">0</span> command(s) buffered</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.626</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.DefaultEndpoint - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, epid=<span class="number">0x1</span>] activating endpoint</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.626</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.DefaultEndpoint - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, epid=<span class="number">0x1</span>] flushCommands()</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.626</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.DefaultEndpoint - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, epid=<span class="number">0x1</span>] flushCommands() Flushing <span class="number">0</span> commands</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.626</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.ConnectionWatchdog - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, last known addr=/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>] channelActive()</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.626</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] channelActive() done</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.626</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.AbstractRedisClient - Connecting to Redis at <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/&lt;unresolved&gt;:<span class="number">6379</span>: Success</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.628</span> [main] DEBUG io.lettuce.core.RedisChannelHandler - dispatching command AsyncCommand [type=SET, output=StatusOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.629</span> [main] DEBUG io.lettuce.core.protocol.DefaultEndpoint - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, epid=<span class="number">0x1</span>] write() writeAndFlush command AsyncCommand [type=SET, output=StatusOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.630</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] write(ctx, AsyncCommand [type=SET, output=StatusOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command], promise)</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.630</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandEncoder - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>] writing command AsyncCommand [type=SET, output=StatusOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.631</span> [main] DEBUG io.lettuce.core.protocol.DefaultEndpoint - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, epid=<span class="number">0x1</span>] write() done</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.645</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Received: <span class="number">5</span> bytes, <span class="number">1</span> commands in the stack</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.645</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Stack contains: <span class="number">1</span> commands</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.645</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.RedisStateMachine - Decode done, empty stack: <span class="keyword">true</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.645</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Completing command AsyncCommand [type=SET, output=StatusOutput [output=OK, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.645</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization committing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">5f</span>c1e4fb]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.645</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">5f</span>c1e4fb]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.645</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@<span class="number">5f</span>c1e4fb]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.679</span> [main] DEBUG io.lettuce.core.RedisChannelHandler - dispatching command AsyncCommand [type=GET, output=ValueOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.679</span> [main] DEBUG io.lettuce.core.protocol.DefaultEndpoint - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, epid=<span class="number">0x1</span>] write() writeAndFlush command AsyncCommand [type=GET, output=ValueOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.679</span> [main] DEBUG io.lettuce.core.protocol.DefaultEndpoint - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, epid=<span class="number">0x1</span>] write() done</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.679</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] write(ctx, AsyncCommand [type=GET, output=ValueOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command], promise)</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.680</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandEncoder - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>] writing command AsyncCommand [type=GET, output=ValueOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.680</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Received: <span class="number">248</span> bytes, <span class="number">1</span> commands in the stack</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.680</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Stack contains: <span class="number">1</span> commands</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.680</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.RedisStateMachine - Decode done, empty stack: <span class="keyword">true</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.680</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Completing command AsyncCommand [type=GET, output=ValueOutput [output=[B@<span class="number">75657082</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.683</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Creating a <span class="keyword">new</span> SqlSession</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.684</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Registering transaction synchronization <span class="keyword">for</span> SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession<span class="meta">@a</span>240452]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.684</span> [main] DEBUG o.m.spring.transaction.SpringManagedTransaction - JDBC Connection [<span class="number">441236678</span>, URL=jdbc:mysql:/ /localhost:<span class="number">3306</span>/ssm?useUnicode=<span class="keyword">true</span>&amp;characterEncoding=UTF-<span class="number">8</span>&amp;useJDBCCompliantTimezoneShift=<span class="keyword">true</span>&amp;useLegacyDatetimeCode=<span class="keyword">false</span>&amp;serverTimezone=GMT%<span class="number">2</span>B8, MySQL Connector/J] will be managed by Spring</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.684</span> [main] DEBUG c.l.springboot.IoCImpl.mapper.RoleDao.updateRole - ==&gt;  Preparing: update t_role set role_name = ?, note = ? where id = ?  </span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.684</span> [main] DEBUG c.l.springboot.IoCImpl.mapper.RoleDao.updateRole - ==&gt; Parameters: role_name_1(String), role_note_1_update(String), <span class="number">43</span>(Long)</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.685</span> [main] DEBUG c.l.springboot.IoCImpl.mapper.RoleDao.updateRole - &lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.685</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession<span class="meta">@a</span>240452]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.686</span> [main] DEBUG io.lettuce.core.RedisChannelHandler - dispatching command AsyncCommand [type=SET, output=StatusOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.686</span> [main] DEBUG io.lettuce.core.protocol.DefaultEndpoint - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, epid=<span class="number">0x1</span>] write() writeAndFlush command AsyncCommand [type=SET, output=StatusOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.686</span> [main] DEBUG io.lettuce.core.protocol.DefaultEndpoint - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, epid=<span class="number">0x1</span>] write() done</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.686</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] write(ctx, AsyncCommand [type=SET, output=StatusOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command], promise)</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.687</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandEncoder - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>] writing command AsyncCommand [type=SET, output=StatusOutput [output=<span class="keyword">null</span>, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.687</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Received: <span class="number">5</span> bytes, <span class="number">1</span> commands in the stack</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.687</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Stack contains: <span class="number">1</span> commands</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.687</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.RedisStateMachine - Decode done, empty stack: <span class="keyword">true</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.687</span> [lettuce-nioEventLoop-<span class="number">4</span>-<span class="number">1</span>] DEBUG io.lettuce.core.protocol.CommandHandler - [channel=<span class="number">0xade3db03</span>, /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52675</span> -&gt; /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>, chid=<span class="number">0x1</span>] Completing command AsyncCommand [type=SET, output=StatusOutput [output=OK, error=<span class="string">'null'</span>], commandType=io.lettuce.core.protocol.Command]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.687</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization committing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession<span class="meta">@a</span>240452]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.687</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession<span class="meta">@a</span>240452]</span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">25</span>:<span class="number">56.687</span> [main] DEBUG org.mybatis.spring.SqlSessionUtils - Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession<span class="meta">@a</span>240452]</span><br></pre></td></tr></tbody></table></figure>

<p>因为我们设置了60秒超时时间，所以到期后，查不到数据了。</p>
<figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; keys *</span><br><span class="line"><span class="number">1</span>) "redis_role_49"</span><br><span class="line"><span class="number">2</span>) "zset1"</span><br><span class="line"><span class="number">3</span>) "\xac\xed\x00\x05t\x00\x05count"</span><br><span class="line"><span class="number">4</span>) "inter_zset"</span><br><span class="line"><span class="number">5</span>) "zset2"</span><br><span class="line"><span class="number">6</span>) "name"</span><br><span class="line"><span class="number">7</span>) "h3"</span><br><span class="line"><span class="number">8</span>) "h1"</span><br><span class="line"><span class="number">9</span>) "h2"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get redis_role_49</span><br><span class="line">"\xac\xed\x00\x05sr\x00\x11java.lang.Integer\x12\xe2\xa0\xa4\xf7\x81\x878\x02\x00\x01I\x00\x05valuexr\x00\x10java.lang.Number\x86\xac\x95\x1d\x0b\x94\xe0\x8b\x02\x00\x00xp\x00\x00\x00\x01"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get redis_role_49</span><br><span class="line">"\xac\xed\x00\x05sr\x00\x11java.lang.Integer\x12\xe2\xa0\xa4\xf7\x81\x878\x02\x00\x01I\x00\x05valuexr\x00\x10java.lang.Number\x86\xac\x95\x1d\x0b\x94\xe0\x8b\x02\x00\x00xp\x00\x00\x00\x01"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get redis_role_49</span><br><span class="line">"\xac\xed\x00\x05sr\x00\x11java.lang.Integer\x12\xe2\xa0\xa4\xf7\x81\x878\x02\x00\x01I\x00\x05valuexr\x00\x10java.lang.Number\x86\xac\x95\x1d\x0b\x94\xe0\x8b\x02\x00\x00xp\x00\x00\x00\x01"</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get redis_role_49</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="注解-CacheEvict"><a href="#注解-CacheEvict" class="headerlink" title="注解@CacheEvict"></a>注解@CacheEvict</h3><table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">value</td>
<td align="left">String[]</td>
<td align="left">要使用缓存的名称</td>
</tr>
<tr>
<td align="left">key</td>
<td align="left">String</td>
<td align="left">指定Spring表达式返回缓存的key</td>
</tr>
<tr>
<td align="left">condition</td>
<td align="left">String</td>
<td align="left">指定Spring表达式，如果返回为true，则执行移除缓存，否则不执行</td>
</tr>
<tr>
<td align="left">allEntries</td>
<td align="left">boolean</td>
<td align="left">如果为true，则删除特定缓存所有键值对，默认值为false，请注意它将清除所有缓存服务器的缓存，这个属性慎用</td>
</tr>
<tr>
<td align="left">beforeInvocation</td>
<td align="left">boolean</td>
<td align="left">指定在方法前后移除缓存，如果指定为true，则在方法前删除缓存；如果为false，则在方法调用后删除缓存，默认值为false</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line"><span class="meta">@CacheEvict</span>(value = <span class="string">"redisCache"</span>, key = <span class="string">"'redis_role_' + #id"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> roleDao.deleteRole(id);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="不适用缓存的方法"><a href="#不适用缓存的方法" class="headerlink" title="不适用缓存的方法"></a>不适用缓存的方法</h3><p>该方法不适用任何缓存注解标注在这个方法上。<br><strong>注意：使用缓存的前提——高命中率，由于这里根据角色名称和备注查找角色信息，该方法的返回值会根据查询条件而多样化，导致其不确定和命中率地下，对于这样的场景，使用缓存并不能有效提高性能，所以这样的场景，就不再使用缓存了。</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Role&gt; <span class="title">findRoles</span><span class="params">(String roleName, String note)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> roleDao.findRoles(roleName, note);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="自调用失效问题"><a href="#自调用失效问题" class="headerlink" title="自调用失效问题"></a>自调用失效问题</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRoles</span><span class="params">(List&lt;Role&gt; roleList)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span>(Role role:roleList){</span><br><span class="line">        <span class="comment">//同一类方法调用自己的方法，产生自调用失效问题</span></span><br><span class="line">        <span class="keyword">this</span>.insertRole(role);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>因为缓存注解也是基于Spring AOP实现的，对于Spring AOP的基础是动态代理技术，也就是只有代理对象的相互调用，AOP才有拦截的功能，才能执行缓存注解提供的功能。而这里的自调用是没有代理对象存在的，所以其注解功能也就失效了。</p>
<h2 id="RedisTemplate的实例"><a href="#RedisTemplate的实例" class="headerlink" title="RedisTemplate的实例"></a>RedisTemplate的实例</h2><p>在很多时候，我们也许需要使用一些更为高级的缓存服务器的API，如Redis的流水线、事务等，所以也许会使用到RedisTemplate本身。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedisTemplateService</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execMultiCommand</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execTransaction</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execPipeline</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RedisTemplateService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.DataAccessException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.SessionCallback;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisServiceImpl</span> <span class="keyword">implements</span> <span class="title">RedisTemplateService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execMultiCommand</span><span class="params">()</span> </span>{</span><br><span class="line">        Object obj = redisTemplate.execute(<span class="keyword">new</span> SessionCallback() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(RedisOperations ops)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">                ops.boundValueOps(<span class="string">"key1"</span>).set(<span class="string">"abc"</span>);</span><br><span class="line">                ops.boundHashOps(<span class="string">"hash"</span>).put(<span class="string">"hash-key-1"</span>, <span class="string">"hash-value-1"</span>);</span><br><span class="line">                <span class="keyword">return</span> ops.boundValueOps(<span class="string">"key1"</span>).get();</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execTransaction</span><span class="params">()</span> </span>{</span><br><span class="line">        List list = (List) redisTemplate.execute(<span class="keyword">new</span> SessionCallback() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(RedisOperations ops)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">                <span class="comment">//监控</span></span><br><span class="line">                ops.watch(<span class="string">"key1"</span>);</span><br><span class="line">                <span class="comment">//开启事务</span></span><br><span class="line">                ops.multi();</span><br><span class="line">                <span class="comment">//注意，命令都不会被马上执行，只会收到Redis的队列中，只会返回null</span></span><br><span class="line">                ops.boundValueOps(<span class="string">"key1"</span>).set(<span class="string">"abc"</span>);</span><br><span class="line">                ops.boundHashOps(<span class="string">"hash"</span>).put(<span class="string">"hash-key-1"</span>, <span class="string">"hash-value-1"</span>);</span><br><span class="line">                ops.opsForValue().get(<span class="string">"key1"</span>);</span><br><span class="line">                <span class="comment">//执行exec方法后会触发事务执行，返回结果，存放到list中</span></span><br><span class="line">                List result = ops.exec();</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execPipeline</span><span class="params">()</span> </span>{</span><br><span class="line">        List list = redisTemplate.executePipelined(<span class="keyword">new</span> SessionCallback() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(RedisOperations ops)</span> <span class="keyword">throws</span> DataAccessException </span>{</span><br><span class="line">                <span class="comment">//在流水线下，命令不会马上返回结果，结果是一次性执行后返回的</span></span><br><span class="line">                ops.opsForValue().set(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br><span class="line">                ops.opsForHash().put(<span class="string">"hash"</span>, <span class="string">"key-hash-1"</span>, <span class="string">"value-hash-1"</span>);</span><br><span class="line">                ops.opsForValue().get(<span class="string">"key1"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<h1 id="高并发业务"><a href="#高并发业务" class="headerlink" title="高并发业务"></a>高并发业务</h1></blockquote>
<h2 id="互联系统应用架构基础分析"><a href="#互联系统应用架构基础分析" class="headerlink" title="互联系统应用架构基础分析"></a>互联系统应用架构基础分析</h2><ul>
<li>防火墙</li>
<li>负载均衡</li>
<li>NoSQL服务器集群</li>
<li>Web服务器集群</li>
<li>数据库集群</li>
</ul>
<p>负载均衡器的功能：</p>
<ul>
<li>对业务请求做初步的分析，决定分不分发请求到 Web 服务器，这就好比以个把控的关卡，常见的分发软件比如 Nginx和Apache 等反向代理服务器，它们在关卡处可以通过配置禁止一些无效的请求，比如封禁经常作弊的IP地址，也可以使用 Lua语言联合 NoSQL 缓存技术进行业务分析，这样就可以初步分析业务，决定是否需要分发到服务器；</li>
<li>提供路由算法，它可以提供一些负载均衡的算法，根据各个服务器的负载能力进行合理分发，每一个Web服务器得到比较均衡的请求，从而降低单个服务器的压力，提高系统的响应能力；</li>
<li>限流，对于一些高并发时刻，需要通过限流来处理，因为可能某个时刻通过上述的算法让有效请求 过多到达服务器，使得一些Web服务器或者数据库服务器产生宕机。当某台机器宕机后，会使得其他服务器承受更大的请求量，这样就容易产生多台服务器连续宕机的可能性，持续下去就会引发服务器雪崩。因此在这种情况下，负载均衡器有限流的算法，对于请求过多的时刻，可以告知用户系统繁忙，稍后再试，从而保证系统持续可用。</li>
</ul>
<h2 id="高并发系统的分析和设计"><a href="#高并发系统的分析和设计" class="headerlink" title="高并发系统的分析和设计"></a>高并发系统的分析和设计</h2><h3 id="有效请求和无效请求"><a href="#有效请求和无效请求" class="headerlink" title="有效请求和无效请求"></a>有效请求和无效请求</h3><p>无效请求有很多种类，比如通过脚本连续刷新网站首页，使得网站频繁访问数据库和其他资源，造成性能持续下降，还有 些为了得到抢购商品，使用刷票软件连续请求的行为。</p>
<h3 id="系统设计"><a href="#系统设计" class="headerlink" title="系统设计"></a>系统设计</h3><p>业务划分：</p>
<ul>
<li>水平划分：分拆成各个独立的子业务，相互隔离，降低数据的复杂性，但是各个系统之间存在着关联，还要通过RPC远程过程调用协议处理这些信息，比较流行的RPC有Dubbo、Thrift和Hessian等。</li>
<li>垂直划分：按照不相干的各个同样的系统分摊下去来进行业务处理。</li>
<li>水平垂直结合的划分。</li>
</ul>
<h3 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h3><ul>
<li>分库</li>
<li>分表</li>
<li>MySQL优化</li>
</ul>
<h3 id="动静分离技术"><a href="#动静分离技术" class="headerlink" title="动静分离技术"></a>动静分离技术</h3><p>对于互联网而言大部分数据都是静态数据，只有少数使用动态数据，动态数据的数据包很小，不会造成网络瓶颈，而静态的数据则不一样，静态数据包含图片、CSS（样式）、JavaScript（脚本）和视频等互联网的应用，尤其是图片和视频占据的流量很大，如果都从冬天服务器（比如Tomcat、WildFly和WebLogic等）获取，那么动态服务器的带宽压力会很大，这个时候应该考虑使用静态分离技术。</p>
<ul>
<li>CDN（Content Delivery Network）内容分发网络技术，它允许企业将自己的静态数据缓存到网络CDN的节点，就近响应。</li>
<li>静态HTTP服务器，将静态数据分离到静态HTTP服务器上。其原理大同小异，就是将资源分配到静态服务器上，这样图片、HTML、脚本等资源都可以从静态服务器上获取，尽量使用Cookie等技术，让客户端缓存能够缓存数据，避免多次请求，降低服务器的压力。</li>
</ul>
<h3 id="锁和高并发"><a href="#锁和高并发" class="headerlink" title="锁和高并发"></a>锁和高并发</h3><p>无论区分有效请求和无效请求，水平划分还是垂直划分，动静分离技术，还是数据库分表、分库等技术的应用，都无法避免动态数据，而动态数据的请求最终也会落在一台Web服务器上。高并发系统存在一个麻烦是并发数据不一致问题。</p>
<p>在高并发的场景下可能出现错扣红包的情况，这样就会导致数据错误。由于在一个瞬间产生很高的并发，因此除了保证数据一致性，还要尽可能地保证系统的性能，加锁会影响并发，而不加锁就难以保证数据的一致性，这就是高并发和锁的矛盾。</p>
<p>为了解决这对矛盾，在当前互联网系统中，大部分企业提出了悲观锁和乐观锁的概念，而对于数据库而言，如果在那么短的时间内需要执行大量SQL，对于服务器的压力可想而知，需要优化数据库的表设计、索引、SQL语句等。有些企业提出了使用Redis事务和Lua语言所提供的原子性来取代现有的数据库的技术，从而提高数据的存储响应，以应对高并发场景，严格来说也属于乐观锁的概念。</p>
<h2 id="搭建抢红包开发环境和超发现象"><a href="#搭建抢红包开发环境和超发现象" class="headerlink" title="搭建抢红包开发环境和超发现象"></a>搭建抢红包开发环境和超发现象</h2><p>现在模拟20万元的红包，共分为2万个红包</p>
<h3 id="大小红包数据库表"><a href="#大小红包数据库表" class="headerlink" title="大小红包数据库表"></a>大小红包数据库表</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">create table T_RED_PACKET(</span><br><span class="line">    id int(12) not null auto_increment , # 红包编号</span><br><span class="line">    user_id int(12) not null , # 发红包用户</span><br><span class="line">    amount decimal(16,2) not null , # 红包金额</span><br><span class="line">    send_date timestamp not null , # 发红包时间</span><br><span class="line">    total int(12) not null ,  # 小红包总数</span><br><span class="line">    unit_amount decimal(12) not null , # 单个小红包金额</span><br><span class="line">    stock int(12) not null ,  # 剩余小红包个数</span><br><span class="line">    version int(12) default 0 not null , # 版本</span><br><span class="line">    note varchar(256) null , # 备注</span><br><span class="line">    primary key clustered(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table T_USER_RED_PACKET(</span><br><span class="line">    id int(12) not null auto_increment, # 编号</span><br><span class="line">    red_packet_id int(12) not null , # 红包编号</span><br><span class="line">    user_id int(12) not null , # 抢红包用户编号</span><br><span class="line">    amount decimal(16,2) not null , # 抢红包金额</span><br><span class="line">    grab_time timestamp not null , # 抢红包时间</span><br><span class="line">    note varchar(256) null , # 备注</span><br><span class="line">    primary key clustered(id)</span><br><span class="line">);</span><br><span class="line">insert into t_red_packet(user_id, amount, send_date, total, unit_amount, stock, note)</span><br><span class="line">values (1, 200000.00, now(), 20000, 10.00, 20000, '20万元金额，2万个小红包，每个10元');</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Mapper接口-1"><a href="#Mapper接口-1" class="headerlink" title="Mapper接口"></a>Mapper接口</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.RedPacket;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketDao</span> </span>{</span><br><span class="line">    <span class="function">RedPacket <span class="title">getRedPacket</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">decreaseRedPacket</span><span class="params">(Long id)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.UserRedPacket;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRedPacketDao</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">grapRedPacket</span><span class="params">(UserRedPacket userRedPacket)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Mybatis的Mapper配置文件"><a href="#Mybatis的Mapper配置文件" class="headerlink" title="Mybatis的Mapper配置文件"></a>Mybatis的Mapper配置文件</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.louris.springboot.IoCImpl.mapper.RedPacketDao"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--查询红包具体信息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRedPacket"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.RedPacket"</span>&gt;</span></span><br><span class="line">        select id, user_id as userId, amount, send_date as sendDate, total, unit_amount as unitAmount, stock, version, note from t_red_packet where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--扣减抢红包库存--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"decreaseRedPacket"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">        update t_red_packet set stock = stock - 1 where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.louris.springboot.IoCImpl.mapper.UserRedPacketDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"grapRedPacket"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span> <span class="attr">parameterType</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.UserRedPacket"</span>&gt;</span></span><br><span class="line">        insert into t_user_red_packet(red_packet_id, user_id, amount, grab_time, note)</span><br><span class="line">        values (#{redPacketId}, #{userId}, #{amount}, now(), #{note})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Service接口"><a href="#Service接口" class="headerlink" title="Service接口"></a>Service接口</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.RedPacket;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketService</span> </span>{</span><br><span class="line">    <span class="function">RedPacket <span class="title">getRedPacket</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">decreaseRedPacket</span><span class="params">(Long id)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRedPacketService</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">grapRedPacket</span><span class="params">(Long redPacketId, Long userId)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="ServiceImpl实现类"><a href="#ServiceImpl实现类" class="headerlink" title="ServiceImpl实现类"></a>ServiceImpl实现类</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.RedPacket;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.RedPacketDao;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RedPacketService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Isolation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedPacketServiceImpl</span> <span class="keyword">implements</span> <span class="title">RedPacketService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedPacketDao redPacketDao = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedPacket <span class="title">getRedPacket</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> redPacketDao.getRedPacket(id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">decreaseRedPacket</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> redPacketDao.decreaseRedPacket(id);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.RedPacket;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.UserRedPacket;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.RedPacketDao;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.UserRedPacketDao;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RedPacketService;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.UserRedPacketService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Isolation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRedPacketServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserRedPacketService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRedPacketDao userRedPacketDao = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedPacketService redPacketService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//失败</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FAILED = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">grapRedPacket</span><span class="params">(Long redPacketId, Long userId)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"enter grapRedPacket"</span>);</span><br><span class="line">        <span class="comment">//获取红包信息</span></span><br><span class="line">        RedPacket redPacket = redPacketService.getRedPacket(redPacketId);</span><br><span class="line">        <span class="comment">//当前小红包库存大于0</span></span><br><span class="line">        <span class="keyword">if</span>(redPacket.getStock() &gt; <span class="number">0</span>){</span><br><span class="line">            System.out.println(<span class="string">"enter stock"</span>);</span><br><span class="line">            redPacketService.decreaseRedPacket(redPacketId);</span><br><span class="line">            <span class="comment">//生成抢红包信息</span></span><br><span class="line">            UserRedPacket userRedPacket = <span class="keyword">new</span> UserRedPacket();</span><br><span class="line">            userRedPacket.setRedPacketId(redPacketId);</span><br><span class="line">            userRedPacket.setUserId(userId);</span><br><span class="line">            userRedPacket.setAmount(redPacket.getUnitAmount());</span><br><span class="line">            userRedPacket.setNote(<span class="string">"抢红包 "</span> + redPacketId);</span><br><span class="line">            System.out.println(userId);</span><br><span class="line">            <span class="comment">//插入抢红包信息</span></span><br><span class="line">            <span class="keyword">return</span> userRedPacketDao.grapRedPacket(userRedPacket);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//失败返回</span></span><br><span class="line">        <span class="keyword">return</span> FAILED;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="页面-1"><a href="#页面-1" class="headerlink" title="页面"></a>页面</h3><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: louris</span><br><span class="line">  Date: <span class="number">2021</span>/<span class="number">10</span>/<span class="number">17</span></span><br><span class="line">  Time: <span class="number">19</span>:<span class="number">47</span></span><br><span class="line">  To change <span class="keyword">this</span> template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;抢红包测试&lt;/title&gt;</span><br><span class="line">    &lt;script src="https://code.jquery.com/jquery-3.2.0.js" type="text/javascript"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">        $(document).ready(function () {</span><br><span class="line">            <span class="comment">//模拟300个异步请求，进行并发</span></span><br><span class="line">            <span class="keyword">var</span> max = <span class="number">300</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= max; i ++){</span><br><span class="line">                <span class="comment">//jQuery的post请求，请注意这是异步请求</span></span><br><span class="line">                $.post({</span><br><span class="line">                    <span class="comment">//请求抢id为1的红包</span></span><br><span class="line">                    url: <span class="string">"./grapRedPacket?redPacketId=1&amp;userId="</span> + i,</span><br><span class="line">                    <span class="comment">//成功后的方法</span></span><br><span class="line">                    success: function (result) {</span><br><span class="line"></span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="控制器-3"><a href="#控制器-3" class="headerlink" title="控制器"></a>控制器</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.UserRedPacketService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/userRedPacket"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRedPacketController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRedPacketService userRedPacketService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/grap"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">grap</span><span class="params">()</span></span>{</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">"redPacket"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/grapRedPacket"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">grapRedPacket</span><span class="params">(Long redPacketId, Long userId)</span></span>{</span><br><span class="line">        <span class="comment">//抢红包</span></span><br><span class="line">        <span class="keyword">int</span> result = userRedPacketService.grapRedPacket(redPacketId, userId);</span><br><span class="line">        Map&lt;String, Object&gt; retMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">boolean</span> flag = result &gt; <span class="number">0</span>;</span><br><span class="line">        retMap.put(<span class="string">"success"</span>, flag);</span><br><span class="line">        retMap.put(<span class="string">"message"</span>, flag ? <span class="string">"抢红包成功"</span> : <span class="string">"抢红包失败"</span>);</span><br><span class="line">        <span class="keyword">return</span> retMap;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="测试结果-3"><a href="#测试结果-3" class="headerlink" title="测试结果"></a>测试结果</h3><p>超发现象：比如库存还剩200个，有300个请求，最后发现发了203个红包，stock库存为-3，出现了超发！<br>比如库存就剩下1个红包，现在有3个请求在读取库存，不加任何措施的情况下，会出现3个请求都读取库存为1的情况，从而多减了库存，发生超发现象。</p>
<h2 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h2><p>利用数据库的行锁<code>for update</code>即可。</p>
<h3 id="修改mapper-xml文件"><a href="#修改mapper-xml文件" class="headerlink" title="修改mapper.xml文件"></a>修改mapper.xml文件</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.louris.springboot.IoCImpl.mapper.RedPacketDao"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--查询红包具体信息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRedPacket"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.RedPacket"</span>&gt;</span></span><br><span class="line">        select id, user_id as userId, amount, send_date as sendDate, total, unit_amount as unitAmount, stock, version, note from t_red_packet where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRedPacketForUpdate"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.RedPacket"</span>&gt;</span></span><br><span class="line">        select id, user_id as userId, amount, send_date as sendDate, total, unit_amount as unitAmount, stock, version, note</span><br><span class="line">        from t_red_packet where id = #{id} for update</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--扣减抢红包库存--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"decreaseRedPacket"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">        update t_red_packet set stock = stock - 1 where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="修改Mapper接口"><a href="#修改Mapper接口" class="headerlink" title="修改Mapper接口"></a>修改Mapper接口</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.RedPacket;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketDao</span> </span>{</span><br><span class="line">    <span class="function">RedPacket <span class="title">getRedPacket</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function">RedPacket <span class="title">getRedPacketForUpdate</span><span class="params">(Long id)</span></span>; <span class="comment">//新增</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">decreaseRedPacket</span><span class="params">(Long id)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="修改实现类"><a href="#修改实现类" class="headerlink" title="修改实现类"></a>修改实现类</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.RedPacket;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.RedPacketDao;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RedPacketService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Isolation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedPacketServiceImpl</span> <span class="keyword">implements</span> <span class="title">RedPacketService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedPacketDao redPacketDao = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedPacket <span class="title">getRedPacket</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="comment">//return redPacketDao.getRedPacket(id);</span></span><br><span class="line">        <span class="keyword">return</span> redPacketDao.getRedPacketForUpdate(id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">decreaseRedPacket</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> redPacketDao.decreaseRedPacket(id);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="测试结果-4"><a href="#测试结果-4" class="headerlink" title="测试结果"></a>测试结果</h3><p>成功消除超发现象，保证了数据的一致性，但是悲观锁的性能下降很多。</p>
<ul>
<li>频繁加锁和释放，导致事务挂起，只有抢到锁才会执行事务，性能下降，同时十分消耗资源。</li>
</ul>
<p>注意：这里事务的隔离级别是读已提交，并且对数据加了行锁，只有在拿到锁的事务读取并减完库存后，即锁释放后，其他事务才能读取，进行更新操作。</p>
<p><code>for update</code>用法以及加锁时机详见<a href="https://zhuanlan.zhihu.com/p/363967886" target="_blank" rel="noopener">参考资料</a></p>
<h2 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h2><p>乐观锁是一种不会阻塞其他线程并发的机制，它不会使用数据库的锁进行实现，它设计里面由于不阻塞其他线程，所以并不会引发线程频繁挂起和恢复。乐观锁使用的是CAS原理</p>
<h3 id="CAS原理概述"><a href="#CAS原理概述" class="headerlink" title="CAS原理概述"></a>CAS原理概述</h3><p>在CAS原理中，对于多个线程共同的资源，先保存一个旧值（Old Value），比如进入线程后，查询当前存量为100个红包，那么先把旧值保存为100，然后经过一定的逻辑处理。当需要扣减红包的时候，先比较数据库当前的值和旧值是否一致，如果一致则进行扣减红包的操作，否则就认为它已经被其他线程修改过了，不再进行操作。</p>
<p>CAS原理并不排斥并发，也不独占资源，只是在线程开始阶段就读入线程共享数据，保存为旧值。当处理完逻辑，需要更新数据的时候，会进行一次比较，即比较各个线程当前共享的数据是否和旧值保持一致。如果一致，就开始更新数据；如果不一致，则认为该数据已经被其他线程修改了，那么就不再更新数据，可以考虑重试或者放弃。有时候可以重试，这样就是一个可重入锁，但是CAS原理会有一个问题，那就是ABA问题。</p>
<h3 id="ABA问题"><a href="#ABA问题" class="headerlink" title="ABA问题"></a>ABA问题</h3><p>现有两个线程，线程1和线程2，初始化x=A，线程2修改x=B,而后又将其修改x=A，这个时候线程1需要修改x，发现与原来的值相同，所以修改。这里就出现了ABA问题，线程1并不知道x已经被修改！</p>
<p>可以通过version 变量，只要修改x就递增version，根据version判断是否修改，就可以避免ABA问题。</p>
<h3 id="乐观锁实现抢红包业务"><a href="#乐观锁实现抢红包业务" class="headerlink" title="乐观锁实现抢红包业务"></a>乐观锁实现抢红包业务</h3><h4 id="修改Mapper-xml"><a href="#修改Mapper-xml" class="headerlink" title="修改Mapper.xml"></a>修改Mapper.xml</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org/DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.louris.springboot.IoCImpl.mapper.RedPacketDao"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--查询红包具体信息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRedPacket"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.RedPacket"</span>&gt;</span></span><br><span class="line">        select id, user_id as userId, amount, send_date as sendDate, total, unit_amount as unitAmount, stock, version, note from t_red_packet where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRedPacketForUpdate"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"com.louris.springboot.IoCImpl.beans.pojo.RedPacket"</span>&gt;</span></span><br><span class="line">        select id, user_id as userId, amount, send_date as sendDate, total, unit_amount as unitAmount, stock, version, note</span><br><span class="line">        from t_red_packet where id = #{id} for update</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--扣减抢红包库存--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"decreaseRedPacket"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">        update t_red_packet set stock = stock - 1 where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"decreaseRedPacketForVersion"</span>&gt;</span></span><br><span class="line">        update t_red_packet set stock = stock - 1, version = version + 1</span><br><span class="line">        where id = #{id}</span><br><span class="line">        and version = #{version}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="修改mapper接口"><a href="#修改mapper接口" class="headerlink" title="修改mapper接口"></a>修改mapper接口</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.RedPacket;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedPacketDao</span> </span>{</span><br><span class="line">    <span class="function">RedPacket <span class="title">getRedPacket</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function">RedPacket <span class="title">getRedPacketForUpdate</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">decreaseRedPacket</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">decreaseRedPacketForVersion</span><span class="params">(Long id, Integer version)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="修改实现类-1"><a href="#修改实现类-1" class="headerlink" title="修改实现类"></a>修改实现类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.RedPacket;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.RedPacketDao;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RedPacketService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Isolation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedPacketServiceImpl</span> <span class="keyword">implements</span> <span class="title">RedPacketService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedPacketDao redPacketDao = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedPacket <span class="title">getRedPacket</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> redPacketDao.getRedPacket(id);</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedPacket <span class="title">getRedPacketForUpdate</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> redPacketDao.getRedPacketForUpdate(id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">decreaseRedPacket</span><span class="params">(Long id)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> redPacketDao.decreaseRedPacket(id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">decreaseRedPacketForVersion</span><span class="params">(Long id, Integer version)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> redPacketDao.decreaseRedPacketForVersion(id, version);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.RedPacket;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.UserRedPacket;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.RedPacketDao;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.UserRedPacketDao;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RedPacketService;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.UserRedPacketService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Isolation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRedPacketServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserRedPacketService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRedPacketDao userRedPacketDao = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedPacketService redPacketService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//失败</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FAILED = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">grapRedPacket</span><span class="params">(Long redPacketId, Long userId)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"enter grapRedPacket"</span>);</span><br><span class="line">        <span class="comment">//获取红包信息</span></span><br><span class="line">        RedPacket redPacket = redPacketService.getRedPacket(redPacketId);</span><br><span class="line">        <span class="comment">//当前小红包库存大于0</span></span><br><span class="line">        <span class="keyword">if</span>(redPacket.getStock() &gt; <span class="number">0</span>){</span><br><span class="line">            <span class="comment">//再次传入线程保存的version</span></span><br><span class="line">            <span class="keyword">int</span> update = redPacketService.decreaseRedPacketForVersion(redPacketId, redPacket.getVersion());</span><br><span class="line">            <span class="comment">//如果没有数据更新，则说明其他线程已经修改过数据，本次抢红包失败</span></span><br><span class="line">            <span class="keyword">if</span>(update == <span class="number">0</span>){</span><br><span class="line">                <span class="keyword">return</span> FAILED;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//生成抢红包信息</span></span><br><span class="line">            UserRedPacket userRedPacket = <span class="keyword">new</span> UserRedPacket();</span><br><span class="line">            userRedPacket.setRedPacketId(redPacketId);</span><br><span class="line">            userRedPacket.setUserId(userId);</span><br><span class="line">            userRedPacket.setAmount(redPacket.getUnitAmount());</span><br><span class="line">            userRedPacket.setNote(<span class="string">"抢红包 "</span> + redPacketId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//插入抢红包信息</span></span><br><span class="line">            <span class="keyword">return</span> userRedPacketDao.grapRedPacket(userRedPacket);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//失败返回</span></span><br><span class="line">        <span class="keyword">return</span> FAILED;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>可以发现，能够保证数据一致性以及高性能，但是还会存在大量的红包，也就是存在大量的因为版本不一致的原因造成抢红包失败的请求，不过这个失败率太高了一点。有时候会容忍这个失败，这取决于业务的需要。</p>
<p>为了克服这个问题，提高成功率，还回考虑使用重入机制。也就是一旦因为版本原因没有抢到红包，则重新尝试抢红包，但是过多的重入会造成大量的SQL执行，所以目前流行的重入会加入两种限制：</p>
<ul>
<li>按时间戳重入，也就是在一定时间戳内（比如100毫秒），不成功的会循环到成功为止，直至超时时间戳，不成功才会退出，返回失败。</li>
<li>按次数，比如限定3次，程序尝试超过3次抢红包后，就判定请求失败，这样有助于提高用户抢红包的成功率。</li>
</ul>
<h3 id="乐观锁重入机制"><a href="#乐观锁重入机制" class="headerlink" title="乐观锁重入机制"></a>乐观锁重入机制</h3><h4 id="时间戳方案"><a href="#时间戳方案" class="headerlink" title="时间戳方案"></a>时间戳方案</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">grapRedPacket</span><span class="params">(Long redPacketId, Long userId)</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录开始时间</span></span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">//无线循环，等到成功或者时间满100毫秒退出</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>){</span><br><span class="line">        <span class="comment">//获取循环当前时间</span></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//当前时间已经超过100毫秒，返回失败</span></span><br><span class="line">        <span class="keyword">if</span>(end - start &gt; <span class="number">100</span>) <span class="keyword">return</span> FAILED;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取红包信息</span></span><br><span class="line">        RedPacket redPacket = redPacketService.getRedPacket(redPacketId);</span><br><span class="line">        <span class="comment">//当前小红包库存大于0</span></span><br><span class="line">        <span class="keyword">if</span>(redPacket.getStock() &gt; <span class="number">0</span>){</span><br><span class="line">            <span class="comment">//再次传入线程保存的version</span></span><br><span class="line">            <span class="keyword">int</span> update = redPacketService.decreaseRedPacketForVersion(redPacketId, redPacket.getVersion());</span><br><span class="line">            <span class="comment">//如果没有数据更新，则说明其他线程已经修改过数据，则重新抢夺</span></span><br><span class="line">            <span class="keyword">if</span>(update == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">//生成抢红包信息</span></span><br><span class="line">            UserRedPacket userRedPacket = <span class="keyword">new</span> UserRedPacket();</span><br><span class="line">            userRedPacket.setRedPacketId(redPacketId);</span><br><span class="line">            userRedPacket.setUserId(userId);</span><br><span class="line">            userRedPacket.setAmount(redPacket.getUnitAmount());</span><br><span class="line">            userRedPacket.setNote(<span class="string">"抢红包 "</span> + redPacketId);</span><br><span class="line">            System.out.println(userId);</span><br><span class="line">            <span class="comment">//插入抢红包信息</span></span><br><span class="line">            <span class="keyword">return</span> userRedPacketDao.grapRedPacket(userRedPacket);</span><br><span class="line">        }<span class="keyword">else</span> <span class="keyword">return</span>  FAILED; <span class="comment">//没有库存</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>测试结果</strong></p>
<p>从结果看，之前大量失败的场景消失了，也没有超发现象，所有红包都抢光了，避免了总是失败的结果，但是有时候时间戳并不是那么稳定，也会随着系统的空闲或者繁忙导致重试次数不一。</p>
<h4 id="限制重试次数方案"><a href="#限制重试次数方案" class="headerlink" title="限制重试次数方案"></a>限制重试次数方案</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">grapRedPacket</span><span class="params">(Long redPacketId, Long userId)</span> </span>{</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i ++){</span><br><span class="line">            <span class="comment">//获取红包信息</span></span><br><span class="line">            RedPacket redPacket = redPacketService.getRedPacket(redPacketId);</span><br><span class="line">            <span class="comment">//当前小红包库存大于0</span></span><br><span class="line">            <span class="keyword">if</span>(redPacket.getStock() &gt; <span class="number">0</span>){</span><br><span class="line">                <span class="comment">//再次传入线程保存的version</span></span><br><span class="line">                <span class="keyword">int</span> update = redPacketService.decreaseRedPacketForVersion(redPacketId, redPacket.getVersion());</span><br><span class="line">                <span class="comment">//如果没有数据更新，则说明其他线程已经修改过数据，则重新抢夺</span></span><br><span class="line">                <span class="keyword">if</span>(update == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">//生成抢红包信息</span></span><br><span class="line">                UserRedPacket userRedPacket = <span class="keyword">new</span> UserRedPacket();</span><br><span class="line">                userRedPacket.setRedPacketId(redPacketId);</span><br><span class="line">                userRedPacket.setUserId(userId);</span><br><span class="line">                userRedPacket.setAmount(redPacket.getUnitAmount());</span><br><span class="line">                userRedPacket.setNote(<span class="string">"抢红包 "</span> + redPacketId);</span><br><span class="line">                System.out.println(userId);</span><br><span class="line">                <span class="comment">//插入抢红包信息</span></span><br><span class="line">                <span class="keyword">return</span> userRedPacketDao.grapRedPacket(userRedPacket);</span><br><span class="line">            }<span class="keyword">else</span> <span class="keyword">return</span>  FAILED; <span class="comment">//没有库存</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> FAILED;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>测试结果</strong></p>
<p>所有红包都被抢到了，也没有超发现象，这样就可以消除大量的请求失败，避免非重入的时候大量请求失败的场景。</p>
<p>但是现在是使用数据库的情况，有时候并不想使用数据库作为抢红包时刻的数据保存载体，而是选择性能优于数据库的Redis。</p>
<h2 id="使用Redis实现抢红包"><a href="#使用Redis实现抢红包" class="headerlink" title="使用Redis实现抢红包"></a>使用Redis实现抢红包</h2><p>数据库最终会将数据保存到磁盘中，而Redis使用的是内存，内存的速度比磁盘速度快得多。但是需要知道的是Redis的功能不如数据库强大，事务也不完整，因此要保证数据的正确性，数据的正确性可以通过严格的验证得以保证。而</p>
<h3 id="使用注解方式配置Redis"><a href="#使用注解方式配置Redis" class="headerlink" title="使用注解方式配置Redis"></a>使用注解方式配置Redis</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.utils.RedisMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp2.BasicDataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.CacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.task.TaskExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheWriter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.jedis.JedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.ChannelTopic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.RedisMessageListenerContainer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.Topic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.JdkSerializationRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> javax.xml.crypto.Data;</span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//@EnableCaching</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = <span class="string">"com.louris.springboot.utils"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"poolConfig"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisPoolConfig <span class="title">getPoolConfig</span><span class="params">()</span></span>{</span><br><span class="line">        JedisPoolConfig poolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        <span class="comment">//最大空闲数</span></span><br><span class="line">        poolConfig.setMaxIdle(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">//最大连接数</span></span><br><span class="line">        poolConfig.setMaxTotal(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">//最大等待时间</span></span><br><span class="line">        poolConfig.setMaxWaitMillis(<span class="number">20000</span>);</span><br><span class="line">        <span class="keyword">return</span> poolConfig;</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"connectionFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">getJedisConnectionFactory</span><span class="params">()</span></span>{</span><br><span class="line">        JedisConnectionFactory factory = <span class="keyword">new</span> JedisConnectionFactory(getPoolConfig());</span><br><span class="line">        factory.setHostName(<span class="string">"localhost"</span>);</span><br><span class="line">        factory.setPort(<span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//factory.setPassword("123456");</span></span><br><span class="line">        factory.afterPropertiesSet(); <span class="comment">//调用后初始化方法，没有它将抛出异常</span></span><br><span class="line">        <span class="comment">//factory.setPoolConfig(getPoolConfig());</span></span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"jdkSerializationRedisSerializer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdkSerializationRedisSerializer <span class="title">getJdkRedisSerializer</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdkSerializationRedisSerializer();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"stringRedisSerializer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> StringRedisSerializer <span class="title">getStringRedisSerializer</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, String&gt; <span class="title">getRedisTemplate</span><span class="params">()</span></span>{</span><br><span class="line">        RedisTemplate&lt;String, String&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        <span class="comment">//设置连接工程</span></span><br><span class="line">        redisTemplate.setConnectionFactory(getJedisConnectionFactory());</span><br><span class="line">        <span class="comment">//设置序列化器</span></span><br><span class="line">        redisTemplate.setDefaultSerializer(getStringRedisSerializer());</span><br><span class="line">        redisTemplate.setKeySerializer(getStringRedisSerializer());</span><br><span class="line">        redisTemplate.setValueSerializer(getStringRedisSerializer());</span><br><span class="line">        redisTemplate.setHashKeySerializer(getStringRedisSerializer());</span><br><span class="line">        redisTemplate.setHashValueSerializer(getStringRedisSerializer());</span><br><span class="line">        redisTemplate.setEnableTransactionSupport(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Bean(name = "redisCache")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">initRedisCacheManager</span><span class="params">(@Autowired RedisTemplate redisTemplate)</span></span>{</span><br><span class="line">        RedisCacheWriter writer = RedisCacheWriter.lockingRedisCacheWriter(getJedisConnectionFactory());</span><br><span class="line">        <span class="comment">//启动Redis缓存的默认设置</span></span><br><span class="line">        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line">        <span class="comment">//设置JDK序列化器</span></span><br><span class="line">        config = config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(getJdkRedisSerializer()));</span><br><span class="line">        <span class="comment">//禁用前缀</span></span><br><span class="line">        config = config.disableKeyPrefix();</span><br><span class="line">        <span class="comment">//设置1min超时</span></span><br><span class="line">        config = config.entryTtl(Duration.ofSeconds(<span class="number">60</span>));</span><br><span class="line">        <span class="comment">//创建Redis缓存管理器</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheManager(writer, config);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Bean(name = "taskExecutor")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">getExecutor</span><span class="params">()</span></span>{</span><br><span class="line">        ThreadPoolTaskExecutor taskExecutor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        taskExecutor.setCorePoolSize(<span class="number">20</span>);</span><br><span class="line">        <span class="keyword">return</span> taskExecutor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisMessageListener listener = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Bean(name = "topicContainer")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title">getContainer</span><span class="params">()</span></span>{</span><br><span class="line">        RedisMessageListenerContainer container = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line">        container.setConnectionFactory(getJedisConnectionFactory());</span><br><span class="line">        container.setTaskExecutor(getExecutor());</span><br><span class="line">        ChannelTopic channelTopic = <span class="keyword">new</span> ChannelTopic(<span class="string">"chat"</span>);</span><br><span class="line">        container.addMessageListener(listener, channelTopic);</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="数据存储设计"><a href="#数据存储设计" class="headerlink" title="数据存储设计"></a>数据存储设计</h3><p>Redis并不是一个严格的事务，而且事务的功能也是有限的。加上Redis本身的命令也比较有限，功能性不强，为了增强功能性，还可以使用Lua语言。Redis中的Lua语言是一种原子性的操作，可以保证数据的一致性。依据这个原理可以避免超发现象，完成抢红包的功能，而且对于性能而言，Redis会比数据库快得多。</p>
<p>第一次运行Lua脚本的时候，先在Redis中编译和缓存脚本，这样就可以得到一个SHA1字符串，之后通过SHA1字符串和参数就能调用Lua脚本了。</p>
<h4 id="redPacket-lua脚本"><a href="#redPacket-lua脚本" class="headerlink" title="redPacket.lua脚本"></a>redPacket.lua脚本</h4><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--缓存抢红包列表信息列表key</span></span><br><span class="line"><span class="keyword">local</span> listKey = <span class="string">'red_packet_list_'</span>..KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="comment">--当前被抢红包key</span></span><br><span class="line"><span class="keyword">local</span> redPacket = <span class="string">'red_packet_'</span>..KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="comment">--获取当前红包库存</span></span><br><span class="line"><span class="keyword">local</span> stock = <span class="built_in">tonumber</span>(redis.call(<span class="string">'hget'</span>, redPacket, <span class="string">'stock'</span>))</span><br><span class="line"><span class="comment">--没有库存，返回为0</span></span><br><span class="line"><span class="keyword">if</span> stock &lt;= <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">end</span></span><br><span class="line"><span class="comment">--库存减1</span></span><br><span class="line">stock = stock - <span class="number">1</span></span><br><span class="line"><span class="comment">--保存当前库存</span></span><br><span class="line">redis.call(<span class="string">'hset'</span>, redPacket, <span class="string">'stock'</span>, <span class="built_in">tostring</span>(stock))</span><br><span class="line"><span class="comment">--往链表中加入当前红包信息</span></span><br><span class="line">redis.call(<span class="string">'rpush'</span>, listKey, ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="comment">--如果是最后一个红包，则返回2，表示抢红包已经结束，需要将列表中的数据保存到数据库中</span></span><br><span class="line"><span class="keyword">if</span> stock == <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">2</span> <span class="keyword">end</span></span><br><span class="line"><span class="comment">--如果并非最后一个红包，则返回1，表示抢红包成功</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>

<p>流程：</p>
<ul>
<li>判断是否存在可抢的库存，如果已经没有可抢夺的红包，则返回为0，结束流程；</li>
<li>有可抢夺的红包，对于红包的库存减一，然后重新设置库存；</li>
<li>将抢红包数据保存到Redis的链表当中，链表的key为red_packet_list_{id}；</li>
<li>如果当前库存为0，那么返回2，这说明可以触发数据库对Redis链表数据的保存，链表的key为red_packet_list_{id}，它将保存抢红包的用户名和抢的时间；</li>
<li>如果当前库存不为0，那么将返回1，这说明抢红包信息保存成功。</li>
</ul>
<h4 id="RedisRedPackerService接口"><a href="#RedisRedPackerService接口" class="headerlink" title="RedisRedPackerService接口"></a>RedisRedPackerService接口</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedisRedPacketService</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">saveUserRedPacketByRedis</span><span class="params">(Long redPacketId, Double unitAmount)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="实现类"><a href="#实现类" class="headerlink" title="实现类"></a>实现类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.UserRedPacket;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RedisRedPacketService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.BoundListOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Async;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"><span class="keyword">import</span> java.sql.Timestamp;</span><br><span class="line"><span class="keyword">import</span> java.text.DateFormat;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisRedPacketServiceImpl</span> <span class="keyword">implements</span> <span class="title">RedisRedPacketService</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX = <span class="string">"red_packet_list_"</span>;</span><br><span class="line">    <span class="comment">//每次取出1000条，避免一次取出消耗太多内存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIME_SIZE = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Async</span> <span class="comment">//开启新线程运行</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUserRedPacketByRedis</span><span class="params">(Long redPacketId, Double unitAmount)</span> </span>{</span><br><span class="line">        System.out.println(<span class="string">"开始保存数据"</span>);</span><br><span class="line">        Long start = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//获取列表操作对象</span></span><br><span class="line">        BoundListOperations ops = redisTemplate.boundListOps(PREFIX + redPacketId);</span><br><span class="line">        Long size = ops.size();</span><br><span class="line">        Long times = size % TIME_SIZE == <span class="number">0</span> ? size / TIME_SIZE : size / TIME_SIZE + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        List&lt;UserRedPacket&gt; userRedPacketList = <span class="keyword">new</span> ArrayList&lt;&gt;(TIME_SIZE);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; times; i ++){</span><br><span class="line">            <span class="comment">//获取至多TIME_SIZE个抢红包信息</span></span><br><span class="line">            List userIdList = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>){</span><br><span class="line">                userIdList = ops.range(i * TIME_SIZE, (i + <span class="number">1</span>) * TIME_SIZE);</span><br><span class="line">            }<span class="keyword">else</span>{</span><br><span class="line">                userIdList = ops.range(i * TIME_SIZE + <span class="number">1</span>, (i + <span class="number">1</span>) * TIME_SIZE);</span><br><span class="line">            }</span><br><span class="line">            userRedPacketList.clear();</span><br><span class="line">            <span class="comment">//保存红包信息</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; userIdList.size(); j ++){</span><br><span class="line">                String args = userIdList.get(j).toString();</span><br><span class="line">                String[] arr = args.split(<span class="string">"-"</span>);</span><br><span class="line">                String userIdStr = arr[<span class="number">0</span>];</span><br><span class="line">                String timeStr = arr[<span class="number">1</span>];</span><br><span class="line">                Long userId = Long.parseLong(userIdStr);</span><br><span class="line">                Long time = Long.parseLong(timeStr);</span><br><span class="line">                <span class="comment">//生成抢红包信息</span></span><br><span class="line">                UserRedPacket userRedPacket = <span class="keyword">new</span> UserRedPacket();</span><br><span class="line">                userRedPacket.setRedPacketId(redPacketId);</span><br><span class="line">                userRedPacket.setUserId(userId);</span><br><span class="line">                userRedPacket.setAmount(unitAmount);</span><br><span class="line">                userRedPacket.setGrabTime(<span class="keyword">new</span> Timestamp(time));</span><br><span class="line">                userRedPacket.setNote(<span class="string">"抢红包 "</span> + redPacketId);</span><br><span class="line">                userRedPacketList.add(userRedPacket);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//插入抢红包信息</span></span><br><span class="line">            count += executeBatch(userRedPacketList);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//删除Redis列表</span></span><br><span class="line">        redisTemplate.delete(PREFIX + redPacketId);</span><br><span class="line">        Long end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"保存数据结束，耗时"</span> + (end - start) + <span class="string">"毫秒，共"</span> + count + <span class="string">"条记录被保存。"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">executeBatch</span><span class="params">(List&lt;UserRedPacket&gt; userRedPacketList)</span></span>{</span><br><span class="line">        Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span>[] count = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            conn = dataSource.getConnection();</span><br><span class="line">            conn.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">            stmt = conn.createStatement();</span><br><span class="line">            <span class="keyword">for</span>(UserRedPacket userRedPacket:userRedPacketList){</span><br><span class="line">                String sql1 = <span class="string">"update t_red_packet set stock = stock - 1 where id = "</span> + userRedPacket.getRedPacketId();</span><br><span class="line">                DateFormat df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">                String sql2 = <span class="string">"insert into t_user_red_packet(red_packet_id, user_id, "</span></span><br><span class="line">                        + <span class="string">"amount, grab_time, note)"</span></span><br><span class="line">                        + <span class="string">"values("</span> + userRedPacket.getRedPacketId() + <span class="string">", "</span></span><br><span class="line">                        + userRedPacket.getUserId() + <span class="string">", "</span></span><br><span class="line">                        + userRedPacket.getAmount() + <span class="string">","</span></span><br><span class="line">                        + <span class="string">"'"</span> + df.format(userRedPacket.getGrabTime()) + <span class="string">"',"</span></span><br><span class="line">                        + <span class="string">"'"</span> + userRedPacket.getNote() + <span class="string">"')"</span>;</span><br><span class="line">                stmt.addBatch(sql1);</span><br><span class="line">                stmt.addBatch(sql2);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//执行批量</span></span><br><span class="line">            count = stmt.executeBatch();</span><br><span class="line">            <span class="comment">//提交事务</span></span><br><span class="line">            conn.commit();</span><br><span class="line">        }<span class="keyword">catch</span> (SQLException e){</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"抢红包批量执行程序错误"</span>);</span><br><span class="line">        }<span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">try</span>{</span><br><span class="line">                <span class="keyword">if</span>(conn != <span class="keyword">null</span> &amp;&amp; !conn.isClosed()){</span><br><span class="line">                    conn.close();</span><br><span class="line">                }</span><br><span class="line">            }<span class="keyword">catch</span> (SQLException e){</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//返回插入抢红包数据记录</span></span><br><span class="line">        <span class="keyword">return</span> count.length / <span class="number">2</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="异步配置类"><a href="#异步配置类" class="headerlink" title="异步配置类"></a>异步配置类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.apache.bcel.generic.TABLESWITCH;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.AsyncConfigurerSupport;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableAsync;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncConfig</span> <span class="keyword">extends</span> <span class="title">AsyncConfigurerSupport</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">getAsyncExecutor</span><span class="params">()</span> </span>{</span><br><span class="line">        ThreadPoolTaskExecutor taskExecutor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        taskExecutor.setCorePoolSize(<span class="number">5</span>);</span><br><span class="line">        taskExecutor.setMaxPoolSize(<span class="number">10</span>);</span><br><span class="line">        taskExecutor.setQueueCapacity(<span class="number">200</span>);</span><br><span class="line">        taskExecutor.initialize();</span><br><span class="line">        <span class="keyword">return</span> taskExecutor;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="抢红包实现类"><a href="#抢红包实现类" class="headerlink" title="抢红包实现类"></a>抢红包实现类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louris.springboot.IoCImpl.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.RedPacket;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.beans.pojo.UserRedPacket;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.RedPacketDao;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.mapper.UserRedPacketDao;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RedPacketService;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.RedisRedPacketService;</span><br><span class="line"><span class="keyword">import</span> com.louris.springboot.IoCImpl.service.UserRedPacketService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Isolation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRedPacketServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserRedPacketService</span> </span>{</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"redisTemplate"</span>)</span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisRedPacketService redisRedPacketService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Lua脚本</span></span><br><span class="line">    String script = <span class="string">"local listKey = 'red_packet_list_'..KEYS[1] \n"</span></span><br><span class="line">            + <span class="string">"local redPacket = 'red_packet_'..KEYS[1] \n"</span></span><br><span class="line">            + <span class="string">"local stock = tonumber(redis.call('hget', redPacket, 'stock')) \n"</span></span><br><span class="line">            + <span class="string">"if stock &lt;= 0 then return 0 end \n"</span></span><br><span class="line">            + <span class="string">"stock = stock - 1 \n"</span></span><br><span class="line">            + <span class="string">"redis.call('hset', redPacket, 'stock', tostring(stock)) \n"</span></span><br><span class="line">            + <span class="string">"redis.call('rpush', listKey, ARGV[1]) \n"</span></span><br><span class="line">            + <span class="string">"if stock == 0 then return 2 end \n"</span></span><br><span class="line">            + <span class="string">"return 1 \n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在缓存Lua脚本后，使用该变量保存Redis返回的32位SHA1编码，使用它去执行缓存的Lua脚本</span></span><br><span class="line">    String sha1 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">grapRedPacketByRedis</span><span class="params">(Long redPacketId, Long userId)</span> </span>{</span><br><span class="line">        <span class="comment">//当前抢红包用户和日期信息</span></span><br><span class="line">        String args = userId + <span class="string">"-"</span> + System.currentTimeMillis();</span><br><span class="line">        Long result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//获取底层Redis操作对象</span></span><br><span class="line">        Jedis jedis = (Jedis) redisTemplate.getConnectionFactory().getConnection().getNativeConnection();</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="comment">//如果脚本没有加载过，那么进行加载，这样就会返回一个sha1编码</span></span><br><span class="line">            <span class="keyword">if</span>(sha1 == <span class="keyword">null</span>){</span><br><span class="line">                sha1 = jedis.scriptLoad(script);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//执行脚本，返回结果</span></span><br><span class="line">            Object res = jedis.evalsha(sha1, <span class="number">1</span>, redPacketId + <span class="string">""</span>, args);</span><br><span class="line">            result = (Long) res;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//返回2时为最后一个红包，此时将抢红包信息通过异步保存到数据库中</span></span><br><span class="line">            <span class="keyword">if</span>(result == <span class="number">2</span>){</span><br><span class="line">                <span class="comment">//获取单个小红包金额</span></span><br><span class="line">                String unitAmountStr = jedis.hget(<span class="string">"red_packet_"</span> + redPacketId, <span class="string">"unit_amount"</span>);</span><br><span class="line">                System.out.println(unitAmountStr);</span><br><span class="line">                <span class="comment">//触发保存数据库操作</span></span><br><span class="line">                Double unitAmount = Double.parseDouble(unitAmountStr);</span><br><span class="line">                System.out.println(<span class="string">"thread_name = "</span> + Thread.currentThread().getName());</span><br><span class="line">                redisRedPacketService.saveUserRedPacketByRedis(redPacketId, unitAmount);</span><br><span class="line">            }</span><br><span class="line">        }<span class="keyword">finally</span> {</span><br><span class="line">            <span class="comment">//确保jedis顺利关闭</span></span><br><span class="line">            <span class="keyword">if</span>(jedis != <span class="keyword">null</span> &amp;&amp; jedis.isConnected()){</span><br><span class="line">                jedis.close();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="页面-2"><a href="#页面-2" class="headerlink" title="页面"></a>页面</h4><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: louris</span><br><span class="line">  Date: <span class="number">2021</span>/<span class="number">10</span>/<span class="number">17</span></span><br><span class="line">  Time: <span class="number">19</span>:<span class="number">47</span></span><br><span class="line">  To change <span class="keyword">this</span> template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;抢红包测试&lt;/title&gt;</span><br><span class="line">    &lt;script src="https://code.jquery.com/jquery-3.2.0.js" type="text/javascript"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">        $(document).ready(function () {</span><br><span class="line">            <span class="comment">//模拟300个异步请求，进行并发</span></span><br><span class="line">            <span class="keyword">var</span> max = <span class="number">300</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= max; i ++){</span><br><span class="line">                <span class="comment">//jQuery的post请求，请注意这是异步请求</span></span><br><span class="line">                $.post({</span><br><span class="line">                    <span class="comment">//请求抢id为1的红包</span></span><br><span class="line">                    url: <span class="string">"./grapRedPacketByRedis?redPacketId=1&amp;userId="</span> + i,</span><br><span class="line">                    <span class="comment">//成功后的方法</span></span><br><span class="line">                    success: function (result) {</span><br><span class="line"></span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="控制类"><a href="#控制类" class="headerlink" title="控制类"></a>控制类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/grapRedPacketByRedis"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">grapRedPacketByRedis</span><span class="params">(Long redPacketId, Long userId)</span></span>{</span><br><span class="line">        Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Long result = userRedPacketService.grapRedPacketByRedis(redPacketId, userId);</span><br><span class="line">        <span class="keyword">boolean</span> flag = result &gt; <span class="number">0</span>;</span><br><span class="line">        resultMap.put(<span class="string">"result"</span>, flag);</span><br><span class="line">        resultMap.put(<span class="string">"message"</span>, flag ? <span class="string">"抢红包成功"</span> : <span class="string">"抢红包失败"</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><figure class="highlight cmd"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hset red_packet_1 stock <span class="number">200</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; hset red_packet_1 unit_amount <span class="number">10</span></span><br><span class="line">(integer) <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span></span><br><span class="line">thread_name = http-nio-<span class="number">8081</span>-exec-<span class="number">4</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">18</span> <span class="number">23</span>:<span class="number">12</span>:<span class="number">52.008</span> [http-nio-<span class="number">8081</span>-exec-<span class="number">4</span>] INFO  o.s.scheduling.concurrent.ThreadPoolTaskExecutor - Initializing ExecutorService</span><br><span class="line">开始保存数据</span><br><span class="line">保存数据结束，耗时<span class="number">412</span>毫秒，共<span class="number">200</span>条记录被保存。</span><br></pre></td></tr></tbody></table></figure>

<h2 id="并发思考"><a href="#并发思考" class="headerlink" title="并发思考"></a>并发思考</h2><p>知识点：</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/26960178" target="_blank" rel="noopener">三级封锁协议</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/363967886" target="_blank" rel="noopener">for update知识点</a></li>
</ul>
<h3 id="仅读已提交隔离级别"><a href="#仅读已提交隔离级别" class="headerlink" title="仅读已提交隔离级别"></a>仅读已提交隔离级别</h3><p>如前面所述，减库存事务包含两步：读库存和减库存；结果是将发生超发现象。</p>
<p>读已提交对应二级封锁协议，以库存为1，有两个请求并发减库存为例：<br>事务1和事务2几乎同时对数据行r加S锁，都读到库存为1，随后都释放S锁，然后事务1先减库存加X锁，期间事务2阻塞，事务1释放X锁后，事务2才能修改数据，这样就造成了两次减库存，超发了！</p>
<h3 id="for-update悲观锁实现"><a href="#for-update悲观锁实现" class="headerlink" title="for update悲观锁实现"></a>for update悲观锁实现</h3><p>乐观锁for update是对读取数据加X锁，只有update或者事务结束了才会释放X锁。<br>以库存为1，有两个请求并发减库存为例：<br>事务1先读数据，加了X锁，事务2这时候读阻塞，事务1更新完数据或者事务回退释放X锁后，事务2才能读库存和写库存，保证了数据一致性。</p>
<h3 id="CAS乐观锁实现"><a href="#CAS乐观锁实现" class="headerlink" title="CAS乐观锁实现"></a>CAS乐观锁实现</h3><p>以库存为1，有两个请求并发减库存为例：<br>事务1和事务2几乎同时对数据行r加S锁，都读到库存为1，随后都释放S锁，然后事务1先减库存加X锁，期间事务2减库存阻塞</p>
<ul>
<li>如果事务1减库存成功，释放X锁后，事务2再次读取库存以及version，发现不一致，不进行减库存；</li>
<li>如果事务1减库存失败回退，释放X锁后，事务2再次读取库存以及version，发现一致，进行减库存；<br>这样也保证了数据的一致性，同时并没有像悲观锁那样更耗时。</li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Tech</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">Spring</a>
        		</li>
      		
		</ul>
	</div>

      

      

      
        
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="http://s.jiathis.com/qrcode.php?url=https://lourisxu.github.io/2021/09/03/springspringmvcmybatis.html/" alt="微信分享二维码">
    </div>
</div>

<div class="mask js-mask"></div>
      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2021/10/22/springsecurity.html/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          spring-security
        
      </div>
    </a>
  
  
    <a href="/2021/05/16/springbootcourse.html/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">SpringBootCourse</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>


<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
        <div class="toc-container tooltip-left">
            <i class="icon-font icon-category"></i>
            <div class="tooltip tooltip-east">
                <span class="tooltip-item">
                </span>
                <span class="tooltip-content">
                  <div class="toc-article">
                  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Java设计模式"><span class="toc-number">2.</span> <span class="toc-text">Java设计模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#反射"><span class="toc-number">2.1.</span> <span class="toc-text">反射</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#反射技术"><span class="toc-number">2.1.1.</span> <span class="toc-text">反射技术</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#静态代理"><span class="toc-number">2.2.</span> <span class="toc-text">静态代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态代理"><span class="toc-number">2.3.</span> <span class="toc-text">动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JDK动态代理"><span class="toc-number">2.3.1.</span> <span class="toc-text">JDK动态代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cglib动态代理"><span class="toc-number">2.3.2.</span> <span class="toc-text">Cglib动态代理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#拦截器"><span class="toc-number">2.4.</span> <span class="toc-text">拦截器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#责任链模式-多级代理"><span class="toc-number">2.5.</span> <span class="toc-text">责任链模式&#x2F;多级代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#观察者模式"><span class="toc-number">2.6.</span> <span class="toc-text">观察者模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建造者模式"><span class="toc-number">2.7.</span> <span class="toc-text">建造者模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简单实现以及建造者模式对比"><span class="toc-number">2.7.1.</span> <span class="toc-text">简单实现以及建造者模式对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#静态内部类的实现"><span class="toc-number">2.7.2.</span> <span class="toc-text">静态内部类的实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#互联网持久层框架——MyBatis"><span class="toc-number">3.</span> <span class="toc-text">互联网持久层框架——MyBatis</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#认识MyBatis核心组件"><span class="toc-number">4.</span> <span class="toc-text">认识MyBatis核心组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Mybatis的核心组件"><span class="toc-number">4.1.</span> <span class="toc-text">Mybatis的核心组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SqlSessionFactory"><span class="toc-number">4.1.1.</span> <span class="toc-text">SqlSessionFactory</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#XML构建方式（推荐）"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">XML构建方式（推荐）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代码构建方式"><span class="toc-number">4.1.1.2.</span> <span class="toc-text">代码构建方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SqlSession"><span class="toc-number">4.1.2.</span> <span class="toc-text">SqlSession</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mapper映射器"><span class="toc-number">4.1.3.</span> <span class="toc-text">Mapper映射器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#POJO和映射接口"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">POJO和映射接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XML映射文件实现"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">XML映射文件实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注解实现"><span class="toc-number">4.1.3.3.</span> <span class="toc-text">注解实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlSession发送SQL"><span class="toc-number">4.1.3.4.</span> <span class="toc-text">SqlSession发送SQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用Mapper接口发送SQL（推荐）"><span class="toc-number">4.1.3.5.</span> <span class="toc-text">用Mapper接口发送SQL（推荐）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#生命周期"><span class="toc-number">4.2.</span> <span class="toc-text">生命周期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实例"><span class="toc-number">4.3.</span> <span class="toc-text">实例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#log4j-properties"><span class="toc-number">4.3.1.</span> <span class="toc-text">log4j.properties</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mybatis-config-xml"><span class="toc-number">4.3.2.</span> <span class="toc-text">mybatis-config.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RoleMapper-xml"><span class="toc-number">4.3.3.</span> <span class="toc-text">RoleMapper.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Role"><span class="toc-number">4.3.4.</span> <span class="toc-text">Role</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RoleMapper"><span class="toc-number">4.3.5.</span> <span class="toc-text">RoleMapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SqlSessionFactoryUtil"><span class="toc-number">4.3.6.</span> <span class="toc-text">SqlSessionFactoryUtil</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#运行结果"><span class="toc-number">4.3.7.</span> <span class="toc-text">运行结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MyBatis配置"><span class="toc-number">5.</span> <span class="toc-text">MyBatis配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#properties属性"><span class="toc-number">5.1.</span> <span class="toc-text">properties属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#property子元素"><span class="toc-number">5.1.1.</span> <span class="toc-text">property子元素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用properties文件"><span class="toc-number">5.1.2.</span> <span class="toc-text">使用properties文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用程序传递方式传递参数"><span class="toc-number">5.1.3.</span> <span class="toc-text">使用程序传递方式传递参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优先级"><span class="toc-number">5.1.4.</span> <span class="toc-text">优先级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#settings设置"><span class="toc-number">5.2.</span> <span class="toc-text">settings设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#typeAliases别名"><span class="toc-number">5.3.</span> <span class="toc-text">typeAliases别名</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#系统定义别名"><span class="toc-number">5.3.1.</span> <span class="toc-text">系统定义别名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义别名"><span class="toc-number">5.3.2.</span> <span class="toc-text">自定义别名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#typeHandler类型转换器"><span class="toc-number">5.4.</span> <span class="toc-text">typeHandler类型转换器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#系统定义的typeHandler"><span class="toc-number">5.4.1.</span> <span class="toc-text">系统定义的typeHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义typeHandler"><span class="toc-number">5.4.2.</span> <span class="toc-text">自定义typeHandler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MyTypeHandler"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">MyTypeHandler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoleMapper-xml-1"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">RoleMapper.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoleMapper-1"><span class="toc-number">5.4.2.3.</span> <span class="toc-text">RoleMapper</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlSessionFactoryUtils"><span class="toc-number">5.4.2.4.</span> <span class="toc-text">SqlSessionFactoryUtils</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行结果-1"><span class="toc-number">5.4.2.5.</span> <span class="toc-text">运行结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#枚举typeHandler"><span class="toc-number">5.4.3.</span> <span class="toc-text">枚举typeHandler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UserMapper-xml"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">UserMapper.xml</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#EnumOrdinalTypeHandler方式"><span class="toc-number">5.4.3.1.1.</span> <span class="toc-text">EnumOrdinalTypeHandler方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EnumTypeHandler方式"><span class="toc-number">5.4.3.1.2.</span> <span class="toc-text">EnumTypeHandler方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SexEnum"><span class="toc-number">5.4.3.2.</span> <span class="toc-text">SexEnum</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#User"><span class="toc-number">5.4.3.3.</span> <span class="toc-text">User</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UserMapper"><span class="toc-number">5.4.3.4.</span> <span class="toc-text">UserMapper</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mybatis-config-xml-1"><span class="toc-number">5.4.3.5.</span> <span class="toc-text">mybatis-config.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SqlSessionFactoryUtils-1"><span class="toc-number">5.4.3.6.</span> <span class="toc-text">SqlSessionFactoryUtils</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行结果-2"><span class="toc-number">5.4.3.7.</span> <span class="toc-text">运行结果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#结果①"><span class="toc-number">5.4.3.7.1.</span> <span class="toc-text">结果①</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#结果②"><span class="toc-number">5.4.3.7.2.</span> <span class="toc-text">结果②</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义枚举typeHandler"><span class="toc-number">5.4.3.8.</span> <span class="toc-text">自定义枚举typeHandler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件操作-（不太常用）"><span class="toc-number">5.4.4.</span> <span class="toc-text">文件操作 （不太常用）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ObjectFactory（对象工厂）"><span class="toc-number">5.5.</span> <span class="toc-text">ObjectFactory（对象工厂）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MyObjectFactory"><span class="toc-number">5.5.1.</span> <span class="toc-text">MyObjectFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mybatis-config-xml-2"><span class="toc-number">5.5.2.</span> <span class="toc-text">mybatis-config.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#运行结果-3"><span class="toc-number">5.5.3.</span> <span class="toc-text">运行结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件"><span class="toc-number">5.6.</span> <span class="toc-text">插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#enviroments（运行环境）"><span class="toc-number">5.7.</span> <span class="toc-text">enviroments（运行环境）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#transactionManager（事务管理器）"><span class="toc-number">5.7.1.</span> <span class="toc-text">transactionManager（事务管理器）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#简介"><span class="toc-number">5.7.1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义事务工厂"><span class="toc-number">5.7.1.2.</span> <span class="toc-text">自定义事务工厂</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#environment数据源环境"><span class="toc-number">5.7.2.</span> <span class="toc-text">environment数据源环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UNPOOLED"><span class="toc-number">5.7.2.1.</span> <span class="toc-text">UNPOOLED</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#POOLED"><span class="toc-number">5.7.2.2.</span> <span class="toc-text">POOLED</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNDI"><span class="toc-number">5.7.2.3.</span> <span class="toc-text">JNDI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第三方数据源"><span class="toc-number">5.7.2.4.</span> <span class="toc-text">第三方数据源</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#databaseIdProvider数据库厂商标识"><span class="toc-number">5.8.</span> <span class="toc-text">databaseIdProvider数据库厂商标识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用系统默认的databaseIdProvider"><span class="toc-number">5.8.1.</span> <span class="toc-text">使用系统默认的databaseIdProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不使用系统规则"><span class="toc-number">5.8.2.</span> <span class="toc-text">不使用系统规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#引入映射器的方法"><span class="toc-number">5.9.</span> <span class="toc-text">引入映射器的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mapper接口"><span class="toc-number">5.9.1.</span> <span class="toc-text">Mapper接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mapper-xml"><span class="toc-number">5.9.2.</span> <span class="toc-text">Mapper.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引入方法"><span class="toc-number">5.9.3.</span> <span class="toc-text">引入方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#映射器"><span class="toc-number">6.</span> <span class="toc-text">映射器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#select元素"><span class="toc-number">6.1.</span> <span class="toc-text">select元素</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介-1"><span class="toc-number">6.1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动映射和驼峰映射"><span class="toc-number">6.1.2.</span> <span class="toc-text">自动映射和驼峰映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#传递多个参数"><span class="toc-number">6.1.3.</span> <span class="toc-text">传递多个参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#不带注解传递"><span class="toc-number">6.1.3.1.</span> <span class="toc-text">不带注解传递</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#带注解传递"><span class="toc-number">6.1.3.2.</span> <span class="toc-text">带注解传递</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Java-Bean传递"><span class="toc-number">6.1.3.3.</span> <span class="toc-text">Java Bean传递</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#混合传递方式"><span class="toc-number">6.1.3.4.</span> <span class="toc-text">混合传递方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-number">6.1.3.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用resultMap映射结果集"><span class="toc-number">6.1.4.</span> <span class="toc-text">使用resultMap映射结果集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分页参数RowBounds"><span class="toc-number">6.1.5.</span> <span class="toc-text">分页参数RowBounds</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#insert元素"><span class="toc-number">6.2.</span> <span class="toc-text">insert元素</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介-2"><span class="toc-number">6.2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单insert语句应用"><span class="toc-number">6.2.2.</span> <span class="toc-text">简单insert语句应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主键回填"><span class="toc-number">6.2.3.</span> <span class="toc-text">主键回填</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义主键"><span class="toc-number">6.2.4.</span> <span class="toc-text">自定义主键</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#update元素和delete元素"><span class="toc-number">6.3.</span> <span class="toc-text">update元素和delete元素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sql元素"><span class="toc-number">6.4.</span> <span class="toc-text">sql元素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参数"><span class="toc-number">6.5.</span> <span class="toc-text">参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#概述"><span class="toc-number">6.5.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#存储过程参数支持"><span class="toc-number">6.5.2.</span> <span class="toc-text">存储过程参数支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#特殊字符串的替换和处理（-和-）"><span class="toc-number">6.5.3.</span> <span class="toc-text">特殊字符串的替换和处理（#和$）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#resultMap元素"><span class="toc-number">6.6.</span> <span class="toc-text">resultMap元素</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#resultMap元素构成"><span class="toc-number">6.6.1.</span> <span class="toc-text">resultMap元素构成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用map存储结果集（不推荐）"><span class="toc-number">6.6.2.</span> <span class="toc-text">使用map存储结果集（不推荐）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用POJO存储结果集（推荐）"><span class="toc-number">6.6.3.</span> <span class="toc-text">使用POJO存储结果集（推荐）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用resultMap（推荐）"><span class="toc-number">6.6.4.</span> <span class="toc-text">使用resultMap（推荐）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#级联"><span class="toc-number">6.7.</span> <span class="toc-text">级联</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#缓存"><span class="toc-number">6.8.</span> <span class="toc-text">缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一级缓存和二级缓存"><span class="toc-number">6.8.1.</span> <span class="toc-text">一级缓存和二级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#一级缓存触发"><span class="toc-number">6.8.1.1.</span> <span class="toc-text">一级缓存触发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一级缓存未触发"><span class="toc-number">6.8.1.2.</span> <span class="toc-text">一级缓存未触发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一级缓存作用范围"><span class="toc-number">6.8.1.3.</span> <span class="toc-text">一级缓存作用范围</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#开启二级缓存："><span class="toc-number">6.8.1.4.</span> <span class="toc-text">开启二级缓存：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存配置项、自定义和应用"><span class="toc-number">6.8.2.</span> <span class="toc-text">缓存配置项、自定义和应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义缓存实现类"><span class="toc-number">6.8.2.1.</span> <span class="toc-text">自定义缓存实现类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他缓存"><span class="toc-number">6.8.2.2.</span> <span class="toc-text">其他缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#语句自定义缓存"><span class="toc-number">6.8.2.3.</span> <span class="toc-text">语句自定义缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#缓存引用"><span class="toc-number">6.8.2.4.</span> <span class="toc-text">缓存引用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存储过程"><span class="toc-number">6.9.</span> <span class="toc-text">存储过程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#动态SQL"><span class="toc-number">7.</span> <span class="toc-text">动态SQL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述-1"><span class="toc-number">7.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#if元素"><span class="toc-number">7.2.</span> <span class="toc-text">if元素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#choose、when、otherwise元素"><span class="toc-number">7.3.</span> <span class="toc-text">choose、when、otherwise元素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#trim、where、set元素"><span class="toc-number">7.4.</span> <span class="toc-text">trim、where、set元素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#foreach元素"><span class="toc-number">7.5.</span> <span class="toc-text">foreach元素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用test的属性判断字符串"><span class="toc-number">7.6.</span> <span class="toc-text">用test的属性判断字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bind元素"><span class="toc-number">7.7.</span> <span class="toc-text">bind元素</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MyBatis的解析和运行原理"><span class="toc-number">8.</span> <span class="toc-text">MyBatis的解析和运行原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#构建SqlSessionFactory过程"><span class="toc-number">8.1.</span> <span class="toc-text">构建SqlSessionFactory过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#XMLConfigBuilder"><span class="toc-number">8.1.1.</span> <span class="toc-text">XMLConfigBuilder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#构建Configuration"><span class="toc-number">8.1.2.</span> <span class="toc-text">构建Configuration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#构建映射器的内部组成"><span class="toc-number">8.1.3.</span> <span class="toc-text">构建映射器的内部组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#构建SqlSessionFactory"><span class="toc-number">8.1.4.</span> <span class="toc-text">构建SqlSessionFactory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SqlSession运行过程"><span class="toc-number">8.2.</span> <span class="toc-text">SqlSession运行过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#映射器（Mapper）的动态代理"><span class="toc-number">8.2.1.</span> <span class="toc-text">映射器（Mapper）的动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DefaultSqlSession"><span class="toc-number">8.2.1.1.</span> <span class="toc-text">DefaultSqlSession</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Configuration"><span class="toc-number">8.2.1.2.</span> <span class="toc-text">Configuration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MapperRegistry"><span class="toc-number">8.2.1.3.</span> <span class="toc-text">MapperRegistry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MapperProxyFactory"><span class="toc-number">8.2.1.4.</span> <span class="toc-text">MapperProxyFactory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MapperProxy"><span class="toc-number">8.2.1.5.</span> <span class="toc-text">MapperProxy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MapperMethod"><span class="toc-number">8.2.1.6.</span> <span class="toc-text">MapperMethod</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SqlSession下的四大对象"><span class="toc-number">8.2.2.</span> <span class="toc-text">SqlSession下的四大对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Executor——执行器"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">Executor——执行器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StatementHandler——数据库会话器"><span class="toc-number">8.2.2.2.</span> <span class="toc-text">StatementHandler——数据库会话器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ParameterHandler——参数处理器"><span class="toc-number">8.2.2.3.</span> <span class="toc-text">ParameterHandler——参数处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ResultSetHandler——结果处理器"><span class="toc-number">8.2.2.4.</span> <span class="toc-text">ResultSetHandler——结果处理器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SqlSession运行总结"><span class="toc-number">8.2.3.</span> <span class="toc-text">SqlSession运行总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#插件-1"><span class="toc-number">9.</span> <span class="toc-text">插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#插件接口"><span class="toc-number">9.1.</span> <span class="toc-text">插件接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件的初始化"><span class="toc-number">9.2.</span> <span class="toc-text">插件的初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件的代理和反射设计"><span class="toc-number">9.3.</span> <span class="toc-text">插件的代理和反射设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见工具类——MetaObject"><span class="toc-number">9.4.</span> <span class="toc-text">常见工具类——MetaObject</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#确定需要拦截的签名"><span class="toc-number">9.4.1.</span> <span class="toc-text">确定需要拦截的签名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设计拦截器"><span class="toc-number">9.4.2.</span> <span class="toc-text">设计拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现拦截方法"><span class="toc-number">9.4.3.</span> <span class="toc-text">实现拦截方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#插件实例——分页插件"><span class="toc-number">9.4.4.</span> <span class="toc-text">插件实例——分页插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义PageParamsCustom类"><span class="toc-number">9.4.4.1.</span> <span class="toc-text">自定义PageParamsCustom类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义PagePlugin类"><span class="toc-number">9.4.4.2.</span> <span class="toc-text">自定义PagePlugin类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mapper设置以及启动程序"><span class="toc-number">9.4.4.3.</span> <span class="toc-text">mapper设置以及启动程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行结果-4"><span class="toc-number">9.4.4.4.</span> <span class="toc-text">运行结果</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-基础"><span class="toc-number">10.</span> <span class="toc-text">Spring 基础</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-IoC概述"><span class="toc-number">11.</span> <span class="toc-text">Spring IoC概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-IoC容器"><span class="toc-number">11.1.</span> <span class="toc-text">Spring IoC容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-IoC容器的初始化和依赖注入"><span class="toc-number">11.1.1.</span> <span class="toc-text">Spring IoC容器的初始化和依赖注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#依赖注入实例"><span class="toc-number">11.1.1.1.</span> <span class="toc-text">依赖注入实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Bean的生命周期"><span class="toc-number">11.1.2.</span> <span class="toc-text">Spring Bean的生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#测试实现"><span class="toc-number">11.1.2.1.</span> <span class="toc-text">测试实现</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#装配Spring-Bean"><span class="toc-number">12.</span> <span class="toc-text">装配Spring Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#依赖注入的3种方式"><span class="toc-number">12.1.</span> <span class="toc-text">依赖注入的3种方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#构造器注入"><span class="toc-number">12.1.1.</span> <span class="toc-text">构造器注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用setter注入"><span class="toc-number">12.1.2.</span> <span class="toc-text">使用setter注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接口注入"><span class="toc-number">12.1.3.</span> <span class="toc-text">接口注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#装配Bean概述"><span class="toc-number">12.2.</span> <span class="toc-text">装配Bean概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过XML配置装配Bean"><span class="toc-number">12.2.1.</span> <span class="toc-text">通过XML配置装配Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#简单配置类对象"><span class="toc-number">12.2.1.1.</span> <span class="toc-text">简单配置类对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#装配集合等复杂对象"><span class="toc-number">12.2.1.2.</span> <span class="toc-text">装配集合等复杂对象</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命名空间装配"><span class="toc-number">12.2.2.</span> <span class="toc-text">命名空间装配</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过注解装配Bean"><span class="toc-number">12.3.</span> <span class="toc-text">通过注解装配Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-Component装配Bean"><span class="toc-number">12.3.1.</span> <span class="toc-text">使用@Component装配Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注解Bean"><span class="toc-number">12.3.1.1.</span> <span class="toc-text">注解Bean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ComponentScan配置扫描类"><span class="toc-number">12.3.1.2.</span> <span class="toc-text">@ComponentScan配置扫描类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试类"><span class="toc-number">12.3.1.3.</span> <span class="toc-text">测试类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行结果-5"><span class="toc-number">12.3.1.4.</span> <span class="toc-text">运行结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动装配——-Autowired"><span class="toc-number">12.3.2.</span> <span class="toc-text">自动装配——@Autowired</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RoleService"><span class="toc-number">12.3.2.1.</span> <span class="toc-text">RoleService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoleServiceImpl"><span class="toc-number">12.3.2.2.</span> <span class="toc-text">RoleServiceImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PojoConfig"><span class="toc-number">12.3.2.3.</span> <span class="toc-text">PojoConfig</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试启动类"><span class="toc-number">12.3.2.4.</span> <span class="toc-text">测试启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行结果-6"><span class="toc-number">12.3.2.5.</span> <span class="toc-text">运行结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Autowired方法配置"><span class="toc-number">12.3.2.6.</span> <span class="toc-text">@Autowired方法配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动装配的歧义性（-Primary-和-Qualifier）"><span class="toc-number">12.3.3.</span> <span class="toc-text">自动装配的歧义性（@Primary 和 @Qualifier）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Primary"><span class="toc-number">12.3.4.</span> <span class="toc-text">@Primary</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实现"><span class="toc-number">12.3.4.1.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行结果-7"><span class="toc-number">12.3.4.2.</span> <span class="toc-text">运行结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Qualifier"><span class="toc-number">12.3.5.</span> <span class="toc-text">@Qualifier</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#装载带有参数的构造方法类"><span class="toc-number">12.3.6.</span> <span class="toc-text">装载带有参数的构造方法类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-Bean装配Bean"><span class="toc-number">12.3.7.</span> <span class="toc-text">使用@Bean装配Bean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注解自定义Bean的初始化和销毁方法"><span class="toc-number">12.3.8.</span> <span class="toc-text">注解自定义Bean的初始化和销毁方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#装配的混合使用"><span class="toc-number">12.4.</span> <span class="toc-text">装配的混合使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实例-1"><span class="toc-number">12.4.1.</span> <span class="toc-text">实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加载多个配置文件"><span class="toc-number">12.4.2.</span> <span class="toc-text">加载多个配置文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Profile"><span class="toc-number">12.5.</span> <span class="toc-text">使用Profile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用注解-Profile配置"><span class="toc-number">12.5.1.</span> <span class="toc-text">使用注解@Profile配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用XML定义Profile"><span class="toc-number">12.5.2.</span> <span class="toc-text">使用XML定义Profile</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-配置文件的profile属性"><span class="toc-number">12.5.2.1.</span> <span class="toc-text">(1)配置文件的profile属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-配置文件的beans元素的profile属性"><span class="toc-number">12.5.2.2.</span> <span class="toc-text">(2)配置文件的beans元素的profile属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动Profile"><span class="toc-number">12.5.2.3.</span> <span class="toc-text">启动Profile</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取ApplicationContext"><span class="toc-number">12.6.</span> <span class="toc-text">获取ApplicationContext</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义新建ApplicationContext"><span class="toc-number">12.6.1.</span> <span class="toc-text">自定义新建ApplicationContext</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#加载XML配置文件方式"><span class="toc-number">12.6.1.1.</span> <span class="toc-text">加载XML配置文件方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#加载注解配置类方式"><span class="toc-number">12.6.1.2.</span> <span class="toc-text">加载注解配置类方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动类方式"><span class="toc-number">12.6.1.3.</span> <span class="toc-text">启动类方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载属性（properties）文件"><span class="toc-number">12.7.</span> <span class="toc-text">加载属性（properties）文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用注解方式加载属性文件"><span class="toc-number">12.8.</span> <span class="toc-text">使用注解方式加载属性文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PropertySource注解"><span class="toc-number">12.8.1.</span> <span class="toc-text">@PropertySource注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PropertySourcesPlaceholderConfigure-Value注解"><span class="toc-number">12.8.2.</span> <span class="toc-text">@PropertySourcesPlaceholderConfigure + @Value注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用XML方式加载属性文件"><span class="toc-number">12.8.3.</span> <span class="toc-text">使用XML方式加载属性文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#条件化装配Bean"><span class="toc-number">12.9.</span> <span class="toc-text">条件化装配Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义条件类"><span class="toc-number">12.9.1.</span> <span class="toc-text">自定义条件类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Conditional注解"><span class="toc-number">12.9.2.</span> <span class="toc-text">@Conditional注解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bean的作用域"><span class="toc-number">12.10.</span> <span class="toc-text">Bean的作用域</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Spring表达式（Spring-EL）"><span class="toc-number">12.11.</span> <span class="toc-text">使用Spring表达式（Spring EL）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-EL-相关的类"><span class="toc-number">12.11.1.</span> <span class="toc-text">Spring EL 相关的类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#表达式创建对象，调用对象方法"><span class="toc-number">12.11.2.</span> <span class="toc-text">表达式创建对象，调用对象方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bean的属性和方法"><span class="toc-number">12.11.3.</span> <span class="toc-text">Bean的属性和方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用类的静态常量和方法"><span class="toc-number">12.11.4.</span> <span class="toc-text">使用类的静态常量和方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-EL运算"><span class="toc-number">12.11.5.</span> <span class="toc-text">Spring EL运算</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#面向切面编程"><span class="toc-number">13.</span> <span class="toc-text">面向切面编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一个简单的约定游戏"><span class="toc-number">13.1.</span> <span class="toc-text">一个简单的约定游戏</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#约定规则"><span class="toc-number">13.1.1.</span> <span class="toc-text">约定规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-AOP的基本概念"><span class="toc-number">13.2.</span> <span class="toc-text">Spring AOP的基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AOP的概念和使用原因"><span class="toc-number">13.2.1.</span> <span class="toc-text">AOP的概念和使用原因</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JDBC数据库事务"><span class="toc-number">13.2.1.1.</span> <span class="toc-text">JDBC数据库事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring-AOP对应数据库事务"><span class="toc-number">13.2.1.2.</span> <span class="toc-text">Spring AOP对应数据库事务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#面向切面编程的术语"><span class="toc-number">13.2.2.</span> <span class="toc-text">面向切面编程的术语</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring对AOP的支持"><span class="toc-number">13.2.3.</span> <span class="toc-text">Spring对AOP的支持</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-AspectJ注解开发Spring-AOP"><span class="toc-number">13.3.</span> <span class="toc-text">使用@AspectJ注解开发Spring AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#选择切点"><span class="toc-number">13.3.1.</span> <span class="toc-text">选择切点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建切面"><span class="toc-number">13.3.2.</span> <span class="toc-text">创建切面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#连接点"><span class="toc-number">13.3.3.</span> <span class="toc-text">连接点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试AOP"><span class="toc-number">13.3.4.</span> <span class="toc-text">测试AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注解实现-1"><span class="toc-number">13.3.4.1.</span> <span class="toc-text">注解实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XML实现"><span class="toc-number">13.3.4.2.</span> <span class="toc-text">XML实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试"><span class="toc-number">13.3.4.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#环绕通知"><span class="toc-number">13.3.5.</span> <span class="toc-text">环绕通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#织入"><span class="toc-number">13.3.6.</span> <span class="toc-text">织入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#给通知传递参数"><span class="toc-number">13.3.7.</span> <span class="toc-text">给通知传递参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引入"><span class="toc-number">13.3.8.</span> <span class="toc-text">引入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用XML配置开发Spring-AOP"><span class="toc-number">13.4.</span> <span class="toc-text">使用XML配置开发Spring AOP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#经典Spring-AOP应用程序"><span class="toc-number">13.5.</span> <span class="toc-text">经典Spring AOP应用程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多个切面"><span class="toc-number">13.6.</span> <span class="toc-text">多个切面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#多切面排序"><span class="toc-number">13.6.1.</span> <span class="toc-text">多切面排序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring和数据库编程"><span class="toc-number">14.</span> <span class="toc-text">Spring和数据库编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#传统的JDBC代码的弊端"><span class="toc-number">14.1.</span> <span class="toc-text">传统的JDBC代码的弊端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置数据库资源"><span class="toc-number">14.2.</span> <span class="toc-text">配置数据库资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用简单数据库配置"><span class="toc-number">14.2.1.</span> <span class="toc-text">使用简单数据库配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用第三方数据库连接池"><span class="toc-number">14.2.2.</span> <span class="toc-text">使用第三方数据库连接池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用JNDI数据库连接池"><span class="toc-number">14.2.3.</span> <span class="toc-text">使用JNDI数据库连接池</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JDBC代码失控的解决方案——JdbcTemplate"><span class="toc-number">14.3.</span> <span class="toc-text">JDBC代码失控的解决方案——JdbcTemplate</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JdbcTemplate的增删改查"><span class="toc-number">14.3.1.</span> <span class="toc-text">JdbcTemplate的增删改查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行多条SQL"><span class="toc-number">14.3.2.</span> <span class="toc-text">执行多条SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JdbcTemplate源码分析"><span class="toc-number">14.3.3.</span> <span class="toc-text">JdbcTemplate源码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MyBatis-Spring项目"><span class="toc-number">14.4.</span> <span class="toc-text">MyBatis-Spring项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置SqlSessionFactoryBean"><span class="toc-number">14.4.1.</span> <span class="toc-text">配置SqlSessionFactoryBean</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#深入Spring数据库事务管理"><span class="toc-number">15.</span> <span class="toc-text">深入Spring数据库事务管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring数据库事务管理器的设计"><span class="toc-number">15.1.</span> <span class="toc-text">Spring数据库事务管理器的设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置事务管理器"><span class="toc-number">15.2.</span> <span class="toc-text">配置事务管理器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编程式事务"><span class="toc-number">15.3.</span> <span class="toc-text">编程式事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#声明式事务"><span class="toc-number">15.4.</span> <span class="toc-text">声明式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Transactional配置项"><span class="toc-number">15.4.1.</span> <span class="toc-text">Transactional配置项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用XML进行配置事务管理器"><span class="toc-number">15.4.2.</span> <span class="toc-text">使用XML进行配置事务管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事务定义器"><span class="toc-number">15.4.3.</span> <span class="toc-text">事务定义器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#声明式事务的约定流程"><span class="toc-number">15.4.4.</span> <span class="toc-text">声明式事务的约定流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库相关知识"><span class="toc-number">15.5.</span> <span class="toc-text">数据库相关知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库事务ACID特性"><span class="toc-number">15.5.1.</span> <span class="toc-text">数据库事务ACID特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#丢失更新"><span class="toc-number">15.5.2.</span> <span class="toc-text">丢失更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第一类丢失更新"><span class="toc-number">15.5.2.1.</span> <span class="toc-text">第一类丢失更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二类丢失更新"><span class="toc-number">15.5.2.2.</span> <span class="toc-text">第二类丢失更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#隔离级别"><span class="toc-number">15.5.3.</span> <span class="toc-text">隔离级别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#选择隔离级别和传播行为"><span class="toc-number">15.6.</span> <span class="toc-text">选择隔离级别和传播行为</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#选择隔离级别"><span class="toc-number">15.6.1.</span> <span class="toc-text">选择隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#传播行为"><span class="toc-number">15.6.2.</span> <span class="toc-text">传播行为</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transactional的自调用失效问题"><span class="toc-number">15.7.</span> <span class="toc-text">@Transactional的自调用失效问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#出现原因"><span class="toc-number">15.7.1.</span> <span class="toc-text">出现原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方案"><span class="toc-number">15.7.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#典型错误用法的剖析"><span class="toc-number">15.8.</span> <span class="toc-text">典型错误用法的剖析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#错误使用Service"><span class="toc-number">15.8.1.</span> <span class="toc-text">错误使用Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#过长时间占用事务"><span class="toc-number">15.8.2.</span> <span class="toc-text">过长时间占用事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#错误捕获异常"><span class="toc-number">15.8.3.</span> <span class="toc-text">错误捕获异常</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-MVC-框架"><span class="toc-number">16.</span> <span class="toc-text">Spring MVC 框架</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-MVC的初始化和流程"><span class="toc-number">17.</span> <span class="toc-text">Spring MVC的初始化和流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MVC设计概述"><span class="toc-number">17.1.</span> <span class="toc-text">MVC设计概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringMVC的组件和流程"><span class="toc-number">17.1.1.</span> <span class="toc-text">SpringMVC的组件和流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-MVC-入门的实例"><span class="toc-number">17.1.2.</span> <span class="toc-text">Spring MVC 入门的实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-MVC开发流程详解"><span class="toc-number">17.2.</span> <span class="toc-text">Spring MVC开发流程详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-RequestMapping"><span class="toc-number">17.2.1.</span> <span class="toc-text">配置@RequestMapping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#控制器的开发"><span class="toc-number">17.2.2.</span> <span class="toc-text">控制器的开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#获取请求参数"><span class="toc-number">17.2.2.1.</span> <span class="toc-text">获取请求参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实现逻辑和绑定视图"><span class="toc-number">17.2.2.2.</span> <span class="toc-text">实现逻辑和绑定视图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#视图渲染"><span class="toc-number">17.2.3.</span> <span class="toc-text">视图渲染</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#深入Spring-MVC组件开发"><span class="toc-number">18.</span> <span class="toc-text">深入Spring MVC组件开发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#控制器接受各类请求参数"><span class="toc-number">18.1.</span> <span class="toc-text">控制器接受各类请求参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#接收普通请求参数"><span class="toc-number">18.1.1.</span> <span class="toc-text">接收普通请求参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-RequestParam注解获取参数"><span class="toc-number">18.1.2.</span> <span class="toc-text">使用@RequestParam注解获取参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用URL传递参数"><span class="toc-number">18.1.3.</span> <span class="toc-text">使用URL传递参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#传递JSON参数"><span class="toc-number">18.1.4.</span> <span class="toc-text">传递JSON参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接收列表数据和表单序列化"><span class="toc-number">18.1.5.</span> <span class="toc-text">接收列表数据和表单序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#简单数组"><span class="toc-number">18.1.5.1.</span> <span class="toc-text">简单数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#POJO数组"><span class="toc-number">18.1.5.2.</span> <span class="toc-text">POJO数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#表单序列化"><span class="toc-number">18.1.5.3.</span> <span class="toc-text">表单序列化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重定向"><span class="toc-number">18.2.</span> <span class="toc-text">重定向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#方法1"><span class="toc-number">18.2.1.</span> <span class="toc-text">方法1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法2"><span class="toc-number">18.2.2.</span> <span class="toc-text">方法2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#传递参数"><span class="toc-number">18.2.3.</span> <span class="toc-text">传递参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#保存并获取属性参数"><span class="toc-number">18.3.</span> <span class="toc-text">保存并获取属性参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#注解-RequestAttribute"><span class="toc-number">18.3.1.</span> <span class="toc-text">注解@RequestAttribute</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注解-SessionAttribute和注解-SessionAttributes"><span class="toc-number">18.3.2.</span> <span class="toc-text">注解@SessionAttribute和注解@SessionAttributes</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#读取后端设置的session属性"><span class="toc-number">18.3.2.1.</span> <span class="toc-text">读取后端设置的session属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#读取前端设置的session属性"><span class="toc-number">18.3.2.2.</span> <span class="toc-text">读取前端设置的session属性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注解-CookieValue和注解-RequestHeader"><span class="toc-number">18.3.3.</span> <span class="toc-text">注解@CookieValue和注解@RequestHeader</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#拦截器-1"><span class="toc-number">18.4.</span> <span class="toc-text">拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#拦截器的定义"><span class="toc-number">18.4.1.</span> <span class="toc-text">拦截器的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拦截器的执行流程"><span class="toc-number">18.4.2.</span> <span class="toc-text">拦截器的执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开发拦截器"><span class="toc-number">18.4.3.</span> <span class="toc-text">开发拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义登录拦截器"><span class="toc-number">18.4.3.1.</span> <span class="toc-text">自定义登录拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拦截器配置类"><span class="toc-number">18.4.3.2.</span> <span class="toc-text">拦截器配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用户登录控制器"><span class="toc-number">18.4.3.3.</span> <span class="toc-text">用户登录控制器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#验证表单"><span class="toc-number">18.5.</span> <span class="toc-text">验证表单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#导入依赖"><span class="toc-number">18.5.1.</span> <span class="toc-text">导入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POJO"><span class="toc-number">18.5.2.</span> <span class="toc-text">POJO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#页面"><span class="toc-number">18.5.3.</span> <span class="toc-text">页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#控制器"><span class="toc-number">18.5.4.</span> <span class="toc-text">控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用验证器"><span class="toc-number">18.5.5.</span> <span class="toc-text">使用验证器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#验证器接口"><span class="toc-number">18.5.5.1.</span> <span class="toc-text">验证器接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义验证器"><span class="toc-number">18.5.5.2.</span> <span class="toc-text">自定义验证器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#控制器绑定验证器"><span class="toc-number">18.5.5.3.</span> <span class="toc-text">控制器绑定验证器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据模型"><span class="toc-number">18.6.</span> <span class="toc-text">数据模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#视图和视图解析器"><span class="toc-number">18.7.</span> <span class="toc-text">视图和视图解析器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#视图"><span class="toc-number">18.7.1.</span> <span class="toc-text">视图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#视图接口定义"><span class="toc-number">18.7.1.1.</span> <span class="toc-text">视图接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#非逻辑视图"><span class="toc-number">18.7.1.2.</span> <span class="toc-text">非逻辑视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#逻辑视图"><span class="toc-number">18.7.1.3.</span> <span class="toc-text">逻辑视图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#视图解析器"><span class="toc-number">18.7.2.</span> <span class="toc-text">视图解析器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实例：Excel视图的使用"><span class="toc-number">18.7.2.1.</span> <span class="toc-text">实例：Excel视图的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#AbstractXlsView抽象类"><span class="toc-number">18.7.2.1.1.</span> <span class="toc-text">AbstractXlsView抽象类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#添加依赖"><span class="toc-number">18.7.2.1.2.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#定义Excel导出接口"><span class="toc-number">18.7.2.1.3.</span> <span class="toc-text">定义Excel导出接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#自定义Excel视图类"><span class="toc-number">18.7.2.1.4.</span> <span class="toc-text">自定义Excel视图类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#角色信息导出控制器"><span class="toc-number">18.7.2.1.5.</span> <span class="toc-text">角色信息导出控制器</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#上传文件"><span class="toc-number">18.8.</span> <span class="toc-text">上传文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置properties文件"><span class="toc-number">18.8.1.</span> <span class="toc-text">配置properties文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端页面"><span class="toc-number">18.8.2.</span> <span class="toc-text">前端页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注入MultiPartResolver-SpringBoot无须注入"><span class="toc-number">18.8.3.</span> <span class="toc-text">注入MultiPartResolver(SpringBoot无须注入)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#控制器-1"><span class="toc-number">18.8.4.</span> <span class="toc-text">控制器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-MVC高级应用"><span class="toc-number">19.</span> <span class="toc-text">Spring MVC高级应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-MVC的数据转换和格式化"><span class="toc-number">19.1.</span> <span class="toc-text">Spring MVC的数据转换和格式化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpMessageConverter和JSON消息转换器"><span class="toc-number">19.1.1.</span> <span class="toc-text">HttpMessageConverter和JSON消息转换器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON消息转换类"><span class="toc-number">19.1.1.1.</span> <span class="toc-text">JSON消息转换类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ResponseBody注解"><span class="toc-number">19.1.1.2.</span> <span class="toc-text">@ResponseBody注解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一对一转换器（Converter）"><span class="toc-number">19.2.</span> <span class="toc-text">一对一转换器（Converter）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义SpringToRole转换器"><span class="toc-number">19.2.1.</span> <span class="toc-text">自定义SpringToRole转换器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#控制器-2"><span class="toc-number">19.2.2.</span> <span class="toc-text">控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数组和集合转换器-GenericConverter"><span class="toc-number">19.2.3.</span> <span class="toc-text">数组和集合转换器 GenericConverter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#StringToArrayConverter"><span class="toc-number">19.2.3.1.</span> <span class="toc-text">StringToArrayConverter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用格式化器（Formatter）"><span class="toc-number">19.2.4.</span> <span class="toc-text">使用格式化器（Formatter）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注解参数"><span class="toc-number">19.2.4.1.</span> <span class="toc-text">注解参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注解类变量"><span class="toc-number">19.2.4.2.</span> <span class="toc-text">注解类变量</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为控制器添加通知"><span class="toc-number">19.3.</span> <span class="toc-text">为控制器添加通知</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#处理异常"><span class="toc-number">19.4.</span> <span class="toc-text">处理异常</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义异常"><span class="toc-number">19.4.1.</span> <span class="toc-text">自定义异常</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#国际化"><span class="toc-number">19.5.</span> <span class="toc-text">国际化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#概述-2"><span class="toc-number">19.5.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MessageSource接口"><span class="toc-number">19.5.2.</span> <span class="toc-text">MessageSource接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CookieLocaleResolver和SessionLocaleResolver"><span class="toc-number">19.5.3.</span> <span class="toc-text">CookieLocaleResolver和SessionLocaleResolver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#国际化拦截器（LocaleChangeInterceptor）"><span class="toc-number">19.5.4.</span> <span class="toc-text">国际化拦截器（LocaleChangeInterceptor）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis应用"><span class="toc-number">20.</span> <span class="toc-text">Redis应用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis概述"><span class="toc-number">21.</span> <span class="toc-text">Redis概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis基本安装和使用"><span class="toc-number">21.1.</span> <span class="toc-text">Redis基本安装和使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows下安装Redis"><span class="toc-number">21.1.1.</span> <span class="toc-text">Windows下安装Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux下安装Redis"><span class="toc-number">21.1.2.</span> <span class="toc-text">Linux下安装Redis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis的Java-API"><span class="toc-number">21.2.</span> <span class="toc-text">Redis的Java API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在Java程序中使用Redis"><span class="toc-number">21.2.1.</span> <span class="toc-text">在Java程序中使用Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在Spring中使用Redis"><span class="toc-number">21.2.2.</span> <span class="toc-text">在Spring中使用Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#添加依赖以及配置"><span class="toc-number">21.2.2.1.</span> <span class="toc-text">添加依赖以及配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring-Data-Redis的4种工厂模型"><span class="toc-number">21.2.2.2.</span> <span class="toc-text">Spring Data Redis的4种工厂模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RedisSerializer对象序列化接口"><span class="toc-number">21.2.2.3.</span> <span class="toc-text">RedisSerializer对象序列化接口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#properties配置方式"><span class="toc-number">21.2.2.3.1.</span> <span class="toc-text">properties配置方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#xml配置方式"><span class="toc-number">21.2.2.3.2.</span> <span class="toc-text">xml配置方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置类注解方式"><span class="toc-number">21.2.2.3.3.</span> <span class="toc-text">配置类注解方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#对象序列化"><span class="toc-number">21.2.2.3.4.</span> <span class="toc-text">对象序列化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试结果"><span class="toc-number">21.2.2.3.5.</span> <span class="toc-text">测试结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#同一个Redis连接"><span class="toc-number">21.2.2.4.</span> <span class="toc-text">同一个Redis连接</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis的6种数据类型"><span class="toc-number">21.3.</span> <span class="toc-text">Redis的6种数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis和数据库的异同"><span class="toc-number">21.4.</span> <span class="toc-text">Redis和数据库的异同</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis数据结构常用命令"><span class="toc-number">22.</span> <span class="toc-text">Redis数据结构常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis数据结构——字符串"><span class="toc-number">22.1.</span> <span class="toc-text">Redis数据结构——字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#常用操作"><span class="toc-number">22.1.1.</span> <span class="toc-text">常用操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#本地操作测试"><span class="toc-number">22.1.1.1.</span> <span class="toc-text">本地操作测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring操作测试"><span class="toc-number">22.1.1.2.</span> <span class="toc-text">Spring操作测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单运算"><span class="toc-number">22.1.2.</span> <span class="toc-text">简单运算</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#本地测试"><span class="toc-number">22.1.2.1.</span> <span class="toc-text">本地测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring测试"><span class="toc-number">22.1.2.2.</span> <span class="toc-text">Spring测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis数据结构——哈希"><span class="toc-number">22.2.</span> <span class="toc-text">Redis数据结构——哈希</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#本地测试-1"><span class="toc-number">22.2.1.</span> <span class="toc-text">本地测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring测试-1"><span class="toc-number">22.2.2.</span> <span class="toc-text">Spring测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis数据结构——链表（linked-list）"><span class="toc-number">22.3.</span> <span class="toc-text">Redis数据结构——链表（linked-list）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#常规命令"><span class="toc-number">22.3.1.</span> <span class="toc-text">常规命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#本地测试-2"><span class="toc-number">22.3.1.1.</span> <span class="toc-text">本地测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#链表的阻塞命令"><span class="toc-number">22.3.2.</span> <span class="toc-text">链表的阻塞命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#本地测试-3"><span class="toc-number">22.3.2.1.</span> <span class="toc-text">本地测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring测试-2"><span class="toc-number">22.3.2.2.</span> <span class="toc-text">Spring测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#常规操作测试"><span class="toc-number">22.3.2.2.1.</span> <span class="toc-text">常规操作测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#阻塞操作测试"><span class="toc-number">22.3.2.2.2.</span> <span class="toc-text">阻塞操作测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis数据结构——集合"><span class="toc-number">22.4.</span> <span class="toc-text">Redis数据结构——集合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#本地测试-4"><span class="toc-number">22.4.1.</span> <span class="toc-text">本地测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring测试-3"><span class="toc-number">22.4.2.</span> <span class="toc-text">Spring测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis数据结构——有序集合"><span class="toc-number">22.5.</span> <span class="toc-text">Redis数据结构——有序集合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis基础命令"><span class="toc-number">22.5.1.</span> <span class="toc-text">Redis基础命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#本地测试-5"><span class="toc-number">22.5.2.</span> <span class="toc-text">本地测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring测试-4"><span class="toc-number">22.5.3.</span> <span class="toc-text">Spring测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基数——HyperLogLog"><span class="toc-number">22.6.</span> <span class="toc-text">基数——HyperLogLog</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis的一些常用技术"><span class="toc-number">23.</span> <span class="toc-text">Redis的一些常用技术</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis的基础事务"><span class="toc-number">23.1.</span> <span class="toc-text">Redis的基础事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#本地测试-6"><span class="toc-number">23.1.1.</span> <span class="toc-text">本地测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring测试-5"><span class="toc-number">23.1.2.</span> <span class="toc-text">Spring测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#探索Redis事务回滚"><span class="toc-number">23.2.</span> <span class="toc-text">探索Redis事务回滚</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#命令正确，数据类型错误"><span class="toc-number">23.2.1.</span> <span class="toc-text">命令正确，数据类型错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令错误"><span class="toc-number">23.2.2.</span> <span class="toc-text">命令错误</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用watch命令监控事务"><span class="toc-number">23.3.</span> <span class="toc-text">使用watch命令监控事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#正常事务提交"><span class="toc-number">23.3.1.</span> <span class="toc-text">正常事务提交</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事务回滚"><span class="toc-number">23.3.2.</span> <span class="toc-text">事务回滚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流水线（pipelined）"><span class="toc-number">23.4.</span> <span class="toc-text">流水线（pipelined）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-API测试"><span class="toc-number">23.4.1.</span> <span class="toc-text">Java API测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring测试-6"><span class="toc-number">23.4.2.</span> <span class="toc-text">Spring测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发布订阅"><span class="toc-number">23.5.</span> <span class="toc-text">发布订阅</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#本地测试-7"><span class="toc-number">23.5.1.</span> <span class="toc-text">本地测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring测试-7"><span class="toc-number">23.5.2.</span> <span class="toc-text">Spring测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis发布订阅监听类"><span class="toc-number">23.5.2.1.</span> <span class="toc-text">Redis发布订阅监听类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RedisConfig配置类"><span class="toc-number">23.5.2.2.</span> <span class="toc-text">RedisConfig配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动类"><span class="toc-number">23.5.2.3.</span> <span class="toc-text">启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试结果-1"><span class="toc-number">23.5.2.4.</span> <span class="toc-text">测试结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#超时命令"><span class="toc-number">23.6.</span> <span class="toc-text">超时命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#本地测试-8"><span class="toc-number">23.6.1.</span> <span class="toc-text">本地测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring测试-8"><span class="toc-number">23.6.2.</span> <span class="toc-text">Spring测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Lua语言"><span class="toc-number">23.7.</span> <span class="toc-text">使用Lua语言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#执行输入Lua程序代码"><span class="toc-number">23.7.1.</span> <span class="toc-text">执行输入Lua程序代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#一般命令格式"><span class="toc-number">23.7.1.1.</span> <span class="toc-text">一般命令格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#多次执行同一脚本"><span class="toc-number">23.7.1.2.</span> <span class="toc-text">多次执行同一脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring测试-9"><span class="toc-number">23.7.1.3.</span> <span class="toc-text">Spring测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行Lua文件"><span class="toc-number">23.7.2.</span> <span class="toc-text">执行Lua文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#本地测试-9"><span class="toc-number">23.7.2.1.</span> <span class="toc-text">本地测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring测试-10"><span class="toc-number">23.7.2.2.</span> <span class="toc-text">Spring测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis配置"><span class="toc-number">24.</span> <span class="toc-text">Redis配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis基础配置文件"><span class="toc-number">24.1.</span> <span class="toc-text">Redis基础配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis备份（持久化）"><span class="toc-number">24.2.</span> <span class="toc-text">Redis备份（持久化）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快照模式的配置项"><span class="toc-number">24.2.1.</span> <span class="toc-text">快照模式的配置项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#只追加文件模式的配置项"><span class="toc-number">24.2.2.</span> <span class="toc-text">只追加文件模式的配置项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis内存回收策略"><span class="toc-number">24.3.</span> <span class="toc-text">Redis内存回收策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复制"><span class="toc-number">24.4.</span> <span class="toc-text">复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#主从同步基本概念"><span class="toc-number">24.4.1.</span> <span class="toc-text">主从同步基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis主从同步配置"><span class="toc-number">24.4.2.</span> <span class="toc-text">Redis主从同步配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis主从同步的过程"><span class="toc-number">24.4.3.</span> <span class="toc-text">Redis主从同步的过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#哨兵（Sentinel）模式"><span class="toc-number">24.5.</span> <span class="toc-text">哨兵（Sentinel）模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#哨兵模式概述"><span class="toc-number">24.5.1.</span> <span class="toc-text">哨兵模式概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#搭建哨兵模式"><span class="toc-number">24.5.2.</span> <span class="toc-text">搭建哨兵模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring缓存机制和Redis的结合"><span class="toc-number">25.</span> <span class="toc-text">Spring缓存机制和Redis的结合</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis和数据库的结合"><span class="toc-number">25.1.</span> <span class="toc-text">Redis和数据库的结合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis和数据库读操作"><span class="toc-number">25.1.1.</span> <span class="toc-text">Redis和数据库读操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis和数据库写操作"><span class="toc-number">25.1.2.</span> <span class="toc-text">Redis和数据库写操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Spring缓存机制整合Redis"><span class="toc-number">25.2.</span> <span class="toc-text">使用Spring缓存机制整合Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备测试环境"><span class="toc-number">25.2.1.</span> <span class="toc-text">准备测试环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#配置MySQL和Redis以及Spring-Cache配置"><span class="toc-number">25.2.1.1.</span> <span class="toc-text">配置MySQL和Redis以及Spring Cache配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#配置文件配置方式（推荐）"><span class="toc-number">25.2.1.1.1.</span> <span class="toc-text">配置文件配置方式（推荐）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置类自定义配置缓存管理器配置方式"><span class="toc-number">25.2.1.1.2.</span> <span class="toc-text">配置类自定义配置缓存管理器配置方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#POJO-1"><span class="toc-number">25.2.1.2.</span> <span class="toc-text">POJO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoleMapper-xml-2"><span class="toc-number">25.2.1.3.</span> <span class="toc-text">RoleMapper.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoleData持久层接口"><span class="toc-number">25.2.1.4.</span> <span class="toc-text">RoleData持久层接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RoleService服务接口"><span class="toc-number">25.2.1.5.</span> <span class="toc-text">RoleService服务接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存注解简介"><span class="toc-number">25.2.2.</span> <span class="toc-text">缓存注解简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注解-Cacheable和-CachePut"><span class="toc-number">25.2.3.</span> <span class="toc-text">注解@Cacheable和@CachePut</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RoleServiceImpl实现类"><span class="toc-number">25.2.3.1.</span> <span class="toc-text">RoleServiceImpl实现类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动测试类"><span class="toc-number">25.2.3.2.</span> <span class="toc-text">启动测试类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试结果-2"><span class="toc-number">25.2.3.3.</span> <span class="toc-text">测试结果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#配置文件配置方式测试结果"><span class="toc-number">25.2.3.3.1.</span> <span class="toc-text">配置文件配置方式测试结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注解-CacheEvict"><span class="toc-number">25.2.4.</span> <span class="toc-text">注解@CacheEvict</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不适用缓存的方法"><span class="toc-number">25.2.5.</span> <span class="toc-text">不适用缓存的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自调用失效问题"><span class="toc-number">25.2.6.</span> <span class="toc-text">自调用失效问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RedisTemplate的实例"><span class="toc-number">25.3.</span> <span class="toc-text">RedisTemplate的实例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#高并发业务"><span class="toc-number">26.</span> <span class="toc-text">高并发业务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#互联系统应用架构基础分析"><span class="toc-number">26.1.</span> <span class="toc-text">互联系统应用架构基础分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#高并发系统的分析和设计"><span class="toc-number">26.2.</span> <span class="toc-text">高并发系统的分析和设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#有效请求和无效请求"><span class="toc-number">26.2.1.</span> <span class="toc-text">有效请求和无效请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#系统设计"><span class="toc-number">26.2.2.</span> <span class="toc-text">系统设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库设计"><span class="toc-number">26.2.3.</span> <span class="toc-text">数据库设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动静分离技术"><span class="toc-number">26.2.4.</span> <span class="toc-text">动静分离技术</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#锁和高并发"><span class="toc-number">26.2.5.</span> <span class="toc-text">锁和高并发</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#搭建抢红包开发环境和超发现象"><span class="toc-number">26.3.</span> <span class="toc-text">搭建抢红包开发环境和超发现象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#大小红包数据库表"><span class="toc-number">26.3.1.</span> <span class="toc-text">大小红包数据库表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mapper接口-1"><span class="toc-number">26.3.2.</span> <span class="toc-text">Mapper接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mybatis的Mapper配置文件"><span class="toc-number">26.3.3.</span> <span class="toc-text">Mybatis的Mapper配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service接口"><span class="toc-number">26.3.4.</span> <span class="toc-text">Service接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ServiceImpl实现类"><span class="toc-number">26.3.5.</span> <span class="toc-text">ServiceImpl实现类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#页面-1"><span class="toc-number">26.3.6.</span> <span class="toc-text">页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#控制器-3"><span class="toc-number">26.3.7.</span> <span class="toc-text">控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试结果-3"><span class="toc-number">26.3.8.</span> <span class="toc-text">测试结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#悲观锁"><span class="toc-number">26.4.</span> <span class="toc-text">悲观锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#修改mapper-xml文件"><span class="toc-number">26.4.1.</span> <span class="toc-text">修改mapper.xml文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改Mapper接口"><span class="toc-number">26.4.2.</span> <span class="toc-text">修改Mapper接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改实现类"><span class="toc-number">26.4.3.</span> <span class="toc-text">修改实现类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试结果-4"><span class="toc-number">26.4.4.</span> <span class="toc-text">测试结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#乐观锁"><span class="toc-number">26.5.</span> <span class="toc-text">乐观锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CAS原理概述"><span class="toc-number">26.5.1.</span> <span class="toc-text">CAS原理概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ABA问题"><span class="toc-number">26.5.2.</span> <span class="toc-text">ABA问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#乐观锁实现抢红包业务"><span class="toc-number">26.5.3.</span> <span class="toc-text">乐观锁实现抢红包业务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#修改Mapper-xml"><span class="toc-number">26.5.3.1.</span> <span class="toc-text">修改Mapper.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改mapper接口"><span class="toc-number">26.5.3.2.</span> <span class="toc-text">修改mapper接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改实现类-1"><span class="toc-number">26.5.3.3.</span> <span class="toc-text">修改实现类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-1"><span class="toc-number">26.5.3.4.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#乐观锁重入机制"><span class="toc-number">26.5.4.</span> <span class="toc-text">乐观锁重入机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#时间戳方案"><span class="toc-number">26.5.4.1.</span> <span class="toc-text">时间戳方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#限制重试次数方案"><span class="toc-number">26.5.4.2.</span> <span class="toc-text">限制重试次数方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Redis实现抢红包"><span class="toc-number">26.6.</span> <span class="toc-text">使用Redis实现抢红包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用注解方式配置Redis"><span class="toc-number">26.6.1.</span> <span class="toc-text">使用注解方式配置Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据存储设计"><span class="toc-number">26.6.2.</span> <span class="toc-text">数据存储设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#redPacket-lua脚本"><span class="toc-number">26.6.2.1.</span> <span class="toc-text">redPacket.lua脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RedisRedPackerService接口"><span class="toc-number">26.6.2.2.</span> <span class="toc-text">RedisRedPackerService接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实现类"><span class="toc-number">26.6.2.3.</span> <span class="toc-text">实现类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步配置类"><span class="toc-number">26.6.2.4.</span> <span class="toc-text">异步配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#抢红包实现类"><span class="toc-number">26.6.2.5.</span> <span class="toc-text">抢红包实现类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#页面-2"><span class="toc-number">26.6.2.6.</span> <span class="toc-text">页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#控制类"><span class="toc-number">26.6.2.7.</span> <span class="toc-text">控制类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-2"><span class="toc-number">26.6.2.8.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#并发思考"><span class="toc-number">26.7.</span> <span class="toc-text">并发思考</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#仅读已提交隔离级别"><span class="toc-number">26.7.1.</span> <span class="toc-text">仅读已提交隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#for-update悲观锁实现"><span class="toc-number">26.7.2.</span> <span class="toc-text">for update悲观锁实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CAS乐观锁实现"><span class="toc-number">26.7.3.</span> <span class="toc-text">CAS乐观锁实现</span></a></li></ol></li></ol></li></ol>
                  </div>
                </span>

            </div>
        </div>
        

    </div>
</aside>




  

  

  

  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2024 Louris
        <span style="font-size: smaller">
          Hosted by
          <a href="https://coding.net/" target="_blank" rel="noopener" style="font-weight: bold">Coding Pages</a>/
          <a href="https://gitee.com/" target="_blank" rel="noopener" style="font-weight: bold">Gitee Pages</a>/
          <a href="https://github.com/" target="_blank" rel="noopener" style="font-weight: bold">Github Pages</a>
        </span>
        <!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
        <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人次</span> -->
    	</div>

      <!-- <div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
           <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
           <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人次</span>
      </div> -->

      <div class="footer-right">
      	<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      </div>
    </div>
  </div>
</footer>

    </div>
    <script>
	var yiliaConfig = {
		mathjax: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		toc_hide_index: false,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>!function(t){function n(e){if(r[e])return r[e].exports;var i=r[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var r={};n.m=t,n.c=r,n.p="./",n(0)}([function(t,n,r){r(203),t.exports=r(199)},function(t,n,r){var e=r(3),i=r(49),o=r(26),u=r(27),c=r(46),f="prototype",a=function(t,n,r){var s,l,h,v,p=t&a.F,d=t&a.G,y=t&a.S,g=t&a.P,m=t&a.B,b=d?e:y?e[n]||(e[n]={}):(e[n]||{})[f],x=d?i:i[n]||(i[n]={}),S=x[f]||(x[f]={});d&&(r=n);for(s in r)l=!p&&b&&void 0!==b[s],h=(l?b:r)[s],v=m&&l?c(h,e):g&&"function"==typeof h?c(Function.call,h):h,b&&u(b,s,h,t&a.U),x[s]!=h&&o(x,s,v),g&&S[s]!=h&&(S[s]=h)};e.core=i,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,t.exports=a},function(t,n,r){var e=r(5);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n,r){var e=r(128)("wks"),i=r(78),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(170),o=r(53),u=Object.defineProperty;n.f=r(9)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(52),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){t.exports=!r(18)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(22);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(20),i=r(59),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(95),i=r(33);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(40)("wks"),i=r(23),o=r(6).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(50);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(21);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n){var r=t.exports={version:"2.5.1"};"number"==typeof __e&&(__e=r)},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(10),i=r(74);t.exports=r(9)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(3),i=r(26),o=r(25),u=r(78)("src"),c="toString",f=Function[c],a=(""+f).split(c);r(49).inspectSource=function(t){return f.call(t)},(t.exports=function(t,n,r,c){var f="function"==typeof r;f&&(o(r,"name")||i(r,"name",n)),t[n]!==r&&(f&&(o(r,u)||i(r,u,t[n]?""+t[n]:a.join(String(n)))),t===e?t[n]=r:c?t[n]?t[n]=r:i(t,n,r):(delete t[n],i(t,n,r)))})(Function.prototype,c,function(){return"function"==typeof this&&this[u]||f.call(this)})},function(t,n,r){var e=r(1),i=r(4),o=r(50),u=/"/g,c=function(t,n,r,e){var i=String(o(t)),c="<"+n;return""!==r&&(c+=" "+r+'="'+String(e).replace(u,"&quot;")+'"'),c+">"+i+"</"+n+">"};t.exports=function(t,n){var r={};r[t]=n(c),e(e.P+e.F*i(function(){var n=""[t]('"');return n!==n.toLowerCase()||n.split('"').length>3}),"String",r)}},function(t,n,r){var e=r(64),i=r(34);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(116),i=r(74),o=r(32),u=r(53),c=r(25),f=r(170),a=Object.getOwnPropertyDescriptor;n.f=r(9)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(25),i=r(17),o=r(149)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(115),i=r(50);t.exports=function(t){return e(i(t))}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(8),o=r(16)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(23);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(6),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(21);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(6),i=r(24),o=r(36),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(16)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(19);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){"use strict";var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n,r){var e=r(46),i=r(115),o=r(17),u=r(11),c=r(134);t.exports=function(t,n){var r=1==t,f=2==t,a=3==t,s=4==t,l=6==t,h=5==t||l,v=n||c;return function(n,c,p){for(var d,y,g=o(n),m=i(g),b=e(c,p,3),x=u(m.length),S=0,w=r?v(n,x):f?v(n,0):void 0;x>S;S++)if((h||S in m)&&(d=m[S],y=b(d,S,g),t))if(r)w[S]=y;else if(y)switch(t){case 3:return!0;case 5:return d;case 6:return S;case 2:w.push(d)}else if(s)return!1;return l?-1:a||s?s:w}}},function(t,n){var r=t.exports={version:"2.5.1"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var e=r(1),i=r(49),o=r(4);t.exports=function(t,n){var r=(i.Object||{})[t]||Object[t],u={};u[t]=n(r),e(e.S+e.F*o(function(){r(1)}),"Object",u)}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(5);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(6),i=r(24),o=r(92),u=r(13),c="prototype",f=function(t,n,r){var a,s,l,h=t&f.F,v=t&f.G,p=t&f.S,d=t&f.P,y=t&f.B,g=t&f.W,m=v?i:i[n]||(i[n]={}),b=m[c],x=v?e:p?e[n]:(e[n]||{})[c];v&&(r=n);for(a in r)(s=!h&&x&&void 0!==x[a])&&a in m||(l=s?x[a]:r[a],m[a]=v&&"function"!=typeof x[a]?r[a]:y&&s?o(l,e):g&&x[a]==l?function(t){var n=function(n,r,e){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,e)}return t.apply(this,arguments)};return n[c]=t[c],n}(l):d&&"function"==typeof l?o(Function.call,l):l,d&&((m.virtual||(m.virtual={}))[a]=l,t&f.R&&b&&!b[a]&&u(b,a,l)))};f.F=1,f.G=2,f.S=4,f.P=8,f.B=16,f.W=32,f.U=64,f.R=128,t.exports=f},function(t,n,r){var e=r(191),i=r(1),o=r(128)("metadata"),u=o.store||(o.store=new(r(194))),c=function(t,n,r){var i=u.get(t);if(!i){if(!r)return;u.set(t,i=new e)}var o=i.get(n);if(!o){if(!r)return;i.set(n,o=new e)}return o};t.exports={store:u,map:c,has:function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},get:function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},set:function(t,n,r,e){c(r,e,!0).set(t,n)},keys:function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},key:function(t){return void 0===t||"symbol"==typeof t?t:String(t)},exp:function(t){i(i.S,"Reflect",t)}}},function(t,n,r){"use strict";if(r(9)){var e=r(70),i=r(3),o=r(4),u=r(1),c=r(130),f=r(155),a=r(46),s=r(68),l=r(74),h=r(26),v=r(75),p=r(52),d=r(11),y=r(189),g=r(77),m=r(53),b=r(25),x=r(114),S=r(5),w=r(17),_=r(141),O=r(71),E=r(31),M=r(72).f,P=r(157),j=r(78),F=r(7),A=r(48),L=r(117),N=r(129),T=r(158),I=r(80),k=r(123),R=r(76),C=r(133),D=r(162),G=r(10),W=r(30),U=G.f,V=W.f,B=i.RangeError,q=i.TypeError,z=i.Uint8Array,H="ArrayBuffer",K="Shared"+H,J="BYTES_PER_ELEMENT",Y="prototype",$=Array[Y],X=f.ArrayBuffer,Q=f.DataView,Z=A(0),tt=A(2),nt=A(3),rt=A(4),et=A(5),it=A(6),ot=L(!0),ut=L(!1),ct=T.values,ft=T.keys,at=T.entries,st=$.lastIndexOf,lt=$.reduce,ht=$.reduceRight,vt=$.join,pt=$.sort,dt=$.slice,yt=$.toString,gt=$.toLocaleString,mt=F("iterator"),bt=F("toStringTag"),xt=j("typed_constructor"),St=j("def_constructor"),wt=c.CONSTR,_t=c.TYPED,Ot=c.VIEW,Et="Wrong length!",Mt=A(1,function(t,n){return Lt(N(t,t[St]),n)}),Pt=o(function(){return 1===new z(new Uint16Array([1]).buffer)[0]}),jt=!!z&&!!z[Y].set&&o(function(){new z(1).set({})}),Ft=function(t,n){var r=p(t);if(r<0||r%n)throw B("Wrong offset!");return r},At=function(t){if(S(t)&&_t in t)return t;throw q(t+" is not a typed array!")},Lt=function(t,n){if(!(S(t)&&xt in t))throw q("It is not a typed array constructor!");return new t(n)},Nt=function(t,n){return Tt(N(t,t[St]),n)},Tt=function(t,n){for(var r=0,e=n.length,i=Lt(t,e);e>r;)i[r]=n[r++];return i},It=function(t,n,r){U(t,n,{get:function(){return this._d[r]}})},kt=function(t){var n,r,e,i,o,u,c=w(t),f=arguments.length,s=f>1?arguments[1]:void 0,l=void 0!==s,h=P(c);if(void 0!=h&&!_(h)){for(u=h.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(l&&f>2&&(s=a(s,arguments[2],2)),n=0,r=d(c.length),i=Lt(this,r);r>n;n++)i[n]=l?s(c[n],n):c[n];return i},Rt=function(){for(var t=0,n=arguments.length,r=Lt(this,n);n>t;)r[t]=arguments[t++];return r},Ct=!!z&&o(function(){gt.call(new z(1))}),Dt=function(){return gt.apply(Ct?dt.call(At(this)):At(this),arguments)},Gt={copyWithin:function(t,n){return D.call(At(this),t,n,arguments.length>2?arguments[2]:void 0)},every:function(t){return rt(At(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return C.apply(At(this),arguments)},filter:function(t){return Nt(this,tt(At(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return et(At(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return it(At(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){Z(At(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return ut(At(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return ot(At(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return vt.apply(At(this),arguments)},lastIndexOf:function(t){return st.apply(At(this),arguments)},map:function(t){return Mt(At(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return lt.apply(At(this),arguments)},reduceRight:function(t){return ht.apply(At(this),arguments)},reverse:function(){for(var t,n=this,r=At(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(At(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return pt.call(At(this),t)},subarray:function(t,n){var r=At(this),e=r.length,i=g(t,e);return new(N(r,r[St]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,d((void 0===n?e:g(n,e))-i))}},Wt=function(t,n){return Nt(this,dt.call(At(this),t,n))},Ut=function(t){At(this);var n=Ft(arguments[1],1),r=this.length,e=w(t),i=d(e.length),o=0;if(i+n>r)throw B(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(At(this))},keys:function(){return ft.call(At(this))},values:function(){return ct.call(At(this))}},Bt=function(t,n){return S(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return Bt(t,n=m(n,!0))?l(2,t[n]):V(t,n)},zt=function(t,n,r){return!(Bt(t,n=m(n,!0))&&S(r)&&b(r,"value"))||b(r,"get")||b(r,"set")||r.configurable||b(r,"writable")&&!r.writable||b(r,"enumerable")&&!r.enumerable?U(t,n,r):(t[n]=r.value,t)};wt||(W.f=qt,G.f=zt),u(u.S+u.F*!wt,"Object",{getOwnPropertyDescriptor:qt,defineProperty:zt}),o(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Ht=v({},Gt);v(Ht,Vt),h(Ht,mt,Vt.values),v(Ht,{slice:Wt,set:Ut,constructor:function(){},toString:yt,toLocaleString:Dt}),It(Ht,"buffer","b"),It(Ht,"byteOffset","o"),It(Ht,"byteLength","l"),It(Ht,"length","e"),U(Ht,bt,{get:function(){return this[_t]}}),t.exports=function(t,n,r,f){var a=t+((f=!!f)?"Clamped":"")+"Array",l="get"+t,v="set"+t,p=i[a],g=p||{},m=p&&E(p),b=!p||!c.ABV,w={},_=p&&p[Y],P=function(t,r){var e=t._d;return e.v[l](r*n+e.o,Pt)},j=function(t,r,e){var i=t._d;f&&(e=(e=Math.round(e))<0?0:e>255?255:255&e),i.v[v](r*n+i.o,e,Pt)},F=function(t,n){U(t,n,{get:function(){return P(this,n)},set:function(t){return j(this,n,t)},enumerable:!0})};b?(p=r(function(t,r,e,i){s(t,p,a,"_d");var o,u,c,f,l=0,v=0;if(S(r)){if(!(r instanceof X||(f=x(r))==H||f==K))return _t in r?Tt(p,r):kt.call(p,r);o=r,v=Ft(e,n);var g=r.byteLength;if(void 0===i){if(g%n)throw B(Et);if((u=g-v)<0)throw B(Et)}else if((u=d(i)*n)+v>g)throw B(Et);c=u/n}else c=y(r),u=c*n,o=new X(u);for(h(t,"_d",{b:o,o:v,l:u,e:c,v:new Q(o)});l<c;)F(t,l++)}),_=p[Y]=O(Ht),h(_,"constructor",p)):o(function(){p(1)})&&o(function(){new p(-1)})&&k(function(t){new p,new p(null),new p(1.5),new p(t)},!0)||(p=r(function(t,r,e,i){s(t,p,a);var o;return S(r)?r instanceof X||(o=x(r))==H||o==K?void 0!==i?new g(r,Ft(e,n),i):void 0!==e?new g(r,Ft(e,n)):new g(r):_t in r?Tt(p,r):kt.call(p,r):new g(y(r))}),Z(m!==Function.prototype?M(g).concat(M(m)):M(g),function(t){t in p||h(p,t,g[t])}),p[Y]=_,e||(_.constructor=p));var A=_[mt],L=!!A&&("values"==A.name||void 0==A.name),N=Vt.values;h(p,xt,!0),h(_,_t,a),h(_,Ot,!0),h(_,St,p),(f?new p(1)[bt]==a:bt in _)||U(_,bt,{get:function(){return a}}),w[a]=p,u(u.G+u.W+u.F*(p!=g),w),u(u.S,a,{BYTES_PER_ELEMENT:n}),u(u.S+u.F*o(function(){g.of.call(p,1)}),a,{from:kt,of:Rt}),J in _||h(_,J,n),u(u.P,a,Gt),R(a),u(u.P+u.F*jt,a,{set:Ut}),u(u.P+u.F*!L,a,Vt),e||_.toString==yt||(_.toString=yt),u(u.P+u.F*o(function(){new p(1).slice()}),a,{slice:Wt}),u(u.P+u.F*(o(function(){return[1,2].toLocaleString()!=new p([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),a,{toLocaleString:Dt}),I[a]=L?A:N,e||L||h(_,mt,N)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(21),i=r(6).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(18)(function(){return 7!=Object.defineProperty(r(58)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var e=r(36),i=r(54),o=r(65),u=r(13),c=r(8),f=r(35),a=r(97),s=r(38),l=r(103),h=r(16)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,m,b,x){a(r,n,g);var S,w,_,O=function(t){if(!v&&t in j)return j[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",M=m==d,P=!1,j=t.prototype,F=j[h]||j["@@iterator"]||m&&j[m],A=F||O(m),L=m?M?O("entries"):A:void 0,N="Array"==n?j.entries||F:F;if(N&&(_=l(N.call(new t)))!==Object.prototype&&_.next&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),M&&F&&F.name!==d&&(P=!0,A=function(){return F.call(this)}),e&&!x||!v&&!P&&j[h]||u(j,h,A),f[n]=A,f[E]=y,m)if(S={values:M?A:O(d),keys:b?A:O(p),entries:L},x)for(w in S)w in j||o(j,w,S[w]);else i(i.P+i.F*(v||P),n,S);return S}},function(t,n,r){var e=r(20),i=r(100),o=r(34),u=r(39)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(58)("iframe"),e=o.length;for(n.style.display="none",r(94).appendChild(n),n.src="javascript:",(t=n.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(64),i=r(34).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(8),i=r(15),o=r(91)(!1),u=r(39)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;void 0==i[e]&&r(26)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n,r){var e=r(78)("meta"),i=r(5),o=r(25),u=r(10).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=t.exports={KEY:e,NEED:!1,fastKey:function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},getWeak:function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},onFreeze:function(t){return a&&l.NEED&&f(t)&&!o(t,e)&&s(t),t}}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n,r){var e=r(46),i=r(173),o=r(141),u=r(2),c=r(11),f=r(157),a={},s={};(n=t.exports=function(t,n,r,l,h){var v,p,d,y,g=h?function(){return t}:f(t),m=e(r,l,n?2:1),b=0;if("function"!=typeof g)throw TypeError(t+" is not iterable!");if(o(g)){for(v=c(t.length);v>b;b++)if((y=n?m(u(p=t[b])[0],p[1]):m(t[b]))===a||y===s)return y}else for(d=g.call(t);!(p=d.next()).done;)if((y=i(d,m,p.value,n))===a||y===s)return y}).BREAK=a,n.RETURN=s},function(t,n){t.exports=!1},function(t,n,r){var e=r(2),i=r(179),o=r(137),u=r(149)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(136)("iframe"),e=o.length;for(n.style.display="none",r(139).appendChild(n),n.src="javascript:",(t=n.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(181),i=r(137).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(181),i=r(137);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n,r){var e=r(27);t.exports=function(t,n,r){for(var i in n)e(t,i,n[i],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(10),o=r(9),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(52),i=Math.max,o=Math.min;t.exports=function(t,n){return(t=e(t))<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(33);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports={}},function(t,n,r){var e=r(10).f,i=r(25),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(1),i=r(50),o=r(4),u=r(153),c="["+u+"]",f=RegExp("^"+c+c+"*"),a=RegExp(c+c+"*$"),s=function(t,n,r){var i={},c=o(function(){return!!u[t]()||"​"!="​"[t]()}),f=i[t]=c?n(l):u[t];r&&(i[r]=f),e(e.P+e.F*c,"String",i)},l=s.trim=function(t,n){return t=String(i(t)),1&n&&(t=t.replace(f,"")),2&n&&(t=t.replace(a,"")),t};t.exports=s},function(t,n,r){var e=r(5);t.exports=function(t,n){if(!e(t)||t._t!==n)throw TypeError("Incompatible receiver, "+n+" required!");return t}},function(t,n,r){t.exports={default:r(87),__esModule:!0}},function(t,n,r){t.exports={default:r(88),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=e(r(85)),o=e(r(84)),u="function"==typeof o.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof o.default&&t.constructor===o.default&&t!==o.default.prototype?"symbol":typeof t};n.default="function"==typeof o.default&&"symbol"===u(i.default)?function(t){return void 0===t?"undefined":u(t)}:function(t){return t&&"function"==typeof o.default&&t.constructor===o.default&&t!==o.default.prototype?"symbol":void 0===t?"undefined":u(t)}},function(t,n,r){r(110),r(108),r(111),r(112),t.exports=r(24).Symbol},function(t,n,r){r(109),r(113),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var e=r(15),i=r(106),o=r(105);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){var e=r(89);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(29),i=r(63),o=r(37);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){var e=r(6).document;t.exports=e&&e.documentElement},function(t,n,r){var e=r(57);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(57);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(61),i=r(22),o=r(38),u={};r(13)(u,r(16)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(23)("meta"),i=r(21),o=r(8),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(18)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=t.exports={KEY:e,NEED:!1,fastKey:function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},getWeak:function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},onFreeze:function(t){return a&&l.NEED&&f(t)&&!o(t,e)&&s(t),t}}},function(t,n,r){var e=r(14),i=r(20),o=r(29);t.exports=r(12)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(22),o=r(15),u=r(42),c=r(8),f=r(59),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(15),i=r(62).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(8),i=r(79),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(41),i=r(33);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f))<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return(t=e(t))<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(90),i=r(98),o=r(35),u=r(15);t.exports=r(60)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(104)(!0);r(60)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(6),i=r(8),o=r(12),u=r(54),c=r(65),f=r(99).KEY,a=r(18),s=r(40),l=r(38),h=r(23),v=r(16),p=r(44),d=r(43),y=r(93),g=r(96),m=r(20),b=r(15),x=r(42),S=r(22),w=r(61),_=r(102),O=r(101),E=r(14),M=r(29),P=O.f,j=E.f,F=_.f,A=e.Symbol,L=e.JSON,N=L&&L.stringify,T="prototype",I=v("_hidden"),k=v("toPrimitive"),R={}.propertyIsEnumerable,C=s("symbol-registry"),D=s("symbols"),G=s("op-symbols"),W=Object[T],U="function"==typeof A,V=e.QObject,B=!V||!V[T]||!V[T].findChild,q=o&&a(function(){return 7!=w(j({},"a",{get:function(){return j(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=P(W,n);e&&delete W[n],j(t,n,r),e&&t!==W&&j(W,n,e)}:j,z=function(t){var n=D[t]=w(A[T]);return n._k=t,n},H=U&&"symbol"==typeof A.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof A},K=function(t,n,r){return t===W&&K(G,n,r),m(t),n=x(n,!0),m(r),i(D,n)?(r.enumerable?(i(t,I)&&t[I][n]&&(t[I][n]=!1),r=w(r,{enumerable:S(0,!1)})):(i(t,I)||j(t,I,S(1,{})),t[I][n]=!0),q(t,n,r)):j(t,n,r)},J=function(t,n){m(t);for(var r,e=y(n=b(n)),i=0,o=e.length;o>i;)K(t,r=e[i++],n[r]);return t},Y=function(t){var n=R.call(this,t=x(t,!0));return!(this===W&&i(D,t)&&!i(G,t))&&(!(n||!i(this,t)||!i(D,t)||i(this,I)&&this[I][t])||n)},$=function(t,n){if(t=b(t),n=x(n,!0),t!==W||!i(D,n)||i(G,n)){var r=P(t,n);return!r||!i(D,n)||i(t,I)&&t[I][n]||(r.enumerable=!0),r}},X=function(t){for(var n,r=F(b(t)),e=[],o=0;r.length>o;)i(D,n=r[o++])||n==I||n==f||e.push(n);return e},Q=function(t){for(var n,r=t===W,e=F(r?G:b(t)),o=[],u=0;e.length>u;)!i(D,n=e[u++])||r&&!i(W,n)||o.push(D[n]);return o};U||(A=function(){if(this instanceof A)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===W&&n.call(G,r),i(this,I)&&i(this[I],t)&&(this[I][t]=!1),q(this,t,S(1,r))};return o&&B&&q(W,t,{configurable:!0,set:n}),z(t)},c(A[T],"toString",function(){return this._k}),O.f=$,E.f=K,r(62).f=_.f=X,r(37).f=Y,r(63).f=Q,o&&!r(36)&&c(W,"propertyIsEnumerable",Y,!0),p.f=function(t){return z(v(t))}),u(u.G+u.W+u.F*!U,{Symbol:A});for(var Z="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),tt=0;Z.length>tt;)v(Z[tt++]);for(var nt=M(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!U,"Symbol",{for:function(t){return i(C,t+="")?C[t]:C[t]=A(t)},keyFor:function(t){if(!H(t))throw TypeError(t+" is not a symbol!");for(var n in C)if(C[n]===t)return n},useSetter:function(){B=!0},useSimple:function(){B=!1}}),u(u.S+u.F*!U,"Object",{create:function(t,n){return void 0===n?w(t):J(w(t),n)},defineProperty:K,defineProperties:J,getOwnPropertyDescriptor:$,getOwnPropertyNames:X,getOwnPropertySymbols:Q}),L&&u(u.S+u.F*(!U||a(function(){var t=A();return"[null]"!=N([t])||"{}"!=N({a:t})||"{}"!=N(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!H(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return"function"==typeof(n=e[1])&&(r=n),!r&&g(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!H(n))return n}),e[1]=n,N.apply(L,e)}}}),A[T][k]||r(13)(A[T],k,A[T].valueOf),l(A,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(107);for(var e=r(6),i=r(13),o=r(35),u=r(16)("toStringTag"),c="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),f=0;f<c.length;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){var e=r(45),i=r(7)("toStringTag"),o="Arguments"==e(function(){return arguments}()),u=function(t,n){try{return t[n]}catch(t){}};t.exports=function(t){var n,r,c;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=u(n=Object(t),i))?r:o?e(n):"Object"==(c=e(n))&&"function"==typeof n.callee?"Arguments":c}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(32),i=r(11),o=r(77);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){"use strict";var e=r(3),i=r(1),o=r(27),u=r(75),c=r(67),f=r(69),a=r(68),s=r(5),l=r(4),h=r(123),v=r(81),p=r(140);t.exports=function(t,n,r,d,y,g){var m=e[t],b=m,x=y?"set":"add",S=b&&b.prototype,w={},_=function(t){var n=S[t];o(S,t,"delete"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"has"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"get"==t?function(t){return g&&!s(t)?void 0:n.call(this,0===t?0:t)}:"add"==t?function(t){return n.call(this,0===t?0:t),this}:function(t,r){return n.call(this,0===t?0:t,r),this})};if("function"==typeof b&&(g||S.forEach&&!l(function(){(new b).entries().next()}))){var O=new b,E=O[x](g?{}:-0,1)!=O,M=l(function(){O.has(1)}),P=h(function(t){new b(t)}),j=!g&&l(function(){for(var t=new b,n=5;n--;)t[x](n,n);return!t.has(-0)});P||(b=n(function(n,r){a(n,b,t);var e=p(new m,n,b);return void 0!=r&&f(r,y,e[x],e),e}),b.prototype=S,S.constructor=b),(M||j)&&(_("delete"),_("has"),y&&_("get")),(j||E)&&_(x),g&&S.clear&&delete S.clear}else b=d.getConstructor(n,t,y,x),u(b.prototype,r),c.NEED=!0;return v(b,t),w[t]=b,i(i.G+i.W+i.F*(b!=m),w),g||d.setStrong(b,t,y),b}},function(t,n,r){"use strict";var e=r(26),i=r(27),o=r(4),u=r(50),c=r(7);t.exports=function(t,n,r){var f=c(t),a=r(u,f,""[t]),s=a[0],l=a[1];o(function(){var n={};return n[f]=function(){return 7},7!=""[t](n)})&&(i(String.prototype,t,s),e(RegExp.prototype,f,2==n?function(t,n){return l.call(t,this,n)}:function(t){return l.call(t,this)}))}},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){var e=r(5),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var e=r(7)("iterator"),i=!1;try{var o=[7][e]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!i)return!1;var r=!1;try{var o=[7],u=o[e]();u.next=function(){return{done:r=!0}},o[e]=function(){return u},t(o)}catch(t){}return r}},function(t,n,r){"use strict";t.exports=r(70)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){"use strict";var e=r(1),i=r(19),o=r(46),u=r(69);t.exports=function(t){e(e.S,t,{from:function(t){var n,r,e,c,f=arguments[1];return i(this),(n=void 0!==f)&&i(f),void 0==t?new this:(r=[],n?(e=0,c=o(f,arguments[2],2),u(t,!1,function(t){r.push(c(t,e++))})):u(t,!1,r.push,r),new this(r))}})}},function(t,n,r){"use strict";var e=r(1);t.exports=function(t){e(e.S,t,{of:function(){for(var t=arguments.length,n=Array(t);t--;)n[t]=arguments[t];return new this(n)}})}},function(t,n,r){var e=r(3),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n,r){var e=r(2),i=r(19),o=r(7)("species");t.exports=function(t,n){var r,u=e(t).constructor;return void 0===u||void 0==(r=e(u)[o])?n:i(r)}},function(t,n,r){for(var e,i=r(3),o=r(26),u=r(78),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n){"use strict";var r={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&-1==t.indexOf("KHTML"),mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:-1==t.indexOf("Safari"),weixin:-1==t.indexOf("MicroMessenger")}}()};t.exports=r},function(t,n,r){"use strict";var e=function(t){return t&&t.__esModule?t:{default:t}}(r(86)),i=function(){function t(t,n,r){return n||r?String.fromCharCode(n||r):u[t]||t}function n(t){return l[t]}var r=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,o=/['<> "&]/g,u={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},c=/\u00a0/g,f=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var h in u)l[u[h]]=h;return u["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(o,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(f,"\n").replace(r,t).replace(c," "):""},encodeBase16:function(t){if(!t)return t;for(var n=[],r=0,e=(t+="").length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;for(var n=[],r=0,e=(t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")})).length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;for(var n=[],r=0,e=(t+="").length;e>r;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;r>n;n++)t[n]=i.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,e.default)(t)))for(var o in t)t[o]=i.encodeObject(t[o]);else if("string"==typeof t)return i.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=i},function(t,n,r){"use strict";var e=r(17),i=r(77),o=r(11);t.exports=function(t){for(var n=e(this),r=o(n.length),u=arguments.length,c=i(u>1?arguments[1]:void 0,r),f=u>2?arguments[2]:void 0,a=void 0===f?r:i(f,r);a>c;)n[c++]=t;return n}},function(t,n,r){var e=r(211);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(10),i=r(74);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(5),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(t){var n=/./;try{"/./"[t](n)}catch(r){try{return n[e]=!1,!"/./"[t](n)}catch(t){}}return!0}},function(t,n,r){var e=r(3).document;t.exports=e&&e.documentElement},function(t,n,r){var e=r(5),i=r(148).set;t.exports=function(t,n,r){var o,u=n.constructor;return u!==r&&"function"==typeof u&&(o=u.prototype)!==r.prototype&&e(o)&&i&&i(t,o),t}},function(t,n,r){var e=r(80),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){"use strict";var e=r(71),i=r(74),o=r(81),u={};r(26)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var e=r(70),i=r(1),o=r(27),u=r(26),c=r(25),f=r(80),a=r(142),s=r(81),l=r(31),h=r(7)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,m,b,x){a(r,n,g);var S,w,_,O=function(t){if(!v&&t in j)return j[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",M=m==d,P=!1,j=t.prototype,F=j[h]||j["@@iterator"]||m&&j[m],A=F||O(m),L=m?M?O("entries"):A:void 0,N="Array"==n?j.entries||F:F;if(N&&(_=l(N.call(new t)))!==Object.prototype&&_.next&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),M&&F&&F.name!==d&&(P=!0,A=function(){return F.call(this)}),e&&!x||!v&&!P&&j[h]||u(j,h,A),f[n]=A,f[E]=y,m)if(S={values:M?A:O(d),keys:b?A:O(p),entries:L},x)for(w in S)w in j||o(j,w,S[w]);else i(i.P+i.F*(v||P),n,S);return S}},function(t,n){var r=Math.expm1;t.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:t>-1e-6&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var e=r(3),i=r(154).set,o=e.MutationObserver||e.WebKitMutationObserver,u=e.process,c=e.Promise,f="process"==r(45)(u);t.exports=function(){var t,n,r,a=function(){var e,i;for(f&&(e=u.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(e){throw t?r():n=void 0,e}}n=void 0,e&&e.enter()};if(f)r=function(){u.nextTick(a)};else if(o){var s=!0,l=document.createTextNode("");new o(a).observe(l,{characterData:!0}),r=function(){l.data=s=!s}}else if(c&&c.resolve){var h=c.resolve();r=function(){h.then(a)}}else r=function(){i.call(e,a)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,r()),n=i}}},function(t,n,r){"use strict";function e(t){var n,r;this.promise=new t(function(t,e){if(void 0!==n||void 0!==r)throw TypeError("Bad Promise constructor");n=t,r=e}),this.resolve=i(n),this.reject=i(r)}var i=r(19);t.exports.f=function(t){return new e(t)}},function(t,n,r){var e=r(5),i=r(2),o=function(t,n){if(i(t),!e(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,n,e){try{(e=r(46)(Function.call,r(30).f(Object.prototype,"__proto__").set,2))(t,[]),n=!(t instanceof Array)}catch(t){n=!0}return function(t,r){return o(t,r),n?t.__proto__=r:e(t,r),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(128)("keys"),i=r(78);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(52),i=r(50);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f))<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536}}},function(t,n,r){var e=r(122),i=r(50);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var e=r(52),i=r(50);t.exports=function(t){var n=String(i(this)),r="",o=e(t);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(n+=n))1&o&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(46),c=r(171),f=r(139),a=r(136),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=s.Dispatch,y=0,g={},m="onreadystatechange",b=function(){var t=+this;if(g.hasOwnProperty(t)){var n=g[t];delete g[t],n()}},x=function(t){b.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return g[++y]=function(){c("function"==typeof t?t:Function(t),n)},e(y),y},v=function(t){delete g[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(b,t,1))}:d&&d.now?e=function(t){d.now(u(b,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=x,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",x,!1)):e=m in a("script")?function(t){f.appendChild(a("script"))[m]=function(){f.removeChild(this),b.call(t)}}:function(t){setTimeout(u(b,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";function e(t,n,r){var e,i,o,u=Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?W(2,-24)-W(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for((t=G(t))!=t||t===C?(i=t!=t?1:0,e=f):(e=U(V(t)/B),t*(o=W(2,-e))<1&&(e--,o*=2),(t+=e+a>=1?s/o:s*W(2,1-a))*o>=2&&(e++,o/=2),e+a>=f?(i=0,e=f):e+a>=1?(i=(t*o-1)*W(2,n),e+=a):(i=t*W(2,a-1)*W(2,n),e=0));n>=8;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;c>0;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u}function i(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;c>0;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;c>0;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-C:C;e+=W(2,n),s-=u}return(a?-1:1)*e*W(2,s-n)}function o(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]}function u(t){return[255&t]}function c(t){return[255&t,t>>8&255]}function f(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]}function a(t){return e(t,52,8)}function s(t){return e(t,23,4)}function l(t,n,r){M(t[L],n,{get:function(){return this[r]}})}function h(t,n,r,e){var i=O(+r);if(i+n>t[J])throw R(N);var o=t[K]._b,u=i+t[Y],c=o.slice(u,u+n);return e?c:c.reverse()}function v(t,n,r,e,i,o){var u=O(+r);if(u+n>t[J])throw R(N);for(var c=t[K]._b,f=u+t[Y],a=e(+i),s=0;s<n;s++)c[f+s]=a[o?s:n-s-1]}var p=r(3),d=r(9),y=r(70),g=r(130),m=r(26),b=r(75),x=r(4),S=r(68),w=r(52),_=r(11),O=r(189),E=r(72).f,M=r(10).f,P=r(133),j=r(81),F="ArrayBuffer",A="DataView",L="prototype",N="Wrong index!",T=p[F],I=p[A],k=p.Math,R=p.RangeError,C=p.Infinity,D=T,G=k.abs,W=k.pow,U=k.floor,V=k.log,B=k.LN2,q="buffer",z="byteLength",H="byteOffset",K=d?"_b":q,J=d?"_l":z,Y=d?"_o":H;if(g.ABV){if(!x(function(){T(1)})||!x(function(){new T(-1)})||x(function(){return new T,new T(1.5),new T(NaN),T.name!=F})){for(var $,X=(T=function(t){return S(this,T),new D(O(t))})[L]=D[L],Q=E(D),Z=0;Q.length>Z;)($=Q[Z++])in T||m(T,$,D[$]);y||(X.constructor=T)}var tt=new I(new T(2)),nt=I[L].setInt8;tt.setInt8(0,2147483648),tt.setInt8(1,2147483649),!tt.getInt8(0)&&tt.getInt8(1)||b(I[L],{setInt8:function(t,n){nt.call(this,t,n<<24>>24)},setUint8:function(t,n){nt.call(this,t,n<<24>>24)}},!0)}else T=function(t){S(this,T,F);var n=O(t);this._b=P.call(Array(n),0),this[J]=n},I=function(t,n,r){S(this,I,A),S(t,T,A);var e=t[J],i=w(n);if(i<0||i>e)throw R("Wrong offset!");if(r=void 0===r?e-i:_(r),i+r>e)throw R("Wrong length!");this[K]=t,this[Y]=i,this[J]=r},d&&(l(T,z,"_l"),l(I,q,"_b"),l(I,z,"_l"),l(I,H,"_o")),b(I[L],{getInt8:function(t){return h(this,1,t)[0]<<24>>24},getUint8:function(t){return h(this,1,t)[0]},getInt16:function(t){var n=h(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=h(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return o(h(this,4,t,arguments[1]))},getUint32:function(t){return o(h(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return i(h(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return i(h(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){v(this,1,t,u,n)},setUint8:function(t,n){v(this,1,t,u,n)},setInt16:function(t,n){v(this,2,t,c,n,arguments[2])},setUint16:function(t,n){v(this,2,t,c,n,arguments[2])},setInt32:function(t,n){v(this,4,t,f,n,arguments[2])},setUint32:function(t,n){v(this,4,t,f,n,arguments[2])},setFloat32:function(t,n){v(this,4,t,s,n,arguments[2])},setFloat64:function(t,n){v(this,8,t,a,n,arguments[2])}});j(T,F),j(I,A),m(I[L],g.VIEW,!0),n[F]=T,n[A]=I},function(t,n,r){var e=r(3),i=r(49),o=r(70),u=r(190),c=r(10).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(114),i=r(7)("iterator"),o=r(80);t.exports=r(49).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(66),i=r(174),o=r(80),u=r(32);t.exports=r(143)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){t.exports=function(t,n){t.classList?t.classList.add(n):t.className+=" "+n}},function(t,n){t.exports=function(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var e=r(17),i=r(77),o=r(11);t.exports=[].copyWithin||function(t,n){var r=e(this),u=o(r.length),c=i(t,u),f=i(n,u),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?u:i(a,u))-f,u-c),l=1;for(f<c&&c<f+s&&(l=-1,f+=s-1,c+=s-1);s-- >0;)f in r?r[c]=r[f]:delete r[c],c+=l,f+=l;return r}},function(t,n,r){var e=r(69);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var e=r(19),i=r(17),o=r(115),u=r(11);t.exports=function(t,n,r,c,f){e(n);var a=i(t),s=o(a),l=u(a.length),h=f?l-1:0,v=f?-1:1;if(r<2)for(;;){if(h in s){c=s[h],h+=v;break}if(h+=v,f?h<0:l<=h)throw TypeError("Reduce of empty array with no initial value")}for(;f?h>=0:l>h;h+=v)h in s&&(c=n(c,s[h],h,a));return c}},function(t,n,r){"use strict";var e=r(19),i=r(5),o=r(171),u=[].slice,c={},f=function(t,n,r){if(!(n in c)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";c[n]=Function("F,a","return new F("+e.join(",")+")")}return c[n](t,r)};t.exports=Function.bind||function(t){var n=e(this),r=u.call(arguments,1),c=function(){var e=r.concat(u.call(arguments));return this instanceof c?f(n,e.length,e):o(n,e,t)};return i(n.prototype)&&(c.prototype=n.prototype),c}},function(t,n,r){"use strict";var e=r(10).f,i=r(71),o=r(75),u=r(46),c=r(68),f=r(69),a=r(143),s=r(174),l=r(76),h=r(9),v=r(67).fastKey,p=r(83),d=h?"_s":"size",y=function(t,n){var r,e=v(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,n,r,a){var s=t(function(t,e){c(t,s,n,"_i"),t._t=n,t._i=i(null),t._f=void 0,t._l=void 0,t[d]=0,void 0!=e&&f(e,r,t[a],t)});return o(s.prototype,{clear:function(){for(var t=p(this,n),r=t._i,e=t._f;e;e=e.n)e.r=!0,e.p&&(e.p=e.p.n=void 0),delete r[e.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var r=p(this,n),e=y(r,t);if(e){var i=e.n,o=e.p;delete r._i[e.i],e.r=!0,o&&(o.n=i),i&&(i.p=o),r._f==e&&(r._f=i),r._l==e&&(r._l=o),r[d]--}return!!e},forEach:function(t){p(this,n);for(var r,e=u(t,arguments.length>1?arguments[1]:void 0,3);r=r?r.n:this._f;)for(e(r.v,r.k,this);r&&r.r;)r=r.p},has:function(t){return!!y(p(this,n),t)}}),h&&e(s.prototype,"size",{get:function(){return p(this,n)[d]}}),s},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=v(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,n,r){a(t,n,function(t,r){this._t=p(t,n),this._k=r,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?"keys"==n?s(0,r.k):"values"==n?s(0,r.v):s(0,[r.k,r.v]):(t._t=void 0,s(1))},r?"entries":"values",!r,!0),l(n)}}},function(t,n,r){var e=r(114),i=r(163);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var e=r(75),i=r(67).getWeak,o=r(2),u=r(5),c=r(68),f=r(69),a=r(48),s=r(25),l=r(83),h=a(5),v=a(6),p=0,d=function(t){return t._l||(t._l=new y)},y=function(){this.a=[]},g=function(t,n){return h(t.a,function(t){return t[0]===n})};y.prototype={get:function(t){var n=g(this,t);if(n)return n[1]},has:function(t){return!!g(this,t)},set:function(t,n){var r=g(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(t){var n=v(this.a,function(n){return n[0]===t});return~n&&this.a.splice(n,1),!!~n}},t.exports={getConstructor:function(t,n,r,o){var a=t(function(t,e){c(t,a,n,"_i"),t._t=n,t._i=p++,t._l=void 0,void 0!=e&&f(e,r,t[o],t)});return e(a.prototype,{delete:function(t){if(!u(t))return!1;var r=i(t);return!0===r?d(l(this,n)).delete(t):r&&s(r,this._i)&&delete r[this._i]},has:function(t){if(!u(t))return!1;var r=i(t);return!0===r?d(l(this,n)).has(t):r&&s(r,this._i)}}),a},def:function(t,n,r){var e=i(o(n),!0);return!0===e?d(t).set(n,r):e[t._i]=r,t},ufstore:d}},function(t,n,r){"use strict";function e(t,n,r,a,s,l,h,v){for(var p,d,y=s,g=0,m=!!h&&c(h,v,3);g<a;){if(g in r){if(p=m?m(r[g],g,n):r[g],d=!1,o(p)&&(d=p[f],d=void 0!==d?!!d:i(p)),d&&l>0)y=e(t,n,p,u(p.length),y,l-1)-1;else{if(y>=9007199254740991)throw TypeError();t[y]=p}y++}g++}return y}var i=r(121),o=r(5),u=r(11),c=r(46),f=r(7)("isConcatSpreadable");t.exports=e},function(t,n,r){t.exports=!r(9)&&!r(4)(function(){return 7!=Object.defineProperty(r(136)("div"),"a",{get:function(){return 7}}).a})},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(5),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var e=r(2);t.exports=function(t,n,r,i){try{return i?n(e(r)[0],r[1]):n(r)}catch(n){var o=t.return;throw void 0!==o&&e(o.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(145),i=Math.pow,o=i(2,-52),u=i(2,-23),c=i(2,127)*(2-u),f=i(2,-126),a=function(t){return t+1/o-1/o};t.exports=Math.fround||function(t){var n,r,i=Math.abs(t),s=e(t);return i<f?s*a(i/f/u)*f*u:(n=(1+u/o)*i,(r=n-(n-i))>c||r!=r?s*(1/0):s*r)}},function(t,n){t.exports=Math.log1p||function(t){return(t=+t)>-1e-8&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n){t.exports=Math.scale||function(t,n,r,e,i){return 0===arguments.length||t!=t||n!=n||r!=r||e!=e||i!=i?NaN:t===1/0||t===-1/0?t:(t-n)*(i-e)/(r-n)+e}},function(t,n,r){"use strict";var e=r(73),i=r(125),o=r(116),u=r(17),c=r(115),f=Object.assign;t.exports=!f||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=f({},t)[r]||Object.keys(f({},n)).join("")!=e})?function(t,n){for(var r=u(t),f=arguments.length,a=1,s=i.f,l=o.f;f>a;)for(var h,v=c(arguments[a++]),p=s?e(v).concat(s(v)):e(v),d=p.length,y=0;d>y;)l.call(v,h=p[y++])&&(r[h]=v[h]);return r}:f},function(t,n,r){var e=r(10),i=r(2),o=r(73);t.exports=r(9)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(32),i=r(72).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(25),i=r(32),o=r(117)(!1),u=r(149)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){var e=r(73),i=r(32),o=r(116).f;t.exports=function(t){return function(n){for(var r,u=i(n),c=e(u),f=c.length,a=0,s=[];f>a;)o.call(u,r=c[a++])&&s.push(t?[r,u[r]]:u[r]);return s}}},function(t,n,r){var e=r(72),i=r(125),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(82).trim;t.exports=1/e(r(153)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(82).trim,o=r(153),u=/^[-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=function(t){try{return{e:!1,v:t()}}catch(t){return{e:!0,v:t}}}},function(t,n,r){var e=r(2),i=r(5),o=r(147);t.exports=function(t,n){if(e(t),i(n)&&n.constructor===t)return n;var r=o.f(t);return(0,r.resolve)(n),r.promise}},function(t,n,r){var e=r(11),i=r(152),o=r(50);t.exports=function(t,n,r,u){var c=String(o(t)),f=c.length,a=void 0===r?" ":String(r),s=e(n);if(s<=f||""==a)return c;var l=s-f,h=i.call(a,Math.ceil(l/a.length));return h.length>l&&(h=h.slice(0,l)),u?h+c:c+h}},function(t,n,r){var e=r(52),i=r(11);t.exports=function(t){if(void 0===t)return 0;var n=e(t),r=i(n);if(n!==r)throw RangeError("Wrong length!");return r}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(166),i=r(83),o="Map";t.exports=r(118)(o,function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(i(this,o),t);return n&&n.v},set:function(t,n){return e.def(i(this,o),0===t?0:t,n)}},e,!0)},function(t,n,r){r(9)&&"g"!=/./g.flags&&r(10).f(RegExp.prototype,"flags",{configurable:!0,get:r(120)})},function(t,n,r){"use strict";var e=r(166),i=r(83);t.exports=r(118)("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(i(this,"Set"),t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var e,i=r(48)(0),o=r(27),u=r(67),c=r(178),f=r(168),a=r(5),s=r(4),l=r(83),h="WeakMap",v=u.getWeak,p=Object.isExtensible,d=f.ufstore,y={},g=function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},m={get:function(t){if(a(t)){var n=v(t);return!0===n?d(l(this,h)).get(t):n?n[this._i]:void 0}},set:function(t,n){return f.def(l(this,h),t,n)}},b=t.exports=r(118)(h,g,m,f,!0,!0);s(function(){return 7!=(new b).set((Object.freeze||Object)(y),7).get(y)})&&(e=f.getConstructor(g,h),c(e.prototype,m),u.NEED=!0,i(["delete","has","get","set"],function(t){var n=b.prototype,r=n[t];o(n,t,function(n,i){if(a(n)&&!p(n)){this._f||(this._f=new e);var o=this._f[t](n,i);return"set"==t?this:o}return r.call(this,n,i)})}))},,,,function(t,n){"use strict";t.exports={init:function(){var t=document.querySelector("#page-nav");t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&lt; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &gt;</a>'),yiliaConfig&&yiliaConfig.open_in_new&&document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")}),yiliaConfig&&yiliaConfig.toc_hide_index&&document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"});var n=document.querySelector("#js-aboutme");n&&0!==n.length&&(n.innerHTML=n.innerText)}}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n){var r=/\/|index.html/g;return t.replace(r,"")===n.replace(r,"")}function o(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var o=t[r];i(n,o.getAttribute("href"))&&(0,l.default)(o,"active")}}function u(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}function c(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}function f(t,n,r,e,i){var o=u(t),f=c(t)-n;if(f-r<=i){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(r||f)+"px",a.style.left=o+"px",a.style.zIndex=e||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");f(t,document.body.scrollTop,-63,2,0),f(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}var l=e(r(159)),h=e((e(r(160)),r(410))),v=e(r(131)),p=e(r(198)),d=r(132);v.default.versions.mobile&&window.screen.width<800&&(o(),s()),(0,d.addLoadEvent)(function(){p.default.init()}),t.exports={}},,,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object[e](t,n,{writable:!0,configurable:!0,value:r})}if(r(409),r(204),r(207),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;var e="defineProperty";n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},function(t,n){(function(n){!function(n){"use strict";function r(t,n,r,e){var o=n&&n.prototype instanceof i?n:i,u=Object.create(o.prototype),c=new v(e||[]);return u._invoke=a(t,r,c),u}function e(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function i(){}function o(){}function u(){}function c(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function f(t){function r(n,i,o,u){var c=e(t[n],t,i);if("throw"!==c.type){var f=c.arg,a=f.value;return a&&"object"==typeof a&&m.call(a,"__await")?Promise.resolve(a.__await).then(function(t){r("next",t,o,u)},function(t){r("throw",t,o,u)}):Promise.resolve(a).then(function(t){f.value=t,o(f)},u)}u(c.arg)}"object"==typeof n.process&&n.process.domain&&(r=n.process.domain.bind(r));var i;this._invoke=function(t,n){function e(){return new Promise(function(e,i){r(t,n,e,i)})}return i=i?i.then(e,e):e()}}function a(t,n,r){var i=E;return function(o,u){if(i===P)throw new Error("Generator is already running");if(i===j){if("throw"===o)throw u;return d()}for(r.method=o,r.arg=u;;){var c=r.delegate;if(c){var f=s(c,r);if(f){if(f===F)continue;return f}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===E)throw i=j,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=P;var a=e(t,n,r);if("normal"===a.type){if(i=r.done?j:M,a.arg===F)continue;return{value:a.arg,done:r.done}}"throw"===a.type&&(i=j,r.method="throw",r.arg=a.arg)}}}function s(t,n){var r=t.iterator[n.method];if(r===y){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=y,s(t,n),"throw"===n.method))return F;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return F}var i=e(r,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,F;var o=i.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=y),n.delegate=null,F):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,F)}function l(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function h(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function v(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(l,this),this.reset(!0)}function p(t){if(t){var n=t[x];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,e=function n(){for(;++r<t.length;)if(m.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=y,n.done=!0,n};return e.next=e}}return{next:d}}function d(){return{value:y,done:!0}}var y,g=Object.prototype,m=g.hasOwnProperty,b="function"==typeof Symbol?Symbol:{},x=b.iterator||"@@iterator",S=b.asyncIterator||"@@asyncIterator",w=b.toStringTag||"@@toStringTag",_="object"==typeof t,O=n.regeneratorRuntime;if(O)_&&(t.exports=O);else{(O=n.regeneratorRuntime=_?t.exports:{}).wrap=r;var E="suspendedStart",M="suspendedYield",P="executing",j="completed",F={},A={};A[x]=function(){return this};var L=Object.getPrototypeOf,N=L&&L(L(p([])));N&&N!==g&&m.call(N,x)&&(A=N);var T=u.prototype=i.prototype=Object.create(A);o.prototype=T.constructor=u,u.constructor=o,u[w]=o.displayName="GeneratorFunction",O.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===o||"GeneratorFunction"===(n.displayName||n.name))},O.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,u):(t.__proto__=u,w in t||(t[w]="GeneratorFunction")),t.prototype=Object.create(T),t},O.awrap=function(t){return{__await:t}},c(f.prototype),f.prototype[S]=function(){return this},O.AsyncIterator=f,O.async=function(t,n,e,i){var o=new f(r(t,n,e,i));return O.isGeneratorFunction(n)?o:o.next().then(function(t){return t.done?t.value:o.next()})},c(T),T[w]="Generator",T[x]=function(){return this},T.toString=function(){return"[object Generator]"},O.keys=function(t){var n=[];for(var r in t)n.push(r);return n.reverse(),function r(){for(;n.length;){var e=n.pop();if(e in t)return r.value=e,r.done=!1,r}return r.done=!0,r}},O.values=p,v.prototype={constructor:v,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=y,this.done=!1,this.delegate=null,this.method="next",this.arg=y,this.tryEntries.forEach(h),!t)for(var n in this)"t"===n.charAt(0)&&m.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=y)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){function n(n,e){return o.type="throw",o.arg=t,r.next=n,e&&(r.method="next",r.arg=y),!!e}if(this.done)throw t;for(var r=this,e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=m.call(i,"catchLoc"),c=m.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&m.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,F):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),F},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),h(r),F}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;h(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:p(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=y),F}}}}("object"==typeof n?n:"object"==typeof window?window:"object"==typeof self?self:this)}).call(n,function(){return this}())},,,function(t,n,r){r(217),t.exports=r(49).RegExp.escape},,,,function(t,n,r){var e=r(5),i=r(121),o=r(7)("species");t.exports=function(t){var n;return i(t)&&("function"!=typeof(n=t.constructor)||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&null===(n=n[o])&&(n=void 0)),void 0===n?Array:n}},function(t,n,r){"use strict";var e=r(4),i=Date.prototype.getTime,o=Date.prototype.toISOString,u=function(t){return t>9?t:"0"+t};t.exports=e(function(){return"0385-07-25T07:06:39.999Z"!=o.call(new Date(-5e13-1))})||!e(function(){o.call(new Date(NaN))})?function(){if(!isFinite(i.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":n>9999?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(r>99?r:"0"+u(r))+"Z"}:o},function(t,n,r){"use strict";var e=r(2),i=r(53),o="number";t.exports=function(t){if("string"!==t&&t!==o&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),t!=o)}},function(t,n,r){var e=r(73),i=r(125),o=r(116);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n){t.exports=function(t,n){var r=n===Object(n)?function(t){return n[t]}:n;return function(n){return String(n).replace(t,r)}}},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var e=r(1),i=r(215)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(162)}),r(66)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(48)(4);e(e.P+e.F*!r(47)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(133)}),r(66)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(48)(2);e(e.P+e.F*!r(47)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(66)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(66)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(0),o=r(47)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(46),i=r(1),o=r(17),u=r(173),c=r(141),f=r(11),a=r(135),s=r(157);i(i.S+i.F*!r(123)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,i,l,h=o(t),v="function"==typeof this?this:Array,p=arguments.length,d=p>1?arguments[1]:void 0,y=void 0!==d,g=0,m=s(h);if(y&&(d=e(d,p>2?arguments[2]:void 0,2)),void 0==m||v==Array&&c(m))for(n=f(h.length),r=new v(n);n>g;g++)a(r,g,y?d(h[g],g):h[g]);else for(l=m.call(h),r=new v;!(i=l.next()).done;g++)a(r,g,y?u(l,d,[i.value,g],!0):i.value);return r.length=g,r}})},function(t,n,r){"use strict";var e=r(1),i=r(117)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(47)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(121)})},function(t,n,r){"use strict";var e=r(1),i=r(32),o=[].join;e(e.P+e.F*(r(115)!=Object||!r(47)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(32),o=r(52),u=r(11),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(47)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(arguments.length>1&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);e>=0;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(1);e(e.P+e.F*!r(47)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(135);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);n>t;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(164);e(e.P+e.F*!r(47)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(164);e(e.P+e.F*!r(47)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(139),o=r(45),u=r(77),c=r(11),f=[].slice;e(e.P+e.F*r(4)(function(){i&&f.call(i)}),"Array",{slice:function(t,n){var r=c(this.length),e=o(this);if(n=void 0===n?r:n,"Array"==e)return f.call(this,t,n);for(var i=u(t,r),a=u(n,r),s=c(a-i),l=Array(s),h=0;h<s;h++)l[h]="String"==e?this.charAt(i+h):this[i+h];return l}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(3);e(e.P+e.F*!r(47)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(19),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(47)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(76)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){var e=r(1),i=r(212);e(e.P+e.F*(Date.prototype.toISOString!==i),"Date",{toISOString:i})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(53);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(26)(i,e,r(213))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(27)(e,o,function(){var t=c.call(this);return t===t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(165)})},function(t,n,r){"use strict";var e=r(5),i=r(31),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(10).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(10).f,i=Function.prototype,o=/^\s*function ([^ (]*)/,u="name";u in i||r(9)&&e(i,u,{configurable:!0,get:function(){try{return(""+this).match(o)[1]}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(176),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:t>94906265.62425156?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}var i=r(1),o=Math.asinh;i(i.S+i.F*!(o&&1/o(0)>0),"Math",{asinh:e})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(145);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(144);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1);e(e.S,"Math",{fround:r(175)})},function(t,n,r){var e=r(1),i=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,o=0,u=0,c=arguments.length,f=0;u<c;)r=i(arguments[u++]),f<r?(e=f/r,o=o*e*e+1,f=r):r>0?(e=r/f,o+=e*e):o+=r;return f===1/0?1/0:f*Math.sqrt(o)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)*Math.LOG10E}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(176)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(145)})},function(t,n,r){var e=r(1),i=r(144),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(144),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(t>0?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(25),o=r(45),u=r(140),c=r(53),f=r(4),a=r(72).f,s=r(30).f,l=r(10).f,h=r(82).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(71)(y))==v,m="trim"in String.prototype,b=function(t){var n=c(t,!1);if("string"==typeof n&&n.length>2){var r,e,i,o=(n=m?n.trim():h(n,3)).charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,f=n.slice(2),a=0,s=f.length;a<s;a++)if((u=f.charCodeAt(a))<48||u>i)return NaN;return parseInt(f,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?f(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(b(n)),r,p):b(n)};for(var x,S=r(9)?a(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),w=0;S.length>w;w++)i(d,x=S[w])&&!i(p,x)&&l(p,x,s(d,x));p.prototype=y,y.constructor=p,r(27)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(172)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(172),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(184);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(185);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),i=r(52),o=r(161),u=r(152),c=1..toFixed,f=Math.floor,a=[0,0,0,0,0,0],s="Number.toFixed: incorrect invocation!",l="0",h=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*a[r],a[r]=e%1e7,e=f(e/1e7)},v=function(t){for(var n=6,r=0;--n>=0;)r+=a[n],a[n]=f(r/t),r=r%t*1e7},p=function(){for(var t=6,n="";--t>=0;)if(""!==n||0===t||0!==a[t]){var r=String(a[t]);n=""===n?r:n+u.call(l,7-r.length)+r}return n},d=function(t,n,r){return 0===n?r:n%2==1?d(t,n-1,r*t):d(t*t,n/2,r)},y=function(t){for(var n=0,r=t;r>=4096;)n+=12,r/=4096;for(;r>=2;)n+=1,r/=2;return n};e(e.P+e.F*(!!c&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){c.call({})})),"Number",{toFixed:function(t){var n,r,e,c,f=o(this,s),a=i(t),g="",m=l;if(a<0||a>20)throw RangeError(s);if(f!=f)return"NaN";if(f<=-1e21||f>=1e21)return String(f);if(f<0&&(g="-",f=-f),f>1e-21)if(n=y(f*d(2,69,1))-69,r=n<0?f*d(2,-n,1):f/d(2,n,1),r*=4503599627370496,(n=52-n)>0){for(h(0,r),e=a;e>=7;)h(1e7,0),e-=7;for(h(d(10,e,1),0),e=n-1;e>=23;)v(1<<23),e-=23;v(1<<e),h(1,1),v(2),m=p()}else h(0,r),h(1<<-n,0),m=p()+u.call(l,a);return a>0?(c=m.length,m=g+(c<=a?"0."+u.call(l,a-c)+m:m.slice(0,c-a)+"."+m.slice(c-a))):m=g+m,m}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(161),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(178)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(71)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(9),"Object",{defineProperties:r(179)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(9),"Object",{defineProperty:r(10).f})},function(t,n,r){var e=r(5),i=r(67).onFreeze;r(51)("freeze",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(32),i=r(30).f;r(51)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(51)("getOwnPropertyNames",function(){return r(180).f})},function(t,n,r){var e=r(17),i=r(31);r(51)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(5);r(51)("isExtensible",function(t){return function(n){return!!e(n)&&(!t||t(n))}})},function(t,n,r){var e=r(5);r(51)("isFrozen",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(5);r(51)("isSealed",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(216)})},function(t,n,r){var e=r(17),i=r(73);r(51)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(5),i=r(67).onFreeze;r(51)("preventExtensions",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(5),i=r(67).onFreeze;r(51)("seal",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(148).set})},function(t,n,r){"use strict";var e=r(114),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(27)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(184);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(185);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u,c=r(70),f=r(3),a=r(46),s=r(114),l=r(1),h=r(5),v=r(19),p=r(68),d=r(69),y=r(129),g=r(154).set,m=r(146)(),b=r(147),x=r(186),S=r(187),w="Promise",_=f.TypeError,O=f.process,E=f[w],M="process"==s(O),P=function(){},j=i=b.f,F=!!function(){try{var t=E.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(P,P)};return(M||"function"==typeof PromiseRejectionEvent)&&t.then(P)instanceof n}catch(t){}}(),A=function(t){var n;return!(!h(t)||"function"!=typeof(n=t.then))&&n},L=function(t,n){if(!t._n){t._n=!0;var r=t._c;m(function(){for(var e=t._v,i=1==t._s,o=0;r.length>o;)!function(n){var r,o,u=i?n.ok:n.fail,c=n.resolve,f=n.reject,a=n.domain;try{u?(i||(2==t._h&&I(t),t._h=1),!0===u?r=e:(a&&a.enter(),r=u(e),a&&a.exit()),r===n.promise?f(_("Promise-chain cycle")):(o=A(r))?o.call(r,c,f):c(r)):f(e)}catch(t){f(t)}}(r[o++]);t._c=[],t._n=!1,n&&!t._h&&N(t)})}},N=function(t){g.call(f,function(){var n,r,e,i=t._v,o=T(t);if(o&&(n=x(function(){M?O.emit("unhandledRejection",i,t):(r=f.onunhandledrejection)?r({promise:t,reason:i}):(e=f.console)&&e.error&&e.error("Unhandled promise rejection",i)}),t._h=M||T(t)?2:1),t._a=void 0,o&&n.e)throw n.v})},T=function(t){if(1==t._h)return!1;for(var n,r=t._a||t._c,e=0;r.length>e;)if((n=r[e++]).fail||!T(n.promise))return!1;return!0},I=function(t){g.call(f,function(){var n;M?O.emit("rejectionHandled",t):(n=f.onrejectionhandled)&&n({promise:t,reason:t._v})})},k=function(t){var n=this;n._d||(n._d=!0,n=n._w||n,n._v=t,n._s=2,n._a||(n._a=n._c.slice()),L(n,!0))},R=function(t){var n,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw _("Promise can't be resolved itself");(n=A(t))?m(function(){var e={_w:r,_d:!1};try{n.call(t,a(R,e,1),a(k,e,1))}catch(t){k.call(e,t)}}):(r._v=t,r._s=1,L(r,!1))}catch(t){k.call({_w:r,_d:!1},t)}}};F||(E=function(t){p(this,E,w,"_h"),v(t),e.call(this);try{t(a(R,this,1),a(k,this,1))}catch(t){k.call(this,t)}},e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},e.prototype=r(75)(E.prototype,{then:function(t,n){var r=j(y(this,E));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=M?O.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&L(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),o=function(){var t=new e;this.promise=t,this.resolve=a(R,t,1),this.reject=a(k,t,1)},b.f=j=function(t){return t===E||t===u?new o(t):i(t)}),l(l.G+l.W+l.F*!F,{Promise:E}),r(81)(E,w),r(76)(w),u=r(49)[w],l(l.S+l.F*!F,w,{reject:function(t){var n=j(this);return(0,n.reject)(t),n.promise}}),l(l.S+l.F*(c||!F),w,{resolve:function(t){return S(c&&this===u?E:this,t)}}),l(l.S+l.F*!(F&&r(123)(function(t){E.all(t).catch(P)})),w,{all:function(t){var n=this,r=j(n),e=r.resolve,i=r.reject,o=x(function(){var r=[],o=0,u=1;d(t,!1,function(t){var c=o++,f=!1;r.push(void 0),u++,n.resolve(t).then(function(t){f||(f=!0,r[c]=t,--u||e(r))},i)}),--u||e(r)});return o.e&&i(o.v),r.promise},race:function(t){var n=this,r=j(n),e=r.reject,i=x(function(){d(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i.e&&e(i.v),r.promise}})},function(t,n,r){var e=r(1),i=r(19),o=r(2),u=(r(3).Reflect||{}).apply,c=Function.apply;e(e.S+e.F*!r(4)(function(){u(function(){})}),"Reflect",{apply:function(t,n,r){var e=i(t),f=o(r);return u?u(e,n,f):c.call(e,n,f)}})},function(t,n,r){var e=r(1),i=r(71),o=r(19),u=r(2),c=r(5),f=r(4),a=r(165),s=(r(3).Reflect||{}).construct,l=f(function(){function t(){}return!(s(function(){},[],t)instanceof t)}),h=!f(function(){s(function(){})});e(e.S+e.F*(l||h),"Reflect",{construct:function(t,n){o(t),u(n);var r=arguments.length<3?t:o(arguments[2]);if(h&&!l)return s(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(a.apply(t,e))}var f=r.prototype,v=i(c(f)?f:Object.prototype),p=Function.apply.call(t,v,n);return c(p)?p:v}})},function(t,n,r){var e=r(10),i=r(1),o=r(2),u=r(53);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(30).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(142)(o,"Object",function(){var t,n=this,r=n._k;do{if(n._i>=r.length)return{value:void 0,done:!0}}while(!((t=r[n._i++])in n._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(30),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(31),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){function e(t,n){var r,c,s=arguments.length<3?t:arguments[2];return a(t)===s?t[n]:(r=i.f(t,n))?u(r,"value")?r.value:void 0!==r.get?r.get.call(s):void 0:f(c=o(t))?e(c,n,s):void 0}var i=r(30),o=r(31),u=r(25),c=r(1),f=r(5),a=r(2);c(c.S,"Reflect",{get:e})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(183)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(148);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){function e(t,n,r){var f,h,v=arguments.length<4?t:arguments[3],p=o.f(s(t),n);if(!p){if(l(h=u(t)))return e(h,n,r,v);p=a(0)}return c(p,"value")?!(!1===p.writable||!l(v)||(f=o.f(v,n)||a(0),f.value=r,i.f(v,n,f),0)):void 0!==p.set&&(p.set.call(v,r),!0)}var i=r(10),o=r(30),u=r(31),c=r(25),f=r(1),a=r(74),s=r(2),l=r(5);f(f.S,"Reflect",{set:e})},function(t,n,r){var e=r(3),i=r(140),o=r(10).f,u=r(72).f,c=r(122),f=r(120),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(9)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),o=void 0===n;return!r&&e&&t.constructor===a&&o?t:i(p?new s(e&&!o?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&o?f.call(t):n),r?this:l,a)};for(var d=u(s),y=0;d.length>y;)!function(t){t in a||o(a,t,{configurable:!0,get:function(){return s[t]},set:function(n){s[t]=n}})}(d[y++]);l.constructor=a,a.prototype=l,r(27)(e,"RegExp",a)}r(76)("RegExp")},function(t,n,r){r(119)("match",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("replace",2,function(t,n,r){return[function(e,i){"use strict";var o=t(this),u=void 0==e?void 0:e[n];return void 0!==u?u.call(e,o,i):r.call(String(o),e,i)},r]})},function(t,n,r){r(119)("search",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("split",2,function(t,n,e){"use strict";var i=r(122),o=e,u=[].push,c="split",f="length",a="lastIndex";if("c"=="abbc"[c](/(b)*/)[1]||4!="test"[c](/(?:)/,-1)[f]||2!="ab"[c](/(?:ab)*/)[f]||4!="."[c](/(.?)(.?)/)[f]||"."[c](/()()/)[f]>1||""[c](/.?/)[f]){var s=void 0===/()??/.exec("")[1];e=function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!i(t))return o.call(r,t,n);var e,c,l,h,v,p=[],d=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),y=0,g=void 0===n?4294967295:n>>>0,m=new RegExp(t.source,d+"g");for(s||(e=new RegExp("^"+m.source+"$(?!\\s)",d));(c=m.exec(r))&&!((l=c.index+c[0][f])>y&&(p.push(r.slice(y,c.index)),!s&&c[f]>1&&c[0].replace(e,function(){for(v=1;v<arguments[f]-2;v++)void 0===arguments[v]&&(c[v]=void 0)}),c[f]>1&&c.index<r[f]&&u.apply(p,c.slice(1)),h=c[0][f],y=l,p[f]>=g));)m[a]===c.index&&m[a]++;return y===r[f]?!h&&m.test("")||p.push(""):p.push(r.slice(y)),p[f]>g?p.slice(0,g):p}}else"0"[c](void 0,0)[f]&&(e=function(t,n){return void 0===t&&0===n?[]:o.call(this,t,n)});return[function(r,i){var o=t(this),u=void 0==r?void 0:r[n];return void 0!==u?u.call(r,o,i):e.call(String(o),r,i)},e]})},function(t,n,r){"use strict";r(192);var e=r(2),i=r(120),o=r(9),u="toString",c=/./[u],f=function(t){r(27)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(28)("anchor",function(t){return function(n){return t(this,"a","name",n)}})},function(t,n,r){"use strict";r(28)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(28)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(28)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(150)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(11),o=r(151),u="endsWith",c=""[u];e(e.P+e.F*r(138)(u),"String",{endsWith:function(t){var n=o(this,t,u),r=arguments.length>1?arguments[1]:void 0,e=i(n.length),f=void 0===r?e:Math.min(i(r),e),a=String(t);return c?c.call(n,a,f):n.slice(f-a.length,f)===a}})},function(t,n,r){"use strict";r(28)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(28)("fontcolor",function(t){return function(n){return t(this,"font","color",n)}})},function(t,n,r){"use strict";r(28)("fontsize",function(t){return function(n){return t(this,"font","size",n)}})},function(t,n,r){var e=r(1),i=r(77),o=String.fromCharCode,u=String.fromCodePoint;e(e.S+e.F*(!!u&&1!=u.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,u=0;e>u;){if(n=+arguments[u++],i(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?o(n):o(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(151),o="includes";e(e.P+e.F*r(138)(o),"String",{includes:function(t){return!!~i(this,t,o).indexOf(t,arguments.length>1?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(28)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(150)(!0);r(143)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(28)("link",function(t){return function(n){return t(this,"a","href",n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(11);e(e.S,"String",{raw:function(t){for(var n=i(t.raw),r=o(n.length),e=arguments.length,u=[],c=0;r>c;)u.push(String(n[c++])),c<e&&u.push(String(arguments[c]));return u.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(152)})},function(t,n,r){"use strict";r(28)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(11),o=r(151),u="startsWith",c=""[u];e(e.P+e.F*r(138)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(arguments.length>1?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(28)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(28)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(28)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(82)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),i=r(25),o=r(9),u=r(1),c=r(27),f=r(67).KEY,a=r(4),s=r(128),l=r(81),h=r(78),v=r(7),p=r(190),d=r(156),y=r(214),g=r(121),m=r(2),b=r(32),x=r(53),S=r(74),w=r(71),_=r(180),O=r(30),E=r(10),M=r(73),P=O.f,j=E.f,F=_.f,A=e.Symbol,L=e.JSON,N=L&&L.stringify,T="prototype",I=v("_hidden"),k=v("toPrimitive"),R={}.propertyIsEnumerable,C=s("symbol-registry"),D=s("symbols"),G=s("op-symbols"),W=Object[T],U="function"==typeof A,V=e.QObject,B=!V||!V[T]||!V[T].findChild,q=o&&a(function(){return 7!=w(j({},"a",{get:function(){return j(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=P(W,n);e&&delete W[n],j(t,n,r),e&&t!==W&&j(W,n,e)}:j,z=function(t){var n=D[t]=w(A[T]);return n._k=t,n},H=U&&"symbol"==typeof A.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof A},K=function(t,n,r){return t===W&&K(G,n,r),m(t),n=x(n,!0),m(r),i(D,n)?(r.enumerable?(i(t,I)&&t[I][n]&&(t[I][n]=!1),r=w(r,{enumerable:S(0,!1)})):(i(t,I)||j(t,I,S(1,{})),t[I][n]=!0),q(t,n,r)):j(t,n,r)},J=function(t,n){m(t);for(var r,e=y(n=b(n)),i=0,o=e.length;o>i;)K(t,r=e[i++],n[r]);return t},Y=function(t){var n=R.call(this,t=x(t,!0));return!(this===W&&i(D,t)&&!i(G,t))&&(!(n||!i(this,t)||!i(D,t)||i(this,I)&&this[I][t])||n)},$=function(t,n){if(t=b(t),n=x(n,!0),t!==W||!i(D,n)||i(G,n)){var r=P(t,n);return!r||!i(D,n)||i(t,I)&&t[I][n]||(r.enumerable=!0),r}},X=function(t){for(var n,r=F(b(t)),e=[],o=0;r.length>o;)i(D,n=r[o++])||n==I||n==f||e.push(n);return e},Q=function(t){for(var n,r=t===W,e=F(r?G:b(t)),o=[],u=0;e.length>u;)!i(D,n=e[u++])||r&&!i(W,n)||o.push(D[n]);return o};U||(A=function(){if(this instanceof A)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===W&&n.call(G,r),i(this,I)&&i(this[I],t)&&(this[I][t]=!1),q(this,t,S(1,r))};return o&&B&&q(W,t,{configurable:!0,set:n}),z(t)},c(A[T],"toString",function(){return this._k}),O.f=$,E.f=K,r(72).f=_.f=X,r(116).f=Y,r(125).f=Q,o&&!r(70)&&c(W,"propertyIsEnumerable",Y,!0),p.f=function(t){return z(v(t))}),u(u.G+u.W+u.F*!U,{Symbol:A});for(var Z="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),tt=0;Z.length>tt;)v(Z[tt++]);for(var nt=M(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!U,"Symbol",{for:function(t){return i(C,t+="")?C[t]:C[t]=A(t)},keyFor:function(t){if(!H(t))throw TypeError(t+" is not a symbol!");for(var n in C)if(C[n]===t)return n},useSetter:function(){B=!0},useSimple:function(){B=!1}}),u(u.S+u.F*!U,"Object",{create:function(t,n){return void 0===n?w(t):J(w(t),n)},defineProperty:K,defineProperties:J,getOwnPropertyDescriptor:$,getOwnPropertyNames:X,getOwnPropertySymbols:Q}),L&&u(u.S+u.F*(!U||a(function(){var t=A();return"[null]"!=N([t])||"{}"!=N({a:t})||"{}"!=N(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!H(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return"function"==typeof(n=e[1])&&(r=n),!r&&g(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!H(n))return n}),e[1]=n,N.apply(L,e)}}}),A[T][k]||r(26)(A[T],k,A[T].valueOf),l(A,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(130),o=r(155),u=r(2),c=r(77),f=r(11),a=r(5),s=r(3).ArrayBuffer,l=r(129),h=o.ArrayBuffer,v=o.DataView,p=i.ABV&&s.isView,d=h.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(s!==h),{ArrayBuffer:h}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return p&&p(t)||a(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new h(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(u(this),t);for(var r=u(this).byteLength,e=c(t,r),i=c(void 0===n?r:n,r),o=new(l(this,h))(f(i-e)),a=new v(this),s=new v(o),p=0;e<i;)s.setUint8(p++,a.getUint8(e++));return o}}),r(76)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(130).ABV,{DataView:r(155).DataView})},function(t,n,r){r(56)("Float32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(56)("Float64",8,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(56)("Int16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(56)("Int32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(56)("Int8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(56)("Uint16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(56)("Uint32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(56)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(56)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}},!0)},function(t,n,r){"use strict";var e=r(168),i=r(83),o="WeakSet";r(118)(o,function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(i(this,o),t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(169),o=r(17),u=r(11),c=r(19),f=r(134);e(e.P,"Array",{flatMap:function(t){var n,r,e=o(this);return c(t),n=u(e.length),r=f(e,0),i(r,e,e,n,0,1,t,arguments[1]),r}}),r(66)("flatMap")},function(t,n,r){"use strict";var e=r(1),i=r(169),o=r(17),u=r(11),c=r(52),f=r(134);e(e.P,"Array",{flatten:function(){var t=arguments[0],n=o(this),r=u(n.length),e=f(n,0);return i(e,n,n,r,0,void 0===t?1:c(t)),e}}),r(66)("flatten")},function(t,n,r){"use strict";var e=r(1),i=r(117)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(66)("includes")},function(t,n,r){var e=r(1),i=r(146)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.G,{global:r(3)})},function(t,n,r){r(126)("Map")},function(t,n,r){r(127)("Map")},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(167)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{clamp:function(t,n,r){return Math.min(r,Math.max(n,t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{DEG_PER_RAD:Math.PI/180})},function(t,n,r){var e=r(1),i=180/Math.PI;e(e.S,"Math",{degrees:function(t){return t*i}})},function(t,n,r){var e=r(1),i=r(177),o=r(175);e(e.S,"Math",{fscale:function(t,n,r,e,u){return o(i(t,n,r,e,u))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=r>>>0;return(n>>>0)+(e>>>0)+((i&o|(i|o)&~(i+o>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>16,f=i>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>16)+((o*f>>>0)+(a&r)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=r>>>0;return(n>>>0)-(e>>>0)-((~i&o|~(i^o)&i-o>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{RAD_PER_DEG:180/Math.PI})},function(t,n,r){var e=r(1),i=Math.PI/180;e(e.S,"Math",{radians:function(t){return t*i}})},function(t,n,r){var e=r(1);e(e.S,"Math",{scale:r(177)})},function(t,n,r){var e=r(1);e(e.S,"Math",{signbit:function(t){return(t=+t)!=t?t:0==t?1/t==1/0:t>0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>>16,f=i>>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>>16)+((o*f>>>0)+(a&r)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(19),u=r(10);r(9)&&e(e.P+r(124),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(19),u=r(10);r(9)&&e(e.P+r(124),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(182)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),i=r(183),o=r(32),u=r(30),c=r(135);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r,e=o(t),f=u.f,a=i(e),s={},l=0;a.length>l;)void 0!==(r=f(e,n=a[l++]))&&c(s,n,r);return s}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(53),u=r(31),c=r(30).f;r(9)&&e(e.P+r(124),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(53),u=r(31),c=r(30).f;r(9)&&e(e.P+r(124),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(182)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),i=r(3),o=r(49),u=r(146)(),c=r(7)("observable"),f=r(19),a=r(2),s=r(68),l=r(75),h=r(26),v=r(69),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},m=function(t){g(t)||(t._o=void 0,y(t))},b=function(t,n){a(t),this._c=void 0,this._o=t,t=new x(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};b.prototype=l({},{unsubscribe:function(){m(this)}});var x=function(t){this._s=t};x.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{m(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var S=function(t){s(this,S,"Observable","_f")._f=f(t)};l(S.prototype,{subscribe:function(t){return new b(t,this._f)},forEach:function(t){var n=this;return new(o.Promise||i.Promise)(function(r,e){f(t);var i=n.subscribe({next:function(n){try{return t(n)}catch(t){e(t),i.unsubscribe()}},error:e,complete:r})})}}),l(S,{from:function(t){var n="function"==typeof this?this:S,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return u(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,r=Array(n);t<n;)r[t]=arguments[t++];return new("function"==typeof this?this:S)(function(t){var n=!1;return u(function(){if(!n){for(var e=0;e<r.length;++e)if(t.next(r[e]),n)return;t.complete()}}),function(){n=!0}})}}),h(S.prototype,c,function(){return this}),e(e.G,{Observable:S}),r(76)("Observable")},function(t,n,r){"use strict";var e=r(1),i=r(49),o=r(3),u=r(129),c=r(187);e(e.P+e.R,"Promise",{finally:function(t){var n=u(this,i.Promise||o.Promise),r="function"==typeof t;return this.then(r?function(r){return c(n,t()).then(function(){return r})}:t,r?function(r){return c(n,t()).then(function(){throw r})}:t)}})},function(t,n,r){"use strict";var e=r(1),i=r(147),o=r(186);e(e.S,"Promise",{try:function(t){var n=i.f(this),r=o(t);return(r.e?n.reject:n.resolve)(r.v),n.promise}})},function(t,n,r){var e=r(55),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(55),i=r(2),o=e.key,u=e.map,c=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:o(arguments[2]),e=u(i(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var f=c.get(n);return f.delete(r),!!f.size||c.delete(n)}})},function(t,n,r){var e=r(193),i=r(163),o=r(55),u=r(2),c=r(31),f=o.keys,a=o.key,s=function(t,n){var r=f(t,n),o=c(t);if(null===o)return r;var u=s(o,n);return u.length?r.length?i(new e(r.concat(u))):u:r};o.exp({getMetadataKeys:function(t){return s(u(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(55),i=r(2),o=r(31),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(55),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(55),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(55),i=r(2),o=r(31),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(55),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(55),i=r(2),o=r(19),u=e.key,c=e.set;e.exp({metadata:function(t,n){return function(r,e){c(t,n,(void 0!==e?i:o)(r),u(e))}}})},function(t,n,r){r(126)("Set")},function(t,n,r){r(127)("Set")},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(167)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(150)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(50),o=r(11),u=r(122),c=r(120),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(142)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(188);e(e.P,"String",{padEnd:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(188);e(e.P,"String",{padStart:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(82)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(82)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(156)("asyncIterator")},function(t,n,r){r(156)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){r(126)("WeakMap")},function(t,n,r){r(127)("WeakMap")},function(t,n,r){r(126)("WeakSet")},function(t,n,r){r(127)("WeakSet")},function(t,n,r){for(var e=r(158),i=r(73),o=r(27),u=r(3),c=r(26),f=r(80),a=r(7),s=a("iterator"),l=a("toStringTag"),h=f.Array,v={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},p=i(v),d=0;d<p.length;d++){var y,g=p[d],m=v[g],b=u[g],x=b&&b.prototype;if(x&&(x[s]||c(x,s,h),x[l]||c(x,l,g),f[g]=h,m))for(y in e)x[y]||o(x,y,e[y],!0)}},function(t,n,r){var e=r(1),i=r(154);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=e.navigator,u=[].slice,c=!!o&&/MSIE .\./.test(o.userAgent),f=function(t){return function(n,r){var e=arguments.length>2,i=!!e&&u.call(arguments,2);return t(e?function(){("function"==typeof n?n:Function(n)).apply(this,i)}:n,r)}};i(i.G+i.B+i.F*c,{setTimeout:f(e.setTimeout),setInterval:f(e.setInterval)})},function(t,n,r){r(337),r(276),r(278),r(277),r(280),r(282),r(287),r(281),r(279),r(289),r(288),r(284),r(285),r(283),r(275),r(286),r(290),r(291),r(243),r(245),r(244),r(293),r(292),r(263),r(273),r(274),r(264),r(265),r(266),r(267),r(268),r(269),r(270),r(271),r(272),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(256),r(257),r(258),r(259),r(260),r(261),r(262),r(324),r(329),r(336),r(327),r(319),r(320),r(325),r(330),r(332),r(315),r(316),r(317),r(318),r(321),r(322),r(323),r(326),r(328),r(331),r(333),r(334),r(335),r(238),r(240),r(239),r(242),r(241),r(227),r(225),r(231),r(228),r(234),r(236),r(224),r(230),r(221),r(235),r(219),r(233),r(232),r(226),r(229),r(218),r(220),r(223),r(222),r(237),r(158),r(309),r(314),r(192),r(310),r(311),r(312),r(313),r(294),r(191),r(193),r(194),r(349),r(338),r(339),r(344),r(347),r(348),r(342),r(345),r(343),r(346),r(340),r(341),r(295),r(296),r(297),r(298),r(299),r(302),r(300),r(301),r(303),r(304),r(305),r(306),r(308),r(307),r(352),r(350),r(351),r(393),r(396),r(395),r(397),r(398),r(394),r(399),r(400),r(374),r(377),r(373),r(371),r(372),r(375),r(376),r(358),r(392),r(357),r(391),r(403),r(405),r(356),r(390),r(402),r(404),r(355),r(401),r(354),r(359),r(360),r(361),r(362),r(363),r(365),r(364),r(366),r(367),r(368),r(370),r(369),r(379),r(380),r(381),r(382),r(384),r(383),r(386),r(385),r(387),r(388),r(389),r(353),r(378),r(408),r(407),r(406),t.exports=r(49)},function(t,n){t.exports=function(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}}])</script><script src="/./main.e8862b.js"></script><script>!function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}("/slider.5b7e29.js")</script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">All articles</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">Friends</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">About me</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Algorithm</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">C++</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">DS</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Tech</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">ML</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">DL</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">English</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Essay</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">git</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">golang</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">HTML</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Javascript</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">CSS</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">js</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">html</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Redis</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">MYSQL</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Spring</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">linux</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">papers</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">RL</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">k8s</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="https://leetcode-cn.com/u/louris/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>我的力扣</a>
            </li>
          
            <li class="search-li">
              <a href="https://www.six1110.top/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>饭勺</a>
            </li>
          
            <li class="search-li">
              <a href="https://www.zjcheng.site/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>中建</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">做一个安静细微的人，&lt;br&gt; 于角落里自在开放，&lt;br&gt; 默默悦人，&lt;br&gt; 却始终不引起过分热闹的关注，&lt;br&gt; 保有独立而随意的品格，&lt;br&gt; 这就很好。&lt;br&gt;&lt;br&gt; Stick to what you insist on,&lt;br&gt; believe what you believe!&lt;br&gt; Life hastily for decades,&lt;br&gt; do what I can!</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"react":{"opacity":1},"log":false});</script></body>
</html>